<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Source: opamSystem.ml (opam-core.src.opam-core)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.css"/><meta name="generator" content="odoc %%VERSION%%"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/></head><body class="odoc-src"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">opam-core</a> &#x00BB; <a href="../index.html">Sources</a> &#x00BB; opam-core &#x00BB; opamSystem.ml</nav><header class="odoc-preamble"><h1>Source file <code><span>opamSystem.ml</span></code></h1></header><div class="odoc-tocs"><nav class="odoc-toc odoc-global-toc"><ul><li><a href="../../index.html">opam-core</a><ul><li>Library <code>opam-core</code><ul><li><a href="../../opam-core/OpamACL/index.html">OpamACL</a></li><li><a href="../../opam-core/OpamCached/index.html">OpamCached</a></li><li><a href="../../opam-core/OpamCompat/index.html">OpamCompat</a></li><li><a href="../../opam-core/OpamConsole/index.html">OpamConsole</a></li><li><a href="../../opam-core/OpamCoreConfig/index.html">OpamCoreConfig</a></li><li><a href="../../opam-core/OpamCoreConfigDeveloper/index.html">OpamCoreConfigDeveloper</a></li><li><a href="../../opam-core/OpamDirTrack/index.html">OpamDirTrack</a></li><li><a href="../../opam-core/OpamFilename/index.html">OpamFilename</a></li><li><a href="../../opam-core/OpamHash/index.html">OpamHash</a></li><li><a href="../../opam-core/OpamJson/index.html">OpamJson</a></li><li><a href="../../opam-core/OpamParallel/index.html">OpamParallel</a></li><li><a href="../../opam-core/OpamProcess/index.html">OpamProcess</a></li><li><a href="../../opam-core/OpamSHA/index.html">OpamSHA</a></li><li><a href="../../opam-core/OpamSWHID/index.html">OpamSWHID</a></li><li><a href="../../opam-core/OpamStd/index.html">OpamStd</a></li><li><a href="../../opam-core/OpamStubs/index.html">OpamStubs</a></li><li><a href="../../opam-core/OpamStubsTypes/index.html">OpamStubsTypes</a></li><li><a href="../../opam-core/OpamSystem/index.html">OpamSystem</a></li><li><a href="../../opam-core/OpamUrl/index.html">OpamUrl</a></li><li><a href="../../opam-core/OpamVersion/index.html">OpamVersion</a></li><li><a href="../../opam-core/OpamVersionCompare/index.html">OpamVersionCompare</a></li><li><a href="../../opam-core/OpamVersionInfo/index.html">OpamVersionInfo</a></li></ul></li><li><a href="../index.html">Sources</a><ul><li>opam-core<ul><li><a href="opamACL.ml.html">opamACL.ml</a></li><li><a href="opamCached.ml.html">opamCached.ml</a></li><li><a href="opamCompat.ml.html">opamCompat.ml</a></li><li><a href="opamConsole.ml.html">opamConsole.ml</a></li><li><a href="opamCoreConfig.ml.html">opamCoreConfig.ml</a></li><li><a href="opamCoreConfigDeveloper.ml.html">opamCoreConfigDeveloper.ml</a></li><li><a href="opamDirTrack.ml.html">opamDirTrack.ml</a></li><li><a href="opamFilename.ml.html">opamFilename.ml</a></li><li><a href="opamHash.ml.html">opamHash.ml</a></li><li><a href="opamJson.ml.html">opamJson.ml</a></li><li><a href="opamParallel.ml.html">opamParallel.ml</a></li><li><a href="opamProcess.ml.html">opamProcess.ml</a></li><li><a href="opamSHA.ml.html">opamSHA.ml</a></li><li><a href="opamSWHID.ml.html">opamSWHID.ml</a></li><li><a href="opamStd.ml.html">opamStd.ml</a></li><li><a href="opamStubs.ml.html">opamStubs.ml</a></li><li><a href="opamStubsTypes.ml.html">opamStubsTypes.ml</a></li><li><a href="#" class="current_unit">opamSystem.ml</a></li><li><a href="opamUrl.ml.html">opamUrl.ml</a></li><li><a href="opamVersion.ml.html">opamVersion.ml</a></li><li><a href="opamVersionCompare.ml.html">opamVersionCompare.ml</a></li><li><a href="opamVersionInfo.ml.html">opamVersionInfo.ml</a></li></ul></li></ul></li></ul></li></ul></nav></div><pre class="source_container"><code class="source_line_column"><a id="L1" class="source_line" href="#L1">1</a>
<a id="L2" class="source_line" href="#L2">2</a>
<a id="L3" class="source_line" href="#L3">3</a>
<a id="L4" class="source_line" href="#L4">4</a>
<a id="L5" class="source_line" href="#L5">5</a>
<a id="L6" class="source_line" href="#L6">6</a>
<a id="L7" class="source_line" href="#L7">7</a>
<a id="L8" class="source_line" href="#L8">8</a>
<a id="L9" class="source_line" href="#L9">9</a>
<a id="L10" class="source_line" href="#L10">10</a>
<a id="L11" class="source_line" href="#L11">11</a>
<a id="L12" class="source_line" href="#L12">12</a>
<a id="L13" class="source_line" href="#L13">13</a>
<a id="L14" class="source_line" href="#L14">14</a>
<a id="L15" class="source_line" href="#L15">15</a>
<a id="L16" class="source_line" href="#L16">16</a>
<a id="L17" class="source_line" href="#L17">17</a>
<a id="L18" class="source_line" href="#L18">18</a>
<a id="L19" class="source_line" href="#L19">19</a>
<a id="L20" class="source_line" href="#L20">20</a>
<a id="L21" class="source_line" href="#L21">21</a>
<a id="L22" class="source_line" href="#L22">22</a>
<a id="L23" class="source_line" href="#L23">23</a>
<a id="L24" class="source_line" href="#L24">24</a>
<a id="L25" class="source_line" href="#L25">25</a>
<a id="L26" class="source_line" href="#L26">26</a>
<a id="L27" class="source_line" href="#L27">27</a>
<a id="L28" class="source_line" href="#L28">28</a>
<a id="L29" class="source_line" href="#L29">29</a>
<a id="L30" class="source_line" href="#L30">30</a>
<a id="L31" class="source_line" href="#L31">31</a>
<a id="L32" class="source_line" href="#L32">32</a>
<a id="L33" class="source_line" href="#L33">33</a>
<a id="L34" class="source_line" href="#L34">34</a>
<a id="L35" class="source_line" href="#L35">35</a>
<a id="L36" class="source_line" href="#L36">36</a>
<a id="L37" class="source_line" href="#L37">37</a>
<a id="L38" class="source_line" href="#L38">38</a>
<a id="L39" class="source_line" href="#L39">39</a>
<a id="L40" class="source_line" href="#L40">40</a>
<a id="L41" class="source_line" href="#L41">41</a>
<a id="L42" class="source_line" href="#L42">42</a>
<a id="L43" class="source_line" href="#L43">43</a>
<a id="L44" class="source_line" href="#L44">44</a>
<a id="L45" class="source_line" href="#L45">45</a>
<a id="L46" class="source_line" href="#L46">46</a>
<a id="L47" class="source_line" href="#L47">47</a>
<a id="L48" class="source_line" href="#L48">48</a>
<a id="L49" class="source_line" href="#L49">49</a>
<a id="L50" class="source_line" href="#L50">50</a>
<a id="L51" class="source_line" href="#L51">51</a>
<a id="L52" class="source_line" href="#L52">52</a>
<a id="L53" class="source_line" href="#L53">53</a>
<a id="L54" class="source_line" href="#L54">54</a>
<a id="L55" class="source_line" href="#L55">55</a>
<a id="L56" class="source_line" href="#L56">56</a>
<a id="L57" class="source_line" href="#L57">57</a>
<a id="L58" class="source_line" href="#L58">58</a>
<a id="L59" class="source_line" href="#L59">59</a>
<a id="L60" class="source_line" href="#L60">60</a>
<a id="L61" class="source_line" href="#L61">61</a>
<a id="L62" class="source_line" href="#L62">62</a>
<a id="L63" class="source_line" href="#L63">63</a>
<a id="L64" class="source_line" href="#L64">64</a>
<a id="L65" class="source_line" href="#L65">65</a>
<a id="L66" class="source_line" href="#L66">66</a>
<a id="L67" class="source_line" href="#L67">67</a>
<a id="L68" class="source_line" href="#L68">68</a>
<a id="L69" class="source_line" href="#L69">69</a>
<a id="L70" class="source_line" href="#L70">70</a>
<a id="L71" class="source_line" href="#L71">71</a>
<a id="L72" class="source_line" href="#L72">72</a>
<a id="L73" class="source_line" href="#L73">73</a>
<a id="L74" class="source_line" href="#L74">74</a>
<a id="L75" class="source_line" href="#L75">75</a>
<a id="L76" class="source_line" href="#L76">76</a>
<a id="L77" class="source_line" href="#L77">77</a>
<a id="L78" class="source_line" href="#L78">78</a>
<a id="L79" class="source_line" href="#L79">79</a>
<a id="L80" class="source_line" href="#L80">80</a>
<a id="L81" class="source_line" href="#L81">81</a>
<a id="L82" class="source_line" href="#L82">82</a>
<a id="L83" class="source_line" href="#L83">83</a>
<a id="L84" class="source_line" href="#L84">84</a>
<a id="L85" class="source_line" href="#L85">85</a>
<a id="L86" class="source_line" href="#L86">86</a>
<a id="L87" class="source_line" href="#L87">87</a>
<a id="L88" class="source_line" href="#L88">88</a>
<a id="L89" class="source_line" href="#L89">89</a>
<a id="L90" class="source_line" href="#L90">90</a>
<a id="L91" class="source_line" href="#L91">91</a>
<a id="L92" class="source_line" href="#L92">92</a>
<a id="L93" class="source_line" href="#L93">93</a>
<a id="L94" class="source_line" href="#L94">94</a>
<a id="L95" class="source_line" href="#L95">95</a>
<a id="L96" class="source_line" href="#L96">96</a>
<a id="L97" class="source_line" href="#L97">97</a>
<a id="L98" class="source_line" href="#L98">98</a>
<a id="L99" class="source_line" href="#L99">99</a>
<a id="L100" class="source_line" href="#L100">100</a>
<a id="L101" class="source_line" href="#L101">101</a>
<a id="L102" class="source_line" href="#L102">102</a>
<a id="L103" class="source_line" href="#L103">103</a>
<a id="L104" class="source_line" href="#L104">104</a>
<a id="L105" class="source_line" href="#L105">105</a>
<a id="L106" class="source_line" href="#L106">106</a>
<a id="L107" class="source_line" href="#L107">107</a>
<a id="L108" class="source_line" href="#L108">108</a>
<a id="L109" class="source_line" href="#L109">109</a>
<a id="L110" class="source_line" href="#L110">110</a>
<a id="L111" class="source_line" href="#L111">111</a>
<a id="L112" class="source_line" href="#L112">112</a>
<a id="L113" class="source_line" href="#L113">113</a>
<a id="L114" class="source_line" href="#L114">114</a>
<a id="L115" class="source_line" href="#L115">115</a>
<a id="L116" class="source_line" href="#L116">116</a>
<a id="L117" class="source_line" href="#L117">117</a>
<a id="L118" class="source_line" href="#L118">118</a>
<a id="L119" class="source_line" href="#L119">119</a>
<a id="L120" class="source_line" href="#L120">120</a>
<a id="L121" class="source_line" href="#L121">121</a>
<a id="L122" class="source_line" href="#L122">122</a>
<a id="L123" class="source_line" href="#L123">123</a>
<a id="L124" class="source_line" href="#L124">124</a>
<a id="L125" class="source_line" href="#L125">125</a>
<a id="L126" class="source_line" href="#L126">126</a>
<a id="L127" class="source_line" href="#L127">127</a>
<a id="L128" class="source_line" href="#L128">128</a>
<a id="L129" class="source_line" href="#L129">129</a>
<a id="L130" class="source_line" href="#L130">130</a>
<a id="L131" class="source_line" href="#L131">131</a>
<a id="L132" class="source_line" href="#L132">132</a>
<a id="L133" class="source_line" href="#L133">133</a>
<a id="L134" class="source_line" href="#L134">134</a>
<a id="L135" class="source_line" href="#L135">135</a>
<a id="L136" class="source_line" href="#L136">136</a>
<a id="L137" class="source_line" href="#L137">137</a>
<a id="L138" class="source_line" href="#L138">138</a>
<a id="L139" class="source_line" href="#L139">139</a>
<a id="L140" class="source_line" href="#L140">140</a>
<a id="L141" class="source_line" href="#L141">141</a>
<a id="L142" class="source_line" href="#L142">142</a>
<a id="L143" class="source_line" href="#L143">143</a>
<a id="L144" class="source_line" href="#L144">144</a>
<a id="L145" class="source_line" href="#L145">145</a>
<a id="L146" class="source_line" href="#L146">146</a>
<a id="L147" class="source_line" href="#L147">147</a>
<a id="L148" class="source_line" href="#L148">148</a>
<a id="L149" class="source_line" href="#L149">149</a>
<a id="L150" class="source_line" href="#L150">150</a>
<a id="L151" class="source_line" href="#L151">151</a>
<a id="L152" class="source_line" href="#L152">152</a>
<a id="L153" class="source_line" href="#L153">153</a>
<a id="L154" class="source_line" href="#L154">154</a>
<a id="L155" class="source_line" href="#L155">155</a>
<a id="L156" class="source_line" href="#L156">156</a>
<a id="L157" class="source_line" href="#L157">157</a>
<a id="L158" class="source_line" href="#L158">158</a>
<a id="L159" class="source_line" href="#L159">159</a>
<a id="L160" class="source_line" href="#L160">160</a>
<a id="L161" class="source_line" href="#L161">161</a>
<a id="L162" class="source_line" href="#L162">162</a>
<a id="L163" class="source_line" href="#L163">163</a>
<a id="L164" class="source_line" href="#L164">164</a>
<a id="L165" class="source_line" href="#L165">165</a>
<a id="L166" class="source_line" href="#L166">166</a>
<a id="L167" class="source_line" href="#L167">167</a>
<a id="L168" class="source_line" href="#L168">168</a>
<a id="L169" class="source_line" href="#L169">169</a>
<a id="L170" class="source_line" href="#L170">170</a>
<a id="L171" class="source_line" href="#L171">171</a>
<a id="L172" class="source_line" href="#L172">172</a>
<a id="L173" class="source_line" href="#L173">173</a>
<a id="L174" class="source_line" href="#L174">174</a>
<a id="L175" class="source_line" href="#L175">175</a>
<a id="L176" class="source_line" href="#L176">176</a>
<a id="L177" class="source_line" href="#L177">177</a>
<a id="L178" class="source_line" href="#L178">178</a>
<a id="L179" class="source_line" href="#L179">179</a>
<a id="L180" class="source_line" href="#L180">180</a>
<a id="L181" class="source_line" href="#L181">181</a>
<a id="L182" class="source_line" href="#L182">182</a>
<a id="L183" class="source_line" href="#L183">183</a>
<a id="L184" class="source_line" href="#L184">184</a>
<a id="L185" class="source_line" href="#L185">185</a>
<a id="L186" class="source_line" href="#L186">186</a>
<a id="L187" class="source_line" href="#L187">187</a>
<a id="L188" class="source_line" href="#L188">188</a>
<a id="L189" class="source_line" href="#L189">189</a>
<a id="L190" class="source_line" href="#L190">190</a>
<a id="L191" class="source_line" href="#L191">191</a>
<a id="L192" class="source_line" href="#L192">192</a>
<a id="L193" class="source_line" href="#L193">193</a>
<a id="L194" class="source_line" href="#L194">194</a>
<a id="L195" class="source_line" href="#L195">195</a>
<a id="L196" class="source_line" href="#L196">196</a>
<a id="L197" class="source_line" href="#L197">197</a>
<a id="L198" class="source_line" href="#L198">198</a>
<a id="L199" class="source_line" href="#L199">199</a>
<a id="L200" class="source_line" href="#L200">200</a>
<a id="L201" class="source_line" href="#L201">201</a>
<a id="L202" class="source_line" href="#L202">202</a>
<a id="L203" class="source_line" href="#L203">203</a>
<a id="L204" class="source_line" href="#L204">204</a>
<a id="L205" class="source_line" href="#L205">205</a>
<a id="L206" class="source_line" href="#L206">206</a>
<a id="L207" class="source_line" href="#L207">207</a>
<a id="L208" class="source_line" href="#L208">208</a>
<a id="L209" class="source_line" href="#L209">209</a>
<a id="L210" class="source_line" href="#L210">210</a>
<a id="L211" class="source_line" href="#L211">211</a>
<a id="L212" class="source_line" href="#L212">212</a>
<a id="L213" class="source_line" href="#L213">213</a>
<a id="L214" class="source_line" href="#L214">214</a>
<a id="L215" class="source_line" href="#L215">215</a>
<a id="L216" class="source_line" href="#L216">216</a>
<a id="L217" class="source_line" href="#L217">217</a>
<a id="L218" class="source_line" href="#L218">218</a>
<a id="L219" class="source_line" href="#L219">219</a>
<a id="L220" class="source_line" href="#L220">220</a>
<a id="L221" class="source_line" href="#L221">221</a>
<a id="L222" class="source_line" href="#L222">222</a>
<a id="L223" class="source_line" href="#L223">223</a>
<a id="L224" class="source_line" href="#L224">224</a>
<a id="L225" class="source_line" href="#L225">225</a>
<a id="L226" class="source_line" href="#L226">226</a>
<a id="L227" class="source_line" href="#L227">227</a>
<a id="L228" class="source_line" href="#L228">228</a>
<a id="L229" class="source_line" href="#L229">229</a>
<a id="L230" class="source_line" href="#L230">230</a>
<a id="L231" class="source_line" href="#L231">231</a>
<a id="L232" class="source_line" href="#L232">232</a>
<a id="L233" class="source_line" href="#L233">233</a>
<a id="L234" class="source_line" href="#L234">234</a>
<a id="L235" class="source_line" href="#L235">235</a>
<a id="L236" class="source_line" href="#L236">236</a>
<a id="L237" class="source_line" href="#L237">237</a>
<a id="L238" class="source_line" href="#L238">238</a>
<a id="L239" class="source_line" href="#L239">239</a>
<a id="L240" class="source_line" href="#L240">240</a>
<a id="L241" class="source_line" href="#L241">241</a>
<a id="L242" class="source_line" href="#L242">242</a>
<a id="L243" class="source_line" href="#L243">243</a>
<a id="L244" class="source_line" href="#L244">244</a>
<a id="L245" class="source_line" href="#L245">245</a>
<a id="L246" class="source_line" href="#L246">246</a>
<a id="L247" class="source_line" href="#L247">247</a>
<a id="L248" class="source_line" href="#L248">248</a>
<a id="L249" class="source_line" href="#L249">249</a>
<a id="L250" class="source_line" href="#L250">250</a>
<a id="L251" class="source_line" href="#L251">251</a>
<a id="L252" class="source_line" href="#L252">252</a>
<a id="L253" class="source_line" href="#L253">253</a>
<a id="L254" class="source_line" href="#L254">254</a>
<a id="L255" class="source_line" href="#L255">255</a>
<a id="L256" class="source_line" href="#L256">256</a>
<a id="L257" class="source_line" href="#L257">257</a>
<a id="L258" class="source_line" href="#L258">258</a>
<a id="L259" class="source_line" href="#L259">259</a>
<a id="L260" class="source_line" href="#L260">260</a>
<a id="L261" class="source_line" href="#L261">261</a>
<a id="L262" class="source_line" href="#L262">262</a>
<a id="L263" class="source_line" href="#L263">263</a>
<a id="L264" class="source_line" href="#L264">264</a>
<a id="L265" class="source_line" href="#L265">265</a>
<a id="L266" class="source_line" href="#L266">266</a>
<a id="L267" class="source_line" href="#L267">267</a>
<a id="L268" class="source_line" href="#L268">268</a>
<a id="L269" class="source_line" href="#L269">269</a>
<a id="L270" class="source_line" href="#L270">270</a>
<a id="L271" class="source_line" href="#L271">271</a>
<a id="L272" class="source_line" href="#L272">272</a>
<a id="L273" class="source_line" href="#L273">273</a>
<a id="L274" class="source_line" href="#L274">274</a>
<a id="L275" class="source_line" href="#L275">275</a>
<a id="L276" class="source_line" href="#L276">276</a>
<a id="L277" class="source_line" href="#L277">277</a>
<a id="L278" class="source_line" href="#L278">278</a>
<a id="L279" class="source_line" href="#L279">279</a>
<a id="L280" class="source_line" href="#L280">280</a>
<a id="L281" class="source_line" href="#L281">281</a>
<a id="L282" class="source_line" href="#L282">282</a>
<a id="L283" class="source_line" href="#L283">283</a>
<a id="L284" class="source_line" href="#L284">284</a>
<a id="L285" class="source_line" href="#L285">285</a>
<a id="L286" class="source_line" href="#L286">286</a>
<a id="L287" class="source_line" href="#L287">287</a>
<a id="L288" class="source_line" href="#L288">288</a>
<a id="L289" class="source_line" href="#L289">289</a>
<a id="L290" class="source_line" href="#L290">290</a>
<a id="L291" class="source_line" href="#L291">291</a>
<a id="L292" class="source_line" href="#L292">292</a>
<a id="L293" class="source_line" href="#L293">293</a>
<a id="L294" class="source_line" href="#L294">294</a>
<a id="L295" class="source_line" href="#L295">295</a>
<a id="L296" class="source_line" href="#L296">296</a>
<a id="L297" class="source_line" href="#L297">297</a>
<a id="L298" class="source_line" href="#L298">298</a>
<a id="L299" class="source_line" href="#L299">299</a>
<a id="L300" class="source_line" href="#L300">300</a>
<a id="L301" class="source_line" href="#L301">301</a>
<a id="L302" class="source_line" href="#L302">302</a>
<a id="L303" class="source_line" href="#L303">303</a>
<a id="L304" class="source_line" href="#L304">304</a>
<a id="L305" class="source_line" href="#L305">305</a>
<a id="L306" class="source_line" href="#L306">306</a>
<a id="L307" class="source_line" href="#L307">307</a>
<a id="L308" class="source_line" href="#L308">308</a>
<a id="L309" class="source_line" href="#L309">309</a>
<a id="L310" class="source_line" href="#L310">310</a>
<a id="L311" class="source_line" href="#L311">311</a>
<a id="L312" class="source_line" href="#L312">312</a>
<a id="L313" class="source_line" href="#L313">313</a>
<a id="L314" class="source_line" href="#L314">314</a>
<a id="L315" class="source_line" href="#L315">315</a>
<a id="L316" class="source_line" href="#L316">316</a>
<a id="L317" class="source_line" href="#L317">317</a>
<a id="L318" class="source_line" href="#L318">318</a>
<a id="L319" class="source_line" href="#L319">319</a>
<a id="L320" class="source_line" href="#L320">320</a>
<a id="L321" class="source_line" href="#L321">321</a>
<a id="L322" class="source_line" href="#L322">322</a>
<a id="L323" class="source_line" href="#L323">323</a>
<a id="L324" class="source_line" href="#L324">324</a>
<a id="L325" class="source_line" href="#L325">325</a>
<a id="L326" class="source_line" href="#L326">326</a>
<a id="L327" class="source_line" href="#L327">327</a>
<a id="L328" class="source_line" href="#L328">328</a>
<a id="L329" class="source_line" href="#L329">329</a>
<a id="L330" class="source_line" href="#L330">330</a>
<a id="L331" class="source_line" href="#L331">331</a>
<a id="L332" class="source_line" href="#L332">332</a>
<a id="L333" class="source_line" href="#L333">333</a>
<a id="L334" class="source_line" href="#L334">334</a>
<a id="L335" class="source_line" href="#L335">335</a>
<a id="L336" class="source_line" href="#L336">336</a>
<a id="L337" class="source_line" href="#L337">337</a>
<a id="L338" class="source_line" href="#L338">338</a>
<a id="L339" class="source_line" href="#L339">339</a>
<a id="L340" class="source_line" href="#L340">340</a>
<a id="L341" class="source_line" href="#L341">341</a>
<a id="L342" class="source_line" href="#L342">342</a>
<a id="L343" class="source_line" href="#L343">343</a>
<a id="L344" class="source_line" href="#L344">344</a>
<a id="L345" class="source_line" href="#L345">345</a>
<a id="L346" class="source_line" href="#L346">346</a>
<a id="L347" class="source_line" href="#L347">347</a>
<a id="L348" class="source_line" href="#L348">348</a>
<a id="L349" class="source_line" href="#L349">349</a>
<a id="L350" class="source_line" href="#L350">350</a>
<a id="L351" class="source_line" href="#L351">351</a>
<a id="L352" class="source_line" href="#L352">352</a>
<a id="L353" class="source_line" href="#L353">353</a>
<a id="L354" class="source_line" href="#L354">354</a>
<a id="L355" class="source_line" href="#L355">355</a>
<a id="L356" class="source_line" href="#L356">356</a>
<a id="L357" class="source_line" href="#L357">357</a>
<a id="L358" class="source_line" href="#L358">358</a>
<a id="L359" class="source_line" href="#L359">359</a>
<a id="L360" class="source_line" href="#L360">360</a>
<a id="L361" class="source_line" href="#L361">361</a>
<a id="L362" class="source_line" href="#L362">362</a>
<a id="L363" class="source_line" href="#L363">363</a>
<a id="L364" class="source_line" href="#L364">364</a>
<a id="L365" class="source_line" href="#L365">365</a>
<a id="L366" class="source_line" href="#L366">366</a>
<a id="L367" class="source_line" href="#L367">367</a>
<a id="L368" class="source_line" href="#L368">368</a>
<a id="L369" class="source_line" href="#L369">369</a>
<a id="L370" class="source_line" href="#L370">370</a>
<a id="L371" class="source_line" href="#L371">371</a>
<a id="L372" class="source_line" href="#L372">372</a>
<a id="L373" class="source_line" href="#L373">373</a>
<a id="L374" class="source_line" href="#L374">374</a>
<a id="L375" class="source_line" href="#L375">375</a>
<a id="L376" class="source_line" href="#L376">376</a>
<a id="L377" class="source_line" href="#L377">377</a>
<a id="L378" class="source_line" href="#L378">378</a>
<a id="L379" class="source_line" href="#L379">379</a>
<a id="L380" class="source_line" href="#L380">380</a>
<a id="L381" class="source_line" href="#L381">381</a>
<a id="L382" class="source_line" href="#L382">382</a>
<a id="L383" class="source_line" href="#L383">383</a>
<a id="L384" class="source_line" href="#L384">384</a>
<a id="L385" class="source_line" href="#L385">385</a>
<a id="L386" class="source_line" href="#L386">386</a>
<a id="L387" class="source_line" href="#L387">387</a>
<a id="L388" class="source_line" href="#L388">388</a>
<a id="L389" class="source_line" href="#L389">389</a>
<a id="L390" class="source_line" href="#L390">390</a>
<a id="L391" class="source_line" href="#L391">391</a>
<a id="L392" class="source_line" href="#L392">392</a>
<a id="L393" class="source_line" href="#L393">393</a>
<a id="L394" class="source_line" href="#L394">394</a>
<a id="L395" class="source_line" href="#L395">395</a>
<a id="L396" class="source_line" href="#L396">396</a>
<a id="L397" class="source_line" href="#L397">397</a>
<a id="L398" class="source_line" href="#L398">398</a>
<a id="L399" class="source_line" href="#L399">399</a>
<a id="L400" class="source_line" href="#L400">400</a>
<a id="L401" class="source_line" href="#L401">401</a>
<a id="L402" class="source_line" href="#L402">402</a>
<a id="L403" class="source_line" href="#L403">403</a>
<a id="L404" class="source_line" href="#L404">404</a>
<a id="L405" class="source_line" href="#L405">405</a>
<a id="L406" class="source_line" href="#L406">406</a>
<a id="L407" class="source_line" href="#L407">407</a>
<a id="L408" class="source_line" href="#L408">408</a>
<a id="L409" class="source_line" href="#L409">409</a>
<a id="L410" class="source_line" href="#L410">410</a>
<a id="L411" class="source_line" href="#L411">411</a>
<a id="L412" class="source_line" href="#L412">412</a>
<a id="L413" class="source_line" href="#L413">413</a>
<a id="L414" class="source_line" href="#L414">414</a>
<a id="L415" class="source_line" href="#L415">415</a>
<a id="L416" class="source_line" href="#L416">416</a>
<a id="L417" class="source_line" href="#L417">417</a>
<a id="L418" class="source_line" href="#L418">418</a>
<a id="L419" class="source_line" href="#L419">419</a>
<a id="L420" class="source_line" href="#L420">420</a>
<a id="L421" class="source_line" href="#L421">421</a>
<a id="L422" class="source_line" href="#L422">422</a>
<a id="L423" class="source_line" href="#L423">423</a>
<a id="L424" class="source_line" href="#L424">424</a>
<a id="L425" class="source_line" href="#L425">425</a>
<a id="L426" class="source_line" href="#L426">426</a>
<a id="L427" class="source_line" href="#L427">427</a>
<a id="L428" class="source_line" href="#L428">428</a>
<a id="L429" class="source_line" href="#L429">429</a>
<a id="L430" class="source_line" href="#L430">430</a>
<a id="L431" class="source_line" href="#L431">431</a>
<a id="L432" class="source_line" href="#L432">432</a>
<a id="L433" class="source_line" href="#L433">433</a>
<a id="L434" class="source_line" href="#L434">434</a>
<a id="L435" class="source_line" href="#L435">435</a>
<a id="L436" class="source_line" href="#L436">436</a>
<a id="L437" class="source_line" href="#L437">437</a>
<a id="L438" class="source_line" href="#L438">438</a>
<a id="L439" class="source_line" href="#L439">439</a>
<a id="L440" class="source_line" href="#L440">440</a>
<a id="L441" class="source_line" href="#L441">441</a>
<a id="L442" class="source_line" href="#L442">442</a>
<a id="L443" class="source_line" href="#L443">443</a>
<a id="L444" class="source_line" href="#L444">444</a>
<a id="L445" class="source_line" href="#L445">445</a>
<a id="L446" class="source_line" href="#L446">446</a>
<a id="L447" class="source_line" href="#L447">447</a>
<a id="L448" class="source_line" href="#L448">448</a>
<a id="L449" class="source_line" href="#L449">449</a>
<a id="L450" class="source_line" href="#L450">450</a>
<a id="L451" class="source_line" href="#L451">451</a>
<a id="L452" class="source_line" href="#L452">452</a>
<a id="L453" class="source_line" href="#L453">453</a>
<a id="L454" class="source_line" href="#L454">454</a>
<a id="L455" class="source_line" href="#L455">455</a>
<a id="L456" class="source_line" href="#L456">456</a>
<a id="L457" class="source_line" href="#L457">457</a>
<a id="L458" class="source_line" href="#L458">458</a>
<a id="L459" class="source_line" href="#L459">459</a>
<a id="L460" class="source_line" href="#L460">460</a>
<a id="L461" class="source_line" href="#L461">461</a>
<a id="L462" class="source_line" href="#L462">462</a>
<a id="L463" class="source_line" href="#L463">463</a>
<a id="L464" class="source_line" href="#L464">464</a>
<a id="L465" class="source_line" href="#L465">465</a>
<a id="L466" class="source_line" href="#L466">466</a>
<a id="L467" class="source_line" href="#L467">467</a>
<a id="L468" class="source_line" href="#L468">468</a>
<a id="L469" class="source_line" href="#L469">469</a>
<a id="L470" class="source_line" href="#L470">470</a>
<a id="L471" class="source_line" href="#L471">471</a>
<a id="L472" class="source_line" href="#L472">472</a>
<a id="L473" class="source_line" href="#L473">473</a>
<a id="L474" class="source_line" href="#L474">474</a>
<a id="L475" class="source_line" href="#L475">475</a>
<a id="L476" class="source_line" href="#L476">476</a>
<a id="L477" class="source_line" href="#L477">477</a>
<a id="L478" class="source_line" href="#L478">478</a>
<a id="L479" class="source_line" href="#L479">479</a>
<a id="L480" class="source_line" href="#L480">480</a>
<a id="L481" class="source_line" href="#L481">481</a>
<a id="L482" class="source_line" href="#L482">482</a>
<a id="L483" class="source_line" href="#L483">483</a>
<a id="L484" class="source_line" href="#L484">484</a>
<a id="L485" class="source_line" href="#L485">485</a>
<a id="L486" class="source_line" href="#L486">486</a>
<a id="L487" class="source_line" href="#L487">487</a>
<a id="L488" class="source_line" href="#L488">488</a>
<a id="L489" class="source_line" href="#L489">489</a>
<a id="L490" class="source_line" href="#L490">490</a>
<a id="L491" class="source_line" href="#L491">491</a>
<a id="L492" class="source_line" href="#L492">492</a>
<a id="L493" class="source_line" href="#L493">493</a>
<a id="L494" class="source_line" href="#L494">494</a>
<a id="L495" class="source_line" href="#L495">495</a>
<a id="L496" class="source_line" href="#L496">496</a>
<a id="L497" class="source_line" href="#L497">497</a>
<a id="L498" class="source_line" href="#L498">498</a>
<a id="L499" class="source_line" href="#L499">499</a>
<a id="L500" class="source_line" href="#L500">500</a>
<a id="L501" class="source_line" href="#L501">501</a>
<a id="L502" class="source_line" href="#L502">502</a>
<a id="L503" class="source_line" href="#L503">503</a>
<a id="L504" class="source_line" href="#L504">504</a>
<a id="L505" class="source_line" href="#L505">505</a>
<a id="L506" class="source_line" href="#L506">506</a>
<a id="L507" class="source_line" href="#L507">507</a>
<a id="L508" class="source_line" href="#L508">508</a>
<a id="L509" class="source_line" href="#L509">509</a>
<a id="L510" class="source_line" href="#L510">510</a>
<a id="L511" class="source_line" href="#L511">511</a>
<a id="L512" class="source_line" href="#L512">512</a>
<a id="L513" class="source_line" href="#L513">513</a>
<a id="L514" class="source_line" href="#L514">514</a>
<a id="L515" class="source_line" href="#L515">515</a>
<a id="L516" class="source_line" href="#L516">516</a>
<a id="L517" class="source_line" href="#L517">517</a>
<a id="L518" class="source_line" href="#L518">518</a>
<a id="L519" class="source_line" href="#L519">519</a>
<a id="L520" class="source_line" href="#L520">520</a>
<a id="L521" class="source_line" href="#L521">521</a>
<a id="L522" class="source_line" href="#L522">522</a>
<a id="L523" class="source_line" href="#L523">523</a>
<a id="L524" class="source_line" href="#L524">524</a>
<a id="L525" class="source_line" href="#L525">525</a>
<a id="L526" class="source_line" href="#L526">526</a>
<a id="L527" class="source_line" href="#L527">527</a>
<a id="L528" class="source_line" href="#L528">528</a>
<a id="L529" class="source_line" href="#L529">529</a>
<a id="L530" class="source_line" href="#L530">530</a>
<a id="L531" class="source_line" href="#L531">531</a>
<a id="L532" class="source_line" href="#L532">532</a>
<a id="L533" class="source_line" href="#L533">533</a>
<a id="L534" class="source_line" href="#L534">534</a>
<a id="L535" class="source_line" href="#L535">535</a>
<a id="L536" class="source_line" href="#L536">536</a>
<a id="L537" class="source_line" href="#L537">537</a>
<a id="L538" class="source_line" href="#L538">538</a>
<a id="L539" class="source_line" href="#L539">539</a>
<a id="L540" class="source_line" href="#L540">540</a>
<a id="L541" class="source_line" href="#L541">541</a>
<a id="L542" class="source_line" href="#L542">542</a>
<a id="L543" class="source_line" href="#L543">543</a>
<a id="L544" class="source_line" href="#L544">544</a>
<a id="L545" class="source_line" href="#L545">545</a>
<a id="L546" class="source_line" href="#L546">546</a>
<a id="L547" class="source_line" href="#L547">547</a>
<a id="L548" class="source_line" href="#L548">548</a>
<a id="L549" class="source_line" href="#L549">549</a>
<a id="L550" class="source_line" href="#L550">550</a>
<a id="L551" class="source_line" href="#L551">551</a>
<a id="L552" class="source_line" href="#L552">552</a>
<a id="L553" class="source_line" href="#L553">553</a>
<a id="L554" class="source_line" href="#L554">554</a>
<a id="L555" class="source_line" href="#L555">555</a>
<a id="L556" class="source_line" href="#L556">556</a>
<a id="L557" class="source_line" href="#L557">557</a>
<a id="L558" class="source_line" href="#L558">558</a>
<a id="L559" class="source_line" href="#L559">559</a>
<a id="L560" class="source_line" href="#L560">560</a>
<a id="L561" class="source_line" href="#L561">561</a>
<a id="L562" class="source_line" href="#L562">562</a>
<a id="L563" class="source_line" href="#L563">563</a>
<a id="L564" class="source_line" href="#L564">564</a>
<a id="L565" class="source_line" href="#L565">565</a>
<a id="L566" class="source_line" href="#L566">566</a>
<a id="L567" class="source_line" href="#L567">567</a>
<a id="L568" class="source_line" href="#L568">568</a>
<a id="L569" class="source_line" href="#L569">569</a>
<a id="L570" class="source_line" href="#L570">570</a>
<a id="L571" class="source_line" href="#L571">571</a>
<a id="L572" class="source_line" href="#L572">572</a>
<a id="L573" class="source_line" href="#L573">573</a>
<a id="L574" class="source_line" href="#L574">574</a>
<a id="L575" class="source_line" href="#L575">575</a>
<a id="L576" class="source_line" href="#L576">576</a>
<a id="L577" class="source_line" href="#L577">577</a>
<a id="L578" class="source_line" href="#L578">578</a>
<a id="L579" class="source_line" href="#L579">579</a>
<a id="L580" class="source_line" href="#L580">580</a>
<a id="L581" class="source_line" href="#L581">581</a>
<a id="L582" class="source_line" href="#L582">582</a>
<a id="L583" class="source_line" href="#L583">583</a>
<a id="L584" class="source_line" href="#L584">584</a>
<a id="L585" class="source_line" href="#L585">585</a>
<a id="L586" class="source_line" href="#L586">586</a>
<a id="L587" class="source_line" href="#L587">587</a>
<a id="L588" class="source_line" href="#L588">588</a>
<a id="L589" class="source_line" href="#L589">589</a>
<a id="L590" class="source_line" href="#L590">590</a>
<a id="L591" class="source_line" href="#L591">591</a>
<a id="L592" class="source_line" href="#L592">592</a>
<a id="L593" class="source_line" href="#L593">593</a>
<a id="L594" class="source_line" href="#L594">594</a>
<a id="L595" class="source_line" href="#L595">595</a>
<a id="L596" class="source_line" href="#L596">596</a>
<a id="L597" class="source_line" href="#L597">597</a>
<a id="L598" class="source_line" href="#L598">598</a>
<a id="L599" class="source_line" href="#L599">599</a>
<a id="L600" class="source_line" href="#L600">600</a>
<a id="L601" class="source_line" href="#L601">601</a>
<a id="L602" class="source_line" href="#L602">602</a>
<a id="L603" class="source_line" href="#L603">603</a>
<a id="L604" class="source_line" href="#L604">604</a>
<a id="L605" class="source_line" href="#L605">605</a>
<a id="L606" class="source_line" href="#L606">606</a>
<a id="L607" class="source_line" href="#L607">607</a>
<a id="L608" class="source_line" href="#L608">608</a>
<a id="L609" class="source_line" href="#L609">609</a>
<a id="L610" class="source_line" href="#L610">610</a>
<a id="L611" class="source_line" href="#L611">611</a>
<a id="L612" class="source_line" href="#L612">612</a>
<a id="L613" class="source_line" href="#L613">613</a>
<a id="L614" class="source_line" href="#L614">614</a>
<a id="L615" class="source_line" href="#L615">615</a>
<a id="L616" class="source_line" href="#L616">616</a>
<a id="L617" class="source_line" href="#L617">617</a>
<a id="L618" class="source_line" href="#L618">618</a>
<a id="L619" class="source_line" href="#L619">619</a>
<a id="L620" class="source_line" href="#L620">620</a>
<a id="L621" class="source_line" href="#L621">621</a>
<a id="L622" class="source_line" href="#L622">622</a>
<a id="L623" class="source_line" href="#L623">623</a>
<a id="L624" class="source_line" href="#L624">624</a>
<a id="L625" class="source_line" href="#L625">625</a>
<a id="L626" class="source_line" href="#L626">626</a>
<a id="L627" class="source_line" href="#L627">627</a>
<a id="L628" class="source_line" href="#L628">628</a>
<a id="L629" class="source_line" href="#L629">629</a>
<a id="L630" class="source_line" href="#L630">630</a>
<a id="L631" class="source_line" href="#L631">631</a>
<a id="L632" class="source_line" href="#L632">632</a>
<a id="L633" class="source_line" href="#L633">633</a>
<a id="L634" class="source_line" href="#L634">634</a>
<a id="L635" class="source_line" href="#L635">635</a>
<a id="L636" class="source_line" href="#L636">636</a>
<a id="L637" class="source_line" href="#L637">637</a>
<a id="L638" class="source_line" href="#L638">638</a>
<a id="L639" class="source_line" href="#L639">639</a>
<a id="L640" class="source_line" href="#L640">640</a>
<a id="L641" class="source_line" href="#L641">641</a>
<a id="L642" class="source_line" href="#L642">642</a>
<a id="L643" class="source_line" href="#L643">643</a>
<a id="L644" class="source_line" href="#L644">644</a>
<a id="L645" class="source_line" href="#L645">645</a>
<a id="L646" class="source_line" href="#L646">646</a>
<a id="L647" class="source_line" href="#L647">647</a>
<a id="L648" class="source_line" href="#L648">648</a>
<a id="L649" class="source_line" href="#L649">649</a>
<a id="L650" class="source_line" href="#L650">650</a>
<a id="L651" class="source_line" href="#L651">651</a>
<a id="L652" class="source_line" href="#L652">652</a>
<a id="L653" class="source_line" href="#L653">653</a>
<a id="L654" class="source_line" href="#L654">654</a>
<a id="L655" class="source_line" href="#L655">655</a>
<a id="L656" class="source_line" href="#L656">656</a>
<a id="L657" class="source_line" href="#L657">657</a>
<a id="L658" class="source_line" href="#L658">658</a>
<a id="L659" class="source_line" href="#L659">659</a>
<a id="L660" class="source_line" href="#L660">660</a>
<a id="L661" class="source_line" href="#L661">661</a>
<a id="L662" class="source_line" href="#L662">662</a>
<a id="L663" class="source_line" href="#L663">663</a>
<a id="L664" class="source_line" href="#L664">664</a>
<a id="L665" class="source_line" href="#L665">665</a>
<a id="L666" class="source_line" href="#L666">666</a>
<a id="L667" class="source_line" href="#L667">667</a>
<a id="L668" class="source_line" href="#L668">668</a>
<a id="L669" class="source_line" href="#L669">669</a>
<a id="L670" class="source_line" href="#L670">670</a>
<a id="L671" class="source_line" href="#L671">671</a>
<a id="L672" class="source_line" href="#L672">672</a>
<a id="L673" class="source_line" href="#L673">673</a>
<a id="L674" class="source_line" href="#L674">674</a>
<a id="L675" class="source_line" href="#L675">675</a>
<a id="L676" class="source_line" href="#L676">676</a>
<a id="L677" class="source_line" href="#L677">677</a>
<a id="L678" class="source_line" href="#L678">678</a>
<a id="L679" class="source_line" href="#L679">679</a>
<a id="L680" class="source_line" href="#L680">680</a>
<a id="L681" class="source_line" href="#L681">681</a>
<a id="L682" class="source_line" href="#L682">682</a>
<a id="L683" class="source_line" href="#L683">683</a>
<a id="L684" class="source_line" href="#L684">684</a>
<a id="L685" class="source_line" href="#L685">685</a>
<a id="L686" class="source_line" href="#L686">686</a>
<a id="L687" class="source_line" href="#L687">687</a>
<a id="L688" class="source_line" href="#L688">688</a>
<a id="L689" class="source_line" href="#L689">689</a>
<a id="L690" class="source_line" href="#L690">690</a>
<a id="L691" class="source_line" href="#L691">691</a>
<a id="L692" class="source_line" href="#L692">692</a>
<a id="L693" class="source_line" href="#L693">693</a>
<a id="L694" class="source_line" href="#L694">694</a>
<a id="L695" class="source_line" href="#L695">695</a>
<a id="L696" class="source_line" href="#L696">696</a>
<a id="L697" class="source_line" href="#L697">697</a>
<a id="L698" class="source_line" href="#L698">698</a>
<a id="L699" class="source_line" href="#L699">699</a>
<a id="L700" class="source_line" href="#L700">700</a>
<a id="L701" class="source_line" href="#L701">701</a>
<a id="L702" class="source_line" href="#L702">702</a>
<a id="L703" class="source_line" href="#L703">703</a>
<a id="L704" class="source_line" href="#L704">704</a>
<a id="L705" class="source_line" href="#L705">705</a>
<a id="L706" class="source_line" href="#L706">706</a>
<a id="L707" class="source_line" href="#L707">707</a>
<a id="L708" class="source_line" href="#L708">708</a>
<a id="L709" class="source_line" href="#L709">709</a>
<a id="L710" class="source_line" href="#L710">710</a>
<a id="L711" class="source_line" href="#L711">711</a>
<a id="L712" class="source_line" href="#L712">712</a>
<a id="L713" class="source_line" href="#L713">713</a>
<a id="L714" class="source_line" href="#L714">714</a>
<a id="L715" class="source_line" href="#L715">715</a>
<a id="L716" class="source_line" href="#L716">716</a>
<a id="L717" class="source_line" href="#L717">717</a>
<a id="L718" class="source_line" href="#L718">718</a>
<a id="L719" class="source_line" href="#L719">719</a>
<a id="L720" class="source_line" href="#L720">720</a>
<a id="L721" class="source_line" href="#L721">721</a>
<a id="L722" class="source_line" href="#L722">722</a>
<a id="L723" class="source_line" href="#L723">723</a>
<a id="L724" class="source_line" href="#L724">724</a>
<a id="L725" class="source_line" href="#L725">725</a>
<a id="L726" class="source_line" href="#L726">726</a>
<a id="L727" class="source_line" href="#L727">727</a>
<a id="L728" class="source_line" href="#L728">728</a>
<a id="L729" class="source_line" href="#L729">729</a>
<a id="L730" class="source_line" href="#L730">730</a>
<a id="L731" class="source_line" href="#L731">731</a>
<a id="L732" class="source_line" href="#L732">732</a>
<a id="L733" class="source_line" href="#L733">733</a>
<a id="L734" class="source_line" href="#L734">734</a>
<a id="L735" class="source_line" href="#L735">735</a>
<a id="L736" class="source_line" href="#L736">736</a>
<a id="L737" class="source_line" href="#L737">737</a>
<a id="L738" class="source_line" href="#L738">738</a>
<a id="L739" class="source_line" href="#L739">739</a>
<a id="L740" class="source_line" href="#L740">740</a>
<a id="L741" class="source_line" href="#L741">741</a>
<a id="L742" class="source_line" href="#L742">742</a>
<a id="L743" class="source_line" href="#L743">743</a>
<a id="L744" class="source_line" href="#L744">744</a>
<a id="L745" class="source_line" href="#L745">745</a>
<a id="L746" class="source_line" href="#L746">746</a>
<a id="L747" class="source_line" href="#L747">747</a>
<a id="L748" class="source_line" href="#L748">748</a>
<a id="L749" class="source_line" href="#L749">749</a>
<a id="L750" class="source_line" href="#L750">750</a>
<a id="L751" class="source_line" href="#L751">751</a>
<a id="L752" class="source_line" href="#L752">752</a>
<a id="L753" class="source_line" href="#L753">753</a>
<a id="L754" class="source_line" href="#L754">754</a>
<a id="L755" class="source_line" href="#L755">755</a>
<a id="L756" class="source_line" href="#L756">756</a>
<a id="L757" class="source_line" href="#L757">757</a>
<a id="L758" class="source_line" href="#L758">758</a>
<a id="L759" class="source_line" href="#L759">759</a>
<a id="L760" class="source_line" href="#L760">760</a>
<a id="L761" class="source_line" href="#L761">761</a>
<a id="L762" class="source_line" href="#L762">762</a>
<a id="L763" class="source_line" href="#L763">763</a>
<a id="L764" class="source_line" href="#L764">764</a>
<a id="L765" class="source_line" href="#L765">765</a>
<a id="L766" class="source_line" href="#L766">766</a>
<a id="L767" class="source_line" href="#L767">767</a>
<a id="L768" class="source_line" href="#L768">768</a>
<a id="L769" class="source_line" href="#L769">769</a>
<a id="L770" class="source_line" href="#L770">770</a>
<a id="L771" class="source_line" href="#L771">771</a>
<a id="L772" class="source_line" href="#L772">772</a>
<a id="L773" class="source_line" href="#L773">773</a>
<a id="L774" class="source_line" href="#L774">774</a>
<a id="L775" class="source_line" href="#L775">775</a>
<a id="L776" class="source_line" href="#L776">776</a>
<a id="L777" class="source_line" href="#L777">777</a>
<a id="L778" class="source_line" href="#L778">778</a>
<a id="L779" class="source_line" href="#L779">779</a>
<a id="L780" class="source_line" href="#L780">780</a>
<a id="L781" class="source_line" href="#L781">781</a>
<a id="L782" class="source_line" href="#L782">782</a>
<a id="L783" class="source_line" href="#L783">783</a>
<a id="L784" class="source_line" href="#L784">784</a>
<a id="L785" class="source_line" href="#L785">785</a>
<a id="L786" class="source_line" href="#L786">786</a>
<a id="L787" class="source_line" href="#L787">787</a>
<a id="L788" class="source_line" href="#L788">788</a>
<a id="L789" class="source_line" href="#L789">789</a>
<a id="L790" class="source_line" href="#L790">790</a>
<a id="L791" class="source_line" href="#L791">791</a>
<a id="L792" class="source_line" href="#L792">792</a>
<a id="L793" class="source_line" href="#L793">793</a>
<a id="L794" class="source_line" href="#L794">794</a>
<a id="L795" class="source_line" href="#L795">795</a>
<a id="L796" class="source_line" href="#L796">796</a>
<a id="L797" class="source_line" href="#L797">797</a>
<a id="L798" class="source_line" href="#L798">798</a>
<a id="L799" class="source_line" href="#L799">799</a>
<a id="L800" class="source_line" href="#L800">800</a>
<a id="L801" class="source_line" href="#L801">801</a>
<a id="L802" class="source_line" href="#L802">802</a>
<a id="L803" class="source_line" href="#L803">803</a>
<a id="L804" class="source_line" href="#L804">804</a>
<a id="L805" class="source_line" href="#L805">805</a>
<a id="L806" class="source_line" href="#L806">806</a>
<a id="L807" class="source_line" href="#L807">807</a>
<a id="L808" class="source_line" href="#L808">808</a>
<a id="L809" class="source_line" href="#L809">809</a>
<a id="L810" class="source_line" href="#L810">810</a>
<a id="L811" class="source_line" href="#L811">811</a>
<a id="L812" class="source_line" href="#L812">812</a>
<a id="L813" class="source_line" href="#L813">813</a>
<a id="L814" class="source_line" href="#L814">814</a>
<a id="L815" class="source_line" href="#L815">815</a>
<a id="L816" class="source_line" href="#L816">816</a>
<a id="L817" class="source_line" href="#L817">817</a>
<a id="L818" class="source_line" href="#L818">818</a>
<a id="L819" class="source_line" href="#L819">819</a>
<a id="L820" class="source_line" href="#L820">820</a>
<a id="L821" class="source_line" href="#L821">821</a>
<a id="L822" class="source_line" href="#L822">822</a>
<a id="L823" class="source_line" href="#L823">823</a>
<a id="L824" class="source_line" href="#L824">824</a>
<a id="L825" class="source_line" href="#L825">825</a>
<a id="L826" class="source_line" href="#L826">826</a>
<a id="L827" class="source_line" href="#L827">827</a>
<a id="L828" class="source_line" href="#L828">828</a>
<a id="L829" class="source_line" href="#L829">829</a>
<a id="L830" class="source_line" href="#L830">830</a>
<a id="L831" class="source_line" href="#L831">831</a>
<a id="L832" class="source_line" href="#L832">832</a>
<a id="L833" class="source_line" href="#L833">833</a>
<a id="L834" class="source_line" href="#L834">834</a>
<a id="L835" class="source_line" href="#L835">835</a>
<a id="L836" class="source_line" href="#L836">836</a>
<a id="L837" class="source_line" href="#L837">837</a>
<a id="L838" class="source_line" href="#L838">838</a>
<a id="L839" class="source_line" href="#L839">839</a>
<a id="L840" class="source_line" href="#L840">840</a>
<a id="L841" class="source_line" href="#L841">841</a>
<a id="L842" class="source_line" href="#L842">842</a>
<a id="L843" class="source_line" href="#L843">843</a>
<a id="L844" class="source_line" href="#L844">844</a>
<a id="L845" class="source_line" href="#L845">845</a>
<a id="L846" class="source_line" href="#L846">846</a>
<a id="L847" class="source_line" href="#L847">847</a>
<a id="L848" class="source_line" href="#L848">848</a>
<a id="L849" class="source_line" href="#L849">849</a>
<a id="L850" class="source_line" href="#L850">850</a>
<a id="L851" class="source_line" href="#L851">851</a>
<a id="L852" class="source_line" href="#L852">852</a>
<a id="L853" class="source_line" href="#L853">853</a>
<a id="L854" class="source_line" href="#L854">854</a>
<a id="L855" class="source_line" href="#L855">855</a>
<a id="L856" class="source_line" href="#L856">856</a>
<a id="L857" class="source_line" href="#L857">857</a>
<a id="L858" class="source_line" href="#L858">858</a>
<a id="L859" class="source_line" href="#L859">859</a>
<a id="L860" class="source_line" href="#L860">860</a>
<a id="L861" class="source_line" href="#L861">861</a>
<a id="L862" class="source_line" href="#L862">862</a>
<a id="L863" class="source_line" href="#L863">863</a>
<a id="L864" class="source_line" href="#L864">864</a>
<a id="L865" class="source_line" href="#L865">865</a>
<a id="L866" class="source_line" href="#L866">866</a>
<a id="L867" class="source_line" href="#L867">867</a>
<a id="L868" class="source_line" href="#L868">868</a>
<a id="L869" class="source_line" href="#L869">869</a>
<a id="L870" class="source_line" href="#L870">870</a>
<a id="L871" class="source_line" href="#L871">871</a>
<a id="L872" class="source_line" href="#L872">872</a>
<a id="L873" class="source_line" href="#L873">873</a>
<a id="L874" class="source_line" href="#L874">874</a>
<a id="L875" class="source_line" href="#L875">875</a>
<a id="L876" class="source_line" href="#L876">876</a>
<a id="L877" class="source_line" href="#L877">877</a>
<a id="L878" class="source_line" href="#L878">878</a>
<a id="L879" class="source_line" href="#L879">879</a>
<a id="L880" class="source_line" href="#L880">880</a>
<a id="L881" class="source_line" href="#L881">881</a>
<a id="L882" class="source_line" href="#L882">882</a>
<a id="L883" class="source_line" href="#L883">883</a>
<a id="L884" class="source_line" href="#L884">884</a>
<a id="L885" class="source_line" href="#L885">885</a>
<a id="L886" class="source_line" href="#L886">886</a>
<a id="L887" class="source_line" href="#L887">887</a>
<a id="L888" class="source_line" href="#L888">888</a>
<a id="L889" class="source_line" href="#L889">889</a>
<a id="L890" class="source_line" href="#L890">890</a>
<a id="L891" class="source_line" href="#L891">891</a>
<a id="L892" class="source_line" href="#L892">892</a>
<a id="L893" class="source_line" href="#L893">893</a>
<a id="L894" class="source_line" href="#L894">894</a>
<a id="L895" class="source_line" href="#L895">895</a>
<a id="L896" class="source_line" href="#L896">896</a>
<a id="L897" class="source_line" href="#L897">897</a>
<a id="L898" class="source_line" href="#L898">898</a>
<a id="L899" class="source_line" href="#L899">899</a>
<a id="L900" class="source_line" href="#L900">900</a>
<a id="L901" class="source_line" href="#L901">901</a>
<a id="L902" class="source_line" href="#L902">902</a>
<a id="L903" class="source_line" href="#L903">903</a>
<a id="L904" class="source_line" href="#L904">904</a>
<a id="L905" class="source_line" href="#L905">905</a>
<a id="L906" class="source_line" href="#L906">906</a>
<a id="L907" class="source_line" href="#L907">907</a>
<a id="L908" class="source_line" href="#L908">908</a>
<a id="L909" class="source_line" href="#L909">909</a>
<a id="L910" class="source_line" href="#L910">910</a>
<a id="L911" class="source_line" href="#L911">911</a>
<a id="L912" class="source_line" href="#L912">912</a>
<a id="L913" class="source_line" href="#L913">913</a>
<a id="L914" class="source_line" href="#L914">914</a>
<a id="L915" class="source_line" href="#L915">915</a>
<a id="L916" class="source_line" href="#L916">916</a>
<a id="L917" class="source_line" href="#L917">917</a>
<a id="L918" class="source_line" href="#L918">918</a>
<a id="L919" class="source_line" href="#L919">919</a>
<a id="L920" class="source_line" href="#L920">920</a>
<a id="L921" class="source_line" href="#L921">921</a>
<a id="L922" class="source_line" href="#L922">922</a>
<a id="L923" class="source_line" href="#L923">923</a>
<a id="L924" class="source_line" href="#L924">924</a>
<a id="L925" class="source_line" href="#L925">925</a>
<a id="L926" class="source_line" href="#L926">926</a>
<a id="L927" class="source_line" href="#L927">927</a>
<a id="L928" class="source_line" href="#L928">928</a>
<a id="L929" class="source_line" href="#L929">929</a>
<a id="L930" class="source_line" href="#L930">930</a>
<a id="L931" class="source_line" href="#L931">931</a>
<a id="L932" class="source_line" href="#L932">932</a>
<a id="L933" class="source_line" href="#L933">933</a>
<a id="L934" class="source_line" href="#L934">934</a>
<a id="L935" class="source_line" href="#L935">935</a>
<a id="L936" class="source_line" href="#L936">936</a>
<a id="L937" class="source_line" href="#L937">937</a>
<a id="L938" class="source_line" href="#L938">938</a>
<a id="L939" class="source_line" href="#L939">939</a>
<a id="L940" class="source_line" href="#L940">940</a>
<a id="L941" class="source_line" href="#L941">941</a>
<a id="L942" class="source_line" href="#L942">942</a>
<a id="L943" class="source_line" href="#L943">943</a>
<a id="L944" class="source_line" href="#L944">944</a>
<a id="L945" class="source_line" href="#L945">945</a>
<a id="L946" class="source_line" href="#L946">946</a>
<a id="L947" class="source_line" href="#L947">947</a>
<a id="L948" class="source_line" href="#L948">948</a>
<a id="L949" class="source_line" href="#L949">949</a>
<a id="L950" class="source_line" href="#L950">950</a>
<a id="L951" class="source_line" href="#L951">951</a>
<a id="L952" class="source_line" href="#L952">952</a>
<a id="L953" class="source_line" href="#L953">953</a>
<a id="L954" class="source_line" href="#L954">954</a>
<a id="L955" class="source_line" href="#L955">955</a>
<a id="L956" class="source_line" href="#L956">956</a>
<a id="L957" class="source_line" href="#L957">957</a>
<a id="L958" class="source_line" href="#L958">958</a>
<a id="L959" class="source_line" href="#L959">959</a>
<a id="L960" class="source_line" href="#L960">960</a>
<a id="L961" class="source_line" href="#L961">961</a>
<a id="L962" class="source_line" href="#L962">962</a>
<a id="L963" class="source_line" href="#L963">963</a>
<a id="L964" class="source_line" href="#L964">964</a>
<a id="L965" class="source_line" href="#L965">965</a>
<a id="L966" class="source_line" href="#L966">966</a>
<a id="L967" class="source_line" href="#L967">967</a>
<a id="L968" class="source_line" href="#L968">968</a>
<a id="L969" class="source_line" href="#L969">969</a>
<a id="L970" class="source_line" href="#L970">970</a>
<a id="L971" class="source_line" href="#L971">971</a>
<a id="L972" class="source_line" href="#L972">972</a>
<a id="L973" class="source_line" href="#L973">973</a>
<a id="L974" class="source_line" href="#L974">974</a>
<a id="L975" class="source_line" href="#L975">975</a>
<a id="L976" class="source_line" href="#L976">976</a>
<a id="L977" class="source_line" href="#L977">977</a>
<a id="L978" class="source_line" href="#L978">978</a>
<a id="L979" class="source_line" href="#L979">979</a>
<a id="L980" class="source_line" href="#L980">980</a>
<a id="L981" class="source_line" href="#L981">981</a>
<a id="L982" class="source_line" href="#L982">982</a>
<a id="L983" class="source_line" href="#L983">983</a>
<a id="L984" class="source_line" href="#L984">984</a>
<a id="L985" class="source_line" href="#L985">985</a>
<a id="L986" class="source_line" href="#L986">986</a>
<a id="L987" class="source_line" href="#L987">987</a>
<a id="L988" class="source_line" href="#L988">988</a>
<a id="L989" class="source_line" href="#L989">989</a>
<a id="L990" class="source_line" href="#L990">990</a>
<a id="L991" class="source_line" href="#L991">991</a>
<a id="L992" class="source_line" href="#L992">992</a>
<a id="L993" class="source_line" href="#L993">993</a>
<a id="L994" class="source_line" href="#L994">994</a>
<a id="L995" class="source_line" href="#L995">995</a>
<a id="L996" class="source_line" href="#L996">996</a>
<a id="L997" class="source_line" href="#L997">997</a>
<a id="L998" class="source_line" href="#L998">998</a>
<a id="L999" class="source_line" href="#L999">999</a>
<a id="L1000" class="source_line" href="#L1000">1000</a>
<a id="L1001" class="source_line" href="#L1001">1001</a>
<a id="L1002" class="source_line" href="#L1002">1002</a>
<a id="L1003" class="source_line" href="#L1003">1003</a>
<a id="L1004" class="source_line" href="#L1004">1004</a>
<a id="L1005" class="source_line" href="#L1005">1005</a>
<a id="L1006" class="source_line" href="#L1006">1006</a>
<a id="L1007" class="source_line" href="#L1007">1007</a>
<a id="L1008" class="source_line" href="#L1008">1008</a>
<a id="L1009" class="source_line" href="#L1009">1009</a>
<a id="L1010" class="source_line" href="#L1010">1010</a>
<a id="L1011" class="source_line" href="#L1011">1011</a>
<a id="L1012" class="source_line" href="#L1012">1012</a>
<a id="L1013" class="source_line" href="#L1013">1013</a>
<a id="L1014" class="source_line" href="#L1014">1014</a>
<a id="L1015" class="source_line" href="#L1015">1015</a>
<a id="L1016" class="source_line" href="#L1016">1016</a>
<a id="L1017" class="source_line" href="#L1017">1017</a>
<a id="L1018" class="source_line" href="#L1018">1018</a>
<a id="L1019" class="source_line" href="#L1019">1019</a>
<a id="L1020" class="source_line" href="#L1020">1020</a>
<a id="L1021" class="source_line" href="#L1021">1021</a>
<a id="L1022" class="source_line" href="#L1022">1022</a>
<a id="L1023" class="source_line" href="#L1023">1023</a>
<a id="L1024" class="source_line" href="#L1024">1024</a>
<a id="L1025" class="source_line" href="#L1025">1025</a>
<a id="L1026" class="source_line" href="#L1026">1026</a>
<a id="L1027" class="source_line" href="#L1027">1027</a>
<a id="L1028" class="source_line" href="#L1028">1028</a>
<a id="L1029" class="source_line" href="#L1029">1029</a>
<a id="L1030" class="source_line" href="#L1030">1030</a>
<a id="L1031" class="source_line" href="#L1031">1031</a>
<a id="L1032" class="source_line" href="#L1032">1032</a>
<a id="L1033" class="source_line" href="#L1033">1033</a>
<a id="L1034" class="source_line" href="#L1034">1034</a>
<a id="L1035" class="source_line" href="#L1035">1035</a>
<a id="L1036" class="source_line" href="#L1036">1036</a>
<a id="L1037" class="source_line" href="#L1037">1037</a>
<a id="L1038" class="source_line" href="#L1038">1038</a>
<a id="L1039" class="source_line" href="#L1039">1039</a>
<a id="L1040" class="source_line" href="#L1040">1040</a>
<a id="L1041" class="source_line" href="#L1041">1041</a>
<a id="L1042" class="source_line" href="#L1042">1042</a>
<a id="L1043" class="source_line" href="#L1043">1043</a>
<a id="L1044" class="source_line" href="#L1044">1044</a>
<a id="L1045" class="source_line" href="#L1045">1045</a>
<a id="L1046" class="source_line" href="#L1046">1046</a>
<a id="L1047" class="source_line" href="#L1047">1047</a>
<a id="L1048" class="source_line" href="#L1048">1048</a>
<a id="L1049" class="source_line" href="#L1049">1049</a>
<a id="L1050" class="source_line" href="#L1050">1050</a>
<a id="L1051" class="source_line" href="#L1051">1051</a>
<a id="L1052" class="source_line" href="#L1052">1052</a>
<a id="L1053" class="source_line" href="#L1053">1053</a>
<a id="L1054" class="source_line" href="#L1054">1054</a>
<a id="L1055" class="source_line" href="#L1055">1055</a>
<a id="L1056" class="source_line" href="#L1056">1056</a>
<a id="L1057" class="source_line" href="#L1057">1057</a>
<a id="L1058" class="source_line" href="#L1058">1058</a>
<a id="L1059" class="source_line" href="#L1059">1059</a>
<a id="L1060" class="source_line" href="#L1060">1060</a>
<a id="L1061" class="source_line" href="#L1061">1061</a>
<a id="L1062" class="source_line" href="#L1062">1062</a>
<a id="L1063" class="source_line" href="#L1063">1063</a>
<a id="L1064" class="source_line" href="#L1064">1064</a>
<a id="L1065" class="source_line" href="#L1065">1065</a>
<a id="L1066" class="source_line" href="#L1066">1066</a>
<a id="L1067" class="source_line" href="#L1067">1067</a>
<a id="L1068" class="source_line" href="#L1068">1068</a>
<a id="L1069" class="source_line" href="#L1069">1069</a>
<a id="L1070" class="source_line" href="#L1070">1070</a>
<a id="L1071" class="source_line" href="#L1071">1071</a>
<a id="L1072" class="source_line" href="#L1072">1072</a>
<a id="L1073" class="source_line" href="#L1073">1073</a>
<a id="L1074" class="source_line" href="#L1074">1074</a>
<a id="L1075" class="source_line" href="#L1075">1075</a>
<a id="L1076" class="source_line" href="#L1076">1076</a>
<a id="L1077" class="source_line" href="#L1077">1077</a>
<a id="L1078" class="source_line" href="#L1078">1078</a>
<a id="L1079" class="source_line" href="#L1079">1079</a>
<a id="L1080" class="source_line" href="#L1080">1080</a>
<a id="L1081" class="source_line" href="#L1081">1081</a>
<a id="L1082" class="source_line" href="#L1082">1082</a>
<a id="L1083" class="source_line" href="#L1083">1083</a>
<a id="L1084" class="source_line" href="#L1084">1084</a>
<a id="L1085" class="source_line" href="#L1085">1085</a>
<a id="L1086" class="source_line" href="#L1086">1086</a>
<a id="L1087" class="source_line" href="#L1087">1087</a>
<a id="L1088" class="source_line" href="#L1088">1088</a>
<a id="L1089" class="source_line" href="#L1089">1089</a>
<a id="L1090" class="source_line" href="#L1090">1090</a>
<a id="L1091" class="source_line" href="#L1091">1091</a>
<a id="L1092" class="source_line" href="#L1092">1092</a>
<a id="L1093" class="source_line" href="#L1093">1093</a>
<a id="L1094" class="source_line" href="#L1094">1094</a>
<a id="L1095" class="source_line" href="#L1095">1095</a>
<a id="L1096" class="source_line" href="#L1096">1096</a>
<a id="L1097" class="source_line" href="#L1097">1097</a>
<a id="L1098" class="source_line" href="#L1098">1098</a>
<a id="L1099" class="source_line" href="#L1099">1099</a>
<a id="L1100" class="source_line" href="#L1100">1100</a>
<a id="L1101" class="source_line" href="#L1101">1101</a>
<a id="L1102" class="source_line" href="#L1102">1102</a>
<a id="L1103" class="source_line" href="#L1103">1103</a>
<a id="L1104" class="source_line" href="#L1104">1104</a>
<a id="L1105" class="source_line" href="#L1105">1105</a>
<a id="L1106" class="source_line" href="#L1106">1106</a>
<a id="L1107" class="source_line" href="#L1107">1107</a>
<a id="L1108" class="source_line" href="#L1108">1108</a>
<a id="L1109" class="source_line" href="#L1109">1109</a>
<a id="L1110" class="source_line" href="#L1110">1110</a>
<a id="L1111" class="source_line" href="#L1111">1111</a>
<a id="L1112" class="source_line" href="#L1112">1112</a>
<a id="L1113" class="source_line" href="#L1113">1113</a>
<a id="L1114" class="source_line" href="#L1114">1114</a>
<a id="L1115" class="source_line" href="#L1115">1115</a>
<a id="L1116" class="source_line" href="#L1116">1116</a>
<a id="L1117" class="source_line" href="#L1117">1117</a>
<a id="L1118" class="source_line" href="#L1118">1118</a>
<a id="L1119" class="source_line" href="#L1119">1119</a>
<a id="L1120" class="source_line" href="#L1120">1120</a>
<a id="L1121" class="source_line" href="#L1121">1121</a>
<a id="L1122" class="source_line" href="#L1122">1122</a>
<a id="L1123" class="source_line" href="#L1123">1123</a>
<a id="L1124" class="source_line" href="#L1124">1124</a>
<a id="L1125" class="source_line" href="#L1125">1125</a>
<a id="L1126" class="source_line" href="#L1126">1126</a>
<a id="L1127" class="source_line" href="#L1127">1127</a>
<a id="L1128" class="source_line" href="#L1128">1128</a>
<a id="L1129" class="source_line" href="#L1129">1129</a>
<a id="L1130" class="source_line" href="#L1130">1130</a>
<a id="L1131" class="source_line" href="#L1131">1131</a>
<a id="L1132" class="source_line" href="#L1132">1132</a>
<a id="L1133" class="source_line" href="#L1133">1133</a>
<a id="L1134" class="source_line" href="#L1134">1134</a>
<a id="L1135" class="source_line" href="#L1135">1135</a>
<a id="L1136" class="source_line" href="#L1136">1136</a>
<a id="L1137" class="source_line" href="#L1137">1137</a>
<a id="L1138" class="source_line" href="#L1138">1138</a>
<a id="L1139" class="source_line" href="#L1139">1139</a>
<a id="L1140" class="source_line" href="#L1140">1140</a>
<a id="L1141" class="source_line" href="#L1141">1141</a>
<a id="L1142" class="source_line" href="#L1142">1142</a>
<a id="L1143" class="source_line" href="#L1143">1143</a>
<a id="L1144" class="source_line" href="#L1144">1144</a>
<a id="L1145" class="source_line" href="#L1145">1145</a>
<a id="L1146" class="source_line" href="#L1146">1146</a>
<a id="L1147" class="source_line" href="#L1147">1147</a>
<a id="L1148" class="source_line" href="#L1148">1148</a>
<a id="L1149" class="source_line" href="#L1149">1149</a>
<a id="L1150" class="source_line" href="#L1150">1150</a>
<a id="L1151" class="source_line" href="#L1151">1151</a>
<a id="L1152" class="source_line" href="#L1152">1152</a>
<a id="L1153" class="source_line" href="#L1153">1153</a>
<a id="L1154" class="source_line" href="#L1154">1154</a>
<a id="L1155" class="source_line" href="#L1155">1155</a>
<a id="L1156" class="source_line" href="#L1156">1156</a>
<a id="L1157" class="source_line" href="#L1157">1157</a>
<a id="L1158" class="source_line" href="#L1158">1158</a>
<a id="L1159" class="source_line" href="#L1159">1159</a>
<a id="L1160" class="source_line" href="#L1160">1160</a>
<a id="L1161" class="source_line" href="#L1161">1161</a>
<a id="L1162" class="source_line" href="#L1162">1162</a>
<a id="L1163" class="source_line" href="#L1163">1163</a>
<a id="L1164" class="source_line" href="#L1164">1164</a>
<a id="L1165" class="source_line" href="#L1165">1165</a>
<a id="L1166" class="source_line" href="#L1166">1166</a>
<a id="L1167" class="source_line" href="#L1167">1167</a>
<a id="L1168" class="source_line" href="#L1168">1168</a>
<a id="L1169" class="source_line" href="#L1169">1169</a>
<a id="L1170" class="source_line" href="#L1170">1170</a>
<a id="L1171" class="source_line" href="#L1171">1171</a>
<a id="L1172" class="source_line" href="#L1172">1172</a>
<a id="L1173" class="source_line" href="#L1173">1173</a>
<a id="L1174" class="source_line" href="#L1174">1174</a>
<a id="L1175" class="source_line" href="#L1175">1175</a>
<a id="L1176" class="source_line" href="#L1176">1176</a>
<a id="L1177" class="source_line" href="#L1177">1177</a>
<a id="L1178" class="source_line" href="#L1178">1178</a>
<a id="L1179" class="source_line" href="#L1179">1179</a>
<a id="L1180" class="source_line" href="#L1180">1180</a>
<a id="L1181" class="source_line" href="#L1181">1181</a>
<a id="L1182" class="source_line" href="#L1182">1182</a>
<a id="L1183" class="source_line" href="#L1183">1183</a>
<a id="L1184" class="source_line" href="#L1184">1184</a>
<a id="L1185" class="source_line" href="#L1185">1185</a>
<a id="L1186" class="source_line" href="#L1186">1186</a>
<a id="L1187" class="source_line" href="#L1187">1187</a>
<a id="L1188" class="source_line" href="#L1188">1188</a>
<a id="L1189" class="source_line" href="#L1189">1189</a>
<a id="L1190" class="source_line" href="#L1190">1190</a>
<a id="L1191" class="source_line" href="#L1191">1191</a>
<a id="L1192" class="source_line" href="#L1192">1192</a>
<a id="L1193" class="source_line" href="#L1193">1193</a>
<a id="L1194" class="source_line" href="#L1194">1194</a>
<a id="L1195" class="source_line" href="#L1195">1195</a>
<a id="L1196" class="source_line" href="#L1196">1196</a>
<a id="L1197" class="source_line" href="#L1197">1197</a>
<a id="L1198" class="source_line" href="#L1198">1198</a>
<a id="L1199" class="source_line" href="#L1199">1199</a>
<a id="L1200" class="source_line" href="#L1200">1200</a>
<a id="L1201" class="source_line" href="#L1201">1201</a>
<a id="L1202" class="source_line" href="#L1202">1202</a>
<a id="L1203" class="source_line" href="#L1203">1203</a>
<a id="L1204" class="source_line" href="#L1204">1204</a>
<a id="L1205" class="source_line" href="#L1205">1205</a>
<a id="L1206" class="source_line" href="#L1206">1206</a>
<a id="L1207" class="source_line" href="#L1207">1207</a>
<a id="L1208" class="source_line" href="#L1208">1208</a>
<a id="L1209" class="source_line" href="#L1209">1209</a>
<a id="L1210" class="source_line" href="#L1210">1210</a>
<a id="L1211" class="source_line" href="#L1211">1211</a>
<a id="L1212" class="source_line" href="#L1212">1212</a>
<a id="L1213" class="source_line" href="#L1213">1213</a>
<a id="L1214" class="source_line" href="#L1214">1214</a>
<a id="L1215" class="source_line" href="#L1215">1215</a>
<a id="L1216" class="source_line" href="#L1216">1216</a>
<a id="L1217" class="source_line" href="#L1217">1217</a>
<a id="L1218" class="source_line" href="#L1218">1218</a>
<a id="L1219" class="source_line" href="#L1219">1219</a>
<a id="L1220" class="source_line" href="#L1220">1220</a>
<a id="L1221" class="source_line" href="#L1221">1221</a>
<a id="L1222" class="source_line" href="#L1222">1222</a>
<a id="L1223" class="source_line" href="#L1223">1223</a>
<a id="L1224" class="source_line" href="#L1224">1224</a>
<a id="L1225" class="source_line" href="#L1225">1225</a>
<a id="L1226" class="source_line" href="#L1226">1226</a>
<a id="L1227" class="source_line" href="#L1227">1227</a>
<a id="L1228" class="source_line" href="#L1228">1228</a>
<a id="L1229" class="source_line" href="#L1229">1229</a>
<a id="L1230" class="source_line" href="#L1230">1230</a>
<a id="L1231" class="source_line" href="#L1231">1231</a>
<a id="L1232" class="source_line" href="#L1232">1232</a>
<a id="L1233" class="source_line" href="#L1233">1233</a>
<a id="L1234" class="source_line" href="#L1234">1234</a>
<a id="L1235" class="source_line" href="#L1235">1235</a>
<a id="L1236" class="source_line" href="#L1236">1236</a>
<a id="L1237" class="source_line" href="#L1237">1237</a>
<a id="L1238" class="source_line" href="#L1238">1238</a>
<a id="L1239" class="source_line" href="#L1239">1239</a>
<a id="L1240" class="source_line" href="#L1240">1240</a>
<a id="L1241" class="source_line" href="#L1241">1241</a>
<a id="L1242" class="source_line" href="#L1242">1242</a>
<a id="L1243" class="source_line" href="#L1243">1243</a>
<a id="L1244" class="source_line" href="#L1244">1244</a>
<a id="L1245" class="source_line" href="#L1245">1245</a>
<a id="L1246" class="source_line" href="#L1246">1246</a>
<a id="L1247" class="source_line" href="#L1247">1247</a>
<a id="L1248" class="source_line" href="#L1248">1248</a>
<a id="L1249" class="source_line" href="#L1249">1249</a>
<a id="L1250" class="source_line" href="#L1250">1250</a>
<a id="L1251" class="source_line" href="#L1251">1251</a>
<a id="L1252" class="source_line" href="#L1252">1252</a>
<a id="L1253" class="source_line" href="#L1253">1253</a>
<a id="L1254" class="source_line" href="#L1254">1254</a>
<a id="L1255" class="source_line" href="#L1255">1255</a>
<a id="L1256" class="source_line" href="#L1256">1256</a>
<a id="L1257" class="source_line" href="#L1257">1257</a>
<a id="L1258" class="source_line" href="#L1258">1258</a>
<a id="L1259" class="source_line" href="#L1259">1259</a>
<a id="L1260" class="source_line" href="#L1260">1260</a>
<a id="L1261" class="source_line" href="#L1261">1261</a>
<a id="L1262" class="source_line" href="#L1262">1262</a>
<a id="L1263" class="source_line" href="#L1263">1263</a>
<a id="L1264" class="source_line" href="#L1264">1264</a>
<a id="L1265" class="source_line" href="#L1265">1265</a>
<a id="L1266" class="source_line" href="#L1266">1266</a>
<a id="L1267" class="source_line" href="#L1267">1267</a>
<a id="L1268" class="source_line" href="#L1268">1268</a>
<a id="L1269" class="source_line" href="#L1269">1269</a>
<a id="L1270" class="source_line" href="#L1270">1270</a>
<a id="L1271" class="source_line" href="#L1271">1271</a>
<a id="L1272" class="source_line" href="#L1272">1272</a>
<a id="L1273" class="source_line" href="#L1273">1273</a>
<a id="L1274" class="source_line" href="#L1274">1274</a>
<a id="L1275" class="source_line" href="#L1275">1275</a>
<a id="L1276" class="source_line" href="#L1276">1276</a>
<a id="L1277" class="source_line" href="#L1277">1277</a>
<a id="L1278" class="source_line" href="#L1278">1278</a>
<a id="L1279" class="source_line" href="#L1279">1279</a>
<a id="L1280" class="source_line" href="#L1280">1280</a>
<a id="L1281" class="source_line" href="#L1281">1281</a>
<a id="L1282" class="source_line" href="#L1282">1282</a>
<a id="L1283" class="source_line" href="#L1283">1283</a>
<a id="L1284" class="source_line" href="#L1284">1284</a>
<a id="L1285" class="source_line" href="#L1285">1285</a>
<a id="L1286" class="source_line" href="#L1286">1286</a>
<a id="L1287" class="source_line" href="#L1287">1287</a>
<a id="L1288" class="source_line" href="#L1288">1288</a>
<a id="L1289" class="source_line" href="#L1289">1289</a>
<a id="L1290" class="source_line" href="#L1290">1290</a>
<a id="L1291" class="source_line" href="#L1291">1291</a>
<a id="L1292" class="source_line" href="#L1292">1292</a>
<a id="L1293" class="source_line" href="#L1293">1293</a>
<a id="L1294" class="source_line" href="#L1294">1294</a>
<a id="L1295" class="source_line" href="#L1295">1295</a>
<a id="L1296" class="source_line" href="#L1296">1296</a>
<a id="L1297" class="source_line" href="#L1297">1297</a>
<a id="L1298" class="source_line" href="#L1298">1298</a>
<a id="L1299" class="source_line" href="#L1299">1299</a>
<a id="L1300" class="source_line" href="#L1300">1300</a>
<a id="L1301" class="source_line" href="#L1301">1301</a>
<a id="L1302" class="source_line" href="#L1302">1302</a>
<a id="L1303" class="source_line" href="#L1303">1303</a>
<a id="L1304" class="source_line" href="#L1304">1304</a>
<a id="L1305" class="source_line" href="#L1305">1305</a>
<a id="L1306" class="source_line" href="#L1306">1306</a>
<a id="L1307" class="source_line" href="#L1307">1307</a>
<a id="L1308" class="source_line" href="#L1308">1308</a>
<a id="L1309" class="source_line" href="#L1309">1309</a>
<a id="L1310" class="source_line" href="#L1310">1310</a>
<a id="L1311" class="source_line" href="#L1311">1311</a>
<a id="L1312" class="source_line" href="#L1312">1312</a>
<a id="L1313" class="source_line" href="#L1313">1313</a>
<a id="L1314" class="source_line" href="#L1314">1314</a>
<a id="L1315" class="source_line" href="#L1315">1315</a>
<a id="L1316" class="source_line" href="#L1316">1316</a>
<a id="L1317" class="source_line" href="#L1317">1317</a>
<a id="L1318" class="source_line" href="#L1318">1318</a>
<a id="L1319" class="source_line" href="#L1319">1319</a>
<a id="L1320" class="source_line" href="#L1320">1320</a>
<a id="L1321" class="source_line" href="#L1321">1321</a>
<a id="L1322" class="source_line" href="#L1322">1322</a>
<a id="L1323" class="source_line" href="#L1323">1323</a>
<a id="L1324" class="source_line" href="#L1324">1324</a>
<a id="L1325" class="source_line" href="#L1325">1325</a>
<a id="L1326" class="source_line" href="#L1326">1326</a>
<a id="L1327" class="source_line" href="#L1327">1327</a>
<a id="L1328" class="source_line" href="#L1328">1328</a>
<a id="L1329" class="source_line" href="#L1329">1329</a>
<a id="L1330" class="source_line" href="#L1330">1330</a>
<a id="L1331" class="source_line" href="#L1331">1331</a>
<a id="L1332" class="source_line" href="#L1332">1332</a>
<a id="L1333" class="source_line" href="#L1333">1333</a>
<a id="L1334" class="source_line" href="#L1334">1334</a>
<a id="L1335" class="source_line" href="#L1335">1335</a>
<a id="L1336" class="source_line" href="#L1336">1336</a>
<a id="L1337" class="source_line" href="#L1337">1337</a>
<a id="L1338" class="source_line" href="#L1338">1338</a>
<a id="L1339" class="source_line" href="#L1339">1339</a>
<a id="L1340" class="source_line" href="#L1340">1340</a>
<a id="L1341" class="source_line" href="#L1341">1341</a>
<a id="L1342" class="source_line" href="#L1342">1342</a>
<a id="L1343" class="source_line" href="#L1343">1343</a>
<a id="L1344" class="source_line" href="#L1344">1344</a>
<a id="L1345" class="source_line" href="#L1345">1345</a>
<a id="L1346" class="source_line" href="#L1346">1346</a>
<a id="L1347" class="source_line" href="#L1347">1347</a>
<a id="L1348" class="source_line" href="#L1348">1348</a>
<a id="L1349" class="source_line" href="#L1349">1349</a>
<a id="L1350" class="source_line" href="#L1350">1350</a>
<a id="L1351" class="source_line" href="#L1351">1351</a>
<a id="L1352" class="source_line" href="#L1352">1352</a>
<a id="L1353" class="source_line" href="#L1353">1353</a>
<a id="L1354" class="source_line" href="#L1354">1354</a>
<a id="L1355" class="source_line" href="#L1355">1355</a>
<a id="L1356" class="source_line" href="#L1356">1356</a>
<a id="L1357" class="source_line" href="#L1357">1357</a>
<a id="L1358" class="source_line" href="#L1358">1358</a>
<a id="L1359" class="source_line" href="#L1359">1359</a>
<a id="L1360" class="source_line" href="#L1360">1360</a>
<a id="L1361" class="source_line" href="#L1361">1361</a>
<a id="L1362" class="source_line" href="#L1362">1362</a>
<a id="L1363" class="source_line" href="#L1363">1363</a>
<a id="L1364" class="source_line" href="#L1364">1364</a>
<a id="L1365" class="source_line" href="#L1365">1365</a>
<a id="L1366" class="source_line" href="#L1366">1366</a>
<a id="L1367" class="source_line" href="#L1367">1367</a>
<a id="L1368" class="source_line" href="#L1368">1368</a>
<a id="L1369" class="source_line" href="#L1369">1369</a>
<a id="L1370" class="source_line" href="#L1370">1370</a>
<a id="L1371" class="source_line" href="#L1371">1371</a>
<a id="L1372" class="source_line" href="#L1372">1372</a>
<a id="L1373" class="source_line" href="#L1373">1373</a>
<a id="L1374" class="source_line" href="#L1374">1374</a>
<a id="L1375" class="source_line" href="#L1375">1375</a>
<a id="L1376" class="source_line" href="#L1376">1376</a>
<a id="L1377" class="source_line" href="#L1377">1377</a>
<a id="L1378" class="source_line" href="#L1378">1378</a>
<a id="L1379" class="source_line" href="#L1379">1379</a>
<a id="L1380" class="source_line" href="#L1380">1380</a>
<a id="L1381" class="source_line" href="#L1381">1381</a>
<a id="L1382" class="source_line" href="#L1382">1382</a>
<a id="L1383" class="source_line" href="#L1383">1383</a>
<a id="L1384" class="source_line" href="#L1384">1384</a>
<a id="L1385" class="source_line" href="#L1385">1385</a>
<a id="L1386" class="source_line" href="#L1386">1386</a>
<a id="L1387" class="source_line" href="#L1387">1387</a>
<a id="L1388" class="source_line" href="#L1388">1388</a>
<a id="L1389" class="source_line" href="#L1389">1389</a>
<a id="L1390" class="source_line" href="#L1390">1390</a>
<a id="L1391" class="source_line" href="#L1391">1391</a>
<a id="L1392" class="source_line" href="#L1392">1392</a>
<a id="L1393" class="source_line" href="#L1393">1393</a>
<a id="L1394" class="source_line" href="#L1394">1394</a>
<a id="L1395" class="source_line" href="#L1395">1395</a>
<a id="L1396" class="source_line" href="#L1396">1396</a>
<a id="L1397" class="source_line" href="#L1397">1397</a>
<a id="L1398" class="source_line" href="#L1398">1398</a>
<a id="L1399" class="source_line" href="#L1399">1399</a>
<a id="L1400" class="source_line" href="#L1400">1400</a>
<a id="L1401" class="source_line" href="#L1401">1401</a>
<a id="L1402" class="source_line" href="#L1402">1402</a>
<a id="L1403" class="source_line" href="#L1403">1403</a>
<a id="L1404" class="source_line" href="#L1404">1404</a>
<a id="L1405" class="source_line" href="#L1405">1405</a>
<a id="L1406" class="source_line" href="#L1406">1406</a>
<a id="L1407" class="source_line" href="#L1407">1407</a>
<a id="L1408" class="source_line" href="#L1408">1408</a>
<a id="L1409" class="source_line" href="#L1409">1409</a>
<a id="L1410" class="source_line" href="#L1410">1410</a>
<a id="L1411" class="source_line" href="#L1411">1411</a>
<a id="L1412" class="source_line" href="#L1412">1412</a>
<a id="L1413" class="source_line" href="#L1413">1413</a>
<a id="L1414" class="source_line" href="#L1414">1414</a>
<a id="L1415" class="source_line" href="#L1415">1415</a>
<a id="L1416" class="source_line" href="#L1416">1416</a>
<a id="L1417" class="source_line" href="#L1417">1417</a>
<a id="L1418" class="source_line" href="#L1418">1418</a>
<a id="L1419" class="source_line" href="#L1419">1419</a>
<a id="L1420" class="source_line" href="#L1420">1420</a>
<a id="L1421" class="source_line" href="#L1421">1421</a>
<a id="L1422" class="source_line" href="#L1422">1422</a>
<a id="L1423" class="source_line" href="#L1423">1423</a>
<a id="L1424" class="source_line" href="#L1424">1424</a>
<a id="L1425" class="source_line" href="#L1425">1425</a>
<a id="L1426" class="source_line" href="#L1426">1426</a>
<a id="L1427" class="source_line" href="#L1427">1427</a>
<a id="L1428" class="source_line" href="#L1428">1428</a>
<a id="L1429" class="source_line" href="#L1429">1429</a>
<a id="L1430" class="source_line" href="#L1430">1430</a>
<a id="L1431" class="source_line" href="#L1431">1431</a>
<a id="L1432" class="source_line" href="#L1432">1432</a>
<a id="L1433" class="source_line" href="#L1433">1433</a>
<a id="L1434" class="source_line" href="#L1434">1434</a>
<a id="L1435" class="source_line" href="#L1435">1435</a>
<a id="L1436" class="source_line" href="#L1436">1436</a>
<a id="L1437" class="source_line" href="#L1437">1437</a>
<a id="L1438" class="source_line" href="#L1438">1438</a>
<a id="L1439" class="source_line" href="#L1439">1439</a>
<a id="L1440" class="source_line" href="#L1440">1440</a>
<a id="L1441" class="source_line" href="#L1441">1441</a>
<a id="L1442" class="source_line" href="#L1442">1442</a>
<a id="L1443" class="source_line" href="#L1443">1443</a>
<a id="L1444" class="source_line" href="#L1444">1444</a>
<a id="L1445" class="source_line" href="#L1445">1445</a>
<a id="L1446" class="source_line" href="#L1446">1446</a>
<a id="L1447" class="source_line" href="#L1447">1447</a>
<a id="L1448" class="source_line" href="#L1448">1448</a>
<a id="L1449" class="source_line" href="#L1449">1449</a>
<a id="L1450" class="source_line" href="#L1450">1450</a>
<a id="L1451" class="source_line" href="#L1451">1451</a>
<a id="L1452" class="source_line" href="#L1452">1452</a>
<a id="L1453" class="source_line" href="#L1453">1453</a>
<a id="L1454" class="source_line" href="#L1454">1454</a>
<a id="L1455" class="source_line" href="#L1455">1455</a>
<a id="L1456" class="source_line" href="#L1456">1456</a>
<a id="L1457" class="source_line" href="#L1457">1457</a>
<a id="L1458" class="source_line" href="#L1458">1458</a>
<a id="L1459" class="source_line" href="#L1459">1459</a>
<a id="L1460" class="source_line" href="#L1460">1460</a>
<a id="L1461" class="source_line" href="#L1461">1461</a>
<a id="L1462" class="source_line" href="#L1462">1462</a>
<a id="L1463" class="source_line" href="#L1463">1463</a>
<a id="L1464" class="source_line" href="#L1464">1464</a>
<a id="L1465" class="source_line" href="#L1465">1465</a>
<a id="L1466" class="source_line" href="#L1466">1466</a>
<a id="L1467" class="source_line" href="#L1467">1467</a>
<a id="L1468" class="source_line" href="#L1468">1468</a>
<a id="L1469" class="source_line" href="#L1469">1469</a>
<a id="L1470" class="source_line" href="#L1470">1470</a>
<a id="L1471" class="source_line" href="#L1471">1471</a>
<a id="L1472" class="source_line" href="#L1472">1472</a>
<a id="L1473" class="source_line" href="#L1473">1473</a>
<a id="L1474" class="source_line" href="#L1474">1474</a>
<a id="L1475" class="source_line" href="#L1475">1475</a>
<a id="L1476" class="source_line" href="#L1476">1476</a>
<a id="L1477" class="source_line" href="#L1477">1477</a>
<a id="L1478" class="source_line" href="#L1478">1478</a>
<a id="L1479" class="source_line" href="#L1479">1479</a>
<a id="L1480" class="source_line" href="#L1480">1480</a>
<a id="L1481" class="source_line" href="#L1481">1481</a>
<a id="L1482" class="source_line" href="#L1482">1482</a>
<a id="L1483" class="source_line" href="#L1483">1483</a>
<a id="L1484" class="source_line" href="#L1484">1484</a>
<a id="L1485" class="source_line" href="#L1485">1485</a>
<a id="L1486" class="source_line" href="#L1486">1486</a>
<a id="L1487" class="source_line" href="#L1487">1487</a>
<a id="L1488" class="source_line" href="#L1488">1488</a>
<a id="L1489" class="source_line" href="#L1489">1489</a>
<a id="L1490" class="source_line" href="#L1490">1490</a>
<a id="L1491" class="source_line" href="#L1491">1491</a>
<a id="L1492" class="source_line" href="#L1492">1492</a>
<a id="L1493" class="source_line" href="#L1493">1493</a>
<a id="L1494" class="source_line" href="#L1494">1494</a>
<a id="L1495" class="source_line" href="#L1495">1495</a>
<a id="L1496" class="source_line" href="#L1496">1496</a>
<a id="L1497" class="source_line" href="#L1497">1497</a>
<a id="L1498" class="source_line" href="#L1498">1498</a>
<a id="L1499" class="source_line" href="#L1499">1499</a>
<a id="L1500" class="source_line" href="#L1500">1500</a>
<a id="L1501" class="source_line" href="#L1501">1501</a>
<a id="L1502" class="source_line" href="#L1502">1502</a>
<a id="L1503" class="source_line" href="#L1503">1503</a>
<a id="L1504" class="source_line" href="#L1504">1504</a>
<a id="L1505" class="source_line" href="#L1505">1505</a>
<a id="L1506" class="source_line" href="#L1506">1506</a>
<a id="L1507" class="source_line" href="#L1507">1507</a>
<a id="L1508" class="source_line" href="#L1508">1508</a>
<a id="L1509" class="source_line" href="#L1509">1509</a>
<a id="L1510" class="source_line" href="#L1510">1510</a>
<a id="L1511" class="source_line" href="#L1511">1511</a>
<a id="L1512" class="source_line" href="#L1512">1512</a>
<a id="L1513" class="source_line" href="#L1513">1513</a>
<a id="L1514" class="source_line" href="#L1514">1514</a>
<a id="L1515" class="source_line" href="#L1515">1515</a>
<a id="L1516" class="source_line" href="#L1516">1516</a>
<a id="L1517" class="source_line" href="#L1517">1517</a>
<a id="L1518" class="source_line" href="#L1518">1518</a>
<a id="L1519" class="source_line" href="#L1519">1519</a>
<a id="L1520" class="source_line" href="#L1520">1520</a>
<a id="L1521" class="source_line" href="#L1521">1521</a>
<a id="L1522" class="source_line" href="#L1522">1522</a>
<a id="L1523" class="source_line" href="#L1523">1523</a>
<a id="L1524" class="source_line" href="#L1524">1524</a>
<a id="L1525" class="source_line" href="#L1525">1525</a>
<a id="L1526" class="source_line" href="#L1526">1526</a>
<a id="L1527" class="source_line" href="#L1527">1527</a>
<a id="L1528" class="source_line" href="#L1528">1528</a>
<a id="L1529" class="source_line" href="#L1529">1529</a>
<a id="L1530" class="source_line" href="#L1530">1530</a>
<a id="L1531" class="source_line" href="#L1531">1531</a>
<a id="L1532" class="source_line" href="#L1532">1532</a>
<a id="L1533" class="source_line" href="#L1533">1533</a>
<a id="L1534" class="source_line" href="#L1534">1534</a>
<a id="L1535" class="source_line" href="#L1535">1535</a>
<a id="L1536" class="source_line" href="#L1536">1536</a>
<a id="L1537" class="source_line" href="#L1537">1537</a>
<a id="L1538" class="source_line" href="#L1538">1538</a>
<a id="L1539" class="source_line" href="#L1539">1539</a>
<a id="L1540" class="source_line" href="#L1540">1540</a>
<a id="L1541" class="source_line" href="#L1541">1541</a>
<a id="L1542" class="source_line" href="#L1542">1542</a>
<a id="L1543" class="source_line" href="#L1543">1543</a>
<a id="L1544" class="source_line" href="#L1544">1544</a>
<a id="L1545" class="source_line" href="#L1545">1545</a>
<a id="L1546" class="source_line" href="#L1546">1546</a>
<a id="L1547" class="source_line" href="#L1547">1547</a>
<a id="L1548" class="source_line" href="#L1548">1548</a>
<a id="L1549" class="source_line" href="#L1549">1549</a>
<a id="L1550" class="source_line" href="#L1550">1550</a>
<a id="L1551" class="source_line" href="#L1551">1551</a>
<a id="L1552" class="source_line" href="#L1552">1552</a>
<a id="L1553" class="source_line" href="#L1553">1553</a>
<a id="L1554" class="source_line" href="#L1554">1554</a>
<a id="L1555" class="source_line" href="#L1555">1555</a>
<a id="L1556" class="source_line" href="#L1556">1556</a>
<a id="L1557" class="source_line" href="#L1557">1557</a>
<a id="L1558" class="source_line" href="#L1558">1558</a>
<a id="L1559" class="source_line" href="#L1559">1559</a>
<a id="L1560" class="source_line" href="#L1560">1560</a>
<a id="L1561" class="source_line" href="#L1561">1561</a>
<a id="L1562" class="source_line" href="#L1562">1562</a>
<a id="L1563" class="source_line" href="#L1563">1563</a>
<a id="L1564" class="source_line" href="#L1564">1564</a>
<a id="L1565" class="source_line" href="#L1565">1565</a>
<a id="L1566" class="source_line" href="#L1566">1566</a>
<a id="L1567" class="source_line" href="#L1567">1567</a>
<a id="L1568" class="source_line" href="#L1568">1568</a>
<a id="L1569" class="source_line" href="#L1569">1569</a>
<a id="L1570" class="source_line" href="#L1570">1570</a>
<a id="L1571" class="source_line" href="#L1571">1571</a>
<a id="L1572" class="source_line" href="#L1572">1572</a>
<a id="L1573" class="source_line" href="#L1573">1573</a>
<a id="L1574" class="source_line" href="#L1574">1574</a>
<a id="L1575" class="source_line" href="#L1575">1575</a>
<a id="L1576" class="source_line" href="#L1576">1576</a>
<a id="L1577" class="source_line" href="#L1577">1577</a>
<a id="L1578" class="source_line" href="#L1578">1578</a>
<a id="L1579" class="source_line" href="#L1579">1579</a>
<a id="L1580" class="source_line" href="#L1580">1580</a>
<a id="L1581" class="source_line" href="#L1581">1581</a>
<a id="L1582" class="source_line" href="#L1582">1582</a>
<a id="L1583" class="source_line" href="#L1583">1583</a>
<a id="L1584" class="source_line" href="#L1584">1584</a>
<a id="L1585" class="source_line" href="#L1585">1585</a>
<a id="L1586" class="source_line" href="#L1586">1586</a>
<a id="L1587" class="source_line" href="#L1587">1587</a>
<a id="L1588" class="source_line" href="#L1588">1588</a>
<a id="L1589" class="source_line" href="#L1589">1589</a>
<a id="L1590" class="source_line" href="#L1590">1590</a>
<a id="L1591" class="source_line" href="#L1591">1591</a>
<a id="L1592" class="source_line" href="#L1592">1592</a>
<a id="L1593" class="source_line" href="#L1593">1593</a>
<a id="L1594" class="source_line" href="#L1594">1594</a>
<a id="L1595" class="source_line" href="#L1595">1595</a>
<a id="L1596" class="source_line" href="#L1596">1596</a>
<a id="L1597" class="source_line" href="#L1597">1597</a>
<a id="L1598" class="source_line" href="#L1598">1598</a>
<a id="L1599" class="source_line" href="#L1599">1599</a>
<a id="L1600" class="source_line" href="#L1600">1600</a>
<a id="L1601" class="source_line" href="#L1601">1601</a>
<a id="L1602" class="source_line" href="#L1602">1602</a>
<a id="L1603" class="source_line" href="#L1603">1603</a>
<a id="L1604" class="source_line" href="#L1604">1604</a>
<a id="L1605" class="source_line" href="#L1605">1605</a>
<a id="L1606" class="source_line" href="#L1606">1606</a>
<a id="L1607" class="source_line" href="#L1607">1607</a>
<a id="L1608" class="source_line" href="#L1608">1608</a>
<a id="L1609" class="source_line" href="#L1609">1609</a>
<a id="L1610" class="source_line" href="#L1610">1610</a>
<a id="L1611" class="source_line" href="#L1611">1611</a>
<a id="L1612" class="source_line" href="#L1612">1612</a>
<a id="L1613" class="source_line" href="#L1613">1613</a>
<a id="L1614" class="source_line" href="#L1614">1614</a>
<a id="L1615" class="source_line" href="#L1615">1615</a>
<a id="L1616" class="source_line" href="#L1616">1616</a>
<a id="L1617" class="source_line" href="#L1617">1617</a>
<a id="L1618" class="source_line" href="#L1618">1618</a>
</code><code class="source_code"><span><span class="COMMENT">(**************************************************************************)</span><span class="EOL">
</span><span class="COMMENT">(*                                                                        *)</span><span class="EOL">
</span><span class="COMMENT">(*    Copyright 2012-2020 OCamlPro                                        *)</span><span class="EOL">
</span><span class="COMMENT">(*    Copyright 2012 INRIA                                                *)</span><span class="EOL">
</span><span class="COMMENT">(*                                                                        *)</span><span class="EOL">
</span><span class="COMMENT">(*  All rights reserved. This file is distributed under the terms of the  *)</span><span class="EOL">
</span><span class="COMMENT">(*  GNU Lesser General Public License version 2.1, with the special       *)</span><span class="EOL">
</span><span class="COMMENT">(*  exception on linking described in the file LICENSE.                   *)</span><span class="EOL">
</span><span class="COMMENT">(*                                                                        *)</span><span class="EOL">
</span><span class="COMMENT">(**************************************************************************)</span><span class="EOL">
</span><span class="EOL">
</span><span id="type-install_warning"><span class="TYPE">type</span> <span class="LIDENT">install_warning</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LBRACKET">[</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Add_exe</span> <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Install_dll</span> <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Install_script</span> <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Install_unknown</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Cygwin</span> <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Msys2</span> <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Tainted</span> <span class="OF">of</span> <span class="LBRACKET">[</span><span class="BACKQUOTE">`</span><span class="UIDENT">Msys2</span> <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Cygwin</span><span class="RBRACKET">]</span> <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Cygwin_libraries</span> <span class="RBRACKET">]</span></span><span class="EOL">
</span><span id="type-install_warning_fn"><span class="TYPE">type</span> <span class="LIDENT">install_warning_fn</span> <span class="EQUAL">=</span> <span class="LIDENT">string</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">install_warning</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span></span><span class="EOL">
</span><span class="EOL">
</span><span id="exception-Process_error"><span class="EXCEPTION">exception</span> <span class="UIDENT">Process_error</span> <span class="OF">of</span> <a href="opamProcess.ml.html#type-result"><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="LIDENT">result</span></a></span><span class="EOL">
</span><span id="exception-Internal_error"><span class="EXCEPTION">exception</span> <span class="UIDENT">Internal_error</span> <span class="OF">of</span> <span class="LIDENT">string</span></span><span class="EOL">
</span><span id="exception-Command_not_found"><span class="EXCEPTION">exception</span> <span class="UIDENT">Command_not_found</span> <span class="OF">of</span> <span class="LIDENT">string</span></span><span class="EOL">
</span><span id="exception-File_not_found"><span class="EXCEPTION">exception</span> <span class="UIDENT">File_not_found</span> <span class="OF">of</span> <span class="LIDENT">string</span></span><span class="EOL">
</span><span id="exception-Permission_denied"><span class="EXCEPTION">exception</span> <span class="UIDENT">Permission_denied</span> <span class="OF">of</span> <span class="LIDENT">string</span></span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-log"><span class="LIDENT">log</span></span> <span class="QUESTION">?</span><span id="local_level_1"><span class="LIDENT">level</span></span> <span id="local_fmt_2"><span class="LIDENT">fmt</span></span> <span class="EQUAL">=</span> <a href="opamConsole.ml.html#val-log"><span class="UIDENT">OpamConsole</span><span class="DOT">.</span><span class="LIDENT">log</span></a> <span class="STRING">&quot;SYSTEM&quot;</span> <span class="QUESTION">?</span><a href="#local_level_1"><span class="LIDENT">level</span></a> <a href="#local_fmt_2"><span class="LIDENT">fmt</span></a><span class="EOL">
</span><span class="LET">let</span> <span id="val-slog"><span class="LIDENT">slog</span></span> <span class="EQUAL">=</span> <a href="opamConsole.ml.html#val-slog"><span class="UIDENT">OpamConsole</span><span class="DOT">.</span><span class="LIDENT">slog</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-internal_error"><span class="LIDENT">internal_error</span></span> <span id="local_fmt_3"><span class="LIDENT">fmt</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="../../../ocaml-base-compiler/src/stdlib/printf.ml.html#val-ksprintf"><span class="UIDENT">Printf</span><span class="DOT">.</span><span class="LIDENT">ksprintf</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_str_4"><span class="LIDENT">str</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LIDENT">log</span> <span class="STRING">&quot;error: %s&quot;</span> <a href="#local_str_4"><span class="LIDENT">str</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-raise"><span class="LIDENT">raise</span></a> <span class="LPAREN">(</span><span class="UIDENT">Internal_error</span> <a href="#local_str_4"><span class="LIDENT">str</span></a><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="RPAREN">)</span> <a href="#local_fmt_3"><span class="LIDENT">fmt</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-process_error"><span class="LIDENT">process_error</span></span> <span id="local_r_5"><span class="LIDENT">r</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="#local_r_5"><span class="LIDENT">r</span></a><span class="DOT">.</span><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="LIDENT">r_signal</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="UIDENT">Some</span> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-sigint"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">sigint</span></a> <span class="THEN">then</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-raise"><span class="LIDENT">raise</span></a> <span class="UIDENT">Sys</span><span class="DOT">.</span><span class="UIDENT">Break</span><span class="EOL">
</span>  <span class="ELSE">else</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-raise"><span class="LIDENT">raise</span></a> <span class="LPAREN">(</span><span class="UIDENT">Process_error</span> <a href="#local_r_5"><span class="LIDENT">r</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-raise_on_process_error"><span class="LIDENT">raise_on_process_error</span></span> <span id="local_r_6"><span class="LIDENT">r</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="opamProcess.ml.html#val-is_failure"><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="LIDENT">is_failure</span></a> <a href="#local_r_6"><span class="LIDENT">r</span></a> <span class="THEN">then</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-raise"><span class="LIDENT">raise</span></a> <span class="LPAREN">(</span><span class="UIDENT">Process_error</span> <a href="#local_r_6"><span class="LIDENT">r</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-command_not_found"><span class="LIDENT">command_not_found</span></span> <span id="local_cmd_7"><span class="LIDENT">cmd</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-raise"><span class="LIDENT">raise</span></a> <span class="LPAREN">(</span><span class="UIDENT">Command_not_found</span> <a href="#local_cmd_7"><span class="LIDENT">cmd</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-permission_denied"><span class="LIDENT">permission_denied</span></span> <span id="local_cmd_8"><span class="LIDENT">cmd</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-raise"><span class="LIDENT">raise</span></a> <span class="LPAREN">(</span><span class="UIDENT">Permission_denied</span> <a href="#local_cmd_8"><span class="LIDENT">cmd</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span id="module-Sys2"><span class="MODULE">module</span> <span class="UIDENT">Sys2</span> <span class="EQUAL">=</span> <span class="STRUCT">struct</span><span class="EOL">
</span>  <span class="COMMENT">(* same as [Sys.is_directory] except for symlinks, which returns always [false]. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Sys2.val-is_directory"><span class="LIDENT">is_directory</span></span> <span id="local_file_9"><span class="LIDENT">file</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="TRY">try</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LPAREN">(</span> <span class="LPAREN">(</span><span class="LIDENT">lstat</span> <a href="#local_file_9"><span class="LIDENT">file</span></a><span class="RPAREN">)</span><span class="DOT">.</span><span class="LIDENT">st_kind</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="UIDENT">S_DIR</span> <span class="RPAREN">)</span><span class="EOL">
</span>    <span class="WITH">with</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">Unix_error</span> <span class="UNDERSCORE">_</span> <span class="AS">as</span> <span id="local_e_10"><span class="LIDENT">e</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-raise"><span class="LIDENT">raise</span></a> <span class="LPAREN">(</span><span class="UIDENT">Sys_error</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/printexc.ml.html#val-to_string"><span class="UIDENT">Printexc</span><span class="DOT">.</span><span class="LIDENT">to_string</span></a> <a href="#local_e_10"><span class="LIDENT">e</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="END">end</span></span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-file_or_symlink_exists"><span class="LIDENT">file_or_symlink_exists</span></span> <span id="local_f_11"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="TRY">try</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a> <span class="LPAREN">(</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">lstat</span> <a href="#local_f_11"><span class="LIDENT">f</span></a><span class="RPAREN">)</span><span class="SEMI">;</span> <span class="TRUE">true</span><span class="EOL">
</span>  <span class="WITH">with</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">Unix_error</span> <span class="LPAREN">(</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">ENOENT</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="FALSE">false</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-(/)"><span class="LPAREN">(</span><span class="INFIXOP3">/</span><span class="RPAREN">)</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#val-concat"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">concat</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-real_path"><span class="LIDENT">real_path</span></span> <span id="local_p_12"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="COMMENT">(* if Filename.is_relative p then *)</span><span class="EOL">
</span>    <span class="MATCH">match</span> <span class="LPAREN">(</span><span class="TRY">try</span> <span class="UIDENT">Some</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-is_directory"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">is_directory</span></a> <a href="#local_p_12"><span class="LIDENT">p</span></a><span class="RPAREN">)</span> <span class="WITH">with</span> <span class="UIDENT">Sys_error</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">None</span><span class="RPAREN">)</span> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span class="REC">rec</span> <span id="local_resolve_13"><span class="LIDENT">resolve</span></span> <span id="local_dir_14"><span class="LIDENT">dir</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>        <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-file_exists"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">file_exists</span></a> <a href="#local_dir_14"><span class="LIDENT">dir</span></a> <span class="THEN">then</span> <span class="UIDENT">OpamCompat</span><span class="DOT">.</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">realpath</span> <a href="#local_dir_14"><span class="LIDENT">dir</span></a> <span class="ELSE">else</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_parent_15"><span class="LIDENT">parent</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#module-Sysdeps"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">dirname</span></a> <a href="#local_dir_14"><span class="LIDENT">dir</span></a> <span class="IN">in</span><span class="EOL">
</span>        <span class="IF">if</span> <a href="#local_dir_14"><span class="LIDENT">dir</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <a href="#local_parent_15"><span class="LIDENT">parent</span></a> <span class="THEN">then</span> <a href="#local_dir_14"><span class="LIDENT">dir</span></a><span class="EOL">
</span>        <span class="ELSE">else</span> <a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#val-concat"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">concat</span></a> <span class="LPAREN">(</span><a href="#local_resolve_13"><span class="LIDENT">resolve</span></a> <a href="#local_parent_15"><span class="LIDENT">parent</span></a><span class="RPAREN">)</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#module-Sysdeps"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">basename</span></a> <a href="#local_dir_14"><span class="LIDENT">dir</span></a><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="IN">in</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_p_16"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>        <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#module-Sysdeps"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">is_relative</span></a> <a href="#local_p_12"><span class="LIDENT">p</span></a> <span class="THEN">then</span> <a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#val-concat"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">concat</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-getcwd"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">getcwd</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="RPAREN">)</span> <a href="#local_p_12"><span class="LIDENT">p</span></a><span class="EOL">
</span>        <span class="ELSE">else</span> <a href="#local_p_12"><span class="LIDENT">p</span></a><span class="EOL">
</span>      <span class="IN">in</span><span class="EOL">
</span>      <a href="#local_resolve_13"><span class="LIDENT">resolve</span></a> <a href="#local_p_16"><span class="LIDENT">p</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Some</span> <span class="TRUE">true</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">OpamCompat</span><span class="DOT">.</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">realpath</span> <a href="#local_p_12"><span class="LIDENT">p</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Some</span> <span class="FALSE">false</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_dir_17"><span class="LIDENT">dir</span></span> <span class="EQUAL">=</span> <span class="UIDENT">OpamCompat</span><span class="DOT">.</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">realpath</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#module-Sysdeps"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">dirname</span></a> <a href="#local_p_12"><span class="LIDENT">p</span></a><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>      <span class="MATCH">match</span> <a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#module-Sysdeps"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">basename</span></a> <a href="#local_p_12"><span class="LIDENT">p</span></a> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="STRING">&quot;.&quot;</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_dir_17"><span class="LIDENT">dir</span></a><span class="EOL">
</span>      <span class="BAR">|</span> <span id="local_base_18"><span class="LIDENT">base</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_dir_17"><span class="LIDENT">dir</span></a> <span class="INFIXOP3">/</span> <a href="#local_base_18"><span class="LIDENT">base</span></a><span class="EOL">
</span>  <span class="COMMENT">(* else p *)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-temp_basename"><span class="LIDENT">temp_basename</span></span> <span id="local_prefix_19"><span class="LIDENT">prefix</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="../../../ocaml-base-compiler/src/stdlib/printf.ml.html#val-sprintf"><span class="UIDENT">Printf</span><span class="DOT">.</span><span class="LIDENT">sprintf</span></a> <span class="STRING">&quot;%s-%d-%06x&quot;</span> <a href="#local_prefix_19"><span class="LIDENT">prefix</span></a> <span class="LPAREN">(</span><a href="opamStubs.ml.html#val-getpid"><span class="UIDENT">OpamStubs</span><span class="DOT">.</span><span class="LIDENT">getpid</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="RPAREN">)</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/random.ml.html#val-int"><span class="UIDENT">Random</span><span class="DOT">.</span><span class="LIDENT">int</span></a> <span class="INT">0xFFFFFF</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span class="REC">rec</span> <span id="val-mk_temp_dir"><span class="LIDENT">mk_temp_dir</span></span> <span class="QUESTION">?</span><span class="LPAREN">(</span><span id="local_prefix_20"><span class="LIDENT">prefix</span></span><span class="EQUAL">=</span><span class="STRING">&quot;opam&quot;</span><span class="RPAREN">)</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_s_21"><span class="LIDENT">s</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#val-get_temp_dir_name"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">get_temp_dir_name</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="INFIXOP3">/</span> <span class="LIDENT">temp_basename</span> <a href="#local_prefix_20"><span class="LIDENT">prefix</span></a> <span class="IN">in</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-file_exists"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">file_exists</span></a> <a href="#local_s_21"><span class="LIDENT">s</span></a> <span class="THEN">then</span><span class="EOL">
</span>    <span class="LIDENT">mk_temp_dir</span> <span class="TILDE">~</span><a href="#local_prefix_20"><span class="LIDENT">prefix</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="ELSE">else</span><span class="EOL">
</span>    <span class="LIDENT">real_path</span> <a href="#local_s_21"><span class="LIDENT">s</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span class="REC">rec</span> <span id="val-mk_unique_dir"><span class="LIDENT">mk_unique_dir</span></span> <span class="TILDE">~</span><span id="local_dir_22"><span class="LIDENT">dir</span></span> <span class="QUESTION">?</span><span class="LPAREN">(</span><span id="local_prefix_23"><span class="LIDENT">prefix</span></span><span class="EQUAL">=</span><span class="STRING">&quot;opam&quot;</span><span class="RPAREN">)</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_s_24"><span class="LIDENT">s</span></span> <span class="EQUAL">=</span> <a href="#local_dir_22"><span class="LIDENT">dir</span></a> <span class="INFIXOP3">/</span> <a href="../../../ocaml-base-compiler/src/stdlib/printf.ml.html#val-sprintf"><span class="UIDENT">Printf</span><span class="DOT">.</span><span class="LIDENT">sprintf</span></a> <span class="STRING">&quot;%s-%06x&quot;</span> <a href="#local_prefix_23"><span class="LIDENT">prefix</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/random.ml.html#val-int"><span class="UIDENT">Random</span><span class="DOT">.</span><span class="LIDENT">int</span></a> <span class="INT">0xFFFFFF</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-file_exists"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">file_exists</span></a> <a href="#local_s_24"><span class="LIDENT">s</span></a> <span class="THEN">then</span><span class="EOL">
</span>    <span class="LIDENT">mk_unique_dir</span> <span class="TILDE">~</span><a href="#local_dir_22"><span class="LIDENT">dir</span></a> <span class="TILDE">~</span><a href="#local_prefix_23"><span class="LIDENT">prefix</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="ELSE">else</span><span class="EOL">
</span>    <span class="LIDENT">real_path</span> <a href="#local_s_24"><span class="LIDENT">s</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-safe_mkdir"><span class="LIDENT">safe_mkdir</span></span> <span id="local_dir_25"><span class="LIDENT">dir</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="TRY">try</span><span class="EOL">
</span>    <span class="LIDENT">log</span> <span class="STRING">&quot;mkdir %s&quot;</span> <a href="#local_dir_25"><span class="LIDENT">dir</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">mkdir</span> <a href="#local_dir_25"><span class="LIDENT">dir</span></a> <span class="INT">0o755</span><span class="EOL">
</span>  <span class="WITH">with</span><span class="EOL">
</span>    <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">Unix_error</span><span class="LPAREN">(</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">EEXIST</span><span class="COMMA">,</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span><span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-mkdir"><span class="LIDENT">mkdir</span></span> <span id="local_dir_26"><span class="LIDENT">dir</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="REC">rec</span> <span id="local_aux_27"><span class="LIDENT">aux</span></span> <span id="local_dir_28"><span class="LIDENT">dir</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-not"><span class="LIDENT">not</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-file_exists"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">file_exists</span></a> <a href="#local_dir_28"><span class="LIDENT">dir</span></a><span class="RPAREN">)</span> <span class="THEN">then</span> <span class="BEGIN">begin</span><span class="EOL">
</span>      <a href="#local_aux_27"><span class="LIDENT">aux</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#module-Sysdeps"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">dirname</span></a> <a href="#local_dir_28"><span class="LIDENT">dir</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>      <span class="LIDENT">safe_mkdir</span> <a href="#local_dir_28"><span class="LIDENT">dir</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="END">end</span> <span class="IN">in</span><span class="EOL">
</span>  <a href="#local_aux_27"><span class="LIDENT">aux</span></a> <a href="#local_dir_26"><span class="LIDENT">dir</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-get_files"><span class="LIDENT">get_files</span></span> <span id="local_dirname_29"><span class="LIDENT">dirname</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_dir_30"><span class="LIDENT">dir</span></span> <span class="EQUAL">=</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">opendir</span> <a href="#local_dirname_29"><span class="LIDENT">dirname</span></a> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="REC">rec</span> <span id="local_aux_31"><span class="LIDENT">aux</span></span> <span id="local_files_32"><span class="LIDENT">files</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="MATCH">match</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">readdir</span> <a href="#local_dir_30"><span class="LIDENT">dir</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="STRING">&quot;.&quot;</span> <span class="BAR">|</span> <span class="STRING">&quot;..&quot;</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_aux_31"><span class="LIDENT">aux</span></a> <a href="#local_files_32"><span class="LIDENT">files</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span id="local_file_33"><span class="LIDENT">file</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_aux_31"><span class="LIDENT">aux</span></a> <span class="LPAREN">(</span><a href="#local_file_33"><span class="LIDENT">file</span></a> <span class="COLONCOLON">::</span> <a href="#local_files_32"><span class="LIDENT">files</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="EXCEPTION">exception</span> <span class="UIDENT">End_of_file</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_files_32"><span class="LIDENT">files</span></a><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_files_34"><span class="LIDENT">files</span></span> <span class="EQUAL">=</span> <a href="#local_aux_31"><span class="LIDENT">aux</span></a> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">closedir</span> <a href="#local_dir_30"><span class="LIDENT">dir</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <a href="#local_files_34"><span class="LIDENT">files</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-log_for_file_management"><span class="LIDENT">log_for_file_management</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="opamCoreConfig.ml.html"><span class="UIDENT">OpamCoreConfig</span></a><span class="DOT">.</span><span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="opamCoreConfig.ml.html#val-r"><span class="LIDENT">r</span></a><span class="DOT">.</span><span class="LIDENT">debug_level</span><span class="RPAREN">)</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;=)"><span class="INFIXOP0">&gt;=</span></a> <span class="INT">4</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* From stdune/src/fpath.ml *)</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-win32_unlink"><span class="LIDENT">win32_unlink</span></span> <span id="local_fn_35"><span class="LIDENT">fn</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="TRY">try</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">unlink</span> <a href="#local_fn_35"><span class="LIDENT">fn</span></a><span class="EOL">
</span>  <span class="WITH">with</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">Unix_error</span> <span class="LPAREN">(</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">EACCES</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="AS">as</span> <span id="local_e_36"><span class="LIDENT">e</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="EOL">
</span>    <span class="TRY">try</span><span class="EOL">
</span>      <span class="COMMENT">(* Try removing the read-only attribute *)</span><span class="EOL">
</span>      <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">chmod</span> <a href="#local_fn_35"><span class="LIDENT">fn</span></a> <span class="INT">0o666</span><span class="SEMI">;</span><span class="EOL">
</span>      <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">unlink</span> <a href="#local_fn_35"><span class="LIDENT">fn</span></a><span class="EOL">
</span>    <span class="WITH">with</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-raise"><span class="LIDENT">raise</span></a> <a href="#local_e_36"><span class="LIDENT">e</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-remove_file_t"><span class="LIDENT">remove_file_t</span></span> <span class="QUESTION">?</span><span class="LPAREN">(</span><span id="local_with_log_37"><span class="LIDENT">with_log</span></span><span class="EQUAL">=</span><span class="TRUE">true</span><span class="RPAREN">)</span> <span id="local_file_38"><span class="LIDENT">file</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="TRY">try</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_with_log_37"><span class="LIDENT">with_log</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <span class="LIDENT">log_for_file_management</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="THEN">then</span><span class="EOL">
</span>      <span class="LIDENT">log</span> <span class="STRING">&quot;rm %s&quot;</span> <a href="#local_file_38"><span class="LIDENT">file</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-win32"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">win32</span></a> <span class="THEN">then</span><span class="EOL">
</span>      <span class="LIDENT">win32_unlink</span> <a href="#local_file_38"><span class="LIDENT">file</span></a><span class="EOL">
</span>    <span class="ELSE">else</span><span class="EOL">
</span>      <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">unlink</span> <a href="#local_file_38"><span class="LIDENT">file</span></a><span class="EOL">
</span>  <span class="WITH">with</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">Unix_error</span> <span class="UNDERSCORE">_</span> <span class="AS">as</span> <span id="local_e_39"><span class="LIDENT">e</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LIDENT">internal_error</span> <span class="STRING">&quot;Cannot remove %s (%s).&quot;</span> <a href="#local_file_38"><span class="LIDENT">file</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/printexc.ml.html#val-to_string"><span class="UIDENT">Printexc</span><span class="DOT">.</span><span class="LIDENT">to_string</span></a> <a href="#local_e_39"><span class="LIDENT">e</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span class="REC">rec</span> <span id="val-remove_dir_t"><span class="LIDENT">remove_dir_t</span></span> <span id="local_dir_40"><span class="LIDENT">dir</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_files_41"><span class="LIDENT">files</span></span> <span class="EQUAL">=</span> <span class="LIDENT">get_files</span> <a href="#local_dir_40"><span class="LIDENT">dir</span></a> <span class="IN">in</span><span class="EOL">
</span>  <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-iter"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">iter</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_file_42"><span class="LIDENT">file</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_file_43"><span class="LIDENT">file</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#val-concat"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">concat</span></a> <a href="#local_dir_40"><span class="LIDENT">dir</span></a> <a href="#local_file_42"><span class="LIDENT">file</span></a> <span class="IN">in</span><span class="EOL">
</span>      <span class="MATCH">match</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">lstat</span> <a href="#local_file_43"><span class="LIDENT">file</span></a> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="LBRACE">{</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">st_kind</span> <span class="EQUAL">=</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">S_DIR</span><span class="SEMI">;</span> <span class="UNDERSCORE">_</span><span class="RBRACE">}</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LIDENT">remove_dir_t</span> <a href="#local_file_43"><span class="LIDENT">file</span></a><span class="EOL">
</span>      <span class="BAR">|</span> <span class="LBRACE">{</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">st_kind</span> <span class="EQUAL">=</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LPAREN">(</span><span class="UIDENT">S_REG</span> <span class="BAR">|</span> <span class="UIDENT">S_LNK</span> <span class="BAR">|</span> <span class="UIDENT">S_CHR</span> <span class="BAR">|</span> <span class="UIDENT">S_BLK</span> <span class="BAR">|</span> <span class="UIDENT">S_FIFO</span> <span class="BAR">|</span> <span class="UIDENT">S_SOCK</span><span class="RPAREN">)</span><span class="SEMI">;</span> <span class="UNDERSCORE">_</span><span class="RBRACE">}</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LIDENT">remove_file_t</span> <span class="LABEL">~with_log:</span><span class="FALSE">false</span> <a href="#local_file_43"><span class="LIDENT">file</span></a><span class="EOL">
</span>      <span class="BAR">|</span> <span class="EXCEPTION">exception</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LPAREN">(</span><span class="UIDENT">Unix_error</span> <span class="LPAREN">(</span><span class="UIDENT">ENOENT</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span><span class="RPAREN">)</span> <span class="WHEN">when</span> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-win32"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">win32</span></a> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="COMMENT">(* This is usually caused by invalid symlinks extracted by a
           Cygwin/MSYS2 tar. *)</span><span class="EOL">
</span>        <span class="LIDENT">remove_file_t</span> <span class="LABEL">~with_log:</span><span class="FALSE">false</span> <a href="#local_file_43"><span class="LIDENT">file</span></a><span class="EOL">
</span>    <span class="RPAREN">)</span> <a href="#local_files_41"><span class="LIDENT">files</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">rmdir</span> <a href="#local_dir_40"><span class="LIDENT">dir</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-remove_dir"><span class="LIDENT">remove_dir</span></span> <span id="local_dir_44"><span class="LIDENT">dir</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">log</span> <span class="STRING">&quot;rmdir %s&quot;</span> <a href="#local_dir_44"><span class="LIDENT">dir</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-file_exists"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">file_exists</span></a> <a href="#local_dir_44"><span class="LIDENT">dir</span></a> <span class="THEN">then</span> <span class="BEGIN">begin</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-is_directory"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">is_directory</span></a> <a href="#local_dir_44"><span class="LIDENT">dir</span></a> <span class="THEN">then</span><span class="EOL">
</span>      <span class="LIDENT">remove_dir_t</span> <a href="#local_dir_44"><span class="LIDENT">dir</span></a><span class="EOL">
</span>    <span class="ELSE">else</span><span class="EOL">
</span>      <span class="LIDENT">remove_file_t</span> <span class="LABEL">~with_log:</span><span class="TRUE">true</span> <a href="#local_dir_44"><span class="LIDENT">dir</span></a><span class="EOL">
</span>  <span class="END">end</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-temp_files"><span class="LIDENT">temp_files</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/hashtbl.ml.html#val-create"><span class="UIDENT">Hashtbl</span><span class="DOT">.</span><span class="LIDENT">create</span></a> <span class="INT">1024</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-logs_cleaner"><span class="LIDENT">logs_cleaner</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_to_clean_45"><span class="LIDENT">to_clean</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ref"><span class="LIDENT">ref</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/set.ml.html#module-Make.val-empty"><span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">String</span><span class="DOT">.</span><span class="UIDENT">Set</span><span class="DOT">.</span><span class="LIDENT">empty</span></a> <span class="IN">in</span><span class="EOL">
</span>  <a href="opamStd.ml.html#module-OpamSys.val-at_exit"><span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">at_exit</span></a><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>       <a href="../../../ocaml-base-compiler/src/stdlib/set.ml.html#module-Make.val-iter"><span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">String</span><span class="DOT">.</span><span class="UIDENT">Set</span><span class="DOT">.</span><span class="LIDENT">iter</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_f_46"><span class="LIDENT">f</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>           <span class="TRY">try</span><span class="EOL">
</span>             <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">unlink</span> <a href="#local_f_46"><span class="LIDENT">f</span></a><span class="SEMI">;</span><span class="EOL">
</span>             <span class="COMMENT">(* Only log the item if unlink succeeded *)</span><span class="EOL">
</span>             <span class="LIDENT">log</span> <span class="STRING">&quot;logs_cleaner: rm: %s&quot;</span> <a href="#local_f_46"><span class="LIDENT">f</span></a><span class="EOL">
</span>           <span class="WITH">with</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">Unix_error</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>         <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="#local_to_clean_45"><span class="LIDENT">to_clean</span></a><span class="SEMI">;</span><span class="EOL">
</span>       <span class="IF">if</span> <a href="opamCoreConfig.ml.html"><span class="UIDENT">OpamCoreConfig</span></a><span class="DOT">.</span><span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="opamCoreConfig.ml.html#val-r"><span class="LIDENT">r</span></a><span class="DOT">.</span><span class="LIDENT">log_dir</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <a href="opamCoreConfig.ml.html#val-default"><span class="LIDENT">default</span></a><span class="DOT">.</span><span class="LIDENT">log_dir</span><span class="RPAREN">)</span> <span class="THEN">then</span><span class="EOL">
</span>         <span class="TRY">try</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">rmdir</span> <a href="opamCoreConfig.ml.html"><span class="UIDENT">OpamCoreConfig</span></a><span class="DOT">.</span><span class="LPAREN">(</span><a href="opamCoreConfig.ml.html#val-default"><span class="LIDENT">default</span></a><span class="DOT">.</span><span class="LIDENT">log_dir</span><span class="RPAREN">)</span><span class="EOL">
</span>         <span class="WITH">with</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">Unix_error</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>  <span class="FUN">fun</span> <span id="local_tmp_dir_47"><span class="LIDENT">tmp_dir</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="opamCoreConfig.ml.html"><span class="UIDENT">OpamCoreConfig</span></a><span class="DOT">.</span><span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="opamCoreConfig.ml.html#val-r"><span class="LIDENT">r</span></a><span class="DOT">.</span><span class="LIDENT">keep_log_dir</span><span class="RPAREN">)</span> <span class="THEN">then</span><span class="EOL">
</span>      <a href="#local_to_clean_45"><span class="LIDENT">to_clean</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/set.ml.html#module-Make.val-remove"><span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">String</span><span class="DOT">.</span><span class="UIDENT">Set</span><span class="DOT">.</span><span class="LIDENT">remove</span></a> <a href="#local_tmp_dir_47"><span class="LIDENT">tmp_dir</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="#local_to_clean_45"><span class="LIDENT">to_clean</span></a><span class="EOL">
</span>    <span class="ELSE">else</span><span class="EOL">
</span>      <a href="#local_to_clean_45"><span class="LIDENT">to_clean</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/set.ml.html#module-Make.val-add"><span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">String</span><span class="DOT">.</span><span class="UIDENT">Set</span><span class="DOT">.</span><span class="LIDENT">add</span></a> <a href="#local_tmp_dir_47"><span class="LIDENT">tmp_dir</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="#local_to_clean_45"><span class="LIDENT">to_clean</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span class="REC">rec</span> <span id="val-temp_file"><span class="LIDENT">temp_file</span></span> <span class="QUESTION">?</span><span class="LPAREN">(</span><span id="local_auto_clean_48"><span class="LIDENT">auto_clean</span></span><span class="EQUAL">=</span><span class="TRUE">true</span><span class="RPAREN">)</span> <span class="QUESTION">?</span><span id="local_dir_49"><span class="LIDENT">dir</span></span> <span id="local_prefix_50"><span class="LIDENT">prefix</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_temp_dir_51"><span class="LIDENT">temp_dir</span></span> <span class="EQUAL">=</span> <span class="MATCH">match</span> <a href="#local_dir_49"><span class="LIDENT">dir</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">None</span>   <span class="MINUSGREATER">-&gt;</span> <a href="opamCoreConfig.ml.html"><span class="UIDENT">OpamCoreConfig</span></a><span class="DOT">.</span><span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="opamCoreConfig.ml.html#val-r"><span class="LIDENT">r</span></a><span class="DOT">.</span><span class="LIDENT">log_dir</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_d_52"><span class="LIDENT">d</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_d_52"><span class="LIDENT">d</span></a> <span class="IN">in</span><span class="EOL">
</span>  <span class="LIDENT">mkdir</span> <a href="#local_temp_dir_51"><span class="LIDENT">temp_dir</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_file_53"><span class="LIDENT">file</span></span> <span class="EQUAL">=</span> <a href="#local_temp_dir_51"><span class="LIDENT">temp_dir</span></a> <span class="INFIXOP3">/</span> <span class="LIDENT">temp_basename</span> <a href="#local_prefix_50"><span class="LIDENT">prefix</span></a> <span class="IN">in</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/hashtbl.ml.html#val-mem"><span class="UIDENT">Hashtbl</span><span class="DOT">.</span><span class="LIDENT">mem</span></a> <span class="LIDENT">temp_files</span> <a href="#local_file_53"><span class="LIDENT">file</span></a> <span class="THEN">then</span><span class="EOL">
</span>    <span class="LIDENT">temp_file</span> <span class="TILDE">~</span><a href="#local_auto_clean_48"><span class="LIDENT">auto_clean</span></a> <span class="QUESTION">?</span><a href="#local_dir_49"><span class="LIDENT">dir</span></a> <a href="#local_prefix_50"><span class="LIDENT">prefix</span></a><span class="EOL">
</span>  <span class="ELSE">else</span> <span class="LPAREN">(</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/hashtbl.ml.html#val-add"><span class="UIDENT">Hashtbl</span><span class="DOT">.</span><span class="LIDENT">add</span></a> <span class="LIDENT">temp_files</span> <a href="#local_file_53"><span class="LIDENT">file</span></a> <span class="TRUE">true</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_auto_clean_48"><span class="LIDENT">auto_clean</span></a> <span class="THEN">then</span> <span class="LIDENT">logs_cleaner</span> <a href="#local_file_53"><span class="LIDENT">file</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <a href="#local_file_53"><span class="LIDENT">file</span></a><span class="EOL">
</span>  <span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-remove_file"><span class="LIDENT">remove_file</span></span> <span id="local_file_54"><span class="LIDENT">file</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="IF">if</span><span class="EOL">
</span>    <span class="TRY">try</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a> <span class="LPAREN">(</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">lstat</span> <a href="#local_file_54"><span class="LIDENT">file</span></a><span class="RPAREN">)</span><span class="SEMI">;</span> <span class="TRUE">true</span> <span class="WITH">with</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">Unix_error</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="FALSE">false</span><span class="EOL">
</span>  <span class="THEN">then</span> <span class="LPAREN">(</span><span class="EOL">
</span>    <span class="LIDENT">log</span> <span class="STRING">&quot;rm %s&quot;</span> <a href="#local_file_54"><span class="LIDENT">file</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="TRY">try</span><span class="EOL">
</span>      <span class="TRY">try</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">unlink</span> <a href="#local_file_54"><span class="LIDENT">file</span></a><span class="EOL">
</span>      <span class="WITH">with</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">Unix_error</span><span class="LPAREN">(</span><span class="UIDENT">EACCES</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="WHEN">when</span> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-win32"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">win32</span></a> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="COMMENT">(* Attempt to remove the read-only bit on Windows *)</span><span class="EOL">
</span>        <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">chmod</span> <a href="#local_file_54"><span class="LIDENT">file</span></a> <span class="INT">0o666</span><span class="SEMI">;</span><span class="EOL">
</span>        <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">unlink</span> <a href="#local_file_54"><span class="LIDENT">file</span></a><span class="EOL">
</span>    <span class="WITH">with</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">Unix_error</span> <span class="UNDERSCORE">_</span> <span class="AS">as</span> <span id="local_e_55"><span class="LIDENT">e</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">internal_error</span> <span class="STRING">&quot;Cannot remove %s (%s).&quot;</span> <a href="#local_file_54"><span class="LIDENT">file</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/printexc.ml.html#val-to_string"><span class="UIDENT">Printexc</span><span class="DOT">.</span><span class="LIDENT">to_string</span></a> <a href="#local_e_55"><span class="LIDENT">e</span></a><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-string_of_channel"><span class="LIDENT">string_of_channel</span></span> <span id="local_ic_56"><span class="LIDENT">ic</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_n_57"><span class="LIDENT">n</span></span> <span class="EQUAL">=</span> <span class="INT">32768</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_s_58"><span class="LIDENT">s</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/bytes.ml.html#val-create"><span class="UIDENT">Bytes</span><span class="DOT">.</span><span class="LIDENT">create</span></a> <a href="#local_n_57"><span class="LIDENT">n</span></a> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_b_59"><span class="LIDENT">b</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/buffer.ml.html#val-create"><span class="UIDENT">Buffer</span><span class="DOT">.</span><span class="LIDENT">create</span></a> <span class="INT">1024</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="REC">rec</span> <span id="local_iter_60"><span class="LIDENT">iter</span></span> <span id="local_ic_61"><span class="LIDENT">ic</span></span> <span id="local_b_62"><span class="LIDENT">b</span></span> <span id="local_s_63"><span class="LIDENT">s</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_nread_64"><span class="LIDENT">nread</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="TRY">try</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-input"><span class="LIDENT">input</span></a> <a href="#local_ic_61"><span class="LIDENT">ic</span></a> <a href="#local_s_63"><span class="LIDENT">s</span></a> <span class="INT">0</span> <a href="#local_n_57"><span class="LIDENT">n</span></a><span class="EOL">
</span>      <span class="WITH">with</span> <span class="UIDENT">End_of_file</span> <span class="MINUSGREATER">-&gt;</span> <span class="INT">0</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_nread_64"><span class="LIDENT">nread</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <span class="INT">0</span> <span class="THEN">then</span> <span class="LPAREN">(</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/buffer.ml.html#val-add_subbytes"><span class="UIDENT">Buffer</span><span class="DOT">.</span><span class="LIDENT">add_subbytes</span></a> <a href="#local_b_62"><span class="LIDENT">b</span></a> <a href="#local_s_63"><span class="LIDENT">s</span></a> <span class="INT">0</span> <a href="#local_nread_64"><span class="LIDENT">nread</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <a href="#local_iter_60"><span class="LIDENT">iter</span></a> <a href="#local_ic_61"><span class="LIDENT">ic</span></a> <a href="#local_b_62"><span class="LIDENT">b</span></a> <a href="#local_s_63"><span class="LIDENT">s</span></a><span class="EOL">
</span>    <span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>  <a href="#local_iter_60"><span class="LIDENT">iter</span></a> <a href="#local_ic_56"><span class="LIDENT">ic</span></a> <a href="#local_b_59"><span class="LIDENT">b</span></a> <a href="#local_s_58"><span class="LIDENT">s</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <a href="../../../ocaml-base-compiler/src/stdlib/buffer.ml.html#val-contents"><span class="UIDENT">Buffer</span><span class="DOT">.</span><span class="LIDENT">contents</span></a> <a href="#local_b_59"><span class="LIDENT">b</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-read"><span class="LIDENT">read</span></span> <span id="local_file_65"><span class="LIDENT">file</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_ic_66"><span class="LIDENT">ic</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="TRY">try</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-open_in_bin"><span class="LIDENT">open_in_bin</span></a> <a href="#local_file_65"><span class="LIDENT">file</span></a><span class="EOL">
</span>    <span class="WITH">with</span> <span class="UIDENT">Sys_error</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-raise"><span class="LIDENT">raise</span></a> <span class="LPAREN">(</span><span class="UIDENT">File_not_found</span> <a href="#local_file_65"><span class="LIDENT">file</span></a><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">lockf</span> <span class="LPAREN">(</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">descr_of_in_channel</span> <a href="#local_ic_66"><span class="LIDENT">ic</span></a><span class="RPAREN">)</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">F_RLOCK</span> <span class="INT">0</span><span class="SEMI">;</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_s_67"><span class="LIDENT">s</span></span> <span class="EQUAL">=</span> <span class="LIDENT">string_of_channel</span> <a href="#local_ic_66"><span class="LIDENT">ic</span></a> <span class="IN">in</span><span class="EOL">
</span>  <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-close_in"><span class="LIDENT">close_in</span></a> <a href="#local_ic_66"><span class="LIDENT">ic</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <a href="#local_s_67"><span class="LIDENT">s</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-write"><span class="LIDENT">write</span></span> <span id="local_file_68"><span class="LIDENT">file</span></span> <span id="local_contents_69"><span class="LIDENT">contents</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">mkdir</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#module-Sysdeps"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">dirname</span></a> <a href="#local_file_68"><span class="LIDENT">file</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_oc_70"><span class="LIDENT">oc</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="TRY">try</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-open_out_bin"><span class="LIDENT">open_out_bin</span></a> <a href="#local_file_68"><span class="LIDENT">file</span></a><span class="EOL">
</span>    <span class="WITH">with</span> <span class="UIDENT">Sys_error</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-raise"><span class="LIDENT">raise</span></a> <span class="LPAREN">(</span><span class="UIDENT">File_not_found</span> <a href="#local_file_68"><span class="LIDENT">file</span></a><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">lockf</span> <span class="LPAREN">(</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">descr_of_out_channel</span> <a href="#local_oc_70"><span class="LIDENT">oc</span></a><span class="RPAREN">)</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">F_LOCK</span> <span class="INT">0</span><span class="SEMI">;</span><span class="EOL">
</span>  <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-output_string"><span class="LIDENT">output_string</span></a> <a href="#local_oc_70"><span class="LIDENT">oc</span></a> <a href="#local_contents_69"><span class="LIDENT">contents</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-close_out"><span class="LIDENT">close_out</span></a> <a href="#local_oc_70"><span class="LIDENT">oc</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-setup_copy"><span class="LIDENT">setup_copy</span></span> <span class="QUESTION">?</span><span class="LPAREN">(</span><span id="local_chmod_71"><span class="LIDENT">chmod</span></span> <span class="EQUAL">=</span> <span class="FUN">fun</span> <span id="local_x_72"><span class="LIDENT">x</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_x_72"><span class="LIDENT">x</span></a><span class="RPAREN">)</span> <span class="TILDE">~</span><span id="local_src_73"><span class="LIDENT">src</span></span> <span class="TILDE">~</span><span id="local_dst_74"><span class="LIDENT">dst</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_ic_75"><span class="LIDENT">ic</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-open_in_bin"><span class="LIDENT">open_in_bin</span></a> <a href="#local_src_73"><span class="LIDENT">src</span></a> <span class="IN">in</span><span class="EOL">
</span>  <span class="TRY">try</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_perm_76"><span class="LIDENT">perm</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">fstat</span> <span class="LPAREN">(</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">descr_of_in_channel</span> <a href="#local_ic_75"><span class="LIDENT">ic</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="DOT">.</span><span class="LIDENT">st_perm</span> <span class="INFIXOP0">|&gt;</span> <a href="#local_chmod_71"><span class="LIDENT">chmod</span></a><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="TRY">try</span> <span class="IF">if</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LPAREN">(</span><span class="LPAREN">(</span><span class="LIDENT">lstat</span> <a href="#local_dst_74"><span class="LIDENT">dst</span></a><span class="RPAREN">)</span><span class="DOT">.</span><span class="LIDENT">st_kind</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;&gt;)"><span class="INFIXOP0">&lt;&gt;</span></a> <span class="UIDENT">S_REG</span><span class="RPAREN">)</span> <span class="THEN">then</span><span class="EOL">
</span>            <span class="LIDENT">remove_file</span> <a href="#local_dst_74"><span class="LIDENT">dst</span></a><span class="EOL">
</span>      <span class="WITH">with</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">Unix_error</span><span class="LPAREN">(</span><span class="UIDENT">ENOENT</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_fd_77"><span class="LIDENT">fd</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_flags_78"><span class="LIDENT">flags</span></span> <span class="EQUAL">=</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LBRACKET">[</span> <span class="UIDENT">O_WRONLY</span><span class="SEMI">;</span> <span class="UIDENT">O_CREAT</span><span class="SEMI">;</span> <span class="UIDENT">O_TRUNC</span> <span class="RBRACKET">]</span> <span class="IN">in</span><span class="EOL">
</span>      <span class="TRY">try</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">openfile</span> <a href="#local_dst_74"><span class="LIDENT">dst</span></a> <a href="#local_flags_78"><span class="LIDENT">flags</span></a> <a href="#local_perm_76"><span class="LIDENT">perm</span></a><span class="EOL">
</span>      <span class="WITH">with</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">Unix_error</span><span class="LPAREN">(</span><span class="UIDENT">EACCES</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="WHEN">when</span> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-win32"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">win32</span></a> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="COMMENT">(* Attempt to remove the read-only bit on Windows *)</span><span class="EOL">
</span>        <span class="BEGIN">begin</span><span class="EOL">
</span>          <span class="TRY">try</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">chmod</span> <a href="#local_dst_74"><span class="LIDENT">dst</span></a> <span class="INT">0o666</span><span class="EOL">
</span>          <span class="WITH">with</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">Unix_error</span><span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="END">end</span><span class="SEMI">;</span><span class="EOL">
</span>        <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">openfile</span> <a href="#local_dst_74"><span class="LIDENT">dst</span></a> <a href="#local_flags_78"><span class="LIDENT">flags</span></a> <a href="#local_perm_76"><span class="LIDENT">perm</span></a><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span>    <span class="TRY">try</span><span class="EOL">
</span>      <span class="IF">if</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LPAREN">(</span><span class="LPAREN">(</span><span class="LIDENT">fstat</span> <a href="#local_fd_77"><span class="LIDENT">fd</span></a><span class="RPAREN">)</span><span class="DOT">.</span><span class="LIDENT">st_perm</span><span class="RPAREN">)</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;&gt;)"><span class="INFIXOP0">&lt;&gt;</span></a> <a href="#local_perm_76"><span class="LIDENT">perm</span></a> <span class="THEN">then</span><span class="EOL">
</span>        <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">fchmod</span> <a href="#local_fd_77"><span class="LIDENT">fd</span></a> <a href="#local_perm_76"><span class="LIDENT">perm</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <span class="LPAREN">(</span><a href="#local_ic_75"><span class="LIDENT">ic</span></a><span class="COMMA">,</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">out_channel_of_descr</span> <a href="#local_fd_77"><span class="LIDENT">fd</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="WITH">with</span> <span id="local_exn_79"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="opamStd.ml.html#module-Exn.val-finalise"><span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">Exn</span><span class="DOT">.</span><span class="LIDENT">finalise</span></a> <a href="#local_exn_79"><span class="LIDENT">exn</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">close</span> <a href="#local_fd_77"><span class="LIDENT">fd</span></a><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="WITH">with</span> <span id="local_exn_80"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="opamStd.ml.html#module-Exn.val-finalise"><span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">Exn</span><span class="DOT">.</span><span class="LIDENT">finalise</span></a> <a href="#local_exn_80"><span class="LIDENT">exn</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-close_in"><span class="LIDENT">close_in</span></a> <a href="#local_ic_75"><span class="LIDENT">ic</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-copy_channels"><span class="LIDENT">copy_channels</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_buf_len_81"><span class="LIDENT">buf_len</span></span> <span class="EQUAL">=</span> <span class="INT">4096</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_buf_82"><span class="LIDENT">buf</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/bytes.ml.html#val-create"><span class="UIDENT">Bytes</span><span class="DOT">.</span><span class="LIDENT">create</span></a> <a href="#local_buf_len_81"><span class="LIDENT">buf_len</span></a> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="REC">rec</span> <span id="local_loop_83"><span class="LIDENT">loop</span></span> <span id="local_ic_84"><span class="LIDENT">ic</span></span> <span id="local_oc_85"><span class="LIDENT">oc</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-input"><span class="LIDENT">input</span></a> <a href="#local_ic_84"><span class="LIDENT">ic</span></a> <a href="#local_buf_82"><span class="LIDENT">buf</span></a> <span class="INT">0</span> <a href="#local_buf_len_81"><span class="LIDENT">buf_len</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="INT">0</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="BAR">|</span> <span id="local_n_86"><span class="LIDENT">n</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-output"><span class="LIDENT">output</span></a> <a href="#local_oc_85"><span class="LIDENT">oc</span></a> <a href="#local_buf_82"><span class="LIDENT">buf</span></a> <span class="INT">0</span> <a href="#local_n_86"><span class="LIDENT">n</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <a href="#local_loop_83"><span class="LIDENT">loop</span></a> <a href="#local_ic_84"><span class="LIDENT">ic</span></a> <a href="#local_oc_85"><span class="LIDENT">oc</span></a><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <a href="#local_loop_83"><span class="LIDENT">loop</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-copy_file_aux"><span class="LIDENT">copy_file_aux</span></span> <span class="QUESTION">?</span><span id="local_chmod_87"><span class="LIDENT">chmod</span></span> <span class="TILDE">~</span><span id="local_src_88"><span class="LIDENT">src</span></span> <span class="TILDE">~</span><span id="local_dst_89"><span class="LIDENT">dst</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_close_channels_90"><span class="LIDENT">close_channels</span></span> <span id="local_ic_91"><span class="LIDENT">ic</span></span> <span id="local_oc_92"><span class="LIDENT">oc</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <a href="opamStd.ml.html#module-Exn.val-finally"><span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">Exn</span><span class="DOT">.</span><span class="LIDENT">finally</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-close_in"><span class="LIDENT">close_in</span></a> <a href="#local_ic_91"><span class="LIDENT">ic</span></a><span class="RPAREN">)</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-close_out"><span class="LIDENT">close_out</span></a> <a href="#local_oc_92"><span class="LIDENT">oc</span></a><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="TRY">try</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="def_537"><span id="local_ic_93"><span class="LIDENT">ic</span></span><span class="COMMA">,</span> <span id="local_oc_94"><span class="LIDENT">oc</span></span></span> <span class="EQUAL">=</span> <span class="LIDENT">setup_copy</span> <span class="QUESTION">?</span><a href="#local_chmod_87"><span class="LIDENT">chmod</span></a> <span class="TILDE">~</span><a href="#local_src_88"><span class="LIDENT">src</span></a> <span class="TILDE">~</span><a href="#local_dst_89"><span class="LIDENT">dst</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>    <a href="opamStd.ml.html#module-Exn.val-finally"><span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">Exn</span><span class="DOT">.</span><span class="LIDENT">finally</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_close_channels_90"><span class="LIDENT">close_channels</span></a> <a href="#local_ic_93"><span class="LIDENT">ic</span></a> <a href="#local_oc_94"><span class="LIDENT">oc</span></a><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">copy_channels</span> <a href="#local_ic_93"><span class="LIDENT">ic</span></a> <a href="#local_oc_94"><span class="LIDENT">oc</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>  <span class="WITH">with</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">Unix_error</span> <span class="UNDERSCORE">_</span> <span class="AS">as</span> <span id="local_e_95"><span class="LIDENT">e</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="COMMENT">(* Remove the partial destination file, if any. *)</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="TRY">try</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">unlink</span> <a href="#local_dst_89"><span class="LIDENT">dst</span></a> <span class="WITH">with</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">Unix_error</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">internal_error</span> <span class="STRING">&quot;Cannot copy %s to %s (%s).&quot;</span> <a href="#local_src_88"><span class="LIDENT">src</span></a> <a href="#local_dst_89"><span class="LIDENT">dst</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/printexc.ml.html#val-to_string"><span class="UIDENT">Printexc</span><span class="DOT">.</span><span class="LIDENT">to_string</span></a> <a href="#local_e_95"><span class="LIDENT">e</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-chdir"><span class="LIDENT">chdir</span></span> <span id="local_dir_96"><span class="LIDENT">dir</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="TRY">try</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">chdir</span> <a href="#local_dir_96"><span class="LIDENT">dir</span></a><span class="EOL">
</span>  <span class="WITH">with</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">Unix_error</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-raise"><span class="LIDENT">raise</span></a> <span class="LPAREN">(</span><span class="UIDENT">File_not_found</span> <a href="#local_dir_96"><span class="LIDENT">dir</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-in_dir"><span class="LIDENT">in_dir</span></span> <span id="local_dir_97"><span class="LIDENT">dir</span></span> <span id="local_fn_98"><span class="LIDENT">fn</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_reset_cwd_99"><span class="LIDENT">reset_cwd</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_cwd_100"><span class="LIDENT">cwd</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="TRY">try</span> <span class="UIDENT">Some</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-getcwd"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">getcwd</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="WITH">with</span> <span class="UIDENT">Sys_error</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">None</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="MATCH">match</span> <a href="#local_cwd_100"><span class="LIDENT">cwd</span></a> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">None</span>     <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_cwd_101"><span class="LIDENT">cwd</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="TRY">try</span> <span class="LIDENT">chdir</span> <a href="#local_cwd_101"><span class="LIDENT">cwd</span></a> <span class="WITH">with</span> <span class="UIDENT">File_not_found</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LIDENT">chdir</span> <a href="#local_dir_97"><span class="LIDENT">dir</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="TRY">try</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_r_102"><span class="LIDENT">r</span></span> <span class="EQUAL">=</span> <a href="#local_fn_98"><span class="LIDENT">fn</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>    <a href="#local_reset_cwd_99"><span class="LIDENT">reset_cwd</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="#local_r_102"><span class="LIDENT">r</span></a><span class="EOL">
</span>  <span class="WITH">with</span> <span id="local_e_103"><span class="LIDENT">e</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="opamStd.ml.html#module-Exn.val-finalise"><span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">Exn</span><span class="DOT">.</span><span class="LIDENT">finalise</span></a> <a href="#local_e_103"><span class="LIDENT">e</span></a> <a href="#local_reset_cwd_99"><span class="LIDENT">reset_cwd</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-list"><span class="LIDENT">list</span></span> <span id="local_kind_104"><span class="LIDENT">kind</span></span> <span id="local_dir_105"><span class="LIDENT">dir</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="TRY">try</span><span class="EOL">
</span>    <span class="LIDENT">in_dir</span> <a href="#local_dir_105"><span class="LIDENT">dir</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_d_106"><span class="LIDENT">d</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-readdir"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">readdir</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-getcwd"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">getcwd</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_d_107"><span class="LIDENT">d</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/array.ml.html#val-to_list"><span class="UIDENT">Array</span><span class="DOT">.</span><span class="LIDENT">to_list</span></a> <a href="#local_d_106"><span class="LIDENT">d</span></a> <span class="IN">in</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_l_108"><span class="LIDENT">l</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-filter"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">filter</span></a> <a href="#local_kind_104"><span class="LIDENT">kind</span></a> <a href="#local_d_107"><span class="LIDENT">d</span></a> <span class="IN">in</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-map"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">map</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#val-concat"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">concat</span></a> <a href="#local_dir_105"><span class="LIDENT">dir</span></a><span class="RPAREN">)</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-sort"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">sort</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-compare"><span class="LIDENT">compare</span></a> <a href="#local_l_108"><span class="LIDENT">l</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="RPAREN">)</span><span class="EOL">
</span>  <span class="WITH">with</span> <span class="UIDENT">File_not_found</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-ls"><span class="LIDENT">ls</span></span> <span id="local_dir_109"><span class="LIDENT">dir</span></span> <span class="EQUAL">=</span> <span class="LIDENT">list</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="TRUE">true</span><span class="RPAREN">)</span> <a href="#local_dir_109"><span class="LIDENT">dir</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-files_with_links"><span class="LIDENT">files_with_links</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">list</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_f_110"><span class="LIDENT">f</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="TRY">try</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-not"><span class="LIDENT">not</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-is_directory"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">is_directory</span></a> <a href="#local_f_110"><span class="LIDENT">f</span></a><span class="RPAREN">)</span> <span class="WITH">with</span> <span class="UIDENT">Sys_error</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="FALSE">false</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-files_all_not_dir"><span class="LIDENT">files_all_not_dir</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">list</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_f_111"><span class="LIDENT">f</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="TRY">try</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-not"><span class="LIDENT">not</span></a> <span class="LPAREN">(</span><span class="UIDENT">Sys2</span><span class="DOT">.</span><span class="LIDENT">is_directory</span> <a href="#local_f_111"><span class="LIDENT">f</span></a><span class="RPAREN">)</span> <span class="WITH">with</span> <span class="UIDENT">Sys_error</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="FALSE">false</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-directories_strict"><span class="LIDENT">directories_strict</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">list</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_f_112"><span class="LIDENT">f</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="TRY">try</span> <span class="UIDENT">Sys2</span><span class="DOT">.</span><span class="LIDENT">is_directory</span> <a href="#local_f_112"><span class="LIDENT">f</span></a> <span class="WITH">with</span> <span class="UIDENT">Sys_error</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="FALSE">false</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-directories_with_links"><span class="LIDENT">directories_with_links</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">list</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_f_113"><span class="LIDENT">f</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="TRY">try</span> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-is_directory"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">is_directory</span></a> <a href="#local_f_113"><span class="LIDENT">f</span></a> <span class="WITH">with</span> <span class="UIDENT">Sys_error</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="FALSE">false</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-rec_files"><span class="LIDENT">rec_files</span></span> <span id="local_dir_114"><span class="LIDENT">dir</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="REC">rec</span> <span id="local_aux_115"><span class="LIDENT">aux</span></span> <span id="local_accu_116"><span class="LIDENT">accu</span></span> <span id="local_dir_117"><span class="LIDENT">dir</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_d_118"><span class="LIDENT">d</span></span> <span class="EQUAL">=</span> <span class="LIDENT">directories_with_links</span> <a href="#local_dir_117"><span class="LIDENT">dir</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_f_119"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span> <span class="LIDENT">files_with_links</span> <a href="#local_dir_117"><span class="LIDENT">dir</span></a> <span class="IN">in</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-fold_left"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">fold_left</span></a> <a href="#local_aux_115"><span class="LIDENT">aux</span></a> <span class="LPAREN">(</span><a href="#local_f_119"><span class="LIDENT">f</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(@)"><span class="INFIXOP1">@</span></a> <a href="#local_accu_116"><span class="LIDENT">accu</span></a><span class="RPAREN">)</span> <a href="#local_d_118"><span class="LIDENT">d</span></a> <span class="IN">in</span><span class="EOL">
</span>  <a href="#local_aux_115"><span class="LIDENT">aux</span></a> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <a href="#local_dir_114"><span class="LIDENT">dir</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-files"><span class="LIDENT">files</span></span> <span id="local_dir_120"><span class="LIDENT">dir</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">files_with_links</span> <a href="#local_dir_120"><span class="LIDENT">dir</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-rec_dirs"><span class="LIDENT">rec_dirs</span></span> <span id="local_dir_121"><span class="LIDENT">dir</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="REC">rec</span> <span id="local_aux_122"><span class="LIDENT">aux</span></span> <span id="local_accu_123"><span class="LIDENT">accu</span></span> <span id="local_dir_124"><span class="LIDENT">dir</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_d_125"><span class="LIDENT">d</span></span> <span class="EQUAL">=</span> <span class="LIDENT">directories_with_links</span> <a href="#local_dir_124"><span class="LIDENT">dir</span></a> <span class="IN">in</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-fold_left"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">fold_left</span></a> <a href="#local_aux_122"><span class="LIDENT">aux</span></a> <span class="LPAREN">(</span><a href="#local_d_125"><span class="LIDENT">d</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(@)"><span class="INFIXOP1">@</span></a> <a href="#local_accu_123"><span class="LIDENT">accu</span></a><span class="RPAREN">)</span> <a href="#local_d_125"><span class="LIDENT">d</span></a> <span class="IN">in</span><span class="EOL">
</span>  <a href="#local_aux_122"><span class="LIDENT">aux</span></a> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <a href="#local_dir_121"><span class="LIDENT">dir</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-dirs"><span class="LIDENT">dirs</span></span> <span id="local_dir_126"><span class="LIDENT">dir</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">directories_with_links</span> <a href="#local_dir_126"><span class="LIDENT">dir</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-dir_is_empty"><span class="LIDENT">dir_is_empty</span></span> <span id="local_dir_127"><span class="LIDENT">dir</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="TRY">try</span> <span class="LIDENT">in_dir</span> <a href="#local_dir_127"><span class="LIDENT">dir</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-readdir"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">readdir</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-getcwd"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">getcwd</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="RPAREN">)</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="LBRACKETBAR">[|</span><span class="BARRBRACKET">|]</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="WITH">with</span> <span class="UIDENT">File_not_found</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="FALSE">false</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-with_tmp_dir"><span class="LIDENT">with_tmp_dir</span></span> <span id="local_fn_128"><span class="LIDENT">fn</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_dir_129"><span class="LIDENT">dir</span></span> <span class="EQUAL">=</span> <span class="LIDENT">mk_temp_dir</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="TRY">try</span><span class="EOL">
</span>    <span class="LIDENT">mkdir</span> <a href="#local_dir_129"><span class="LIDENT">dir</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_e_130"><span class="LIDENT">e</span></span> <span class="EQUAL">=</span> <a href="#local_fn_128"><span class="LIDENT">fn</span></a> <a href="#local_dir_129"><span class="LIDENT">dir</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LIDENT">remove_dir</span> <a href="#local_dir_129"><span class="LIDENT">dir</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <a href="#local_e_130"><span class="LIDENT">e</span></a><span class="EOL">
</span>  <span class="WITH">with</span> <span id="local_e_131"><span class="LIDENT">e</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="opamStd.ml.html#module-Exn.val-finalise"><span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">Exn</span><span class="DOT">.</span><span class="LIDENT">finalise</span></a> <a href="#local_e_131"><span class="LIDENT">e</span></a> <span class="INFIXOP1">@@</span> <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LIDENT">remove_dir</span> <a href="#local_dir_129"><span class="LIDENT">dir</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-in_tmp_dir"><span class="LIDENT">in_tmp_dir</span></span> <span id="local_fn_132"><span class="LIDENT">fn</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">with_tmp_dir</span> <span class="INFIXOP1">@@</span> <span class="FUN">fun</span> <span id="local_dir_133"><span class="LIDENT">dir</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LIDENT">in_dir</span> <a href="#local_dir_133"><span class="LIDENT">dir</span></a> <a href="#local_fn_132"><span class="LIDENT">fn</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-with_tmp_dir_job"><span class="LIDENT">with_tmp_dir_job</span></span> <span id="local_fjob_134"><span class="LIDENT">fjob</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_dir_135"><span class="LIDENT">dir</span></span> <span class="EQUAL">=</span> <span class="LIDENT">mk_temp_dir</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LIDENT">mkdir</span> <a href="#local_dir_135"><span class="LIDENT">dir</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <a href="opamProcess.ml.html#module-Job.val-finally"><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="UIDENT">Job</span><span class="DOT">.</span><span class="LIDENT">finally</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">remove_dir</span> <a href="#local_dir_135"><span class="LIDENT">dir</span></a><span class="RPAREN">)</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_fjob_134"><span class="LIDENT">fjob</span></a> <a href="#local_dir_135"><span class="LIDENT">dir</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-remove"><span class="LIDENT">remove</span></span> <span id="local_file_136"><span class="LIDENT">file</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="IF">if</span> <span class="LPAREN">(</span><span class="TRY">try</span> <span class="UIDENT">Sys2</span><span class="DOT">.</span><span class="LIDENT">is_directory</span> <a href="#local_file_136"><span class="LIDENT">file</span></a> <span class="WITH">with</span> <span class="UIDENT">Sys_error</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="FALSE">false</span><span class="RPAREN">)</span> <span class="THEN">then</span><span class="EOL">
</span>    <span class="LIDENT">remove_dir</span> <a href="#local_file_136"><span class="LIDENT">file</span></a><span class="EOL">
</span>  <span class="ELSE">else</span><span class="EOL">
</span>    <span class="LIDENT">remove_file</span> <a href="#local_file_136"><span class="LIDENT">file</span></a><span class="EOL">
</span><span class="EOL">
</span><span id="type-command"><span class="TYPE">type</span> <span class="LIDENT">command</span> <span class="EQUAL">=</span> <span class="LIDENT">string</span> <span class="LIDENT">list</span></span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-forward_to_back"><span class="LIDENT">forward_to_back</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-win32"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">win32</span></a> <span class="THEN">then</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/string.ml.html#val-map"><span class="UIDENT">String</span><span class="DOT">.</span><span class="LIDENT">map</span></a> <span class="LPAREN">(</span><span class="FUNCTION">function</span> <span class="CHAR">'/'</span> <span class="MINUSGREATER">-&gt;</span> <span class="CHAR">'\\'</span> <span class="BAR">|</span> <span id="local_c_137"><span class="LIDENT">c</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_c_137"><span class="LIDENT">c</span></a><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="ELSE">else</span><span class="EOL">
</span>    <span class="FUN">fun</span> <span id="local_x_138"><span class="LIDENT">x</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_x_138"><span class="LIDENT">x</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-back_to_forward"><span class="LIDENT">back_to_forward</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-win32"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">win32</span></a> <span class="THEN">then</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/string.ml.html#val-map"><span class="UIDENT">String</span><span class="DOT">.</span><span class="LIDENT">map</span></a> <span class="LPAREN">(</span><span class="FUNCTION">function</span> <span class="CHAR">'\\'</span> <span class="MINUSGREATER">-&gt;</span> <span class="CHAR">'/'</span> <span class="BAR">|</span> <span id="local_c_139"><span class="LIDENT">c</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_c_139"><span class="LIDENT">c</span></a><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="ELSE">else</span><span class="EOL">
</span>    <span class="FUN">fun</span> <span id="local_x_140"><span class="LIDENT">x</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_x_140"><span class="LIDENT">x</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-resolve_command"><span class="LIDENT">resolve_command</span></span> <span class="EQUAL">=</span> <a href="opamProcess.ml.html#val-resolve_command"><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="LIDENT">resolve_command</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-bin_contains_bash"><span class="LIDENT">bin_contains_bash</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-not"><span class="LIDENT">not</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-win32"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">win32</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&amp;&amp;)"><span class="AMPERAMPER">&amp;&amp;</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-not"><span class="LIDENT">not</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-cygwin"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">cygwin</span></a> <span class="THEN">then</span> <span class="FUN">fun</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="FALSE">false</span> <span class="ELSE">else</span><span class="EOL">
</span>  <span class="FUN">fun</span> <span id="local_bin_141"><span class="LIDENT">bin</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="LIDENT">resolve_command</span> <span class="LABEL">~env:</span><span class="LBRACKETBAR">[|</span><span class="BARRBRACKET">|]</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#val-concat"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">concat</span></a> <a href="#local_bin_141"><span class="LIDENT">bin</span></a> <span class="STRING">&quot;bash.exe&quot;</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;&gt;)"><span class="INFIXOP0">&lt;&gt;</span></a> <span class="UIDENT">None</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-apply_cygpath"><span class="LIDENT">apply_cygpath</span></span> <span id="local_name_142"><span class="LIDENT">name</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="COMMENT">(* XXX Deeper bug, looking in the cygvoke code (see OpamProcess.create) *)</span><span class="EOL">
</span>  <span class="MATCH">match</span> <span class="LIDENT">resolve_command</span> <span class="STRING">&quot;cygpath&quot;</span> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_cygpath_143"><span class="LIDENT">cygpath</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_r_144"><span class="LIDENT">r</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <a href="opamProcess.ml.html#val-run"><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="LIDENT">run</span></a><span class="EOL">
</span>        <span class="LPAREN">(</span><a href="opamProcess.ml.html#val-command"><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="LIDENT">command</span></a> <span class="LABEL">~name:</span><span class="LPAREN">(</span><span class="LIDENT">temp_file</span> <span class="STRING">&quot;command&quot;</span><span class="RPAREN">)</span><span class="EOL">
</span>           <span class="LABEL">~allow_stdin:</span><span class="FALSE">false</span> <span class="LABEL">~verbose:</span><span class="FALSE">false</span> <a href="#local_cygpath_143"><span class="LIDENT">cygpath</span></a> <span class="LBRACKET">[</span><span class="STRING">&quot;--&quot;</span><span class="SEMI">;</span> <a href="#local_name_142"><span class="LIDENT">name</span></a><span class="RBRACKET">]</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span>    <a href="opamProcess.ml.html#val-cleanup"><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="LIDENT">cleanup</span></a> <span class="LABEL">~force:</span><span class="TRUE">true</span> <a href="#local_r_144"><span class="LIDENT">r</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="opamProcess.ml.html#val-is_success"><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="LIDENT">is_success</span></a> <a href="#local_r_144"><span class="LIDENT">r</span></a> <span class="THEN">then</span><span class="EOL">
</span>      <span class="MATCH">match</span> <a href="#local_r_144"><span class="LIDENT">r</span></a><span class="DOT">.</span><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="LIDENT">r_stdout</span> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span id="local_l_145"><span class="LIDENT">l</span></span><span class="COLONCOLON">::</span><span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_l_145"><span class="LIDENT">l</span></a><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="STRING">&quot;&quot;</span><span class="EOL">
</span>    <span class="ELSE">else</span><span class="EOL">
</span>      <a href="opamConsole.ml.html#val-error_and_exit"><span class="UIDENT">OpamConsole</span><span class="DOT">.</span><span class="LIDENT">error_and_exit</span></a> <span class="BACKQUOTE">`</span><span class="UIDENT">Internal_error</span> <span class="STRING">&quot;Could not apply cygpath to %s&quot;</span> <a href="#local_name_142"><span class="LIDENT">name</span></a><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="opamConsole.ml.html#val-error_and_exit"><span class="UIDENT">OpamConsole</span><span class="DOT">.</span><span class="LIDENT">error_and_exit</span></a> <span class="BACKQUOTE">`</span><span class="UIDENT">Internal_error</span> <span class="STRING">&quot;Could not apply cygpath to %s&quot;</span> <a href="#local_name_142"><span class="LIDENT">name</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-get_cygpath_function"><span class="LIDENT">get_cygpath_function</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-win32"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">win32</span></a> <span class="THEN">then</span><span class="EOL">
</span>    <span class="FUN">fun</span> <span class="TILDE">~</span><span id="local_command_146"><span class="LIDENT">command</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LAZY">lazy</span> <span class="LPAREN">(</span><span class="EOL">
</span>        <span class="IF">if</span> <a href="opamStd.ml.html#module-Option.val-map_default"><span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">Option</span><span class="DOT">.</span><span class="LIDENT">map_default</span></a><span class="EOL">
</span>            <span class="LPAREN">(</span><a href="opamStd.ml.html#module-OpamSys.val-is_cygwin_variant"><span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">is_cygwin_variant</span></a><span class="EOL">
</span>               <span class="OPTLABEL">?search_in_first:</span><span class="LPAREN">(</span><a href="opamCoreConfig.ml.html"><span class="UIDENT">OpamCoreConfig</span></a><span class="DOT">.</span><span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="opamCoreConfig.ml.html#val-r"><span class="LIDENT">r</span></a><span class="DOT">.</span><span class="LIDENT">cygbin</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>               <span class="FALSE">false</span><span class="EOL">
</span>               <span class="LPAREN">(</span><span class="LIDENT">resolve_command</span> <a href="#local_command_146"><span class="LIDENT">command</span></a><span class="RPAREN">)</span> <span class="THEN">then</span><span class="EOL">
</span>          <span class="LIDENT">apply_cygpath</span><span class="EOL">
</span>        <span class="ELSE">else</span> <span class="FUN">fun</span> <span id="local_x_147"><span class="LIDENT">x</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_x_147"><span class="LIDENT">x</span></a><span class="EOL">
</span>      <span class="RPAREN">)</span><span class="EOL">
</span>  <span class="ELSE">else</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_f_148"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/lazy.ml.html#val-from_val"><span class="UIDENT">Lazy</span><span class="DOT">.</span><span class="LIDENT">from_val</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_x_149"><span class="LIDENT">x</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_x_149"><span class="LIDENT">x</span></a><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="FUN">fun</span> <span class="LABEL">~command:</span><span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_f_148"><span class="LIDENT">f</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-apply_cygpath_path_transform"><span class="LIDENT">apply_cygpath_path_transform</span></span> <span class="TILDE">~</span><span id="local_pathlist_150"><span class="LIDENT">pathlist</span></span> <span id="local_cygpath_151"><span class="LIDENT">cygpath</span></span> <span id="local_path_152"><span class="LIDENT">path</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_args_153"><span class="LIDENT">args</span></span> <span class="EQUAL">=</span> <span class="IF">if</span> <a href="#local_pathlist_150"><span class="LIDENT">pathlist</span></a> <span class="THEN">then</span> <span class="LBRACKET">[</span> <span class="STRING">&quot;--path&quot;</span> <span class="RBRACKET">]</span> <span class="ELSE">else</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_r_154"><span class="LIDENT">r</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <a href="opamProcess.ml.html#val-run"><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="LIDENT">run</span></a><span class="EOL">
</span>      <span class="LPAREN">(</span><a href="opamProcess.ml.html#val-command"><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="LIDENT">command</span></a> <span class="LABEL">~name:</span><span class="LPAREN">(</span><span class="LIDENT">temp_file</span> <span class="STRING">&quot;command&quot;</span><span class="RPAREN">)</span> <span class="LABEL">~verbose:</span><span class="FALSE">false</span><span class="EOL">
</span>         <a href="#local_cygpath_151"><span class="LIDENT">cygpath</span></a> <span class="LPAREN">(</span><a href="#local_args_153"><span class="LIDENT">args</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(@)"><span class="INFIXOP1">@</span></a> <span class="LBRACKET">[</span><span class="STRING">&quot;--&quot;</span><span class="SEMI">;</span> <a href="#local_path_152"><span class="LIDENT">path</span></a><span class="RBRACKET">]</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <a href="opamProcess.ml.html#val-cleanup"><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="LIDENT">cleanup</span></a> <span class="LABEL">~force:</span><span class="TRUE">true</span> <a href="#local_r_154"><span class="LIDENT">r</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="opamProcess.ml.html#val-is_success"><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="LIDENT">is_success</span></a> <a href="#local_r_154"><span class="LIDENT">r</span></a> <span class="THEN">then</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-hd"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">hd</span></a> <a href="#local_r_154"><span class="LIDENT">r</span></a><span class="DOT">.</span><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="LIDENT">r_stdout</span><span class="EOL">
</span>  <span class="ELSE">else</span><span class="EOL">
</span>    <a href="opamConsole.ml.html#val-error_and_exit"><span class="UIDENT">OpamConsole</span><span class="DOT">.</span><span class="LIDENT">error_and_exit</span></a> <span class="BACKQUOTE">`</span><span class="UIDENT">Internal_error</span> <span class="STRING">&quot;Could not apply cygpath --path to %s&quot;</span> <a href="#local_path_152"><span class="LIDENT">path</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-get_cygpath_path_transform"><span class="LIDENT">get_cygpath_path_transform</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="COMMENT">(* We are running in a functioning Cygwin or MSYS2 environment if and only
     if `cygpath` is in the PATH. *)</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-win32"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">win32</span></a> <span class="THEN">then</span><span class="EOL">
</span>    <span class="LAZY">lazy</span> <span class="LPAREN">(</span><span class="EOL">
</span>      <span class="MATCH">match</span> <span class="LIDENT">resolve_command</span> <span class="STRING">&quot;cygpath&quot;</span> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_cygpath_155"><span class="LIDENT">cygpath</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">apply_cygpath_path_transform</span> <a href="#local_cygpath_155"><span class="LIDENT">cygpath</span></a><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span> <span class="FUN">fun</span> <span class="LABEL">~pathlist:</span><span class="UNDERSCORE">_</span> <span id="local_x_156"><span class="LIDENT">x</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_x_156"><span class="LIDENT">x</span></a><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="ELSE">else</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/lazy.ml.html#val-from_val"><span class="UIDENT">Lazy</span><span class="DOT">.</span><span class="LIDENT">from_val</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LABEL">~pathlist:</span><span class="UNDERSCORE">_</span> <span id="local_x_157"><span class="LIDENT">x</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_x_157"><span class="LIDENT">x</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-runs"><span class="LIDENT">runs</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ref"><span class="LIDENT">ref</span></a> <span class="LBRACKET">[</span><span class="RBRACKET">]</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-print_stats"><span class="LIDENT">print_stats</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="MATCH">match</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><span class="LIDENT">runs</span> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="BAR">|</span> <span id="local_l_158"><span class="LIDENT">l</span></span>  <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="opamConsole.ml.html#val-msg"><span class="UIDENT">OpamConsole</span><span class="DOT">.</span><span class="LIDENT">msg</span></a> <span class="STRING">&quot;%d external processes called:\n%s&quot;</span><span class="EOL">
</span>      <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-length"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">length</span></a> <a href="#local_l_158"><span class="LIDENT">l</span></a><span class="RPAREN">)</span> <span class="LPAREN">(</span><a href="opamStd.ml.html#module-OpamFormat.val-itemize"><span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">Format</span><span class="DOT">.</span><span class="LIDENT">itemize</span></a> <span class="LABEL">~bullet:</span><span class="STRING">&quot;  &quot;</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/string.ml.html#val-concat"><span class="UIDENT">String</span><span class="DOT">.</span><span class="LIDENT">concat</span></a> <span class="STRING">&quot; &quot;</span><span class="RPAREN">)</span> <a href="#local_l_158"><span class="LIDENT">l</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-log_file"><span class="LIDENT">log_file</span></span> <span class="QUESTION">?</span><span id="local_dir_159"><span class="LIDENT">dir</span></span> <span id="local_name_160"><span class="LIDENT">name</span></span> <span class="EQUAL">=</span> <span class="LIDENT">temp_file</span> <span class="QUESTION">?</span><a href="#local_dir_159"><span class="LIDENT">dir</span></a> <span class="LPAREN">(</span><a href="opamStd.ml.html#module-Option.val-default"><span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">Option</span><span class="DOT">.</span><span class="LIDENT">default</span></a> <span class="STRING">&quot;log&quot;</span> <a href="#local_name_160"><span class="LIDENT">name</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-make_command"><span class="LIDENT">make_command</span></span><span class="EOL">
</span>    <span class="QUESTION">?</span><span id="local_verbose_161"><span class="LIDENT">verbose</span></span> <span class="QUESTION">?</span><span id="local_env_162"><span class="LIDENT">env</span></span> <span class="QUESTION">?</span><span id="local_name_163"><span class="LIDENT">name</span></span> <span class="QUESTION">?</span><span id="local_text_164"><span class="LIDENT">text</span></span> <span class="QUESTION">?</span><span id="local_metadata_165"><span class="LIDENT">metadata</span></span> <span class="QUESTION">?</span><span id="local_allow_stdin_166"><span class="LIDENT">allow_stdin</span></span> <span class="QUESTION">?</span><span id="local_stdout_167"><span class="LIDENT">stdout</span></span><span class="EOL">
</span>    <span class="QUESTION">?</span><span id="local_dir_168"><span class="LIDENT">dir</span></span> <span class="QUESTION">?</span><span class="LPAREN">(</span><span id="local_resolve_path_169"><span class="LIDENT">resolve_path</span></span><span class="EQUAL">=</span><span class="TRUE">true</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span id="local_cmd_170"><span class="LIDENT">cmd</span></span> <span id="local_args_171"><span class="LIDENT">args</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_env_172"><span class="LIDENT">env</span></span> <span class="EQUAL">=</span> <span class="MATCH">match</span> <a href="#local_env_162"><span class="LIDENT">env</span></a> <span class="WITH">with</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span> <a href="opamProcess.ml.html#val-default_env"><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="LIDENT">default_env</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_e_173"><span class="LIDENT">e</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_e_173"><span class="LIDENT">e</span></a> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_name_174"><span class="LIDENT">name</span></span> <span class="EQUAL">=</span> <span class="LIDENT">log_file</span> <a href="#local_name_163"><span class="LIDENT">name</span></a> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_verbose_175"><span class="LIDENT">verbose</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <a href="opamStd.ml.html#module-Option.val-default"><span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">Option</span><span class="DOT">.</span><span class="LIDENT">default</span></a> <a href="opamCoreConfig.ml.html"><span class="UIDENT">OpamCoreConfig</span></a><span class="DOT">.</span><span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="opamCoreConfig.ml.html#val-r"><span class="LIDENT">r</span></a><span class="DOT">.</span><span class="LIDENT">verbose_level</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;=)"><span class="INFIXOP0">&gt;=</span></a> <span class="INT">2</span><span class="RPAREN">)</span> <a href="#local_verbose_161"><span class="LIDENT">verbose</span></a><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_full_cmd_176"><span class="LIDENT">full_cmd</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_resolve_path_169"><span class="LIDENT">resolve_path</span></a> <span class="THEN">then</span> <a href="opamStd.ml.html#module-OpamSys.val-resolve_command"><span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">resolve_command</span></a> <span class="TILDE">~</span><a href="#local_env_172"><span class="LIDENT">env</span></a> <span class="QUESTION">?</span><a href="#local_dir_168"><span class="LIDENT">dir</span></a> <a href="#local_cmd_170"><span class="LIDENT">cmd</span></a><span class="EOL">
</span>    <span class="ELSE">else</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Cmd</span> <a href="#local_cmd_170"><span class="LIDENT">cmd</span></a><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <span class="MATCH">match</span> <a href="#local_full_cmd_176"><span class="LIDENT">full_cmd</span></a> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Cmd</span> <span id="local_cmd_177"><span class="LIDENT">cmd</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="opamProcess.ml.html#val-command"><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="LIDENT">command</span></a><span class="EOL">
</span>      <span class="TILDE">~</span><a href="#local_env_172"><span class="LIDENT">env</span></a> <span class="TILDE">~</span><a href="#local_name_174"><span class="LIDENT">name</span></a> <span class="QUESTION">?</span><a href="#local_text_164"><span class="LIDENT">text</span></a> <span class="TILDE">~</span><a href="#local_verbose_175"><span class="LIDENT">verbose</span></a> <span class="QUESTION">?</span><a href="#local_metadata_165"><span class="LIDENT">metadata</span></a> <span class="QUESTION">?</span><a href="#local_allow_stdin_166"><span class="LIDENT">allow_stdin</span></a> <span class="QUESTION">?</span><a href="#local_stdout_167"><span class="LIDENT">stdout</span></a> <span class="QUESTION">?</span><a href="#local_dir_168"><span class="LIDENT">dir</span></a><span class="EOL">
</span>      <a href="#local_cmd_177"><span class="LIDENT">cmd</span></a> <a href="#local_args_171"><span class="LIDENT">args</span></a><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Not_found</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">command_not_found</span> <a href="#local_cmd_170"><span class="LIDENT">cmd</span></a><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Denied</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">permission_denied</span> <a href="#local_cmd_170"><span class="LIDENT">cmd</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-run_process"><span class="LIDENT">run_process</span></span><span class="EOL">
</span>    <span class="QUESTION">?</span><span id="local_verbose_178"><span class="LIDENT">verbose</span></span> <span class="QUESTION">?</span><span id="local_env_179"><span class="LIDENT">env</span></span> <span class="TILDE">~</span><span id="local_name_180"><span class="LIDENT">name</span></span> <span class="QUESTION">?</span><span id="local_metadata_181"><span class="LIDENT">metadata</span></span> <span class="QUESTION">?</span><span id="local_stdout_182"><span class="LIDENT">stdout</span></span> <span class="QUESTION">?</span><span id="local_allow_stdin_183"><span class="LIDENT">allow_stdin</span></span> <span id="local_command_184"><span class="LIDENT">command</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_env_185"><span class="LIDENT">env</span></span> <span class="EQUAL">=</span> <span class="MATCH">match</span> <a href="#local_env_179"><span class="LIDENT">env</span></a> <span class="WITH">with</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span> <a href="opamProcess.ml.html#val-default_env"><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="LIDENT">default_env</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_e_186"><span class="LIDENT">e</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_e_186"><span class="LIDENT">e</span></a> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_chrono_187"><span class="LIDENT">chrono</span></span> <span class="EQUAL">=</span> <a href="opamConsole.ml.html#val-timer"><span class="UIDENT">OpamConsole</span><span class="DOT">.</span><span class="LIDENT">timer</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LIDENT">runs</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="#local_command_184"><span class="LIDENT">command</span></a> <span class="COLONCOLON">::</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><span class="LIDENT">runs</span><span class="SEMI">;</span><span class="EOL">
</span>  <span class="MATCH">match</span> <a href="#local_command_184"><span class="LIDENT">command</span></a> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span>          <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-invalid_arg"><span class="LIDENT">invalid_arg</span></a> <span class="STRING">&quot;run_process&quot;</span><span class="EOL">
</span>  <span class="BAR">|</span> <span id="local_cmd_188"><span class="LIDENT">cmd</span></span> <span class="COLONCOLON">::</span> <span id="local_args_189"><span class="LIDENT">args</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="opamStd.ml.html#module-OpamSys.val-resolve_command"><span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">resolve_command</span></a> <span class="TILDE">~</span><a href="#local_env_185"><span class="LIDENT">env</span></a> <a href="#local_cmd_188"><span class="LIDENT">cmd</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Cmd</span> <span id="local_full_cmd_190"><span class="LIDENT">full_cmd</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_verbose_191"><span class="LIDENT">verbose</span></span> <span class="EQUAL">=</span> <span class="MATCH">match</span> <a href="#local_verbose_178"><span class="LIDENT">verbose</span></a> <span class="WITH">with</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">None</span>   <span class="MINUSGREATER">-&gt;</span> <a href="opamCoreConfig.ml.html"><span class="UIDENT">OpamCoreConfig</span></a><span class="DOT">.</span><span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="opamCoreConfig.ml.html#val-r"><span class="LIDENT">r</span></a><span class="DOT">.</span><span class="LIDENT">verbose_level</span><span class="RPAREN">)</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;=)"><span class="INFIXOP0">&gt;=</span></a> <span class="INT">2</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_b_192"><span class="LIDENT">b</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_b_192"><span class="LIDENT">b</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_r_193"><span class="LIDENT">r</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>        <a href="opamProcess.ml.html#val-run"><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="LIDENT">run</span></a><span class="EOL">
</span>          <span class="LPAREN">(</span><a href="opamProcess.ml.html#val-command"><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="LIDENT">command</span></a><span class="EOL">
</span>             <span class="TILDE">~</span><a href="#local_env_185"><span class="LIDENT">env</span></a> <span class="TILDE">~</span><a href="#local_name_180"><span class="LIDENT">name</span></a> <span class="TILDE">~</span><a href="#local_verbose_191"><span class="LIDENT">verbose</span></a> <span class="QUESTION">?</span><a href="#local_metadata_181"><span class="LIDENT">metadata</span></a> <span class="QUESTION">?</span><a href="#local_allow_stdin_183"><span class="LIDENT">allow_stdin</span></a> <span class="QUESTION">?</span><a href="#local_stdout_182"><span class="LIDENT">stdout</span></a><span class="EOL">
</span>             <a href="#local_full_cmd_190"><span class="LIDENT">full_cmd</span></a> <a href="#local_args_189"><span class="LIDENT">args</span></a><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="IN">in</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_str_194"><span class="LIDENT">str</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/string.ml.html#val-concat"><span class="UIDENT">String</span><span class="DOT">.</span><span class="LIDENT">concat</span></a> <span class="STRING">&quot; &quot;</span> <span class="LPAREN">(</span><a href="#local_cmd_188"><span class="LIDENT">cmd</span></a> <span class="COLONCOLON">::</span> <a href="#local_args_189"><span class="LIDENT">args</span></a><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>      <span class="LIDENT">log</span> <span class="LABEL">~level:</span><span class="INT">2</span> <span class="STRING">&quot;[%a] (in %.3fs) %s&quot;</span><span class="EOL">
</span>        <span class="LPAREN">(</span><a href="opamConsole.ml.html#val-slog"><span class="UIDENT">OpamConsole</span><span class="DOT">.</span><span class="LIDENT">slog</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#module-Sysdeps"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">basename</span></a><span class="RPAREN">)</span> <a href="#local_name_180"><span class="LIDENT">name</span></a><span class="EOL">
</span>        <span class="LPAREN">(</span><a href="#local_chrono_187"><span class="LIDENT">chrono</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="RPAREN">)</span> <a href="#local_str_194"><span class="LIDENT">str</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <a href="#local_r_193"><span class="LIDENT">r</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Not_found</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">command_not_found</span> <a href="#local_cmd_188"><span class="LIDENT">cmd</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Denied</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">permission_denied</span> <a href="#local_cmd_188"><span class="LIDENT">cmd</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-command"><span class="LIDENT">command</span></span> <span class="QUESTION">?</span><span id="local_verbose_195"><span class="LIDENT">verbose</span></span> <span class="QUESTION">?</span><span id="local_env_196"><span class="LIDENT">env</span></span> <span class="QUESTION">?</span><span id="local_name_197"><span class="LIDENT">name</span></span> <span class="QUESTION">?</span><span id="local_metadata_198"><span class="LIDENT">metadata</span></span> <span class="QUESTION">?</span><span id="local_allow_stdin_199"><span class="LIDENT">allow_stdin</span></span> <span id="local_cmd_200"><span class="LIDENT">cmd</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_name_201"><span class="LIDENT">name</span></span> <span class="EQUAL">=</span> <span class="LIDENT">log_file</span> <a href="#local_name_197"><span class="LIDENT">name</span></a> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_r_202"><span class="LIDENT">r</span></span> <span class="EQUAL">=</span> <span class="LIDENT">run_process</span> <span class="QUESTION">?</span><a href="#local_verbose_195"><span class="LIDENT">verbose</span></a> <span class="QUESTION">?</span><a href="#local_env_196"><span class="LIDENT">env</span></a> <span class="TILDE">~</span><a href="#local_name_201"><span class="LIDENT">name</span></a> <span class="QUESTION">?</span><a href="#local_metadata_198"><span class="LIDENT">metadata</span></a> <span class="QUESTION">?</span><a href="#local_allow_stdin_199"><span class="LIDENT">allow_stdin</span></a> <a href="#local_cmd_200"><span class="LIDENT">cmd</span></a> <span class="IN">in</span><span class="EOL">
</span>  <a href="opamProcess.ml.html#val-cleanup"><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="LIDENT">cleanup</span></a> <a href="#local_r_202"><span class="LIDENT">r</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="LIDENT">raise_on_process_error</span> <a href="#local_r_202"><span class="LIDENT">r</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-commands"><span class="LIDENT">commands</span></span> <span class="QUESTION">?</span><span id="local_verbose_203"><span class="LIDENT">verbose</span></span> <span class="QUESTION">?</span><span id="local_env_204"><span class="LIDENT">env</span></span> <span class="QUESTION">?</span><span id="local_name_205"><span class="LIDENT">name</span></span> <span class="QUESTION">?</span><span id="local_metadata_206"><span class="LIDENT">metadata</span></span> <span class="QUESTION">?</span><span class="LPAREN">(</span><span id="local_keep_going_207"><span class="LIDENT">keep_going</span></span><span class="EQUAL">=</span><span class="FALSE">false</span><span class="RPAREN">)</span> <span id="local_commands_208"><span class="LIDENT">commands</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_name_209"><span class="LIDENT">name</span></span> <span class="EQUAL">=</span> <span class="LIDENT">log_file</span> <a href="#local_name_205"><span class="LIDENT">name</span></a> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_run_210"><span class="LIDENT">run</span></span> <span class="EQUAL">=</span> <span class="LIDENT">run_process</span> <span class="QUESTION">?</span><a href="#local_verbose_203"><span class="LIDENT">verbose</span></a> <span class="QUESTION">?</span><a href="#local_env_204"><span class="LIDENT">env</span></a> <span class="TILDE">~</span><a href="#local_name_209"><span class="LIDENT">name</span></a> <span class="QUESTION">?</span><a href="#local_metadata_206"><span class="LIDENT">metadata</span></a> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_command_211"><span class="LIDENT">command</span></span> <span id="local_r0_212"><span class="LIDENT">r0</span></span> <span id="local_c_213"><span class="LIDENT">c</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_r0_212"><span class="LIDENT">r0</span></a><span class="COMMA">,</span> <a href="#local_keep_going_207"><span class="LIDENT">keep_going</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="LPAREN">(</span><span class="BACKQUOTE">`</span><span class="UIDENT">Error</span> <span class="UNDERSCORE">_</span> <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Exception</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span><span class="COMMA">,</span> <span class="FALSE">false</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_r0_212"><span class="LIDENT">r0</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_r1_214"><span class="LIDENT">r1</span></span> <span class="EQUAL">=</span> <span class="TRY">try</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_r_215"><span class="LIDENT">r</span></span> <span class="EQUAL">=</span> <a href="#local_run_210"><span class="LIDENT">run</span></a> <a href="#local_c_213"><span class="LIDENT">c</span></a> <span class="IN">in</span><span class="EOL">
</span>          <span class="IF">if</span> <a href="opamProcess.ml.html#val-is_success"><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="LIDENT">is_success</span></a> <a href="#local_r_215"><span class="LIDENT">r</span></a> <span class="THEN">then</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Successful</span> <a href="#local_r_215"><span class="LIDENT">r</span></a> <span class="ELSE">else</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Error</span> <a href="#local_r_215"><span class="LIDENT">r</span></a><span class="EOL">
</span>        <span class="WITH">with</span> <span class="UIDENT">Command_not_found</span> <span class="UNDERSCORE">_</span> <span class="AS">as</span> <span id="local_e_216"><span class="LIDENT">e</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Exception</span> <a href="#local_e_216"><span class="LIDENT">e</span></a><span class="EOL">
</span>      <span class="IN">in</span><span class="EOL">
</span>      <span class="MATCH">match</span> <a href="#local_r0_212"><span class="LIDENT">r0</span></a> <span class="WITH">with</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Start</span> <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Successful</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_r1_214"><span class="LIDENT">r1</span></a> <span class="BAR">|</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_r0_212"><span class="LIDENT">r0</span></a><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <span class="MATCH">match</span> <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-fold_left"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">fold_left</span></a> <a href="#local_command_211"><span class="LIDENT">command</span></a> <span class="BACKQUOTE">`</span><span class="UIDENT">Start</span> <a href="#local_commands_208"><span class="LIDENT">commands</span></a> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Start</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Successful</span> <span id="local_r_217"><span class="LIDENT">r</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="opamProcess.ml.html#val-cleanup"><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="LIDENT">cleanup</span></a> <a href="#local_r_217"><span class="LIDENT">r</span></a><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Error</span> <span id="local_e_218"><span class="LIDENT">e</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">process_error</span> <a href="#local_e_218"><span class="LIDENT">e</span></a><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Exception</span> <span id="local_e_219"><span class="LIDENT">e</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-raise"><span class="LIDENT">raise</span></a> <a href="#local_e_219"><span class="LIDENT">e</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-read_command_output"><span class="LIDENT">read_command_output</span></span> <span class="QUESTION">?</span><span id="local_verbose_220"><span class="LIDENT">verbose</span></span> <span class="QUESTION">?</span><span id="local_env_221"><span class="LIDENT">env</span></span> <span class="QUESTION">?</span><span id="local_metadata_222"><span class="LIDENT">metadata</span></span> <span class="QUESTION">?</span><span id="local_allow_stdin_223"><span class="LIDENT">allow_stdin</span></span><span class="EOL">
</span>    <span class="QUESTION">?</span><span class="LPAREN">(</span><span id="local_ignore_stderr_224"><span class="LIDENT">ignore_stderr</span></span><span class="EQUAL">=</span><span class="FALSE">false</span><span class="RPAREN">)</span> <span id="local_cmd_225"><span class="LIDENT">cmd</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_name_226"><span class="LIDENT">name</span></span> <span class="EQUAL">=</span> <span class="LIDENT">log_file</span> <span class="UIDENT">None</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_stdout_227"><span class="LIDENT">stdout</span></span> <span class="EQUAL">=</span> <a href="#local_name_226"><span class="LIDENT">name</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(^)"><span class="INFIXOP1">^</span></a> <span class="LPAREN">(</span><span class="IF">if</span> <a href="#local_ignore_stderr_224"><span class="LIDENT">ignore_stderr</span></a> <span class="THEN">then</span> <span class="STRING">&quot;.stdout&quot;</span> <span class="ELSE">else</span> <span class="STRING">&quot;.out&quot;</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_r_228"><span class="LIDENT">r</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">run_process</span> <span class="QUESTION">?</span><a href="#local_verbose_220"><span class="LIDENT">verbose</span></a> <span class="QUESTION">?</span><a href="#local_env_221"><span class="LIDENT">env</span></a> <span class="TILDE">~</span><a href="#local_name_226"><span class="LIDENT">name</span></a> <span class="QUESTION">?</span><a href="#local_metadata_222"><span class="LIDENT">metadata</span></a> <span class="QUESTION">?</span><a href="#local_allow_stdin_223"><span class="LIDENT">allow_stdin</span></a><span class="EOL">
</span>      <span class="TILDE">~</span><a href="#local_stdout_227"><span class="LIDENT">stdout</span></a><span class="EOL">
</span>      <a href="#local_cmd_225"><span class="LIDENT">cmd</span></a><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <a href="opamProcess.ml.html#val-cleanup"><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="LIDENT">cleanup</span></a> <a href="#local_r_228"><span class="LIDENT">r</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="LIDENT">raise_on_process_error</span> <a href="#local_r_228"><span class="LIDENT">r</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <a href="#local_r_228"><span class="LIDENT">r</span></a><span class="DOT">.</span><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="LIDENT">r_stdout</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-verbose_for_base_commands"><span class="LIDENT">verbose_for_base_commands</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="opamCoreConfig.ml.html"><span class="UIDENT">OpamCoreConfig</span></a><span class="DOT">.</span><span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="opamCoreConfig.ml.html#val-r"><span class="LIDENT">r</span></a><span class="DOT">.</span><span class="LIDENT">verbose_level</span><span class="RPAREN">)</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;=)"><span class="INFIXOP0">&gt;=</span></a> <span class="INT">3</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-copy_file_t"><span class="LIDENT">copy_file_t</span></span> <span class="QUESTION">?</span><span class="LPAREN">(</span><span id="local_with_log_229"><span class="LIDENT">with_log</span></span><span class="EQUAL">=</span><span class="TRUE">true</span><span class="RPAREN">)</span> <span id="local_src_230"><span class="LIDENT">src</span></span> <span id="local_dst_231"><span class="LIDENT">dst</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="IF">if</span> <span class="LPAREN">(</span><span class="TRY">try</span> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-is_directory"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">is_directory</span></a> <a href="#local_src_230"><span class="LIDENT">src</span></a><span class="EOL">
</span>      <span class="WITH">with</span> <span class="UIDENT">Sys_error</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-raise"><span class="LIDENT">raise</span></a> <span class="LPAREN">(</span><span class="UIDENT">File_not_found</span> <a href="#local_src_230"><span class="LIDENT">src</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="THEN">then</span> <span class="LIDENT">internal_error</span> <span class="STRING">&quot;Cannot copy %s: it is a directory.&quot;</span> <a href="#local_src_230"><span class="LIDENT">src</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="IF">if</span> <span class="LPAREN">(</span><span class="TRY">try</span> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-is_directory"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">is_directory</span></a> <a href="#local_dst_231"><span class="LIDENT">dst</span></a> <span class="WITH">with</span> <span class="UIDENT">Sys_error</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="FALSE">false</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="THEN">then</span> <span class="LIDENT">internal_error</span> <span class="STRING">&quot;Cannot copy to %s: it is a directory.&quot;</span> <a href="#local_dst_231"><span class="LIDENT">dst</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="IF">if</span> <span class="LIDENT">file_or_symlink_exists</span> <a href="#local_dst_231"><span class="LIDENT">dst</span></a><span class="EOL">
</span>  <span class="THEN">then</span> <span class="LIDENT">remove_file</span> <a href="#local_dst_231"><span class="LIDENT">dst</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="LIDENT">mkdir</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#module-Sysdeps"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">dirname</span></a> <a href="#local_dst_231"><span class="LIDENT">dst</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="#local_with_log_229"><span class="LIDENT">with_log</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <span class="LIDENT">log_for_file_management</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="THEN">then</span><span class="EOL">
</span>    <span class="LIDENT">log</span> <span class="STRING">&quot;copy %s -&gt; %s&quot;</span> <a href="#local_src_230"><span class="LIDENT">src</span></a> <a href="#local_dst_231"><span class="LIDENT">dst</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="LIDENT">copy_file_aux</span> <span class="TILDE">~</span><a href="#local_src_230"><span class="LIDENT">src</span></a> <span class="TILDE">~</span><a href="#local_dst_231"><span class="LIDENT">dst</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span class="REC">rec</span> <span id="val-link_t"><span class="LIDENT">link_t</span></span> <span class="QUESTION">?</span><span class="LPAREN">(</span><span id="local_with_log_232"><span class="LIDENT">with_log</span></span><span class="EQUAL">=</span><span class="TRUE">true</span><span class="RPAREN">)</span> <span id="local_src_233"><span class="LIDENT">src</span></span> <span id="local_dst_234"><span class="LIDENT">dst</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">mkdir</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#module-Sysdeps"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">dirname</span></a> <a href="#local_dst_234"><span class="LIDENT">dst</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>  <span class="IF">if</span> <span class="LIDENT">file_or_symlink_exists</span> <a href="#local_dst_234"><span class="LIDENT">dst</span></a> <span class="THEN">then</span><span class="EOL">
</span>    <span class="LIDENT">remove_file</span> <a href="#local_dst_234"><span class="LIDENT">dst</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="TRY">try</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_with_log_232"><span class="LIDENT">with_log</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <span class="LIDENT">log_for_file_management</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="THEN">then</span><span class="EOL">
</span>      <span class="LIDENT">log</span> <span class="STRING">&quot;ln -s %s %s&quot;</span> <a href="#local_src_233"><span class="LIDENT">src</span></a> <a href="#local_dst_234"><span class="LIDENT">dst</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">symlink</span> <a href="#local_src_233"><span class="LIDENT">src</span></a> <a href="#local_dst_234"><span class="LIDENT">dst</span></a><span class="EOL">
</span>  <span class="WITH">with</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">Unix_error</span> <span class="LPAREN">(</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">EXDEV</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="COMMENT">(* Fall back to copy if symlinks are not supported *)</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_src_235"><span class="LIDENT">src</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#module-Sysdeps"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">is_relative</span></a> <a href="#local_src_233"><span class="LIDENT">src</span></a> <span class="THEN">then</span> <a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#module-Sysdeps"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">dirname</span></a> <a href="#local_dst_234"><span class="LIDENT">dst</span></a> <span class="INFIXOP3">/</span> <a href="#local_src_233"><span class="LIDENT">src</span></a><span class="EOL">
</span>      <span class="ELSE">else</span> <a href="#local_src_233"><span class="LIDENT">src</span></a><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-is_directory"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">is_directory</span></a> <a href="#local_src_235"><span class="LIDENT">src</span></a> <span class="THEN">then</span><span class="EOL">
</span>      <span class="LIDENT">copy_dir_t</span> <a href="#local_src_235"><span class="LIDENT">src</span></a> <a href="#local_dst_234"><span class="LIDENT">dst</span></a><span class="EOL">
</span>    <span class="ELSE">else</span><span class="EOL">
</span>      <span class="LIDENT">copy_file_t</span> <a href="#local_src_235"><span class="LIDENT">src</span></a> <a href="#local_dst_234"><span class="LIDENT">dst</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="AND">and</span> <span id="val-copy_dir_t"><span class="LIDENT">copy_dir_t</span></span> <span class="QUESTION">?</span><span class="LPAREN">(</span><span id="local_with_log_236"><span class="LIDENT">with_log</span></span><span class="EQUAL">=</span><span class="TRUE">true</span><span class="RPAREN">)</span> <span id="local_src_237"><span class="LIDENT">src</span></span> <span id="local_dst_dir_238"><span class="LIDENT">dst_dir</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="#local_with_log_236"><span class="LIDENT">with_log</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <span class="LIDENT">log_for_file_management</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="THEN">then</span><span class="EOL">
</span>    <span class="LIDENT">log</span> <span class="STRING">&quot;copydir %s -&gt; %s&quot;</span> <a href="#local_src_237"><span class="LIDENT">src</span></a> <a href="#local_dst_dir_238"><span class="LIDENT">dst_dir</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_files_239"><span class="LIDENT">files</span></span> <span class="EQUAL">=</span> <span class="LIDENT">get_files</span> <a href="#local_src_237"><span class="LIDENT">src</span></a> <span class="IN">in</span><span class="EOL">
</span>  <span class="LIDENT">mkdir</span> <a href="#local_dst_dir_238"><span class="LIDENT">dst_dir</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_with_log_240"><span class="LIDENT">with_log</span></span> <span class="EQUAL">=</span> <span class="FALSE">false</span> <span class="IN">in</span><span class="EOL">
</span>  <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-iter"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">iter</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_file_241"><span class="LIDENT">file</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_src_242"><span class="LIDENT">src</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#val-concat"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">concat</span></a> <a href="#local_src_237"><span class="LIDENT">src</span></a> <a href="#local_file_241"><span class="LIDENT">file</span></a> <span class="IN">in</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_dst_243"><span class="LIDENT">dst</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#val-concat"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">concat</span></a> <a href="#local_dst_dir_238"><span class="LIDENT">dst_dir</span></a> <a href="#local_file_241"><span class="LIDENT">file</span></a> <span class="IN">in</span><span class="EOL">
</span>      <span class="MATCH">match</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">lstat</span> <a href="#local_src_242"><span class="LIDENT">src</span></a> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="LBRACE">{</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">st_kind</span> <span class="EQUAL">=</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">S_REG</span><span class="SEMI">;</span> <span class="UNDERSCORE">_</span><span class="RBRACE">}</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LIDENT">copy_file_t</span> <span class="TILDE">~</span><a href="#local_with_log_240"><span class="LIDENT">with_log</span></a> <a href="#local_src_242"><span class="LIDENT">src</span></a> <a href="#local_dst_243"><span class="LIDENT">dst</span></a><span class="EOL">
</span>      <span class="BAR">|</span> <span class="LBRACE">{</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">st_kind</span> <span class="EQUAL">=</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">S_DIR</span><span class="SEMI">;</span> <span class="UNDERSCORE">_</span><span class="RBRACE">}</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LIDENT">copy_dir_t</span> <span class="TILDE">~</span><a href="#local_with_log_240"><span class="LIDENT">with_log</span></a> <a href="#local_src_242"><span class="LIDENT">src</span></a> <a href="#local_dst_243"><span class="LIDENT">dst</span></a><span class="EOL">
</span>      <span class="BAR">|</span> <span class="LBRACE">{</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">st_kind</span> <span class="EQUAL">=</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">S_LNK</span><span class="SEMI">;</span> <span class="UNDERSCORE">_</span><span class="RBRACE">}</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_src_244"><span class="LIDENT">src</span></span> <span class="EQUAL">=</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">readlink</span> <a href="#local_src_242"><span class="LIDENT">src</span></a> <span class="IN">in</span><span class="EOL">
</span>        <span class="LIDENT">link_t</span> <span class="TILDE">~</span><a href="#local_with_log_240"><span class="LIDENT">with_log</span></a> <a href="#local_src_244"><span class="LIDENT">src</span></a> <a href="#local_dst_243"><span class="LIDENT">dst</span></a><span class="EOL">
</span>      <span class="BAR">|</span> <span class="LBRACE">{</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">st_kind</span> <span class="EQUAL">=</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">S_CHR</span><span class="SEMI">;</span> <span class="UNDERSCORE">_</span><span class="RBRACE">}</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-failwith"><span class="failwith">failwith</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/printf.ml.html#val-sprintf"><span class="UIDENT">Printf</span><span class="DOT">.</span><span class="LIDENT">sprintf</span></a> <span class="STRING">&quot;Copying character devices (%s) is unsupported&quot;</span> <a href="#local_src_242"><span class="LIDENT">src</span></a><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="LBRACE">{</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">st_kind</span> <span class="EQUAL">=</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">S_BLK</span><span class="SEMI">;</span> <span class="UNDERSCORE">_</span><span class="RBRACE">}</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-failwith"><span class="failwith">failwith</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/printf.ml.html#val-sprintf"><span class="UIDENT">Printf</span><span class="DOT">.</span><span class="LIDENT">sprintf</span></a> <span class="STRING">&quot;Copying block devices (%s) is unsupported&quot;</span> <a href="#local_src_242"><span class="LIDENT">src</span></a><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="LBRACE">{</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">st_kind</span> <span class="EQUAL">=</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">S_FIFO</span><span class="SEMI">;</span> <span class="UNDERSCORE">_</span><span class="RBRACE">}</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-failwith"><span class="failwith">failwith</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/printf.ml.html#val-sprintf"><span class="UIDENT">Printf</span><span class="DOT">.</span><span class="LIDENT">sprintf</span></a> <span class="STRING">&quot;Copying named pipes (%s) is unsupported&quot;</span> <a href="#local_src_242"><span class="LIDENT">src</span></a><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="LBRACE">{</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">st_kind</span> <span class="EQUAL">=</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">S_SOCK</span><span class="SEMI">;</span> <span class="UNDERSCORE">_</span><span class="RBRACE">}</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-failwith"><span class="failwith">failwith</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/printf.ml.html#val-sprintf"><span class="UIDENT">Printf</span><span class="DOT">.</span><span class="LIDENT">sprintf</span></a> <span class="STRING">&quot;Copying sockets (%s) is unsupported&quot;</span> <a href="#local_src_242"><span class="LIDENT">src</span></a><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="EXCEPTION">exception</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LPAREN">(</span><span class="UIDENT">Unix_error</span> <span class="LPAREN">(</span><span class="UIDENT">ENOENT</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span><span class="RPAREN">)</span> <span class="WHEN">when</span> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-win32"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">win32</span></a> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="COMMENT">(* This is usually caused by invalid symlinks extracted by a
           Cygwin/MSYS2 tar. *)</span><span class="EOL">
</span>        <a href="opamConsole.ml.html#val-warning"><span class="UIDENT">OpamConsole</span><span class="DOT">.</span><span class="LIDENT">warning</span></a> <span class="STRING">&quot;Warning: cannot copy %s to %s&quot;</span> <a href="#local_src_242"><span class="LIDENT">src</span></a> <a href="#local_dst_dir_238"><span class="LIDENT">dst_dir</span></a><span class="EOL">
</span>    <span class="RPAREN">)</span> <a href="#local_files_239"><span class="LIDENT">files</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-copy_dir"><span class="LIDENT">copy_dir</span></span> <span class="EQUAL">=</span> <span class="LIDENT">copy_dir_t</span> <span class="LABEL">~with_log:</span><span class="TRUE">true</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-copy_file"><span class="LIDENT">copy_file</span></span> <span class="EQUAL">=</span> <span class="LIDENT">copy_file_t</span> <span class="LABEL">~with_log:</span><span class="TRUE">true</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-mv"><span class="LIDENT">mv</span></span> <span id="local_src_245"><span class="LIDENT">src</span></span> <span id="local_dst_246"><span class="LIDENT">dst</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="IF">if</span> <span class="LIDENT">file_or_symlink_exists</span> <a href="#local_dst_246"><span class="LIDENT">dst</span></a> <span class="THEN">then</span> <span class="LIDENT">remove_file</span> <a href="#local_dst_246"><span class="LIDENT">dst</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="LIDENT">mkdir</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#module-Sysdeps"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">dirname</span></a> <a href="#local_dst_246"><span class="LIDENT">dst</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>  <span class="LIDENT">log</span> <span class="STRING">&quot;mv %s -&gt; %s&quot;</span> <a href="#local_src_245"><span class="LIDENT">src</span></a> <a href="#local_dst_246"><span class="LIDENT">dst</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="TRY">try</span><span class="EOL">
</span>    <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">rename</span> <a href="#local_src_245"><span class="LIDENT">src</span></a> <a href="#local_dst_246"><span class="LIDENT">dst</span></a><span class="EOL">
</span>  <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">Unix_error</span><span class="LPAREN">(</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">EXDEV</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_with_log_247"><span class="LIDENT">with_log</span></span> <span class="EQUAL">=</span> <span class="FALSE">false</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-is_directory"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">is_directory</span></a> <a href="#local_src_245"><span class="LIDENT">src</span></a><span class="EOL">
</span>    <span class="THEN">then</span> <span class="LPAREN">(</span><span class="LIDENT">copy_dir_t</span> <span class="TILDE">~</span><a href="#local_with_log_247"><span class="LIDENT">with_log</span></a> <a href="#local_src_245"><span class="LIDENT">src</span></a> <a href="#local_dst_246"><span class="LIDENT">dst</span></a><span class="SEMI">;</span> <span class="LIDENT">remove_dir_t</span> <a href="#local_src_245"><span class="LIDENT">src</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="ELSE">else</span> <span class="LPAREN">(</span><span class="LIDENT">copy_file_t</span> <span class="TILDE">~</span><a href="#local_with_log_247"><span class="LIDENT">with_log</span></a> <a href="#local_src_245"><span class="LIDENT">src</span></a> <a href="#local_dst_246"><span class="LIDENT">dst</span></a><span class="SEMI">;</span> <span class="LIDENT">remove_file_t</span> <span class="TILDE">~</span><a href="#local_with_log_247"><span class="LIDENT">with_log</span></a> <a href="#local_src_245"><span class="LIDENT">src</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-is_exec"><span class="LIDENT">is_exec</span></span> <span id="local_file_248"><span class="LIDENT">file</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_stat_249"><span class="LIDENT">stat</span></span> <span class="EQUAL">=</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">stat</span> <a href="#local_file_248"><span class="LIDENT">file</span></a> <span class="IN">in</span><span class="EOL">
</span>  <a href="#local_stat_249"><span class="LIDENT">stat</span></a><span class="DOT">.</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">st_kind</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">S_REG</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&amp;&amp;)"><span class="AMPERAMPER">&amp;&amp;</span></a><span class="EOL">
</span>  <a href="#local_stat_249"><span class="LIDENT">stat</span></a><span class="DOT">.</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">st_perm</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(land)"><span class="INFIXOP3">land</span></a> <span class="INT">0o111</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;&gt;)"><span class="INFIXOP0">&lt;&gt;</span></a> <span class="INT">0</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-file_is_empty"><span class="LIDENT">file_is_empty</span></span> <span id="local_f_250"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LPAREN">(</span><span class="LPAREN">(</span><span class="LIDENT">stat</span> <a href="#local_f_250"><span class="LIDENT">f</span></a><span class="RPAREN">)</span><span class="DOT">.</span><span class="LIDENT">st_size</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="INT">0</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-classify_executable"><span class="LIDENT">classify_executable</span></span> <span id="local_file_251"><span class="LIDENT">file</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_c_252"><span class="LIDENT">c</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-open_in"><span class="LIDENT">open_in</span></a> <a href="#local_file_251"><span class="LIDENT">file</span></a> <span class="IN">in</span><span class="EOL">
</span>  <span class="COMMENT">(* On a 32-bit system, this could fail for a PE image with a 2GB+ DOS header =-o *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_input_int_little_253"><span class="LIDENT">input_int_little</span></span> <span id="local_c_254"><span class="LIDENT">c</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_b1_255"><span class="LIDENT">b1</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-input_byte"><span class="LIDENT">input_byte</span></a> <a href="#local_c_254"><span class="LIDENT">c</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_b2_256"><span class="LIDENT">b2</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-input_byte"><span class="LIDENT">input_byte</span></a> <a href="#local_c_254"><span class="LIDENT">c</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_b3_257"><span class="LIDENT">b3</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-input_byte"><span class="LIDENT">input_byte</span></a> <a href="#local_c_254"><span class="LIDENT">c</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_b4_258"><span class="LIDENT">b4</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-input_byte"><span class="LIDENT">input_byte</span></a> <a href="#local_c_254"><span class="LIDENT">c</span></a> <span class="IN">in</span><span class="EOL">
</span>    <a href="#local_b1_255"><span class="LIDENT">b1</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(lor)"><span class="INFIXOP3">lor</span></a> <span class="LPAREN">(</span><a href="#local_b2_256"><span class="LIDENT">b2</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(lsl)"><span class="INFIXOP4">lsl</span></a> <span class="INT">8</span><span class="RPAREN">)</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(lor)"><span class="INFIXOP3">lor</span></a> <span class="LPAREN">(</span><a href="#local_b3_257"><span class="LIDENT">b3</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(lsl)"><span class="INFIXOP4">lsl</span></a> <span class="INT">16</span><span class="RPAREN">)</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(lor)"><span class="INFIXOP3">lor</span></a> <span class="LPAREN">(</span><a href="#local_b4_258"><span class="LIDENT">b4</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(lsl)"><span class="INFIXOP4">lsl</span></a> <span class="INT">24</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_input_short_little_259"><span class="LIDENT">input_short_little</span></span> <span id="local_c_260"><span class="LIDENT">c</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_b1_261"><span class="LIDENT">b1</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-input_byte"><span class="LIDENT">input_byte</span></a> <a href="#local_c_260"><span class="LIDENT">c</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_b2_262"><span class="LIDENT">b2</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-input_byte"><span class="LIDENT">input_byte</span></a> <a href="#local_c_260"><span class="LIDENT">c</span></a> <span class="IN">in</span><span class="EOL">
</span>    <a href="#local_b1_261"><span class="LIDENT">b1</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(lor)"><span class="INFIXOP3">lor</span></a> <span class="LPAREN">(</span><a href="#local_b2_262"><span class="LIDENT">b2</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(lsl)"><span class="INFIXOP4">lsl</span></a> <span class="INT">8</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>  <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-set_binary_mode_in"><span class="LIDENT">set_binary_mode_in</span></a> <a href="#local_c_252"><span class="LIDENT">c</span></a> <span class="TRUE">true</span><span class="SEMI">;</span><span class="EOL">
</span>  <span class="TRY">try</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-really_input_string"><span class="LIDENT">really_input_string</span></a> <a href="#local_c_252"><span class="LIDENT">c</span></a> <span class="INT">2</span> <span class="WITH">with</span><span class="EOL">
</span>      <span class="STRING">&quot;#!&quot;</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-close_in"><span class="LIDENT">close_in</span></a> <a href="#local_c_252"><span class="LIDENT">c</span></a><span class="SEMI">;</span><span class="EOL">
</span>        <span class="BACKQUOTE">`</span><span class="UIDENT">Script</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="STRING">&quot;MZ&quot;</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_is_pe_263"><span class="LIDENT">is_pe</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>          <span class="TRY">try</span><span class="EOL">
</span>            <span class="COMMENT">(* Offset to PE header at 0x3c (but we've already read two bytes) *)</span><span class="EOL">
</span>            <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-really_input_string"><span class="LIDENT">really_input_string</span></a> <a href="#local_c_252"><span class="LIDENT">c</span></a> <span class="INT">0x3a</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>            <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-really_input_string"><span class="LIDENT">really_input_string</span></a> <a href="#local_c_252"><span class="LIDENT">c</span></a> <span class="LPAREN">(</span><a href="#local_input_int_little_253"><span class="LIDENT">input_int_little</span></a> <a href="#local_c_252"><span class="LIDENT">c</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <span class="INT">0x40</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>            <span class="LET">let</span> <span id="local_magic_264"><span class="LIDENT">magic</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-really_input_string"><span class="LIDENT">really_input_string</span></a> <a href="#local_c_252"><span class="LIDENT">c</span></a> <span class="INT">4</span> <span class="IN">in</span><span class="EOL">
</span>            <a href="#local_magic_264"><span class="LIDENT">magic</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="STRING">&quot;PE\000\000&quot;</span><span class="EOL">
</span>          <span class="WITH">with</span> <span class="UIDENT">End_of_file</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-close_in"><span class="LIDENT">close_in</span></a> <a href="#local_c_252"><span class="LIDENT">c</span></a><span class="SEMI">;</span><span class="EOL">
</span>            <span class="FALSE">false</span> <span class="IN">in</span><span class="EOL">
</span>        <span class="IF">if</span> <a href="#local_is_pe_263"><span class="LIDENT">is_pe</span></a> <span class="THEN">then</span><span class="EOL">
</span>          <span class="TRY">try</span><span class="EOL">
</span>            <span class="LET">let</span> <span id="local_arch_265"><span class="LIDENT">arch</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>              <span class="COMMENT">(* NB It's not necessary to determine PE/PE+ headers for x64/x86 determination *)</span><span class="EOL">
</span>              <span class="MATCH">match</span> <a href="#local_input_short_little_259"><span class="LIDENT">input_short_little</span></a> <a href="#local_c_252"><span class="LIDENT">c</span></a> <span class="WITH">with</span><span class="EOL">
</span>                <span class="INT">0x8664</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>                  <span class="BACKQUOTE">`</span><span class="LIDENT">x86_64</span><span class="EOL">
</span>              <span class="BAR">|</span> <span class="INT">0x14c</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>                  <span class="BACKQUOTE">`</span><span class="LIDENT">x86</span><span class="EOL">
</span>              <span class="BAR">|</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>                  <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-raise"><span class="LIDENT">raise</span></a> <span class="UIDENT">End_of_file</span><span class="EOL">
</span>            <span class="IN">in</span><span class="EOL">
</span>            <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-really_input_string"><span class="LIDENT">really_input_string</span></a> <a href="#local_c_252"><span class="LIDENT">c</span></a> <span class="INT">14</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>            <span class="LET">let</span> <span id="local_size_of_opt_header_266"><span class="LIDENT">size_of_opt_header</span></span> <span class="EQUAL">=</span> <a href="#local_input_short_little_259"><span class="LIDENT">input_short_little</span></a> <a href="#local_c_252"><span class="LIDENT">c</span></a> <span class="IN">in</span><span class="EOL">
</span>            <span class="LET">let</span> <span id="local_characteristics_267"><span class="LIDENT">characteristics</span></span> <span class="EQUAL">=</span> <a href="#local_input_short_little_259"><span class="LIDENT">input_short_little</span></a> <a href="#local_c_252"><span class="LIDENT">c</span></a> <span class="IN">in</span><span class="EOL">
</span>            <span class="COMMENT">(* Executable images must have a PE &quot;optional&quot; header and be marked executable *)</span><span class="EOL">
</span>            <span class="COMMENT">(* Could also validate IMAGE_FILE_32BIT_MACHINE (0x100) for x86 and IMAGE_FILE_LARGE_ADDRESS_AWARE (0x20) for x64 *)</span><span class="EOL">
</span>            <span class="IF">if</span> <a href="#local_size_of_opt_header_266"><span class="LIDENT">size_of_opt_header</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;=)"><span class="INFIXOP0">&lt;=</span></a> <span class="INT">0</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <a href="#local_characteristics_267"><span class="LIDENT">characteristics</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(land)"><span class="INFIXOP3">land</span></a> <span class="INT">0x2</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="INT">0</span> <span class="THEN">then</span><span class="EOL">
</span>              <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-raise"><span class="LIDENT">raise</span></a> <span class="UIDENT">End_of_file</span><span class="SEMI">;</span><span class="EOL">
</span>            <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-close_in"><span class="LIDENT">close_in</span></a> <a href="#local_c_252"><span class="LIDENT">c</span></a><span class="SEMI">;</span><span class="EOL">
</span>            <span class="IF">if</span> <a href="#local_characteristics_267"><span class="LIDENT">characteristics</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(land)"><span class="INFIXOP3">land</span></a> <span class="INT">0x2000</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;&gt;)"><span class="INFIXOP0">&lt;&gt;</span></a> <span class="INT">0</span> <span class="THEN">then</span><span class="EOL">
</span>              <span class="BACKQUOTE">`</span><span class="UIDENT">Dll</span> <a href="#local_arch_265"><span class="LIDENT">arch</span></a><span class="EOL">
</span>            <span class="ELSE">else</span><span class="EOL">
</span>              <span class="BACKQUOTE">`</span><span class="UIDENT">Exe</span> <a href="#local_arch_265"><span class="LIDENT">arch</span></a><span class="EOL">
</span>          <span class="WITH">with</span> <span class="UIDENT">End_of_file</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-close_in"><span class="LIDENT">close_in</span></a> <a href="#local_c_252"><span class="LIDENT">c</span></a><span class="SEMI">;</span><span class="EOL">
</span>            <span class="BACKQUOTE">`</span><span class="UIDENT">Unknown</span><span class="EOL">
</span>        <span class="ELSE">else</span><span class="EOL">
</span>          <span class="BACKQUOTE">`</span><span class="UIDENT">Exe</span> <span class="BACKQUOTE">`</span><span class="LIDENT">i386</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-close_in"><span class="LIDENT">close_in</span></a> <a href="#local_c_252"><span class="LIDENT">c</span></a><span class="SEMI">;</span><span class="EOL">
</span>        <span class="BACKQUOTE">`</span><span class="UIDENT">Unknown</span><span class="EOL">
</span>  <span class="WITH">with</span> <span class="UIDENT">End_of_file</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-close_in"><span class="LIDENT">close_in</span></a> <a href="#local_c_252"><span class="LIDENT">c</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="BACKQUOTE">`</span><span class="UIDENT">Unknown</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-default_install_warning"><span class="LIDENT">default_install_warning</span></span> <span id="local_dst_268"><span class="LIDENT">dst</span></span> <span class="EQUAL">=</span> <span class="FUNCTION">function</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Add_exe</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="opamConsole.ml.html#val-warning"><span class="UIDENT">OpamConsole</span><span class="DOT">.</span><span class="LIDENT">warning</span></a> <span class="STRING">&quot;Automatically adding .exe to %s&quot;</span> <a href="#local_dst_268"><span class="LIDENT">dst</span></a><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Install_dll</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="COMMENT">(* TODO Installation of .dll to bin is unfortunate, but not sure if it
       should be a warning *)</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Install_script</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="COMMENT">(* TODO Generate a .cmd wrapper (and warn about it - they're not perfect) *)</span><span class="EOL">
</span>    <a href="opamConsole.ml.html#val-warning"><span class="UIDENT">OpamConsole</span><span class="DOT">.</span><span class="LIDENT">warning</span></a> <span class="STRING">&quot;%s is a script; the command won't be available&quot;</span> <a href="#local_dst_268"><span class="LIDENT">dst</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Install_unknown</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="COMMENT">(* TODO Installation of a non-executable file is unexpected, but not sure
       if it should be a warning/error *)</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Cygwin</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="opamConsole.ml.html#val-warning"><span class="UIDENT">OpamConsole</span><span class="DOT">.</span><span class="LIDENT">warning</span></a> <span class="STRING">&quot;%s is a Cygwin-linked executable&quot;</span> <a href="#local_dst_268"><span class="LIDENT">dst</span></a><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Msys2</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="opamConsole.ml.html#val-warning"><span class="UIDENT">OpamConsole</span><span class="DOT">.</span><span class="LIDENT">warning</span></a> <span class="STRING">&quot;%s is a MSYS2-linked executable&quot;</span> <a href="#local_dst_268"><span class="LIDENT">dst</span></a><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Tainted</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Cygwin</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="opamConsole.ml.html#val-warning"><span class="UIDENT">OpamConsole</span><span class="DOT">.</span><span class="LIDENT">warning</span></a><span class="EOL">
</span>      <span class="STRING">&quot;%s is an executable which links to a Cygwin-linked library&quot;</span> <a href="#local_dst_268"><span class="LIDENT">dst</span></a><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Tainted</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Msys2</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="opamConsole.ml.html#val-warning"><span class="UIDENT">OpamConsole</span><span class="DOT">.</span><span class="LIDENT">warning</span></a><span class="EOL">
</span>      <span class="STRING">&quot;%s is an executable which links to a MSYS2-linked library&quot;</span> <a href="#local_dst_268"><span class="LIDENT">dst</span></a><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Cygwin_libraries</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="opamConsole.ml.html#val-warning"><span class="UIDENT">OpamConsole</span><span class="DOT">.</span><span class="LIDENT">warning</span></a><span class="EOL">
</span>      <span class="STRING">&quot;%s links with a Cygwin-compiled DLL (almost certainly a packaging \
       or environment error)&quot;</span> <a href="#local_dst_268"><span class="LIDENT">dst</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-install"><span class="LIDENT">install</span></span> <span class="QUESTION">?</span><span class="LPAREN">(</span><span id="local_warning_269"><span class="LIDENT">warning</span></span><span class="EQUAL">=</span><span class="LIDENT">default_install_warning</span><span class="RPAREN">)</span> <span class="QUESTION">?</span><span id="local_exec_270"><span class="LIDENT">exec</span></span> <span id="local_src_271"><span class="LIDENT">src</span></span> <span id="local_dst_272"><span class="LIDENT">dst</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-is_directory"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">is_directory</span></a> <a href="#local_src_271"><span class="LIDENT">src</span></a> <span class="THEN">then</span><span class="EOL">
</span>    <span class="LIDENT">internal_error</span> <span class="STRING">&quot;Cannot install %s: it is a directory.&quot;</span> <a href="#local_src_271"><span class="LIDENT">src</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="IF">if</span> <span class="LPAREN">(</span><span class="TRY">try</span> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-is_directory"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">is_directory</span></a> <a href="#local_dst_272"><span class="LIDENT">dst</span></a> <span class="WITH">with</span> <span class="UIDENT">Sys_error</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="FALSE">false</span><span class="RPAREN">)</span> <span class="THEN">then</span><span class="EOL">
</span>    <span class="LIDENT">internal_error</span> <span class="STRING">&quot;Cannot install to %s: it is a directory.&quot;</span> <a href="#local_dst_272"><span class="LIDENT">dst</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="LIDENT">mkdir</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#module-Sysdeps"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">dirname</span></a> <a href="#local_dst_272"><span class="LIDENT">dst</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_exec_273"><span class="LIDENT">exec</span></span> <span class="EQUAL">=</span> <span class="MATCH">match</span> <a href="#local_exec_270"><span class="LIDENT">exec</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_e_274"><span class="LIDENT">e</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_e_274"><span class="LIDENT">e</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">is_exec</span> <a href="#local_src_271"><span class="LIDENT">src</span></a> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_perm_275"><span class="LIDENT">perm</span></span> <span class="EQUAL">=</span> <span class="IF">if</span> <a href="#local_exec_273"><span class="LIDENT">exec</span></a> <span class="THEN">then</span> <span class="INT">0o755</span> <span class="ELSE">else</span> <span class="INT">0o644</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LIDENT">log</span> <span class="STRING">&quot;install %s -&gt; %s (%o)&quot;</span> <a href="#local_src_271"><span class="LIDENT">src</span></a> <a href="#local_dst_272"><span class="LIDENT">dst</span></a> <a href="#local_perm_275"><span class="LIDENT">perm</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-win32"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">win32</span></a> <span class="THEN">then</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_exec_273"><span class="LIDENT">exec</span></a> <span class="THEN">then</span> <span class="BEGIN">begin</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="def_539"><span class="LPAREN">(</span><span id="local_dst_276"><span class="LIDENT">dst</span></span><span class="COMMA">,</span> <span id="local_cygcheck_277"><span class="LIDENT">cygcheck</span></span><span class="RPAREN">)</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>        <span class="MATCH">match</span> <span class="LIDENT">classify_executable</span> <a href="#local_src_271"><span class="LIDENT">src</span></a> <span class="WITH">with</span><span class="EOL">
</span>          <span class="BACKQUOTE">`</span><span class="UIDENT">Exe</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-not"><span class="LIDENT">not</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#module-Sysdeps"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">check_suffix</span></a> <a href="#local_dst_272"><span class="LIDENT">dst</span></a> <span class="STRING">&quot;.exe&quot;</span><span class="RPAREN">)</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&amp;&amp;)"><span class="AMPERAMPER">&amp;&amp;</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-not"><span class="LIDENT">not</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#module-Sysdeps"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">check_suffix</span></a> <a href="#local_dst_272"><span class="LIDENT">dst</span></a> <span class="STRING">&quot;.dll&quot;</span><span class="RPAREN">)</span> <span class="THEN">then</span> <span class="BEGIN">begin</span><span class="EOL">
</span>              <a href="#local_warning_269"><span class="LIDENT">warning</span></a> <a href="#local_dst_272"><span class="LIDENT">dst</span></a> <span class="BACKQUOTE">`</span><span class="UIDENT">Add_exe</span><span class="SEMI">;</span><span class="EOL">
</span>              <span class="LPAREN">(</span><a href="#local_dst_272"><span class="LIDENT">dst</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(^)"><span class="INFIXOP1">^</span></a> <span class="STRING">&quot;.exe&quot;</span><span class="COMMA">,</span> <span class="TRUE">true</span><span class="RPAREN">)</span><span class="EOL">
</span>            <span class="END">end</span> <span class="ELSE">else</span><span class="EOL">
</span>              <span class="LPAREN">(</span><a href="#local_dst_272"><span class="LIDENT">dst</span></a><span class="COMMA">,</span> <span class="TRUE">true</span><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Dll</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <a href="#local_warning_269"><span class="LIDENT">warning</span></a> <a href="#local_dst_272"><span class="LIDENT">dst</span></a> <span class="BACKQUOTE">`</span><span class="UIDENT">Install_dll</span><span class="SEMI">;</span><span class="EOL">
</span>            <span class="LPAREN">(</span><a href="#local_dst_272"><span class="LIDENT">dst</span></a><span class="COMMA">,</span> <span class="TRUE">true</span><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Script</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <a href="#local_warning_269"><span class="LIDENT">warning</span></a> <a href="#local_dst_272"><span class="LIDENT">dst</span></a> <span class="BACKQUOTE">`</span><span class="UIDENT">Install_script</span><span class="SEMI">;</span><span class="EOL">
</span>            <span class="LPAREN">(</span><a href="#local_dst_272"><span class="LIDENT">dst</span></a><span class="COMMA">,</span> <span class="FALSE">false</span><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Unknown</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <a href="#local_warning_269"><span class="LIDENT">warning</span></a> <a href="#local_dst_272"><span class="LIDENT">dst</span></a> <span class="BACKQUOTE">`</span><span class="UIDENT">Install_unknown</span><span class="SEMI">;</span><span class="EOL">
</span>            <span class="LPAREN">(</span><a href="#local_dst_272"><span class="LIDENT">dst</span></a><span class="COMMA">,</span> <span class="FALSE">false</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="IN">in</span><span class="EOL">
</span>      <span class="LIDENT">copy_file_aux</span> <span class="TILDE">~</span><a href="#local_src_271"><span class="LIDENT">src</span></a> <span class="TILDE">~</span><a href="#local_dst_276"><span class="LIDENT">dst</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>      <span class="IF">if</span> <a href="#local_cygcheck_277"><span class="LIDENT">cygcheck</span></a> <span class="THEN">then</span><span class="EOL">
</span>        <span class="MATCH">match</span> <a href="opamStd.ml.html#module-OpamSys.val-get_windows_executable_variant"><span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">get_windows_executable_variant</span></a><span class="EOL">
</span>                <span class="OPTLABEL">?search_in_first:</span><a href="opamCoreConfig.ml.html"><span class="UIDENT">OpamCoreConfig</span></a><span class="DOT">.</span><span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="opamCoreConfig.ml.html#val-r"><span class="LIDENT">r</span></a><span class="DOT">.</span><span class="LIDENT">cygbin</span><span class="RPAREN">)</span> <a href="#local_dst_276"><span class="LIDENT">dst</span></a> <span class="WITH">with</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Native</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="LPAREN">(</span><span class="BACKQUOTE">`</span><span class="UIDENT">Cygwin</span> <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Msys2</span> <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Tainted</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="AS">as</span> <span id="local_code_278"><span class="LIDENT">code</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_warning_269"><span class="LIDENT">warning</span></a> <a href="#local_dst_276"><span class="LIDENT">dst</span></a> <a href="#local_code_278"><span class="LIDENT">code</span></a><span class="EOL">
</span>    <span class="END">end</span> <span class="ELSE">else</span><span class="EOL">
</span>      <span class="LIDENT">copy_file_aux</span> <span class="TILDE">~</span><a href="#local_src_271"><span class="LIDENT">src</span></a> <span class="TILDE">~</span><a href="#local_dst_272"><span class="LIDENT">dst</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="ELSE">else</span><span class="EOL">
</span>    <span class="LIDENT">copy_file_aux</span> <span class="LABEL">~chmod:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_perm_275"><span class="LIDENT">perm</span></a><span class="RPAREN">)</span> <span class="TILDE">~</span><a href="#local_src_271"><span class="LIDENT">src</span></a> <span class="TILDE">~</span><a href="#local_dst_272"><span class="LIDENT">dst</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-cpu_count"><span class="LIDENT">cpu_count</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="TRY">try</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_ans_279"><span class="LIDENT">ans</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LET">let</span> <span class="OPEN">open</span> <a href="opamStd.ml.html"><span class="UIDENT">OpamStd</span></a> <span class="IN">in</span><span class="EOL">
</span>      <span class="MATCH">match</span> <a href="opamStd.ml.html#module-OpamSys.val-os"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">os</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Sys</span><span class="DOT">.</span><span class="UIDENT">Win32</span> <span class="MINUSGREATER">-&gt;</span> <span class="LBRACKET">[</span><a href="opamStd.ml.html#module-Env.val-get"><span class="UIDENT">Env</span><span class="DOT">.</span><span class="LIDENT">get</span></a> <span class="STRING">&quot;NUMBER_OF_PROCESSORS&quot;</span><span class="RBRACKET">]</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Sys</span><span class="DOT">.</span><span class="UIDENT">FreeBSD</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">read_command_output</span> <span class="LABEL">~verbose:</span><span class="LPAREN">(</span><span class="LIDENT">verbose_for_base_commands</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>                         <span class="LBRACKET">[</span><span class="STRING">&quot;sysctl&quot;</span><span class="SEMI">;</span> <span class="STRING">&quot;-n&quot;</span><span class="SEMI">;</span> <span class="STRING">&quot;hw.ncpu&quot;</span><span class="RBRACKET">]</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">read_command_output</span> <span class="LABEL">~verbose:</span><span class="LPAREN">(</span><span class="LIDENT">verbose_for_base_commands</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>               <span class="LBRACKET">[</span><span class="STRING">&quot;getconf&quot;</span><span class="SEMI">;</span> <span class="STRING">&quot;_NPROCESSORS_ONLN&quot;</span><span class="RBRACKET">]</span><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-int_of_string"><span class="LIDENT">int_of_string</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-hd"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">hd</span></a> <a href="#local_ans_279"><span class="LIDENT">ans</span></a><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="WITH">with</span> <span class="UIDENT">Not_found</span> <span class="BAR">|</span> <span class="UIDENT">Process_error</span> <span class="UNDERSCORE">_</span> <span class="BAR">|</span> <span class="UIDENT">Failure</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="INT">1</span><span class="EOL">
</span><span class="EOL">
</span><span class="OPEN">open</span> <a href="opamProcess.ml.html#module-Job.module-Op"><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="UIDENT">Job</span><span class="DOT">.</span><span class="UIDENT">Op</span></a><span class="EOL">
</span><span class="EOL">
</span><span id="module-Tar"><span class="MODULE">module</span> <span class="UIDENT">Tar</span> <span class="EQUAL">=</span> <span class="STRUCT">struct</span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Tar.type-extract"><span class="TYPE">type</span> <span class="LIDENT">extract</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span id="module-Tar.type-extract.constructor-Bzip2"><span class="BAR">|</span> <span class="UIDENT">Bzip2</span></span><span class="EOL">
</span>    <span id="module-Tar.type-extract.constructor-Gzip"><span class="BAR">|</span> <span class="UIDENT">Gzip</span></span><span class="EOL">
</span>    <span id="module-Tar.type-extract.constructor-Lzma"><span class="BAR">|</span> <span class="UIDENT">Lzma</span></span><span class="EOL">
</span>    <span id="module-Tar.type-extract.constructor-Xz"><span class="BAR">|</span> <span class="UIDENT">Xz</span></span></span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Tar.val-{extract_command}1/shadowed/(opam-core-src-opam-core-opamSystem.ml)"><span class="LIDENT">extract_command</span></span> <span class="EQUAL">=</span> <span class="FUNCTION">function</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Bzip2</span> <span class="MINUSGREATER">-&gt;</span> <span class="STRING">&quot;bzip2&quot;</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Gzip</span> <span class="MINUSGREATER">-&gt;</span> <span class="STRING">&quot;gzip&quot;</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Lzma</span> <span class="MINUSGREATER">-&gt;</span> <span class="STRING">&quot;lzma&quot;</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Xz</span> <span class="MINUSGREATER">-&gt;</span> <span class="STRING">&quot;xz&quot;</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Tar.val-extract_option"><span class="LIDENT">extract_option</span></span> <span class="EQUAL">=</span> <span class="FUNCTION">function</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Bzip2</span> <span class="MINUSGREATER">-&gt;</span> <span class="CHAR">'j'</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Gzip</span> <span class="MINUSGREATER">-&gt;</span> <span class="CHAR">'z'</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Lzma</span> <span class="MINUSGREATER">-&gt;</span> <span class="CHAR">'Y'</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Xz</span> <span class="MINUSGREATER">-&gt;</span> <span class="CHAR">'J'</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Tar.val-extensions"><span class="LIDENT">extensions</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LBRACKET">[</span> <span class="LBRACKET">[</span> <span class="STRING">&quot;tar.gz&quot;</span> <span class="SEMI">;</span> <span class="STRING">&quot;tgz&quot;</span> <span class="RBRACKET">]</span><span class="COMMA">,</span> <span class="UIDENT">Gzip</span><span class="EOL">
</span>    <span class="SEMI">;</span> <span class="LBRACKET">[</span> <span class="STRING">&quot;tar.bz2&quot;</span> <span class="SEMI">;</span> <span class="STRING">&quot;tbz&quot;</span> <span class="RBRACKET">]</span><span class="COMMA">,</span> <span class="UIDENT">Bzip2</span><span class="EOL">
</span>    <span class="SEMI">;</span> <span class="LBRACKET">[</span> <span class="STRING">&quot;tar.xz&quot;</span> <span class="SEMI">;</span> <span class="STRING">&quot;txz&quot;</span> <span class="RBRACKET">]</span><span class="COMMA">,</span> <span class="UIDENT">Xz</span><span class="EOL">
</span>    <span class="SEMI">;</span> <span class="LBRACKET">[</span> <span class="STRING">&quot;tar.lzma&quot;</span> <span class="SEMI">;</span> <span class="STRING">&quot;tlz&quot;</span> <span class="RBRACKET">]</span><span class="COMMA">,</span> <span class="UIDENT">Lzma</span><span class="EOL">
</span>    <span class="RBRACKET">]</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Tar.val-guess_type"><span class="LIDENT">guess_type</span></span> <span id="local_f_280"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="TRY">try</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_ic_281"><span class="LIDENT">ic</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-open_in"><span class="LIDENT">open_in</span></a> <a href="#local_f_280"><span class="LIDENT">f</span></a> <span class="IN">in</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_c1_282"><span class="LIDENT">c1</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-input_char"><span class="LIDENT">input_char</span></a> <a href="#local_ic_281"><span class="LIDENT">ic</span></a> <span class="IN">in</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_c2_283"><span class="LIDENT">c2</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-input_char"><span class="LIDENT">input_char</span></a> <a href="#local_ic_281"><span class="LIDENT">ic</span></a> <span class="IN">in</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-close_in"><span class="LIDENT">close_in</span></a> <a href="#local_ic_281"><span class="LIDENT">ic</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <span class="MATCH">match</span> <a href="#local_c1_282"><span class="LIDENT">c1</span></a><span class="COMMA">,</span> <a href="#local_c2_283"><span class="LIDENT">c2</span></a> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="CHAR">'\031'</span><span class="COMMA">,</span> <span class="CHAR">'\139'</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Some</span> <span class="UIDENT">Gzip</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="CHAR">'B'</span>   <span class="COMMA">,</span> <span class="CHAR">'Z'</span>    <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Some</span> <span class="UIDENT">Bzip2</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="CHAR">'\xfd'</span><span class="COMMA">,</span> <span class="CHAR">'\x37'</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Some</span> <span class="UIDENT">Xz</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="CHAR">'\x5d'</span><span class="COMMA">,</span> <span class="CHAR">'\x00'</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Some</span> <span class="UIDENT">Lzma</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UNDERSCORE">_</span>              <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">None</span><span class="EOL">
</span>    <span class="WITH">with</span> <span class="UIDENT">Sys_error</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">None</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Tar.val-match_ext"><span class="LIDENT">match_ext</span></span> <span id="local_file_284"><span class="LIDENT">file</span></span> <span id="local_ext_285"><span class="LIDENT">ext</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-exists"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">exists</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#module-Sysdeps"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">check_suffix</span></a> <a href="#local_file_284"><span class="LIDENT">file</span></a><span class="RPAREN">)</span> <a href="#local_ext_285"><span class="LIDENT">ext</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Tar.val-get_type"><span class="LIDENT">get_type</span></span> <span id="local_file_286"><span class="LIDENT">file</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_ext_287"><span class="LIDENT">ext</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-fold_left"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">fold_left</span></a><span class="EOL">
</span>        <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_acc_288"><span class="LIDENT">acc</span></span> <span class="LPAREN">(</span><span id="local_ext_289"><span class="LIDENT">ext</span></span><span class="COMMA">,</span> <span id="local_t_290"><span class="LIDENT">t</span></span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="MATCH">match</span> <a href="#local_acc_288"><span class="LIDENT">acc</span></a> <span class="WITH">with</span><span class="EOL">
</span>           <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_t_291"><span class="LIDENT">t</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Some</span> <a href="#local_t_291"><span class="LIDENT">t</span></a><span class="EOL">
</span>           <span class="BAR">|</span> <span class="UIDENT">None</span>   <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>             <span class="IF">if</span> <span class="LIDENT">match_ext</span> <a href="#local_file_286"><span class="LIDENT">file</span></a> <a href="#local_ext_289"><span class="LIDENT">ext</span></a><span class="EOL">
</span>             <span class="THEN">then</span> <span class="UIDENT">Some</span> <a href="#local_t_290"><span class="LIDENT">t</span></a><span class="EOL">
</span>             <span class="ELSE">else</span> <span class="UIDENT">None</span><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="UIDENT">None</span><span class="EOL">
</span>        <span class="LIDENT">extensions</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-file_exists"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">file_exists</span></a> <a href="#local_file_286"><span class="LIDENT">file</span></a> <span class="THEN">then</span> <span class="LIDENT">guess_type</span> <a href="#local_file_286"><span class="LIDENT">file</span></a><span class="EOL">
</span>    <span class="ELSE">else</span> <a href="#local_ext_287"><span class="LIDENT">ext</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Tar.val-is_archive"><span class="LIDENT">is_archive</span></span> <span id="local_file_292"><span class="LIDENT">file</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">get_type</span> <a href="#local_file_292"><span class="LIDENT">file</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;&gt;)"><span class="INFIXOP0">&lt;&gt;</span></a> <span class="UIDENT">None</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Tar.val-check_extract"><span class="LIDENT">check_extract</span></span> <span id="local_file_293"><span class="LIDENT">file</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <a href="opamStd.ml.html#module-Option.module-Op"><span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">Option</span><span class="DOT">.</span><span class="UIDENT">Op</span></a><span class="DOT">.</span><span class="LPAREN">(</span><span class="EOL">
</span>      <span class="LIDENT">get_type</span> <a href="#local_file_293"><span class="LIDENT">file</span></a> <a href="opamStd.ml.html#module-Option.module-Op.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span id="local_typ_294"><span class="LIDENT">typ</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_cmd_295"><span class="LIDENT">cmd</span></span> <span class="EQUAL">=</span> <span class="LIDENT">extract_command</span> <a href="#local_typ_294"><span class="LIDENT">typ</span></a> <span class="IN">in</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_res_296"><span class="LIDENT">res</span></span> <span class="EQUAL">=</span> <span class="LIDENT">resolve_command</span> <a href="#local_cmd_295"><span class="LIDENT">cmd</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;&gt;)"><span class="INFIXOP0">&lt;&gt;</span></a> <span class="UIDENT">None</span> <span class="IN">in</span><span class="EOL">
</span>      <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-not"><span class="LIDENT">not</span></a> <a href="#local_res_296"><span class="LIDENT">res</span></a> <span class="THEN">then</span><span class="EOL">
</span>        <span class="UIDENT">Some</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/printf.ml.html#val-sprintf"><span class="UIDENT">Printf</span><span class="DOT">.</span><span class="LIDENT">sprintf</span></a> <span class="STRING">&quot;Tar needs %s to extract the archive&quot;</span> <a href="#local_cmd_295"><span class="LIDENT">cmd</span></a><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="ELSE">else</span> <span class="UIDENT">None</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Tar.val-tar_cmd"><span class="LIDENT">tar_cmd</span></span> <span class="EQUAL">=</span> <span class="LAZY">lazy</span> <span class="LPAREN">(</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="opamStd.ml.html#module-OpamSys.val-os"><span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">os</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="UIDENT">OpenBSD</span> <span class="MINUSGREATER">-&gt;</span> <span class="STRING">&quot;gtar&quot;</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="STRING">&quot;tar&quot;</span><span class="EOL">
</span>  <span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Tar.val-cygpath_tar"><span class="LIDENT">cygpath_tar</span></span> <span class="EQUAL">=</span> <span class="LAZY">lazy</span> <span class="LPAREN">(</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/lazy.ml.html#val-force"><span class="UIDENT">Lazy</span><span class="DOT">.</span><span class="LIDENT">force</span></a> <span class="LPAREN">(</span><span class="LIDENT">get_cygpath_function</span> <span class="LABEL">~command:</span><span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/lazy.ml.html#val-force"><span class="UIDENT">Lazy</span><span class="DOT">.</span><span class="LIDENT">force</span></a> <span class="LIDENT">tar_cmd</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Tar.val-extract_command"><span class="LIDENT">extract_command</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="FUN">fun</span> <span id="local_file_297"><span class="LIDENT">file</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="opamStd.ml.html#module-Option.module-Op"><span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">Option</span><span class="DOT">.</span><span class="UIDENT">Op</span></a><span class="DOT">.</span><span class="LPAREN">(</span><span class="EOL">
</span>        <span class="LIDENT">get_type</span> <a href="#local_file_297"><span class="LIDENT">file</span></a> <a href="opamStd.ml.html#module-Option.module-Op.val-(&gt;&gt;|)"><span class="INFIXOP0">&gt;&gt;|</span></a> <span class="FUN">fun</span> <span id="local_typ_298"><span class="LIDENT">typ</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_f_299"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/lazy.ml.html#val-force"><span class="UIDENT">Lazy</span><span class="DOT">.</span><span class="LIDENT">force</span></a> <span class="LIDENT">cygpath_tar</span> <span class="IN">in</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_tar_cmd_300"><span class="LIDENT">tar_cmd</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/lazy.ml.html#val-force"><span class="UIDENT">Lazy</span><span class="DOT">.</span><span class="LIDENT">force</span></a> <span class="LIDENT">tar_cmd</span> <span class="IN">in</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_command_301"><span class="LIDENT">command</span></span> <span id="local_c_302"><span class="LIDENT">c</span></span> <span id="local_dir_303"><span class="LIDENT">dir</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>          <span class="LIDENT">make_command</span> <a href="#local_tar_cmd_300"><span class="LIDENT">tar_cmd</span></a> <span class="LBRACKET">[</span> <a href="../../../ocaml-base-compiler/src/stdlib/printf.ml.html#val-sprintf"><span class="UIDENT">Printf</span><span class="DOT">.</span><span class="LIDENT">sprintf</span></a> <span class="STRING">&quot;xf%c&quot;</span> <a href="#local_c_302"><span class="LIDENT">c</span></a> <span class="SEMI">;</span> <a href="#local_f_299"><span class="LIDENT">f</span></a> <a href="#local_file_297"><span class="LIDENT">file</span></a><span class="SEMI">;</span> <span class="STRING">&quot;-C&quot;</span> <span class="SEMI">;</span> <a href="#local_f_299"><span class="LIDENT">f</span></a> <a href="#local_dir_303"><span class="LIDENT">dir</span></a> <span class="RBRACKET">]</span><span class="EOL">
</span>        <span class="IN">in</span><span class="EOL">
</span>        <a href="#local_command_301"><span class="LIDENT">command</span></a> <span class="LPAREN">(</span><span class="LIDENT">extract_option</span> <a href="#local_typ_298"><span class="LIDENT">typ</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Tar.val-compress_command"><span class="LIDENT">compress_command</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="FUN">fun</span> <span id="local_file_304"><span class="LIDENT">file</span></span> <span id="local_dir_305"><span class="LIDENT">dir</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_f_306"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/lazy.ml.html#val-force"><span class="UIDENT">Lazy</span><span class="DOT">.</span><span class="LIDENT">force</span></a> <span class="LIDENT">cygpath_tar</span> <span class="IN">in</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_tar_cmd_307"><span class="LIDENT">tar_cmd</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/lazy.ml.html#val-force"><span class="UIDENT">Lazy</span><span class="DOT">.</span><span class="LIDENT">force</span></a> <span class="LIDENT">tar_cmd</span> <span class="IN">in</span><span class="EOL">
</span>      <span class="LIDENT">make_command</span> <a href="#local_tar_cmd_307"><span class="LIDENT">tar_cmd</span></a> <span class="LBRACKET">[</span><span class="EOL">
</span>        <span class="STRING">&quot;cfz&quot;</span><span class="SEMI">;</span> <a href="#local_f_306"><span class="LIDENT">f</span></a> <a href="#local_file_304"><span class="LIDENT">file</span></a><span class="SEMI">;</span><span class="EOL">
</span>        <span class="STRING">&quot;-C&quot;</span> <span class="SEMI">;</span> <a href="#local_f_306"><span class="LIDENT">f</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#module-Sysdeps"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">dirname</span></a> <a href="#local_dir_305"><span class="LIDENT">dir</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>        <a href="#local_f_306"><span class="LIDENT">f</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#module-Sysdeps"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">basename</span></a> <a href="#local_dir_305"><span class="LIDENT">dir</span></a><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="RBRACKET">]</span><span class="EOL">
</span><span class="EOL">
</span><span class="END">end</span></span><span class="EOL">
</span><span class="EOL">
</span><span id="module-Zip"><span class="MODULE">module</span> <span class="UIDENT">Zip</span> <span class="EQUAL">=</span> <span class="STRUCT">struct</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Zip.val-is_archive"><span class="LIDENT">is_archive</span></span> <span id="local_f_308"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-file_exists"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">file_exists</span></a> <a href="#local_f_308"><span class="LIDENT">f</span></a> <span class="THEN">then</span><span class="EOL">
</span>      <span class="TRY">try</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_ic_309"><span class="LIDENT">ic</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-open_in"><span class="LIDENT">open_in</span></a> <a href="#local_f_308"><span class="LIDENT">f</span></a> <span class="IN">in</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_c1_310"><span class="LIDENT">c1</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-input_char"><span class="LIDENT">input_char</span></a> <a href="#local_ic_309"><span class="LIDENT">ic</span></a> <span class="IN">in</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_c2_311"><span class="LIDENT">c2</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-input_char"><span class="LIDENT">input_char</span></a> <a href="#local_ic_309"><span class="LIDENT">ic</span></a> <span class="IN">in</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_c3_312"><span class="LIDENT">c3</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-input_char"><span class="LIDENT">input_char</span></a> <a href="#local_ic_309"><span class="LIDENT">ic</span></a> <span class="IN">in</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_c4_313"><span class="LIDENT">c4</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-input_char"><span class="LIDENT">input_char</span></a> <a href="#local_ic_309"><span class="LIDENT">ic</span></a> <span class="IN">in</span><span class="EOL">
</span>        <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-close_in"><span class="LIDENT">close_in</span></a> <a href="#local_ic_309"><span class="LIDENT">ic</span></a><span class="SEMI">;</span><span class="EOL">
</span>        <span class="MATCH">match</span> <a href="#local_c1_310"><span class="LIDENT">c1</span></a><span class="COMMA">,</span> <a href="#local_c2_311"><span class="LIDENT">c2</span></a><span class="COMMA">,</span> <a href="#local_c3_312"><span class="LIDENT">c3</span></a><span class="COMMA">,</span> <a href="#local_c4_313"><span class="LIDENT">c4</span></a> <span class="WITH">with</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="CHAR">'\x50'</span><span class="COMMA">,</span> <span class="CHAR">'\x4b'</span><span class="COMMA">,</span> <span class="CHAR">'\x03'</span><span class="COMMA">,</span> <span class="CHAR">'\x04'</span> <span class="MINUSGREATER">-&gt;</span> <span class="TRUE">true</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="FALSE">false</span><span class="EOL">
</span>      <span class="WITH">with</span> <span class="UIDENT">Sys_error</span> <span class="UNDERSCORE">_</span> <span class="BAR">|</span> <span class="UIDENT">End_of_file</span> <span class="MINUSGREATER">-&gt;</span> <span class="FALSE">false</span><span class="EOL">
</span>    <span class="ELSE">else</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#module-Sysdeps"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">check_suffix</span></a> <a href="#local_f_308"><span class="LIDENT">f</span></a> <span class="STRING">&quot;zip&quot;</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Zip.val-extract_command"><span class="LIDENT">extract_command</span></span> <span id="local_file_314"><span class="LIDENT">file</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="UIDENT">Some</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_dir_315"><span class="LIDENT">dir</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">make_command</span> <span class="STRING">&quot;unzip&quot;</span> <span class="LBRACKET">[</span> <a href="#local_file_314"><span class="LIDENT">file</span></a><span class="SEMI">;</span> <span class="STRING">&quot;-d&quot;</span><span class="SEMI">;</span> <a href="#local_dir_315"><span class="LIDENT">dir</span></a> <span class="RBRACKET">]</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="END">end</span></span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-is_archive"><span class="LIDENT">is_archive</span></span> <span id="local_file_316"><span class="LIDENT">file</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="UIDENT">Tar</span><span class="DOT">.</span><span class="LIDENT">is_archive</span> <a href="#local_file_316"><span class="LIDENT">file</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <span class="UIDENT">Zip</span><span class="DOT">.</span><span class="LIDENT">is_archive</span> <a href="#local_file_316"><span class="LIDENT">file</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-extract_command"><span class="LIDENT">extract_command</span></span> <span id="local_file_317"><span class="LIDENT">file</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="IF">if</span> <span class="UIDENT">Zip</span><span class="DOT">.</span><span class="LIDENT">is_archive</span> <a href="#local_file_317"><span class="LIDENT">file</span></a> <span class="THEN">then</span> <span class="UIDENT">Zip</span><span class="DOT">.</span><span class="LIDENT">extract_command</span> <a href="#local_file_317"><span class="LIDENT">file</span></a><span class="EOL">
</span>  <span class="ELSE">else</span> <span class="UIDENT">Tar</span><span class="DOT">.</span><span class="LIDENT">extract_command</span> <a href="#local_file_317"><span class="LIDENT">file</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-make_tar_gz_job"><span class="LIDENT">make_tar_gz_job</span></span> <span class="TILDE">~</span><span id="local_dir_318"><span class="LIDENT">dir</span></span> <span id="local_file_319"><span class="LIDENT">file</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_tmpfile_320"><span class="LIDENT">tmpfile</span></span> <span class="EQUAL">=</span> <a href="#local_file_319"><span class="LIDENT">file</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(^)"><span class="INFIXOP1">^</span></a> <span class="STRING">&quot;.tmp&quot;</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LIDENT">remove_file</span> <a href="#local_tmpfile_320"><span class="LIDENT">tmpfile</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="UIDENT">Tar</span><span class="DOT">.</span><span class="LIDENT">compress_command</span> <a href="#local_tmpfile_320"><span class="LIDENT">tmpfile</span></a> <a href="#local_dir_318"><span class="LIDENT">dir</span></a> <a href="opamProcess.ml.html#module-Job.module-Op.val-(@@&gt;)"><span class="INFIXOP1">@@&gt;</span></a> <span class="FUN">fun</span> <span id="local_r_321"><span class="LIDENT">r</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>  <a href="opamProcess.ml.html#val-cleanup"><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="LIDENT">cleanup</span></a> <a href="#local_r_321"><span class="LIDENT">r</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="opamProcess.ml.html#val-is_success"><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="LIDENT">is_success</span></a> <a href="#local_r_321"><span class="LIDENT">r</span></a> <span class="THEN">then</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="LIDENT">mv</span> <a href="#local_tmpfile_320"><span class="LIDENT">tmpfile</span></a> <a href="#local_file_319"><span class="LIDENT">file</span></a><span class="SEMI">;</span> <span class="UIDENT">Done</span> <span class="UIDENT">None</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="ELSE">else</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="LIDENT">remove_file</span> <a href="#local_tmpfile_320"><span class="LIDENT">tmpfile</span></a><span class="SEMI">;</span> <span class="UIDENT">Done</span> <span class="LPAREN">(</span><span class="UIDENT">Some</span> <span class="LPAREN">(</span><span class="UIDENT">Process_error</span> <a href="#local_r_321"><span class="LIDENT">r</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-extract_job"><span class="LIDENT">extract_job</span></span> <span class="TILDE">~</span><span id="local_dir_322"><span class="LIDENT">dir</span></span> <span id="local_file_323"><span class="LIDENT">file</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-not"><span class="LIDENT">not</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-file_exists"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">file_exists</span></a> <a href="#local_file_323"><span class="LIDENT">file</span></a><span class="RPAREN">)</span> <span class="THEN">then</span><span class="EOL">
</span>    <span class="UIDENT">Done</span> <span class="LPAREN">(</span><span class="UIDENT">Some</span> <span class="LPAREN">(</span><span class="UIDENT">File_not_found</span> <a href="#local_file_323"><span class="LIDENT">file</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="ELSE">else</span><span class="EOL">
</span>  <span class="LIDENT">with_tmp_dir_job</span> <span class="INFIXOP1">@@</span> <span class="FUN">fun</span> <span id="local_tmp_dir_324"><span class="LIDENT">tmp_dir</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>  <span class="MATCH">match</span> <span class="LIDENT">extract_command</span> <a href="#local_file_323"><span class="LIDENT">file</span></a> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">None</span>   <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="UIDENT">Done</span> <span class="LPAREN">(</span><span class="UIDENT">Some</span> <span class="LPAREN">(</span><span class="UIDENT">Failure</span> <span class="LPAREN">(</span><span class="STRING">&quot;Unknown archive type: &quot;</span><a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(^)"><span class="INFIXOP1">^</span></a><a href="#local_file_323"><span class="LIDENT">file</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_cmd_325"><span class="LIDENT">cmd</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="#local_cmd_325"><span class="LIDENT">cmd</span></a> <a href="#local_tmp_dir_324"><span class="LIDENT">tmp_dir</span></a> <a href="opamProcess.ml.html#module-Job.module-Op.val-(@@&gt;)"><span class="INFIXOP1">@@&gt;</span></a> <span class="FUN">fun</span> <span id="local_r_326"><span class="LIDENT">r</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-not"><span class="LIDENT">not</span></a> <span class="LPAREN">(</span><a href="opamProcess.ml.html#val-is_success"><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="LIDENT">is_success</span></a> <a href="#local_r_326"><span class="LIDENT">r</span></a><span class="RPAREN">)</span> <span class="THEN">then</span><span class="EOL">
</span>      <span class="IF">if</span> <span class="UIDENT">Zip</span><span class="DOT">.</span><span class="LIDENT">is_archive</span> <a href="#local_file_323"><span class="LIDENT">file</span></a> <span class="THEN">then</span><span class="EOL">
</span>        <span class="UIDENT">Done</span> <span class="LPAREN">(</span><span class="UIDENT">Some</span> <span class="LPAREN">(</span><span class="UIDENT">Process_error</span> <a href="#local_r_326"><span class="LIDENT">r</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="ELSE">else</span> <span class="MATCH">match</span> <span class="UIDENT">Tar</span><span class="DOT">.</span><span class="LIDENT">check_extract</span> <a href="#local_file_323"><span class="LIDENT">file</span></a> <span class="WITH">with</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Done</span> <span class="LPAREN">(</span><span class="UIDENT">Some</span> <span class="LPAREN">(</span><span class="UIDENT">Process_error</span> <a href="#local_r_326"><span class="LIDENT">r</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_s_327"><span class="LIDENT">s</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Done</span> <span class="LPAREN">(</span><span class="UIDENT">Some</span> <span class="LPAREN">(</span><span class="UIDENT">Failure</span> <a href="#local_s_327"><span class="LIDENT">s</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="ELSE">else</span> <span class="IF">if</span> <span class="TRY">try</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-not"><span class="LIDENT">not</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-is_directory"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">is_directory</span></a> <a href="#local_dir_322"><span class="LIDENT">dir</span></a><span class="RPAREN">)</span> <span class="WITH">with</span> <span class="UIDENT">Sys_error</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="FALSE">false</span> <span class="THEN">then</span><span class="EOL">
</span>      <span class="LIDENT">internal_error</span> <span class="STRING">&quot;Extracting the archive would overwrite %s.&quot;</span> <a href="#local_dir_322"><span class="LIDENT">dir</span></a><span class="EOL">
</span>    <span class="ELSE">else</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_flist_328"><span class="LIDENT">flist</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <a href="opamStd.ml.html#module-Op"><span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">Op</span></a><span class="DOT">.</span><span class="LPAREN">(</span><span class="EOL">
</span>        <span class="LIDENT">files_all_not_dir</span> <a href="#local_tmp_dir_324"><span class="LIDENT">tmp_dir</span></a> <a href="opamStd.ml.html#module-Op.val-(|&gt;)"><span class="INFIXOP0">|&gt;</span></a><span class="EOL">
</span>        <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-filter"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">filter</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-not"><span class="LIDENT">not</span></a> <a href="opamStd.ml.html#module-Op.val-(@*)"><span class="INFIXOP1">@*</span></a> <a href="opamStd.ml.html#module-OpamString.val-contains"><span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">String</span><span class="DOT">.</span><span class="LIDENT">contains</span></a> <span class="LABEL">~sub:</span><span class="STRING">&quot;pax_global_header&quot;</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_flist_328"><span class="LIDENT">flist</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="BEGIN">begin</span> <span class="MATCH">match</span> <span class="LIDENT">directories_strict</span> <a href="#local_tmp_dir_324"><span class="LIDENT">tmp_dir</span></a> <span class="WITH">with</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="LBRACKET">[</span><span id="local_x_329"><span class="LIDENT">x</span></span><span class="RBRACKET">]</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LPAREN">(</span><span class="TRY">try</span><span class="EOL">
</span>             <span class="LIDENT">mkdir</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#module-Sysdeps"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">dirname</span></a> <a href="#local_dir_322"><span class="LIDENT">dir</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>             <span class="LIDENT">copy_dir</span> <a href="#local_x_329"><span class="LIDENT">x</span></a> <a href="#local_dir_322"><span class="LIDENT">dir</span></a><span class="SEMI">;</span><span class="EOL">
</span>             <span class="UIDENT">Done</span> <span class="UIDENT">None</span><span class="EOL">
</span>           <span class="WITH">with</span> <span id="local_e_330"><span class="LIDENT">e</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="opamStd.ml.html#module-Exn.val-fatal"><span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">Exn</span><span class="DOT">.</span><span class="LIDENT">fatal</span></a> <a href="#local_e_330"><span class="LIDENT">e</span></a><span class="SEMI">;</span> <span class="UIDENT">Done</span> <span class="LPAREN">(</span><span class="UIDENT">Some</span> <a href="#local_e_330"><span class="LIDENT">e</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LIDENT">internal_error</span> <span class="STRING">&quot;The archive %S contains multiple root directories.&quot;</span><span class="EOL">
</span>            <a href="#local_file_323"><span class="LIDENT">file</span></a><span class="EOL">
</span>      <span class="END">end</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UNDERSCORE">_</span>   <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">mkdir</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#module-Sysdeps"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">dirname</span></a> <a href="#local_dir_322"><span class="LIDENT">dir</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>      <span class="TRY">try</span> <span class="LIDENT">copy_dir</span> <a href="#local_tmp_dir_324"><span class="LIDENT">tmp_dir</span></a> <a href="#local_dir_322"><span class="LIDENT">dir</span></a><span class="SEMI">;</span> <span class="UIDENT">Done</span> <span class="UIDENT">None</span><span class="EOL">
</span>      <span class="WITH">with</span> <span id="local_e_331"><span class="LIDENT">e</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="opamStd.ml.html#module-Exn.val-fatal"><span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">Exn</span><span class="DOT">.</span><span class="LIDENT">fatal</span></a> <a href="#local_e_331"><span class="LIDENT">e</span></a><span class="SEMI">;</span> <span class="UIDENT">Done</span> <span class="LPAREN">(</span><span class="UIDENT">Some</span> <a href="#local_e_331"><span class="LIDENT">e</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-extract"><span class="LIDENT">extract</span></span> <span class="TILDE">~</span><span id="local_dir_332"><span class="LIDENT">dir</span></span> <span id="local_file_333"><span class="LIDENT">file</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="MATCH">match</span> <a href="opamProcess.ml.html#module-Job.val-run"><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="UIDENT">Job</span><span class="DOT">.</span><span class="LIDENT">run</span></a> <span class="LPAREN">(</span><span class="LIDENT">extract_job</span> <span class="TILDE">~</span><a href="#local_dir_332"><span class="LIDENT">dir</span></a> <a href="#local_file_333"><span class="LIDENT">file</span></a><span class="RPAREN">)</span> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_e_334"><span class="LIDENT">e</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-raise"><span class="LIDENT">raise</span></a> <a href="#local_e_334"><span class="LIDENT">e</span></a><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-extract_in_job"><span class="LIDENT">extract_in_job</span></span> <span class="TILDE">~</span><span id="local_dir_335"><span class="LIDENT">dir</span></span> <span id="local_file_336"><span class="LIDENT">file</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="opamProcess.ml.html#module-Job.val-catch"><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="UIDENT">Job</span><span class="DOT">.</span><span class="LIDENT">catch</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_e_337"><span class="LIDENT">e</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Done</span> <span class="LPAREN">(</span><span class="UIDENT">Some</span> <a href="#local_e_337"><span class="LIDENT">e</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span> <span class="INFIXOP1">@@</span> <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>  <span class="LIDENT">mkdir</span> <a href="#local_dir_335"><span class="LIDENT">dir</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="MATCH">match</span> <span class="LIDENT">extract_command</span> <a href="#local_file_336"><span class="LIDENT">file</span></a> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">internal_error</span> <span class="STRING">&quot;%s is not a valid tar or zip archive.&quot;</span> <a href="#local_file_336"><span class="LIDENT">file</span></a><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_cmd_338"><span class="LIDENT">cmd</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="#local_cmd_338"><span class="LIDENT">cmd</span></a> <a href="#local_dir_335"><span class="LIDENT">dir</span></a> <a href="opamProcess.ml.html#module-Job.module-Op.val-(@@&gt;)"><span class="INFIXOP1">@@&gt;</span></a> <span class="FUN">fun</span> <span id="local_r_339"><span class="LIDENT">r</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-not"><span class="LIDENT">not</span></a> <span class="LPAREN">(</span><a href="opamProcess.ml.html#val-is_success"><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="LIDENT">is_success</span></a> <a href="#local_r_339"><span class="LIDENT">r</span></a><span class="RPAREN">)</span> <span class="THEN">then</span><span class="EOL">
</span>      <span class="IF">if</span> <span class="UIDENT">Zip</span><span class="DOT">.</span><span class="LIDENT">is_archive</span> <a href="#local_file_336"><span class="LIDENT">file</span></a> <span class="THEN">then</span><span class="EOL">
</span>        <span class="UIDENT">Done</span> <span class="LPAREN">(</span><span class="UIDENT">Some</span> <span class="LPAREN">(</span><span class="UIDENT">Process_error</span> <a href="#local_r_339"><span class="LIDENT">r</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="ELSE">else</span> <span class="MATCH">match</span> <span class="UIDENT">Tar</span><span class="DOT">.</span><span class="LIDENT">check_extract</span> <a href="#local_file_336"><span class="LIDENT">file</span></a> <span class="WITH">with</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="UIDENT">Done</span> <span class="LPAREN">(</span><span class="UIDENT">Some</span> <span class="LPAREN">(</span><span class="UIDENT">Failure</span><span class="EOL">
</span>                        <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/printf.ml.html#val-sprintf"><span class="UIDENT">Printf</span><span class="DOT">.</span><span class="LIDENT">sprintf</span></a> <span class="STRING">&quot;Failed to extract archive %s: %s&quot;</span> <a href="#local_file_336"><span class="LIDENT">file</span></a><span class="EOL">
</span>                           <span class="LPAREN">(</span><a href="opamProcess.ml.html#val-result_summary"><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="LIDENT">result_summary</span></a> <a href="#local_r_339"><span class="LIDENT">r</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_s_340"><span class="LIDENT">s</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Done</span> <span class="LPAREN">(</span><span class="UIDENT">Some</span> <span class="LPAREN">(</span><span class="UIDENT">Failure</span> <a href="#local_s_340"><span class="LIDENT">s</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="ELSE">else</span> <span class="UIDENT">Done</span> <span class="UIDENT">None</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-extract_in"><span class="LIDENT">extract_in</span></span> <span class="TILDE">~</span><span id="local_dir_341"><span class="LIDENT">dir</span></span> <span id="local_file_342"><span class="LIDENT">file</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="MATCH">match</span> <a href="opamProcess.ml.html#module-Job.val-run"><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="UIDENT">Job</span><span class="DOT">.</span><span class="LIDENT">run</span></a> <span class="LPAREN">(</span><span class="LIDENT">extract_in_job</span> <span class="TILDE">~</span><a href="#local_dir_341"><span class="LIDENT">dir</span></a> <a href="#local_file_342"><span class="LIDENT">file</span></a><span class="RPAREN">)</span> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_e_343"><span class="LIDENT">e</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-raise"><span class="LIDENT">raise</span></a> <a href="#local_e_343"><span class="LIDENT">e</span></a><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-link"><span class="LIDENT">link</span></span> <span id="local_src_344"><span class="LIDENT">src</span></span> <span id="local_dst_345"><span class="LIDENT">dst</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_fallback_346"><span class="LIDENT">fallback</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="COMMENT">(* Fall back to copy if symlinks are not supported *)</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_src_347"><span class="LIDENT">src</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#module-Sysdeps"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">is_relative</span></a> <a href="#local_src_344"><span class="LIDENT">src</span></a> <span class="THEN">then</span> <a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#module-Sysdeps"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">dirname</span></a> <a href="#local_dst_345"><span class="LIDENT">dst</span></a> <span class="INFIXOP3">/</span> <a href="#local_src_344"><span class="LIDENT">src</span></a><span class="EOL">
</span>      <span class="ELSE">else</span> <a href="#local_src_344"><span class="LIDENT">src</span></a><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-is_directory"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">is_directory</span></a> <a href="#local_src_347"><span class="LIDENT">src</span></a> <span class="THEN">then</span><span class="EOL">
</span>      <span class="LIDENT">copy_dir</span> <a href="#local_src_347"><span class="LIDENT">src</span></a> <a href="#local_dst_345"><span class="LIDENT">dst</span></a><span class="EOL">
</span>    <span class="ELSE">else</span><span class="EOL">
</span>      <span class="LIDENT">copy_file</span> <a href="#local_src_347"><span class="LIDENT">src</span></a> <a href="#local_dst_345"><span class="LIDENT">dst</span></a><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <span class="LIDENT">mkdir</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#module-Sysdeps"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">dirname</span></a> <a href="#local_dst_345"><span class="LIDENT">dst</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>  <span class="IF">if</span> <span class="LIDENT">file_or_symlink_exists</span> <a href="#local_dst_345"><span class="LIDENT">dst</span></a> <span class="THEN">then</span> <span class="LPAREN">(</span><span class="EOL">
</span>    <span class="COMMENT">(* TODO: move this into remove_file *)</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-win32"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">win32</span></a> <span class="THEN">then</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">chmod</span> <a href="#local_dst_345"><span class="LIDENT">dst</span></a> <span class="INT">0o640</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">remove_file</span> <a href="#local_dst_345"><span class="LIDENT">dst</span></a><span class="EOL">
</span>  <span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>  <span class="IF">if</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">has_symlink</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="THEN">then</span><span class="EOL">
</span>    <span class="TRY">try</span><span class="EOL">
</span>      <span class="LIDENT">log</span> <span class="STRING">&quot;ln -s %s %s&quot;</span> <a href="#local_src_344"><span class="LIDENT">src</span></a> <a href="#local_dst_345"><span class="LIDENT">dst</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">symlink</span> <a href="#local_src_344"><span class="LIDENT">src</span></a> <a href="#local_dst_345"><span class="LIDENT">dst</span></a><span class="EOL">
</span>    <span class="WITH">with</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">Unix_error</span> <span class="LPAREN">(</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">EXDEV</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="#local_fallback_346"><span class="LIDENT">fallback</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="ELSE">else</span> <span class="LPAREN">(</span><span class="EOL">
</span>    <span class="LIDENT">log</span> <span class="STRING">&quot;copy %s -&gt; %s&quot;</span> <a href="#local_src_344"><span class="LIDENT">src</span></a> <a href="#local_dst_345"><span class="LIDENT">dst</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <a href="#local_fallback_346"><span class="LIDENT">fallback</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span id="type-actual_lock_flag"><span class="TYPE">type</span> <span class="LIDENT">actual_lock_flag</span> <span class="EQUAL">=</span> <span class="LBRACKET">[</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Lock_read</span> <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Lock_write</span> <span class="RBRACKET">]</span></span><span class="EOL">
</span><span id="type-lock_flag"><span class="TYPE">type</span> <span class="LIDENT">lock_flag</span> <span class="EQUAL">=</span> <span class="LBRACKET">[</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Lock_none</span> <span class="BAR">|</span> <span class="LIDENT">actual_lock_flag</span> <span class="RBRACKET">]</span></span><span class="EOL">
</span><span class="EOL">
</span><span id="type-lock"><span class="TYPE">type</span> <span class="LIDENT">lock</span> <span class="EQUAL">=</span> <span class="LBRACE">{</span><span class="EOL">
</span>  <span id="def_540"><span class="MUTABLE">mutable</span> <span class="LIDENT">fd</span><span class="COLON">:</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">file_descr</span> <span class="LIDENT">option</span><span class="SEMI">;</span></span><span class="EOL">
</span>  <span id="def_541"><span class="LIDENT">file</span><span class="COLON">:</span> <span class="LIDENT">string</span><span class="SEMI">;</span></span><span class="EOL">
</span>  <span id="def_536"><span class="MUTABLE">mutable</span> <span class="LIDENT">kind</span><span class="COLON">:</span> <span class="LIDENT">lock_flag</span><span class="SEMI">;</span></span><span class="EOL">
</span><span class="RBRACE">}</span></span><span class="EOL">
</span><span class="EOL">
</span><span id="exception-Locked"><span class="EXCEPTION">exception</span> <span class="UIDENT">Locked</span></span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-unix_lock_op"><span class="LIDENT">unix_lock_op</span></span> <span class="TILDE">~</span><span id="local_dontblock_348"><span class="LIDENT">dontblock</span></span> <span class="EQUAL">=</span> <span class="FUNCTION">function</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Lock_read</span> <span class="MINUSGREATER">-&gt;</span> <span class="IF">if</span> <a href="#local_dontblock_348"><span class="LIDENT">dontblock</span></a> <span class="THEN">then</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">F_TRLOCK</span> <span class="ELSE">else</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">F_RLOCK</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Lock_write</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="opamCoreConfig.ml.html"><span class="UIDENT">OpamCoreConfig</span></a><span class="DOT">.</span><span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="opamCoreConfig.ml.html#val-r"><span class="LIDENT">r</span></a><span class="DOT">.</span><span class="LIDENT">safe_mode</span><span class="RPAREN">)</span> <span class="THEN">then</span><span class="EOL">
</span>      <a href="opamConsole.ml.html#val-error_and_exit"><span class="UIDENT">OpamConsole</span><span class="DOT">.</span><span class="LIDENT">error_and_exit</span></a> <span class="BACKQUOTE">`</span><span class="UIDENT">Locked</span> <span class="STRING">&quot;Write lock attempt in safe mode&quot;</span><span class="EOL">
</span>    <span class="ELSE">else</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_dontblock_348"><span class="LIDENT">dontblock</span></a> <span class="THEN">then</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">F_TLOCK</span> <span class="ELSE">else</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">F_LOCK</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-string_of_lock_kind"><span class="LIDENT">string_of_lock_kind</span></span> <span class="EQUAL">=</span> <span class="FUNCTION">function</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Lock_none</span> <span class="MINUSGREATER">-&gt;</span> <span class="STRING">&quot;none&quot;</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Lock_read</span> <span class="MINUSGREATER">-&gt;</span> <span class="STRING">&quot;read&quot;</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Lock_write</span> <span class="MINUSGREATER">-&gt;</span> <span class="STRING">&quot;write&quot;</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-locks"><span class="LIDENT">locks</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/hashtbl.ml.html#val-create"><span class="UIDENT">Hashtbl</span><span class="DOT">.</span><span class="LIDENT">create</span></a> <span class="INT">16</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-release_all_locks"><span class="LIDENT">release_all_locks</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="../../../ocaml-base-compiler/src/stdlib/hashtbl.ml.html#val-iter"><span class="UIDENT">Hashtbl</span><span class="DOT">.</span><span class="LIDENT">iter</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_fd_349"><span class="LIDENT">fd</span></span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">close</span> <a href="#local_fd_349"><span class="LIDENT">fd</span></a><span class="RPAREN">)</span> <span class="LIDENT">locks</span><span class="SEMI">;</span><span class="EOL">
</span>  <a href="../../../ocaml-base-compiler/src/stdlib/hashtbl.ml.html#val-clear"><span class="UIDENT">Hashtbl</span><span class="DOT">.</span><span class="LIDENT">clear</span></a> <span class="LIDENT">locks</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span class="REC">rec</span> <span id="val-flock_update"><span class="LIDENT">flock_update</span></span><span class="EOL">
</span>  <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span><span class="DOT">.</span> <span class="LPAREN">(</span><span class="LBRACKETLESS">[&lt;</span> <span class="LIDENT">lock_flag</span> <span class="RBRACKET">]</span> <span class="AS">as</span> <span class="QUOTE">'</span><span class="LIDENT">a</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="OPTLABEL">?dontblock:</span><span class="LIDENT">bool</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">lock</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span><span class="EOL">
</span>  <span class="EQUAL">=</span> <span class="FUN">fun</span> <span id="local_flag_350"><span class="LIDENT">flag</span></span> <span class="QUESTION">?</span><span class="LPAREN">(</span><span id="local_dontblock_351"><span class="LIDENT">dontblock</span></span><span class="EQUAL">=</span><a href="opamCoreConfig.ml.html"><span class="UIDENT">OpamCoreConfig</span></a><span class="DOT">.</span><span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="opamCoreConfig.ml.html#val-r"><span class="LIDENT">r</span></a><span class="DOT">.</span><span class="LIDENT">safe_mode</span><span class="RPAREN">)</span><span class="RPAREN">)</span> <span id="local_lock_352"><span class="LIDENT">lock</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>  <span class="LIDENT">log</span> <span class="STRING">&quot;LOCK %s (%a =&gt; %a)&quot;</span> <span class="LABEL">~level:</span><span class="INT">2</span> <a href="#local_lock_352"><span class="LIDENT">lock</span></a><span class="DOT">.</span><span class="LIDENT">file</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="LIDENT">slog</span> <span class="LIDENT">string_of_lock_kind</span><span class="RPAREN">)</span> <span class="LPAREN">(</span><a href="#local_lock_352"><span class="LIDENT">lock</span></a><span class="DOT">.</span><span class="LIDENT">kind</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="LIDENT">slog</span> <span class="LIDENT">string_of_lock_kind</span><span class="RPAREN">)</span> <a href="#local_flag_350"><span class="LIDENT">flag</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="#local_lock_352"><span class="LIDENT">lock</span></a><span class="DOT">.</span><span class="LIDENT">kind</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="LPAREN">(</span><a href="#local_flag_350"><span class="LIDENT">flag</span></a> <span class="COLONGREATER">:&gt;</span> <span class="LIDENT">lock_flag</span><span class="RPAREN">)</span> <span class="THEN">then</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="ELSE">else</span><span class="EOL">
</span>  <span class="MATCH">match</span> <a href="#local_flag_350"><span class="LIDENT">flag</span></a><span class="COMMA">,</span> <a href="#local_lock_352"><span class="LIDENT">lock</span></a> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Lock_none</span><span class="COMMA">,</span> <span class="LBRACE">{</span> <span class="LIDENT">fd</span> <span class="EQUAL">=</span> <span class="UIDENT">Some</span> <span id="local_fd_353"><span class="LIDENT">fd</span></span><span class="SEMI">;</span> <span class="LIDENT">kind</span> <span class="EQUAL">=</span> <span class="LPAREN">(</span><span class="BACKQUOTE">`</span><span class="UIDENT">Lock_read</span> <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Lock_write</span><span class="RPAREN">)</span><span class="SEMI">;</span> <span class="UNDERSCORE">_</span> <span class="RBRACE">}</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/hashtbl.ml.html#val-remove"><span class="UIDENT">Hashtbl</span><span class="DOT">.</span><span class="LIDENT">remove</span></a> <span class="LIDENT">locks</span> <a href="#local_fd_353"><span class="LIDENT">fd</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">close</span> <a href="#local_fd_353"><span class="LIDENT">fd</span></a><span class="SEMI">;</span> <span class="COMMENT">(* implies Unix.lockf fd Unix.F_ULOCK 0 *)</span><span class="EOL">
</span>    <a href="#local_lock_352"><span class="LIDENT">lock</span></a><span class="DOT">.</span><span class="LIDENT">kind</span> <span class="LESSMINUS">&lt;-</span> <span class="LPAREN">(</span><a href="#local_flag_350"><span class="LIDENT">flag</span></a> <span class="COLONGREATER">:&gt;</span> <span class="LIDENT">lock_flag</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="#local_lock_352"><span class="LIDENT">lock</span></a><span class="DOT">.</span><span class="LIDENT">fd</span> <span class="LESSMINUS">&lt;-</span> <span class="UIDENT">None</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="LPAREN">(</span><span class="BACKQUOTE">`</span><span class="UIDENT">Lock_read</span> <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Lock_write</span><span class="RPAREN">)</span><span class="COMMA">,</span> <span class="LBRACE">{</span> <span class="LIDENT">fd</span> <span class="EQUAL">=</span> <span class="UIDENT">None</span><span class="SEMI">;</span> <span class="LIDENT">kind</span> <span class="EQUAL">=</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Lock_none</span><span class="SEMI">;</span> <span id="local_file_354"><span class="LIDENT">file</span></span> <span class="RBRACE">}</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_new_lock_355"><span class="LIDENT">new_lock</span></span> <span class="EQUAL">=</span> <span class="LIDENT">flock</span> <a href="#local_flag_350"><span class="LIDENT">flag</span></a> <span class="TILDE">~</span><a href="#local_dontblock_351"><span class="LIDENT">dontblock</span></a> <a href="#local_file_354"><span class="LIDENT">file</span></a> <span class="IN">in</span><span class="EOL">
</span>    <a href="#local_lock_352"><span class="LIDENT">lock</span></a><span class="DOT">.</span><span class="LIDENT">kind</span> <span class="LESSMINUS">&lt;-</span> <span class="LPAREN">(</span><a href="#local_flag_350"><span class="LIDENT">flag</span></a> <span class="COLONGREATER">:&gt;</span> <span class="LIDENT">lock_flag</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="#local_lock_352"><span class="LIDENT">lock</span></a><span class="DOT">.</span><span class="LIDENT">fd</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_new_lock_355"><span class="LIDENT">new_lock</span></a><span class="DOT">.</span><span class="LIDENT">fd</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Lock_write</span><span class="COMMA">,</span> <span class="LBRACE">{</span> <span class="LIDENT">fd</span> <span class="EQUAL">=</span> <span class="UIDENT">Some</span> <span id="local_fd_356"><span class="LIDENT">fd</span></span><span class="SEMI">;</span> <span id="local_file_357"><span class="LIDENT">file</span></span><span class="SEMI">;</span> <span class="LIDENT">kind</span> <span class="EQUAL">=</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Lock_read</span> <span class="RBRACE">}</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">close</span> <a href="#local_fd_356"><span class="LIDENT">fd</span></a><span class="SEMI">;</span> <span class="COMMENT">(* fd needs read-write reopen *)</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_new_lock_358"><span class="LIDENT">new_lock</span></span> <span class="EQUAL">=</span> <span class="LIDENT">flock</span> <a href="#local_flag_350"><span class="LIDENT">flag</span></a> <span class="TILDE">~</span><a href="#local_dontblock_351"><span class="LIDENT">dontblock</span></a> <a href="#local_file_357"><span class="LIDENT">file</span></a> <span class="IN">in</span><span class="EOL">
</span>    <a href="#local_lock_352"><span class="LIDENT">lock</span></a><span class="DOT">.</span><span class="LIDENT">kind</span> <span class="LESSMINUS">&lt;-</span> <span class="LPAREN">(</span><a href="#local_flag_350"><span class="LIDENT">flag</span></a> <span class="COLONGREATER">:&gt;</span> <span class="LIDENT">lock_flag</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="#local_lock_352"><span class="LIDENT">lock</span></a><span class="DOT">.</span><span class="LIDENT">fd</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_new_lock_358"><span class="LIDENT">new_lock</span></a><span class="DOT">.</span><span class="LIDENT">fd</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="LPAREN">(</span><span class="BACKQUOTE">`</span><span class="UIDENT">Lock_read</span> <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Lock_write</span><span class="RPAREN">)</span> <span class="AS">as</span> <span id="local_flag_359"><span class="LIDENT">flag</span></span><span class="COMMA">,</span> <span class="LBRACE">{</span> <span class="LIDENT">fd</span> <span class="EQUAL">=</span> <span class="UIDENT">Some</span> <span id="local_fd_360"><span class="LIDENT">fd</span></span><span class="SEMI">;</span> <span id="local_file_361"><span class="LIDENT">file</span></span><span class="SEMI">;</span> <span id="local_kind_362"><span class="LIDENT">kind</span></span> <span class="RBRACE">}</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="COMMENT">(* Write locks are not recursive on Windows, so only call lockf if necessary *)</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_kind_362"><span class="LIDENT">kind</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;&gt;)"><span class="INFIXOP0">&lt;&gt;</span></a> <a href="#local_flag_359"><span class="LIDENT">flag</span></a> <span class="THEN">then</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="TRY">try</span><span class="EOL">
</span>         <span class="COMMENT">(* Locks can't be promoted (or demoted) on Windows - see PR#7264 *)</span><span class="EOL">
</span>         <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-win32"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">win32</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&amp;&amp;)"><span class="AMPERAMPER">&amp;&amp;</span></a> <a href="#local_kind_362"><span class="LIDENT">kind</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;&gt;)"><span class="INFIXOP0">&lt;&gt;</span></a> <span class="BACKQUOTE">`</span><span class="UIDENT">Lock_none</span> <span class="THEN">then</span><span class="EOL">
</span>           <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LPAREN">(</span><span class="LIDENT">lockf</span> <a href="#local_fd_360"><span class="LIDENT">fd</span></a> <span class="UIDENT">F_ULOCK</span> <span class="INT">0</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>         <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">lockf</span> <a href="#local_fd_360"><span class="LIDENT">fd</span></a> <span class="LPAREN">(</span><span class="LIDENT">unix_lock_op</span> <span class="LABEL">~dontblock:</span><span class="TRUE">true</span> <a href="#local_flag_359"><span class="LIDENT">flag</span></a><span class="RPAREN">)</span> <span class="INT">0</span><span class="EOL">
</span>       <span class="WITH">with</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">Unix_error</span> <span class="LPAREN">(</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">EAGAIN</span><span class="COMMA">,</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span><span class="UNDERSCORE">_</span><span class="RPAREN">)</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">Unix_error</span> <span class="LPAREN">(</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">EACCES</span><span class="COMMA">,</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span><span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>         <span class="IF">if</span> <a href="#local_dontblock_351"><span class="LIDENT">dontblock</span></a> <span class="THEN">then</span><span class="EOL">
</span>           <a href="opamConsole.ml.html#val-error_and_exit"><span class="UIDENT">OpamConsole</span><span class="DOT">.</span><span class="LIDENT">error_and_exit</span></a> <span class="BACKQUOTE">`</span><span class="UIDENT">Locked</span><span class="EOL">
</span>             <span class="STRING">&quot;Another process has locked %s and non blocking mode enabled&quot;</span><span class="EOL">
</span>             <a href="#local_file_361"><span class="LIDENT">file</span></a><span class="SEMI">;</span><span class="EOL">
</span>         <a href="opamConsole.ml.html#val-formatted_errmsg"><span class="UIDENT">OpamConsole</span><span class="DOT">.</span><span class="LIDENT">formatted_errmsg</span></a><span class="EOL">
</span>           <span class="STRING">&quot;Another process has locked %s, waiting (%s to abort)... &quot;</span><span class="EOL">
</span>           <a href="#local_file_361"><span class="LIDENT">file</span></a> <span class="LPAREN">(</span><span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-win32"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">win32</span></a> <span class="THEN">then</span> <span class="STRING">&quot;CTRL+C&quot;</span> <span class="ELSE">else</span> <span class="STRING">&quot;C-c&quot;</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>         <span class="LET">let</span> <span class="REC">rec</span> <span id="local_lock_w_ignore_sig_363"><span class="LIDENT">lock_w_ignore_sig</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>           <span class="TRY">try</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">lockf</span> <a href="#local_fd_360"><span class="LIDENT">fd</span></a> <span class="LPAREN">(</span><span class="LIDENT">unix_lock_op</span> <span class="LABEL">~dontblock:</span><span class="FALSE">false</span> <a href="#local_flag_359"><span class="LIDENT">flag</span></a><span class="RPAREN">)</span> <span class="INT">0</span><span class="SEMI">;</span><span class="EOL">
</span>           <span class="WITH">with</span> <span class="UIDENT">Sys</span><span class="DOT">.</span><span class="UIDENT">Break</span> <span class="AS">as</span> <span id="local_e_364"><span class="LIDENT">e</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><a href="opamConsole.ml.html#val-errmsg"><span class="UIDENT">OpamConsole</span><span class="DOT">.</span><span class="LIDENT">errmsg</span></a> <span class="STRING">&quot;\n&quot;</span><span class="SEMI">;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-raise"><span class="LIDENT">raise</span></a> <a href="#local_e_364"><span class="LIDENT">e</span></a><span class="RPAREN">)</span><span class="EOL">
</span>              <span class="BAR">|</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">Unix_error</span> <span class="LPAREN">(</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">EINTR</span><span class="COMMA">,</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span><span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_lock_w_ignore_sig_363"><span class="LIDENT">lock_w_ignore_sig</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>         <span class="IN">in</span> <a href="#local_lock_w_ignore_sig_363"><span class="LIDENT">lock_w_ignore_sig</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>         <a href="opamConsole.ml.html#val-errmsg"><span class="UIDENT">OpamConsole</span><span class="DOT">.</span><span class="LIDENT">errmsg</span></a> <span class="STRING">&quot;lock acquired.\n&quot;</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="#local_lock_352"><span class="LIDENT">lock</span></a><span class="DOT">.</span><span class="LIDENT">kind</span> <span class="LESSMINUS">&lt;-</span> <span class="LPAREN">(</span><a href="#local_flag_359"><span class="LIDENT">flag</span></a> <span class="COLONGREATER">:&gt;</span> <span class="LIDENT">lock_flag</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="ASSERT">assert</span> <span class="FALSE">false</span><span class="EOL">
</span><span class="EOL">
</span><span class="AND">and</span> <span id="val-flock"><span class="LIDENT">flock</span></span><span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span><span class="DOT">.</span> <span class="LPAREN">(</span><span class="LBRACKETLESS">[&lt;</span> <span class="LIDENT">lock_flag</span> <span class="RBRACKET">]</span> <span class="AS">as</span> <span class="QUOTE">'</span><span class="LIDENT">a</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="OPTLABEL">?dontblock:</span><span class="LIDENT">bool</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">string</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">lock</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="FUN">fun</span> <span id="local_flag_365"><span class="LIDENT">flag</span></span> <span class="QUESTION">?</span><span id="local_dontblock_366"><span class="LIDENT">dontblock</span></span> <span id="local_file_367"><span class="LIDENT">file</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>  <span class="MATCH">match</span> <a href="#local_flag_365"><span class="LIDENT">flag</span></a> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Lock_none</span> <span class="MINUSGREATER">-&gt;</span> <span class="LBRACE">{</span> <span class="LIDENT">fd</span> <span class="EQUAL">=</span> <span class="UIDENT">None</span><span class="SEMI">;</span> <a href="#local_file_367"><span class="LIDENT">file</span></a><span class="SEMI">;</span> <span class="LIDENT">kind</span> <span class="EQUAL">=</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Lock_none</span> <span class="RBRACE">}</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Lock_write</span> <span class="WHEN">when</span> <a href="opamCoreConfig.ml.html"><span class="UIDENT">OpamCoreConfig</span></a><span class="DOT">.</span><span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="opamCoreConfig.ml.html#val-r"><span class="LIDENT">r</span></a><span class="DOT">.</span><span class="LIDENT">safe_mode</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="opamConsole.ml.html#val-error_and_exit"><span class="UIDENT">OpamConsole</span><span class="DOT">.</span><span class="LIDENT">error_and_exit</span></a> <span class="BACKQUOTE">`</span><span class="UIDENT">Locked</span> <span class="STRING">&quot;Write lock attempt in safe mode&quot;</span><span class="SEMI">;</span><span class="EOL">
</span>  <span class="BAR">|</span> <span id="local_flag_368"><span class="LIDENT">flag</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LIDENT">mkdir</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#module-Sysdeps"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">dirname</span></a> <a href="#local_file_367"><span class="LIDENT">file</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_rdflag_369"><span class="LIDENT">rdflag</span></span> <span class="EQUAL">=</span> <span class="IF">if</span> <span class="LPAREN">(</span><a href="#local_flag_368"><span class="LIDENT">flag</span></a> <span class="COLONGREATER">:&gt;</span> <span class="LIDENT">lock_flag</span><span class="RPAREN">)</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="BACKQUOTE">`</span><span class="UIDENT">Lock_write</span> <span class="THEN">then</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">O_RDWR</span> <span class="ELSE">else</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">O_RDONLY</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_fd_370"><span class="LIDENT">fd</span></span> <span class="EQUAL">=</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">openfile</span> <a href="#local_file_367"><span class="LIDENT">file</span></a> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LPAREN">(</span><span class="LBRACKET">[</span><span class="UIDENT">O_CREAT</span><span class="SEMI">;</span> <span class="UIDENT">O_CLOEXEC</span><span class="SEMI">;</span> <span class="UIDENT">O_SHARE_DELETE</span><span class="SEMI">;</span> <a href="#local_rdflag_369"><span class="LIDENT">rdflag</span></a><span class="RBRACKET">]</span><span class="RPAREN">)</span> <span class="INT">0o666</span> <span class="IN">in</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/hashtbl.ml.html#val-add"><span class="UIDENT">Hashtbl</span><span class="DOT">.</span><span class="LIDENT">add</span></a> <span class="LIDENT">locks</span> <a href="#local_fd_370"><span class="LIDENT">fd</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_lock_371"><span class="LIDENT">lock</span></span> <span class="EQUAL">=</span> <span class="LBRACE">{</span> <span class="LIDENT">fd</span> <span class="EQUAL">=</span> <span class="UIDENT">Some</span> <a href="#local_fd_370"><span class="LIDENT">fd</span></a><span class="SEMI">;</span> <a href="#local_file_367"><span class="LIDENT">file</span></a><span class="SEMI">;</span> <span class="LIDENT">kind</span> <span class="EQUAL">=</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Lock_none</span> <span class="RBRACE">}</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="LIDENT">flock_update</span> <a href="#local_flag_368"><span class="LIDENT">flag</span></a> <span class="QUESTION">?</span><a href="#local_dontblock_366"><span class="LIDENT">dontblock</span></a> <a href="#local_lock_371"><span class="LIDENT">lock</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <a href="#local_lock_371"><span class="LIDENT">lock</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-funlock"><span class="LIDENT">funlock</span></span> <span id="local_lock_372"><span class="LIDENT">lock</span></span> <span class="EQUAL">=</span> <span class="LIDENT">flock_update</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Lock_none</span> <a href="#local_lock_372"><span class="LIDENT">lock</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-get_lock_flag"><span class="LIDENT">get_lock_flag</span></span> <span id="local_lock_373"><span class="LIDENT">lock</span></span> <span class="EQUAL">=</span> <a href="#local_lock_373"><span class="LIDENT">lock</span></a><span class="DOT">.</span><span class="LIDENT">kind</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-get_lock_fd"><span class="LIDENT">get_lock_fd</span></span> <span id="local_lock_374"><span class="LIDENT">lock</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="MATCH">match</span> <a href="#local_lock_374"><span class="LIDENT">lock</span></a><span class="DOT">.</span><span class="LIDENT">fd</span> <span class="WITH">with</span><span class="EOL">
</span>    <span class="UIDENT">Some</span> <span id="local_fd_375"><span class="LIDENT">fd</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_fd_375"><span class="LIDENT">fd</span></a><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-raise"><span class="LIDENT">raise</span></a> <span class="UIDENT">Not_found</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-lock_max"><span class="LIDENT">lock_max</span></span> <span id="local_flag1_376"><span class="LIDENT">flag1</span></span> <span id="local_flag2_377"><span class="LIDENT">flag2</span></span> <span class="EQUAL">=</span> <span class="MATCH">match</span> <a href="#local_flag1_376"><span class="LIDENT">flag1</span></a><span class="COMMA">,</span> <a href="#local_flag2_377"><span class="LIDENT">flag2</span></a> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Lock_write</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span> <span class="BAR">|</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Lock_write</span> <span class="MINUSGREATER">-&gt;</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Lock_write</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Lock_read</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span> <span class="BAR">|</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Lock_read</span> <span class="MINUSGREATER">-&gt;</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Lock_read</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Lock_none</span><span class="COMMA">,</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Lock_none</span> <span class="MINUSGREATER">-&gt;</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Lock_none</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-lock_none"><span class="LIDENT">lock_none</span></span> <span class="EQUAL">=</span> <span class="LBRACE">{</span><span class="EOL">
</span>  <span class="LIDENT">fd</span> <span class="EQUAL">=</span> <span class="UIDENT">None</span><span class="SEMI">;</span><span class="EOL">
</span>  <span class="LIDENT">file</span> <span class="EQUAL">=</span> <span class="STRING">&quot;&quot;</span><span class="SEMI">;</span><span class="EOL">
</span>  <span class="LIDENT">kind</span> <span class="EQUAL">=</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Lock_none</span><span class="SEMI">;</span><span class="EOL">
</span><span class="RBRACE">}</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-lock_isatleast"><span class="LIDENT">lock_isatleast</span></span> <span id="local_flag_378"><span class="LIDENT">flag</span></span> <span id="local_lock_379"><span class="LIDENT">lock</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">lock_max</span> <a href="#local_flag_378"><span class="LIDENT">flag</span></a> <a href="#local_lock_379"><span class="LIDENT">lock</span></a><span class="DOT">.</span><span class="LIDENT">kind</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <a href="#local_lock_379"><span class="LIDENT">lock</span></a><span class="DOT">.</span><span class="LIDENT">kind</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-get_eol_encoding"><span class="LIDENT">get_eol_encoding</span></span> <span id="local_file_380"><span class="LIDENT">file</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_ch_381"><span class="LIDENT">ch</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="TRY">try</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-open_in_bin"><span class="LIDENT">open_in_bin</span></a> <a href="#local_file_380"><span class="LIDENT">file</span></a><span class="EOL">
</span>    <span class="WITH">with</span> <span class="UIDENT">Sys_error</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-raise"><span class="LIDENT">raise</span></a> <span class="LPAREN">(</span><span class="UIDENT">File_not_found</span> <a href="#local_file_380"><span class="LIDENT">file</span></a><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_has_cr_382"><span class="LIDENT">has_cr</span></span> <span id="local_line_383"><span class="LIDENT">line</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_length_384"><span class="LIDENT">length</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/string.ml.html#val-length"><span class="UIDENT">String</span><span class="DOT">.</span><span class="LIDENT">length</span></a> <a href="#local_line_383"><span class="LIDENT">line</span></a> <span class="IN">in</span><span class="EOL">
</span>    <a href="#local_length_384"><span class="LIDENT">length</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <span class="INT">0</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&amp;&amp;)"><span class="AMPERAMPER">&amp;&amp;</span></a> <a href="#local_line_383"><span class="LIDENT">line</span></a><span class="DOT">.</span><span class="LBRACKET">[</span><a href="#local_length_384"><span class="LIDENT">length</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <span class="INT">1</span><span class="RBRACKET">]</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="CHAR">'\r'</span><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_last_char_385"><span class="LIDENT">last_char</span></span> <span id="local_ch_386"><span class="LIDENT">ch</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-seek_in"><span class="LIDENT">seek_in</span></a> <a href="#local_ch_386"><span class="LIDENT">ch</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-in_channel_length"><span class="LIDENT">in_channel_length</span></a> <a href="#local_ch_386"><span class="LIDENT">ch</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <span class="INT">1</span><span class="RPAREN">)</span><span class="SEMI">;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-input_char"><span class="LIDENT">input_char</span></a> <a href="#local_ch_386"><span class="LIDENT">ch</span></a> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="REC">rec</span> <span id="local_read_lines_387"><span class="LIDENT">read_lines</span></span> <span id="local_cr_388"><span class="LIDENT">cr</span></span> <span id="local_line_389"><span class="LIDENT">line</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_has_cr_390"><span class="LIDENT">has_cr</span></span> <span class="EQUAL">=</span> <a href="#local_has_cr_382"><span class="LIDENT">has_cr</span></a> <a href="#local_line_389"><span class="LIDENT">line</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-input_line"><span class="LIDENT">input_line</span></a> <a href="#local_ch_381"><span class="LIDENT">ch</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span id="local_line_391"><span class="LIDENT">line</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="IF">if</span> <a href="#local_has_cr_390"><span class="LIDENT">has_cr</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <a href="#local_cr_388"><span class="LIDENT">cr</span></a> <span class="THEN">then</span><span class="EOL">
</span>          <a href="#local_read_lines_387"><span class="LIDENT">read_lines</span></a> <a href="#local_cr_388"><span class="LIDENT">cr</span></a> <a href="#local_line_391"><span class="LIDENT">line</span></a><span class="EOL">
</span>        <span class="ELSE">else</span> <span class="BEGIN">begin</span><span class="EOL">
</span>          <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-close_in"><span class="LIDENT">close_in</span></a> <a href="#local_ch_381"><span class="LIDENT">ch</span></a><span class="SEMI">;</span><span class="EOL">
</span>          <span class="UIDENT">None</span><span class="EOL">
</span>        <span class="END">end</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="EXCEPTION">exception</span> <span class="UIDENT">End_of_file</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_result_392"><span class="LIDENT">result</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>          <span class="IF">if</span> <a href="#local_cr_388"><span class="LIDENT">cr</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <a href="#local_has_cr_390"><span class="LIDENT">has_cr</span></a> <span class="THEN">then</span><span class="EOL">
</span>            <span class="UIDENT">Some</span> <a href="#local_cr_388"><span class="LIDENT">cr</span></a><span class="EOL">
</span>          <span class="ELSE">else</span><span class="EOL">
</span>            <span class="IF">if</span> <a href="#local_cr_388"><span class="LIDENT">cr</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&amp;&amp;)"><span class="AMPERAMPER">&amp;&amp;</span></a> <a href="#local_last_char_385"><span class="LIDENT">last_char</span></a> <a href="#local_ch_381"><span class="LIDENT">ch</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;&gt;)"><span class="INFIXOP0">&lt;&gt;</span></a> <span class="CHAR">'\n'</span> <span class="THEN">then</span><span class="EOL">
</span>              <span class="UIDENT">Some</span> <span class="TRUE">true</span><span class="EOL">
</span>            <span class="ELSE">else</span><span class="EOL">
</span>              <span class="UIDENT">None</span><span class="EOL">
</span>        <span class="IN">in</span><span class="EOL">
</span>        <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-close_in"><span class="LIDENT">close_in</span></a> <a href="#local_ch_381"><span class="LIDENT">ch</span></a><span class="SEMI">;</span><span class="EOL">
</span>        <a href="#local_result_392"><span class="LIDENT">result</span></a><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <span class="MATCH">match</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-input_line"><span class="LIDENT">input_line</span></a> <a href="#local_ch_381"><span class="LIDENT">ch</span></a> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span id="local_line_one_393"><span class="LIDENT">line_one</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_has_cr_394"><span class="LIDENT">has_cr</span></span> <span class="EQUAL">=</span> <a href="#local_has_cr_382"><span class="LIDENT">has_cr</span></a> <a href="#local_line_one_393"><span class="LIDENT">line_one</span></a> <span class="IN">in</span><span class="EOL">
</span>      <span class="BEGIN">begin</span> <span class="MATCH">match</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-input_line"><span class="LIDENT">input_line</span></a> <a href="#local_ch_381"><span class="LIDENT">ch</span></a> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span id="local_line_two_395"><span class="LIDENT">line_two</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="#local_read_lines_387"><span class="LIDENT">read_lines</span></a> <a href="#local_has_cr_394"><span class="LIDENT">has_cr</span></a> <a href="#local_line_two_395"><span class="LIDENT">line_two</span></a><span class="EOL">
</span>      <span class="BAR">|</span> <span class="EXCEPTION">exception</span> <span class="UIDENT">End_of_file</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_result_396"><span class="LIDENT">result</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <span class="IF">if</span> <a href="#local_last_char_385"><span class="LIDENT">last_char</span></a> <a href="#local_ch_381"><span class="LIDENT">ch</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="CHAR">'\n'</span> <span class="THEN">then</span><span class="EOL">
</span>              <span class="UIDENT">Some</span> <a href="#local_has_cr_394"><span class="LIDENT">has_cr</span></a><span class="EOL">
</span>            <span class="ELSE">else</span><span class="EOL">
</span>              <span class="UIDENT">None</span><span class="EOL">
</span>          <span class="IN">in</span><span class="EOL">
</span>          <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-close_in"><span class="LIDENT">close_in</span></a> <a href="#local_ch_381"><span class="LIDENT">ch</span></a><span class="SEMI">;</span><span class="EOL">
</span>          <a href="#local_result_396"><span class="LIDENT">result</span></a><span class="EOL">
</span>      <span class="END">end</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="EXCEPTION">exception</span> <span class="UIDENT">End_of_file</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-close_in"><span class="LIDENT">close_in</span></a> <a href="#local_ch_381"><span class="LIDENT">ch</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <span class="UIDENT">None</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-translate_patch"><span class="LIDENT">translate_patch</span></span> <span class="TILDE">~</span><span id="local_dir_397"><span class="LIDENT">dir</span></span> <span id="local_orig_398"><span class="LIDENT">orig</span></span> <span id="local_corrected_399"><span class="LIDENT">corrected</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="COMMENT">(* It's unnecessarily complicated to infer whether the entire file is CRLF
     encoded and also the status of individual files, so accept scanning the
     file three times instead of two. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_log_400"><span class="LIDENT">log</span></span> <span class="QUESTION">?</span><span id="local_level_401"><span class="LIDENT">level</span></span> <span id="local_fmt_402"><span class="LIDENT">fmt</span></span> <span class="EQUAL">=</span> <a href="opamConsole.ml.html#val-log"><span class="UIDENT">OpamConsole</span><span class="DOT">.</span><span class="LIDENT">log</span></a> <span class="STRING">&quot;PATCH&quot;</span> <span class="QUESTION">?</span><a href="#local_level_401"><span class="LIDENT">level</span></a> <a href="#local_fmt_402"><span class="LIDENT">fmt</span></a> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_strip_cr_403"><span class="LIDENT">strip_cr</span></span> <span class="EQUAL">=</span> <span class="LIDENT">get_eol_encoding</span> <a href="#local_orig_398"><span class="LIDENT">orig</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="UIDENT">Some</span> <span class="TRUE">true</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_ch_404"><span class="LIDENT">ch</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="TRY">try</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-open_in_bin"><span class="LIDENT">open_in_bin</span></a> <a href="#local_orig_398"><span class="LIDENT">orig</span></a><span class="EOL">
</span>    <span class="WITH">with</span> <span class="UIDENT">Sys_error</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-raise"><span class="LIDENT">raise</span></a> <span class="LPAREN">(</span><span class="UIDENT">File_not_found</span> <a href="#local_orig_398"><span class="LIDENT">orig</span></a><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <span class="COMMENT">(* CRLF detection with patching can be more complicated than that used here,
     especially in the presence of files with mixed LF/CRLF endings. The
     processing done here aims to allow patching to succeed on files which are
     wholly encoded CRLF or LF against patches which may have been translated to
     be the opposite.

     The resulting patch will *always* have LF line endings for the patch
     metadata (headers, chunk locations, etc.) but uses either CRLF or LF
     depending on the target file. Endings in the patch are always preserved for
     new files. The benefit of always using LF endings for the metadata is that
     patch's &quot;Stripping trailing CRs from patch&quot; behaviour won't be triggered.

     There are various patch formats, though only the Unified and Context
     formats allow multiple files to be patched. I tired of trying to get
     sufficient documented detail of Context diffs to be able to parse them
     without resorting to reverse-engineering code. It is unusual to see them
     these days, so for now opam just emits a warning if a Context diff file is
     encountered and does no processing to it.

     There are various semantic aspects of Unified diffs which are not handled
     (at least at present) by this function which are documented in the code
     with the marker &quot;Weakness&quot;. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_process_chunk_header_405"><span class="LIDENT">process_chunk_header</span></span> <span id="local_result_406"><span class="LIDENT">result</span></span> <span id="local_line_407"><span class="LIDENT">line</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="opamStd.ml.html#module-OpamString.val-split"><span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">String</span><span class="DOT">.</span><span class="LIDENT">split</span></a> <a href="#local_line_407"><span class="LIDENT">line</span></a> <span class="CHAR">' '</span> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="STRING">&quot;@@&quot;</span><span class="COLONCOLON">::</span><span id="local_a_408"><span class="LIDENT">a</span></span><span class="COLONCOLON">::</span><span id="local_b_409"><span class="LIDENT">b</span></span><span class="COLONCOLON">::</span><span class="STRING">&quot;@@&quot;</span><span class="COLONCOLON">::</span><span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="COMMENT">(* Weakness: for a new file [a] should always be -0,0 (not checked) *)</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_l_a_410"><span class="LIDENT">l_a</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/string.ml.html#val-length"><span class="UIDENT">String</span><span class="DOT">.</span><span class="LIDENT">length</span></a> <a href="#local_a_408"><span class="LIDENT">a</span></a> <span class="IN">in</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_l_b_411"><span class="LIDENT">l_b</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/string.ml.html#val-length"><span class="UIDENT">String</span><span class="DOT">.</span><span class="LIDENT">length</span></a> <a href="#local_b_409"><span class="LIDENT">b</span></a> <span class="IN">in</span><span class="EOL">
</span>        <span class="IF">if</span> <a href="#local_l_a_410"><span class="LIDENT">l_a</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <span class="INT">1</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&amp;&amp;)"><span class="AMPERAMPER">&amp;&amp;</span></a> <a href="#local_l_b_411"><span class="LIDENT">l_b</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <span class="INT">1</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&amp;&amp;)"><span class="AMPERAMPER">&amp;&amp;</span></a> <a href="#local_a_408"><span class="LIDENT">a</span></a><span class="DOT">.</span><span class="LBRACKET">[</span><span class="INT">0</span><span class="RBRACKET">]</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="CHAR">'-'</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&amp;&amp;)"><span class="AMPERAMPER">&amp;&amp;</span></a> <a href="#local_b_409"><span class="LIDENT">b</span></a><span class="DOT">.</span><span class="LBRACKET">[</span><span class="INT">0</span><span class="RBRACKET">]</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="CHAR">'+'</span> <span class="THEN">then</span><span class="EOL">
</span>          <span class="TRY">try</span><span class="EOL">
</span>            <span class="LET">let</span> <span id="local_f_412"><span class="LIDENT">f</span></span> <span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span id="local_v_413"><span class="LIDENT">v</span></span><span class="RPAREN">)</span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-int_of_string"><span class="LIDENT">int_of_string</span></a> <a href="#local_v_413"><span class="LIDENT">v</span></a> <span class="IN">in</span><span class="EOL">
</span>            <span class="LET">let</span> <span id="local_neg_414"><span class="LIDENT">neg</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>              <a href="opamStd.ml.html#module-OpamString.val-cut_at"><span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">String</span><span class="DOT">.</span><span class="LIDENT">cut_at</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/string.ml.html#val-sub"><span class="UIDENT">String</span><span class="DOT">.</span><span class="LIDENT">sub</span></a> <a href="#local_a_408"><span class="LIDENT">a</span></a> <span class="INT">1</span> <span class="LPAREN">(</span><a href="#local_l_a_410"><span class="LIDENT">l_a</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <span class="INT">1</span><span class="RPAREN">)</span><span class="RPAREN">)</span> <span class="CHAR">','</span><span class="EOL">
</span>                      <span class="INFIXOP0">|&gt;</span> <a href="opamStd.ml.html#module-Option.val-map_default"><span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">Option</span><span class="DOT">.</span><span class="LIDENT">map_default</span></a> <a href="#local_f_412"><span class="LIDENT">f</span></a> <span class="INT">1</span><span class="EOL">
</span>            <span class="IN">in</span><span class="EOL">
</span>            <span class="LET">let</span> <span id="local_pos_415"><span class="LIDENT">pos</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>              <a href="opamStd.ml.html#module-OpamString.val-cut_at"><span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">String</span><span class="DOT">.</span><span class="LIDENT">cut_at</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/string.ml.html#val-sub"><span class="UIDENT">String</span><span class="DOT">.</span><span class="LIDENT">sub</span></a> <a href="#local_b_409"><span class="LIDENT">b</span></a> <span class="INT">1</span> <span class="LPAREN">(</span><a href="#local_l_b_411"><span class="LIDENT">l_b</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <span class="INT">1</span><span class="RPAREN">)</span><span class="RPAREN">)</span> <span class="CHAR">','</span><span class="EOL">
</span>                      <span class="INFIXOP0">|&gt;</span> <a href="opamStd.ml.html#module-Option.val-map_default"><span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">Option</span><span class="DOT">.</span><span class="LIDENT">map_default</span></a> <a href="#local_f_412"><span class="LIDENT">f</span></a> <span class="INT">1</span><span class="EOL">
</span>            <span class="IN">in</span><span class="EOL">
</span>            <a href="#local_result_406"><span class="LIDENT">result</span></a> <a href="#local_neg_414"><span class="LIDENT">neg</span></a> <a href="#local_pos_415"><span class="LIDENT">pos</span></a><span class="EOL">
</span>          <span class="WITH">with</span> <span id="local_e_416"><span class="LIDENT">e</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <a href="opamStd.ml.html#module-Exn.val-fatal"><span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">Exn</span><span class="DOT">.</span><span class="LIDENT">fatal</span></a> <a href="#local_e_416"><span class="LIDENT">e</span></a><span class="SEMI">;</span><span class="EOL">
</span>            <span class="COMMENT">(* TODO Should display some kind of re-sync warning *)</span><span class="EOL">
</span>            <span class="BACKQUOTE">`</span><span class="UIDENT">Header</span><span class="EOL">
</span>        <span class="ELSE">else</span><span class="EOL">
</span>          <span class="COMMENT">(* TODO Should display some kind of re-sync warning *)</span><span class="EOL">
</span>          <span class="BACKQUOTE">`</span><span class="UIDENT">Header</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="COMMENT">(* TODO Should display some kind of warning that there were no chunks *)</span><span class="EOL">
</span>        <span class="BACKQUOTE">`</span><span class="UIDENT">Header</span><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_process_state_transition_417"><span class="LIDENT">process_state_transition</span></span> <span id="local_next_state_418"><span class="LIDENT">next_state</span></span> <span id="local_state_419"><span class="LIDENT">state</span></span> <span id="local_transforms_420"><span class="LIDENT">transforms</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="MATCH">match</span> <span class="LPAREN">(</span><a href="#local_state_419"><span class="LIDENT">state</span></a><span class="COMMA">,</span> <a href="#local_next_state_418"><span class="LIDENT">next_state</span></a><span class="RPAREN">)</span> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="LPAREN">(</span><span class="BACKQUOTE">`</span><span class="UIDENT">Processing</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Processing</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <a href="#local_transforms_420"><span class="LIDENT">transforms</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="LPAREN">(</span><span class="BACKQUOTE">`</span><span class="UIDENT">Processing</span> <span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span id="local_target_421"><span class="LIDENT">target</span></span><span class="COMMA">,</span> <span id="local_crlf_422"><span class="LIDENT">crlf</span></span><span class="COMMA">,</span> <span id="local_patch_crlf_423"><span class="LIDENT">patch_crlf</span></span><span class="COMMA">,</span> <span id="local_chunks_424"><span class="LIDENT">chunks</span></span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_compute_transform_425"><span class="LIDENT">compute_transform</span></span> <span id="local_patch_crlf_426"><span class="LIDENT">patch_crlf</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>          <span class="COMMENT">(* Emit the patch *)</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_transform_427"><span class="LIDENT">transform</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <span class="MATCH">match</span> <span class="LPAREN">(</span><a href="#local_crlf_422"><span class="LIDENT">crlf</span></a><span class="COMMA">,</span> <a href="#local_patch_crlf_426"><span class="LIDENT">patch_crlf</span></a><span class="RPAREN">)</span> <span class="WITH">with</span><span class="EOL">
</span>            <span class="BAR">|</span> <span class="LPAREN">(</span><span class="UIDENT">None</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span><span class="EOL">
</span>            <span class="BAR">|</span> <span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UIDENT">None</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>                <a href="#local_log_400"><span class="LIDENT">log</span></a> <span class="LABEL">~level:</span><span class="INT">3</span> <span class="STRING">&quot;CRLF adaptation skipped for %s&quot;</span> <a href="#local_target_421"><span class="LIDENT">target</span></a><span class="SEMI">;</span><span class="EOL">
</span>                <span class="UIDENT">None</span><span class="EOL">
</span>            <span class="BAR">|</span> <span class="LPAREN">(</span><span class="UIDENT">Some</span> <span id="local_crlf_428"><span class="LIDENT">crlf</span></span><span class="COMMA">,</span> <span class="UIDENT">Some</span> <span id="local_patch_crlf_429"><span class="LIDENT">patch_crlf</span></span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>                <span class="IF">if</span> <a href="#local_crlf_428"><span class="LIDENT">crlf</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <a href="#local_patch_crlf_429"><span class="LIDENT">patch_crlf</span></a> <span class="THEN">then</span> <span class="BEGIN">begin</span><span class="EOL">
</span>                  <a href="#local_log_400"><span class="LIDENT">log</span></a> <span class="LABEL">~level:</span><span class="INT">3</span> <span class="STRING">&quot;No CRLF adaptation necessary for %s&quot;</span> <a href="#local_target_421"><span class="LIDENT">target</span></a><span class="SEMI">;</span><span class="EOL">
</span>                  <span class="UIDENT">None</span><span class="EOL">
</span>                <span class="END">end</span> <span class="ELSE">else</span> <span class="IF">if</span> <a href="#local_crlf_428"><span class="LIDENT">crlf</span></a> <span class="THEN">then</span> <span class="BEGIN">begin</span><span class="EOL">
</span>                  <a href="#local_log_400"><span class="LIDENT">log</span></a> <span class="LABEL">~level:</span><span class="INT">3</span> <span class="STRING">&quot;Adding \\r to patch chunks for %s&quot;</span> <a href="#local_target_421"><span class="LIDENT">target</span></a><span class="SEMI">;</span><span class="EOL">
</span>                  <span class="UIDENT">Some</span> <span class="TRUE">true</span><span class="EOL">
</span>                <span class="END">end</span> <span class="ELSE">else</span> <span class="BEGIN">begin</span><span class="EOL">
</span>                  <a href="#local_log_400"><span class="LIDENT">log</span></a> <span class="LABEL">~level:</span><span class="INT">3</span> <span class="STRING">&quot;Stripping \\r to patch chunks for %s&quot;</span> <a href="#local_target_421"><span class="LIDENT">target</span></a><span class="SEMI">;</span><span class="EOL">
</span>                  <span class="UIDENT">Some</span> <span class="FALSE">false</span><span class="EOL">
</span>                <span class="END">end</span><span class="EOL">
</span>          <span class="IN">in</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_record_transform_430"><span class="LIDENT">record_transform</span></span> <span id="local_transform_431"><span class="LIDENT">transform</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <span class="LET">let</span> <span id="local_augment_record_432"><span class="LIDENT">augment_record</span></span> <span class="LPAREN">(</span><span id="local_first_line_433"><span class="LIDENT">first_line</span></span><span class="COMMA">,</span> <span id="local_last_line_434"><span class="LIDENT">last_line</span></span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>              <span class="LPAREN">(</span><a href="#local_first_line_433"><span class="LIDENT">first_line</span></a><span class="COMMA">,</span> <a href="#local_last_line_434"><span class="LIDENT">last_line</span></a><span class="COMMA">,</span> <a href="#local_transform_431"><span class="LIDENT">transform</span></a><span class="RPAREN">)</span><span class="EOL">
</span>            <span class="IN">in</span><span class="EOL">
</span>            <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-rev_append"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">rev_append</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-rev_map"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">rev_map</span></a> <a href="#local_augment_record_432"><span class="LIDENT">augment_record</span></a> <a href="#local_chunks_424"><span class="LIDENT">chunks</span></a><span class="RPAREN">)</span> <a href="#local_transforms_420"><span class="LIDENT">transforms</span></a><span class="EOL">
</span>          <span class="IN">in</span><span class="EOL">
</span>          <a href="opamStd.ml.html#module-Option.val-map_default"><span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">Option</span><span class="DOT">.</span><span class="LIDENT">map_default</span></a> <a href="#local_record_transform_430"><span class="LIDENT">record_transform</span></a> <a href="#local_transforms_420"><span class="LIDENT">transforms</span></a> <a href="#local_transform_427"><span class="LIDENT">transform</span></a><span class="EOL">
</span>        <span class="IN">in</span><span class="EOL">
</span>        <a href="opamStd.ml.html#module-Option.val-map_default"><span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">Option</span><span class="DOT">.</span><span class="LIDENT">map_default</span></a> <a href="#local_compute_transform_425"><span class="LIDENT">compute_transform</span></a> <a href="#local_transforms_420"><span class="LIDENT">transforms</span></a> <a href="#local_patch_crlf_423"><span class="LIDENT">patch_crlf</span></a><span class="EOL">
</span>     <span class="BAR">|</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <a href="#local_transforms_420"><span class="LIDENT">transforms</span></a><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="REC">rec</span> <span id="local_fold_lines_435"><span class="LIDENT">fold_lines</span></span> <span id="local_state_436"><span class="LIDENT">state</span></span> <span id="local_n_437"><span class="LIDENT">n</span></span> <span id="local_transforms_438"><span class="LIDENT">transforms</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-input_line"><span class="LIDENT">input_line</span></a> <a href="#local_ch_404"><span class="LIDENT">ch</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span id="local_line_439"><span class="LIDENT">line</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_line_440"><span class="LIDENT">line</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>          <span class="IF">if</span> <a href="#local_strip_cr_403"><span class="LIDENT">strip_cr</span></a> <span class="THEN">then</span><span class="EOL">
</span>            <a href="../../../ocaml-base-compiler/src/stdlib/string.ml.html#val-sub"><span class="UIDENT">String</span><span class="DOT">.</span><span class="LIDENT">sub</span></a> <a href="#local_line_439"><span class="LIDENT">line</span></a> <span class="INT">0</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/string.ml.html#val-length"><span class="UIDENT">String</span><span class="DOT">.</span><span class="LIDENT">length</span></a> <a href="#local_line_439"><span class="LIDENT">line</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <span class="INT">1</span><span class="RPAREN">)</span><span class="EOL">
</span>          <span class="ELSE">else</span><span class="EOL">
</span>            <a href="#local_line_439"><span class="LIDENT">line</span></a><span class="EOL">
</span>        <span class="IN">in</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_length_441"><span class="LIDENT">length</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/string.ml.html#val-length"><span class="UIDENT">String</span><span class="DOT">.</span><span class="LIDENT">length</span></a> <a href="#local_line_440"><span class="LIDENT">line</span></a> <span class="IN">in</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_next_state_442"><span class="LIDENT">next_state</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>          <span class="MATCH">match</span> <a href="#local_state_436"><span class="LIDENT">state</span></a> <span class="WITH">with</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Header</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <span class="BEGIN">begin</span><span class="EOL">
</span>              <span class="MATCH">match</span> <span class="LPAREN">(</span><span class="IF">if</span> <a href="#local_length_441"><span class="LIDENT">length</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <span class="INT">4</span> <span class="THEN">then</span> <a href="../../../ocaml-base-compiler/src/stdlib/string.ml.html#val-sub"><span class="UIDENT">String</span><span class="DOT">.</span><span class="LIDENT">sub</span></a> <a href="#local_line_440"><span class="LIDENT">line</span></a> <span class="INT">0</span> <span class="INT">4</span> <span class="ELSE">else</span> <span class="STRING">&quot;&quot;</span><span class="RPAREN">)</span> <span class="WITH">with</span><span class="EOL">
</span>              <span class="BAR">|</span> <span class="STRING">&quot;--- &quot;</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>                  <span class="COMMENT">(* Start of a unified diff header. *)</span><span class="EOL">
</span>                  <span class="LET">let</span> <span id="local_file_443"><span class="LIDENT">file</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>                    <span class="LET">let</span> <span id="local_file_444"><span class="LIDENT">file</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/string.ml.html#val-sub"><span class="UIDENT">String</span><span class="DOT">.</span><span class="LIDENT">sub</span></a> <a href="#local_line_440"><span class="LIDENT">line</span></a> <span class="INT">4</span> <span class="LPAREN">(</span><a href="#local_length_441"><span class="LIDENT">length</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <span class="INT">4</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>                    <span class="LET">let</span> <span class="OPEN">open</span> <a href="opamStd.ml.html"><span class="UIDENT">OpamStd</span></a> <span class="IN">in</span><span class="EOL">
</span>                    <a href="opamStd.ml.html#module-Option.val-map_default"><span class="UIDENT">Option</span><span class="DOT">.</span><span class="LIDENT">map_default</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-fst"><span class="LIDENT">fst</span></a> <a href="#local_file_444"><span class="LIDENT">file</span></a> <span class="LPAREN">(</span><a href="opamStd.ml.html#module-OpamString.val-cut_at"><span class="UIDENT">String</span><span class="DOT">.</span><span class="LIDENT">cut_at</span></a> <a href="#local_file_444"><span class="LIDENT">file</span></a> <span class="CHAR">'\t'</span><span class="RPAREN">)</span><span class="EOL">
</span>                  <span class="IN">in</span><span class="EOL">
</span>                  <span class="COMMENT">(* Weakness: new files are also marked with a time-stamp at
                               the start of the epoch, however it's localised,
                               making it a bit tricky to identify! New files are
                               also identified by their absence on disk, so this
                               weakness isn't particularly critical. *)</span><span class="EOL">
</span>                  <span class="IF">if</span> <a href="#local_file_443"><span class="LIDENT">file</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="STRING">&quot;/dev/null&quot;</span> <span class="THEN">then</span><span class="EOL">
</span>                    <span class="BACKQUOTE">`</span><span class="UIDENT">NewHeader</span><span class="EOL">
</span>                  <span class="ELSE">else</span><span class="EOL">
</span>                    <span class="LET">let</span> <span id="local_target_445"><span class="LIDENT">target</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>                      <a href="opamStd.ml.html#module-OpamString.val-cut_at"><span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">String</span><span class="DOT">.</span><span class="LIDENT">cut_at</span></a> <span class="LPAREN">(</span><span class="LIDENT">back_to_forward</span> <a href="#local_file_443"><span class="LIDENT">file</span></a><span class="RPAREN">)</span> <span class="CHAR">'/'</span><span class="EOL">
</span>                      <span class="INFIXOP0">|&gt;</span> <a href="opamStd.ml.html#module-Option.val-map_default"><span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">Option</span><span class="DOT">.</span><span class="LIDENT">map_default</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-snd"><span class="LIDENT">snd</span></a> <a href="#local_file_443"><span class="LIDENT">file</span></a><span class="EOL">
</span>                      <span class="INFIXOP0">|&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#val-concat"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">concat</span></a> <a href="#local_dir_397"><span class="LIDENT">dir</span></a><span class="EOL">
</span>                    <span class="IN">in</span><span class="EOL">
</span>                    <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-file_exists"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">file_exists</span></a> <a href="#local_target_445"><span class="LIDENT">target</span></a> <span class="THEN">then</span><span class="EOL">
</span>                      <span class="LET">let</span> <span id="local_crlf_446"><span class="LIDENT">crlf</span></span> <span class="EQUAL">=</span> <span class="LIDENT">get_eol_encoding</span> <a href="#local_target_445"><span class="LIDENT">target</span></a> <span class="IN">in</span><span class="EOL">
</span>                      <span class="BACKQUOTE">`</span><span class="UIDENT">Patching</span> <span class="LPAREN">(</span><a href="#local_file_443"><span class="LIDENT">file</span></a><span class="COMMA">,</span> <a href="#local_crlf_446"><span class="LIDENT">crlf</span></a><span class="RPAREN">)</span><span class="EOL">
</span>                    <span class="ELSE">else</span><span class="EOL">
</span>                      <span class="BACKQUOTE">`</span><span class="UIDENT">NewHeader</span><span class="EOL">
</span>              <span class="BAR">|</span> <span class="STRING">&quot;*** &quot;</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>                  <a href="opamConsole.ml.html#val-warning"><span class="UIDENT">OpamConsole</span><span class="DOT">.</span><span class="LIDENT">warning</span></a> <span class="STRING">&quot;File %s uses context diffs which are \
                                       less portable; consider using unified \
                                       diffs&quot;</span> <a href="#local_orig_398"><span class="LIDENT">orig</span></a><span class="SEMI">;</span><span class="EOL">
</span>                  <span class="BACKQUOTE">`</span><span class="UIDENT">SkipFile</span><span class="EOL">
</span>              <span class="BAR">|</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>                  <span class="COMMENT">(* Headers will contain other lines, which are ignored (e.g.
                     the diff command which generated the diff, or Git commit
                     messages) *)</span><span class="EOL">
</span>                  <span class="BACKQUOTE">`</span><span class="UIDENT">Header</span><span class="EOL">
</span>            <span class="END">end</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">NewHeader</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>              <span class="IF">if</span> <span class="LPAREN">(</span><span class="IF">if</span> <a href="#local_length_441"><span class="LIDENT">length</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <span class="INT">4</span> <span class="THEN">then</span> <a href="../../../ocaml-base-compiler/src/stdlib/string.ml.html#val-sub"><span class="UIDENT">String</span><span class="DOT">.</span><span class="LIDENT">sub</span></a> <a href="#local_line_440"><span class="LIDENT">line</span></a> <span class="INT">0</span> <span class="INT">4</span> <span class="ELSE">else</span> <span class="STRING">&quot;&quot;</span><span class="RPAREN">)</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="STRING">&quot;+++ &quot;</span> <span class="THEN">then</span><span class="EOL">
</span>                <span class="BACKQUOTE">`</span><span class="UIDENT">New</span><span class="EOL">
</span>              <span class="ELSE">else</span><span class="EOL">
</span>                <span class="COMMENT">(* TODO Should display some kind of re-sync warning *)</span><span class="EOL">
</span>                <span class="BACKQUOTE">`</span><span class="UIDENT">Header</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">New</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>              <a href="#local_process_chunk_header_405"><span class="LIDENT">process_chunk_header</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_neg_447"><span class="LIDENT">neg</span></span> <span id="local_pos_448"><span class="LIDENT">pos</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="BACKQUOTE">`</span><span class="UIDENT">NewChunk</span> <span class="LPAREN">(</span><a href="#local_neg_447"><span class="LIDENT">neg</span></a><span class="COMMA">,</span> <a href="#local_pos_448"><span class="LIDENT">pos</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>                                   <a href="#local_line_440"><span class="LIDENT">line</span></a><span class="EOL">
</span>          <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">NewChunk</span> <span class="LPAREN">(</span><span id="local_neg_449"><span class="LIDENT">neg</span></span><span class="COMMA">,</span> <span id="local_pos_450"><span class="LIDENT">pos</span></span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>              <span class="COMMENT">(* Weakness: new files should only have + lines *)</span><span class="EOL">
</span>              <span class="LET">let</span> <span id="local_neg_451"><span class="LIDENT">neg</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>                <span class="IF">if</span> <a href="#local_line_440"><span class="LIDENT">line</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="STRING">&quot;&quot;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <a href="#local_line_440"><span class="LIDENT">line</span></a><span class="DOT">.</span><span class="LBRACKET">[</span><span class="INT">0</span><span class="RBRACKET">]</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="CHAR">' '</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <a href="#local_line_440"><span class="LIDENT">line</span></a><span class="DOT">.</span><span class="LBRACKET">[</span><span class="INT">0</span><span class="RBRACKET">]</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="CHAR">'-'</span> <span class="THEN">then</span><span class="EOL">
</span>                  <a href="#local_neg_449"><span class="LIDENT">neg</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <span class="INT">1</span><span class="EOL">
</span>                <span class="ELSE">else</span><span class="EOL">
</span>                  <a href="#local_neg_449"><span class="LIDENT">neg</span></a><span class="EOL">
</span>              <span class="IN">in</span><span class="EOL">
</span>              <span class="LET">let</span> <span id="local_pos_452"><span class="LIDENT">pos</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>                <span class="IF">if</span> <a href="#local_line_440"><span class="LIDENT">line</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="STRING">&quot;&quot;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <a href="#local_line_440"><span class="LIDENT">line</span></a><span class="DOT">.</span><span class="LBRACKET">[</span><span class="INT">0</span><span class="RBRACKET">]</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="CHAR">' '</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <a href="#local_line_440"><span class="LIDENT">line</span></a><span class="DOT">.</span><span class="LBRACKET">[</span><span class="INT">0</span><span class="RBRACKET">]</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="CHAR">'+'</span> <span class="THEN">then</span><span class="EOL">
</span>                  <a href="#local_pos_450"><span class="LIDENT">pos</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <span class="INT">1</span><span class="EOL">
</span>                <span class="ELSE">else</span><span class="EOL">
</span>                  <a href="#local_pos_450"><span class="LIDENT">pos</span></a><span class="EOL">
</span>              <span class="IN">in</span><span class="EOL">
</span>              <span class="IF">if</span> <a href="#local_neg_451"><span class="LIDENT">neg</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="INT">0</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&amp;&amp;)"><span class="AMPERAMPER">&amp;&amp;</span></a> <a href="#local_pos_452"><span class="LIDENT">pos</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="INT">0</span> <span class="THEN">then</span><span class="EOL">
</span>                <span class="BACKQUOTE">`</span><span class="UIDENT">New</span><span class="EOL">
</span>              <span class="ELSE">else</span><span class="EOL">
</span>                <span class="COMMENT">(* Weakness: there should only be one chunk for a new file *)</span><span class="EOL">
</span>                <span class="BACKQUOTE">`</span><span class="UIDENT">NewChunk</span> <span class="LPAREN">(</span><a href="#local_neg_451"><span class="LIDENT">neg</span></a><span class="COMMA">,</span> <a href="#local_pos_452"><span class="LIDENT">pos</span></a><span class="RPAREN">)</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Patching</span> <span class="LPAREN">(</span><span id="local_orig_453"><span class="LIDENT">orig</span></span><span class="COMMA">,</span> <span id="local_crlf_454"><span class="LIDENT">crlf</span></span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>              <span class="IF">if</span> <span class="LPAREN">(</span><span class="IF">if</span> <a href="#local_length_441"><span class="LIDENT">length</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <span class="INT">4</span> <span class="THEN">then</span> <a href="../../../ocaml-base-compiler/src/stdlib/string.ml.html#val-sub"><span class="UIDENT">String</span><span class="DOT">.</span><span class="LIDENT">sub</span></a> <a href="#local_line_440"><span class="LIDENT">line</span></a> <span class="INT">0</span> <span class="INT">4</span> <span class="ELSE">else</span> <span class="STRING">&quot;&quot;</span><span class="RPAREN">)</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="STRING">&quot;+++ &quot;</span> <span class="THEN">then</span><span class="EOL">
</span>                <span class="LET">let</span> <span id="local_file_455"><span class="LIDENT">file</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>                  <span class="LET">let</span> <span id="local_file_456"><span class="LIDENT">file</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/string.ml.html#val-sub"><span class="UIDENT">String</span><span class="DOT">.</span><span class="LIDENT">sub</span></a> <a href="#local_line_440"><span class="LIDENT">line</span></a> <span class="INT">4</span> <span class="LPAREN">(</span><a href="#local_length_441"><span class="LIDENT">length</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <span class="INT">4</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>                  <span class="LET">let</span> <span class="OPEN">open</span> <a href="opamStd.ml.html"><span class="UIDENT">OpamStd</span></a> <span class="IN">in</span><span class="EOL">
</span>                  <a href="opamStd.ml.html#module-Option.val-map_default"><span class="UIDENT">Option</span><span class="DOT">.</span><span class="LIDENT">map_default</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-fst"><span class="LIDENT">fst</span></a> <a href="#local_file_456"><span class="LIDENT">file</span></a> <span class="LPAREN">(</span><a href="opamStd.ml.html#module-OpamString.val-cut_at"><span class="UIDENT">String</span><span class="DOT">.</span><span class="LIDENT">cut_at</span></a> <a href="#local_file_456"><span class="LIDENT">file</span></a> <span class="CHAR">'\t'</span><span class="RPAREN">)</span><span class="EOL">
</span>                <span class="IN">in</span><span class="EOL">
</span>                <span class="BACKQUOTE">`</span><span class="UIDENT">Processing</span> <span class="LPAREN">(</span><a href="#local_orig_453"><span class="LIDENT">orig</span></a><span class="COMMA">,</span> <a href="#local_file_455"><span class="LIDENT">file</span></a><span class="COMMA">,</span> <a href="#local_crlf_454"><span class="LIDENT">crlf</span></a><span class="COMMA">,</span> <span class="UIDENT">None</span><span class="COMMA">,</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span><span class="COMMA">,</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Head</span><span class="RPAREN">)</span><span class="EOL">
</span>              <span class="ELSE">else</span><span class="EOL">
</span>                <span class="BACKQUOTE">`</span><span class="UIDENT">Header</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Processing</span> <span class="LPAREN">(</span><span id="local_orig_457"><span class="LIDENT">orig</span></span><span class="COMMA">,</span> <span id="local_target_458"><span class="LIDENT">target</span></span><span class="COMMA">,</span> <span id="local_crlf_459"><span class="LIDENT">crlf</span></span><span class="COMMA">,</span> <span id="local_patch_crlf_460"><span class="LIDENT">patch_crlf</span></span><span class="COMMA">,</span> <span id="local_chunks_461"><span class="LIDENT">chunks</span></span><span class="COMMA">,</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Head</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>              <span class="IF">if</span> <a href="#local_line_440"><span class="LIDENT">line</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="STRING">&quot;\\ No newline at end of file&quot;</span> <span class="THEN">then</span><span class="EOL">
</span>                <span class="COMMENT">(* If the no eol-at-eof indicator is found, never add \r to
                   final chunk line *)</span><span class="EOL">
</span>                <span class="LET">let</span> <span id="local_chunks_462"><span class="LIDENT">chunks</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>                  <span class="MATCH">match</span> <a href="#local_chunks_461"><span class="LIDENT">chunks</span></a> <span class="WITH">with</span><span class="EOL">
</span>                  <span class="BAR">|</span> <span class="LPAREN">(</span><span id="local_a_463"><span class="LIDENT">a</span></span><span class="COMMA">,</span> <span id="local_b_464"><span class="LIDENT">b</span></span><span class="RPAREN">)</span><span class="COLONCOLON">::</span><span id="local_chunks_465"><span class="LIDENT">chunks</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>                      <span class="LPAREN">(</span><a href="#local_a_463"><span class="LIDENT">a</span></a><span class="COMMA">,</span> <a href="#local_b_464"><span class="LIDENT">b</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <span class="INT">1</span><span class="RPAREN">)</span><span class="COLONCOLON">::</span><a href="#local_chunks_465"><span class="LIDENT">chunks</span></a><span class="EOL">
</span>                  <span class="BAR">|</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>                      <a href="#local_chunks_461"><span class="LIDENT">chunks</span></a><span class="EOL">
</span>                <span class="IN">in</span><span class="EOL">
</span>                <span class="BACKQUOTE">`</span><span class="UIDENT">Processing</span> <span class="LPAREN">(</span><a href="#local_orig_457"><span class="LIDENT">orig</span></a><span class="COMMA">,</span> <a href="#local_target_458"><span class="LIDENT">target</span></a><span class="COMMA">,</span> <a href="#local_crlf_459"><span class="LIDENT">crlf</span></a><span class="COMMA">,</span> <a href="#local_patch_crlf_460"><span class="LIDENT">patch_crlf</span></a><span class="COMMA">,</span> <a href="#local_chunks_462"><span class="LIDENT">chunks</span></a><span class="COMMA">,</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Head</span><span class="RPAREN">)</span><span class="EOL">
</span>             <span class="ELSE">else</span><span class="EOL">
</span>                <a href="#local_process_chunk_header_405"><span class="LIDENT">process_chunk_header</span></a><span class="EOL">
</span>                  <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_neg_466"><span class="LIDENT">neg</span></span> <span id="local_pos_467"><span class="LIDENT">pos</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>                     <span class="BACKQUOTE">`</span><span class="UIDENT">Processing</span> <span class="LPAREN">(</span><a href="#local_orig_457"><span class="LIDENT">orig</span></a><span class="COMMA">,</span> <a href="#local_target_458"><span class="LIDENT">target</span></a><span class="COMMA">,</span> <a href="#local_crlf_459"><span class="LIDENT">crlf</span></a><span class="COMMA">,</span> <a href="#local_patch_crlf_460"><span class="LIDENT">patch_crlf</span></a><span class="COMMA">,</span> <a href="#local_chunks_461"><span class="LIDENT">chunks</span></a><span class="COMMA">,</span><span class="EOL">
</span>                                  <span class="BACKQUOTE">`</span><span class="UIDENT">Chunk</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-succ"><span class="LIDENT">succ</span></a> <a href="#local_n_437"><span class="LIDENT">n</span></a><span class="COMMA">,</span> <a href="#local_neg_466"><span class="LIDENT">neg</span></a><span class="COMMA">,</span> <a href="#local_pos_467"><span class="LIDENT">pos</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>                  <a href="#local_line_440"><span class="LIDENT">line</span></a><span class="EOL">
</span>          <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Processing</span> <span class="LPAREN">(</span><span id="local_orig_468"><span class="LIDENT">orig</span></span><span class="COMMA">,</span> <span id="local_target_469"><span class="LIDENT">target</span></span><span class="COMMA">,</span> <span id="local_crlf_470"><span class="LIDENT">crlf</span></span><span class="COMMA">,</span> <span id="local_patch_crlf_471"><span class="LIDENT">patch_crlf</span></span><span class="COMMA">,</span> <span id="local_chunks_472"><span class="LIDENT">chunks</span></span><span class="COMMA">,</span><span class="EOL">
</span>                         <span class="BACKQUOTE">`</span><span class="UIDENT">Chunk</span> <span class="LPAREN">(</span><span id="local_first_line_473"><span class="LIDENT">first_line</span></span><span class="COMMA">,</span> <span id="local_neg_474"><span class="LIDENT">neg</span></span><span class="COMMA">,</span> <span id="local_pos_475"><span class="LIDENT">pos</span></span><span class="RPAREN">)</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>              <span class="LET">let</span> <span id="local_neg_476"><span class="LIDENT">neg</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>                <span class="IF">if</span> <a href="#local_line_440"><span class="LIDENT">line</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="STRING">&quot;&quot;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <a href="#local_line_440"><span class="LIDENT">line</span></a><span class="DOT">.</span><span class="LBRACKET">[</span><span class="INT">0</span><span class="RBRACKET">]</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="CHAR">' '</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <a href="#local_line_440"><span class="LIDENT">line</span></a><span class="DOT">.</span><span class="LBRACKET">[</span><span class="INT">0</span><span class="RBRACKET">]</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="CHAR">'-'</span> <span class="THEN">then</span><span class="EOL">
</span>                  <a href="#local_neg_474"><span class="LIDENT">neg</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <span class="INT">1</span><span class="EOL">
</span>                <span class="ELSE">else</span><span class="EOL">
</span>                  <a href="#local_neg_474"><span class="LIDENT">neg</span></a><span class="EOL">
</span>              <span class="IN">in</span><span class="EOL">
</span>              <span class="LET">let</span> <span id="local_pos_477"><span class="LIDENT">pos</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>                <span class="IF">if</span> <a href="#local_line_440"><span class="LIDENT">line</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="STRING">&quot;&quot;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <a href="#local_line_440"><span class="LIDENT">line</span></a><span class="DOT">.</span><span class="LBRACKET">[</span><span class="INT">0</span><span class="RBRACKET">]</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="CHAR">' '</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <a href="#local_line_440"><span class="LIDENT">line</span></a><span class="DOT">.</span><span class="LBRACKET">[</span><span class="INT">0</span><span class="RBRACKET">]</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="CHAR">'+'</span> <span class="THEN">then</span><span class="EOL">
</span>                  <a href="#local_pos_475"><span class="LIDENT">pos</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <span class="INT">1</span><span class="EOL">
</span>                <span class="ELSE">else</span><span class="EOL">
</span>                  <a href="#local_pos_475"><span class="LIDENT">pos</span></a><span class="EOL">
</span>              <span class="IN">in</span><span class="EOL">
</span>              <span class="LET">let</span> <span id="local_patch_crlf_478"><span class="LIDENT">patch_crlf</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>                <span class="LET">let</span> <span id="local_has_cr_479"><span class="LIDENT">has_cr</span></span> <span class="EQUAL">=</span> <span class="LPAREN">(</span><a href="#local_length_441"><span class="LIDENT">length</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <span class="INT">0</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&amp;&amp;)"><span class="AMPERAMPER">&amp;&amp;</span></a> <a href="#local_line_440"><span class="LIDENT">line</span></a><span class="DOT">.</span><span class="LBRACKET">[</span><a href="#local_length_441"><span class="LIDENT">length</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <span class="INT">1</span><span class="RBRACKET">]</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="CHAR">'\r'</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>                <span class="MATCH">match</span> <a href="#local_patch_crlf_471"><span class="LIDENT">patch_crlf</span></a> <span class="WITH">with</span><span class="EOL">
</span>                <span class="BAR">|</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>                    <span class="UIDENT">Some</span> <span class="LPAREN">(</span><span class="UIDENT">Some</span> <a href="#local_has_cr_479"><span class="LIDENT">has_cr</span></a><span class="RPAREN">)</span><span class="EOL">
</span>                <span class="BAR">|</span> <span class="UIDENT">Some</span> <span class="LPAREN">(</span><span class="UIDENT">Some</span> <span id="local_think_cr_480"><span class="LIDENT">think_cr</span></span><span class="RPAREN">)</span> <span class="WHEN">when</span> <a href="#local_think_cr_480"><span class="LIDENT">think_cr</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;&gt;)"><span class="INFIXOP0">&lt;&gt;</span></a> <a href="#local_has_cr_479"><span class="LIDENT">has_cr</span></a> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>                    <a href="#local_log_400"><span class="LIDENT">log</span></a> <span class="LABEL">~level:</span><span class="INT">2</span> <span class="STRING">&quot;Patch adaptation disabled for %s: \
                                  mixed endings or binary file&quot;</span> <a href="#local_target_469"><span class="LIDENT">target</span></a><span class="SEMI">;</span><span class="EOL">
</span>                    <span class="UIDENT">Some</span> <span class="UIDENT">None</span><span class="EOL">
</span>                <span class="BAR">|</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>                    <a href="#local_patch_crlf_471"><span class="LIDENT">patch_crlf</span></a><span class="EOL">
</span>              <span class="IN">in</span><span class="EOL">
</span>              <span class="IF">if</span> <a href="#local_neg_476"><span class="LIDENT">neg</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="INT">0</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&amp;&amp;)"><span class="AMPERAMPER">&amp;&amp;</span></a> <a href="#local_pos_477"><span class="LIDENT">pos</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="INT">0</span> <span class="THEN">then</span><span class="EOL">
</span>                <span class="LET">let</span> <span id="local_chunks_481"><span class="LIDENT">chunks</span></span> <span class="EQUAL">=</span> <span class="LPAREN">(</span><a href="#local_first_line_473"><span class="LIDENT">first_line</span></a><span class="COMMA">,</span> <a href="#local_n_437"><span class="LIDENT">n</span></a><span class="RPAREN">)</span><span class="COLONCOLON">::</span><a href="#local_chunks_472"><span class="LIDENT">chunks</span></a> <span class="IN">in</span><span class="EOL">
</span>                <span class="BACKQUOTE">`</span><span class="UIDENT">Processing</span> <span class="LPAREN">(</span><a href="#local_orig_468"><span class="LIDENT">orig</span></a><span class="COMMA">,</span> <a href="#local_target_469"><span class="LIDENT">target</span></a><span class="COMMA">,</span> <a href="#local_crlf_470"><span class="LIDENT">crlf</span></a><span class="COMMA">,</span> <a href="#local_patch_crlf_478"><span class="LIDENT">patch_crlf</span></a><span class="COMMA">,</span> <a href="#local_chunks_481"><span class="LIDENT">chunks</span></a><span class="COMMA">,</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Head</span><span class="RPAREN">)</span><span class="EOL">
</span>              <span class="ELSE">else</span><span class="EOL">
</span>                <span class="BACKQUOTE">`</span><span class="UIDENT">Processing</span> <span class="LPAREN">(</span><a href="#local_orig_468"><span class="LIDENT">orig</span></a><span class="COMMA">,</span> <a href="#local_target_469"><span class="LIDENT">target</span></a><span class="COMMA">,</span> <a href="#local_crlf_470"><span class="LIDENT">crlf</span></a><span class="COMMA">,</span> <a href="#local_patch_crlf_478"><span class="LIDENT">patch_crlf</span></a><span class="COMMA">,</span> <a href="#local_chunks_472"><span class="LIDENT">chunks</span></a><span class="COMMA">,</span><span class="EOL">
</span>                             <span class="BACKQUOTE">`</span><span class="UIDENT">Chunk</span> <span class="LPAREN">(</span><a href="#local_first_line_473"><span class="LIDENT">first_line</span></a><span class="COMMA">,</span> <a href="#local_neg_476"><span class="LIDENT">neg</span></a><span class="COMMA">,</span> <a href="#local_pos_477"><span class="LIDENT">pos</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">SkipFile</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>              <span class="BACKQUOTE">`</span><span class="UIDENT">SkipFile</span><span class="EOL">
</span>        <span class="IN">in</span><span class="EOL">
</span>        <span class="IF">if</span> <a href="#local_next_state_442"><span class="LIDENT">next_state</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="BACKQUOTE">`</span><span class="UIDENT">SkipFile</span> <span class="THEN">then</span><span class="EOL">
</span>          <span class="LBRACKET">[</span><span class="RBRACKET">]</span><span class="EOL">
</span>        <span class="ELSE">else</span><span class="EOL">
</span>          <a href="#local_process_state_transition_417"><span class="LIDENT">process_state_transition</span></a> <a href="#local_next_state_442"><span class="LIDENT">next_state</span></a> <a href="#local_state_436"><span class="LIDENT">state</span></a> <a href="#local_transforms_438"><span class="LIDENT">transforms</span></a><span class="EOL">
</span>            <span class="INFIXOP0">|&gt;</span> <a href="#local_fold_lines_435"><span class="LIDENT">fold_lines</span></a> <a href="#local_next_state_442"><span class="LIDENT">next_state</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-succ"><span class="LIDENT">succ</span></a> <a href="#local_n_437"><span class="LIDENT">n</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="EXCEPTION">exception</span> <span class="UIDENT">End_of_file</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <a href="#local_process_state_transition_417"><span class="LIDENT">process_state_transition</span></a> <span class="BACKQUOTE">`</span><span class="UIDENT">Header</span> <a href="#local_state_436"><span class="LIDENT">state</span></a> <a href="#local_transforms_438"><span class="LIDENT">transforms</span></a> <span class="INFIXOP0">|&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-rev"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">rev</span></a><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_transforms_482"><span class="LIDENT">transforms</span></span> <span class="EQUAL">=</span> <a href="#local_fold_lines_435"><span class="LIDENT">fold_lines</span></a> <span class="BACKQUOTE">`</span><span class="UIDENT">Header</span> <span class="INT">1</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="#local_transforms_482"><span class="LIDENT">transforms</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="THEN">then</span><span class="EOL">
</span>    <span class="LIDENT">copy_file</span> <a href="#local_orig_398"><span class="LIDENT">orig</span></a> <a href="#local_corrected_399"><span class="LIDENT">corrected</span></a><span class="EOL">
</span>  <span class="ELSE">else</span> <span class="BEGIN">begin</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-seek_in"><span class="LIDENT">seek_in</span></a> <a href="#local_ch_404"><span class="LIDENT">ch</span></a> <span class="INT">0</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_ch_out_483"><span class="LIDENT">ch_out</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="TRY">try</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-open_out_bin"><span class="LIDENT">open_out_bin</span></a> <a href="#local_corrected_399"><span class="LIDENT">corrected</span></a><span class="EOL">
</span>      <span class="WITH">with</span> <span class="UIDENT">Sys_error</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-close_in"><span class="LIDENT">close_in</span></a> <a href="#local_ch_404"><span class="LIDENT">ch</span></a><span class="SEMI">;</span><span class="EOL">
</span>        <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-raise"><span class="LIDENT">raise</span></a> <span class="LPAREN">(</span><span class="UIDENT">File_not_found</span> <a href="#local_corrected_399"><span class="LIDENT">corrected</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="def_535"><span class="LPAREN">(</span><span id="local_normal_484"><span class="LIDENT">normal</span></span><span class="COMMA">,</span> <span id="local_add_cr_485"><span class="LIDENT">add_cr</span></span><span class="COMMA">,</span> <span id="local_strip_cr_486"><span class="LIDENT">strip_cr</span></span><span class="RPAREN">)</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_strip_487"><span class="LIDENT">strip</span></span> <span id="local_n_488"><span class="LIDENT">n</span></span> <span id="local_s_489"><span class="LIDENT">s</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/string.ml.html#val-sub"><span class="UIDENT">String</span><span class="DOT">.</span><span class="LIDENT">sub</span></a> <a href="#local_s_489"><span class="LIDENT">s</span></a> <span class="INT">0</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/string.ml.html#val-length"><span class="UIDENT">String</span><span class="DOT">.</span><span class="LIDENT">length</span></a> <a href="#local_s_489"><span class="LIDENT">s</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <a href="#local_n_488"><span class="LIDENT">n</span></a><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_id_490"><span class="LIDENT">id</span></span> <span id="local_x_491"><span class="LIDENT">x</span></span> <span class="EQUAL">=</span> <a href="#local_x_491"><span class="LIDENT">x</span></a> <span class="IN">in</span><span class="EOL">
</span>      <span class="IF">if</span> <a href="#local_strip_cr_403"><span class="LIDENT">strip_cr</span></a> <span class="THEN">then</span><span class="EOL">
</span>        <span class="LPAREN">(</span><a href="#local_strip_487"><span class="LIDENT">strip</span></a> <span class="INT">1</span><span class="COMMA">,</span> <a href="#local_id_490"><span class="LIDENT">id</span></a><span class="COMMA">,</span> <a href="#local_strip_487"><span class="LIDENT">strip</span></a> <span class="INT">2</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="ELSE">else</span><span class="EOL">
</span>        <span class="LPAREN">(</span><a href="#local_id_490"><span class="LIDENT">id</span></a><span class="COMMA">,</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_s_492"><span class="LIDENT">s</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_s_492"><span class="LIDENT">s</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(^)"><span class="INFIXOP1">^</span></a> <span class="STRING">&quot;\r&quot;</span><span class="RPAREN">)</span><span class="COMMA">,</span> <a href="#local_strip_487"><span class="LIDENT">strip</span></a> <span class="INT">1</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="opamConsole.ml.html#val-debug"><span class="UIDENT">OpamConsole</span><span class="DOT">.</span><span class="LIDENT">debug</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="THEN">then</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_log_transform_493"><span class="LIDENT">log_transform</span></span> <span class="LPAREN">(</span><span id="local_first_line_494"><span class="LIDENT">first_line</span></span><span class="COMMA">,</span> <span id="local_last_line_495"><span class="LIDENT">last_line</span></span><span class="COMMA">,</span> <span id="local_add_cr_496"><span class="LIDENT">add_cr</span></span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>         <span class="LET">let</span> <span id="local_indicator_497"><span class="LIDENT">indicator</span></span> <span class="EQUAL">=</span> <span class="IF">if</span> <a href="#local_add_cr_496"><span class="LIDENT">add_cr</span></a> <span class="THEN">then</span> <span class="CHAR">'+'</span> <span class="ELSE">else</span> <span class="CHAR">'-'</span> <span class="IN">in</span><span class="EOL">
</span>         <a href="#local_log_400"><span class="LIDENT">log</span></a> <span class="LABEL">~level:</span><span class="INT">3</span> <span class="STRING">&quot;Transform %d-%d %c\\r&quot;</span> <a href="#local_first_line_494"><span class="LIDENT">first_line</span></a> <a href="#local_last_line_495"><span class="LIDENT">last_line</span></a> <a href="#local_indicator_497"><span class="LIDENT">indicator</span></a><span class="EOL">
</span>      <span class="IN">in</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-iter"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">iter</span></a> <a href="#local_log_transform_493"><span class="LIDENT">log_transform</span></a> <a href="#local_transforms_482"><span class="LIDENT">transforms</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="REC">rec</span> <span id="local_fold_lines_498"><span class="LIDENT">fold_lines</span></span> <span id="local_n_499"><span class="LIDENT">n</span></span> <span id="local_transforms_500"><span class="LIDENT">transforms</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="MATCH">match</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-input_line"><span class="LIDENT">input_line</span></a> <a href="#local_ch_404"><span class="LIDENT">ch</span></a> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span id="local_line_501"><span class="LIDENT">line</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="def_534"><span class="LPAREN">(</span><span id="local_f_502"><span class="LIDENT">f</span></span><span class="COMMA">,</span> <span id="local_transforms_503"><span class="LIDENT">transforms</span></span><span class="RPAREN">)</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <span class="MATCH">match</span> <a href="#local_transforms_500"><span class="LIDENT">transforms</span></a> <span class="WITH">with</span><span class="EOL">
</span>            <span class="BAR">|</span> <span class="LPAREN">(</span><span id="local_first_line_504"><span class="LIDENT">first_line</span></span><span class="COMMA">,</span> <span id="local_last_line_505"><span class="LIDENT">last_line</span></span><span class="COMMA">,</span> <span id="local_add_cr_to_chunks_506"><span class="LIDENT">add_cr_to_chunks</span></span><span class="RPAREN">)</span><span class="COLONCOLON">::</span><span id="local_next_transforms_507"><span class="LIDENT">next_transforms</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>                <span class="LET">let</span> <span id="local_transforms_508"><span class="LIDENT">transforms</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>                  <span class="IF">if</span> <a href="#local_n_499"><span class="LIDENT">n</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <a href="#local_last_line_505"><span class="LIDENT">last_line</span></a> <span class="THEN">then</span><span class="EOL">
</span>                    <a href="#local_next_transforms_507"><span class="LIDENT">next_transforms</span></a><span class="EOL">
</span>                  <span class="ELSE">else</span><span class="EOL">
</span>                    <a href="#local_transforms_500"><span class="LIDENT">transforms</span></a><span class="EOL">
</span>                <span class="IN">in</span><span class="EOL">
</span>                <span class="LET">let</span> <span id="local_f_509"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>                  <span class="IF">if</span> <a href="#local_n_499"><span class="LIDENT">n</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;=)"><span class="INFIXOP0">&gt;=</span></a> <a href="#local_first_line_504"><span class="LIDENT">first_line</span></a> <span class="THEN">then</span><span class="EOL">
</span>                    <span class="IF">if</span> <a href="#local_add_cr_to_chunks_506"><span class="LIDENT">add_cr_to_chunks</span></a> <span class="THEN">then</span><span class="EOL">
</span>                      <a href="#local_add_cr_485"><span class="LIDENT">add_cr</span></a><span class="EOL">
</span>                    <span class="ELSE">else</span><span class="EOL">
</span>                      <a href="#local_strip_cr_486"><span class="LIDENT">strip_cr</span></a><span class="EOL">
</span>                  <span class="ELSE">else</span><span class="EOL">
</span>                    <a href="#local_normal_484"><span class="LIDENT">normal</span></a><span class="EOL">
</span>                <span class="IN">in</span><span class="EOL">
</span>                <span class="LPAREN">(</span><a href="#local_f_509"><span class="LIDENT">f</span></a><span class="COMMA">,</span> <a href="#local_transforms_508"><span class="LIDENT">transforms</span></a><span class="RPAREN">)</span><span class="EOL">
</span>             <span class="BAR">|</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>                 <span class="LPAREN">(</span><a href="#local_normal_484"><span class="LIDENT">normal</span></a><span class="COMMA">,</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span><span class="RPAREN">)</span><span class="EOL">
</span>          <span class="IN">in</span><span class="EOL">
</span>          <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-output_string"><span class="LIDENT">output_string</span></a> <a href="#local_ch_out_483"><span class="LIDENT">ch_out</span></a> <span class="LPAREN">(</span><a href="#local_f_502"><span class="LIDENT">f</span></a> <a href="#local_line_501"><span class="LIDENT">line</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>          <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-output_char"><span class="LIDENT">output_char</span></a> <a href="#local_ch_out_483"><span class="LIDENT">ch_out</span></a> <span class="CHAR">'\n'</span><span class="SEMI">;</span><span class="EOL">
</span>          <a href="#local_fold_lines_498"><span class="LIDENT">fold_lines</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-succ"><span class="LIDENT">succ</span></a> <a href="#local_n_499"><span class="LIDENT">n</span></a><span class="RPAREN">)</span> <a href="#local_transforms_503"><span class="LIDENT">transforms</span></a><span class="EOL">
</span>      <span class="BAR">|</span> <span class="EXCEPTION">exception</span> <span class="UIDENT">End_of_file</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-close_out"><span class="LIDENT">close_out</span></a> <a href="#local_ch_out_483"><span class="LIDENT">ch_out</span></a><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span>    <a href="#local_fold_lines_498"><span class="LIDENT">fold_lines</span></a> <span class="INT">1</span> <a href="#local_transforms_482"><span class="LIDENT">transforms</span></a><span class="EOL">
</span>  <span class="END">end</span><span class="SEMI">;</span><span class="EOL">
</span>  <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-close_in"><span class="LIDENT">close_in</span></a> <a href="#local_ch_404"><span class="LIDENT">ch</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-gpatch"><span class="LIDENT">gpatch</span></span> <span class="EQUAL">=</span> <span class="LAZY">lazy</span> <span class="BEGIN">begin</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="REC">rec</span> <span id="local_search_gpatch_510"><span class="LIDENT">search_gpatch</span></span> <span class="EQUAL">=</span> <span class="FUNCTION">function</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">None</span><span class="EOL">
</span>    <span class="BAR">|</span> <span id="local_patch_cmd_511"><span class="LIDENT">patch_cmd</span></span><span class="COLONCOLON">::</span><span id="local_patch_cmds_512"><span class="LIDENT">patch_cmds</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="MATCH">match</span> <a href="opamProcess.ml.html#val-run"><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="LIDENT">run</span></a> <span class="LPAREN">(</span><span class="LIDENT">make_command</span> <span class="LABEL">~name:</span><span class="STRING">&quot;patch&quot;</span> <a href="#local_patch_cmd_511"><span class="LIDENT">patch_cmd</span></a> <span class="LBRACKET">[</span><span class="STRING">&quot;--version&quot;</span><span class="RBRACKET">]</span><span class="RPAREN">)</span> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span id="local_r_513"><span class="LIDENT">r</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LPAREN">(</span><span class="MATCH">match</span> <a href="opamProcess.ml.html#val-is_success"><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="LIDENT">is_success</span></a> <a href="#local_r_513"><span class="LIDENT">r</span></a><span class="COMMA">,</span> <a href="#local_r_513"><span class="LIDENT">r</span></a><span class="DOT">.</span><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="LIDENT">r_stdout</span> <span class="WITH">with</span><span class="EOL">
</span>         <span class="BAR">|</span> <span class="TRUE">true</span><span class="COMMA">,</span> <span id="local_full_514"><span class="LIDENT">full</span></span><span class="COLONCOLON">::</span><span class="UNDERSCORE">_</span> <span class="WHEN">when</span><span class="EOL">
</span>             <a href="opamStd.ml.html#module-OpamString.val-is_prefix_of"><span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">String</span><span class="DOT">.</span><span class="LIDENT">is_prefix_of</span></a> <span class="LABEL">~from:</span><span class="INT">0</span> <span class="TILDE">~</span><a href="#local_full_514"><span class="LIDENT">full</span></a> <span class="STRING">&quot;GNU patch &quot;</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>           <span class="UIDENT">Some</span> <a href="#local_patch_cmd_511"><span class="LIDENT">patch_cmd</span></a><span class="EOL">
</span>         <span class="BAR">|</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>           <a href="#local_search_gpatch_510"><span class="LIDENT">search_gpatch</span></a> <a href="#local_patch_cmds_512"><span class="LIDENT">patch_cmds</span></a><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="EXCEPTION">exception</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_search_gpatch_510"><span class="LIDENT">search_gpatch</span></a> <a href="#local_patch_cmds_512"><span class="LIDENT">patch_cmds</span></a><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="def_538"><span id="local_default_cmd_515"><span class="LIDENT">default_cmd</span></span><span class="COMMA">,</span> <span id="local_other_cmds_516"><span class="LIDENT">other_cmds</span></span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="opamStd.ml.html#module-OpamSys.val-os"><span class="UIDENT">OpamStd</span><span class="DOT">.</span><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">os</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">DragonFly</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">FreeBSD</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">NetBSD</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">OpenBSD</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="STRING">&quot;gpatch&quot;</span><span class="COMMA">,</span> <span class="LBRACKET">[</span><span class="STRING">&quot;patch&quot;</span><span class="RBRACKET">]</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Cygwin</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Darwin</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Linux</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Unix</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Win32</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Other</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="STRING">&quot;patch&quot;</span><span class="COMMA">,</span> <span class="LBRACKET">[</span><span class="STRING">&quot;gpatch&quot;</span><span class="RBRACKET">]</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <span class="MATCH">match</span> <a href="#local_search_gpatch_510"><span class="LIDENT">search_gpatch</span></a> <span class="LPAREN">(</span><a href="#local_default_cmd_515"><span class="LIDENT">default_cmd</span></a> <span class="COLONCOLON">::</span> <a href="#local_other_cmds_516"><span class="LIDENT">other_cmds</span></a><span class="RPAREN">)</span> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_gpatch_517"><span class="LIDENT">gpatch</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_gpatch_517"><span class="LIDENT">gpatch</span></a><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="opamConsole.ml.html#val-warning"><span class="UIDENT">OpamConsole</span><span class="DOT">.</span><span class="LIDENT">warning</span></a> <span class="STRING">&quot;Invalid patch utility. Please install GNU patch&quot;</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="#local_default_cmd_515"><span class="LIDENT">default_cmd</span></a><span class="EOL">
</span><span class="END">end</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-patch"><span class="LIDENT">patch</span></span> <span class="QUESTION">?</span><span class="LPAREN">(</span><span id="local_preprocess_518"><span class="LIDENT">preprocess</span></span><span class="EQUAL">=</span><span class="TRUE">true</span><span class="RPAREN">)</span> <span class="TILDE">~</span><span id="local_dir_519"><span class="LIDENT">dir</span></span> <span id="local_p_520"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-not"><span class="LIDENT">not</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-file_exists"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">file_exists</span></a> <a href="#local_p_520"><span class="LIDENT">p</span></a><span class="RPAREN">)</span> <span class="THEN">then</span><span class="EOL">
</span>    <span class="LPAREN">(</span><a href="opamConsole.ml.html#val-error"><span class="UIDENT">OpamConsole</span><span class="DOT">.</span><span class="LIDENT">error</span></a> <span class="STRING">&quot;Patch file %S not found.&quot;</span> <a href="#local_p_520"><span class="LIDENT">p</span></a><span class="SEMI">;</span><span class="EOL">
</span>     <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-raise"><span class="LIDENT">raise</span></a> <span class="UIDENT">Not_found</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_p'_521"><span class="LIDENT">p'</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_preprocess_518"><span class="LIDENT">preprocess</span></a> <span class="THEN">then</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_p'_522"><span class="LIDENT">p'</span></span> <span class="EQUAL">=</span> <span class="LIDENT">temp_file</span> <span class="LABEL">~auto_clean:</span><span class="FALSE">false</span> <span class="STRING">&quot;processed-patch&quot;</span> <span class="IN">in</span><span class="EOL">
</span>      <span class="LIDENT">translate_patch</span> <span class="TILDE">~</span><a href="#local_dir_519"><span class="LIDENT">dir</span></a> <a href="#local_p_520"><span class="LIDENT">p</span></a> <a href="#local_p'_522"><span class="LIDENT">p'</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <a href="#local_p'_522"><span class="LIDENT">p'</span></a><span class="EOL">
</span>    <span class="ELSE">else</span><span class="EOL">
</span>      <a href="#local_p_520"><span class="LIDENT">p</span></a><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_patch_cmd_523"><span class="LIDENT">patch_cmd</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/lazy.ml.html#val-force"><span class="UIDENT">Lazy</span><span class="DOT">.</span><span class="LIDENT">force</span></a> <span class="LIDENT">gpatch</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LIDENT">make_command</span> <span class="LABEL">~name:</span><span class="STRING">&quot;patch&quot;</span> <span class="TILDE">~</span><a href="#local_dir_519"><span class="LIDENT">dir</span></a> <a href="#local_patch_cmd_523"><span class="LIDENT">patch_cmd</span></a> <span class="LBRACKET">[</span><span class="STRING">&quot;-p1&quot;</span><span class="SEMI">;</span> <span class="STRING">&quot;-i&quot;</span><span class="SEMI">;</span> <a href="#local_p'_521"><span class="LIDENT">p'</span></a><span class="RBRACKET">]</span> <a href="opamProcess.ml.html#module-Job.module-Op.val-(@@&gt;)"><span class="INFIXOP1">@@&gt;</span></a> <span class="FUN">fun</span> <span id="local_r_524"><span class="LIDENT">r</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-not"><span class="LIDENT">not</span></a> <span class="LPAREN">(</span><a href="opamConsole.ml.html#val-debug"><span class="UIDENT">OpamConsole</span><span class="DOT">.</span><span class="LIDENT">debug</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="RPAREN">)</span> <span class="THEN">then</span> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-remove"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">remove</span></a> <a href="#local_p'_521"><span class="LIDENT">p'</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="opamProcess.ml.html#val-is_success"><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="LIDENT">is_success</span></a> <a href="#local_r_524"><span class="LIDENT">r</span></a> <span class="THEN">then</span> <span class="UIDENT">Done</span> <span class="UIDENT">None</span><span class="EOL">
</span>    <span class="ELSE">else</span> <span class="UIDENT">Done</span> <span class="LPAREN">(</span><span class="UIDENT">Some</span> <span class="LPAREN">(</span><span class="UIDENT">Process_error</span> <a href="#local_r_524"><span class="LIDENT">r</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-register_printer"><span class="LIDENT">register_printer</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="../../../ocaml-base-compiler/src/stdlib/printexc.ml.html#val-register_printer"><span class="UIDENT">Printexc</span><span class="DOT">.</span><span class="LIDENT">register_printer</span></a> <span class="LPAREN">(</span><span class="FUNCTION">function</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Process_error</span> <span id="local_r_525"><span class="LIDENT">r</span></span>     <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Some</span> <span class="LPAREN">(</span><a href="opamProcess.ml.html#val-result_summary"><span class="UIDENT">OpamProcess</span><span class="DOT">.</span><span class="LIDENT">result_summary</span></a> <a href="#local_r_525"><span class="LIDENT">r</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Internal_error</span> <span id="local_m_526"><span class="LIDENT">m</span></span>    <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Some</span> <a href="#local_m_526"><span class="LIDENT">m</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Command_not_found</span> <span id="local_c_527"><span class="LIDENT">c</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Some</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/printf.ml.html#val-sprintf"><span class="UIDENT">Printf</span><span class="DOT">.</span><span class="LIDENT">sprintf</span></a> <span class="STRING">&quot;%S: command not found.&quot;</span> <a href="#local_c_527"><span class="LIDENT">c</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Permission_denied</span> <span id="local_c_528"><span class="LIDENT">c</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Some</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/printf.ml.html#val-sprintf"><span class="UIDENT">Printf</span><span class="DOT">.</span><span class="LIDENT">sprintf</span></a> <span class="STRING">&quot;%S: permission denied.&quot;</span> <a href="#local_c_528"><span class="LIDENT">c</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Sys</span><span class="DOT">.</span><span class="UIDENT">Break</span>           <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Some</span> <span class="STRING">&quot;User interruption&quot;</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">Unix_error</span> <span class="LPAREN">(</span><span id="local_e_529"><span class="LIDENT">e</span></span><span class="COMMA">,</span> <span id="local_fn_530"><span class="LIDENT">fn</span></span><span class="COMMA">,</span> <span id="local_msg_531"><span class="LIDENT">msg</span></span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_msg_532"><span class="LIDENT">msg</span></span> <span class="EQUAL">=</span> <span class="IF">if</span> <a href="#local_msg_531"><span class="LIDENT">msg</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="STRING">&quot;&quot;</span> <span class="THEN">then</span> <span class="STRING">&quot;&quot;</span> <span class="ELSE">else</span> <span class="STRING">&quot; on &quot;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(^)"><span class="INFIXOP1">^</span></a> <a href="#local_msg_531"><span class="LIDENT">msg</span></a> <span class="IN">in</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_error_533"><span class="LIDENT">error</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/printf.ml.html#val-sprintf"><span class="UIDENT">Printf</span><span class="DOT">.</span><span class="LIDENT">sprintf</span></a> <span class="STRING">&quot;%s: %S failed%s: %s&quot;</span><span class="EOL">
</span>          <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-executable_name"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">executable_name</span></a> <a href="#local_fn_530"><span class="LIDENT">fn</span></a> <a href="#local_msg_532"><span class="LIDENT">msg</span></a> <span class="LPAREN">(</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">error_message</span> <a href="#local_e_529"><span class="LIDENT">e</span></a><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>      <span class="UIDENT">Some</span> <a href="#local_error_533"><span class="LIDENT">error</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">None</span><span class="EOL">
</span>  <span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-init"><span class="LIDENT">init</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">register_printer</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>  <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-catch_break"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">catch_break</span></a> <span class="TRUE">true</span><span class="SEMI">;</span><span class="EOL">
</span>  <span class="TRY">try</span> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-set_signal"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">set_signal</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-sigpipe"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">sigpipe</span></a> <span class="LPAREN">(</span><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="UIDENT">Signal_handle</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="WITH">with</span> <span class="UIDENT">Invalid_argument</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span></span></code></pre></body></html>
