<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>driver_dev (b0.driver_dev)</title><meta charset="utf-8"/><link rel="stylesheet" href="../odoc.css"/><meta name="generator" content="odoc %%VERSION%%"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>let base_url = '../';
let search_urls = ['sherlodoc_db.js','../sherlodoc.js'];
</script><script src="../odoc_search.js" defer="defer"></script></head><body class="odoc"><nav class="odoc-nav"><a href="index.html">Up</a> ‚Äì <a href="../index.html">üè†</a> &#x00BB; <a href="index.html">B0  <span class="version">v0.0.5</span></a> &#x00BB; B0 driver development manual</nav><div class="odoc-search"><div class="search-inner"><input class="search-bar" placeholder="üîé Type '/' to search..."/><div class="search-snake"></div><div class="search-result"></div></div></div><header class="odoc-preamble"><h1 id="b0-driver-development-manual"><a href="#b0-driver-development-manual" class="anchor"></a>B0 driver development manual</h1><p>A B0 driver like <code>b0</code> or <code>d0</code> is an executable that provides a service on the definitions of a B0 file. This manual shows how to develop a custom driver for B0 files.</p></header><div class="odoc-tocs"><nav class="odoc-toc odoc-local-toc"><ul><li><a href="#overview">Overview</a></li><li><a href="#library">The driver library</a></li><li><a href="#fixme">FIXME</a></li></ul></nav><nav class="odoc-toc odoc-global-toc"><ul><li><a href="index.html">B0  <span class="version">v0.0.5</span></a><ul><li><a href="b00_manual.html">B00 manual</a></li><li><a href="cmdlet_manual.html">Cmdlet manual</a></li><li><a href="#" class="current_unit">B0 driver development manual</a></li><li><a href="manual.html">B0 manual</a></li><li><a href="old_manual.html">B0 manual</a></li><li><a href="opam.html"><code>opam</code> support manual</a></li><li><a href="rationale.html">Why b0 ?</a></li><li><a href="release.html">B0 release support manual</a></li><li><a href="todo.html">Design considerations and todo</a></li><li><a href="unit_manual.html">Build unit manual</a></li><li>Library <code>b0</code><ul><li><a href="b0/B0_build/index.html">B0_build</a></li><li><a href="b0/B0_cli/index.html">B0_cli</a></li><li><a href="b0/B0_cmdlet/index.html">B0_cmdlet</a></li><li><a href="b0/B0_def/index.html">B0_def</a></li><li><a href="b0/B0_dir/index.html">B0_dir</a></li><li><a href="b0/B0_driver/index.html">B0_driver</a></li><li><a href="b0/B0_file/index.html">B0_file</a></li><li><a href="b0/B0_meta/index.html">B0_meta</a></li><li><a href="b0/B0_pack/index.html">B0_pack</a></li><li><a href="b0/B0_unit/index.html">B0_unit</a></li></ul></li><li>Library <code>b0.b0</code><ul><li><a href="b0.b0/B0_b0/index.html">B0_b0</a></li><li><a href="b0.b0/B0_cmd_build/index.html">B0_cmd_build</a></li><li><a href="b0.b0/B0_cmd_cmd/index.html">B0_cmd_cmd</a></li><li><a href="b0.b0/B0_cmd_cmdlet/index.html">B0_cmd_cmdlet</a></li><li><a href="b0.b0/B0_cmd_delete/index.html">B0_cmd_delete</a></li><li><a href="b0.b0/B0_cmd_file/index.html">B0_cmd_file</a></li><li><a href="b0.b0/B0_cmd_list/index.html">B0_cmd_list</a></li><li><a href="b0.b0/B0_cmd_log/index.html">B0_cmd_log</a></li><li><a href="b0.b0/B0_cmd_pack/index.html">B0_cmd_pack</a></li><li><a href="b0.b0/B0_cmd_root/index.html">B0_cmd_root</a></li><li><a href="b0.b0/B0_cmd_scope/index.html">B0_cmd_scope</a></li><li><a href="b0.b0/B0_cmd_unit/index.html">B0_cmd_unit</a></li><li><a href="b0.b0/B0_main/index.html">B0_main</a></li></ul></li><li>Library <code>b0.b00</code><ul><li><a href="b0.b00/B00/index.html">B00</a></li><li><a href="b0.b00/B000/index.html">B000</a></li><li><a href="b0.b00/B000_conv/index.html">B000_conv</a></li></ul></li><li>Library <code>b0.b00.kit</code><ul><li><a href="b0.b00.kit/B00_base64/index.html">B00_base64</a></li><li><a href="b0.b00.kit/B00_cli/index.html">B00_cli</a></li><li><a href="b0.b00.kit/B00_cmark/index.html">B00_cmark</a></li><li><a href="b0.b00.kit/B00_editor/index.html">B00_editor</a></li><li><a href="b0.b00.kit/B00_fexts/index.html">B00_fexts</a></li><li><a href="b0.b00.kit/B00_findex/index.html">B00_findex</a></li><li><a href="b0.b00.kit/B00_github/index.html">B00_github</a></li><li><a href="b0.b00.kit/B00_htmlg/index.html">B00_htmlg</a></li><li><a href="b0.b00.kit/B00_http/index.html">B00_http</a></li><li><a href="b0.b00.kit/B00_jsoo/index.html">B00_jsoo</a></li><li><a href="b0.b00.kit/B00_lines/index.html">B00_lines</a></li><li><a href="b0.b00.kit/B00_ocaml/index.html">B00_ocaml</a></li><li><a href="b0.b00.kit/B00_odoc/index.html">B00_odoc</a></li><li><a href="b0.b00.kit/B00_os/index.html">B00_os</a></li><li><a href="b0.b00.kit/B00_pager/index.html">B00_pager</a></li><li><a href="b0.b00.kit/B00_pdf_viewer/index.html">B00_pdf_viewer</a></li><li><a href="b0.b00.kit/B00_rsync/index.html">B00_rsync</a></li><li><a href="b0.b00.kit/B00_serialk_json/index.html">B00_serialk_json</a></li><li><a href="b0.b00.kit/B00_serialk_sexp/index.html">B00_serialk_sexp</a></li><li><a href="b0.b00.kit/B00_serialk_text/index.html">B00_serialk_text</a></li><li><a href="b0.b00.kit/B00_trace/index.html">B00_trace</a></li><li><a href="b0.b00.kit/B00_vcs/index.html">B00_vcs</a></li><li><a href="b0.b00.kit/B00_www_browser/index.html">B00_www_browser</a></li></ul></li><li>Library <code>b0.kit</code><ul><li><a href="b0.kit/B0_expect/index.html">B0_expect</a></li><li><a href="b0.kit/B0_jsoo/index.html">B0_jsoo</a></li><li><a href="b0.kit/B0_kit/index.html">B0_kit</a></li><li><a href="b0.kit/B0_ocaml/index.html">B0_ocaml</a></li><li><a href="b0.kit/B0_ocaml_eco/index.html">B0_ocaml_eco</a></li><li><a href="b0.kit/B0_opam/index.html">B0_opam</a></li><li><a href="b0.kit/B0_release/index.html">B0_release</a></li><li><a href="b0.kit/B0_srcs/index.html">B0_srcs</a></li></ul></li><li>Library <code>b0.std</code><ul><li><a href="b0.std/B0_std/index.html">B0_std</a></li></ul></li></ul></li></ul></nav></div><div class="odoc-content"><h2 id="overview"><a href="#overview" class="anchor"></a>Overview</h2><p>The B0 file needs to be compiled and made accessible to the driver executable. At the moment the OCaml <code>Dynlink</code> API is not being used. Instead the driver executable relinks its objects with a compilation of the B0 file to produce another executable that is executed to run the driver on the definitions.</p><p>With the help of the <a href="b0/B0_driver/index.html"><code>B0_driver</code></a> module this all happens transparently in the <code>.drivers</code> directory of the <code>_b0</code> directory.</p><h2 id="library"><a href="#library" class="anchor"></a>The driver library</h2><p>For your driver to access a B0 file you need to create an OCaml library which has all the objects of your driver and registers its <code>main</code> function by calling <a href="b0/B0_driver/index.html#val-set"><code>B0_driver.set</code></a>.</p><p>Source wise a typical driver source structure is:</p><pre class="language-ocaml"><code>src/mydriver_main.ml
src/mydriver_main_run.ml</code></pre><p>The <code>mydriver_main.ml</code> file implements and registers the driver. It's compiled object should be part of your driver library. Here's a minimal example :</p><pre class="language-ocaml"><code>open B0_std
open Cmdliner

let driver =
  let name = &quot;mydriver&quot; and version = &quot;v0.0.5&quot; in
  let libs = [&quot;mydriver&quot; (* other needed libraries can be added here *) ] in
  B0_driver.create ~name ~version ~libs

let my_driver conf = Fmt.pr &quot;Running %s!@.&quot;; B0_driver.Exit.ok
let my_driver =
  let doc = &quot;My driver&quot; in
  let sdocs = Manpage.s_common_options in
  let exits = B0_driver.Exit.Info.base_cmd in
  let man = [ `S Manpage.s_description; &quot;$(mname) does not much.&quot; ] in
  B0_driver.with_b0_file ~driver (Term.const unit_cmd),
  Term.info &quot;mydriver&quot; ~version:&quot;v0.0.5&quot; ~doc ~sdocs ~exits ~man

let main () = Term.eval mydriver
let () = B0_driver.set driver ~main</code></pre><p>The <code>mydriver_main_run.ml</code> file defines your driver executable when it has no B0 file linked in. It's the program that runs your driver without the B0 file linked in. It should simply be:</p><pre class="language-ocaml"><code>let () =
  let module D = Mydriver_main (* make sure we link it *) in
  if !Sys.interactive then () else B0_driver.run ~has_b0_file:false</code></pre><p>A few things to note:</p><ul><li>Your driver library must be installed and available in the <code>OCAMLPATH</code> under the name you gave in to <a href="b0/B0_driver/index.html"><code>B0_driver</code></a>.</li><li>The driver library's directory is not added to the includes for compiling the B0 file. This prevents drivers from adding declarations to the compilation environment since using them in a B0 file would then break other drivers. New declarations must always be explicitely imported in the B0 file by using the <code>#require</code> directive.</li></ul><h2 id="fixme"><a href="#fixme" class="anchor"></a>FIXME</h2><p>The driver dance seems to be a bit slow for now. Even for the up-to-date dance we get into the 43ms <code>b0 unit list</code>. But there's room for improvement. Here are different things to consider that could be done.</p><ul><li>Cold driver compilation. I think we get hit a bit by the executable link phase (globally 500ms, but the compilation spawn takes 480ms). Investigate what makes OCaml linking faster. Maybe a mono cmo ? Alternatively consider using <code>Dylink</code> once it gets lib support, but then what about platforms that don't support it.</li><li>The various timing obtained with <code>b0 file log --stats</code> and <code>b0 -v -v</code> don't add up to what <code>time b0</code> reports. Investigate, is it the execv ? June 2020: maybe it is/was <a href="https://github.com/ocaml/ocaml/issues/9705#issuecomment-649096985">that</a>. Also see how much toplevel init takes (how ?).</li><li>Try to jump directly into the compiled driver executable and let it auto verify and auto recompile if needed ? This could allow to share part of the hash cache in the future.</li><li>Maybe go back to use an ad-hoc stamp for driver compilation rather than use B00 itself.</li></ul></div></body></html>
