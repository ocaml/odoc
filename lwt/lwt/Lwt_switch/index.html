<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Lwt_switch (lwt.lwt.Lwt_switch)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.css"/><meta name="generator" content="odoc %%VERSION%%"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>let base_url = '../../../';
let search_urls = ['../../sherlodoc_db.js','../../../sherlodoc.js'];
</script><script src="../../../odoc_search.js" defer="defer"></script></head><body class="odoc"><nav class="odoc-nav"><a href="../../index.html">Up</a> ‚Äì <a href="../../../index.html">üè†</a> &#x00BB; <a href="../../index.html">Lwt</a> &#x00BB; Library <code>lwt</code> &#x00BB; Lwt_switch</nav><div class="odoc-search"><div class="search-inner"><input class="search-bar" placeholder="üîé Type '/' to search..."/><div class="search-snake"></div><div class="search-result"></div></div></div><header class="odoc-preamble"><h1>Module <code><span>Lwt_switch</span></code><a href="../../src/lwt/lwt_switch.ml.html" class="source_link">Source</a></h1><p>Lwt switches</p></header><div class="odoc-tocs"><nav class="odoc-toc odoc-global-toc"><ul><li><a href="../../index.html">Lwt</a><ul><li>Library <code>lwt</code><ul><li><a href="../Lwt/index.html">Lwt</a></li><li><a href="../Lwt_condition/index.html">Lwt_condition</a></li><li><a href="../Lwt_list/index.html">Lwt_list</a></li><li><a href="../Lwt_mutex/index.html">Lwt_mutex</a></li><li><a href="../Lwt_mvar/index.html">Lwt_mvar</a></li><li><a href="../Lwt_pool/index.html">Lwt_pool</a></li><li><a href="../Lwt_pqueue/index.html">Lwt_pqueue</a></li><li><a href="../Lwt_result/index.html">Lwt_result</a></li><li><a href="../Lwt_seq/index.html">Lwt_seq</a></li><li><a href="../Lwt_sequence/index.html">Lwt_sequence</a></li><li><a href="../Lwt_stream/index.html">Lwt_stream</a></li><li><a href="#" class="current_unit">Lwt_switch</a></li></ul></li><li>Library <code>lwt.unix</code><ul><li><a href="../../lwt.unix/Lwt_bytes/index.html">Lwt_bytes</a></li><li><a href="../../lwt.unix/Lwt_config/index.html">Lwt_config</a></li><li><a href="../../lwt.unix/Lwt_engine/index.html">Lwt_engine</a></li><li><a href="../../lwt.unix/Lwt_features/index.html">Lwt_features</a></li><li><a href="../../lwt.unix/Lwt_fmt/index.html">Lwt_fmt</a></li><li><a href="../../lwt.unix/Lwt_gc/index.html">Lwt_gc</a></li><li><a href="../../lwt.unix/Lwt_io/index.html">Lwt_io</a></li><li><a href="../../lwt.unix/Lwt_main/index.html">Lwt_main</a></li><li><a href="../../lwt.unix/Lwt_preemptive/index.html">Lwt_preemptive</a></li><li><a href="../../lwt.unix/Lwt_process/index.html">Lwt_process</a></li><li><a href="../../lwt.unix/Lwt_sys/index.html">Lwt_sys</a></li><li><a href="../../lwt.unix/Lwt_throttle/index.html">Lwt_throttle</a></li><li><a href="../../lwt.unix/Lwt_timeout/index.html">Lwt_timeout</a></li><li><a href="../../lwt.unix/Lwt_unix/index.html">Lwt_unix</a></li></ul></li><li><a href="../../src/index.html">Sources</a></li></ul></li></ul></nav></div><div class="odoc-content"><p>Switch has two goals:</p><ul><li>being able to free multiple resources at the same time,</li><li>offer a better alternative than always returning an id to free some resource.</li></ul><p>For example, consider the following interface:</p><pre class="language-ocaml"><code>type id

val free : id -&gt; unit Lwt.t

val f : unit -&gt; id Lwt.t
val g : unit -&gt; id Lwt.t
val h : unit -&gt; id Lwt.t</code></pre><p>Now you want to call <code>f</code>, <code>g</code> and <code>h</code> in parallel. You can simply do:</p><pre class="language-ocaml"><code>lwt idf = f () and idg = g () and idh = h () in
...</code></pre><p>However, one may want to handle possible failures of <code>f ()</code>, <code>g ()</code> and <code>h ()</code>, and disable all allocated resources if one of these three threads fails. This may be hard since you have to remember which one failed and which one returned correctly.</p><p>Now if we change the interface a little bit:</p><pre class="language-ocaml"><code>val f : ?switch : Lwt_switch.t -&gt; unit -&gt; id Lwt.t
val g : ?switch : Lwt_switch.t -&gt; unit -&gt; id Lwt.t
val h : ?switch : Lwt_switch.t -&gt; unit -&gt; id Lwt.t</code></pre><p>the code becomes:</p><pre class="language-ocaml"><code>Lwt_switch.with_switch (fun switch -&gt;
  lwt idf = f ~switch ()
  and idg = g ~switch ()
  and idh = h ~switch () in
  ...
)</code></pre><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><a href="../../src/lwt/lwt_switch.ml.html#type-t" class="source_link">Source</a><code><span><span class="keyword">type</span> t</span></code></div><div class="spec-doc"><p>Type of switches.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-create"><a href="#val-create" class="anchor"></a><a href="../../src/lwt/lwt_switch.ml.html#val-create" class="source_link">Source</a><code><span><span class="keyword">val</span> create : <span>unit <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>create ()</code> creates a new switch.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-with_switch"><a href="#val-with_switch" class="anchor"></a><a href="../../src/lwt/lwt_switch.ml.html#val-with_switch" class="source_link">Source</a><code><span><span class="keyword">val</span> with_switch : <span><span>(<span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="../Lwt/index.html#type-t">Lwt.t</a></span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="../Lwt/index.html#type-t">Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>with_switch fn</code> is <code>fn switch</code>, where <code>switch</code> is a fresh switch that is turned off when the callback thread finishes (whether it succeeds or fails).</p><ul class="at-tags"><li class="since"><span class="at-tag">since</span> 2.6.0</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-is_on"><a href="#val-is_on" class="anchor"></a><a href="../../src/lwt/lwt_switch.ml.html#val-is_on" class="source_link">Source</a><code><span><span class="keyword">val</span> is_on : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>is_on switch</code> returns <code>true</code> if the switch is currently on, and <code>false</code> otherwise.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-turn_off"><a href="#val-turn_off" class="anchor"></a><a href="../../src/lwt/lwt_switch.ml.html#val-turn_off" class="source_link">Source</a><code><span><span class="keyword">val</span> turn_off : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <a href="../Lwt/index.html#type-t">Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>turn_off switch</code> turns off the switch. It calls all registered hooks, waits for all of them to terminate, then returns. If one of the hooks failed, it will fail with the exception raised by the hook. If the switch is already off, it does nothing.</p></div></div><div class="odoc-spec"><div class="spec exception anchored" id="exception-Off"><a href="#exception-Off" class="anchor"></a><a href="../../src/lwt/lwt_switch.ml.html#exception-Off" class="source_link">Source</a><code><span><span class="keyword">exception</span> </span><span><span class="exception">Off</span></span></code></div><div class="spec-doc"><p>Exception raised when trying to add a hook to a switch that is already off.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-check"><a href="#val-check" class="anchor"></a><a href="../../src/lwt/lwt_switch.ml.html#val-check" class="source_link">Source</a><code><span><span class="keyword">val</span> check : <span><span><a href="#type-t">t</a> option</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>check switch</code> does nothing if <code>switch</code> is <code>None</code> or contains an switch that is currently on, and raises <a href="#exception-Off"><code>Off</code></a> otherwise.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-add_hook"><a href="#val-add_hook" class="anchor"></a><a href="../../src/lwt/lwt_switch.ml.html#val-add_hook" class="source_link">Source</a><code><span><span class="keyword">val</span> add_hook : <span><span><a href="#type-t">t</a> option</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span>unit <a href="../Lwt/index.html#type-t">Lwt.t</a></span>)</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>add_hook switch f</code> registers <code>f</code> so it will be called when <a href="#val-turn_off"><code>turn_off</code></a> is invoked. It does nothing if <code>switch</code> is <code>None</code>. If <code>switch</code> contains an switch that is already off then <a href="#exception-Off"><code>Off</code></a> is raised.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-add_hook_or_exec"><a href="#val-add_hook_or_exec" class="anchor"></a><a href="../../src/lwt/lwt_switch.ml.html#val-add_hook_or_exec" class="source_link">Source</a><code><span><span class="keyword">val</span> add_hook_or_exec : <span><span><a href="#type-t">t</a> option</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span>unit <a href="../Lwt/index.html#type-t">Lwt.t</a></span>)</span> <span class="arrow">&#45;&gt;</span></span> <span>unit <a href="../Lwt/index.html#type-t">Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>add_hook_or_exec switch f</code> is the same as <a href="#val-add_hook"><code>add_hook</code></a> except that if the switch is already off, <code>f</code> is called immediately.</p></div></div></div></body></html>
