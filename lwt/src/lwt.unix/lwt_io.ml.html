<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Source: lwt_io.ml (lwt.src.lwt.unix)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.css"/><meta name="generator" content="odoc %%VERSION%%"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/></head><body class="odoc-src"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">Lwt</a> &#x00BB; <a href="../index.html">Sources</a> &#x00BB; lwt.unix &#x00BB; lwt_io.ml</nav><header class="odoc-preamble"><h1>Source file <code><span>lwt_io.ml</span></code></h1></header><div class="odoc-tocs"><nav class="odoc-toc odoc-global-toc"><ul><li><a href="../../index.html">Lwt</a><ul><li>Library <code>lwt</code><ul><li><a href="../../lwt/Lwt/index.html">Lwt</a></li><li><a href="../../lwt/Lwt_condition/index.html">Lwt_condition</a></li><li><a href="../../lwt/Lwt_list/index.html">Lwt_list</a></li><li><a href="../../lwt/Lwt_mutex/index.html">Lwt_mutex</a></li><li><a href="../../lwt/Lwt_mvar/index.html">Lwt_mvar</a></li><li><a href="../../lwt/Lwt_pool/index.html">Lwt_pool</a></li><li><a href="../../lwt/Lwt_pqueue/index.html">Lwt_pqueue</a></li><li><a href="../../lwt/Lwt_result/index.html">Lwt_result</a></li><li><a href="../../lwt/Lwt_seq/index.html">Lwt_seq</a></li><li><a href="../../lwt/Lwt_sequence/index.html">Lwt_sequence</a></li><li><a href="../../lwt/Lwt_stream/index.html">Lwt_stream</a></li><li><a href="../../lwt/Lwt_switch/index.html">Lwt_switch</a></li></ul></li><li>Library <code>lwt.unix</code><ul><li><a href="../../lwt.unix/Lwt_bytes/index.html">Lwt_bytes</a></li><li><a href="../../lwt.unix/Lwt_config/index.html">Lwt_config</a></li><li><a href="../../lwt.unix/Lwt_engine/index.html">Lwt_engine</a></li><li><a href="../../lwt.unix/Lwt_features/index.html">Lwt_features</a></li><li><a href="../../lwt.unix/Lwt_fmt/index.html">Lwt_fmt</a></li><li><a href="../../lwt.unix/Lwt_gc/index.html">Lwt_gc</a></li><li><a href="../../lwt.unix/Lwt_io/index.html">Lwt_io</a></li><li><a href="../../lwt.unix/Lwt_main/index.html">Lwt_main</a></li><li><a href="../../lwt.unix/Lwt_preemptive/index.html">Lwt_preemptive</a></li><li><a href="../../lwt.unix/Lwt_process/index.html">Lwt_process</a></li><li><a href="../../lwt.unix/Lwt_sys/index.html">Lwt_sys</a></li><li><a href="../../lwt.unix/Lwt_throttle/index.html">Lwt_throttle</a></li><li><a href="../../lwt.unix/Lwt_timeout/index.html">Lwt_timeout</a></li><li><a href="../../lwt.unix/Lwt_unix/index.html">Lwt_unix</a></li></ul></li><li><a href="../index.html">Sources</a><ul><li>lwt<ul><li><a href="../lwt/lwt.ml.html">lwt.ml</a></li><li><a href="../lwt/lwt_condition.ml.html">lwt_condition.ml</a></li><li><a href="../lwt/lwt_list.ml.html">lwt_list.ml</a></li><li><a href="../lwt/lwt_mutex.ml.html">lwt_mutex.ml</a></li><li><a href="../lwt/lwt_mvar.ml.html">lwt_mvar.ml</a></li><li><a href="../lwt/lwt_pool.ml.html">lwt_pool.ml</a></li><li><a href="../lwt/lwt_pqueue.ml.html">lwt_pqueue.ml</a></li><li><a href="../lwt/lwt_result.ml.html">lwt_result.ml</a></li><li><a href="../lwt/lwt_seq.ml.html">lwt_seq.ml</a></li><li><a href="../lwt/lwt_sequence.ml.html">lwt_sequence.ml</a></li><li><a href="../lwt/lwt_stream.ml.html">lwt_stream.ml</a></li><li><a href="../lwt/lwt_switch.ml.html">lwt_switch.ml</a></li></ul></li><li>lwt.unix<ul><li><a href="lwt_bytes.ml.html">lwt_bytes.ml</a></li><li><a href="lwt_config.ml.html">lwt_config.ml</a></li><li><a href="lwt_engine.ml.html">lwt_engine.ml</a></li><li><a href="lwt_features.ml.html">lwt_features.ml</a></li><li><a href="lwt_fmt.ml.html">lwt_fmt.ml</a></li><li><a href="lwt_gc.ml.html">lwt_gc.ml</a></li><li><a href="#" class="current_unit">lwt_io.ml</a></li><li><a href="lwt_main.ml.html">lwt_main.ml</a></li><li><a href="lwt_preemptive.ml.html">lwt_preemptive.ml</a></li><li><a href="lwt_process.ml.html">lwt_process.ml</a></li><li><a href="lwt_sys.ml.html">lwt_sys.ml</a></li><li><a href="lwt_throttle.ml.html">lwt_throttle.ml</a></li><li><a href="lwt_timeout.ml.html">lwt_timeout.ml</a></li><li><a href="lwt_unix.ml.html">lwt_unix.ml</a></li></ul></li></ul></li></ul></li></ul></nav></div><pre class="source_container"><code class="source_line_column"><a id="L1" class="source_line" href="#L1">1</a>
<a id="L2" class="source_line" href="#L2">2</a>
<a id="L3" class="source_line" href="#L3">3</a>
<a id="L4" class="source_line" href="#L4">4</a>
<a id="L5" class="source_line" href="#L5">5</a>
<a id="L6" class="source_line" href="#L6">6</a>
<a id="L7" class="source_line" href="#L7">7</a>
<a id="L8" class="source_line" href="#L8">8</a>
<a id="L9" class="source_line" href="#L9">9</a>
<a id="L10" class="source_line" href="#L10">10</a>
<a id="L11" class="source_line" href="#L11">11</a>
<a id="L12" class="source_line" href="#L12">12</a>
<a id="L13" class="source_line" href="#L13">13</a>
<a id="L14" class="source_line" href="#L14">14</a>
<a id="L15" class="source_line" href="#L15">15</a>
<a id="L16" class="source_line" href="#L16">16</a>
<a id="L17" class="source_line" href="#L17">17</a>
<a id="L18" class="source_line" href="#L18">18</a>
<a id="L19" class="source_line" href="#L19">19</a>
<a id="L20" class="source_line" href="#L20">20</a>
<a id="L21" class="source_line" href="#L21">21</a>
<a id="L22" class="source_line" href="#L22">22</a>
<a id="L23" class="source_line" href="#L23">23</a>
<a id="L24" class="source_line" href="#L24">24</a>
<a id="L25" class="source_line" href="#L25">25</a>
<a id="L26" class="source_line" href="#L26">26</a>
<a id="L27" class="source_line" href="#L27">27</a>
<a id="L28" class="source_line" href="#L28">28</a>
<a id="L29" class="source_line" href="#L29">29</a>
<a id="L30" class="source_line" href="#L30">30</a>
<a id="L31" class="source_line" href="#L31">31</a>
<a id="L32" class="source_line" href="#L32">32</a>
<a id="L33" class="source_line" href="#L33">33</a>
<a id="L34" class="source_line" href="#L34">34</a>
<a id="L35" class="source_line" href="#L35">35</a>
<a id="L36" class="source_line" href="#L36">36</a>
<a id="L37" class="source_line" href="#L37">37</a>
<a id="L38" class="source_line" href="#L38">38</a>
<a id="L39" class="source_line" href="#L39">39</a>
<a id="L40" class="source_line" href="#L40">40</a>
<a id="L41" class="source_line" href="#L41">41</a>
<a id="L42" class="source_line" href="#L42">42</a>
<a id="L43" class="source_line" href="#L43">43</a>
<a id="L44" class="source_line" href="#L44">44</a>
<a id="L45" class="source_line" href="#L45">45</a>
<a id="L46" class="source_line" href="#L46">46</a>
<a id="L47" class="source_line" href="#L47">47</a>
<a id="L48" class="source_line" href="#L48">48</a>
<a id="L49" class="source_line" href="#L49">49</a>
<a id="L50" class="source_line" href="#L50">50</a>
<a id="L51" class="source_line" href="#L51">51</a>
<a id="L52" class="source_line" href="#L52">52</a>
<a id="L53" class="source_line" href="#L53">53</a>
<a id="L54" class="source_line" href="#L54">54</a>
<a id="L55" class="source_line" href="#L55">55</a>
<a id="L56" class="source_line" href="#L56">56</a>
<a id="L57" class="source_line" href="#L57">57</a>
<a id="L58" class="source_line" href="#L58">58</a>
<a id="L59" class="source_line" href="#L59">59</a>
<a id="L60" class="source_line" href="#L60">60</a>
<a id="L61" class="source_line" href="#L61">61</a>
<a id="L62" class="source_line" href="#L62">62</a>
<a id="L63" class="source_line" href="#L63">63</a>
<a id="L64" class="source_line" href="#L64">64</a>
<a id="L65" class="source_line" href="#L65">65</a>
<a id="L66" class="source_line" href="#L66">66</a>
<a id="L67" class="source_line" href="#L67">67</a>
<a id="L68" class="source_line" href="#L68">68</a>
<a id="L69" class="source_line" href="#L69">69</a>
<a id="L70" class="source_line" href="#L70">70</a>
<a id="L71" class="source_line" href="#L71">71</a>
<a id="L72" class="source_line" href="#L72">72</a>
<a id="L73" class="source_line" href="#L73">73</a>
<a id="L74" class="source_line" href="#L74">74</a>
<a id="L75" class="source_line" href="#L75">75</a>
<a id="L76" class="source_line" href="#L76">76</a>
<a id="L77" class="source_line" href="#L77">77</a>
<a id="L78" class="source_line" href="#L78">78</a>
<a id="L79" class="source_line" href="#L79">79</a>
<a id="L80" class="source_line" href="#L80">80</a>
<a id="L81" class="source_line" href="#L81">81</a>
<a id="L82" class="source_line" href="#L82">82</a>
<a id="L83" class="source_line" href="#L83">83</a>
<a id="L84" class="source_line" href="#L84">84</a>
<a id="L85" class="source_line" href="#L85">85</a>
<a id="L86" class="source_line" href="#L86">86</a>
<a id="L87" class="source_line" href="#L87">87</a>
<a id="L88" class="source_line" href="#L88">88</a>
<a id="L89" class="source_line" href="#L89">89</a>
<a id="L90" class="source_line" href="#L90">90</a>
<a id="L91" class="source_line" href="#L91">91</a>
<a id="L92" class="source_line" href="#L92">92</a>
<a id="L93" class="source_line" href="#L93">93</a>
<a id="L94" class="source_line" href="#L94">94</a>
<a id="L95" class="source_line" href="#L95">95</a>
<a id="L96" class="source_line" href="#L96">96</a>
<a id="L97" class="source_line" href="#L97">97</a>
<a id="L98" class="source_line" href="#L98">98</a>
<a id="L99" class="source_line" href="#L99">99</a>
<a id="L100" class="source_line" href="#L100">100</a>
<a id="L101" class="source_line" href="#L101">101</a>
<a id="L102" class="source_line" href="#L102">102</a>
<a id="L103" class="source_line" href="#L103">103</a>
<a id="L104" class="source_line" href="#L104">104</a>
<a id="L105" class="source_line" href="#L105">105</a>
<a id="L106" class="source_line" href="#L106">106</a>
<a id="L107" class="source_line" href="#L107">107</a>
<a id="L108" class="source_line" href="#L108">108</a>
<a id="L109" class="source_line" href="#L109">109</a>
<a id="L110" class="source_line" href="#L110">110</a>
<a id="L111" class="source_line" href="#L111">111</a>
<a id="L112" class="source_line" href="#L112">112</a>
<a id="L113" class="source_line" href="#L113">113</a>
<a id="L114" class="source_line" href="#L114">114</a>
<a id="L115" class="source_line" href="#L115">115</a>
<a id="L116" class="source_line" href="#L116">116</a>
<a id="L117" class="source_line" href="#L117">117</a>
<a id="L118" class="source_line" href="#L118">118</a>
<a id="L119" class="source_line" href="#L119">119</a>
<a id="L120" class="source_line" href="#L120">120</a>
<a id="L121" class="source_line" href="#L121">121</a>
<a id="L122" class="source_line" href="#L122">122</a>
<a id="L123" class="source_line" href="#L123">123</a>
<a id="L124" class="source_line" href="#L124">124</a>
<a id="L125" class="source_line" href="#L125">125</a>
<a id="L126" class="source_line" href="#L126">126</a>
<a id="L127" class="source_line" href="#L127">127</a>
<a id="L128" class="source_line" href="#L128">128</a>
<a id="L129" class="source_line" href="#L129">129</a>
<a id="L130" class="source_line" href="#L130">130</a>
<a id="L131" class="source_line" href="#L131">131</a>
<a id="L132" class="source_line" href="#L132">132</a>
<a id="L133" class="source_line" href="#L133">133</a>
<a id="L134" class="source_line" href="#L134">134</a>
<a id="L135" class="source_line" href="#L135">135</a>
<a id="L136" class="source_line" href="#L136">136</a>
<a id="L137" class="source_line" href="#L137">137</a>
<a id="L138" class="source_line" href="#L138">138</a>
<a id="L139" class="source_line" href="#L139">139</a>
<a id="L140" class="source_line" href="#L140">140</a>
<a id="L141" class="source_line" href="#L141">141</a>
<a id="L142" class="source_line" href="#L142">142</a>
<a id="L143" class="source_line" href="#L143">143</a>
<a id="L144" class="source_line" href="#L144">144</a>
<a id="L145" class="source_line" href="#L145">145</a>
<a id="L146" class="source_line" href="#L146">146</a>
<a id="L147" class="source_line" href="#L147">147</a>
<a id="L148" class="source_line" href="#L148">148</a>
<a id="L149" class="source_line" href="#L149">149</a>
<a id="L150" class="source_line" href="#L150">150</a>
<a id="L151" class="source_line" href="#L151">151</a>
<a id="L152" class="source_line" href="#L152">152</a>
<a id="L153" class="source_line" href="#L153">153</a>
<a id="L154" class="source_line" href="#L154">154</a>
<a id="L155" class="source_line" href="#L155">155</a>
<a id="L156" class="source_line" href="#L156">156</a>
<a id="L157" class="source_line" href="#L157">157</a>
<a id="L158" class="source_line" href="#L158">158</a>
<a id="L159" class="source_line" href="#L159">159</a>
<a id="L160" class="source_line" href="#L160">160</a>
<a id="L161" class="source_line" href="#L161">161</a>
<a id="L162" class="source_line" href="#L162">162</a>
<a id="L163" class="source_line" href="#L163">163</a>
<a id="L164" class="source_line" href="#L164">164</a>
<a id="L165" class="source_line" href="#L165">165</a>
<a id="L166" class="source_line" href="#L166">166</a>
<a id="L167" class="source_line" href="#L167">167</a>
<a id="L168" class="source_line" href="#L168">168</a>
<a id="L169" class="source_line" href="#L169">169</a>
<a id="L170" class="source_line" href="#L170">170</a>
<a id="L171" class="source_line" href="#L171">171</a>
<a id="L172" class="source_line" href="#L172">172</a>
<a id="L173" class="source_line" href="#L173">173</a>
<a id="L174" class="source_line" href="#L174">174</a>
<a id="L175" class="source_line" href="#L175">175</a>
<a id="L176" class="source_line" href="#L176">176</a>
<a id="L177" class="source_line" href="#L177">177</a>
<a id="L178" class="source_line" href="#L178">178</a>
<a id="L179" class="source_line" href="#L179">179</a>
<a id="L180" class="source_line" href="#L180">180</a>
<a id="L181" class="source_line" href="#L181">181</a>
<a id="L182" class="source_line" href="#L182">182</a>
<a id="L183" class="source_line" href="#L183">183</a>
<a id="L184" class="source_line" href="#L184">184</a>
<a id="L185" class="source_line" href="#L185">185</a>
<a id="L186" class="source_line" href="#L186">186</a>
<a id="L187" class="source_line" href="#L187">187</a>
<a id="L188" class="source_line" href="#L188">188</a>
<a id="L189" class="source_line" href="#L189">189</a>
<a id="L190" class="source_line" href="#L190">190</a>
<a id="L191" class="source_line" href="#L191">191</a>
<a id="L192" class="source_line" href="#L192">192</a>
<a id="L193" class="source_line" href="#L193">193</a>
<a id="L194" class="source_line" href="#L194">194</a>
<a id="L195" class="source_line" href="#L195">195</a>
<a id="L196" class="source_line" href="#L196">196</a>
<a id="L197" class="source_line" href="#L197">197</a>
<a id="L198" class="source_line" href="#L198">198</a>
<a id="L199" class="source_line" href="#L199">199</a>
<a id="L200" class="source_line" href="#L200">200</a>
<a id="L201" class="source_line" href="#L201">201</a>
<a id="L202" class="source_line" href="#L202">202</a>
<a id="L203" class="source_line" href="#L203">203</a>
<a id="L204" class="source_line" href="#L204">204</a>
<a id="L205" class="source_line" href="#L205">205</a>
<a id="L206" class="source_line" href="#L206">206</a>
<a id="L207" class="source_line" href="#L207">207</a>
<a id="L208" class="source_line" href="#L208">208</a>
<a id="L209" class="source_line" href="#L209">209</a>
<a id="L210" class="source_line" href="#L210">210</a>
<a id="L211" class="source_line" href="#L211">211</a>
<a id="L212" class="source_line" href="#L212">212</a>
<a id="L213" class="source_line" href="#L213">213</a>
<a id="L214" class="source_line" href="#L214">214</a>
<a id="L215" class="source_line" href="#L215">215</a>
<a id="L216" class="source_line" href="#L216">216</a>
<a id="L217" class="source_line" href="#L217">217</a>
<a id="L218" class="source_line" href="#L218">218</a>
<a id="L219" class="source_line" href="#L219">219</a>
<a id="L220" class="source_line" href="#L220">220</a>
<a id="L221" class="source_line" href="#L221">221</a>
<a id="L222" class="source_line" href="#L222">222</a>
<a id="L223" class="source_line" href="#L223">223</a>
<a id="L224" class="source_line" href="#L224">224</a>
<a id="L225" class="source_line" href="#L225">225</a>
<a id="L226" class="source_line" href="#L226">226</a>
<a id="L227" class="source_line" href="#L227">227</a>
<a id="L228" class="source_line" href="#L228">228</a>
<a id="L229" class="source_line" href="#L229">229</a>
<a id="L230" class="source_line" href="#L230">230</a>
<a id="L231" class="source_line" href="#L231">231</a>
<a id="L232" class="source_line" href="#L232">232</a>
<a id="L233" class="source_line" href="#L233">233</a>
<a id="L234" class="source_line" href="#L234">234</a>
<a id="L235" class="source_line" href="#L235">235</a>
<a id="L236" class="source_line" href="#L236">236</a>
<a id="L237" class="source_line" href="#L237">237</a>
<a id="L238" class="source_line" href="#L238">238</a>
<a id="L239" class="source_line" href="#L239">239</a>
<a id="L240" class="source_line" href="#L240">240</a>
<a id="L241" class="source_line" href="#L241">241</a>
<a id="L242" class="source_line" href="#L242">242</a>
<a id="L243" class="source_line" href="#L243">243</a>
<a id="L244" class="source_line" href="#L244">244</a>
<a id="L245" class="source_line" href="#L245">245</a>
<a id="L246" class="source_line" href="#L246">246</a>
<a id="L247" class="source_line" href="#L247">247</a>
<a id="L248" class="source_line" href="#L248">248</a>
<a id="L249" class="source_line" href="#L249">249</a>
<a id="L250" class="source_line" href="#L250">250</a>
<a id="L251" class="source_line" href="#L251">251</a>
<a id="L252" class="source_line" href="#L252">252</a>
<a id="L253" class="source_line" href="#L253">253</a>
<a id="L254" class="source_line" href="#L254">254</a>
<a id="L255" class="source_line" href="#L255">255</a>
<a id="L256" class="source_line" href="#L256">256</a>
<a id="L257" class="source_line" href="#L257">257</a>
<a id="L258" class="source_line" href="#L258">258</a>
<a id="L259" class="source_line" href="#L259">259</a>
<a id="L260" class="source_line" href="#L260">260</a>
<a id="L261" class="source_line" href="#L261">261</a>
<a id="L262" class="source_line" href="#L262">262</a>
<a id="L263" class="source_line" href="#L263">263</a>
<a id="L264" class="source_line" href="#L264">264</a>
<a id="L265" class="source_line" href="#L265">265</a>
<a id="L266" class="source_line" href="#L266">266</a>
<a id="L267" class="source_line" href="#L267">267</a>
<a id="L268" class="source_line" href="#L268">268</a>
<a id="L269" class="source_line" href="#L269">269</a>
<a id="L270" class="source_line" href="#L270">270</a>
<a id="L271" class="source_line" href="#L271">271</a>
<a id="L272" class="source_line" href="#L272">272</a>
<a id="L273" class="source_line" href="#L273">273</a>
<a id="L274" class="source_line" href="#L274">274</a>
<a id="L275" class="source_line" href="#L275">275</a>
<a id="L276" class="source_line" href="#L276">276</a>
<a id="L277" class="source_line" href="#L277">277</a>
<a id="L278" class="source_line" href="#L278">278</a>
<a id="L279" class="source_line" href="#L279">279</a>
<a id="L280" class="source_line" href="#L280">280</a>
<a id="L281" class="source_line" href="#L281">281</a>
<a id="L282" class="source_line" href="#L282">282</a>
<a id="L283" class="source_line" href="#L283">283</a>
<a id="L284" class="source_line" href="#L284">284</a>
<a id="L285" class="source_line" href="#L285">285</a>
<a id="L286" class="source_line" href="#L286">286</a>
<a id="L287" class="source_line" href="#L287">287</a>
<a id="L288" class="source_line" href="#L288">288</a>
<a id="L289" class="source_line" href="#L289">289</a>
<a id="L290" class="source_line" href="#L290">290</a>
<a id="L291" class="source_line" href="#L291">291</a>
<a id="L292" class="source_line" href="#L292">292</a>
<a id="L293" class="source_line" href="#L293">293</a>
<a id="L294" class="source_line" href="#L294">294</a>
<a id="L295" class="source_line" href="#L295">295</a>
<a id="L296" class="source_line" href="#L296">296</a>
<a id="L297" class="source_line" href="#L297">297</a>
<a id="L298" class="source_line" href="#L298">298</a>
<a id="L299" class="source_line" href="#L299">299</a>
<a id="L300" class="source_line" href="#L300">300</a>
<a id="L301" class="source_line" href="#L301">301</a>
<a id="L302" class="source_line" href="#L302">302</a>
<a id="L303" class="source_line" href="#L303">303</a>
<a id="L304" class="source_line" href="#L304">304</a>
<a id="L305" class="source_line" href="#L305">305</a>
<a id="L306" class="source_line" href="#L306">306</a>
<a id="L307" class="source_line" href="#L307">307</a>
<a id="L308" class="source_line" href="#L308">308</a>
<a id="L309" class="source_line" href="#L309">309</a>
<a id="L310" class="source_line" href="#L310">310</a>
<a id="L311" class="source_line" href="#L311">311</a>
<a id="L312" class="source_line" href="#L312">312</a>
<a id="L313" class="source_line" href="#L313">313</a>
<a id="L314" class="source_line" href="#L314">314</a>
<a id="L315" class="source_line" href="#L315">315</a>
<a id="L316" class="source_line" href="#L316">316</a>
<a id="L317" class="source_line" href="#L317">317</a>
<a id="L318" class="source_line" href="#L318">318</a>
<a id="L319" class="source_line" href="#L319">319</a>
<a id="L320" class="source_line" href="#L320">320</a>
<a id="L321" class="source_line" href="#L321">321</a>
<a id="L322" class="source_line" href="#L322">322</a>
<a id="L323" class="source_line" href="#L323">323</a>
<a id="L324" class="source_line" href="#L324">324</a>
<a id="L325" class="source_line" href="#L325">325</a>
<a id="L326" class="source_line" href="#L326">326</a>
<a id="L327" class="source_line" href="#L327">327</a>
<a id="L328" class="source_line" href="#L328">328</a>
<a id="L329" class="source_line" href="#L329">329</a>
<a id="L330" class="source_line" href="#L330">330</a>
<a id="L331" class="source_line" href="#L331">331</a>
<a id="L332" class="source_line" href="#L332">332</a>
<a id="L333" class="source_line" href="#L333">333</a>
<a id="L334" class="source_line" href="#L334">334</a>
<a id="L335" class="source_line" href="#L335">335</a>
<a id="L336" class="source_line" href="#L336">336</a>
<a id="L337" class="source_line" href="#L337">337</a>
<a id="L338" class="source_line" href="#L338">338</a>
<a id="L339" class="source_line" href="#L339">339</a>
<a id="L340" class="source_line" href="#L340">340</a>
<a id="L341" class="source_line" href="#L341">341</a>
<a id="L342" class="source_line" href="#L342">342</a>
<a id="L343" class="source_line" href="#L343">343</a>
<a id="L344" class="source_line" href="#L344">344</a>
<a id="L345" class="source_line" href="#L345">345</a>
<a id="L346" class="source_line" href="#L346">346</a>
<a id="L347" class="source_line" href="#L347">347</a>
<a id="L348" class="source_line" href="#L348">348</a>
<a id="L349" class="source_line" href="#L349">349</a>
<a id="L350" class="source_line" href="#L350">350</a>
<a id="L351" class="source_line" href="#L351">351</a>
<a id="L352" class="source_line" href="#L352">352</a>
<a id="L353" class="source_line" href="#L353">353</a>
<a id="L354" class="source_line" href="#L354">354</a>
<a id="L355" class="source_line" href="#L355">355</a>
<a id="L356" class="source_line" href="#L356">356</a>
<a id="L357" class="source_line" href="#L357">357</a>
<a id="L358" class="source_line" href="#L358">358</a>
<a id="L359" class="source_line" href="#L359">359</a>
<a id="L360" class="source_line" href="#L360">360</a>
<a id="L361" class="source_line" href="#L361">361</a>
<a id="L362" class="source_line" href="#L362">362</a>
<a id="L363" class="source_line" href="#L363">363</a>
<a id="L364" class="source_line" href="#L364">364</a>
<a id="L365" class="source_line" href="#L365">365</a>
<a id="L366" class="source_line" href="#L366">366</a>
<a id="L367" class="source_line" href="#L367">367</a>
<a id="L368" class="source_line" href="#L368">368</a>
<a id="L369" class="source_line" href="#L369">369</a>
<a id="L370" class="source_line" href="#L370">370</a>
<a id="L371" class="source_line" href="#L371">371</a>
<a id="L372" class="source_line" href="#L372">372</a>
<a id="L373" class="source_line" href="#L373">373</a>
<a id="L374" class="source_line" href="#L374">374</a>
<a id="L375" class="source_line" href="#L375">375</a>
<a id="L376" class="source_line" href="#L376">376</a>
<a id="L377" class="source_line" href="#L377">377</a>
<a id="L378" class="source_line" href="#L378">378</a>
<a id="L379" class="source_line" href="#L379">379</a>
<a id="L380" class="source_line" href="#L380">380</a>
<a id="L381" class="source_line" href="#L381">381</a>
<a id="L382" class="source_line" href="#L382">382</a>
<a id="L383" class="source_line" href="#L383">383</a>
<a id="L384" class="source_line" href="#L384">384</a>
<a id="L385" class="source_line" href="#L385">385</a>
<a id="L386" class="source_line" href="#L386">386</a>
<a id="L387" class="source_line" href="#L387">387</a>
<a id="L388" class="source_line" href="#L388">388</a>
<a id="L389" class="source_line" href="#L389">389</a>
<a id="L390" class="source_line" href="#L390">390</a>
<a id="L391" class="source_line" href="#L391">391</a>
<a id="L392" class="source_line" href="#L392">392</a>
<a id="L393" class="source_line" href="#L393">393</a>
<a id="L394" class="source_line" href="#L394">394</a>
<a id="L395" class="source_line" href="#L395">395</a>
<a id="L396" class="source_line" href="#L396">396</a>
<a id="L397" class="source_line" href="#L397">397</a>
<a id="L398" class="source_line" href="#L398">398</a>
<a id="L399" class="source_line" href="#L399">399</a>
<a id="L400" class="source_line" href="#L400">400</a>
<a id="L401" class="source_line" href="#L401">401</a>
<a id="L402" class="source_line" href="#L402">402</a>
<a id="L403" class="source_line" href="#L403">403</a>
<a id="L404" class="source_line" href="#L404">404</a>
<a id="L405" class="source_line" href="#L405">405</a>
<a id="L406" class="source_line" href="#L406">406</a>
<a id="L407" class="source_line" href="#L407">407</a>
<a id="L408" class="source_line" href="#L408">408</a>
<a id="L409" class="source_line" href="#L409">409</a>
<a id="L410" class="source_line" href="#L410">410</a>
<a id="L411" class="source_line" href="#L411">411</a>
<a id="L412" class="source_line" href="#L412">412</a>
<a id="L413" class="source_line" href="#L413">413</a>
<a id="L414" class="source_line" href="#L414">414</a>
<a id="L415" class="source_line" href="#L415">415</a>
<a id="L416" class="source_line" href="#L416">416</a>
<a id="L417" class="source_line" href="#L417">417</a>
<a id="L418" class="source_line" href="#L418">418</a>
<a id="L419" class="source_line" href="#L419">419</a>
<a id="L420" class="source_line" href="#L420">420</a>
<a id="L421" class="source_line" href="#L421">421</a>
<a id="L422" class="source_line" href="#L422">422</a>
<a id="L423" class="source_line" href="#L423">423</a>
<a id="L424" class="source_line" href="#L424">424</a>
<a id="L425" class="source_line" href="#L425">425</a>
<a id="L426" class="source_line" href="#L426">426</a>
<a id="L427" class="source_line" href="#L427">427</a>
<a id="L428" class="source_line" href="#L428">428</a>
<a id="L429" class="source_line" href="#L429">429</a>
<a id="L430" class="source_line" href="#L430">430</a>
<a id="L431" class="source_line" href="#L431">431</a>
<a id="L432" class="source_line" href="#L432">432</a>
<a id="L433" class="source_line" href="#L433">433</a>
<a id="L434" class="source_line" href="#L434">434</a>
<a id="L435" class="source_line" href="#L435">435</a>
<a id="L436" class="source_line" href="#L436">436</a>
<a id="L437" class="source_line" href="#L437">437</a>
<a id="L438" class="source_line" href="#L438">438</a>
<a id="L439" class="source_line" href="#L439">439</a>
<a id="L440" class="source_line" href="#L440">440</a>
<a id="L441" class="source_line" href="#L441">441</a>
<a id="L442" class="source_line" href="#L442">442</a>
<a id="L443" class="source_line" href="#L443">443</a>
<a id="L444" class="source_line" href="#L444">444</a>
<a id="L445" class="source_line" href="#L445">445</a>
<a id="L446" class="source_line" href="#L446">446</a>
<a id="L447" class="source_line" href="#L447">447</a>
<a id="L448" class="source_line" href="#L448">448</a>
<a id="L449" class="source_line" href="#L449">449</a>
<a id="L450" class="source_line" href="#L450">450</a>
<a id="L451" class="source_line" href="#L451">451</a>
<a id="L452" class="source_line" href="#L452">452</a>
<a id="L453" class="source_line" href="#L453">453</a>
<a id="L454" class="source_line" href="#L454">454</a>
<a id="L455" class="source_line" href="#L455">455</a>
<a id="L456" class="source_line" href="#L456">456</a>
<a id="L457" class="source_line" href="#L457">457</a>
<a id="L458" class="source_line" href="#L458">458</a>
<a id="L459" class="source_line" href="#L459">459</a>
<a id="L460" class="source_line" href="#L460">460</a>
<a id="L461" class="source_line" href="#L461">461</a>
<a id="L462" class="source_line" href="#L462">462</a>
<a id="L463" class="source_line" href="#L463">463</a>
<a id="L464" class="source_line" href="#L464">464</a>
<a id="L465" class="source_line" href="#L465">465</a>
<a id="L466" class="source_line" href="#L466">466</a>
<a id="L467" class="source_line" href="#L467">467</a>
<a id="L468" class="source_line" href="#L468">468</a>
<a id="L469" class="source_line" href="#L469">469</a>
<a id="L470" class="source_line" href="#L470">470</a>
<a id="L471" class="source_line" href="#L471">471</a>
<a id="L472" class="source_line" href="#L472">472</a>
<a id="L473" class="source_line" href="#L473">473</a>
<a id="L474" class="source_line" href="#L474">474</a>
<a id="L475" class="source_line" href="#L475">475</a>
<a id="L476" class="source_line" href="#L476">476</a>
<a id="L477" class="source_line" href="#L477">477</a>
<a id="L478" class="source_line" href="#L478">478</a>
<a id="L479" class="source_line" href="#L479">479</a>
<a id="L480" class="source_line" href="#L480">480</a>
<a id="L481" class="source_line" href="#L481">481</a>
<a id="L482" class="source_line" href="#L482">482</a>
<a id="L483" class="source_line" href="#L483">483</a>
<a id="L484" class="source_line" href="#L484">484</a>
<a id="L485" class="source_line" href="#L485">485</a>
<a id="L486" class="source_line" href="#L486">486</a>
<a id="L487" class="source_line" href="#L487">487</a>
<a id="L488" class="source_line" href="#L488">488</a>
<a id="L489" class="source_line" href="#L489">489</a>
<a id="L490" class="source_line" href="#L490">490</a>
<a id="L491" class="source_line" href="#L491">491</a>
<a id="L492" class="source_line" href="#L492">492</a>
<a id="L493" class="source_line" href="#L493">493</a>
<a id="L494" class="source_line" href="#L494">494</a>
<a id="L495" class="source_line" href="#L495">495</a>
<a id="L496" class="source_line" href="#L496">496</a>
<a id="L497" class="source_line" href="#L497">497</a>
<a id="L498" class="source_line" href="#L498">498</a>
<a id="L499" class="source_line" href="#L499">499</a>
<a id="L500" class="source_line" href="#L500">500</a>
<a id="L501" class="source_line" href="#L501">501</a>
<a id="L502" class="source_line" href="#L502">502</a>
<a id="L503" class="source_line" href="#L503">503</a>
<a id="L504" class="source_line" href="#L504">504</a>
<a id="L505" class="source_line" href="#L505">505</a>
<a id="L506" class="source_line" href="#L506">506</a>
<a id="L507" class="source_line" href="#L507">507</a>
<a id="L508" class="source_line" href="#L508">508</a>
<a id="L509" class="source_line" href="#L509">509</a>
<a id="L510" class="source_line" href="#L510">510</a>
<a id="L511" class="source_line" href="#L511">511</a>
<a id="L512" class="source_line" href="#L512">512</a>
<a id="L513" class="source_line" href="#L513">513</a>
<a id="L514" class="source_line" href="#L514">514</a>
<a id="L515" class="source_line" href="#L515">515</a>
<a id="L516" class="source_line" href="#L516">516</a>
<a id="L517" class="source_line" href="#L517">517</a>
<a id="L518" class="source_line" href="#L518">518</a>
<a id="L519" class="source_line" href="#L519">519</a>
<a id="L520" class="source_line" href="#L520">520</a>
<a id="L521" class="source_line" href="#L521">521</a>
<a id="L522" class="source_line" href="#L522">522</a>
<a id="L523" class="source_line" href="#L523">523</a>
<a id="L524" class="source_line" href="#L524">524</a>
<a id="L525" class="source_line" href="#L525">525</a>
<a id="L526" class="source_line" href="#L526">526</a>
<a id="L527" class="source_line" href="#L527">527</a>
<a id="L528" class="source_line" href="#L528">528</a>
<a id="L529" class="source_line" href="#L529">529</a>
<a id="L530" class="source_line" href="#L530">530</a>
<a id="L531" class="source_line" href="#L531">531</a>
<a id="L532" class="source_line" href="#L532">532</a>
<a id="L533" class="source_line" href="#L533">533</a>
<a id="L534" class="source_line" href="#L534">534</a>
<a id="L535" class="source_line" href="#L535">535</a>
<a id="L536" class="source_line" href="#L536">536</a>
<a id="L537" class="source_line" href="#L537">537</a>
<a id="L538" class="source_line" href="#L538">538</a>
<a id="L539" class="source_line" href="#L539">539</a>
<a id="L540" class="source_line" href="#L540">540</a>
<a id="L541" class="source_line" href="#L541">541</a>
<a id="L542" class="source_line" href="#L542">542</a>
<a id="L543" class="source_line" href="#L543">543</a>
<a id="L544" class="source_line" href="#L544">544</a>
<a id="L545" class="source_line" href="#L545">545</a>
<a id="L546" class="source_line" href="#L546">546</a>
<a id="L547" class="source_line" href="#L547">547</a>
<a id="L548" class="source_line" href="#L548">548</a>
<a id="L549" class="source_line" href="#L549">549</a>
<a id="L550" class="source_line" href="#L550">550</a>
<a id="L551" class="source_line" href="#L551">551</a>
<a id="L552" class="source_line" href="#L552">552</a>
<a id="L553" class="source_line" href="#L553">553</a>
<a id="L554" class="source_line" href="#L554">554</a>
<a id="L555" class="source_line" href="#L555">555</a>
<a id="L556" class="source_line" href="#L556">556</a>
<a id="L557" class="source_line" href="#L557">557</a>
<a id="L558" class="source_line" href="#L558">558</a>
<a id="L559" class="source_line" href="#L559">559</a>
<a id="L560" class="source_line" href="#L560">560</a>
<a id="L561" class="source_line" href="#L561">561</a>
<a id="L562" class="source_line" href="#L562">562</a>
<a id="L563" class="source_line" href="#L563">563</a>
<a id="L564" class="source_line" href="#L564">564</a>
<a id="L565" class="source_line" href="#L565">565</a>
<a id="L566" class="source_line" href="#L566">566</a>
<a id="L567" class="source_line" href="#L567">567</a>
<a id="L568" class="source_line" href="#L568">568</a>
<a id="L569" class="source_line" href="#L569">569</a>
<a id="L570" class="source_line" href="#L570">570</a>
<a id="L571" class="source_line" href="#L571">571</a>
<a id="L572" class="source_line" href="#L572">572</a>
<a id="L573" class="source_line" href="#L573">573</a>
<a id="L574" class="source_line" href="#L574">574</a>
<a id="L575" class="source_line" href="#L575">575</a>
<a id="L576" class="source_line" href="#L576">576</a>
<a id="L577" class="source_line" href="#L577">577</a>
<a id="L578" class="source_line" href="#L578">578</a>
<a id="L579" class="source_line" href="#L579">579</a>
<a id="L580" class="source_line" href="#L580">580</a>
<a id="L581" class="source_line" href="#L581">581</a>
<a id="L582" class="source_line" href="#L582">582</a>
<a id="L583" class="source_line" href="#L583">583</a>
<a id="L584" class="source_line" href="#L584">584</a>
<a id="L585" class="source_line" href="#L585">585</a>
<a id="L586" class="source_line" href="#L586">586</a>
<a id="L587" class="source_line" href="#L587">587</a>
<a id="L588" class="source_line" href="#L588">588</a>
<a id="L589" class="source_line" href="#L589">589</a>
<a id="L590" class="source_line" href="#L590">590</a>
<a id="L591" class="source_line" href="#L591">591</a>
<a id="L592" class="source_line" href="#L592">592</a>
<a id="L593" class="source_line" href="#L593">593</a>
<a id="L594" class="source_line" href="#L594">594</a>
<a id="L595" class="source_line" href="#L595">595</a>
<a id="L596" class="source_line" href="#L596">596</a>
<a id="L597" class="source_line" href="#L597">597</a>
<a id="L598" class="source_line" href="#L598">598</a>
<a id="L599" class="source_line" href="#L599">599</a>
<a id="L600" class="source_line" href="#L600">600</a>
<a id="L601" class="source_line" href="#L601">601</a>
<a id="L602" class="source_line" href="#L602">602</a>
<a id="L603" class="source_line" href="#L603">603</a>
<a id="L604" class="source_line" href="#L604">604</a>
<a id="L605" class="source_line" href="#L605">605</a>
<a id="L606" class="source_line" href="#L606">606</a>
<a id="L607" class="source_line" href="#L607">607</a>
<a id="L608" class="source_line" href="#L608">608</a>
<a id="L609" class="source_line" href="#L609">609</a>
<a id="L610" class="source_line" href="#L610">610</a>
<a id="L611" class="source_line" href="#L611">611</a>
<a id="L612" class="source_line" href="#L612">612</a>
<a id="L613" class="source_line" href="#L613">613</a>
<a id="L614" class="source_line" href="#L614">614</a>
<a id="L615" class="source_line" href="#L615">615</a>
<a id="L616" class="source_line" href="#L616">616</a>
<a id="L617" class="source_line" href="#L617">617</a>
<a id="L618" class="source_line" href="#L618">618</a>
<a id="L619" class="source_line" href="#L619">619</a>
<a id="L620" class="source_line" href="#L620">620</a>
<a id="L621" class="source_line" href="#L621">621</a>
<a id="L622" class="source_line" href="#L622">622</a>
<a id="L623" class="source_line" href="#L623">623</a>
<a id="L624" class="source_line" href="#L624">624</a>
<a id="L625" class="source_line" href="#L625">625</a>
<a id="L626" class="source_line" href="#L626">626</a>
<a id="L627" class="source_line" href="#L627">627</a>
<a id="L628" class="source_line" href="#L628">628</a>
<a id="L629" class="source_line" href="#L629">629</a>
<a id="L630" class="source_line" href="#L630">630</a>
<a id="L631" class="source_line" href="#L631">631</a>
<a id="L632" class="source_line" href="#L632">632</a>
<a id="L633" class="source_line" href="#L633">633</a>
<a id="L634" class="source_line" href="#L634">634</a>
<a id="L635" class="source_line" href="#L635">635</a>
<a id="L636" class="source_line" href="#L636">636</a>
<a id="L637" class="source_line" href="#L637">637</a>
<a id="L638" class="source_line" href="#L638">638</a>
<a id="L639" class="source_line" href="#L639">639</a>
<a id="L640" class="source_line" href="#L640">640</a>
<a id="L641" class="source_line" href="#L641">641</a>
<a id="L642" class="source_line" href="#L642">642</a>
<a id="L643" class="source_line" href="#L643">643</a>
<a id="L644" class="source_line" href="#L644">644</a>
<a id="L645" class="source_line" href="#L645">645</a>
<a id="L646" class="source_line" href="#L646">646</a>
<a id="L647" class="source_line" href="#L647">647</a>
<a id="L648" class="source_line" href="#L648">648</a>
<a id="L649" class="source_line" href="#L649">649</a>
<a id="L650" class="source_line" href="#L650">650</a>
<a id="L651" class="source_line" href="#L651">651</a>
<a id="L652" class="source_line" href="#L652">652</a>
<a id="L653" class="source_line" href="#L653">653</a>
<a id="L654" class="source_line" href="#L654">654</a>
<a id="L655" class="source_line" href="#L655">655</a>
<a id="L656" class="source_line" href="#L656">656</a>
<a id="L657" class="source_line" href="#L657">657</a>
<a id="L658" class="source_line" href="#L658">658</a>
<a id="L659" class="source_line" href="#L659">659</a>
<a id="L660" class="source_line" href="#L660">660</a>
<a id="L661" class="source_line" href="#L661">661</a>
<a id="L662" class="source_line" href="#L662">662</a>
<a id="L663" class="source_line" href="#L663">663</a>
<a id="L664" class="source_line" href="#L664">664</a>
<a id="L665" class="source_line" href="#L665">665</a>
<a id="L666" class="source_line" href="#L666">666</a>
<a id="L667" class="source_line" href="#L667">667</a>
<a id="L668" class="source_line" href="#L668">668</a>
<a id="L669" class="source_line" href="#L669">669</a>
<a id="L670" class="source_line" href="#L670">670</a>
<a id="L671" class="source_line" href="#L671">671</a>
<a id="L672" class="source_line" href="#L672">672</a>
<a id="L673" class="source_line" href="#L673">673</a>
<a id="L674" class="source_line" href="#L674">674</a>
<a id="L675" class="source_line" href="#L675">675</a>
<a id="L676" class="source_line" href="#L676">676</a>
<a id="L677" class="source_line" href="#L677">677</a>
<a id="L678" class="source_line" href="#L678">678</a>
<a id="L679" class="source_line" href="#L679">679</a>
<a id="L680" class="source_line" href="#L680">680</a>
<a id="L681" class="source_line" href="#L681">681</a>
<a id="L682" class="source_line" href="#L682">682</a>
<a id="L683" class="source_line" href="#L683">683</a>
<a id="L684" class="source_line" href="#L684">684</a>
<a id="L685" class="source_line" href="#L685">685</a>
<a id="L686" class="source_line" href="#L686">686</a>
<a id="L687" class="source_line" href="#L687">687</a>
<a id="L688" class="source_line" href="#L688">688</a>
<a id="L689" class="source_line" href="#L689">689</a>
<a id="L690" class="source_line" href="#L690">690</a>
<a id="L691" class="source_line" href="#L691">691</a>
<a id="L692" class="source_line" href="#L692">692</a>
<a id="L693" class="source_line" href="#L693">693</a>
<a id="L694" class="source_line" href="#L694">694</a>
<a id="L695" class="source_line" href="#L695">695</a>
<a id="L696" class="source_line" href="#L696">696</a>
<a id="L697" class="source_line" href="#L697">697</a>
<a id="L698" class="source_line" href="#L698">698</a>
<a id="L699" class="source_line" href="#L699">699</a>
<a id="L700" class="source_line" href="#L700">700</a>
<a id="L701" class="source_line" href="#L701">701</a>
<a id="L702" class="source_line" href="#L702">702</a>
<a id="L703" class="source_line" href="#L703">703</a>
<a id="L704" class="source_line" href="#L704">704</a>
<a id="L705" class="source_line" href="#L705">705</a>
<a id="L706" class="source_line" href="#L706">706</a>
<a id="L707" class="source_line" href="#L707">707</a>
<a id="L708" class="source_line" href="#L708">708</a>
<a id="L709" class="source_line" href="#L709">709</a>
<a id="L710" class="source_line" href="#L710">710</a>
<a id="L711" class="source_line" href="#L711">711</a>
<a id="L712" class="source_line" href="#L712">712</a>
<a id="L713" class="source_line" href="#L713">713</a>
<a id="L714" class="source_line" href="#L714">714</a>
<a id="L715" class="source_line" href="#L715">715</a>
<a id="L716" class="source_line" href="#L716">716</a>
<a id="L717" class="source_line" href="#L717">717</a>
<a id="L718" class="source_line" href="#L718">718</a>
<a id="L719" class="source_line" href="#L719">719</a>
<a id="L720" class="source_line" href="#L720">720</a>
<a id="L721" class="source_line" href="#L721">721</a>
<a id="L722" class="source_line" href="#L722">722</a>
<a id="L723" class="source_line" href="#L723">723</a>
<a id="L724" class="source_line" href="#L724">724</a>
<a id="L725" class="source_line" href="#L725">725</a>
<a id="L726" class="source_line" href="#L726">726</a>
<a id="L727" class="source_line" href="#L727">727</a>
<a id="L728" class="source_line" href="#L728">728</a>
<a id="L729" class="source_line" href="#L729">729</a>
<a id="L730" class="source_line" href="#L730">730</a>
<a id="L731" class="source_line" href="#L731">731</a>
<a id="L732" class="source_line" href="#L732">732</a>
<a id="L733" class="source_line" href="#L733">733</a>
<a id="L734" class="source_line" href="#L734">734</a>
<a id="L735" class="source_line" href="#L735">735</a>
<a id="L736" class="source_line" href="#L736">736</a>
<a id="L737" class="source_line" href="#L737">737</a>
<a id="L738" class="source_line" href="#L738">738</a>
<a id="L739" class="source_line" href="#L739">739</a>
<a id="L740" class="source_line" href="#L740">740</a>
<a id="L741" class="source_line" href="#L741">741</a>
<a id="L742" class="source_line" href="#L742">742</a>
<a id="L743" class="source_line" href="#L743">743</a>
<a id="L744" class="source_line" href="#L744">744</a>
<a id="L745" class="source_line" href="#L745">745</a>
<a id="L746" class="source_line" href="#L746">746</a>
<a id="L747" class="source_line" href="#L747">747</a>
<a id="L748" class="source_line" href="#L748">748</a>
<a id="L749" class="source_line" href="#L749">749</a>
<a id="L750" class="source_line" href="#L750">750</a>
<a id="L751" class="source_line" href="#L751">751</a>
<a id="L752" class="source_line" href="#L752">752</a>
<a id="L753" class="source_line" href="#L753">753</a>
<a id="L754" class="source_line" href="#L754">754</a>
<a id="L755" class="source_line" href="#L755">755</a>
<a id="L756" class="source_line" href="#L756">756</a>
<a id="L757" class="source_line" href="#L757">757</a>
<a id="L758" class="source_line" href="#L758">758</a>
<a id="L759" class="source_line" href="#L759">759</a>
<a id="L760" class="source_line" href="#L760">760</a>
<a id="L761" class="source_line" href="#L761">761</a>
<a id="L762" class="source_line" href="#L762">762</a>
<a id="L763" class="source_line" href="#L763">763</a>
<a id="L764" class="source_line" href="#L764">764</a>
<a id="L765" class="source_line" href="#L765">765</a>
<a id="L766" class="source_line" href="#L766">766</a>
<a id="L767" class="source_line" href="#L767">767</a>
<a id="L768" class="source_line" href="#L768">768</a>
<a id="L769" class="source_line" href="#L769">769</a>
<a id="L770" class="source_line" href="#L770">770</a>
<a id="L771" class="source_line" href="#L771">771</a>
<a id="L772" class="source_line" href="#L772">772</a>
<a id="L773" class="source_line" href="#L773">773</a>
<a id="L774" class="source_line" href="#L774">774</a>
<a id="L775" class="source_line" href="#L775">775</a>
<a id="L776" class="source_line" href="#L776">776</a>
<a id="L777" class="source_line" href="#L777">777</a>
<a id="L778" class="source_line" href="#L778">778</a>
<a id="L779" class="source_line" href="#L779">779</a>
<a id="L780" class="source_line" href="#L780">780</a>
<a id="L781" class="source_line" href="#L781">781</a>
<a id="L782" class="source_line" href="#L782">782</a>
<a id="L783" class="source_line" href="#L783">783</a>
<a id="L784" class="source_line" href="#L784">784</a>
<a id="L785" class="source_line" href="#L785">785</a>
<a id="L786" class="source_line" href="#L786">786</a>
<a id="L787" class="source_line" href="#L787">787</a>
<a id="L788" class="source_line" href="#L788">788</a>
<a id="L789" class="source_line" href="#L789">789</a>
<a id="L790" class="source_line" href="#L790">790</a>
<a id="L791" class="source_line" href="#L791">791</a>
<a id="L792" class="source_line" href="#L792">792</a>
<a id="L793" class="source_line" href="#L793">793</a>
<a id="L794" class="source_line" href="#L794">794</a>
<a id="L795" class="source_line" href="#L795">795</a>
<a id="L796" class="source_line" href="#L796">796</a>
<a id="L797" class="source_line" href="#L797">797</a>
<a id="L798" class="source_line" href="#L798">798</a>
<a id="L799" class="source_line" href="#L799">799</a>
<a id="L800" class="source_line" href="#L800">800</a>
<a id="L801" class="source_line" href="#L801">801</a>
<a id="L802" class="source_line" href="#L802">802</a>
<a id="L803" class="source_line" href="#L803">803</a>
<a id="L804" class="source_line" href="#L804">804</a>
<a id="L805" class="source_line" href="#L805">805</a>
<a id="L806" class="source_line" href="#L806">806</a>
<a id="L807" class="source_line" href="#L807">807</a>
<a id="L808" class="source_line" href="#L808">808</a>
<a id="L809" class="source_line" href="#L809">809</a>
<a id="L810" class="source_line" href="#L810">810</a>
<a id="L811" class="source_line" href="#L811">811</a>
<a id="L812" class="source_line" href="#L812">812</a>
<a id="L813" class="source_line" href="#L813">813</a>
<a id="L814" class="source_line" href="#L814">814</a>
<a id="L815" class="source_line" href="#L815">815</a>
<a id="L816" class="source_line" href="#L816">816</a>
<a id="L817" class="source_line" href="#L817">817</a>
<a id="L818" class="source_line" href="#L818">818</a>
<a id="L819" class="source_line" href="#L819">819</a>
<a id="L820" class="source_line" href="#L820">820</a>
<a id="L821" class="source_line" href="#L821">821</a>
<a id="L822" class="source_line" href="#L822">822</a>
<a id="L823" class="source_line" href="#L823">823</a>
<a id="L824" class="source_line" href="#L824">824</a>
<a id="L825" class="source_line" href="#L825">825</a>
<a id="L826" class="source_line" href="#L826">826</a>
<a id="L827" class="source_line" href="#L827">827</a>
<a id="L828" class="source_line" href="#L828">828</a>
<a id="L829" class="source_line" href="#L829">829</a>
<a id="L830" class="source_line" href="#L830">830</a>
<a id="L831" class="source_line" href="#L831">831</a>
<a id="L832" class="source_line" href="#L832">832</a>
<a id="L833" class="source_line" href="#L833">833</a>
<a id="L834" class="source_line" href="#L834">834</a>
<a id="L835" class="source_line" href="#L835">835</a>
<a id="L836" class="source_line" href="#L836">836</a>
<a id="L837" class="source_line" href="#L837">837</a>
<a id="L838" class="source_line" href="#L838">838</a>
<a id="L839" class="source_line" href="#L839">839</a>
<a id="L840" class="source_line" href="#L840">840</a>
<a id="L841" class="source_line" href="#L841">841</a>
<a id="L842" class="source_line" href="#L842">842</a>
<a id="L843" class="source_line" href="#L843">843</a>
<a id="L844" class="source_line" href="#L844">844</a>
<a id="L845" class="source_line" href="#L845">845</a>
<a id="L846" class="source_line" href="#L846">846</a>
<a id="L847" class="source_line" href="#L847">847</a>
<a id="L848" class="source_line" href="#L848">848</a>
<a id="L849" class="source_line" href="#L849">849</a>
<a id="L850" class="source_line" href="#L850">850</a>
<a id="L851" class="source_line" href="#L851">851</a>
<a id="L852" class="source_line" href="#L852">852</a>
<a id="L853" class="source_line" href="#L853">853</a>
<a id="L854" class="source_line" href="#L854">854</a>
<a id="L855" class="source_line" href="#L855">855</a>
<a id="L856" class="source_line" href="#L856">856</a>
<a id="L857" class="source_line" href="#L857">857</a>
<a id="L858" class="source_line" href="#L858">858</a>
<a id="L859" class="source_line" href="#L859">859</a>
<a id="L860" class="source_line" href="#L860">860</a>
<a id="L861" class="source_line" href="#L861">861</a>
<a id="L862" class="source_line" href="#L862">862</a>
<a id="L863" class="source_line" href="#L863">863</a>
<a id="L864" class="source_line" href="#L864">864</a>
<a id="L865" class="source_line" href="#L865">865</a>
<a id="L866" class="source_line" href="#L866">866</a>
<a id="L867" class="source_line" href="#L867">867</a>
<a id="L868" class="source_line" href="#L868">868</a>
<a id="L869" class="source_line" href="#L869">869</a>
<a id="L870" class="source_line" href="#L870">870</a>
<a id="L871" class="source_line" href="#L871">871</a>
<a id="L872" class="source_line" href="#L872">872</a>
<a id="L873" class="source_line" href="#L873">873</a>
<a id="L874" class="source_line" href="#L874">874</a>
<a id="L875" class="source_line" href="#L875">875</a>
<a id="L876" class="source_line" href="#L876">876</a>
<a id="L877" class="source_line" href="#L877">877</a>
<a id="L878" class="source_line" href="#L878">878</a>
<a id="L879" class="source_line" href="#L879">879</a>
<a id="L880" class="source_line" href="#L880">880</a>
<a id="L881" class="source_line" href="#L881">881</a>
<a id="L882" class="source_line" href="#L882">882</a>
<a id="L883" class="source_line" href="#L883">883</a>
<a id="L884" class="source_line" href="#L884">884</a>
<a id="L885" class="source_line" href="#L885">885</a>
<a id="L886" class="source_line" href="#L886">886</a>
<a id="L887" class="source_line" href="#L887">887</a>
<a id="L888" class="source_line" href="#L888">888</a>
<a id="L889" class="source_line" href="#L889">889</a>
<a id="L890" class="source_line" href="#L890">890</a>
<a id="L891" class="source_line" href="#L891">891</a>
<a id="L892" class="source_line" href="#L892">892</a>
<a id="L893" class="source_line" href="#L893">893</a>
<a id="L894" class="source_line" href="#L894">894</a>
<a id="L895" class="source_line" href="#L895">895</a>
<a id="L896" class="source_line" href="#L896">896</a>
<a id="L897" class="source_line" href="#L897">897</a>
<a id="L898" class="source_line" href="#L898">898</a>
<a id="L899" class="source_line" href="#L899">899</a>
<a id="L900" class="source_line" href="#L900">900</a>
<a id="L901" class="source_line" href="#L901">901</a>
<a id="L902" class="source_line" href="#L902">902</a>
<a id="L903" class="source_line" href="#L903">903</a>
<a id="L904" class="source_line" href="#L904">904</a>
<a id="L905" class="source_line" href="#L905">905</a>
<a id="L906" class="source_line" href="#L906">906</a>
<a id="L907" class="source_line" href="#L907">907</a>
<a id="L908" class="source_line" href="#L908">908</a>
<a id="L909" class="source_line" href="#L909">909</a>
<a id="L910" class="source_line" href="#L910">910</a>
<a id="L911" class="source_line" href="#L911">911</a>
<a id="L912" class="source_line" href="#L912">912</a>
<a id="L913" class="source_line" href="#L913">913</a>
<a id="L914" class="source_line" href="#L914">914</a>
<a id="L915" class="source_line" href="#L915">915</a>
<a id="L916" class="source_line" href="#L916">916</a>
<a id="L917" class="source_line" href="#L917">917</a>
<a id="L918" class="source_line" href="#L918">918</a>
<a id="L919" class="source_line" href="#L919">919</a>
<a id="L920" class="source_line" href="#L920">920</a>
<a id="L921" class="source_line" href="#L921">921</a>
<a id="L922" class="source_line" href="#L922">922</a>
<a id="L923" class="source_line" href="#L923">923</a>
<a id="L924" class="source_line" href="#L924">924</a>
<a id="L925" class="source_line" href="#L925">925</a>
<a id="L926" class="source_line" href="#L926">926</a>
<a id="L927" class="source_line" href="#L927">927</a>
<a id="L928" class="source_line" href="#L928">928</a>
<a id="L929" class="source_line" href="#L929">929</a>
<a id="L930" class="source_line" href="#L930">930</a>
<a id="L931" class="source_line" href="#L931">931</a>
<a id="L932" class="source_line" href="#L932">932</a>
<a id="L933" class="source_line" href="#L933">933</a>
<a id="L934" class="source_line" href="#L934">934</a>
<a id="L935" class="source_line" href="#L935">935</a>
<a id="L936" class="source_line" href="#L936">936</a>
<a id="L937" class="source_line" href="#L937">937</a>
<a id="L938" class="source_line" href="#L938">938</a>
<a id="L939" class="source_line" href="#L939">939</a>
<a id="L940" class="source_line" href="#L940">940</a>
<a id="L941" class="source_line" href="#L941">941</a>
<a id="L942" class="source_line" href="#L942">942</a>
<a id="L943" class="source_line" href="#L943">943</a>
<a id="L944" class="source_line" href="#L944">944</a>
<a id="L945" class="source_line" href="#L945">945</a>
<a id="L946" class="source_line" href="#L946">946</a>
<a id="L947" class="source_line" href="#L947">947</a>
<a id="L948" class="source_line" href="#L948">948</a>
<a id="L949" class="source_line" href="#L949">949</a>
<a id="L950" class="source_line" href="#L950">950</a>
<a id="L951" class="source_line" href="#L951">951</a>
<a id="L952" class="source_line" href="#L952">952</a>
<a id="L953" class="source_line" href="#L953">953</a>
<a id="L954" class="source_line" href="#L954">954</a>
<a id="L955" class="source_line" href="#L955">955</a>
<a id="L956" class="source_line" href="#L956">956</a>
<a id="L957" class="source_line" href="#L957">957</a>
<a id="L958" class="source_line" href="#L958">958</a>
<a id="L959" class="source_line" href="#L959">959</a>
<a id="L960" class="source_line" href="#L960">960</a>
<a id="L961" class="source_line" href="#L961">961</a>
<a id="L962" class="source_line" href="#L962">962</a>
<a id="L963" class="source_line" href="#L963">963</a>
<a id="L964" class="source_line" href="#L964">964</a>
<a id="L965" class="source_line" href="#L965">965</a>
<a id="L966" class="source_line" href="#L966">966</a>
<a id="L967" class="source_line" href="#L967">967</a>
<a id="L968" class="source_line" href="#L968">968</a>
<a id="L969" class="source_line" href="#L969">969</a>
<a id="L970" class="source_line" href="#L970">970</a>
<a id="L971" class="source_line" href="#L971">971</a>
<a id="L972" class="source_line" href="#L972">972</a>
<a id="L973" class="source_line" href="#L973">973</a>
<a id="L974" class="source_line" href="#L974">974</a>
<a id="L975" class="source_line" href="#L975">975</a>
<a id="L976" class="source_line" href="#L976">976</a>
<a id="L977" class="source_line" href="#L977">977</a>
<a id="L978" class="source_line" href="#L978">978</a>
<a id="L979" class="source_line" href="#L979">979</a>
<a id="L980" class="source_line" href="#L980">980</a>
<a id="L981" class="source_line" href="#L981">981</a>
<a id="L982" class="source_line" href="#L982">982</a>
<a id="L983" class="source_line" href="#L983">983</a>
<a id="L984" class="source_line" href="#L984">984</a>
<a id="L985" class="source_line" href="#L985">985</a>
<a id="L986" class="source_line" href="#L986">986</a>
<a id="L987" class="source_line" href="#L987">987</a>
<a id="L988" class="source_line" href="#L988">988</a>
<a id="L989" class="source_line" href="#L989">989</a>
<a id="L990" class="source_line" href="#L990">990</a>
<a id="L991" class="source_line" href="#L991">991</a>
<a id="L992" class="source_line" href="#L992">992</a>
<a id="L993" class="source_line" href="#L993">993</a>
<a id="L994" class="source_line" href="#L994">994</a>
<a id="L995" class="source_line" href="#L995">995</a>
<a id="L996" class="source_line" href="#L996">996</a>
<a id="L997" class="source_line" href="#L997">997</a>
<a id="L998" class="source_line" href="#L998">998</a>
<a id="L999" class="source_line" href="#L999">999</a>
<a id="L1000" class="source_line" href="#L1000">1000</a>
<a id="L1001" class="source_line" href="#L1001">1001</a>
<a id="L1002" class="source_line" href="#L1002">1002</a>
<a id="L1003" class="source_line" href="#L1003">1003</a>
<a id="L1004" class="source_line" href="#L1004">1004</a>
<a id="L1005" class="source_line" href="#L1005">1005</a>
<a id="L1006" class="source_line" href="#L1006">1006</a>
<a id="L1007" class="source_line" href="#L1007">1007</a>
<a id="L1008" class="source_line" href="#L1008">1008</a>
<a id="L1009" class="source_line" href="#L1009">1009</a>
<a id="L1010" class="source_line" href="#L1010">1010</a>
<a id="L1011" class="source_line" href="#L1011">1011</a>
<a id="L1012" class="source_line" href="#L1012">1012</a>
<a id="L1013" class="source_line" href="#L1013">1013</a>
<a id="L1014" class="source_line" href="#L1014">1014</a>
<a id="L1015" class="source_line" href="#L1015">1015</a>
<a id="L1016" class="source_line" href="#L1016">1016</a>
<a id="L1017" class="source_line" href="#L1017">1017</a>
<a id="L1018" class="source_line" href="#L1018">1018</a>
<a id="L1019" class="source_line" href="#L1019">1019</a>
<a id="L1020" class="source_line" href="#L1020">1020</a>
<a id="L1021" class="source_line" href="#L1021">1021</a>
<a id="L1022" class="source_line" href="#L1022">1022</a>
<a id="L1023" class="source_line" href="#L1023">1023</a>
<a id="L1024" class="source_line" href="#L1024">1024</a>
<a id="L1025" class="source_line" href="#L1025">1025</a>
<a id="L1026" class="source_line" href="#L1026">1026</a>
<a id="L1027" class="source_line" href="#L1027">1027</a>
<a id="L1028" class="source_line" href="#L1028">1028</a>
<a id="L1029" class="source_line" href="#L1029">1029</a>
<a id="L1030" class="source_line" href="#L1030">1030</a>
<a id="L1031" class="source_line" href="#L1031">1031</a>
<a id="L1032" class="source_line" href="#L1032">1032</a>
<a id="L1033" class="source_line" href="#L1033">1033</a>
<a id="L1034" class="source_line" href="#L1034">1034</a>
<a id="L1035" class="source_line" href="#L1035">1035</a>
<a id="L1036" class="source_line" href="#L1036">1036</a>
<a id="L1037" class="source_line" href="#L1037">1037</a>
<a id="L1038" class="source_line" href="#L1038">1038</a>
<a id="L1039" class="source_line" href="#L1039">1039</a>
<a id="L1040" class="source_line" href="#L1040">1040</a>
<a id="L1041" class="source_line" href="#L1041">1041</a>
<a id="L1042" class="source_line" href="#L1042">1042</a>
<a id="L1043" class="source_line" href="#L1043">1043</a>
<a id="L1044" class="source_line" href="#L1044">1044</a>
<a id="L1045" class="source_line" href="#L1045">1045</a>
<a id="L1046" class="source_line" href="#L1046">1046</a>
<a id="L1047" class="source_line" href="#L1047">1047</a>
<a id="L1048" class="source_line" href="#L1048">1048</a>
<a id="L1049" class="source_line" href="#L1049">1049</a>
<a id="L1050" class="source_line" href="#L1050">1050</a>
<a id="L1051" class="source_line" href="#L1051">1051</a>
<a id="L1052" class="source_line" href="#L1052">1052</a>
<a id="L1053" class="source_line" href="#L1053">1053</a>
<a id="L1054" class="source_line" href="#L1054">1054</a>
<a id="L1055" class="source_line" href="#L1055">1055</a>
<a id="L1056" class="source_line" href="#L1056">1056</a>
<a id="L1057" class="source_line" href="#L1057">1057</a>
<a id="L1058" class="source_line" href="#L1058">1058</a>
<a id="L1059" class="source_line" href="#L1059">1059</a>
<a id="L1060" class="source_line" href="#L1060">1060</a>
<a id="L1061" class="source_line" href="#L1061">1061</a>
<a id="L1062" class="source_line" href="#L1062">1062</a>
<a id="L1063" class="source_line" href="#L1063">1063</a>
<a id="L1064" class="source_line" href="#L1064">1064</a>
<a id="L1065" class="source_line" href="#L1065">1065</a>
<a id="L1066" class="source_line" href="#L1066">1066</a>
<a id="L1067" class="source_line" href="#L1067">1067</a>
<a id="L1068" class="source_line" href="#L1068">1068</a>
<a id="L1069" class="source_line" href="#L1069">1069</a>
<a id="L1070" class="source_line" href="#L1070">1070</a>
<a id="L1071" class="source_line" href="#L1071">1071</a>
<a id="L1072" class="source_line" href="#L1072">1072</a>
<a id="L1073" class="source_line" href="#L1073">1073</a>
<a id="L1074" class="source_line" href="#L1074">1074</a>
<a id="L1075" class="source_line" href="#L1075">1075</a>
<a id="L1076" class="source_line" href="#L1076">1076</a>
<a id="L1077" class="source_line" href="#L1077">1077</a>
<a id="L1078" class="source_line" href="#L1078">1078</a>
<a id="L1079" class="source_line" href="#L1079">1079</a>
<a id="L1080" class="source_line" href="#L1080">1080</a>
<a id="L1081" class="source_line" href="#L1081">1081</a>
<a id="L1082" class="source_line" href="#L1082">1082</a>
<a id="L1083" class="source_line" href="#L1083">1083</a>
<a id="L1084" class="source_line" href="#L1084">1084</a>
<a id="L1085" class="source_line" href="#L1085">1085</a>
<a id="L1086" class="source_line" href="#L1086">1086</a>
<a id="L1087" class="source_line" href="#L1087">1087</a>
<a id="L1088" class="source_line" href="#L1088">1088</a>
<a id="L1089" class="source_line" href="#L1089">1089</a>
<a id="L1090" class="source_line" href="#L1090">1090</a>
<a id="L1091" class="source_line" href="#L1091">1091</a>
<a id="L1092" class="source_line" href="#L1092">1092</a>
<a id="L1093" class="source_line" href="#L1093">1093</a>
<a id="L1094" class="source_line" href="#L1094">1094</a>
<a id="L1095" class="source_line" href="#L1095">1095</a>
<a id="L1096" class="source_line" href="#L1096">1096</a>
<a id="L1097" class="source_line" href="#L1097">1097</a>
<a id="L1098" class="source_line" href="#L1098">1098</a>
<a id="L1099" class="source_line" href="#L1099">1099</a>
<a id="L1100" class="source_line" href="#L1100">1100</a>
<a id="L1101" class="source_line" href="#L1101">1101</a>
<a id="L1102" class="source_line" href="#L1102">1102</a>
<a id="L1103" class="source_line" href="#L1103">1103</a>
<a id="L1104" class="source_line" href="#L1104">1104</a>
<a id="L1105" class="source_line" href="#L1105">1105</a>
<a id="L1106" class="source_line" href="#L1106">1106</a>
<a id="L1107" class="source_line" href="#L1107">1107</a>
<a id="L1108" class="source_line" href="#L1108">1108</a>
<a id="L1109" class="source_line" href="#L1109">1109</a>
<a id="L1110" class="source_line" href="#L1110">1110</a>
<a id="L1111" class="source_line" href="#L1111">1111</a>
<a id="L1112" class="source_line" href="#L1112">1112</a>
<a id="L1113" class="source_line" href="#L1113">1113</a>
<a id="L1114" class="source_line" href="#L1114">1114</a>
<a id="L1115" class="source_line" href="#L1115">1115</a>
<a id="L1116" class="source_line" href="#L1116">1116</a>
<a id="L1117" class="source_line" href="#L1117">1117</a>
<a id="L1118" class="source_line" href="#L1118">1118</a>
<a id="L1119" class="source_line" href="#L1119">1119</a>
<a id="L1120" class="source_line" href="#L1120">1120</a>
<a id="L1121" class="source_line" href="#L1121">1121</a>
<a id="L1122" class="source_line" href="#L1122">1122</a>
<a id="L1123" class="source_line" href="#L1123">1123</a>
<a id="L1124" class="source_line" href="#L1124">1124</a>
<a id="L1125" class="source_line" href="#L1125">1125</a>
<a id="L1126" class="source_line" href="#L1126">1126</a>
<a id="L1127" class="source_line" href="#L1127">1127</a>
<a id="L1128" class="source_line" href="#L1128">1128</a>
<a id="L1129" class="source_line" href="#L1129">1129</a>
<a id="L1130" class="source_line" href="#L1130">1130</a>
<a id="L1131" class="source_line" href="#L1131">1131</a>
<a id="L1132" class="source_line" href="#L1132">1132</a>
<a id="L1133" class="source_line" href="#L1133">1133</a>
<a id="L1134" class="source_line" href="#L1134">1134</a>
<a id="L1135" class="source_line" href="#L1135">1135</a>
<a id="L1136" class="source_line" href="#L1136">1136</a>
<a id="L1137" class="source_line" href="#L1137">1137</a>
<a id="L1138" class="source_line" href="#L1138">1138</a>
<a id="L1139" class="source_line" href="#L1139">1139</a>
<a id="L1140" class="source_line" href="#L1140">1140</a>
<a id="L1141" class="source_line" href="#L1141">1141</a>
<a id="L1142" class="source_line" href="#L1142">1142</a>
<a id="L1143" class="source_line" href="#L1143">1143</a>
<a id="L1144" class="source_line" href="#L1144">1144</a>
<a id="L1145" class="source_line" href="#L1145">1145</a>
<a id="L1146" class="source_line" href="#L1146">1146</a>
<a id="L1147" class="source_line" href="#L1147">1147</a>
<a id="L1148" class="source_line" href="#L1148">1148</a>
<a id="L1149" class="source_line" href="#L1149">1149</a>
<a id="L1150" class="source_line" href="#L1150">1150</a>
<a id="L1151" class="source_line" href="#L1151">1151</a>
<a id="L1152" class="source_line" href="#L1152">1152</a>
<a id="L1153" class="source_line" href="#L1153">1153</a>
<a id="L1154" class="source_line" href="#L1154">1154</a>
<a id="L1155" class="source_line" href="#L1155">1155</a>
<a id="L1156" class="source_line" href="#L1156">1156</a>
<a id="L1157" class="source_line" href="#L1157">1157</a>
<a id="L1158" class="source_line" href="#L1158">1158</a>
<a id="L1159" class="source_line" href="#L1159">1159</a>
<a id="L1160" class="source_line" href="#L1160">1160</a>
<a id="L1161" class="source_line" href="#L1161">1161</a>
<a id="L1162" class="source_line" href="#L1162">1162</a>
<a id="L1163" class="source_line" href="#L1163">1163</a>
<a id="L1164" class="source_line" href="#L1164">1164</a>
<a id="L1165" class="source_line" href="#L1165">1165</a>
<a id="L1166" class="source_line" href="#L1166">1166</a>
<a id="L1167" class="source_line" href="#L1167">1167</a>
<a id="L1168" class="source_line" href="#L1168">1168</a>
<a id="L1169" class="source_line" href="#L1169">1169</a>
<a id="L1170" class="source_line" href="#L1170">1170</a>
<a id="L1171" class="source_line" href="#L1171">1171</a>
<a id="L1172" class="source_line" href="#L1172">1172</a>
<a id="L1173" class="source_line" href="#L1173">1173</a>
<a id="L1174" class="source_line" href="#L1174">1174</a>
<a id="L1175" class="source_line" href="#L1175">1175</a>
<a id="L1176" class="source_line" href="#L1176">1176</a>
<a id="L1177" class="source_line" href="#L1177">1177</a>
<a id="L1178" class="source_line" href="#L1178">1178</a>
<a id="L1179" class="source_line" href="#L1179">1179</a>
<a id="L1180" class="source_line" href="#L1180">1180</a>
<a id="L1181" class="source_line" href="#L1181">1181</a>
<a id="L1182" class="source_line" href="#L1182">1182</a>
<a id="L1183" class="source_line" href="#L1183">1183</a>
<a id="L1184" class="source_line" href="#L1184">1184</a>
<a id="L1185" class="source_line" href="#L1185">1185</a>
<a id="L1186" class="source_line" href="#L1186">1186</a>
<a id="L1187" class="source_line" href="#L1187">1187</a>
<a id="L1188" class="source_line" href="#L1188">1188</a>
<a id="L1189" class="source_line" href="#L1189">1189</a>
<a id="L1190" class="source_line" href="#L1190">1190</a>
<a id="L1191" class="source_line" href="#L1191">1191</a>
<a id="L1192" class="source_line" href="#L1192">1192</a>
<a id="L1193" class="source_line" href="#L1193">1193</a>
<a id="L1194" class="source_line" href="#L1194">1194</a>
<a id="L1195" class="source_line" href="#L1195">1195</a>
<a id="L1196" class="source_line" href="#L1196">1196</a>
<a id="L1197" class="source_line" href="#L1197">1197</a>
<a id="L1198" class="source_line" href="#L1198">1198</a>
<a id="L1199" class="source_line" href="#L1199">1199</a>
<a id="L1200" class="source_line" href="#L1200">1200</a>
<a id="L1201" class="source_line" href="#L1201">1201</a>
<a id="L1202" class="source_line" href="#L1202">1202</a>
<a id="L1203" class="source_line" href="#L1203">1203</a>
<a id="L1204" class="source_line" href="#L1204">1204</a>
<a id="L1205" class="source_line" href="#L1205">1205</a>
<a id="L1206" class="source_line" href="#L1206">1206</a>
<a id="L1207" class="source_line" href="#L1207">1207</a>
<a id="L1208" class="source_line" href="#L1208">1208</a>
<a id="L1209" class="source_line" href="#L1209">1209</a>
<a id="L1210" class="source_line" href="#L1210">1210</a>
<a id="L1211" class="source_line" href="#L1211">1211</a>
<a id="L1212" class="source_line" href="#L1212">1212</a>
<a id="L1213" class="source_line" href="#L1213">1213</a>
<a id="L1214" class="source_line" href="#L1214">1214</a>
<a id="L1215" class="source_line" href="#L1215">1215</a>
<a id="L1216" class="source_line" href="#L1216">1216</a>
<a id="L1217" class="source_line" href="#L1217">1217</a>
<a id="L1218" class="source_line" href="#L1218">1218</a>
<a id="L1219" class="source_line" href="#L1219">1219</a>
<a id="L1220" class="source_line" href="#L1220">1220</a>
<a id="L1221" class="source_line" href="#L1221">1221</a>
<a id="L1222" class="source_line" href="#L1222">1222</a>
<a id="L1223" class="source_line" href="#L1223">1223</a>
<a id="L1224" class="source_line" href="#L1224">1224</a>
<a id="L1225" class="source_line" href="#L1225">1225</a>
<a id="L1226" class="source_line" href="#L1226">1226</a>
<a id="L1227" class="source_line" href="#L1227">1227</a>
<a id="L1228" class="source_line" href="#L1228">1228</a>
<a id="L1229" class="source_line" href="#L1229">1229</a>
<a id="L1230" class="source_line" href="#L1230">1230</a>
<a id="L1231" class="source_line" href="#L1231">1231</a>
<a id="L1232" class="source_line" href="#L1232">1232</a>
<a id="L1233" class="source_line" href="#L1233">1233</a>
<a id="L1234" class="source_line" href="#L1234">1234</a>
<a id="L1235" class="source_line" href="#L1235">1235</a>
<a id="L1236" class="source_line" href="#L1236">1236</a>
<a id="L1237" class="source_line" href="#L1237">1237</a>
<a id="L1238" class="source_line" href="#L1238">1238</a>
<a id="L1239" class="source_line" href="#L1239">1239</a>
<a id="L1240" class="source_line" href="#L1240">1240</a>
<a id="L1241" class="source_line" href="#L1241">1241</a>
<a id="L1242" class="source_line" href="#L1242">1242</a>
<a id="L1243" class="source_line" href="#L1243">1243</a>
<a id="L1244" class="source_line" href="#L1244">1244</a>
<a id="L1245" class="source_line" href="#L1245">1245</a>
<a id="L1246" class="source_line" href="#L1246">1246</a>
<a id="L1247" class="source_line" href="#L1247">1247</a>
<a id="L1248" class="source_line" href="#L1248">1248</a>
<a id="L1249" class="source_line" href="#L1249">1249</a>
<a id="L1250" class="source_line" href="#L1250">1250</a>
<a id="L1251" class="source_line" href="#L1251">1251</a>
<a id="L1252" class="source_line" href="#L1252">1252</a>
<a id="L1253" class="source_line" href="#L1253">1253</a>
<a id="L1254" class="source_line" href="#L1254">1254</a>
<a id="L1255" class="source_line" href="#L1255">1255</a>
<a id="L1256" class="source_line" href="#L1256">1256</a>
<a id="L1257" class="source_line" href="#L1257">1257</a>
<a id="L1258" class="source_line" href="#L1258">1258</a>
<a id="L1259" class="source_line" href="#L1259">1259</a>
<a id="L1260" class="source_line" href="#L1260">1260</a>
<a id="L1261" class="source_line" href="#L1261">1261</a>
<a id="L1262" class="source_line" href="#L1262">1262</a>
<a id="L1263" class="source_line" href="#L1263">1263</a>
<a id="L1264" class="source_line" href="#L1264">1264</a>
<a id="L1265" class="source_line" href="#L1265">1265</a>
<a id="L1266" class="source_line" href="#L1266">1266</a>
<a id="L1267" class="source_line" href="#L1267">1267</a>
<a id="L1268" class="source_line" href="#L1268">1268</a>
<a id="L1269" class="source_line" href="#L1269">1269</a>
<a id="L1270" class="source_line" href="#L1270">1270</a>
<a id="L1271" class="source_line" href="#L1271">1271</a>
<a id="L1272" class="source_line" href="#L1272">1272</a>
<a id="L1273" class="source_line" href="#L1273">1273</a>
<a id="L1274" class="source_line" href="#L1274">1274</a>
<a id="L1275" class="source_line" href="#L1275">1275</a>
<a id="L1276" class="source_line" href="#L1276">1276</a>
<a id="L1277" class="source_line" href="#L1277">1277</a>
<a id="L1278" class="source_line" href="#L1278">1278</a>
<a id="L1279" class="source_line" href="#L1279">1279</a>
<a id="L1280" class="source_line" href="#L1280">1280</a>
<a id="L1281" class="source_line" href="#L1281">1281</a>
<a id="L1282" class="source_line" href="#L1282">1282</a>
<a id="L1283" class="source_line" href="#L1283">1283</a>
<a id="L1284" class="source_line" href="#L1284">1284</a>
<a id="L1285" class="source_line" href="#L1285">1285</a>
<a id="L1286" class="source_line" href="#L1286">1286</a>
<a id="L1287" class="source_line" href="#L1287">1287</a>
<a id="L1288" class="source_line" href="#L1288">1288</a>
<a id="L1289" class="source_line" href="#L1289">1289</a>
<a id="L1290" class="source_line" href="#L1290">1290</a>
<a id="L1291" class="source_line" href="#L1291">1291</a>
<a id="L1292" class="source_line" href="#L1292">1292</a>
<a id="L1293" class="source_line" href="#L1293">1293</a>
<a id="L1294" class="source_line" href="#L1294">1294</a>
<a id="L1295" class="source_line" href="#L1295">1295</a>
<a id="L1296" class="source_line" href="#L1296">1296</a>
<a id="L1297" class="source_line" href="#L1297">1297</a>
<a id="L1298" class="source_line" href="#L1298">1298</a>
<a id="L1299" class="source_line" href="#L1299">1299</a>
<a id="L1300" class="source_line" href="#L1300">1300</a>
<a id="L1301" class="source_line" href="#L1301">1301</a>
<a id="L1302" class="source_line" href="#L1302">1302</a>
<a id="L1303" class="source_line" href="#L1303">1303</a>
<a id="L1304" class="source_line" href="#L1304">1304</a>
<a id="L1305" class="source_line" href="#L1305">1305</a>
<a id="L1306" class="source_line" href="#L1306">1306</a>
<a id="L1307" class="source_line" href="#L1307">1307</a>
<a id="L1308" class="source_line" href="#L1308">1308</a>
<a id="L1309" class="source_line" href="#L1309">1309</a>
<a id="L1310" class="source_line" href="#L1310">1310</a>
<a id="L1311" class="source_line" href="#L1311">1311</a>
<a id="L1312" class="source_line" href="#L1312">1312</a>
<a id="L1313" class="source_line" href="#L1313">1313</a>
<a id="L1314" class="source_line" href="#L1314">1314</a>
<a id="L1315" class="source_line" href="#L1315">1315</a>
<a id="L1316" class="source_line" href="#L1316">1316</a>
<a id="L1317" class="source_line" href="#L1317">1317</a>
<a id="L1318" class="source_line" href="#L1318">1318</a>
<a id="L1319" class="source_line" href="#L1319">1319</a>
<a id="L1320" class="source_line" href="#L1320">1320</a>
<a id="L1321" class="source_line" href="#L1321">1321</a>
<a id="L1322" class="source_line" href="#L1322">1322</a>
<a id="L1323" class="source_line" href="#L1323">1323</a>
<a id="L1324" class="source_line" href="#L1324">1324</a>
<a id="L1325" class="source_line" href="#L1325">1325</a>
<a id="L1326" class="source_line" href="#L1326">1326</a>
<a id="L1327" class="source_line" href="#L1327">1327</a>
<a id="L1328" class="source_line" href="#L1328">1328</a>
<a id="L1329" class="source_line" href="#L1329">1329</a>
<a id="L1330" class="source_line" href="#L1330">1330</a>
<a id="L1331" class="source_line" href="#L1331">1331</a>
<a id="L1332" class="source_line" href="#L1332">1332</a>
<a id="L1333" class="source_line" href="#L1333">1333</a>
<a id="L1334" class="source_line" href="#L1334">1334</a>
<a id="L1335" class="source_line" href="#L1335">1335</a>
<a id="L1336" class="source_line" href="#L1336">1336</a>
<a id="L1337" class="source_line" href="#L1337">1337</a>
<a id="L1338" class="source_line" href="#L1338">1338</a>
<a id="L1339" class="source_line" href="#L1339">1339</a>
<a id="L1340" class="source_line" href="#L1340">1340</a>
<a id="L1341" class="source_line" href="#L1341">1341</a>
<a id="L1342" class="source_line" href="#L1342">1342</a>
<a id="L1343" class="source_line" href="#L1343">1343</a>
<a id="L1344" class="source_line" href="#L1344">1344</a>
<a id="L1345" class="source_line" href="#L1345">1345</a>
<a id="L1346" class="source_line" href="#L1346">1346</a>
<a id="L1347" class="source_line" href="#L1347">1347</a>
<a id="L1348" class="source_line" href="#L1348">1348</a>
<a id="L1349" class="source_line" href="#L1349">1349</a>
<a id="L1350" class="source_line" href="#L1350">1350</a>
<a id="L1351" class="source_line" href="#L1351">1351</a>
<a id="L1352" class="source_line" href="#L1352">1352</a>
<a id="L1353" class="source_line" href="#L1353">1353</a>
<a id="L1354" class="source_line" href="#L1354">1354</a>
<a id="L1355" class="source_line" href="#L1355">1355</a>
<a id="L1356" class="source_line" href="#L1356">1356</a>
<a id="L1357" class="source_line" href="#L1357">1357</a>
<a id="L1358" class="source_line" href="#L1358">1358</a>
<a id="L1359" class="source_line" href="#L1359">1359</a>
<a id="L1360" class="source_line" href="#L1360">1360</a>
<a id="L1361" class="source_line" href="#L1361">1361</a>
<a id="L1362" class="source_line" href="#L1362">1362</a>
<a id="L1363" class="source_line" href="#L1363">1363</a>
<a id="L1364" class="source_line" href="#L1364">1364</a>
<a id="L1365" class="source_line" href="#L1365">1365</a>
<a id="L1366" class="source_line" href="#L1366">1366</a>
<a id="L1367" class="source_line" href="#L1367">1367</a>
<a id="L1368" class="source_line" href="#L1368">1368</a>
<a id="L1369" class="source_line" href="#L1369">1369</a>
<a id="L1370" class="source_line" href="#L1370">1370</a>
<a id="L1371" class="source_line" href="#L1371">1371</a>
<a id="L1372" class="source_line" href="#L1372">1372</a>
<a id="L1373" class="source_line" href="#L1373">1373</a>
<a id="L1374" class="source_line" href="#L1374">1374</a>
<a id="L1375" class="source_line" href="#L1375">1375</a>
<a id="L1376" class="source_line" href="#L1376">1376</a>
<a id="L1377" class="source_line" href="#L1377">1377</a>
<a id="L1378" class="source_line" href="#L1378">1378</a>
<a id="L1379" class="source_line" href="#L1379">1379</a>
<a id="L1380" class="source_line" href="#L1380">1380</a>
<a id="L1381" class="source_line" href="#L1381">1381</a>
<a id="L1382" class="source_line" href="#L1382">1382</a>
<a id="L1383" class="source_line" href="#L1383">1383</a>
<a id="L1384" class="source_line" href="#L1384">1384</a>
<a id="L1385" class="source_line" href="#L1385">1385</a>
<a id="L1386" class="source_line" href="#L1386">1386</a>
<a id="L1387" class="source_line" href="#L1387">1387</a>
<a id="L1388" class="source_line" href="#L1388">1388</a>
<a id="L1389" class="source_line" href="#L1389">1389</a>
<a id="L1390" class="source_line" href="#L1390">1390</a>
<a id="L1391" class="source_line" href="#L1391">1391</a>
<a id="L1392" class="source_line" href="#L1392">1392</a>
<a id="L1393" class="source_line" href="#L1393">1393</a>
<a id="L1394" class="source_line" href="#L1394">1394</a>
<a id="L1395" class="source_line" href="#L1395">1395</a>
<a id="L1396" class="source_line" href="#L1396">1396</a>
<a id="L1397" class="source_line" href="#L1397">1397</a>
<a id="L1398" class="source_line" href="#L1398">1398</a>
<a id="L1399" class="source_line" href="#L1399">1399</a>
<a id="L1400" class="source_line" href="#L1400">1400</a>
<a id="L1401" class="source_line" href="#L1401">1401</a>
<a id="L1402" class="source_line" href="#L1402">1402</a>
<a id="L1403" class="source_line" href="#L1403">1403</a>
<a id="L1404" class="source_line" href="#L1404">1404</a>
<a id="L1405" class="source_line" href="#L1405">1405</a>
<a id="L1406" class="source_line" href="#L1406">1406</a>
<a id="L1407" class="source_line" href="#L1407">1407</a>
<a id="L1408" class="source_line" href="#L1408">1408</a>
<a id="L1409" class="source_line" href="#L1409">1409</a>
<a id="L1410" class="source_line" href="#L1410">1410</a>
<a id="L1411" class="source_line" href="#L1411">1411</a>
<a id="L1412" class="source_line" href="#L1412">1412</a>
<a id="L1413" class="source_line" href="#L1413">1413</a>
<a id="L1414" class="source_line" href="#L1414">1414</a>
<a id="L1415" class="source_line" href="#L1415">1415</a>
<a id="L1416" class="source_line" href="#L1416">1416</a>
<a id="L1417" class="source_line" href="#L1417">1417</a>
<a id="L1418" class="source_line" href="#L1418">1418</a>
<a id="L1419" class="source_line" href="#L1419">1419</a>
<a id="L1420" class="source_line" href="#L1420">1420</a>
<a id="L1421" class="source_line" href="#L1421">1421</a>
<a id="L1422" class="source_line" href="#L1422">1422</a>
<a id="L1423" class="source_line" href="#L1423">1423</a>
<a id="L1424" class="source_line" href="#L1424">1424</a>
<a id="L1425" class="source_line" href="#L1425">1425</a>
<a id="L1426" class="source_line" href="#L1426">1426</a>
<a id="L1427" class="source_line" href="#L1427">1427</a>
<a id="L1428" class="source_line" href="#L1428">1428</a>
<a id="L1429" class="source_line" href="#L1429">1429</a>
<a id="L1430" class="source_line" href="#L1430">1430</a>
<a id="L1431" class="source_line" href="#L1431">1431</a>
<a id="L1432" class="source_line" href="#L1432">1432</a>
<a id="L1433" class="source_line" href="#L1433">1433</a>
<a id="L1434" class="source_line" href="#L1434">1434</a>
<a id="L1435" class="source_line" href="#L1435">1435</a>
<a id="L1436" class="source_line" href="#L1436">1436</a>
<a id="L1437" class="source_line" href="#L1437">1437</a>
<a id="L1438" class="source_line" href="#L1438">1438</a>
<a id="L1439" class="source_line" href="#L1439">1439</a>
<a id="L1440" class="source_line" href="#L1440">1440</a>
<a id="L1441" class="source_line" href="#L1441">1441</a>
<a id="L1442" class="source_line" href="#L1442">1442</a>
<a id="L1443" class="source_line" href="#L1443">1443</a>
<a id="L1444" class="source_line" href="#L1444">1444</a>
<a id="L1445" class="source_line" href="#L1445">1445</a>
<a id="L1446" class="source_line" href="#L1446">1446</a>
<a id="L1447" class="source_line" href="#L1447">1447</a>
<a id="L1448" class="source_line" href="#L1448">1448</a>
<a id="L1449" class="source_line" href="#L1449">1449</a>
<a id="L1450" class="source_line" href="#L1450">1450</a>
<a id="L1451" class="source_line" href="#L1451">1451</a>
<a id="L1452" class="source_line" href="#L1452">1452</a>
<a id="L1453" class="source_line" href="#L1453">1453</a>
<a id="L1454" class="source_line" href="#L1454">1454</a>
<a id="L1455" class="source_line" href="#L1455">1455</a>
<a id="L1456" class="source_line" href="#L1456">1456</a>
<a id="L1457" class="source_line" href="#L1457">1457</a>
<a id="L1458" class="source_line" href="#L1458">1458</a>
<a id="L1459" class="source_line" href="#L1459">1459</a>
<a id="L1460" class="source_line" href="#L1460">1460</a>
<a id="L1461" class="source_line" href="#L1461">1461</a>
<a id="L1462" class="source_line" href="#L1462">1462</a>
<a id="L1463" class="source_line" href="#L1463">1463</a>
<a id="L1464" class="source_line" href="#L1464">1464</a>
<a id="L1465" class="source_line" href="#L1465">1465</a>
<a id="L1466" class="source_line" href="#L1466">1466</a>
<a id="L1467" class="source_line" href="#L1467">1467</a>
<a id="L1468" class="source_line" href="#L1468">1468</a>
<a id="L1469" class="source_line" href="#L1469">1469</a>
<a id="L1470" class="source_line" href="#L1470">1470</a>
<a id="L1471" class="source_line" href="#L1471">1471</a>
<a id="L1472" class="source_line" href="#L1472">1472</a>
<a id="L1473" class="source_line" href="#L1473">1473</a>
<a id="L1474" class="source_line" href="#L1474">1474</a>
<a id="L1475" class="source_line" href="#L1475">1475</a>
<a id="L1476" class="source_line" href="#L1476">1476</a>
<a id="L1477" class="source_line" href="#L1477">1477</a>
<a id="L1478" class="source_line" href="#L1478">1478</a>
<a id="L1479" class="source_line" href="#L1479">1479</a>
<a id="L1480" class="source_line" href="#L1480">1480</a>
<a id="L1481" class="source_line" href="#L1481">1481</a>
<a id="L1482" class="source_line" href="#L1482">1482</a>
<a id="L1483" class="source_line" href="#L1483">1483</a>
<a id="L1484" class="source_line" href="#L1484">1484</a>
<a id="L1485" class="source_line" href="#L1485">1485</a>
<a id="L1486" class="source_line" href="#L1486">1486</a>
<a id="L1487" class="source_line" href="#L1487">1487</a>
<a id="L1488" class="source_line" href="#L1488">1488</a>
<a id="L1489" class="source_line" href="#L1489">1489</a>
<a id="L1490" class="source_line" href="#L1490">1490</a>
<a id="L1491" class="source_line" href="#L1491">1491</a>
<a id="L1492" class="source_line" href="#L1492">1492</a>
<a id="L1493" class="source_line" href="#L1493">1493</a>
<a id="L1494" class="source_line" href="#L1494">1494</a>
<a id="L1495" class="source_line" href="#L1495">1495</a>
<a id="L1496" class="source_line" href="#L1496">1496</a>
<a id="L1497" class="source_line" href="#L1497">1497</a>
<a id="L1498" class="source_line" href="#L1498">1498</a>
<a id="L1499" class="source_line" href="#L1499">1499</a>
<a id="L1500" class="source_line" href="#L1500">1500</a>
<a id="L1501" class="source_line" href="#L1501">1501</a>
<a id="L1502" class="source_line" href="#L1502">1502</a>
<a id="L1503" class="source_line" href="#L1503">1503</a>
<a id="L1504" class="source_line" href="#L1504">1504</a>
<a id="L1505" class="source_line" href="#L1505">1505</a>
<a id="L1506" class="source_line" href="#L1506">1506</a>
<a id="L1507" class="source_line" href="#L1507">1507</a>
<a id="L1508" class="source_line" href="#L1508">1508</a>
<a id="L1509" class="source_line" href="#L1509">1509</a>
<a id="L1510" class="source_line" href="#L1510">1510</a>
<a id="L1511" class="source_line" href="#L1511">1511</a>
<a id="L1512" class="source_line" href="#L1512">1512</a>
<a id="L1513" class="source_line" href="#L1513">1513</a>
<a id="L1514" class="source_line" href="#L1514">1514</a>
<a id="L1515" class="source_line" href="#L1515">1515</a>
<a id="L1516" class="source_line" href="#L1516">1516</a>
<a id="L1517" class="source_line" href="#L1517">1517</a>
<a id="L1518" class="source_line" href="#L1518">1518</a>
<a id="L1519" class="source_line" href="#L1519">1519</a>
<a id="L1520" class="source_line" href="#L1520">1520</a>
<a id="L1521" class="source_line" href="#L1521">1521</a>
<a id="L1522" class="source_line" href="#L1522">1522</a>
<a id="L1523" class="source_line" href="#L1523">1523</a>
<a id="L1524" class="source_line" href="#L1524">1524</a>
<a id="L1525" class="source_line" href="#L1525">1525</a>
<a id="L1526" class="source_line" href="#L1526">1526</a>
<a id="L1527" class="source_line" href="#L1527">1527</a>
<a id="L1528" class="source_line" href="#L1528">1528</a>
<a id="L1529" class="source_line" href="#L1529">1529</a>
<a id="L1530" class="source_line" href="#L1530">1530</a>
<a id="L1531" class="source_line" href="#L1531">1531</a>
<a id="L1532" class="source_line" href="#L1532">1532</a>
<a id="L1533" class="source_line" href="#L1533">1533</a>
<a id="L1534" class="source_line" href="#L1534">1534</a>
<a id="L1535" class="source_line" href="#L1535">1535</a>
<a id="L1536" class="source_line" href="#L1536">1536</a>
<a id="L1537" class="source_line" href="#L1537">1537</a>
<a id="L1538" class="source_line" href="#L1538">1538</a>
<a id="L1539" class="source_line" href="#L1539">1539</a>
<a id="L1540" class="source_line" href="#L1540">1540</a>
<a id="L1541" class="source_line" href="#L1541">1541</a>
<a id="L1542" class="source_line" href="#L1542">1542</a>
<a id="L1543" class="source_line" href="#L1543">1543</a>
<a id="L1544" class="source_line" href="#L1544">1544</a>
<a id="L1545" class="source_line" href="#L1545">1545</a>
<a id="L1546" class="source_line" href="#L1546">1546</a>
<a id="L1547" class="source_line" href="#L1547">1547</a>
<a id="L1548" class="source_line" href="#L1548">1548</a>
<a id="L1549" class="source_line" href="#L1549">1549</a>
<a id="L1550" class="source_line" href="#L1550">1550</a>
<a id="L1551" class="source_line" href="#L1551">1551</a>
<a id="L1552" class="source_line" href="#L1552">1552</a>
<a id="L1553" class="source_line" href="#L1553">1553</a>
<a id="L1554" class="source_line" href="#L1554">1554</a>
<a id="L1555" class="source_line" href="#L1555">1555</a>
<a id="L1556" class="source_line" href="#L1556">1556</a>
<a id="L1557" class="source_line" href="#L1557">1557</a>
<a id="L1558" class="source_line" href="#L1558">1558</a>
<a id="L1559" class="source_line" href="#L1559">1559</a>
<a id="L1560" class="source_line" href="#L1560">1560</a>
<a id="L1561" class="source_line" href="#L1561">1561</a>
<a id="L1562" class="source_line" href="#L1562">1562</a>
<a id="L1563" class="source_line" href="#L1563">1563</a>
<a id="L1564" class="source_line" href="#L1564">1564</a>
<a id="L1565" class="source_line" href="#L1565">1565</a>
<a id="L1566" class="source_line" href="#L1566">1566</a>
<a id="L1567" class="source_line" href="#L1567">1567</a>
<a id="L1568" class="source_line" href="#L1568">1568</a>
<a id="L1569" class="source_line" href="#L1569">1569</a>
<a id="L1570" class="source_line" href="#L1570">1570</a>
<a id="L1571" class="source_line" href="#L1571">1571</a>
<a id="L1572" class="source_line" href="#L1572">1572</a>
<a id="L1573" class="source_line" href="#L1573">1573</a>
<a id="L1574" class="source_line" href="#L1574">1574</a>
<a id="L1575" class="source_line" href="#L1575">1575</a>
<a id="L1576" class="source_line" href="#L1576">1576</a>
<a id="L1577" class="source_line" href="#L1577">1577</a>
<a id="L1578" class="source_line" href="#L1578">1578</a>
<a id="L1579" class="source_line" href="#L1579">1579</a>
<a id="L1580" class="source_line" href="#L1580">1580</a>
<a id="L1581" class="source_line" href="#L1581">1581</a>
<a id="L1582" class="source_line" href="#L1582">1582</a>
<a id="L1583" class="source_line" href="#L1583">1583</a>
<a id="L1584" class="source_line" href="#L1584">1584</a>
<a id="L1585" class="source_line" href="#L1585">1585</a>
<a id="L1586" class="source_line" href="#L1586">1586</a>
<a id="L1587" class="source_line" href="#L1587">1587</a>
<a id="L1588" class="source_line" href="#L1588">1588</a>
<a id="L1589" class="source_line" href="#L1589">1589</a>
<a id="L1590" class="source_line" href="#L1590">1590</a>
<a id="L1591" class="source_line" href="#L1591">1591</a>
<a id="L1592" class="source_line" href="#L1592">1592</a>
<a id="L1593" class="source_line" href="#L1593">1593</a>
<a id="L1594" class="source_line" href="#L1594">1594</a>
<a id="L1595" class="source_line" href="#L1595">1595</a>
<a id="L1596" class="source_line" href="#L1596">1596</a>
<a id="L1597" class="source_line" href="#L1597">1597</a>
<a id="L1598" class="source_line" href="#L1598">1598</a>
<a id="L1599" class="source_line" href="#L1599">1599</a>
<a id="L1600" class="source_line" href="#L1600">1600</a>
<a id="L1601" class="source_line" href="#L1601">1601</a>
<a id="L1602" class="source_line" href="#L1602">1602</a>
<a id="L1603" class="source_line" href="#L1603">1603</a>
<a id="L1604" class="source_line" href="#L1604">1604</a>
<a id="L1605" class="source_line" href="#L1605">1605</a>
<a id="L1606" class="source_line" href="#L1606">1606</a>
<a id="L1607" class="source_line" href="#L1607">1607</a>
<a id="L1608" class="source_line" href="#L1608">1608</a>
<a id="L1609" class="source_line" href="#L1609">1609</a>
<a id="L1610" class="source_line" href="#L1610">1610</a>
<a id="L1611" class="source_line" href="#L1611">1611</a>
<a id="L1612" class="source_line" href="#L1612">1612</a>
<a id="L1613" class="source_line" href="#L1613">1613</a>
<a id="L1614" class="source_line" href="#L1614">1614</a>
<a id="L1615" class="source_line" href="#L1615">1615</a>
<a id="L1616" class="source_line" href="#L1616">1616</a>
<a id="L1617" class="source_line" href="#L1617">1617</a>
<a id="L1618" class="source_line" href="#L1618">1618</a>
<a id="L1619" class="source_line" href="#L1619">1619</a>
<a id="L1620" class="source_line" href="#L1620">1620</a>
<a id="L1621" class="source_line" href="#L1621">1621</a>
<a id="L1622" class="source_line" href="#L1622">1622</a>
<a id="L1623" class="source_line" href="#L1623">1623</a>
<a id="L1624" class="source_line" href="#L1624">1624</a>
<a id="L1625" class="source_line" href="#L1625">1625</a>
<a id="L1626" class="source_line" href="#L1626">1626</a>
<a id="L1627" class="source_line" href="#L1627">1627</a>
<a id="L1628" class="source_line" href="#L1628">1628</a>
<a id="L1629" class="source_line" href="#L1629">1629</a>
<a id="L1630" class="source_line" href="#L1630">1630</a>
<a id="L1631" class="source_line" href="#L1631">1631</a>
<a id="L1632" class="source_line" href="#L1632">1632</a>
<a id="L1633" class="source_line" href="#L1633">1633</a>
<a id="L1634" class="source_line" href="#L1634">1634</a>
<a id="L1635" class="source_line" href="#L1635">1635</a>
<a id="L1636" class="source_line" href="#L1636">1636</a>
<a id="L1637" class="source_line" href="#L1637">1637</a>
<a id="L1638" class="source_line" href="#L1638">1638</a>
<a id="L1639" class="source_line" href="#L1639">1639</a>
<a id="L1640" class="source_line" href="#L1640">1640</a>
<a id="L1641" class="source_line" href="#L1641">1641</a>
<a id="L1642" class="source_line" href="#L1642">1642</a>
<a id="L1643" class="source_line" href="#L1643">1643</a>
<a id="L1644" class="source_line" href="#L1644">1644</a>
<a id="L1645" class="source_line" href="#L1645">1645</a>
<a id="L1646" class="source_line" href="#L1646">1646</a>
<a id="L1647" class="source_line" href="#L1647">1647</a>
<a id="L1648" class="source_line" href="#L1648">1648</a>
<a id="L1649" class="source_line" href="#L1649">1649</a>
<a id="L1650" class="source_line" href="#L1650">1650</a>
<a id="L1651" class="source_line" href="#L1651">1651</a>
<a id="L1652" class="source_line" href="#L1652">1652</a>
<a id="L1653" class="source_line" href="#L1653">1653</a>
<a id="L1654" class="source_line" href="#L1654">1654</a>
<a id="L1655" class="source_line" href="#L1655">1655</a>
<a id="L1656" class="source_line" href="#L1656">1656</a>
<a id="L1657" class="source_line" href="#L1657">1657</a>
<a id="L1658" class="source_line" href="#L1658">1658</a>
<a id="L1659" class="source_line" href="#L1659">1659</a>
<a id="L1660" class="source_line" href="#L1660">1660</a>
<a id="L1661" class="source_line" href="#L1661">1661</a>
<a id="L1662" class="source_line" href="#L1662">1662</a>
<a id="L1663" class="source_line" href="#L1663">1663</a>
<a id="L1664" class="source_line" href="#L1664">1664</a>
<a id="L1665" class="source_line" href="#L1665">1665</a>
<a id="L1666" class="source_line" href="#L1666">1666</a>
<a id="L1667" class="source_line" href="#L1667">1667</a>
<a id="L1668" class="source_line" href="#L1668">1668</a>
<a id="L1669" class="source_line" href="#L1669">1669</a>
<a id="L1670" class="source_line" href="#L1670">1670</a>
<a id="L1671" class="source_line" href="#L1671">1671</a>
<a id="L1672" class="source_line" href="#L1672">1672</a>
<a id="L1673" class="source_line" href="#L1673">1673</a>
<a id="L1674" class="source_line" href="#L1674">1674</a>
<a id="L1675" class="source_line" href="#L1675">1675</a>
<a id="L1676" class="source_line" href="#L1676">1676</a>
<a id="L1677" class="source_line" href="#L1677">1677</a>
<a id="L1678" class="source_line" href="#L1678">1678</a>
<a id="L1679" class="source_line" href="#L1679">1679</a>
<a id="L1680" class="source_line" href="#L1680">1680</a>
<a id="L1681" class="source_line" href="#L1681">1681</a>
<a id="L1682" class="source_line" href="#L1682">1682</a>
<a id="L1683" class="source_line" href="#L1683">1683</a>
<a id="L1684" class="source_line" href="#L1684">1684</a>
<a id="L1685" class="source_line" href="#L1685">1685</a>
<a id="L1686" class="source_line" href="#L1686">1686</a>
<a id="L1687" class="source_line" href="#L1687">1687</a>
<a id="L1688" class="source_line" href="#L1688">1688</a>
<a id="L1689" class="source_line" href="#L1689">1689</a>
<a id="L1690" class="source_line" href="#L1690">1690</a>
<a id="L1691" class="source_line" href="#L1691">1691</a>
<a id="L1692" class="source_line" href="#L1692">1692</a>
<a id="L1693" class="source_line" href="#L1693">1693</a>
<a id="L1694" class="source_line" href="#L1694">1694</a>
<a id="L1695" class="source_line" href="#L1695">1695</a>
<a id="L1696" class="source_line" href="#L1696">1696</a>
<a id="L1697" class="source_line" href="#L1697">1697</a>
<a id="L1698" class="source_line" href="#L1698">1698</a>
<a id="L1699" class="source_line" href="#L1699">1699</a>
<a id="L1700" class="source_line" href="#L1700">1700</a>
<a id="L1701" class="source_line" href="#L1701">1701</a>
<a id="L1702" class="source_line" href="#L1702">1702</a>
<a id="L1703" class="source_line" href="#L1703">1703</a>
<a id="L1704" class="source_line" href="#L1704">1704</a>
<a id="L1705" class="source_line" href="#L1705">1705</a>
<a id="L1706" class="source_line" href="#L1706">1706</a>
<a id="L1707" class="source_line" href="#L1707">1707</a>
<a id="L1708" class="source_line" href="#L1708">1708</a>
<a id="L1709" class="source_line" href="#L1709">1709</a>
<a id="L1710" class="source_line" href="#L1710">1710</a>
<a id="L1711" class="source_line" href="#L1711">1711</a>
<a id="L1712" class="source_line" href="#L1712">1712</a>
<a id="L1713" class="source_line" href="#L1713">1713</a>
<a id="L1714" class="source_line" href="#L1714">1714</a>
<a id="L1715" class="source_line" href="#L1715">1715</a>
<a id="L1716" class="source_line" href="#L1716">1716</a>
<a id="L1717" class="source_line" href="#L1717">1717</a>
<a id="L1718" class="source_line" href="#L1718">1718</a>
<a id="L1719" class="source_line" href="#L1719">1719</a>
<a id="L1720" class="source_line" href="#L1720">1720</a>
<a id="L1721" class="source_line" href="#L1721">1721</a>
<a id="L1722" class="source_line" href="#L1722">1722</a>
<a id="L1723" class="source_line" href="#L1723">1723</a>
<a id="L1724" class="source_line" href="#L1724">1724</a>
<a id="L1725" class="source_line" href="#L1725">1725</a>
<a id="L1726" class="source_line" href="#L1726">1726</a>
<a id="L1727" class="source_line" href="#L1727">1727</a>
<a id="L1728" class="source_line" href="#L1728">1728</a>
<a id="L1729" class="source_line" href="#L1729">1729</a>
<a id="L1730" class="source_line" href="#L1730">1730</a>
<a id="L1731" class="source_line" href="#L1731">1731</a>
<a id="L1732" class="source_line" href="#L1732">1732</a>
<a id="L1733" class="source_line" href="#L1733">1733</a>
<a id="L1734" class="source_line" href="#L1734">1734</a>
<a id="L1735" class="source_line" href="#L1735">1735</a>
<a id="L1736" class="source_line" href="#L1736">1736</a>
<a id="L1737" class="source_line" href="#L1737">1737</a>
<a id="L1738" class="source_line" href="#L1738">1738</a>
<a id="L1739" class="source_line" href="#L1739">1739</a>
<a id="L1740" class="source_line" href="#L1740">1740</a>
<a id="L1741" class="source_line" href="#L1741">1741</a>
<a id="L1742" class="source_line" href="#L1742">1742</a>
<a id="L1743" class="source_line" href="#L1743">1743</a>
<a id="L1744" class="source_line" href="#L1744">1744</a>
<a id="L1745" class="source_line" href="#L1745">1745</a>
<a id="L1746" class="source_line" href="#L1746">1746</a>
<a id="L1747" class="source_line" href="#L1747">1747</a>
<a id="L1748" class="source_line" href="#L1748">1748</a>
<a id="L1749" class="source_line" href="#L1749">1749</a>
<a id="L1750" class="source_line" href="#L1750">1750</a>
<a id="L1751" class="source_line" href="#L1751">1751</a>
<a id="L1752" class="source_line" href="#L1752">1752</a>
<a id="L1753" class="source_line" href="#L1753">1753</a>
<a id="L1754" class="source_line" href="#L1754">1754</a>
<a id="L1755" class="source_line" href="#L1755">1755</a>
<a id="L1756" class="source_line" href="#L1756">1756</a>
<a id="L1757" class="source_line" href="#L1757">1757</a>
<a id="L1758" class="source_line" href="#L1758">1758</a>
<a id="L1759" class="source_line" href="#L1759">1759</a>
<a id="L1760" class="source_line" href="#L1760">1760</a>
<a id="L1761" class="source_line" href="#L1761">1761</a>
<a id="L1762" class="source_line" href="#L1762">1762</a>
<a id="L1763" class="source_line" href="#L1763">1763</a>
<a id="L1764" class="source_line" href="#L1764">1764</a>
<a id="L1765" class="source_line" href="#L1765">1765</a>
<a id="L1766" class="source_line" href="#L1766">1766</a>
<a id="L1767" class="source_line" href="#L1767">1767</a>
<a id="L1768" class="source_line" href="#L1768">1768</a>
<a id="L1769" class="source_line" href="#L1769">1769</a>
<a id="L1770" class="source_line" href="#L1770">1770</a>
<a id="L1771" class="source_line" href="#L1771">1771</a>
<a id="L1772" class="source_line" href="#L1772">1772</a>
<a id="L1773" class="source_line" href="#L1773">1773</a>
<a id="L1774" class="source_line" href="#L1774">1774</a>
<a id="L1775" class="source_line" href="#L1775">1775</a>
<a id="L1776" class="source_line" href="#L1776">1776</a>
<a id="L1777" class="source_line" href="#L1777">1777</a>
<a id="L1778" class="source_line" href="#L1778">1778</a>
<a id="L1779" class="source_line" href="#L1779">1779</a>
<a id="L1780" class="source_line" href="#L1780">1780</a>
<a id="L1781" class="source_line" href="#L1781">1781</a>
<a id="L1782" class="source_line" href="#L1782">1782</a>
<a id="L1783" class="source_line" href="#L1783">1783</a>
<a id="L1784" class="source_line" href="#L1784">1784</a>
<a id="L1785" class="source_line" href="#L1785">1785</a>
<a id="L1786" class="source_line" href="#L1786">1786</a>
<a id="L1787" class="source_line" href="#L1787">1787</a>
<a id="L1788" class="source_line" href="#L1788">1788</a>
<a id="L1789" class="source_line" href="#L1789">1789</a>
<a id="L1790" class="source_line" href="#L1790">1790</a>
<a id="L1791" class="source_line" href="#L1791">1791</a>
<a id="L1792" class="source_line" href="#L1792">1792</a>
<a id="L1793" class="source_line" href="#L1793">1793</a>
<a id="L1794" class="source_line" href="#L1794">1794</a>
<a id="L1795" class="source_line" href="#L1795">1795</a>
<a id="L1796" class="source_line" href="#L1796">1796</a>
<a id="L1797" class="source_line" href="#L1797">1797</a>
<a id="L1798" class="source_line" href="#L1798">1798</a>
<a id="L1799" class="source_line" href="#L1799">1799</a>
<a id="L1800" class="source_line" href="#L1800">1800</a>
<a id="L1801" class="source_line" href="#L1801">1801</a>
<a id="L1802" class="source_line" href="#L1802">1802</a>
<a id="L1803" class="source_line" href="#L1803">1803</a>
<a id="L1804" class="source_line" href="#L1804">1804</a>
<a id="L1805" class="source_line" href="#L1805">1805</a>
<a id="L1806" class="source_line" href="#L1806">1806</a>
<a id="L1807" class="source_line" href="#L1807">1807</a>
<a id="L1808" class="source_line" href="#L1808">1808</a>
<a id="L1809" class="source_line" href="#L1809">1809</a>
<a id="L1810" class="source_line" href="#L1810">1810</a>
<a id="L1811" class="source_line" href="#L1811">1811</a>
<a id="L1812" class="source_line" href="#L1812">1812</a>
<a id="L1813" class="source_line" href="#L1813">1813</a>
<a id="L1814" class="source_line" href="#L1814">1814</a>
<a id="L1815" class="source_line" href="#L1815">1815</a>
<a id="L1816" class="source_line" href="#L1816">1816</a>
<a id="L1817" class="source_line" href="#L1817">1817</a>
<a id="L1818" class="source_line" href="#L1818">1818</a>
<a id="L1819" class="source_line" href="#L1819">1819</a>
<a id="L1820" class="source_line" href="#L1820">1820</a>
<a id="L1821" class="source_line" href="#L1821">1821</a>
<a id="L1822" class="source_line" href="#L1822">1822</a>
<a id="L1823" class="source_line" href="#L1823">1823</a>
<a id="L1824" class="source_line" href="#L1824">1824</a>
<a id="L1825" class="source_line" href="#L1825">1825</a>
<a id="L1826" class="source_line" href="#L1826">1826</a>
<a id="L1827" class="source_line" href="#L1827">1827</a>
<a id="L1828" class="source_line" href="#L1828">1828</a>
<a id="L1829" class="source_line" href="#L1829">1829</a>
<a id="L1830" class="source_line" href="#L1830">1830</a>
<a id="L1831" class="source_line" href="#L1831">1831</a>
<a id="L1832" class="source_line" href="#L1832">1832</a>
<a id="L1833" class="source_line" href="#L1833">1833</a>
<a id="L1834" class="source_line" href="#L1834">1834</a>
<a id="L1835" class="source_line" href="#L1835">1835</a>
<a id="L1836" class="source_line" href="#L1836">1836</a>
<a id="L1837" class="source_line" href="#L1837">1837</a>
<a id="L1838" class="source_line" href="#L1838">1838</a>
<a id="L1839" class="source_line" href="#L1839">1839</a>
<a id="L1840" class="source_line" href="#L1840">1840</a>
<a id="L1841" class="source_line" href="#L1841">1841</a>
<a id="L1842" class="source_line" href="#L1842">1842</a>
<a id="L1843" class="source_line" href="#L1843">1843</a>
<a id="L1844" class="source_line" href="#L1844">1844</a>
<a id="L1845" class="source_line" href="#L1845">1845</a>
<a id="L1846" class="source_line" href="#L1846">1846</a>
<a id="L1847" class="source_line" href="#L1847">1847</a>
<a id="L1848" class="source_line" href="#L1848">1848</a>
<a id="L1849" class="source_line" href="#L1849">1849</a>
<a id="L1850" class="source_line" href="#L1850">1850</a>
<a id="L1851" class="source_line" href="#L1851">1851</a>
<a id="L1852" class="source_line" href="#L1852">1852</a>
<a id="L1853" class="source_line" href="#L1853">1853</a>
<a id="L1854" class="source_line" href="#L1854">1854</a>
<a id="L1855" class="source_line" href="#L1855">1855</a>
<a id="L1856" class="source_line" href="#L1856">1856</a>
<a id="L1857" class="source_line" href="#L1857">1857</a>
<a id="L1858" class="source_line" href="#L1858">1858</a>
<a id="L1859" class="source_line" href="#L1859">1859</a>
<a id="L1860" class="source_line" href="#L1860">1860</a>
<a id="L1861" class="source_line" href="#L1861">1861</a>
<a id="L1862" class="source_line" href="#L1862">1862</a>
<a id="L1863" class="source_line" href="#L1863">1863</a>
<a id="L1864" class="source_line" href="#L1864">1864</a>
<a id="L1865" class="source_line" href="#L1865">1865</a>
<a id="L1866" class="source_line" href="#L1866">1866</a>
<a id="L1867" class="source_line" href="#L1867">1867</a>
<a id="L1868" class="source_line" href="#L1868">1868</a>
<a id="L1869" class="source_line" href="#L1869">1869</a>
<a id="L1870" class="source_line" href="#L1870">1870</a>
</code><code class="source_code"><span><span class="COMMENT">(* This file is part of Lwt, released under the MIT license. See LICENSE.md for
   details, or visit https://github.com/ocsigen/lwt/blob/master/LICENSE.md. *)</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* [Lwt_sequence] is deprecated â€“ we don't want users outside Lwt using it.
   However, it is still used internally by Lwt. So, briefly disable warning 3
   (&quot;deprecated&quot;), and create a local, non-deprecated alias for
   [Lwt_sequence] that can be referred to by the rest of the code in this
   module without triggering any more warnings. *)</span><span class="EOL">
</span><span class="LBRACKETATATAT">[@@@</span><span class="LIDENT">ocaml</span><span class="DOT">.</span><span class="LIDENT">warning</span> <span class="STRING">&quot;-3&quot;</span><span class="RBRACKET">]</span><span class="EOL">
</span><span id="module-Lwt_sequence"><span class="MODULE">module</span> <span class="UIDENT">Lwt_sequence</span> <span class="EQUAL">=</span> <a href="../lwt/lwt_sequence.ml.html"><span class="UIDENT">Lwt_sequence</span></a></span><span class="EOL">
</span><span class="LBRACKETATATAT">[@@@</span><span class="LIDENT">ocaml</span><span class="DOT">.</span><span class="LIDENT">warning</span> <span class="STRING">&quot;+3&quot;</span><span class="RBRACKET">]</span><span class="EOL">
</span><span class="EOL">
</span><span class="OPEN">open</span> <a href="../lwt/lwt.ml.html#module-Infix"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="UIDENT">Infix</span></a><span class="EOL">
</span><span class="EOL">
</span><span id="exception-Channel_closed"><span class="EXCEPTION">exception</span> <span class="UIDENT">Channel_closed</span> <span class="OF">of</span> <span class="LIDENT">string</span></span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* Minimum size for buffers: *)</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-min_buffer_size"><span class="LIDENT">min_buffer_size</span></span> <span class="EQUAL">=</span> <span class="INT">16</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-check_buffer_size"><span class="LIDENT">check_buffer_size</span></span> <span id="local_fun_name_1"><span class="LIDENT">fun_name</span></span> <span id="local_buffer_size_2"><span class="LIDENT">buffer_size</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="#local_buffer_size_2"><span class="LIDENT">buffer_size</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;)"><span class="LESS">&lt;</span></a> <span class="LIDENT">min_buffer_size</span> <span class="THEN">then</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/printf.ml.html#val-ksprintf"><span class="UIDENT">Printf</span><span class="DOT">.</span><span class="LIDENT">ksprintf</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-invalid_arg"><span class="LIDENT">invalid_arg</span></a> <span class="STRING">&quot;Lwt_io.%s: too small buffer size&quot;</span> <a href="#local_fun_name_1"><span class="LIDENT">fun_name</span></a><span class="EOL">
</span>  <span class="ELSE">else</span> <span class="IF">if</span> <a href="#local_buffer_size_2"><span class="LIDENT">buffer_size</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-max_string_length"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">max_string_length</span></a> <span class="THEN">then</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/printf.ml.html#val-ksprintf"><span class="UIDENT">Printf</span><span class="DOT">.</span><span class="LIDENT">ksprintf</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-invalid_arg"><span class="LIDENT">invalid_arg</span></a> <span class="STRING">&quot;Lwt_io.%s: too big buffer size&quot;</span> <a href="#local_fun_name_1"><span class="LIDENT">fun_name</span></a><span class="EOL">
</span>  <span class="ELSE">else</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-check_buffer"><span class="LIDENT">check_buffer</span></span> <span id="local_fun_name_3"><span class="LIDENT">fun_name</span></span> <span id="local_buffer_4"><span class="LIDENT">buffer</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">check_buffer_size</span> <a href="#local_fun_name_3"><span class="LIDENT">fun_name</span></a> <span class="LPAREN">(</span><a href="lwt_bytes.ml.html#val-length"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">length</span></a> <a href="#local_buffer_4"><span class="LIDENT">buffer</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-{default_buffer_size}1/shadowed/(lwt-src-lwt.unix-lwt_io.ml)"><span class="LIDENT">default_buffer_size</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ref"><span class="LIDENT">ref</span></a> <span class="INT">4096</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* +-----------------------------------------------------------------+
   | Types                                                           |
   +-----------------------------------------------------------------+ *)</span><span class="EOL">
</span><span class="EOL">
</span><span id="type-input"><span class="TYPE">type</span> <span class="LIDENT">input</span></span><span class="EOL">
</span><span id="type-output"><span class="TYPE">type</span> <span class="LIDENT">output</span></span><span class="EOL">
</span><span class="EOL">
</span><span id="type-mode"><span class="TYPE">type</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">mode</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span id="type-mode.constructor-Input"><span class="BAR">|</span> <span class="UIDENT">Input</span> <span class="COLON">:</span> <span class="LIDENT">input</span> <span class="LIDENT">mode</span></span><span class="EOL">
</span>  <span id="type-mode.constructor-Output"><span class="BAR">|</span> <span class="UIDENT">Output</span> <span class="COLON">:</span> <span class="LIDENT">output</span> <span class="LIDENT">mode</span></span></span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-input"><span class="LIDENT">input</span></span> <span class="COLON">:</span> <span class="LIDENT">input</span> <span class="LIDENT">mode</span> <span class="EQUAL">=</span> <span class="UIDENT">Input</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-output"><span class="LIDENT">output</span></span> <span class="COLON">:</span> <span class="LIDENT">output</span> <span class="LIDENT">mode</span> <span class="EQUAL">=</span> <span class="UIDENT">Output</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* A channel state *)</span><span class="EOL">
</span><span id="type-state"><span class="TYPE">type</span> <span class="QUOTE">'</span><span class="LIDENT">mode</span> <span class="LIDENT">state</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span id="type-state.constructor-Busy_primitive"><span class="BAR">|</span> <span class="UIDENT">Busy_primitive</span></span><span class="EOL">
</span>  <span class="COMMENT">(* A primitive is running on the channel *)</span><span class="EOL">
</span><span class="EOL">
</span>  <span id="type-state.constructor-Busy_atomic"><span class="BAR">|</span> <span class="UIDENT">Busy_atomic</span> <span class="OF">of</span> <span class="QUOTE">'</span><span class="LIDENT">mode</span> <span class="LIDENT">channel</span></span><span class="EOL">
</span>  <span class="COMMENT">(* An atomic operations is being performed on the channel. The
     argument is the temporary atomic wrapper. *)</span><span class="EOL">
</span><span class="EOL">
</span>  <span id="type-state.constructor-Waiting_for_busy"><span class="BAR">|</span> <span class="UIDENT">Waiting_for_busy</span></span><span class="EOL">
</span>  <span class="COMMENT">(* A queued operation has not yet started. *)</span><span class="EOL">
</span><span class="EOL">
</span>  <span id="type-state.constructor-Idle"><span class="BAR">|</span> <span class="UIDENT">Idle</span></span><span class="EOL">
</span>  <span class="COMMENT">(* The channel is unused *)</span><span class="EOL">
</span><span class="EOL">
</span>  <span id="type-state.constructor-Closed"><span class="BAR">|</span> <span class="UIDENT">Closed</span></span><span class="EOL">
</span>  <span class="COMMENT">(* The channel has been closed *)</span><span class="EOL">
</span><span class="EOL">
</span>  <span id="type-state.constructor-Invalid"><span class="BAR">|</span> <span class="UIDENT">Invalid</span></span></span><span class="EOL">
</span>  <span class="COMMENT">(* The channel is a temporary channel created for an atomic
     operation which has terminated. *)</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* A wrapper, which ensures that io operations are atomic: *)</span><span class="EOL">
</span><span id="type-channel"><span class="AND">and</span> <span class="QUOTE">'</span><span class="LIDENT">mode</span> <span class="LIDENT">channel</span> <span class="EQUAL">=</span> <span class="LBRACE">{</span><span class="EOL">
</span>  <span id="def_682"><span class="MUTABLE">mutable</span> <span class="LIDENT">state</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">mode</span> <span class="LIDENT">state</span><span class="SEMI">;</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span id="def_688"><span class="LIDENT">channel</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">mode</span> <span class="LIDENT">_channel</span><span class="SEMI">;</span></span><span class="EOL">
</span>  <span class="COMMENT">(* The real channel *)</span><span class="EOL">
</span><span class="EOL">
</span>  <span id="def_685"><span class="MUTABLE">mutable</span> <span class="LIDENT">queued</span> <span class="COLON">:</span> <a href="../lwt/lwt.ml.html#module-Public_types.type-u"><span class="LIDENT">unit</span> <span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">u</span></a> <span class="UIDENT">Lwt_sequence</span><span class="DOT">.</span><span class="LIDENT">t</span><span class="SEMI">;</span></span><span class="EOL">
</span>  <span class="COMMENT">(* Queued operations *)</span><span class="EOL">
</span><span class="RBRACE">}</span></span><span class="EOL">
</span><span class="EOL">
</span><span id="type-_channel"><span class="AND">and</span> <span class="QUOTE">'</span><span class="LIDENT">mode</span> <span class="LIDENT">_channel</span> <span class="EQUAL">=</span> <span class="LBRACE">{</span><span class="EOL">
</span>  <span id="def_683"><span class="MUTABLE">mutable</span> <span class="LIDENT">buffer</span> <span class="COLON">:</span> <a href="lwt_bytes.ml.html#type-t"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">t</span></a><span class="SEMI">;</span></span><span class="EOL">
</span>  <span id="def_674"><span class="MUTABLE">mutable</span> <span class="LIDENT">length</span> <span class="COLON">:</span> <span class="LIDENT">int</span><span class="SEMI">;</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span id="def_677"><span class="MUTABLE">mutable</span> <span class="LIDENT">ptr</span> <span class="COLON">:</span> <span class="LIDENT">int</span><span class="SEMI">;</span></span><span class="EOL">
</span>  <span class="COMMENT">(* Current position *)</span><span class="EOL">
</span><span class="EOL">
</span>  <span id="def_676"><span class="MUTABLE">mutable</span> <span class="LIDENT">max</span> <span class="COLON">:</span> <span class="LIDENT">int</span><span class="SEMI">;</span></span><span class="EOL">
</span>  <span class="COMMENT">(* Position of the end of data int the buffer. It is equal to
     [length] for output channels. *)</span><span class="EOL">
</span><span class="EOL">
</span>  <span id="def_680"><span class="LIDENT">abort_waiter</span> <span class="COLON">:</span> <a href="../lwt/lwt.ml.html#module-Public_types.type-t"><span class="LIDENT">int</span> <span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">t</span></a><span class="SEMI">;</span></span><span class="EOL">
</span>  <span class="COMMENT">(* Thread which is wakeup with an exception when the channel is
     closed. *)</span><span class="EOL">
</span>  <span id="def_689"><span class="LIDENT">abort_wakener</span> <span class="COLON">:</span> <a href="../lwt/lwt.ml.html#module-Public_types.type-u"><span class="LIDENT">int</span> <span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">u</span></a><span class="SEMI">;</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span id="def_704"><span class="MUTABLE">mutable</span> <span class="LIDENT">auto_flushing</span> <span class="COLON">:</span> <span class="LIDENT">bool</span><span class="SEMI">;</span></span><span class="EOL">
</span>  <span class="COMMENT">(* Whether the auto-flusher is currently running or not *)</span><span class="EOL">
</span><span class="EOL">
</span>  <span id="def_701"><span class="LIDENT">main</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">mode</span> <span class="LIDENT">channel</span><span class="SEMI">;</span></span><span class="EOL">
</span>  <span class="COMMENT">(* The main wrapper *)</span><span class="EOL">
</span><span class="EOL">
</span>  <span id="def_693"><span class="LIDENT">close</span> <span class="COLON">:</span> <a href="../../../ocaml-base-compiler/src/stdlib/lazy.ml.html#type-t"><a href="../lwt/lwt.ml.html#module-Public_types.type-t"><span class="LIDENT">unit</span> <span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">t</span></a> <span class="UIDENT">Lazy</span><span class="DOT">.</span><span class="LIDENT">t</span></a><span class="SEMI">;</span></span><span class="EOL">
</span>  <span class="COMMENT">(* Close function *)</span><span class="EOL">
</span><span class="EOL">
</span>  <span id="def_703"><span class="LIDENT">mode</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">mode</span> <span class="LIDENT">mode</span><span class="SEMI">;</span></span><span class="EOL">
</span>  <span class="COMMENT">(* The channel mode *)</span><span class="EOL">
</span><span class="EOL">
</span>  <span id="def_698"><span class="MUTABLE">mutable</span> <span class="LIDENT">offset</span> <span class="COLON">:</span> <span class="LIDENT">int64</span><span class="SEMI">;</span></span><span class="EOL">
</span>  <span class="COMMENT">(* Number of bytes really read/written *)</span><span class="EOL">
</span><span class="EOL">
</span>  <span id="def_690"><span class="LIDENT">typ</span> <span class="COLON">:</span> <span class="LIDENT">typ</span><span class="SEMI">;</span></span><span class="EOL">
</span>  <span class="COMMENT">(* Type of the channel. *)</span><span class="EOL">
</span><span class="RBRACE">}</span></span><span class="EOL">
</span><span class="EOL">
</span><span id="type-typ"><span class="AND">and</span> <span class="LIDENT">typ</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span id="type-typ.constructor-Type_normal"><span class="BAR">|</span> <span class="UIDENT">Type_normal</span> <span class="OF">of</span><span class="EOL">
</span>    <span class="LPAREN">(</span><a href="lwt_bytes.ml.html#type-t"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">t</span></a> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">int</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">int</span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Public_types.type-t"><span class="LIDENT">int</span> <span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">t</span></a><span class="RPAREN">)</span> <span class="STAR">*</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="LIDENT">int64</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">seek_command</span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Public_types.type-t"><span class="LIDENT">int64</span> <span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">t</span></a><span class="RPAREN">)</span></span><span class="EOL">
</span>  <span class="COMMENT">(* The channel has been created with [make]. The first argument
     is the refill/flush function and the second is the seek
     function. *)</span><span class="EOL">
</span>  <span id="type-typ.constructor-Type_bytes"><span class="BAR">|</span> <span class="UIDENT">Type_bytes</span></span></span><span class="EOL">
</span>  <span class="COMMENT">(* The channel has been created with [of_bytes]. *)</span><span class="EOL">
</span><span class="EOL">
</span><span id="type-input_channel"><span class="TYPE">type</span> <span class="LIDENT">input_channel</span> <span class="EQUAL">=</span> <span class="LIDENT">input</span> <span class="LIDENT">channel</span></span><span class="EOL">
</span><span id="type-output_channel"><span class="TYPE">type</span> <span class="LIDENT">output_channel</span> <span class="EQUAL">=</span> <span class="LIDENT">output</span> <span class="LIDENT">channel</span></span><span class="EOL">
</span><span class="EOL">
</span><span id="type-direct_access"><span class="TYPE">type</span> <span class="LIDENT">direct_access</span> <span class="EQUAL">=</span> <span class="LBRACE">{</span><span class="EOL">
</span>  <span id="def_702"><span class="LIDENT">da_buffer</span> <span class="COLON">:</span> <a href="lwt_bytes.ml.html#type-t"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">t</span></a><span class="SEMI">;</span></span><span class="EOL">
</span>  <span id="def_700"><span class="MUTABLE">mutable</span> <span class="LIDENT">da_ptr</span> <span class="COLON">:</span> <span class="LIDENT">int</span><span class="SEMI">;</span></span><span class="EOL">
</span>  <span id="def_681"><span class="MUTABLE">mutable</span> <span class="LIDENT">da_max</span> <span class="COLON">:</span> <span class="LIDENT">int</span><span class="SEMI">;</span></span><span class="EOL">
</span>  <span id="def_686"><span class="LIDENT">da_perform</span> <span class="COLON">:</span> <span class="LIDENT">unit</span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Public_types.type-t"><span class="LIDENT">int</span> <span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">t</span></a><span class="SEMI">;</span></span><span class="EOL">
</span><span class="RBRACE">}</span></span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-mode"><span class="LIDENT">mode</span></span> <span id="local_wrapper_5"><span class="LIDENT">wrapper</span></span> <span class="EQUAL">=</span> <a href="#local_wrapper_5"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">channel</span><span class="DOT">.</span><span class="LIDENT">mode</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* +-----------------------------------------------------------------+
   | Creations, closing, locking, ...                                |
   +-----------------------------------------------------------------+ *)</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* This strange hash function is fine because Lwt_io only ever:
    - adds distinct channels to the hash set,
    - folds over the hash set.
   Lwt_io never looks up individual elements. The constant function is not
   suitable, because then all channels will end up in the same hash bucket.

   A weak hash set is used instead of a weak array to avoid having to include
   resizing and compaction code in Lwt_io. *)</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-hash_output_channel"><span class="LIDENT">hash_output_channel</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_index_6"><span class="LIDENT">index</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ref"><span class="LIDENT">ref</span></a> <span class="INT">0</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="#local_index_6"><span class="LIDENT">index</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="#local_index_6"><span class="LIDENT">index</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <span class="INT">1</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="#local_index_6"><span class="LIDENT">index</span></a><span class="EOL">
</span><span class="EOL">
</span><span id="module-Outputs"><span class="MODULE">module</span> <span class="UIDENT">Outputs</span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/weak.ml.html#module-Make"><span class="UIDENT">Weak</span><span class="DOT">.</span><span class="UIDENT">Make</span></a><span class="LPAREN">(</span><span class="STRUCT">struct</span><span class="EOL">
</span>    <span id="def_675"><span class="TYPE">type</span> <span class="LIDENT">t</span> <span class="EQUAL">=</span> <span class="LIDENT">output_channel</span></span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_hash_7"><span class="LIDENT">hash</span></span> <span class="UNDERSCORE">_</span> <span class="EQUAL">=</span> <span class="LIDENT">hash_output_channel</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_equal_8"><span class="LIDENT">equal</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(==)"><span class="LPAREN">(</span> <span class="INFIXOP0">==</span> <span class="RPAREN">)</span></a><span class="EOL">
</span>  <span class="END">end</span><span class="RPAREN">)</span></span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* Table of all opened output channels. On exit they are all
   flushed: *)</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-outputs"><span class="LIDENT">outputs</span></span> <span class="EQUAL">=</span> <span class="UIDENT">Outputs</span><span class="DOT">.</span><span class="LIDENT">create</span> <span class="INT">32</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-position"><span class="LIDENT">position</span></span> <span class="COLON">:</span> <span class="TYPE">type</span> <span class="LIDENT">mode</span><span class="DOT">.</span> <span class="LIDENT">mode</span> <span class="LIDENT">channel</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">int64</span> <span class="EQUAL">=</span> <span class="FUN">fun</span> <span id="local_wrapper_9"><span class="LIDENT">wrapper</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_ch_10"><span class="LIDENT">ch</span></span> <span class="EQUAL">=</span> <a href="#local_wrapper_9"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">channel</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="MATCH">match</span> <a href="#local_ch_10"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">mode</span> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Input</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/int64.ml.html#val-sub"><span class="UIDENT">Int64</span><span class="DOT">.</span><span class="LIDENT">sub</span></a> <a href="#local_ch_10"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">offset</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/int64.ml.html#val-of_int"><span class="UIDENT">Int64</span><span class="DOT">.</span><span class="LIDENT">of_int</span></a> <span class="LPAREN">(</span><a href="#local_ch_10"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">max</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <a href="#local_ch_10"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Output</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/int64.ml.html#val-add"><span class="UIDENT">Int64</span><span class="DOT">.</span><span class="LIDENT">add</span></a> <a href="#local_ch_10"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">offset</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/int64.ml.html#val-of_int"><span class="UIDENT">Int64</span><span class="DOT">.</span><span class="LIDENT">of_int</span></a> <a href="#local_ch_10"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-name"><span class="LIDENT">name</span></span> <span class="COLON">:</span> <span class="TYPE">type</span> <span class="LIDENT">mode</span><span class="DOT">.</span> <span class="LIDENT">mode</span> <span class="LIDENT">_channel</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">string</span> <span class="EQUAL">=</span> <span class="FUN">fun</span> <span id="local_ch_11"><span class="LIDENT">ch</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>  <span class="MATCH">match</span> <a href="#local_ch_11"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">mode</span> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Input</span> <span class="MINUSGREATER">-&gt;</span> <span class="STRING">&quot;input&quot;</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Output</span> <span class="MINUSGREATER">-&gt;</span> <span class="STRING">&quot;output&quot;</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-closed_channel"><span class="LIDENT">closed_channel</span></span> <span id="local_ch_12"><span class="LIDENT">ch</span></span> <span class="EQUAL">=</span> <span class="UIDENT">Channel_closed</span> <span class="LPAREN">(</span><span class="LIDENT">name</span> <a href="#local_ch_12"><span class="LIDENT">ch</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-invalid_channel"><span class="LIDENT">invalid_channel</span></span> <span id="local_ch_13"><span class="LIDENT">ch</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="UIDENT">Failure</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/printf.ml.html#val-sprintf"><span class="UIDENT">Printf</span><span class="DOT">.</span><span class="LIDENT">sprintf</span></a> <span class="STRING">&quot;temporary atomic channel %s no more valid&quot;</span> <span class="LPAREN">(</span><span class="LIDENT">name</span> <a href="#local_ch_13"><span class="LIDENT">ch</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-is_busy"><span class="LIDENT">is_busy</span></span> <span id="local_ch_14"><span class="LIDENT">ch</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="MATCH">match</span> <a href="#local_ch_14"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Invalid</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-raise"><span class="LIDENT">raise</span></a> <span class="LPAREN">(</span><span class="LIDENT">invalid_channel</span> <a href="#local_ch_14"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">channel</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Idle</span> <span class="BAR">|</span> <span class="UIDENT">Closed</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="FALSE">false</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Busy_primitive</span> <span class="BAR">|</span> <span class="UIDENT">Busy_atomic</span> <span class="UNDERSCORE">_</span> <span class="BAR">|</span> <span class="UIDENT">Waiting_for_busy</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="TRUE">true</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* Flush/refill the buffer. No race condition could happen because
   this function is always called atomically: *)</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-perform_io"><span class="LIDENT">perform_io</span></span> <span class="COLON">:</span> <span class="TYPE">type</span> <span class="LIDENT">mode</span><span class="DOT">.</span> <span class="LIDENT">mode</span> <span class="LIDENT">_channel</span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Public_types.type-t"><span class="LIDENT">int</span> <span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">t</span></a> <span class="EQUAL">=</span> <span class="FUN">fun</span> <span id="local_ch_15"><span class="LIDENT">ch</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>  <span class="MATCH">match</span> <a href="#local_ch_15"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">main</span><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Closed</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <span class="LPAREN">(</span><span class="LIDENT">closed_channel</span> <a href="#local_ch_15"><span class="LIDENT">ch</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Invalid</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <span class="LPAREN">(</span><span class="LIDENT">invalid_channel</span> <a href="#local_ch_15"><span class="LIDENT">ch</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Idle</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Waiting_for_busy</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="ASSERT">assert</span> <span class="FALSE">false</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Busy_primitive</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Busy_atomic</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_ch_15"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">typ</span> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Type_normal</span> <span class="LPAREN">(</span><span id="local_perform_16"><span class="LIDENT">perform</span></span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="def_687"><span id="local_ptr_17"><span class="LIDENT">ptr</span></span><span class="COMMA">,</span> <span id="local_len_18"><span class="LIDENT">len</span></span></span> <span class="EQUAL">=</span><span class="EOL">
</span>        <span class="MATCH">match</span> <a href="#local_ch_15"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">mode</span> <span class="WITH">with</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Input</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="COMMENT">(* Size of data in the buffer *)</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_size_19"><span class="LIDENT">size</span></span> <span class="EQUAL">=</span> <a href="#local_ch_15"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">max</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <a href="#local_ch_15"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <span class="IN">in</span><span class="EOL">
</span>          <span class="COMMENT">(* If there are still data in the buffer, keep them: *)</span><span class="EOL">
</span>          <span class="IF">if</span> <a href="#local_size_19"><span class="LIDENT">size</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <span class="INT">0</span> <span class="THEN">then</span><span class="EOL">
</span>            <a href="lwt_bytes.ml.html#val-unsafe_blit"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">unsafe_blit</span></a> <a href="#local_ch_15"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <a href="#local_ch_15"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <a href="#local_ch_15"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <span class="INT">0</span> <a href="#local_size_19"><span class="LIDENT">size</span></a><span class="SEMI">;</span><span class="EOL">
</span>          <span class="COMMENT">(* Update positions: *)</span><span class="EOL">
</span>          <a href="#local_ch_15"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <span class="LESSMINUS">&lt;-</span> <span class="INT">0</span><span class="SEMI">;</span><span class="EOL">
</span>          <a href="#local_ch_15"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">max</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_size_19"><span class="LIDENT">size</span></a><span class="SEMI">;</span><span class="EOL">
</span>          <span class="LPAREN">(</span><a href="#local_size_19"><span class="LIDENT">size</span></a><span class="COMMA">,</span> <a href="#local_ch_15"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">length</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <a href="#local_size_19"><span class="LIDENT">size</span></a><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Output</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LPAREN">(</span><span class="INT">0</span><span class="COMMA">,</span> <a href="#local_ch_15"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="IN">in</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_perform_20"><span class="LIDENT">perform</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>        <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-win32"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">win32</span></a> <span class="THEN">then</span><span class="EOL">
</span>          <a href="../lwt/lwt.ml.html#module-Sequential_composition.val-catch"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">catch</span></a><span class="EOL">
</span>            <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>              <a href="#local_perform_16"><span class="LIDENT">perform</span></a> <a href="#local_ch_15"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <a href="#local_ptr_17"><span class="LIDENT">ptr</span></a> <a href="#local_len_18"><span class="LIDENT">len</span></a><span class="RPAREN">)</span><span class="EOL">
</span>            <span class="LPAREN">(</span><span class="FUNCTION">function</span><span class="EOL">
</span>              <span class="BAR">|</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">Unix_error</span> <span class="LPAREN">(</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">EPIPE</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>                <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <span class="INT">0</span><span class="EOL">
</span>              <span class="BAR">|</span> <span id="local_exn_21"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <a href="#local_exn_21"><span class="LIDENT">exn</span></a><span class="RPAREN">)</span> <span class="LBRACKETAT">[@</span><span class="LIDENT">ocaml</span><span class="DOT">.</span><span class="LIDENT">warning</span> <span class="STRING">&quot;-4&quot;</span><span class="RBRACKET">]</span><span class="EOL">
</span>        <span class="ELSE">else</span><span class="EOL">
</span>          <a href="#local_perform_16"><span class="LIDENT">perform</span></a> <a href="#local_ch_15"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <a href="#local_ptr_17"><span class="LIDENT">ptr</span></a> <a href="#local_len_18"><span class="LIDENT">len</span></a><span class="EOL">
</span>      <span class="IN">in</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Concurrent_composition.val-pick"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">pick</span></a> <span class="LBRACKET">[</span><a href="#local_ch_15"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">abort_waiter</span><span class="SEMI">;</span> <a href="#local_perform_20"><span class="LIDENT">perform</span></a><span class="RBRACKET">]</span> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span id="local_n_22"><span class="LIDENT">n</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="COMMENT">(* Never trust user functions... *)</span><span class="EOL">
</span>      <span class="IF">if</span> <a href="#local_n_22"><span class="LIDENT">n</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;)"><span class="LESS">&lt;</span></a> <span class="INT">0</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <a href="#local_n_22"><span class="LIDENT">n</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <a href="#local_len_18"><span class="LIDENT">len</span></a> <span class="THEN">then</span><span class="EOL">
</span>        <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a><span class="EOL">
</span>          <span class="LPAREN">(</span><span class="UIDENT">Failure</span><span class="EOL">
</span>            <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/printf.ml.html#val-sprintf"><span class="UIDENT">Printf</span><span class="DOT">.</span><span class="LIDENT">sprintf</span></a><span class="EOL">
</span>              <span class="STRING">&quot;Lwt_io.perform_io: invalid result of the [%s] function&quot;</span><span class="EOL">
</span>              <span class="LPAREN">(</span><span class="MATCH">match</span> <a href="#local_ch_15"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">mode</span> <span class="WITH">with</span> <span class="UIDENT">Input</span> <span class="MINUSGREATER">-&gt;</span> <span class="STRING">&quot;read&quot;</span> <span class="BAR">|</span> <span class="UIDENT">Output</span> <span class="MINUSGREATER">-&gt;</span> <span class="STRING">&quot;write&quot;</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="ELSE">else</span> <span class="BEGIN">begin</span><span class="EOL">
</span>        <span class="COMMENT">(* Update the global offset: *)</span><span class="EOL">
</span>        <a href="#local_ch_15"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">offset</span> <span class="LESSMINUS">&lt;-</span> <a href="../../../ocaml-base-compiler/src/stdlib/int64.ml.html#val-add"><span class="UIDENT">Int64</span><span class="DOT">.</span><span class="LIDENT">add</span></a> <a href="#local_ch_15"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">offset</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/int64.ml.html#val-of_int"><span class="UIDENT">Int64</span><span class="DOT">.</span><span class="LIDENT">of_int</span></a> <a href="#local_n_22"><span class="LIDENT">n</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>        <span class="COMMENT">(* Update buffer positions: *)</span><span class="EOL">
</span>        <span class="BEGIN">begin</span> <span class="MATCH">match</span> <a href="#local_ch_15"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">mode</span> <span class="WITH">with</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="UIDENT">Input</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <a href="#local_ch_15"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">max</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_ch_15"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">max</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <a href="#local_n_22"><span class="LIDENT">n</span></a><span class="EOL">
</span>          <span class="BAR">|</span> <span class="UIDENT">Output</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <span class="COMMENT">(* Shift remaining data: *)</span><span class="EOL">
</span>            <span class="LET">let</span> <span id="local_len_23"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span> <a href="#local_len_18"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <a href="#local_n_22"><span class="LIDENT">n</span></a> <span class="IN">in</span><span class="EOL">
</span>            <a href="lwt_bytes.ml.html#val-unsafe_blit"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">unsafe_blit</span></a> <a href="#local_ch_15"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <a href="#local_n_22"><span class="LIDENT">n</span></a> <a href="#local_ch_15"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <span class="INT">0</span> <a href="#local_len_23"><span class="LIDENT">len</span></a><span class="SEMI">;</span><span class="EOL">
</span>            <a href="#local_ch_15"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_len_23"><span class="LIDENT">len</span></a><span class="EOL">
</span>        <span class="END">end</span><span class="SEMI">;</span><span class="EOL">
</span>        <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <a href="#local_n_22"><span class="LIDENT">n</span></a><span class="EOL">
</span>      <span class="END">end</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Type_bytes</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="BEGIN">begin</span> <span class="MATCH">match</span> <a href="#local_ch_15"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">mode</span> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Input</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <span class="INT">0</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Output</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a><span class="EOL">
</span>          <span class="LPAREN">(</span><span class="UIDENT">Failure</span> <span class="STRING">&quot;cannot flush a channel created with Lwt_io.of_string&quot;</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="END">end</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-refill"><span class="LIDENT">refill</span></span> <span class="EQUAL">=</span> <span class="LIDENT">perform_io</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-flush_partial"><span class="LIDENT">flush_partial</span></span> <span class="EQUAL">=</span> <span class="LIDENT">perform_io</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span class="REC">rec</span> <span id="val-flush_total"><span class="LIDENT">flush_total</span></span> <span id="local_oc_24"><span class="LIDENT">oc</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="#local_oc_24"><span class="LIDENT">oc</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <span class="INT">0</span> <span class="THEN">then</span><span class="EOL">
</span>    <span class="LIDENT">flush_partial</span> <a href="#local_oc_24"><span class="LIDENT">oc</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LIDENT">flush_total</span> <a href="#local_oc_24"><span class="LIDENT">oc</span></a><span class="EOL">
</span>  <span class="ELSE">else</span><span class="EOL">
</span>    <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-safe_flush_total"><span class="LIDENT">safe_flush_total</span></span> <span id="local_oc_25"><span class="LIDENT">oc</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="../lwt/lwt.ml.html#module-Sequential_composition.val-catch"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">catch</span></a><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">flush_total</span> <a href="#local_oc_25"><span class="LIDENT">oc</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="UNDERSCORE">_</span>  <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-deepest_wrapper"><span class="LIDENT">deepest_wrapper</span></span> <span id="local_ch_26"><span class="LIDENT">ch</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="REC">rec</span> <span id="local_loop_27"><span class="LIDENT">loop</span></span> <span id="local_wrapper_28"><span class="LIDENT">wrapper</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_wrapper_28"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Busy_atomic</span> <span id="local_wrapper_29"><span class="LIDENT">wrapper</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="#local_loop_27"><span class="LIDENT">loop</span></a> <a href="#local_wrapper_29"><span class="LIDENT">wrapper</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Busy_primitive</span> <span class="BAR">|</span> <span class="UIDENT">Waiting_for_busy</span> <span class="BAR">|</span> <span class="UIDENT">Idle</span> <span class="BAR">|</span> <span class="UIDENT">Closed</span> <span class="BAR">|</span> <span class="UIDENT">Invalid</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="#local_wrapper_28"><span class="LIDENT">wrapper</span></a><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <a href="#local_loop_27"><span class="LIDENT">loop</span></a> <a href="#local_ch_26"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">main</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-auto_flush"><span class="LIDENT">auto_flush</span></span> <span id="local_oc_30"><span class="LIDENT">oc</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="../lwt/lwt.ml.html#module-Miscellaneous.val-pause"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">pause</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_wrapper_31"><span class="LIDENT">wrapper</span></span> <span class="EQUAL">=</span> <span class="LIDENT">deepest_wrapper</span> <a href="#local_oc_30"><span class="LIDENT">oc</span></a> <span class="IN">in</span><span class="EOL">
</span>  <span class="MATCH">match</span> <a href="#local_wrapper_31"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Busy_primitive</span> <span class="BAR">|</span> <span class="UIDENT">Waiting_for_busy</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="COMMENT">(* The channel is used, cancel auto flushing. It will be
       restarted when the channel Lwt.returns to the [Idle] state: *)</span><span class="EOL">
</span>    <a href="#local_oc_30"><span class="LIDENT">oc</span></a><span class="DOT">.</span><span class="LIDENT">auto_flushing</span> <span class="LESSMINUS">&lt;-</span> <span class="FALSE">false</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Busy_atomic</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="COMMENT">(* Cannot happen since we took the deepest wrapper: *)</span><span class="EOL">
</span>    <span class="ASSERT">assert</span> <span class="FALSE">false</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Idle</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="#local_oc_30"><span class="LIDENT">oc</span></a><span class="DOT">.</span><span class="LIDENT">auto_flushing</span> <span class="LESSMINUS">&lt;-</span> <span class="FALSE">false</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="#local_wrapper_31"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="LESSMINUS">&lt;-</span> <span class="UIDENT">Busy_primitive</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">safe_flush_total</span> <a href="#local_oc_30"><span class="LIDENT">oc</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_wrapper_31"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="UIDENT">Busy_primitive</span> <span class="THEN">then</span><span class="EOL">
</span>      <a href="#local_wrapper_31"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="LESSMINUS">&lt;-</span> <span class="UIDENT">Idle</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-not"><span class="LIDENT">not</span></a> <span class="LPAREN">(</span><span class="UIDENT">Lwt_sequence</span><span class="DOT">.</span><span class="LIDENT">is_empty</span> <a href="#local_wrapper_31"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">queued</span><span class="RPAREN">)</span> <span class="THEN">then</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Resolving.val-wakeup_later"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">wakeup_later</span></a> <span class="LPAREN">(</span><span class="UIDENT">Lwt_sequence</span><span class="DOT">.</span><span class="LIDENT">take_l</span> <a href="#local_wrapper_31"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">queued</span><span class="RPAREN">)</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Closed</span> <span class="BAR">|</span> <span class="UIDENT">Invalid</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* A ``locked'' channel is a channel in the state [Busy_primitive] or
   [Busy_atomic] *)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-unlock"><span class="LIDENT">unlock</span></span> <span class="COLON">:</span> <span class="TYPE">type</span> <span class="LIDENT">m</span><span class="DOT">.</span> <span class="LIDENT">m</span> <span class="LIDENT">channel</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span> <span class="EQUAL">=</span> <span class="FUN">fun</span> <span id="local_wrapper_32"><span class="LIDENT">wrapper</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="MATCH">match</span> <a href="#local_wrapper_32"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Busy_primitive</span> <span class="BAR">|</span> <span class="UIDENT">Busy_atomic</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="IF">if</span> <span class="UIDENT">Lwt_sequence</span><span class="DOT">.</span><span class="LIDENT">is_empty</span> <a href="#local_wrapper_32"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">queued</span> <span class="THEN">then</span><span class="EOL">
</span>      <a href="#local_wrapper_32"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="LESSMINUS">&lt;-</span> <span class="UIDENT">Idle</span><span class="EOL">
</span>    <span class="ELSE">else</span> <span class="BEGIN">begin</span><span class="EOL">
</span>      <a href="#local_wrapper_32"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="LESSMINUS">&lt;-</span> <span class="UIDENT">Waiting_for_busy</span><span class="SEMI">;</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Resolving.val-wakeup_later"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">wakeup_later</span></a> <span class="LPAREN">(</span><span class="UIDENT">Lwt_sequence</span><span class="DOT">.</span><span class="LIDENT">take_l</span> <a href="#local_wrapper_32"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">queued</span><span class="RPAREN">)</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="END">end</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="COMMENT">(* Launches the auto-flusher: *)</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_ch_33"><span class="LIDENT">ch</span></span> <span class="EQUAL">=</span> <a href="#local_wrapper_32"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">channel</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="IF">if</span> <span class="COMMENT">(* Launch the auto-flusher only if the channel is not busy: *)</span><span class="EOL">
</span>      <span class="LPAREN">(</span><a href="#local_wrapper_32"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="UIDENT">Idle</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&amp;&amp;)"><span class="AMPERAMPER">&amp;&amp;</span></a><span class="EOL">
</span>       <span class="COMMENT">(* Launch the auto-flusher only for output channel: *)</span><span class="EOL">
</span>       <span class="LPAREN">(</span><span class="MATCH">match</span> <a href="#local_ch_33"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">mode</span> <span class="WITH">with</span> <span class="UIDENT">Input</span> <span class="MINUSGREATER">-&gt;</span> <span class="FALSE">false</span> <span class="BAR">|</span> <span class="UIDENT">Output</span> <span class="MINUSGREATER">-&gt;</span> <span class="TRUE">true</span><span class="RPAREN">)</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&amp;&amp;)"><span class="AMPERAMPER">&amp;&amp;</span></a><span class="EOL">
</span>       <span class="COMMENT">(* Do not launch two auto-flusher: *)</span><span class="EOL">
</span>       <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-not"><span class="LIDENT">not</span></a> <a href="#local_ch_33"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">auto_flushing</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&amp;&amp;)"><span class="AMPERAMPER">&amp;&amp;</span></a><span class="EOL">
</span>       <span class="COMMENT">(* Do not launch the auto-flusher if operations are queued: *)</span><span class="EOL">
</span>       <span class="UIDENT">Lwt_sequence</span><span class="DOT">.</span><span class="LIDENT">is_empty</span> <a href="#local_wrapper_32"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">queued</span><span class="RPAREN">)</span> <span class="THEN">then</span> <span class="BEGIN">begin</span><span class="EOL">
</span>      <a href="#local_ch_33"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">auto_flushing</span> <span class="LESSMINUS">&lt;-</span> <span class="TRUE">true</span><span class="SEMI">;</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a> <span class="LPAREN">(</span><span class="LIDENT">auto_flush</span> <a href="#local_ch_33"><span class="LIDENT">ch</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="END">end</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Closed</span> <span class="BAR">|</span> <span class="UIDENT">Invalid</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="COMMENT">(* Do not change channel state if the channel has been closed *)</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-not"><span class="LIDENT">not</span></a> <span class="LPAREN">(</span><span class="UIDENT">Lwt_sequence</span><span class="DOT">.</span><span class="LIDENT">is_empty</span> <a href="#local_wrapper_32"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">queued</span><span class="RPAREN">)</span> <span class="THEN">then</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Resolving.val-wakeup_later"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">wakeup_later</span></a> <span class="LPAREN">(</span><span class="UIDENT">Lwt_sequence</span><span class="DOT">.</span><span class="LIDENT">take_l</span> <a href="#local_wrapper_32"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">queued</span><span class="RPAREN">)</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Idle</span> <span class="BAR">|</span> <span class="UIDENT">Waiting_for_busy</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="COMMENT">(* We must never unlock an unlocked channel *)</span><span class="EOL">
</span>    <span class="ASSERT">assert</span> <span class="FALSE">false</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* Wrap primitives into atomic io operations: *)</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-primitive"><span class="LIDENT">primitive</span></span> <span id="local_f_34"><span class="LIDENT">f</span></span> <span id="local_wrapper_35"><span class="LIDENT">wrapper</span></span> <span class="EQUAL">=</span> <span class="MATCH">match</span> <a href="#local_wrapper_35"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Idle</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="#local_wrapper_35"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="LESSMINUS">&lt;-</span> <span class="UIDENT">Busy_primitive</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="../lwt/lwt.ml.html#module-Sequential_composition.val-finalize"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">finalize</span></a><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_f_34"><span class="LIDENT">f</span></a> <a href="#local_wrapper_35"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">channel</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>         <span class="LIDENT">unlock</span> <a href="#local_wrapper_35"><span class="LIDENT">wrapper</span></a><span class="SEMI">;</span><span class="EOL">
</span>         <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Busy_primitive</span> <span class="BAR">|</span> <span class="UIDENT">Busy_atomic</span> <span class="UNDERSCORE">_</span> <span class="BAR">|</span> <span class="UIDENT">Waiting_for_busy</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="../lwt/lwt.ml.html#module-Pending_promises.val-add_task_r"><span class="LPAREN">(</span><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">add_task_r</span> <span class="LBRACKETAT">[@</span><span class="LIDENT">ocaml</span><span class="DOT">.</span><span class="LIDENT">warning</span> <span class="STRING">&quot;-3&quot;</span><span class="RBRACKET">]</span><span class="RPAREN">)</span></a> <a href="#local_wrapper_35"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">queued</span> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="BEGIN">begin</span> <span class="MATCH">match</span> <a href="#local_wrapper_35"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Closed</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="COMMENT">(* The channel has been closed while we were waiting *)</span><span class="EOL">
</span>        <span class="LIDENT">unlock</span> <a href="#local_wrapper_35"><span class="LIDENT">wrapper</span></a><span class="SEMI">;</span><span class="EOL">
</span>        <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <span class="LPAREN">(</span><span class="LIDENT">closed_channel</span> <a href="#local_wrapper_35"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">channel</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Idle</span> <span class="BAR">|</span> <span class="UIDENT">Waiting_for_busy</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <a href="#local_wrapper_35"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="LESSMINUS">&lt;-</span> <span class="UIDENT">Busy_primitive</span><span class="SEMI">;</span><span class="EOL">
</span>        <a href="../lwt/lwt.ml.html#module-Sequential_composition.val-finalize"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">finalize</span></a><span class="EOL">
</span>          <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_f_34"><span class="LIDENT">f</span></a> <a href="#local_wrapper_35"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">channel</span><span class="RPAREN">)</span><span class="EOL">
</span>          <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>             <span class="LIDENT">unlock</span> <a href="#local_wrapper_35"><span class="LIDENT">wrapper</span></a><span class="SEMI">;</span><span class="EOL">
</span>             <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Invalid</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <span class="LPAREN">(</span><span class="LIDENT">invalid_channel</span> <a href="#local_wrapper_35"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">channel</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Busy_primitive</span> <span class="BAR">|</span> <span class="UIDENT">Busy_atomic</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="ASSERT">assert</span> <span class="FALSE">false</span><span class="EOL">
</span>    <span class="END">end</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Closed</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <span class="LPAREN">(</span><span class="LIDENT">closed_channel</span> <a href="#local_wrapper_35"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">channel</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Invalid</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <span class="LPAREN">(</span><span class="LIDENT">invalid_channel</span> <a href="#local_wrapper_35"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">channel</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* Wrap a sequence of io operations into an atomic operation: *)</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-atomic"><span class="LIDENT">atomic</span></span> <span id="local_f_36"><span class="LIDENT">f</span></span> <span id="local_wrapper_37"><span class="LIDENT">wrapper</span></span> <span class="EQUAL">=</span> <span class="MATCH">match</span> <a href="#local_wrapper_37"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Idle</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_tmp_wrapper_38"><span class="LIDENT">tmp_wrapper</span></span> <span class="EQUAL">=</span> <span class="LBRACE">{</span> <span class="LIDENT">state</span> <span class="EQUAL">=</span> <span class="UIDENT">Idle</span><span class="SEMI">;</span><span class="EOL">
</span>                        <span class="LIDENT">channel</span> <span class="EQUAL">=</span> <a href="#local_wrapper_37"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">channel</span><span class="SEMI">;</span><span class="EOL">
</span>                        <span class="LIDENT">queued</span> <span class="EQUAL">=</span> <span class="UIDENT">Lwt_sequence</span><span class="DOT">.</span><span class="LIDENT">create</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="RBRACE">}</span> <span class="IN">in</span><span class="EOL">
</span>    <a href="#local_wrapper_37"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="LESSMINUS">&lt;-</span> <span class="UIDENT">Busy_atomic</span> <a href="#local_tmp_wrapper_38"><span class="LIDENT">tmp_wrapper</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <a href="../lwt/lwt.ml.html#module-Sequential_composition.val-finalize"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">finalize</span></a><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_f_36"><span class="LIDENT">f</span></a> <a href="#local_tmp_wrapper_38"><span class="LIDENT">tmp_wrapper</span></a><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>         <span class="COMMENT">(* The temporary wrapper is no more valid: *)</span><span class="EOL">
</span>         <a href="#local_tmp_wrapper_38"><span class="LIDENT">tmp_wrapper</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="LESSMINUS">&lt;-</span> <span class="UIDENT">Invalid</span><span class="SEMI">;</span><span class="EOL">
</span>         <span class="LIDENT">unlock</span> <a href="#local_wrapper_37"><span class="LIDENT">wrapper</span></a><span class="SEMI">;</span><span class="EOL">
</span>         <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Busy_primitive</span> <span class="BAR">|</span> <span class="UIDENT">Busy_atomic</span> <span class="UNDERSCORE">_</span> <span class="BAR">|</span> <span class="UIDENT">Waiting_for_busy</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="../lwt/lwt.ml.html#module-Pending_promises.val-add_task_r"><span class="LPAREN">(</span><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">add_task_r</span> <span class="LBRACKETAT">[@</span><span class="LIDENT">ocaml</span><span class="DOT">.</span><span class="LIDENT">warning</span> <span class="STRING">&quot;-3&quot;</span><span class="RBRACKET">]</span><span class="RPAREN">)</span></a> <a href="#local_wrapper_37"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">queued</span> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="BEGIN">begin</span> <span class="MATCH">match</span> <a href="#local_wrapper_37"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Closed</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="COMMENT">(* The channel has been closed while we were waiting *)</span><span class="EOL">
</span>        <span class="LIDENT">unlock</span> <a href="#local_wrapper_37"><span class="LIDENT">wrapper</span></a><span class="SEMI">;</span><span class="EOL">
</span>        <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <span class="LPAREN">(</span><span class="LIDENT">closed_channel</span> <a href="#local_wrapper_37"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">channel</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Idle</span> <span class="BAR">|</span> <span class="UIDENT">Waiting_for_busy</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_tmp_wrapper_39"><span class="LIDENT">tmp_wrapper</span></span> <span class="EQUAL">=</span> <span class="LBRACE">{</span> <span class="LIDENT">state</span> <span class="EQUAL">=</span> <span class="UIDENT">Idle</span><span class="SEMI">;</span><span class="EOL">
</span>                            <span class="LIDENT">channel</span> <span class="EQUAL">=</span> <a href="#local_wrapper_37"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">channel</span><span class="SEMI">;</span><span class="EOL">
</span>                            <span class="LIDENT">queued</span> <span class="EQUAL">=</span> <span class="UIDENT">Lwt_sequence</span><span class="DOT">.</span><span class="LIDENT">create</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="RBRACE">}</span> <span class="IN">in</span><span class="EOL">
</span>        <a href="#local_wrapper_37"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="LESSMINUS">&lt;-</span> <span class="UIDENT">Busy_atomic</span> <a href="#local_tmp_wrapper_39"><span class="LIDENT">tmp_wrapper</span></a><span class="SEMI">;</span><span class="EOL">
</span>        <a href="../lwt/lwt.ml.html#module-Sequential_composition.val-finalize"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">finalize</span></a><span class="EOL">
</span>          <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_f_36"><span class="LIDENT">f</span></a> <a href="#local_tmp_wrapper_39"><span class="LIDENT">tmp_wrapper</span></a><span class="RPAREN">)</span><span class="EOL">
</span>          <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>             <a href="#local_tmp_wrapper_39"><span class="LIDENT">tmp_wrapper</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="LESSMINUS">&lt;-</span> <span class="UIDENT">Invalid</span><span class="SEMI">;</span><span class="EOL">
</span>             <span class="LIDENT">unlock</span> <a href="#local_wrapper_37"><span class="LIDENT">wrapper</span></a><span class="SEMI">;</span><span class="EOL">
</span>             <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Invalid</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <span class="LPAREN">(</span><span class="LIDENT">invalid_channel</span> <a href="#local_wrapper_37"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">channel</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Busy_primitive</span> <span class="BAR">|</span> <span class="UIDENT">Busy_atomic</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="ASSERT">assert</span> <span class="FALSE">false</span><span class="EOL">
</span>    <span class="END">end</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Closed</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <span class="LPAREN">(</span><span class="LIDENT">closed_channel</span> <a href="#local_wrapper_37"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">channel</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Invalid</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <span class="LPAREN">(</span><span class="LIDENT">invalid_channel</span> <a href="#local_wrapper_37"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">channel</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span class="REC">rec</span> <span id="val-abort"><span class="LIDENT">abort</span></span> <span id="local_wrapper_40"><span class="LIDENT">wrapper</span></span> <span class="EQUAL">=</span> <span class="MATCH">match</span> <a href="#local_wrapper_40"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Busy_atomic</span> <span id="local_tmp_wrapper_41"><span class="LIDENT">tmp_wrapper</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="COMMENT">(* Close the depest opened wrapper: *)</span><span class="EOL">
</span>    <span class="LIDENT">abort</span> <a href="#local_tmp_wrapper_41"><span class="LIDENT">tmp_wrapper</span></a><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Closed</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="COMMENT">(* Double close, just returns the same thing as before *)</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/lazy.ml.html#val-force"><span class="UIDENT">Lazy</span><span class="DOT">.</span><span class="LIDENT">force</span></a> <a href="#local_wrapper_40"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">channel</span><span class="DOT">.</span><span class="LIDENT">close</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Invalid</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <span class="LPAREN">(</span><span class="LIDENT">invalid_channel</span> <a href="#local_wrapper_40"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">channel</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Idle</span> <span class="BAR">|</span> <span class="UIDENT">Busy_primitive</span> <span class="BAR">|</span> <span class="UIDENT">Waiting_for_busy</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="#local_wrapper_40"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="LESSMINUS">&lt;-</span> <span class="UIDENT">Closed</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="COMMENT">(* Abort any current real reading/writing operation on the
       channel: *)</span><span class="EOL">
</span>    <a href="../lwt/lwt.ml.html#module-Resolving.val-wakeup_exn"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">wakeup_exn</span></a><span class="EOL">
</span>      <a href="#local_wrapper_40"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">channel</span><span class="DOT">.</span><span class="LIDENT">abort_wakener</span> <span class="LPAREN">(</span><span class="LIDENT">closed_channel</span> <a href="#local_wrapper_40"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">channel</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/lazy.ml.html#val-force"><span class="UIDENT">Lazy</span><span class="DOT">.</span><span class="LIDENT">force</span></a> <a href="#local_wrapper_40"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">channel</span><span class="DOT">.</span><span class="LIDENT">close</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-close"><span class="LIDENT">close</span></span> <span class="COLON">:</span> <span class="TYPE">type</span> <span class="LIDENT">mode</span><span class="DOT">.</span> <span class="LIDENT">mode</span> <span class="LIDENT">channel</span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Public_types.type-t"><span class="LIDENT">unit</span> <span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">t</span></a> <span class="EQUAL">=</span> <span class="FUN">fun</span> <span id="local_wrapper_42"><span class="LIDENT">wrapper</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_channel_43"><span class="LIDENT">channel</span></span> <span class="EQUAL">=</span> <a href="#local_wrapper_42"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">channel</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="#local_channel_43"><span class="LIDENT">channel</span></a><span class="DOT">.</span><span class="LIDENT">main</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!=)"><span class="INFIXOP0">!=</span></a> <a href="#local_wrapper_42"><span class="LIDENT">wrapper</span></a> <span class="THEN">then</span><span class="EOL">
</span>    <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="UIDENT">Failure</span><span class="EOL">
</span>        <span class="STRING">&quot;Lwt_io.close: cannot close a channel obtained via Lwt_io.atomic&quot;</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="ELSE">else</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_channel_43"><span class="LIDENT">channel</span></a><span class="DOT">.</span><span class="LIDENT">mode</span> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Input</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="COMMENT">(* Just close it now: *)</span><span class="EOL">
</span>      <span class="LIDENT">abort</span> <a href="#local_wrapper_42"><span class="LIDENT">wrapper</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Output</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Sequential_composition.val-catch"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">catch</span></a><span class="EOL">
</span>        <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>           <span class="COMMENT">(* Performs all pending actions, flush the buffer, then close it: *)</span><span class="EOL">
</span>           <span class="LIDENT">primitive</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_channel_44"><span class="LIDENT">channel</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>             <span class="LIDENT">safe_flush_total</span> <a href="#local_channel_44"><span class="LIDENT">channel</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">abort</span> <a href="#local_wrapper_42"><span class="LIDENT">wrapper</span></a><span class="RPAREN">)</span> <a href="#local_wrapper_42"><span class="LIDENT">wrapper</span></a><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>           <span class="LIDENT">abort</span> <a href="#local_wrapper_42"><span class="LIDENT">wrapper</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-is_closed"><span class="LIDENT">is_closed</span></span> <span id="local_wrapper_45"><span class="LIDENT">wrapper</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="MATCH">match</span> <a href="#local_wrapper_45"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Closed</span> <span class="MINUSGREATER">-&gt;</span> <span class="TRUE">true</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Busy_primitive</span> <span class="BAR">|</span> <span class="UIDENT">Busy_atomic</span> <span class="UNDERSCORE">_</span> <span class="BAR">|</span> <span class="UIDENT">Waiting_for_busy</span> <span class="BAR">|</span> <span class="UIDENT">Idle</span> <span class="BAR">|</span> <span class="UIDENT">Invalid</span> <span class="MINUSGREATER">-&gt;</span> <span class="FALSE">false</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-flush_all"><span class="LIDENT">flush_all</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_wrappers_46"><span class="LIDENT">wrappers</span></span> <span class="EQUAL">=</span> <span class="UIDENT">Outputs</span><span class="DOT">.</span><span class="LIDENT">fold</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_x_47"><span class="LIDENT">x</span></span> <span id="local_l_48"><span class="LIDENT">l</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_x_47"><span class="LIDENT">x</span></a> <span class="COLONCOLON">::</span> <a href="#local_l_48"><span class="LIDENT">l</span></a><span class="RPAREN">)</span> <span class="LIDENT">outputs</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="IN">in</span><span class="EOL">
</span>  <a href="../lwt/lwt_list.ml.html#val-iter_p"><span class="UIDENT">Lwt_list</span><span class="DOT">.</span><span class="LIDENT">iter_p</span></a><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_wrapper_49"><span class="LIDENT">wrapper</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>       <a href="../lwt/lwt.ml.html#module-Sequential_composition.val-catch"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">catch</span></a><span class="EOL">
</span>         <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">primitive</span> <span class="LIDENT">safe_flush_total</span> <a href="#local_wrapper_49"><span class="LIDENT">wrapper</span></a><span class="RPAREN">)</span><span class="EOL">
</span>         <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="UNDERSCORE">_</span>  <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>    <a href="#local_wrappers_46"><span class="LIDENT">wrappers</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="COMMENT">(* Flush all opened output channels on exit: *)</span><span class="EOL">
</span>  <a href="lwt_main.ml.html#val-at_exit"><span class="UIDENT">Lwt_main</span><span class="DOT">.</span><span class="LIDENT">at_exit</span></a> <span class="LIDENT">flush_all</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-no_seek"><span class="LIDENT">no_seek</span></span> <span id="local__pos_50"><span class="LIDENT">_pos</span></span> <span id="local__cmd_51"><span class="LIDENT">_cmd</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <span class="LPAREN">(</span><span class="UIDENT">Failure</span> <span class="STRING">&quot;Lwt_io.seek: seek not supported on this channel&quot;</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-make"><span class="LIDENT">make</span></span> <span class="COLON">:</span><span class="EOL">
</span>    <span class="TYPE">type</span> <span class="LIDENT">m</span><span class="DOT">.</span><span class="EOL">
</span>    <span class="QUESTION">?</span><span class="LIDENT">buffer</span> <span class="COLON">:</span> <a href="lwt_bytes.ml.html#type-t"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">t</span></a> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="QUESTION">?</span><span class="LIDENT">close</span> <span class="COLON">:</span> <span class="LPAREN">(</span><span class="LIDENT">unit</span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Public_types.type-t"><span class="LIDENT">unit</span> <span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">t</span></a><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="QUESTION">?</span><span class="LIDENT">seek</span> <span class="COLON">:</span> <span class="LPAREN">(</span><span class="LIDENT">int64</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">seek_command</span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Public_types.type-t"><span class="LIDENT">int64</span> <span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">t</span></a><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LIDENT">mode</span> <span class="COLON">:</span> <span class="LIDENT">m</span> <span class="LIDENT">mode</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LPAREN">(</span><a href="lwt_bytes.ml.html#type-t"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">t</span></a> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">int</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">int</span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Public_types.type-t"><span class="LIDENT">int</span> <span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">t</span></a><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">m</span> <span class="LIDENT">channel</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="FUN">fun</span> <span class="QUESTION">?</span><span id="local_buffer_52"><span class="LIDENT">buffer</span></span> <span class="QUESTION">?</span><span class="LPAREN">(</span><span id="local_close_53"><span class="LIDENT">close</span></span><span class="EQUAL">=</span><a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a><span class="RPAREN">)</span> <span class="QUESTION">?</span><span class="LPAREN">(</span><span id="local_seek_54"><span class="LIDENT">seek</span></span><span class="EQUAL">=</span><span class="LIDENT">no_seek</span><span class="RPAREN">)</span> <span class="TILDE">~</span><span id="local_mode_55"><span class="LIDENT">mode</span></span> <span id="local_perform_io_56"><span class="LIDENT">perform_io</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="def_691"><span class="LPAREN">(</span><span id="local_buffer_57"><span class="LIDENT">buffer</span></span><span class="COMMA">,</span> <span id="local_size_58"><span class="LIDENT">size</span></span><span class="RPAREN">)</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_buffer_52"><span class="LIDENT">buffer</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_buffer_59"><span class="LIDENT">buffer</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">check_buffer</span> <span class="STRING">&quot;Lwt_io.make&quot;</span> <a href="#local_buffer_59"><span class="LIDENT">buffer</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <span class="LPAREN">(</span><a href="#local_buffer_59"><span class="LIDENT">buffer</span></a><span class="COMMA">,</span> <a href="lwt_bytes.ml.html#val-length"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">length</span></a> <a href="#local_buffer_59"><span class="LIDENT">buffer</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_size_60"><span class="LIDENT">size</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><span class="LIDENT">default_buffer_size</span> <span class="IN">in</span><span class="EOL">
</span>      <span class="LPAREN">(</span><a href="lwt_bytes.ml.html#val-create"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">create</span></a> <a href="#local_size_60"><span class="LIDENT">size</span></a><span class="COMMA">,</span> <a href="#local_size_60"><span class="LIDENT">size</span></a><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="def_696"><span id="local_abort_waiter_61"><span class="LIDENT">abort_waiter</span></span><span class="COMMA">,</span> <span id="local_abort_wakener_62"><span class="LIDENT">abort_wakener</span></span></span> <span class="EQUAL">=</span> <a href="../lwt/lwt.ml.html#module-Pending_promises.val-wait"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">wait</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="REC">rec</span> <span id="local_ch_63"><span class="LIDENT">ch</span></span> <span class="EQUAL">=</span> <span class="LBRACE">{</span><span class="EOL">
</span>    <span class="LIDENT">buffer</span> <span class="EQUAL">=</span> <a href="#local_buffer_57"><span class="LIDENT">buffer</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">length</span> <span class="EQUAL">=</span> <a href="#local_size_58"><span class="LIDENT">size</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">ptr</span> <span class="EQUAL">=</span> <span class="INT">0</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">max</span> <span class="EQUAL">=</span> <span class="LPAREN">(</span><span class="MATCH">match</span> <a href="#local_mode_55"><span class="LIDENT">mode</span></a> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Input</span> <span class="MINUSGREATER">-&gt;</span> <span class="INT">0</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Output</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_size_58"><span class="LIDENT">size</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">close</span> <span class="EQUAL">=</span> <span class="LAZY">lazy</span><span class="LPAREN">(</span><a href="../lwt/lwt.ml.html#module-Sequential_composition.val-catch"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">catch</span></a> <a href="#local_close_53"><span class="LIDENT">close</span></a> <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">abort_waiter</span> <span class="EQUAL">=</span> <a href="#local_abort_waiter_61"><span class="LIDENT">abort_waiter</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">abort_wakener</span> <span class="EQUAL">=</span> <a href="#local_abort_wakener_62"><span class="LIDENT">abort_wakener</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">main</span> <span class="EQUAL">=</span> <a href="#local_wrapper_67"><span class="LIDENT">wrapper</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">auto_flushing</span> <span class="EQUAL">=</span> <span class="FALSE">false</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">mode</span> <span class="EQUAL">=</span> <a href="#local_mode_55"><span class="LIDENT">mode</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">offset</span> <span class="EQUAL">=</span> <span class="INT">0L</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">typ</span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="UIDENT">Type_normal</span> <span class="LPAREN">(</span><span class="EOL">
</span>        <a href="#local_perform_io_56"><span class="LIDENT">perform_io</span></a><span class="COMMA">,</span><span class="EOL">
</span>        <span class="FUN">fun</span> <span id="local_pos_64"><span class="LIDENT">pos</span></span> <span id="local_cmd_65"><span class="LIDENT">cmd</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="TRY">try</span> <a href="#local_seek_54"><span class="LIDENT">seek</span></a> <a href="#local_pos_64"><span class="LIDENT">pos</span></a> <a href="#local_cmd_65"><span class="LIDENT">cmd</span></a><span class="EOL">
</span>          <span class="WITH">with</span> <span id="local_e_66"><span class="LIDENT">e</span></span> <span class="WHEN">when</span> <a href="../lwt/lwt.ml.html#module-Exception_filter.val-run"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="UIDENT">Exception_filter</span><span class="DOT">.</span><span class="LIDENT">run</span></a> <a href="#local_e_66"><span class="LIDENT">e</span></a> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <a href="#local_e_66"><span class="LIDENT">e</span></a><span class="EOL">
</span>    <span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>  <span class="RBRACE">}</span> <span class="AND">and</span> <span id="local_wrapper_67"><span class="LIDENT">wrapper</span></span> <span class="EQUAL">=</span> <span class="LBRACE">{</span><span class="EOL">
</span>    <span class="LIDENT">state</span> <span class="EQUAL">=</span> <span class="UIDENT">Idle</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">channel</span> <span class="EQUAL">=</span> <a href="#local_ch_63"><span class="LIDENT">ch</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">queued</span> <span class="EQUAL">=</span> <span class="UIDENT">Lwt_sequence</span><span class="DOT">.</span><span class="LIDENT">create</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>  <span class="RBRACE">}</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LPAREN">(</span><span class="MATCH">match</span> <a href="#local_mode_55"><span class="LIDENT">mode</span></a> <span class="WITH">with</span><span class="EOL">
</span>   <span class="BAR">|</span> <span class="UIDENT">Input</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>   <span class="BAR">|</span> <span class="UIDENT">Output</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Outputs</span><span class="DOT">.</span><span class="LIDENT">add</span> <span class="LIDENT">outputs</span> <a href="#local_wrapper_67"><span class="LIDENT">wrapper</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>  <a href="#local_wrapper_67"><span class="LIDENT">wrapper</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-of_bytes"><span class="LIDENT">of_bytes</span></span> <span class="LPAREN">(</span><span class="TYPE">type</span> <span class="LIDENT">m</span><span class="RPAREN">)</span> <span class="TILDE">~</span><span class="LPAREN">(</span><span id="local_mode_68"><span class="LIDENT">mode</span></span> <span class="COLON">:</span> <span class="LIDENT">m</span> <span class="LIDENT">mode</span><span class="RPAREN">)</span> <span id="local_bytes_69"><span class="LIDENT">bytes</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_length_70"><span class="LIDENT">length</span></span> <span class="EQUAL">=</span> <a href="lwt_bytes.ml.html#val-length"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">length</span></a> <a href="#local_bytes_69"><span class="LIDENT">bytes</span></a> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="def_679"><span id="local_abort_waiter_71"><span class="LIDENT">abort_waiter</span></span><span class="COMMA">,</span> <span id="local_abort_wakener_72"><span class="LIDENT">abort_wakener</span></span></span> <span class="EQUAL">=</span> <a href="../lwt/lwt.ml.html#module-Pending_promises.val-wait"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">wait</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="REC">rec</span> <span id="local_ch_73"><span class="LIDENT">ch</span></span> <span class="EQUAL">=</span> <span class="LBRACE">{</span><span class="EOL">
</span>    <span class="LIDENT">buffer</span> <span class="EQUAL">=</span> <a href="#local_bytes_69"><span class="LIDENT">bytes</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">length</span> <span class="EQUAL">=</span> <a href="#local_length_70"><span class="LIDENT">length</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">ptr</span> <span class="EQUAL">=</span> <span class="INT">0</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">max</span> <span class="EQUAL">=</span> <a href="#local_length_70"><span class="LIDENT">length</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">close</span> <span class="EQUAL">=</span> <span class="LAZY">lazy</span><a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="LPAREN">(</span><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span><span class="RPAREN">)</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">abort_waiter</span> <span class="EQUAL">=</span> <a href="#local_abort_waiter_71"><span class="LIDENT">abort_waiter</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">abort_wakener</span> <span class="EQUAL">=</span> <a href="#local_abort_wakener_72"><span class="LIDENT">abort_wakener</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">main</span> <span class="EQUAL">=</span> <a href="#local_wrapper_74"><span class="LIDENT">wrapper</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="COMMENT">(* Auto flush is set to [true] to prevent writing functions from
       trying to launch the auto-fllushed. *)</span><span class="EOL">
</span>    <span class="LIDENT">auto_flushing</span> <span class="EQUAL">=</span> <span class="TRUE">true</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">mode</span> <span class="EQUAL">=</span> <a href="#local_mode_68"><span class="LIDENT">mode</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">offset</span> <span class="EQUAL">=</span> <span class="LPAREN">(</span><span class="MATCH">match</span> <a href="#local_mode_68"><span class="LIDENT">mode</span></a> <span class="WITH">with</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Output</span> <span class="MINUSGREATER">-&gt;</span> <span class="INT">0L</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Input</span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/int64.ml.html#val-of_int"><span class="UIDENT">Int64</span><span class="DOT">.</span><span class="LIDENT">of_int</span></a> <a href="#local_length_70"><span class="LIDENT">length</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">typ</span> <span class="EQUAL">=</span> <span class="UIDENT">Type_bytes</span><span class="SEMI">;</span><span class="EOL">
</span>  <span class="RBRACE">}</span> <span class="AND">and</span> <span id="local_wrapper_74"><span class="LIDENT">wrapper</span></span> <span class="EQUAL">=</span> <span class="LBRACE">{</span><span class="EOL">
</span>    <span class="LIDENT">state</span> <span class="EQUAL">=</span> <span class="UIDENT">Idle</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">channel</span> <span class="EQUAL">=</span> <a href="#local_ch_73"><span class="LIDENT">ch</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">queued</span> <span class="EQUAL">=</span> <span class="UIDENT">Lwt_sequence</span><span class="DOT">.</span><span class="LIDENT">create</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>  <span class="RBRACE">}</span> <span class="IN">in</span><span class="EOL">
</span>  <a href="#local_wrapper_74"><span class="LIDENT">wrapper</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-of_fd"><span class="LIDENT">of_fd</span></span> <span class="COLON">:</span><span class="EOL">
</span>    <span class="TYPE">type</span> <span class="LIDENT">m</span><span class="DOT">.</span><span class="EOL">
</span>    <span class="QUESTION">?</span><span class="LIDENT">buffer</span> <span class="COLON">:</span> <a href="lwt_bytes.ml.html#type-t"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">t</span></a> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="QUESTION">?</span><span class="LIDENT">close</span> <span class="COLON">:</span> <span class="LPAREN">(</span><span class="LIDENT">unit</span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Public_types.type-t"><span class="LIDENT">unit</span> <span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">t</span></a><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LIDENT">mode</span> <span class="COLON">:</span> <span class="LIDENT">m</span> <span class="LIDENT">mode</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="lwt_unix.ml.html#type-file_descr"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">file_descr</span></a> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">m</span> <span class="LIDENT">channel</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="FUN">fun</span> <span class="QUESTION">?</span><span id="local_buffer_75"><span class="LIDENT">buffer</span></span> <span class="QUESTION">?</span><span id="local_close_76"><span class="LIDENT">close</span></span> <span class="TILDE">~</span><span id="local_mode_77"><span class="LIDENT">mode</span></span> <span id="local_fd_78"><span class="LIDENT">fd</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_perform_io_79"><span class="LIDENT">perform_io</span></span> <span class="EQUAL">=</span> <span class="MATCH">match</span> <a href="#local_mode_77"><span class="LIDENT">mode</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Input</span> <span class="MINUSGREATER">-&gt;</span> <a href="lwt_bytes.ml.html#val-read"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">read</span></a> <a href="#local_fd_78"><span class="LIDENT">fd</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Output</span> <span class="MINUSGREATER">-&gt;</span> <a href="lwt_bytes.ml.html#val-write"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">write</span></a> <a href="#local_fd_78"><span class="LIDENT">fd</span></a><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <span class="LIDENT">make</span><span class="EOL">
</span>    <span class="QUESTION">?</span><a href="#local_buffer_75"><span class="LIDENT">buffer</span></a><span class="EOL">
</span>    <span class="LABEL">~close:</span><span class="LPAREN">(</span><span class="MATCH">match</span> <a href="#local_close_76"><span class="LIDENT">close</span></a> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_f_80"><span class="LIDENT">f</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_f_80"><span class="LIDENT">f</span></a><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="lwt_unix.ml.html#val-close"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">close</span></a> <a href="#local_fd_78"><span class="LIDENT">fd</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="LABEL">~seek:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_pos_81"><span class="LIDENT">pos</span></span> <span id="local_cmd_82"><span class="LIDENT">cmd</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="lwt_unix.ml.html#module-LargeFile.val-lseek"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="UIDENT">LargeFile</span><span class="DOT">.</span><span class="LIDENT">lseek</span></a> <a href="#local_fd_78"><span class="LIDENT">fd</span></a> <a href="#local_pos_81"><span class="LIDENT">pos</span></a> <a href="#local_cmd_82"><span class="LIDENT">cmd</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="TILDE">~</span><a href="#local_mode_77"><span class="LIDENT">mode</span></a><span class="EOL">
</span>    <a href="#local_perform_io_79"><span class="LIDENT">perform_io</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-of_unix_fd"><span class="LIDENT">of_unix_fd</span></span> <span class="COLON">:</span><span class="EOL">
</span>    <span class="TYPE">type</span> <span class="LIDENT">m</span><span class="DOT">.</span><span class="EOL">
</span>    <span class="QUESTION">?</span><span class="LIDENT">buffer</span> <span class="COLON">:</span> <a href="lwt_bytes.ml.html#type-t"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">t</span></a> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="QUESTION">?</span><span class="LIDENT">close</span> <span class="COLON">:</span> <span class="LPAREN">(</span><span class="LIDENT">unit</span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Public_types.type-t"><span class="LIDENT">unit</span> <span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">t</span></a><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LIDENT">mode</span> <span class="COLON">:</span> <span class="LIDENT">m</span> <span class="LIDENT">mode</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">file_descr</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">m</span> <span class="LIDENT">channel</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="FUN">fun</span> <span class="QUESTION">?</span><span id="local_buffer_83"><span class="LIDENT">buffer</span></span> <span class="QUESTION">?</span><span id="local_close_84"><span class="LIDENT">close</span></span> <span class="TILDE">~</span><span id="local_mode_85"><span class="LIDENT">mode</span></span> <span id="local_fd_86"><span class="LIDENT">fd</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>  <span class="LIDENT">of_fd</span> <span class="QUESTION">?</span><a href="#local_buffer_83"><span class="LIDENT">buffer</span></a> <span class="QUESTION">?</span><a href="#local_close_84"><span class="LIDENT">close</span></a> <span class="TILDE">~</span><a href="#local_mode_85"><span class="LIDENT">mode</span></a> <span class="LPAREN">(</span><a href="lwt_unix.ml.html#val-of_unix_file_descr"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">of_unix_file_descr</span></a> <a href="#local_fd_86"><span class="LIDENT">fd</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-buffered"><span class="LIDENT">buffered</span></span> <span class="COLON">:</span> <span class="TYPE">type</span> <span class="LIDENT">m</span><span class="DOT">.</span> <span class="LIDENT">m</span> <span class="LIDENT">channel</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">int</span> <span class="EQUAL">=</span> <span class="FUN">fun</span> <span id="local_ch_87"><span class="LIDENT">ch</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>  <span class="MATCH">match</span> <a href="#local_ch_87"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">channel</span><span class="DOT">.</span><span class="LIDENT">mode</span> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Input</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_ch_87"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">channel</span><span class="DOT">.</span><span class="LIDENT">max</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <a href="#local_ch_87"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">channel</span><span class="DOT">.</span><span class="LIDENT">ptr</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Output</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_ch_87"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">channel</span><span class="DOT">.</span><span class="LIDENT">ptr</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-buffer_size"><span class="LIDENT">buffer_size</span></span> <span id="local_ch_88"><span class="LIDENT">ch</span></span> <span class="EQUAL">=</span> <a href="#local_ch_88"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">channel</span><span class="DOT">.</span><span class="LIDENT">length</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-resize_buffer"><span class="LIDENT">resize_buffer</span></span> <span class="COLON">:</span> <span class="TYPE">type</span> <span class="LIDENT">m</span><span class="DOT">.</span> <span class="LIDENT">m</span> <span class="LIDENT">channel</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">int</span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Public_types.type-t"><span class="LIDENT">unit</span> <span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">t</span></a> <span class="EQUAL">=</span> <span class="FUN">fun</span> <span id="local_wrapper_89"><span class="LIDENT">wrapper</span></span> <span id="local_len_90"><span class="LIDENT">len</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="#local_len_90"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;)"><span class="LESS">&lt;</span></a> <span class="LIDENT">min_buffer_size</span> <span class="THEN">then</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-invalid_arg"><span class="LIDENT">invalid_arg</span></a> <span class="STRING">&quot;Lwt_io.resize_buffer: buffer size too small&quot;</span><span class="SEMI">;</span><span class="EOL">
</span>  <span class="MATCH">match</span> <a href="#local_wrapper_89"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">channel</span><span class="DOT">.</span><span class="LIDENT">typ</span> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Type_bytes</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="UIDENT">Failure</span><span class="EOL">
</span>        <span class="LPAREN">(</span><span class="STRING">&quot;Lwt_io.resize_buffer: cannot resize the buffer of a channel &quot;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(^)"><span class="INFIXOP1">^</span></a><span class="EOL">
</span>         <span class="STRING">&quot;created with Lwt_io.of_string&quot;</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Type_normal</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_f_91"><span class="LIDENT">f</span></span> <span class="COLON">:</span> <span class="TYPE">type</span> <span class="LIDENT">m</span><span class="DOT">.</span> <span class="LIDENT">m</span> <span class="LIDENT">_channel</span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Public_types.type-t"><span class="LIDENT">unit</span> <span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">t</span></a> <span class="EQUAL">=</span> <span class="FUN">fun</span> <span id="local_ch_92"><span class="LIDENT">ch</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="MATCH">match</span> <a href="#local_ch_92"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">mode</span> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Input</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_unread_count_93"><span class="LIDENT">unread_count</span></span> <span class="EQUAL">=</span> <a href="#local_ch_92"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">max</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <a href="#local_ch_92"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <span class="IN">in</span><span class="EOL">
</span>        <span class="COMMENT">(* Fail if we want to decrease the buffer size and there is
           too much unread data in the buffer: *)</span><span class="EOL">
</span>        <span class="IF">if</span> <a href="#local_len_90"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;)"><span class="LESS">&lt;</span></a> <a href="#local_unread_count_93"><span class="LIDENT">unread_count</span></a> <span class="THEN">then</span><span class="EOL">
</span>          <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a><span class="EOL">
</span>            <span class="LPAREN">(</span><span class="UIDENT">Failure</span><span class="EOL">
</span>              <span class="LPAREN">(</span><span class="STRING">&quot;Lwt_io.resize_buffer: cannot decrease buffer size, too much &quot;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(^)"><span class="INFIXOP1">^</span></a><span class="EOL">
</span>               <span class="STRING">&quot;unread data&quot;</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="ELSE">else</span> <span class="BEGIN">begin</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_buffer_94"><span class="LIDENT">buffer</span></span> <span class="EQUAL">=</span> <a href="lwt_bytes.ml.html#val-create"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">create</span></a> <a href="#local_len_90"><span class="LIDENT">len</span></a> <span class="IN">in</span><span class="EOL">
</span>          <a href="lwt_bytes.ml.html#val-unsafe_blit"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">unsafe_blit</span></a> <a href="#local_ch_92"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <a href="#local_ch_92"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <a href="#local_buffer_94"><span class="LIDENT">buffer</span></a> <span class="INT">0</span> <a href="#local_unread_count_93"><span class="LIDENT">unread_count</span></a><span class="SEMI">;</span><span class="EOL">
</span>          <a href="#local_ch_92"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_buffer_94"><span class="LIDENT">buffer</span></a><span class="SEMI">;</span><span class="EOL">
</span>          <a href="#local_ch_92"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">length</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_len_90"><span class="LIDENT">len</span></a><span class="SEMI">;</span><span class="EOL">
</span>          <a href="#local_ch_92"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <span class="LESSMINUS">&lt;-</span> <span class="INT">0</span><span class="SEMI">;</span><span class="EOL">
</span>          <a href="#local_ch_92"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">max</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_unread_count_93"><span class="LIDENT">unread_count</span></a><span class="SEMI">;</span><span class="EOL">
</span>          <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="EOL">
</span>        <span class="END">end</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Output</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="COMMENT">(* If we decrease the buffer size, flush the buffer until
           the number of buffered bytes fits into the new buffer: *)</span><span class="EOL">
</span>        <span class="LET">let</span> <span class="REC">rec</span> <span id="local_loop_95"><span class="LIDENT">loop</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>          <span class="IF">if</span> <a href="#local_ch_92"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <a href="#local_len_90"><span class="LIDENT">len</span></a> <span class="THEN">then</span><span class="EOL">
</span>            <span class="LIDENT">flush_partial</span> <a href="#local_ch_92"><span class="LIDENT">ch</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <a href="#local_loop_95"><span class="LIDENT">loop</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>          <span class="ELSE">else</span><span class="EOL">
</span>            <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="EOL">
</span>        <span class="IN">in</span><span class="EOL">
</span>        <a href="#local_loop_95"><span class="LIDENT">loop</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_buffer_96"><span class="LIDENT">buffer</span></span> <span class="EQUAL">=</span> <a href="lwt_bytes.ml.html#val-create"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">create</span></a> <a href="#local_len_90"><span class="LIDENT">len</span></a> <span class="IN">in</span><span class="EOL">
</span>        <a href="lwt_bytes.ml.html#val-unsafe_blit"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">unsafe_blit</span></a> <a href="#local_ch_92"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <span class="INT">0</span> <a href="#local_buffer_96"><span class="LIDENT">buffer</span></a> <span class="INT">0</span> <a href="#local_ch_92"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span><span class="SEMI">;</span><span class="EOL">
</span>        <a href="#local_ch_92"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_buffer_96"><span class="LIDENT">buffer</span></a><span class="SEMI">;</span><span class="EOL">
</span>        <a href="#local_ch_92"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">length</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_len_90"><span class="LIDENT">len</span></a><span class="SEMI">;</span><span class="EOL">
</span>        <a href="#local_ch_92"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">max</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_len_90"><span class="LIDENT">len</span></a><span class="SEMI">;</span><span class="EOL">
</span>        <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span>    <span class="LIDENT">primitive</span> <a href="#local_f_91"><span class="LIDENT">f</span></a> <a href="#local_wrapper_89"><span class="LIDENT">wrapper</span></a><span class="EOL">
</span><span class="EOL">
</span><span id="module-Primitives"><span class="MODULE">module</span> <span class="UIDENT">Primitives</span> <span class="EQUAL">=</span><span class="EOL">
</span><span class="STRUCT">struct</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* This module contains all primitives operations. The operates
     without protection regarding locking, they are wrapped after into
     safe operations. *)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* +---------------------------------------------------------------+
     | Reading                                                       |
     +---------------------------------------------------------------+ *)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="REC">rec</span> <span id="module-Primitives.val-read_char"><span class="LIDENT">read_char</span></span> <span id="local_ic_97"><span class="LIDENT">ic</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_ptr_98"><span class="LIDENT">ptr</span></span> <span class="EQUAL">=</span> <a href="#local_ic_97"><span class="LIDENT">ic</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_ptr_98"><span class="LIDENT">ptr</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <a href="#local_ic_97"><span class="LIDENT">ic</span></a><span class="DOT">.</span><span class="LIDENT">max</span> <span class="THEN">then</span><span class="EOL">
</span>      <span class="LIDENT">refill</span> <a href="#local_ic_97"><span class="LIDENT">ic</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUNCTION">function</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="INT">0</span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <span class="UIDENT">End_of_file</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">read_char</span> <a href="#local_ic_97"><span class="LIDENT">ic</span></a><span class="EOL">
</span>    <span class="ELSE">else</span> <span class="BEGIN">begin</span><span class="EOL">
</span>      <a href="#local_ic_97"><span class="LIDENT">ic</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_ptr_98"><span class="LIDENT">ptr</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <span class="INT">1</span><span class="SEMI">;</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <span class="LPAREN">(</span><a href="lwt_bytes.ml.html#val-unsafe_get"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">unsafe_get</span></a> <a href="#local_ic_97"><span class="LIDENT">ic</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <a href="#local_ptr_98"><span class="LIDENT">ptr</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="END">end</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Primitives.val-read_char_opt"><span class="LIDENT">read_char_opt</span></span> <span id="local_ic_99"><span class="LIDENT">ic</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <a href="../lwt/lwt.ml.html#module-Sequential_composition.val-catch"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">catch</span></a><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">read_char</span> <a href="#local_ic_99"><span class="LIDENT">ic</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;|=)"><span class="INFIXOP0">&gt;|=</span></a> <span class="FUN">fun</span> <span id="local_ch_100"><span class="LIDENT">ch</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Some</span> <a href="#local_ch_100"><span class="LIDENT">ch</span></a><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="FUNCTION">function</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">End_of_file</span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_none"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_none</span></a><span class="EOL">
</span>        <span class="BAR">|</span> <span id="local_exn_101"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <a href="#local_exn_101"><span class="LIDENT">exn</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Primitives.val-read_line"><span class="LIDENT">read_line</span></span> <span id="local_ic_102"><span class="LIDENT">ic</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_buf_103"><span class="LIDENT">buf</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/buffer.ml.html#val-create"><span class="UIDENT">Buffer</span><span class="DOT">.</span><span class="LIDENT">create</span></a> <span class="INT">128</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="REC">rec</span> <span id="local_loop_104"><span class="LIDENT">loop</span></span> <span id="local_cr_read_105"><span class="LIDENT">cr_read</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Sequential_composition.val-try_bind"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">try_bind</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">read_char</span> <a href="#local_ic_102"><span class="LIDENT">ic</span></a><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="LPAREN">(</span><span class="FUNCTION">function</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="CHAR">'\n'</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a><span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/buffer.ml.html#val-contents"><span class="UIDENT">Buffer</span><span class="DOT">.</span><span class="LIDENT">contents</span></a> <a href="#local_buf_103"><span class="LIDENT">buf</span></a><span class="RPAREN">)</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="CHAR">'\r'</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <span class="IF">if</span> <a href="#local_cr_read_105"><span class="LIDENT">cr_read</span></a> <span class="THEN">then</span> <a href="../../../ocaml-base-compiler/src/stdlib/buffer.ml.html#val-add_char"><span class="UIDENT">Buffer</span><span class="DOT">.</span><span class="LIDENT">add_char</span></a> <a href="#local_buf_103"><span class="LIDENT">buf</span></a> <span class="CHAR">'\r'</span><span class="SEMI">;</span><span class="EOL">
</span>            <a href="#local_loop_104"><span class="LIDENT">loop</span></a> <span class="TRUE">true</span><span class="EOL">
</span>          <span class="BAR">|</span> <span id="local_ch_106"><span class="LIDENT">ch</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <span class="IF">if</span> <a href="#local_cr_read_105"><span class="LIDENT">cr_read</span></a> <span class="THEN">then</span> <a href="../../../ocaml-base-compiler/src/stdlib/buffer.ml.html#val-add_char"><span class="UIDENT">Buffer</span><span class="DOT">.</span><span class="LIDENT">add_char</span></a> <a href="#local_buf_103"><span class="LIDENT">buf</span></a> <span class="CHAR">'\r'</span><span class="SEMI">;</span><span class="EOL">
</span>            <a href="../../../ocaml-base-compiler/src/stdlib/buffer.ml.html#val-add_char"><span class="UIDENT">Buffer</span><span class="DOT">.</span><span class="LIDENT">add_char</span></a> <a href="#local_buf_103"><span class="LIDENT">buf</span></a> <a href="#local_ch_106"><span class="LIDENT">ch</span></a><span class="SEMI">;</span><span class="EOL">
</span>            <a href="#local_loop_104"><span class="LIDENT">loop</span></a> <span class="FALSE">false</span><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="LPAREN">(</span><span class="FUNCTION">function</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="UIDENT">End_of_file</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <span class="IF">if</span> <a href="#local_cr_read_105"><span class="LIDENT">cr_read</span></a> <span class="THEN">then</span> <a href="../../../ocaml-base-compiler/src/stdlib/buffer.ml.html#val-add_char"><span class="UIDENT">Buffer</span><span class="DOT">.</span><span class="LIDENT">add_char</span></a> <a href="#local_buf_103"><span class="LIDENT">buf</span></a> <span class="CHAR">'\r'</span><span class="SEMI">;</span><span class="EOL">
</span>            <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a><span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/buffer.ml.html#val-contents"><span class="UIDENT">Buffer</span><span class="DOT">.</span><span class="LIDENT">contents</span></a> <a href="#local_buf_103"><span class="LIDENT">buf</span></a><span class="RPAREN">)</span><span class="EOL">
</span>          <span class="BAR">|</span> <span id="local_exn_107"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <a href="#local_exn_107"><span class="LIDENT">exn</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span>    <span class="LIDENT">read_char</span> <a href="#local_ic_102"><span class="LIDENT">ic</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUNCTION">function</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="CHAR">'\r'</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_loop_104"><span class="LIDENT">loop</span></a> <span class="TRUE">true</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="CHAR">'\n'</span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <span class="STRING">&quot;&quot;</span><span class="EOL">
</span>    <span class="BAR">|</span> <span id="local_ch_108"><span class="LIDENT">ch</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/buffer.ml.html#val-add_char"><span class="UIDENT">Buffer</span><span class="DOT">.</span><span class="LIDENT">add_char</span></a> <a href="#local_buf_103"><span class="LIDENT">buf</span></a> <a href="#local_ch_108"><span class="LIDENT">ch</span></a><span class="SEMI">;</span> <a href="#local_loop_104"><span class="LIDENT">loop</span></a> <span class="FALSE">false</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Primitives.val-read_line_opt"><span class="LIDENT">read_line_opt</span></span> <span id="local_ic_109"><span class="LIDENT">ic</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <a href="../lwt/lwt.ml.html#module-Sequential_composition.val-catch"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">catch</span></a><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">read_line</span> <a href="#local_ic_109"><span class="LIDENT">ic</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;|=)"><span class="INFIXOP0">&gt;|=</span></a> <span class="FUN">fun</span> <span id="local_ch_110"><span class="LIDENT">ch</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Some</span> <a href="#local_ch_110"><span class="LIDENT">ch</span></a><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="FUNCTION">function</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">End_of_file</span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_none"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_none</span></a><span class="EOL">
</span>        <span class="BAR">|</span> <span id="local_exn_111"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <a href="#local_exn_111"><span class="LIDENT">exn</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Primitives.val-unsafe_read_into'"><span class="LIDENT">unsafe_read_into'</span></span> <span id="local_ic_112"><span class="LIDENT">ic</span></span> <span id="local_blit_113"><span class="LIDENT">blit</span></span> <span id="local_buf_114"><span class="LIDENT">buf</span></span> <span id="local_ofs_115"><span class="LIDENT">ofs</span></span> <span id="local_len_116"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_avail_117"><span class="LIDENT">avail</span></span> <span class="EQUAL">=</span> <a href="#local_ic_112"><span class="LIDENT">ic</span></a><span class="DOT">.</span><span class="LIDENT">max</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <a href="#local_ic_112"><span class="LIDENT">ic</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_avail_117"><span class="LIDENT">avail</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <span class="INT">0</span> <span class="THEN">then</span> <span class="BEGIN">begin</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_len_118"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-min"><span class="LIDENT">min</span></a> <a href="#local_len_116"><span class="LIDENT">len</span></a> <a href="#local_avail_117"><span class="LIDENT">avail</span></a> <span class="IN">in</span><span class="EOL">
</span>      <a href="#local_blit_113"><span class="LIDENT">blit</span></a> <a href="#local_ic_112"><span class="LIDENT">ic</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <a href="#local_ic_112"><span class="LIDENT">ic</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <a href="#local_buf_114"><span class="LIDENT">buf</span></a> <a href="#local_ofs_115"><span class="LIDENT">ofs</span></a> <a href="#local_len_118"><span class="LIDENT">len</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <a href="#local_ic_112"><span class="LIDENT">ic</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_ic_112"><span class="LIDENT">ic</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <a href="#local_len_118"><span class="LIDENT">len</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <a href="#local_len_118"><span class="LIDENT">len</span></a><span class="EOL">
</span>    <span class="END">end</span> <span class="ELSE">else</span> <span class="BEGIN">begin</span><span class="EOL">
</span>      <span class="LIDENT">refill</span> <a href="#local_ic_112"><span class="LIDENT">ic</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span id="local_n_119"><span class="LIDENT">n</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_len_120"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-min"><span class="LIDENT">min</span></a> <a href="#local_len_116"><span class="LIDENT">len</span></a> <a href="#local_n_119"><span class="LIDENT">n</span></a> <span class="IN">in</span><span class="EOL">
</span>      <a href="#local_blit_113"><span class="LIDENT">blit</span></a> <a href="#local_ic_112"><span class="LIDENT">ic</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <span class="INT">0</span> <a href="#local_buf_114"><span class="LIDENT">buf</span></a> <a href="#local_ofs_115"><span class="LIDENT">ofs</span></a> <a href="#local_len_120"><span class="LIDENT">len</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <a href="#local_ic_112"><span class="LIDENT">ic</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_len_120"><span class="LIDENT">len</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <a href="#local_ic_112"><span class="LIDENT">ic</span></a><span class="DOT">.</span><span class="LIDENT">max</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_n_119"><span class="LIDENT">n</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <a href="#local_len_120"><span class="LIDENT">len</span></a><span class="EOL">
</span>    <span class="END">end</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Primitives.val-unsafe_read_into_bigstring"><span class="LIDENT">unsafe_read_into_bigstring</span></span> <span id="local_ic_121"><span class="LIDENT">ic</span></span> <span id="local_buf_122"><span class="LIDENT">buf</span></span> <span id="local_ofs_123"><span class="LIDENT">ofs</span></span> <span id="local_len_124"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">unsafe_read_into'</span> <a href="#local_ic_121"><span class="LIDENT">ic</span></a> <a href="lwt_bytes.ml.html#val-unsafe_blit"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">unsafe_blit</span></a> <a href="#local_buf_122"><span class="LIDENT">buf</span></a> <a href="#local_ofs_123"><span class="LIDENT">ofs</span></a> <a href="#local_len_124"><span class="LIDENT">len</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Primitives.val-unsafe_read_into"><span class="LIDENT">unsafe_read_into</span></span> <span id="local_ic_125"><span class="LIDENT">ic</span></span> <span id="local_buf_126"><span class="LIDENT">buf</span></span> <span id="local_ofs_127"><span class="LIDENT">ofs</span></span> <span id="local_len_128"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">unsafe_read_into'</span> <a href="#local_ic_125"><span class="LIDENT">ic</span></a> <a href="lwt_bytes.ml.html#val-unsafe_blit_to_bytes"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">unsafe_blit_to_bytes</span></a> <a href="#local_buf_126"><span class="LIDENT">buf</span></a> <a href="#local_ofs_127"><span class="LIDENT">ofs</span></a> <a href="#local_len_128"><span class="LIDENT">len</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Primitives.val-read_into_bigstring"><span class="LIDENT">read_into_bigstring</span></span> <span id="local_ic_129"><span class="LIDENT">ic</span></span> <span id="local_buf_130"><span class="LIDENT">buf</span></span> <span id="local_ofs_131"><span class="LIDENT">ofs</span></span> <span id="local_len_132"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_ofs_131"><span class="LIDENT">ofs</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;)"><span class="LESS">&lt;</span></a> <span class="INT">0</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <a href="#local_len_132"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;)"><span class="LESS">&lt;</span></a> <span class="INT">0</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <a href="#local_ofs_131"><span class="LIDENT">ofs</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <a href="#local_len_132"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <a href="lwt_bytes.ml.html#val-length"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">length</span></a> <a href="#local_buf_130"><span class="LIDENT">buf</span></a> <span class="THEN">then</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <span class="LPAREN">(</span><span class="UIDENT">Invalid_argument</span> <span class="STRING">&quot;Lwt_io.read_into_bigstring&quot;</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="ELSE">else</span> <span class="BEGIN">begin</span><span class="EOL">
</span>      <span class="IF">if</span> <a href="#local_len_132"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="INT">0</span> <span class="THEN">then</span><span class="EOL">
</span>        <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <span class="INT">0</span><span class="EOL">
</span>      <span class="ELSE">else</span><span class="EOL">
</span>        <span class="LIDENT">unsafe_read_into_bigstring</span> <a href="#local_ic_129"><span class="LIDENT">ic</span></a> <a href="#local_buf_130"><span class="LIDENT">buf</span></a> <a href="#local_ofs_131"><span class="LIDENT">ofs</span></a> <a href="#local_len_132"><span class="LIDENT">len</span></a><span class="EOL">
</span>    <span class="END">end</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Primitives.val-read_into"><span class="LIDENT">read_into</span></span> <span id="local_ic_133"><span class="LIDENT">ic</span></span> <span id="local_buf_134"><span class="LIDENT">buf</span></span> <span id="local_ofs_135"><span class="LIDENT">ofs</span></span> <span id="local_len_136"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_ofs_135"><span class="LIDENT">ofs</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;)"><span class="LESS">&lt;</span></a> <span class="INT">0</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <a href="#local_len_136"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;)"><span class="LESS">&lt;</span></a> <span class="INT">0</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <a href="#local_ofs_135"><span class="LIDENT">ofs</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <a href="#local_len_136"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/bytes.ml.html#val-length"><span class="UIDENT">Bytes</span><span class="DOT">.</span><span class="LIDENT">length</span></a> <a href="#local_buf_134"><span class="LIDENT">buf</span></a> <span class="THEN">then</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <span class="LPAREN">(</span><span class="UIDENT">Invalid_argument</span> <span class="STRING">&quot;Lwt_io.read_into&quot;</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="ELSE">else</span> <span class="BEGIN">begin</span><span class="EOL">
</span>      <span class="IF">if</span> <a href="#local_len_136"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="INT">0</span> <span class="THEN">then</span><span class="EOL">
</span>        <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <span class="INT">0</span><span class="EOL">
</span>      <span class="ELSE">else</span><span class="EOL">
</span>        <span class="LIDENT">unsafe_read_into</span> <a href="#local_ic_133"><span class="LIDENT">ic</span></a> <a href="#local_buf_134"><span class="LIDENT">buf</span></a> <a href="#local_ofs_135"><span class="LIDENT">ofs</span></a> <a href="#local_len_136"><span class="LIDENT">len</span></a><span class="EOL">
</span>    <span class="END">end</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Primitives.val-unsafe_read_into_exactly'"><span class="LIDENT">unsafe_read_into_exactly'</span></span> <span id="local_read_into_137"><span class="LIDENT">read_into</span></span> <span id="local_ic_138"><span class="LIDENT">ic</span></span> <span id="local_buf_139"><span class="LIDENT">buf</span></span> <span id="local_ofs_140"><span class="LIDENT">ofs</span></span> <span id="local_len_141"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="REC">rec</span> <span id="local_loop_142"><span class="LIDENT">loop</span></span> <span id="local_ic_143"><span class="LIDENT">ic</span></span> <span id="local_buf_144"><span class="LIDENT">buf</span></span> <span id="local_ofs_145"><span class="LIDENT">ofs</span></span> <span id="local_len_146"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <a href="#local_read_into_137"><span class="LIDENT">read_into</span></a> <a href="#local_ic_143"><span class="LIDENT">ic</span></a> <a href="#local_buf_144"><span class="LIDENT">buf</span></a> <a href="#local_ofs_145"><span class="LIDENT">ofs</span></a> <a href="#local_len_146"><span class="LIDENT">len</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUNCTION">function</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="INT">0</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <span class="UIDENT">End_of_file</span><span class="EOL">
</span>      <span class="BAR">|</span> <span id="local_n_147"><span class="LIDENT">n</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_len_148"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span> <a href="#local_len_146"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <a href="#local_n_147"><span class="LIDENT">n</span></a> <span class="IN">in</span><span class="EOL">
</span>          <span class="IF">if</span> <a href="#local_len_148"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="INT">0</span> <span class="THEN">then</span><span class="EOL">
</span>            <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="EOL">
</span>          <span class="ELSE">else</span><span class="EOL">
</span>            <a href="#local_loop_142"><span class="LIDENT">loop</span></a> <a href="#local_ic_143"><span class="LIDENT">ic</span></a> <a href="#local_buf_144"><span class="LIDENT">buf</span></a> <span class="LPAREN">(</span><a href="#local_ofs_145"><span class="LIDENT">ofs</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <a href="#local_n_147"><span class="LIDENT">n</span></a><span class="RPAREN">)</span> <a href="#local_len_148"><span class="LIDENT">len</span></a><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span>    <a href="#local_loop_142"><span class="LIDENT">loop</span></a> <a href="#local_ic_138"><span class="LIDENT">ic</span></a> <a href="#local_buf_139"><span class="LIDENT">buf</span></a> <a href="#local_ofs_140"><span class="LIDENT">ofs</span></a> <a href="#local_len_141"><span class="LIDENT">len</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Primitives.val-unsafe_read_into_exactly_bigstring"><span class="LIDENT">unsafe_read_into_exactly_bigstring</span></span> <span id="local_ic_149"><span class="LIDENT">ic</span></span> <span id="local_buf_150"><span class="LIDENT">buf</span></span> <span id="local_ofs_151"><span class="LIDENT">ofs</span></span> <span id="local_len_152"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">unsafe_read_into_exactly'</span> <span class="LIDENT">unsafe_read_into_bigstring</span> <a href="#local_ic_149"><span class="LIDENT">ic</span></a> <a href="#local_buf_150"><span class="LIDENT">buf</span></a> <a href="#local_ofs_151"><span class="LIDENT">ofs</span></a> <a href="#local_len_152"><span class="LIDENT">len</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Primitives.val-unsafe_read_into_exactly"><span class="LIDENT">unsafe_read_into_exactly</span></span> <span id="local_ic_153"><span class="LIDENT">ic</span></span> <span id="local_buf_154"><span class="LIDENT">buf</span></span> <span id="local_ofs_155"><span class="LIDENT">ofs</span></span> <span id="local_len_156"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">unsafe_read_into_exactly'</span> <span class="LIDENT">unsafe_read_into</span> <a href="#local_ic_153"><span class="LIDENT">ic</span></a> <a href="#local_buf_154"><span class="LIDENT">buf</span></a> <a href="#local_ofs_155"><span class="LIDENT">ofs</span></a> <a href="#local_len_156"><span class="LIDENT">len</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Primitives.val-read_into_exactly_bigstring"><span class="LIDENT">read_into_exactly_bigstring</span></span> <span id="local_ic_157"><span class="LIDENT">ic</span></span> <span id="local_buf_158"><span class="LIDENT">buf</span></span> <span id="local_ofs_159"><span class="LIDENT">ofs</span></span> <span id="local_len_160"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_ofs_159"><span class="LIDENT">ofs</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;)"><span class="LESS">&lt;</span></a> <span class="INT">0</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <a href="#local_len_160"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;)"><span class="LESS">&lt;</span></a> <span class="INT">0</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <a href="#local_ofs_159"><span class="LIDENT">ofs</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <a href="#local_len_160"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <a href="lwt_bytes.ml.html#val-length"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">length</span></a> <a href="#local_buf_158"><span class="LIDENT">buf</span></a> <span class="THEN">then</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <span class="LPAREN">(</span><span class="UIDENT">Invalid_argument</span> <span class="STRING">&quot;Lwt_io.read_into_exactly_bigstring&quot;</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="ELSE">else</span> <span class="BEGIN">begin</span><span class="EOL">
</span>      <span class="IF">if</span> <a href="#local_len_160"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="INT">0</span> <span class="THEN">then</span><span class="EOL">
</span>        <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="EOL">
</span>      <span class="ELSE">else</span><span class="EOL">
</span>        <span class="LIDENT">unsafe_read_into_exactly_bigstring</span> <a href="#local_ic_157"><span class="LIDENT">ic</span></a> <a href="#local_buf_158"><span class="LIDENT">buf</span></a> <a href="#local_ofs_159"><span class="LIDENT">ofs</span></a> <a href="#local_len_160"><span class="LIDENT">len</span></a><span class="EOL">
</span>    <span class="END">end</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Primitives.val-read_into_exactly"><span class="LIDENT">read_into_exactly</span></span> <span id="local_ic_161"><span class="LIDENT">ic</span></span> <span id="local_buf_162"><span class="LIDENT">buf</span></span> <span id="local_ofs_163"><span class="LIDENT">ofs</span></span> <span id="local_len_164"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_ofs_163"><span class="LIDENT">ofs</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;)"><span class="LESS">&lt;</span></a> <span class="INT">0</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <a href="#local_len_164"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;)"><span class="LESS">&lt;</span></a> <span class="INT">0</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <a href="#local_ofs_163"><span class="LIDENT">ofs</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <a href="#local_len_164"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/bytes.ml.html#val-length"><span class="UIDENT">Bytes</span><span class="DOT">.</span><span class="LIDENT">length</span></a> <a href="#local_buf_162"><span class="LIDENT">buf</span></a> <span class="THEN">then</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <span class="LPAREN">(</span><span class="UIDENT">Invalid_argument</span> <span class="STRING">&quot;Lwt_io.read_into_exactly&quot;</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="ELSE">else</span> <span class="BEGIN">begin</span><span class="EOL">
</span>      <span class="IF">if</span> <a href="#local_len_164"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="INT">0</span> <span class="THEN">then</span><span class="EOL">
</span>        <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="EOL">
</span>      <span class="ELSE">else</span><span class="EOL">
</span>        <span class="LIDENT">unsafe_read_into_exactly</span> <a href="#local_ic_161"><span class="LIDENT">ic</span></a> <a href="#local_buf_162"><span class="LIDENT">buf</span></a> <a href="#local_ofs_163"><span class="LIDENT">ofs</span></a> <a href="#local_len_164"><span class="LIDENT">len</span></a><span class="EOL">
</span>    <span class="END">end</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Primitives.val-rev_concat"><span class="LIDENT">rev_concat</span></span> <span id="local_len_165"><span class="LIDENT">len</span></span> <span id="local_l_166"><span class="LIDENT">l</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_buf_167"><span class="LIDENT">buf</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/bytes.ml.html#val-create"><span class="UIDENT">Bytes</span><span class="DOT">.</span><span class="LIDENT">create</span></a> <a href="#local_len_165"><span class="LIDENT">len</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="UNDERSCORE">_</span> <span class="EQUAL">=</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-fold_left"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">fold_left</span></a><span class="EOL">
</span>        <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_ofs_168"><span class="LIDENT">ofs</span></span> <span id="local_str_169"><span class="LIDENT">str</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>           <span class="LET">let</span> <span id="local_len_170"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/string.ml.html#val-length"><span class="UIDENT">String</span><span class="DOT">.</span><span class="LIDENT">length</span></a> <a href="#local_str_169"><span class="LIDENT">str</span></a> <span class="IN">in</span><span class="EOL">
</span>           <span class="LET">let</span> <span id="local_ofs_171"><span class="LIDENT">ofs</span></span> <span class="EQUAL">=</span> <a href="#local_ofs_168"><span class="LIDENT">ofs</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <a href="#local_len_170"><span class="LIDENT">len</span></a> <span class="IN">in</span><span class="EOL">
</span>           <a href="../../../ocaml-base-compiler/src/stdlib/string.ml.html#val-unsafe_blit"><span class="UIDENT">String</span><span class="DOT">.</span><span class="LIDENT">unsafe_blit</span></a> <a href="#local_str_169"><span class="LIDENT">str</span></a> <span class="INT">0</span> <a href="#local_buf_167"><span class="LIDENT">buf</span></a> <a href="#local_ofs_171"><span class="LIDENT">ofs</span></a> <a href="#local_len_170"><span class="LIDENT">len</span></a><span class="SEMI">;</span><span class="EOL">
</span>           <a href="#local_ofs_171"><span class="LIDENT">ofs</span></a><span class="RPAREN">)</span><span class="EOL">
</span>        <a href="#local_len_165"><span class="LIDENT">len</span></a> <a href="#local_l_166"><span class="LIDENT">l</span></a><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span>    <a href="#local_buf_167"><span class="LIDENT">buf</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="REC">rec</span> <span id="module-Primitives.val-read_all"><span class="LIDENT">read_all</span></span> <span id="local_ic_172"><span class="LIDENT">ic</span></span> <span id="local_total_len_173"><span class="LIDENT">total_len</span></span> <span id="local_acc_174"><span class="LIDENT">acc</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_len_175"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span> <a href="#local_ic_172"><span class="LIDENT">ic</span></a><span class="DOT">.</span><span class="LIDENT">max</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <a href="#local_ic_172"><span class="LIDENT">ic</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_buf_176"><span class="LIDENT">buf</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/bytes.ml.html#val-create"><span class="UIDENT">Bytes</span><span class="DOT">.</span><span class="LIDENT">create</span></a> <a href="#local_len_175"><span class="LIDENT">len</span></a> <span class="IN">in</span><span class="EOL">
</span>    <a href="lwt_bytes.ml.html#val-unsafe_blit_to_bytes"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">unsafe_blit_to_bytes</span></a> <a href="#local_ic_172"><span class="LIDENT">ic</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <a href="#local_ic_172"><span class="LIDENT">ic</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <a href="#local_buf_176"><span class="LIDENT">buf</span></a> <span class="INT">0</span> <a href="#local_len_175"><span class="LIDENT">len</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_str_177"><span class="LIDENT">str</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/bytes.ml.html#val-unsafe_to_string"><span class="UIDENT">Bytes</span><span class="DOT">.</span><span class="LIDENT">unsafe_to_string</span></a> <a href="#local_buf_176"><span class="LIDENT">buf</span></a> <span class="IN">in</span><span class="EOL">
</span>    <a href="#local_ic_172"><span class="LIDENT">ic</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_ic_172"><span class="LIDENT">ic</span></a><span class="DOT">.</span><span class="LIDENT">max</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">refill</span> <a href="#local_ic_172"><span class="LIDENT">ic</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUNCTION">function</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="INT">0</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <span class="LPAREN">(</span><span class="LIDENT">rev_concat</span> <span class="LPAREN">(</span><a href="#local_len_175"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <a href="#local_total_len_173"><span class="LIDENT">total_len</span></a><span class="RPAREN">)</span> <span class="LPAREN">(</span><a href="#local_str_177"><span class="LIDENT">str</span></a> <span class="COLONCOLON">::</span> <a href="#local_acc_174"><span class="LIDENT">acc</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">read_all</span> <a href="#local_ic_172"><span class="LIDENT">ic</span></a> <span class="LPAREN">(</span><a href="#local_len_175"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <a href="#local_total_len_173"><span class="LIDENT">total_len</span></a><span class="RPAREN">)</span> <span class="LPAREN">(</span><a href="#local_str_177"><span class="LIDENT">str</span></a> <span class="COLONCOLON">::</span> <a href="#local_acc_174"><span class="LIDENT">acc</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Primitives.val-read"><span class="LIDENT">read</span></span> <span id="local_count_178"><span class="LIDENT">count</span></span> <span id="local_ic_179"><span class="LIDENT">ic</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_count_178"><span class="LIDENT">count</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">read_all</span> <a href="#local_ic_179"><span class="LIDENT">ic</span></a> <span class="INT">0</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;|=)"><span class="INFIXOP0">&gt;|=</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/bytes.ml.html#val-unsafe_to_string"><span class="UIDENT">Bytes</span><span class="DOT">.</span><span class="LIDENT">unsafe_to_string</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_len_180"><span class="LIDENT">len</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_buf_181"><span class="LIDENT">buf</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/bytes.ml.html#val-create"><span class="UIDENT">Bytes</span><span class="DOT">.</span><span class="LIDENT">create</span></a> <a href="#local_len_180"><span class="LIDENT">len</span></a> <span class="IN">in</span><span class="EOL">
</span>      <span class="LIDENT">unsafe_read_into</span> <a href="#local_ic_179"><span class="LIDENT">ic</span></a> <a href="#local_buf_181"><span class="LIDENT">buf</span></a> <span class="INT">0</span> <a href="#local_len_180"><span class="LIDENT">len</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span id="local_real_len_182"><span class="LIDENT">real_len</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="IF">if</span> <a href="#local_real_len_182"><span class="LIDENT">real_len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;)"><span class="LESS">&lt;</span></a> <a href="#local_len_180"><span class="LIDENT">len</span></a> <span class="THEN">then</span><span class="EOL">
</span>        <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/bytes.ml.html"><span class="UIDENT">Bytes</span></a><span class="DOT">.</span><span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/bytes.ml.html#val-sub"><span class="LIDENT">sub</span></a> <a href="#local_buf_181"><span class="LIDENT">buf</span></a> <span class="INT">0</span> <a href="#local_real_len_182"><span class="LIDENT">real_len</span></a> <span class="INFIXOP0">|&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/bytes.ml.html#val-unsafe_to_string"><span class="LIDENT">unsafe_to_string</span></a><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="ELSE">else</span><span class="EOL">
</span>        <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/bytes.ml.html#val-unsafe_to_string"><span class="UIDENT">Bytes</span><span class="DOT">.</span><span class="LIDENT">unsafe_to_string</span></a> <a href="#local_buf_181"><span class="LIDENT">buf</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Primitives.val-read_value"><span class="LIDENT">read_value</span></span> <span id="local_ic_183"><span class="LIDENT">ic</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_header_184"><span class="LIDENT">header</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/bytes.ml.html#val-create"><span class="UIDENT">Bytes</span><span class="DOT">.</span><span class="LIDENT">create</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/marshal.ml.html#val-header_size"><span class="UIDENT">Marshal</span><span class="DOT">.</span><span class="LIDENT">header_size</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LIDENT">unsafe_read_into_exactly</span> <a href="#local_ic_183"><span class="LIDENT">ic</span></a> <a href="#local_header_184"><span class="LIDENT">header</span></a> <span class="INT">0</span> <a href="../../../ocaml-base-compiler/src/stdlib/marshal.ml.html#val-header_size"><span class="UIDENT">Marshal</span><span class="DOT">.</span><span class="LIDENT">header_size</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_bsize_185"><span class="LIDENT">bsize</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/marshal.ml.html#val-data_size"><span class="UIDENT">Marshal</span><span class="DOT">.</span><span class="LIDENT">data_size</span></a> <a href="#local_header_184"><span class="LIDENT">header</span></a> <span class="INT">0</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_buffer_186"><span class="LIDENT">buffer</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/bytes.ml.html#val-create"><span class="UIDENT">Bytes</span><span class="DOT">.</span><span class="LIDENT">create</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/marshal.ml.html#val-header_size"><span class="UIDENT">Marshal</span><span class="DOT">.</span><span class="LIDENT">header_size</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <a href="#local_bsize_185"><span class="LIDENT">bsize</span></a><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/bytes.ml.html#val-unsafe_blit"><span class="UIDENT">Bytes</span><span class="DOT">.</span><span class="LIDENT">unsafe_blit</span></a> <a href="#local_header_184"><span class="LIDENT">header</span></a> <span class="INT">0</span> <a href="#local_buffer_186"><span class="LIDENT">buffer</span></a> <span class="INT">0</span> <a href="../../../ocaml-base-compiler/src/stdlib/marshal.ml.html#val-header_size"><span class="UIDENT">Marshal</span><span class="DOT">.</span><span class="LIDENT">header_size</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">unsafe_read_into_exactly</span> <a href="#local_ic_183"><span class="LIDENT">ic</span></a> <a href="#local_buffer_186"><span class="LIDENT">buffer</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/marshal.ml.html#val-header_size"><span class="UIDENT">Marshal</span><span class="DOT">.</span><span class="LIDENT">header_size</span></a> <a href="#local_bsize_185"><span class="LIDENT">bsize</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/marshal.ml.html#val-from_bytes"><span class="UIDENT">Marshal</span><span class="DOT">.</span><span class="LIDENT">from_bytes</span></a> <a href="#local_buffer_186"><span class="LIDENT">buffer</span></a> <span class="INT">0</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* +---------------------------------------------------------------+
     | Writing                                                       |
     +---------------------------------------------------------------+ *)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Primitives.val-flush"><span class="LIDENT">flush</span></span> <span class="EQUAL">=</span> <span class="LIDENT">flush_total</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="REC">rec</span> <span id="module-Primitives.val-write_char"><span class="LIDENT">write_char</span></span> <span id="local_oc_187"><span class="LIDENT">oc</span></span> <span id="local_ch_188"><span class="LIDENT">ch</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_ptr_189"><span class="LIDENT">ptr</span></span> <span class="EQUAL">=</span> <a href="#local_oc_187"><span class="LIDENT">oc</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_ptr_189"><span class="LIDENT">ptr</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;)"><span class="LESS">&lt;</span></a> <a href="#local_oc_187"><span class="LIDENT">oc</span></a><span class="DOT">.</span><span class="LIDENT">length</span> <span class="THEN">then</span> <span class="BEGIN">begin</span><span class="EOL">
</span>      <a href="#local_oc_187"><span class="LIDENT">oc</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_ptr_189"><span class="LIDENT">ptr</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <span class="INT">1</span><span class="SEMI">;</span><span class="EOL">
</span>      <a href="lwt_bytes.ml.html#val-unsafe_set"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">unsafe_set</span></a> <a href="#local_oc_187"><span class="LIDENT">oc</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <a href="#local_ptr_189"><span class="LIDENT">ptr</span></a> <a href="#local_ch_188"><span class="LIDENT">ch</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="EOL">
</span>    <span class="END">end</span> <span class="ELSE">else</span><span class="EOL">
</span>      <span class="LIDENT">flush_partial</span> <a href="#local_oc_187"><span class="LIDENT">oc</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">write_char</span> <a href="#local_oc_187"><span class="LIDENT">oc</span></a> <a href="#local_ch_188"><span class="LIDENT">ch</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="REC">rec</span> <span id="module-Primitives.val-unsafe_write_from'"><span class="LIDENT">unsafe_write_from'</span></span> <span id="local_blit_190"><span class="LIDENT">blit</span></span> <span id="local_oc_191"><span class="LIDENT">oc</span></span> <span id="local_str_192"><span class="LIDENT">str</span></span> <span id="local_ofs_193"><span class="LIDENT">ofs</span></span> <span id="local_len_194"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_avail_195"><span class="LIDENT">avail</span></span> <span class="EQUAL">=</span> <a href="#local_oc_191"><span class="LIDENT">oc</span></a><span class="DOT">.</span><span class="LIDENT">length</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <a href="#local_oc_191"><span class="LIDENT">oc</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_avail_195"><span class="LIDENT">avail</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;=)"><span class="INFIXOP0">&gt;=</span></a> <a href="#local_len_194"><span class="LIDENT">len</span></a> <span class="THEN">then</span> <span class="BEGIN">begin</span><span class="EOL">
</span>      <a href="#local_blit_190"><span class="LIDENT">blit</span></a> <a href="#local_str_192"><span class="LIDENT">str</span></a> <a href="#local_ofs_193"><span class="LIDENT">ofs</span></a> <a href="#local_oc_191"><span class="LIDENT">oc</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <a href="#local_oc_191"><span class="LIDENT">oc</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <a href="#local_len_194"><span class="LIDENT">len</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <a href="#local_oc_191"><span class="LIDENT">oc</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_oc_191"><span class="LIDENT">oc</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <a href="#local_len_194"><span class="LIDENT">len</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <span class="INT">0</span><span class="EOL">
</span>    <span class="END">end</span> <span class="ELSE">else</span> <span class="BEGIN">begin</span><span class="EOL">
</span>      <a href="#local_blit_190"><span class="LIDENT">blit</span></a> <a href="#local_str_192"><span class="LIDENT">str</span></a> <a href="#local_ofs_193"><span class="LIDENT">ofs</span></a> <a href="#local_oc_191"><span class="LIDENT">oc</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <a href="#local_oc_191"><span class="LIDENT">oc</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <a href="#local_avail_195"><span class="LIDENT">avail</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <a href="#local_oc_191"><span class="LIDENT">oc</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_oc_191"><span class="LIDENT">oc</span></a><span class="DOT">.</span><span class="LIDENT">length</span><span class="SEMI">;</span><span class="EOL">
</span>      <span class="LIDENT">flush_partial</span> <a href="#local_oc_191"><span class="LIDENT">oc</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_len_196"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span> <a href="#local_len_194"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <a href="#local_avail_195"><span class="LIDENT">avail</span></a> <span class="IN">in</span><span class="EOL">
</span>      <span class="IF">if</span> <a href="#local_oc_191"><span class="LIDENT">oc</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="INT">0</span> <span class="THEN">then</span> <span class="BEGIN">begin</span><span class="EOL">
</span>        <span class="IF">if</span> <a href="#local_len_196"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="INT">0</span> <span class="THEN">then</span><span class="EOL">
</span>          <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <span class="INT">0</span><span class="EOL">
</span>        <span class="ELSE">else</span><span class="EOL">
</span>          <span class="COMMENT">(* Everything has been written, try to write more: *)</span><span class="EOL">
</span>          <span class="LIDENT">unsafe_write_from'</span> <a href="#local_blit_190"><span class="LIDENT">blit</span></a> <a href="#local_oc_191"><span class="LIDENT">oc</span></a> <a href="#local_str_192"><span class="LIDENT">str</span></a> <span class="LPAREN">(</span><a href="#local_ofs_193"><span class="LIDENT">ofs</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <a href="#local_avail_195"><span class="LIDENT">avail</span></a><span class="RPAREN">)</span> <a href="#local_len_196"><span class="LIDENT">len</span></a><span class="EOL">
</span>      <span class="END">end</span> <span class="ELSE">else</span><span class="EOL">
</span>        <span class="COMMENT">(* Not everything has been written, just what is
           remaining: *)</span><span class="EOL">
</span>        <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <a href="#local_len_196"><span class="LIDENT">len</span></a><span class="EOL">
</span>    <span class="END">end</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Primitives.val-unsafe_write_from_bigstring"><span class="LIDENT">unsafe_write_from_bigstring</span></span> <span id="local_oc_197"><span class="LIDENT">oc</span></span> <span id="local_bytes_198"><span class="LIDENT">bytes</span></span> <span id="local_ofs_199"><span class="LIDENT">ofs</span></span> <span id="local_len_200"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">unsafe_write_from'</span> <a href="lwt_bytes.ml.html#val-blit"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">blit</span></a> <a href="#local_oc_197"><span class="LIDENT">oc</span></a> <a href="#local_bytes_198"><span class="LIDENT">bytes</span></a> <a href="#local_ofs_199"><span class="LIDENT">ofs</span></a> <a href="#local_len_200"><span class="LIDENT">len</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Primitives.val-unsafe_write_from"><span class="LIDENT">unsafe_write_from</span></span> <span id="local_oc_201"><span class="LIDENT">oc</span></span> <span id="local_str_202"><span class="LIDENT">str</span></span> <span id="local_ofs_203"><span class="LIDENT">ofs</span></span> <span id="local_len_204"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">unsafe_write_from'</span> <a href="lwt_bytes.ml.html#val-unsafe_blit_from_bytes"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">unsafe_blit_from_bytes</span></a> <a href="#local_oc_201"><span class="LIDENT">oc</span></a> <a href="#local_str_202"><span class="LIDENT">str</span></a> <a href="#local_ofs_203"><span class="LIDENT">ofs</span></a> <a href="#local_len_204"><span class="LIDENT">len</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Primitives.val-write_from_bigstring"><span class="LIDENT">write_from_bigstring</span></span> <span id="local_oc_205"><span class="LIDENT">oc</span></span> <span id="local_bytes_206"><span class="LIDENT">bytes</span></span> <span id="local_ofs_207"><span class="LIDENT">ofs</span></span> <span id="local_len_208"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_ofs_207"><span class="LIDENT">ofs</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;)"><span class="LESS">&lt;</span></a> <span class="INT">0</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <a href="#local_len_208"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;)"><span class="LESS">&lt;</span></a> <span class="INT">0</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <a href="#local_ofs_207"><span class="LIDENT">ofs</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <a href="#local_len_208"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <a href="lwt_bytes.ml.html#val-length"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">length</span></a> <a href="#local_bytes_206"><span class="LIDENT">bytes</span></a> <span class="THEN">then</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <span class="LPAREN">(</span><span class="UIDENT">Invalid_argument</span> <span class="STRING">&quot;Lwt_io.write_from_bigstring&quot;</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="ELSE">else</span> <span class="BEGIN">begin</span><span class="EOL">
</span>      <span class="IF">if</span> <a href="#local_len_208"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="INT">0</span> <span class="THEN">then</span><span class="EOL">
</span>        <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <span class="INT">0</span><span class="EOL">
</span>      <span class="ELSE">else</span><span class="EOL">
</span>        <span class="LIDENT">unsafe_write_from_bigstring</span> <a href="#local_oc_205"><span class="LIDENT">oc</span></a> <a href="#local_bytes_206"><span class="LIDENT">bytes</span></a> <a href="#local_ofs_207"><span class="LIDENT">ofs</span></a> <a href="#local_len_208"><span class="LIDENT">len</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span id="local_remaining_209"><span class="LIDENT">remaining</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <span class="LPAREN">(</span><a href="#local_len_208"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <a href="#local_remaining_209"><span class="LIDENT">remaining</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="END">end</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Primitives.val-write_from"><span class="LIDENT">write_from</span></span> <span id="local_oc_210"><span class="LIDENT">oc</span></span> <span id="local_buf_211"><span class="LIDENT">buf</span></span> <span id="local_ofs_212"><span class="LIDENT">ofs</span></span> <span id="local_len_213"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_ofs_212"><span class="LIDENT">ofs</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;)"><span class="LESS">&lt;</span></a> <span class="INT">0</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <a href="#local_len_213"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;)"><span class="LESS">&lt;</span></a> <span class="INT">0</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <a href="#local_ofs_212"><span class="LIDENT">ofs</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <a href="#local_len_213"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/bytes.ml.html#val-length"><span class="UIDENT">Bytes</span><span class="DOT">.</span><span class="LIDENT">length</span></a> <a href="#local_buf_211"><span class="LIDENT">buf</span></a> <span class="THEN">then</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <span class="LPAREN">(</span><span class="UIDENT">Invalid_argument</span> <span class="STRING">&quot;Lwt_io.write_from&quot;</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="ELSE">else</span> <span class="BEGIN">begin</span><span class="EOL">
</span>      <span class="IF">if</span> <a href="#local_len_213"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="INT">0</span> <span class="THEN">then</span><span class="EOL">
</span>        <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <span class="INT">0</span><span class="EOL">
</span>      <span class="ELSE">else</span><span class="EOL">
</span>        <span class="LIDENT">unsafe_write_from</span> <a href="#local_oc_210"><span class="LIDENT">oc</span></a> <a href="#local_buf_211"><span class="LIDENT">buf</span></a> <a href="#local_ofs_212"><span class="LIDENT">ofs</span></a> <a href="#local_len_213"><span class="LIDENT">len</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span id="local_remaining_214"><span class="LIDENT">remaining</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <span class="LPAREN">(</span><a href="#local_len_213"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <a href="#local_remaining_214"><span class="LIDENT">remaining</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="END">end</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Primitives.val-write_from_string"><span class="LIDENT">write_from_string</span></span> <span id="local_oc_215"><span class="LIDENT">oc</span></span> <span id="local_buf_216"><span class="LIDENT">buf</span></span> <span id="local_ofs_217"><span class="LIDENT">ofs</span></span> <span id="local_len_218"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_buf_219"><span class="LIDENT">buf</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/bytes.ml.html#val-unsafe_of_string"><span class="UIDENT">Bytes</span><span class="DOT">.</span><span class="LIDENT">unsafe_of_string</span></a> <a href="#local_buf_216"><span class="LIDENT">buf</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LIDENT">write_from</span> <a href="#local_oc_215"><span class="LIDENT">oc</span></a> <a href="#local_buf_219"><span class="LIDENT">buf</span></a> <a href="#local_ofs_217"><span class="LIDENT">ofs</span></a> <a href="#local_len_218"><span class="LIDENT">len</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Primitives.val-unsafe_write_from_exactly'"><span class="LIDENT">unsafe_write_from_exactly'</span></span> <span id="local_write_from_220"><span class="LIDENT">write_from</span></span> <span id="local_oc_221"><span class="LIDENT">oc</span></span> <span id="local_buf_222"><span class="LIDENT">buf</span></span> <span id="local_ofs_223"><span class="LIDENT">ofs</span></span> <span id="local_len_224"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="REC">rec</span> <span id="local_loop_225"><span class="LIDENT">loop</span></span> <span id="local_oc_226"><span class="LIDENT">oc</span></span> <span id="local_buf_227"><span class="LIDENT">buf</span></span> <span id="local_ofs_228"><span class="LIDENT">ofs</span></span> <span id="local_len_229"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <a href="#local_write_from_220"><span class="LIDENT">write_from</span></a> <a href="#local_oc_226"><span class="LIDENT">oc</span></a> <a href="#local_buf_227"><span class="LIDENT">buf</span></a> <a href="#local_ofs_228"><span class="LIDENT">ofs</span></a> <a href="#local_len_229"><span class="LIDENT">len</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUNCTION">function</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="INT">0</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="EOL">
</span>      <span class="BAR">|</span> <span id="local_n_230"><span class="LIDENT">n</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="#local_loop_225"><span class="LIDENT">loop</span></a> <a href="#local_oc_226"><span class="LIDENT">oc</span></a> <a href="#local_buf_227"><span class="LIDENT">buf</span></a> <span class="LPAREN">(</span><a href="#local_ofs_228"><span class="LIDENT">ofs</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <a href="#local_len_229"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <a href="#local_n_230"><span class="LIDENT">n</span></a><span class="RPAREN">)</span> <a href="#local_n_230"><span class="LIDENT">n</span></a><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span>    <a href="#local_loop_225"><span class="LIDENT">loop</span></a> <a href="#local_oc_221"><span class="LIDENT">oc</span></a> <a href="#local_buf_222"><span class="LIDENT">buf</span></a> <a href="#local_ofs_223"><span class="LIDENT">ofs</span></a> <a href="#local_len_224"><span class="LIDENT">len</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Primitives.val-unsafe_write_from_exactly"><span class="LIDENT">unsafe_write_from_exactly</span></span> <span id="local_oc_231"><span class="LIDENT">oc</span></span> <span id="local_buf_232"><span class="LIDENT">buf</span></span> <span id="local_ofs_233"><span class="LIDENT">ofs</span></span> <span id="local_len_234"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">unsafe_write_from_exactly'</span> <span class="LIDENT">unsafe_write_from</span> <a href="#local_oc_231"><span class="LIDENT">oc</span></a> <a href="#local_buf_232"><span class="LIDENT">buf</span></a> <a href="#local_ofs_233"><span class="LIDENT">ofs</span></a> <a href="#local_len_234"><span class="LIDENT">len</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Primitives.val-unsafe_write_from_exactly_bigstring"><span class="LIDENT">unsafe_write_from_exactly_bigstring</span></span> <span id="local_oc_235"><span class="LIDENT">oc</span></span> <span id="local_buf_236"><span class="LIDENT">buf</span></span> <span id="local_ofs_237"><span class="LIDENT">ofs</span></span> <span id="local_len_238"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">unsafe_write_from_exactly'</span> <span class="LIDENT">unsafe_write_from_bigstring</span> <a href="#local_oc_235"><span class="LIDENT">oc</span></a> <a href="#local_buf_236"><span class="LIDENT">buf</span></a> <a href="#local_ofs_237"><span class="LIDENT">ofs</span></a> <a href="#local_len_238"><span class="LIDENT">len</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Primitives.val-write_from_exactly"><span class="LIDENT">write_from_exactly</span></span> <span id="local_oc_239"><span class="LIDENT">oc</span></span> <span id="local_buf_240"><span class="LIDENT">buf</span></span> <span id="local_ofs_241"><span class="LIDENT">ofs</span></span> <span id="local_len_242"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_ofs_241"><span class="LIDENT">ofs</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;)"><span class="LESS">&lt;</span></a> <span class="INT">0</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <a href="#local_len_242"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;)"><span class="LESS">&lt;</span></a> <span class="INT">0</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <a href="#local_ofs_241"><span class="LIDENT">ofs</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <a href="#local_len_242"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/bytes.ml.html#val-length"><span class="UIDENT">Bytes</span><span class="DOT">.</span><span class="LIDENT">length</span></a> <a href="#local_buf_240"><span class="LIDENT">buf</span></a> <span class="THEN">then</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <span class="LPAREN">(</span><span class="UIDENT">Invalid_argument</span> <span class="STRING">&quot;Lwt_io.write_from_exactly&quot;</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="ELSE">else</span> <span class="BEGIN">begin</span><span class="EOL">
</span>      <span class="IF">if</span> <a href="#local_len_242"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="INT">0</span> <span class="THEN">then</span><span class="EOL">
</span>        <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="EOL">
</span>      <span class="ELSE">else</span><span class="EOL">
</span>        <span class="LIDENT">unsafe_write_from_exactly</span> <a href="#local_oc_239"><span class="LIDENT">oc</span></a> <a href="#local_buf_240"><span class="LIDENT">buf</span></a> <a href="#local_ofs_241"><span class="LIDENT">ofs</span></a> <a href="#local_len_242"><span class="LIDENT">len</span></a><span class="EOL">
</span>    <span class="END">end</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Primitives.val-write_from_exactly_bigstring"><span class="LIDENT">write_from_exactly_bigstring</span></span> <span id="local_oc_243"><span class="LIDENT">oc</span></span> <span id="local_buf_244"><span class="LIDENT">buf</span></span> <span id="local_ofs_245"><span class="LIDENT">ofs</span></span> <span id="local_len_246"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_ofs_245"><span class="LIDENT">ofs</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;)"><span class="LESS">&lt;</span></a> <span class="INT">0</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <a href="#local_len_246"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;)"><span class="LESS">&lt;</span></a> <span class="INT">0</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <a href="#local_ofs_245"><span class="LIDENT">ofs</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <a href="#local_len_246"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <a href="lwt_bytes.ml.html#val-length"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">length</span></a> <a href="#local_buf_244"><span class="LIDENT">buf</span></a> <span class="THEN">then</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <span class="LPAREN">(</span><span class="UIDENT">Invalid_argument</span> <span class="STRING">&quot;Lwt_io.write_from_exactly_bigstring&quot;</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="ELSE">else</span> <span class="BEGIN">begin</span><span class="EOL">
</span>      <span class="IF">if</span> <a href="#local_len_246"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="INT">0</span> <span class="THEN">then</span><span class="EOL">
</span>        <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="EOL">
</span>      <span class="ELSE">else</span><span class="EOL">
</span>        <span class="LIDENT">unsafe_write_from_exactly_bigstring</span> <a href="#local_oc_243"><span class="LIDENT">oc</span></a> <a href="#local_buf_244"><span class="LIDENT">buf</span></a> <a href="#local_ofs_245"><span class="LIDENT">ofs</span></a> <a href="#local_len_246"><span class="LIDENT">len</span></a><span class="EOL">
</span>    <span class="END">end</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Primitives.val-write_from_string_exactly"><span class="LIDENT">write_from_string_exactly</span></span> <span id="local_oc_247"><span class="LIDENT">oc</span></span> <span id="local_buf_248"><span class="LIDENT">buf</span></span> <span id="local_ofs_249"><span class="LIDENT">ofs</span></span> <span id="local_len_250"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_buf_251"><span class="LIDENT">buf</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/bytes.ml.html#val-unsafe_of_string"><span class="UIDENT">Bytes</span><span class="DOT">.</span><span class="LIDENT">unsafe_of_string</span></a> <a href="#local_buf_248"><span class="LIDENT">buf</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LIDENT">write_from_exactly</span> <a href="#local_oc_247"><span class="LIDENT">oc</span></a> <a href="#local_buf_251"><span class="LIDENT">buf</span></a> <a href="#local_ofs_249"><span class="LIDENT">ofs</span></a> <a href="#local_len_250"><span class="LIDENT">len</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Primitives.val-write"><span class="LIDENT">write</span></span> <span id="local_oc_252"><span class="LIDENT">oc</span></span> <span id="local_str_253"><span class="LIDENT">str</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_buf_254"><span class="LIDENT">buf</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/bytes.ml.html#val-unsafe_of_string"><span class="UIDENT">Bytes</span><span class="DOT">.</span><span class="LIDENT">unsafe_of_string</span></a> <a href="#local_str_253"><span class="LIDENT">str</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LIDENT">unsafe_write_from_exactly</span> <a href="#local_oc_252"><span class="LIDENT">oc</span></a> <a href="#local_buf_254"><span class="LIDENT">buf</span></a> <span class="INT">0</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/bytes.ml.html#val-length"><span class="UIDENT">Bytes</span><span class="DOT">.</span><span class="LIDENT">length</span></a> <a href="#local_buf_254"><span class="LIDENT">buf</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Primitives.val-write_line"><span class="LIDENT">write_line</span></span> <span id="local_oc_255"><span class="LIDENT">oc</span></span> <span id="local_str_256"><span class="LIDENT">str</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_buf_257"><span class="LIDENT">buf</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/bytes.ml.html#val-unsafe_of_string"><span class="UIDENT">Bytes</span><span class="DOT">.</span><span class="LIDENT">unsafe_of_string</span></a> <a href="#local_str_256"><span class="LIDENT">str</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LIDENT">unsafe_write_from_exactly</span> <a href="#local_oc_255"><span class="LIDENT">oc</span></a> <a href="#local_buf_257"><span class="LIDENT">buf</span></a> <span class="INT">0</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/bytes.ml.html#val-length"><span class="UIDENT">Bytes</span><span class="DOT">.</span><span class="LIDENT">length</span></a> <a href="#local_buf_257"><span class="LIDENT">buf</span></a><span class="RPAREN">)</span> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LIDENT">write_char</span> <a href="#local_oc_255"><span class="LIDENT">oc</span></a> <span class="CHAR">'\n'</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Primitives.val-write_value"><span class="LIDENT">write_value</span></span> <span id="local_oc_258"><span class="LIDENT">oc</span></span> <span class="QUESTION">?</span><span class="LPAREN">(</span><span id="local_flags_259"><span class="LIDENT">flags</span></span><span class="EQUAL">=</span><span class="LBRACKET">[</span><span class="RBRACKET">]</span><span class="RPAREN">)</span> <span id="local_x_260"><span class="LIDENT">x</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">write</span> <a href="#local_oc_258"><span class="LIDENT">oc</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/marshal.ml.html#val-to_string"><span class="UIDENT">Marshal</span><span class="DOT">.</span><span class="LIDENT">to_string</span></a> <a href="#local_x_260"><span class="LIDENT">x</span></a> <a href="#local_flags_259"><span class="LIDENT">flags</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* +---------------------------------------------------------------+
     | Low-level access                                              |
     +---------------------------------------------------------------+ *)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="REC">rec</span> <span id="module-Primitives.val-read_block_unsafe"><span class="LIDENT">read_block_unsafe</span></span> <span id="local_ic_261"><span class="LIDENT">ic</span></span> <span id="local_size_262"><span class="LIDENT">size</span></span> <span id="local_f_263"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_ic_261"><span class="LIDENT">ic</span></a><span class="DOT">.</span><span class="LIDENT">max</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <a href="#local_ic_261"><span class="LIDENT">ic</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;)"><span class="LESS">&lt;</span></a> <a href="#local_size_262"><span class="LIDENT">size</span></a> <span class="THEN">then</span><span class="EOL">
</span>      <span class="LIDENT">refill</span> <a href="#local_ic_261"><span class="LIDENT">ic</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUNCTION">function</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="INT">0</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <span class="UIDENT">End_of_file</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LIDENT">read_block_unsafe</span> <a href="#local_ic_261"><span class="LIDENT">ic</span></a> <a href="#local_size_262"><span class="LIDENT">size</span></a> <a href="#local_f_263"><span class="LIDENT">f</span></a><span class="EOL">
</span>    <span class="ELSE">else</span> <span class="BEGIN">begin</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_ptr_264"><span class="LIDENT">ptr</span></span> <span class="EQUAL">=</span> <a href="#local_ic_261"><span class="LIDENT">ic</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <span class="IN">in</span><span class="EOL">
</span>      <a href="#local_ic_261"><span class="LIDENT">ic</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_ptr_264"><span class="LIDENT">ptr</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <a href="#local_size_262"><span class="LIDENT">size</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <a href="#local_f_263"><span class="LIDENT">f</span></a> <a href="#local_ic_261"><span class="LIDENT">ic</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <a href="#local_ptr_264"><span class="LIDENT">ptr</span></a><span class="EOL">
</span>    <span class="END">end</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="REC">rec</span> <span id="module-Primitives.val-write_block_unsafe"><span class="LIDENT">write_block_unsafe</span></span> <span id="local_oc_265"><span class="LIDENT">oc</span></span> <span id="local_size_266"><span class="LIDENT">size</span></span> <span id="local_f_267"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_oc_265"><span class="LIDENT">oc</span></a><span class="DOT">.</span><span class="LIDENT">max</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <a href="#local_oc_265"><span class="LIDENT">oc</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;)"><span class="LESS">&lt;</span></a> <a href="#local_size_266"><span class="LIDENT">size</span></a> <span class="THEN">then</span><span class="EOL">
</span>      <span class="LIDENT">flush_partial</span> <a href="#local_oc_265"><span class="LIDENT">oc</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">write_block_unsafe</span> <a href="#local_oc_265"><span class="LIDENT">oc</span></a> <a href="#local_size_266"><span class="LIDENT">size</span></a> <a href="#local_f_267"><span class="LIDENT">f</span></a><span class="EOL">
</span>    <span class="ELSE">else</span> <span class="BEGIN">begin</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_ptr_268"><span class="LIDENT">ptr</span></span> <span class="EQUAL">=</span> <a href="#local_oc_265"><span class="LIDENT">oc</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <span class="IN">in</span><span class="EOL">
</span>      <a href="#local_oc_265"><span class="LIDENT">oc</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_ptr_268"><span class="LIDENT">ptr</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <a href="#local_size_266"><span class="LIDENT">size</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <a href="#local_f_267"><span class="LIDENT">f</span></a> <a href="#local_oc_265"><span class="LIDENT">oc</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <a href="#local_ptr_268"><span class="LIDENT">ptr</span></a><span class="EOL">
</span>    <span class="END">end</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Primitives.val-block"><span class="LIDENT">block</span></span> <span class="COLON">:</span><span class="EOL">
</span>      <span class="TYPE">type</span> <span class="LIDENT">m</span><span class="DOT">.</span><span class="EOL">
</span>      <span class="LIDENT">m</span> <span class="LIDENT">_channel</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">int</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LPAREN">(</span><a href="lwt_bytes.ml.html#type-t"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">t</span></a> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">int</span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Public_types.type-t"><span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">t</span></a><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <a href="../lwt/lwt.ml.html#module-Public_types.type-t"><span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">t</span></a> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="FUN">fun</span> <span id="local_ch_269"><span class="LIDENT">ch</span></span> <span id="local_size_270"><span class="LIDENT">size</span></span> <span id="local_f_271"><span class="LIDENT">f</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_size_270"><span class="LIDENT">size</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;)"><span class="LESS">&lt;</span></a> <span class="INT">0</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <a href="#local_size_270"><span class="LIDENT">size</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <span class="LIDENT">min_buffer_size</span> <span class="THEN">then</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <span class="LPAREN">(</span><span class="UIDENT">Invalid_argument</span> <span class="STRING">&quot;Lwt_io.block&quot;</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="ELSE">else</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_ch_269"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">max</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <a href="#local_ch_269"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;=)"><span class="INFIXOP0">&gt;=</span></a> <a href="#local_size_270"><span class="LIDENT">size</span></a> <span class="THEN">then</span> <span class="BEGIN">begin</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_ptr_272"><span class="LIDENT">ptr</span></span> <span class="EQUAL">=</span> <a href="#local_ch_269"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <span class="IN">in</span><span class="EOL">
</span>      <a href="#local_ch_269"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_ptr_272"><span class="LIDENT">ptr</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <a href="#local_size_270"><span class="LIDENT">size</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <a href="#local_f_271"><span class="LIDENT">f</span></a> <a href="#local_ch_269"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <a href="#local_ptr_272"><span class="LIDENT">ptr</span></a><span class="EOL">
</span>    <span class="END">end</span> <span class="ELSE">else</span><span class="EOL">
</span>      <span class="MATCH">match</span> <a href="#local_ch_269"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">mode</span> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Input</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LIDENT">read_block_unsafe</span> <a href="#local_ch_269"><span class="LIDENT">ch</span></a> <a href="#local_size_270"><span class="LIDENT">size</span></a> <a href="#local_f_271"><span class="LIDENT">f</span></a><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Output</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LIDENT">write_block_unsafe</span> <a href="#local_ch_269"><span class="LIDENT">ch</span></a> <a href="#local_size_270"><span class="LIDENT">size</span></a> <a href="#local_f_271"><span class="LIDENT">f</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Primitives.val-perform"><span class="LIDENT">perform</span></span> <span id="local_token_273"><span class="LIDENT">token</span></span> <span id="local_da_274"><span class="LIDENT">da</span></span> <span id="local_ch_275"><span class="LIDENT">ch</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="#local_token_273"><span class="LIDENT">token</span></a> <span class="THEN">then</span> <span class="BEGIN">begin</span><span class="EOL">
</span>      <span class="IF">if</span> <a href="#local_da_274"><span class="LIDENT">da</span></a><span class="DOT">.</span><span class="LIDENT">da_max</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;&gt;)"><span class="INFIXOP0">&lt;&gt;</span></a> <a href="#local_ch_275"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">max</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <a href="#local_da_274"><span class="LIDENT">da</span></a><span class="DOT">.</span><span class="LIDENT">da_ptr</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;)"><span class="LESS">&lt;</span></a> <a href="#local_ch_275"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <a href="#local_da_274"><span class="LIDENT">da</span></a><span class="DOT">.</span><span class="LIDENT">da_ptr</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <a href="#local_ch_275"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">max</span> <span class="THEN">then</span><span class="EOL">
</span>        <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <span class="LPAREN">(</span><span class="UIDENT">Invalid_argument</span> <span class="STRING">&quot;Lwt_io.direct_access.da_perform&quot;</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="ELSE">else</span> <span class="BEGIN">begin</span><span class="EOL">
</span>        <a href="#local_ch_275"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_da_274"><span class="LIDENT">da</span></a><span class="DOT">.</span><span class="LIDENT">da_ptr</span><span class="SEMI">;</span><span class="EOL">
</span>        <span class="LIDENT">perform_io</span> <a href="#local_ch_275"><span class="LIDENT">ch</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span id="local_count_276"><span class="LIDENT">count</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <a href="#local_da_274"><span class="LIDENT">da</span></a><span class="DOT">.</span><span class="LIDENT">da_ptr</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_ch_275"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span><span class="SEMI">;</span><span class="EOL">
</span>        <a href="#local_da_274"><span class="LIDENT">da</span></a><span class="DOT">.</span><span class="LIDENT">da_max</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_ch_275"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">max</span><span class="SEMI">;</span><span class="EOL">
</span>        <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <a href="#local_count_276"><span class="LIDENT">count</span></a><span class="EOL">
</span>      <span class="END">end</span><span class="EOL">
</span>    <span class="END">end</span> <span class="ELSE">else</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a><span class="EOL">
</span>        <span class="LPAREN">(</span><span class="UIDENT">Failure</span><span class="EOL">
</span>          <span class="LPAREN">(</span><span class="STRING">&quot;Lwt_io.perform: this function can not be called outside &quot;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(^)"><span class="INFIXOP1">^</span></a><span class="EOL">
</span>           <span class="STRING">&quot;Lwt_io.direct_access&quot;</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Primitives.val-direct_access"><span class="LIDENT">direct_access</span></span> <span id="local_ch_277"><span class="LIDENT">ch</span></span> <span id="local_f_278"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_token_279"><span class="LIDENT">token</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ref"><span class="LIDENT">ref</span></a> <span class="TRUE">true</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="REC">rec</span> <span id="local_da_280"><span class="LIDENT">da</span></span> <span class="EQUAL">=</span> <span class="LBRACE">{</span><span class="EOL">
</span>      <span class="LIDENT">da_ptr</span> <span class="EQUAL">=</span> <a href="#local_ch_277"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span><span class="SEMI">;</span><span class="EOL">
</span>      <span class="LIDENT">da_max</span> <span class="EQUAL">=</span> <a href="#local_ch_277"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">max</span><span class="SEMI">;</span><span class="EOL">
</span>      <span class="LIDENT">da_buffer</span> <span class="EQUAL">=</span> <a href="#local_ch_277"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span><span class="SEMI">;</span><span class="EOL">
</span>      <span class="LIDENT">da_perform</span> <span class="EQUAL">=</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">perform</span> <a href="#local_token_279"><span class="LIDENT">token</span></a> <a href="#local_da_280"><span class="LIDENT">da</span></a> <a href="#local_ch_277"><span class="LIDENT">ch</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="RBRACE">}</span> <span class="IN">in</span><span class="EOL">
</span>    <a href="#local_f_278"><span class="LIDENT">f</span></a> <a href="#local_da_280"><span class="LIDENT">da</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span id="local_x_281"><span class="LIDENT">x</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="#local_token_279"><span class="LIDENT">token</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <span class="FALSE">false</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_da_280"><span class="LIDENT">da</span></a><span class="DOT">.</span><span class="LIDENT">da_max</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;&gt;)"><span class="INFIXOP0">&lt;&gt;</span></a> <a href="#local_ch_277"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">max</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <a href="#local_da_280"><span class="LIDENT">da</span></a><span class="DOT">.</span><span class="LIDENT">da_ptr</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;)"><span class="LESS">&lt;</span></a> <a href="#local_ch_277"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <a href="#local_da_280"><span class="LIDENT">da</span></a><span class="DOT">.</span><span class="LIDENT">da_ptr</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <a href="#local_ch_277"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">max</span> <span class="THEN">then</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <span class="LPAREN">(</span><span class="UIDENT">Failure</span> <span class="STRING">&quot;Lwt_io.direct_access: invalid result of [f]&quot;</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="ELSE">else</span> <span class="BEGIN">begin</span><span class="EOL">
</span>      <a href="#local_ch_277"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_da_280"><span class="LIDENT">da</span></a><span class="DOT">.</span><span class="LIDENT">da_ptr</span><span class="SEMI">;</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <a href="#local_x_281"><span class="LIDENT">x</span></a><span class="EOL">
</span>    <span class="END">end</span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Primitives.module-MakeNumberIO"><span class="MODULE">module</span> <span class="UIDENT">MakeNumberIO</span> <span class="LPAREN">(</span><span class="UIDENT">Endian</span> <span class="COLON">:</span> <a href="../../../ocplib-endian/src/ocplib-endian.bigstring/endianBigstring.ml.html#module-type-EndianBigstringSig"><span class="UIDENT">EndianBigstring</span><span class="DOT">.</span><span class="UIDENT">EndianBigstringSig</span></a><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="STRUCT">struct</span><span class="EOL">
</span>    <span class="COMMENT">(* +-------------------------------------------------------------+
       | Reading numbers                                             |
       +-------------------------------------------------------------+ *)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="module-Primitives.module-MakeNumberIO.val-read_int"><span class="LIDENT">read_int</span></span> <span id="local_ic_282"><span class="LIDENT">ic</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LIDENT">read_block_unsafe</span> <a href="#local_ic_282"><span class="LIDENT">ic</span></a> <span class="INT">4</span><span class="EOL">
</span>        <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_buffer_283"><span class="LIDENT">buffer</span></span> <span id="local_ptr_284"><span class="LIDENT">ptr</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/int32.ml.html#val-to_int"><span class="UIDENT">Int32</span><span class="DOT">.</span><span class="LIDENT">to_int</span></a> <span class="LPAREN">(</span><span class="UIDENT">Endian</span><span class="DOT">.</span><span class="LIDENT">get_int32</span> <a href="#local_buffer_283"><span class="LIDENT">buffer</span></a> <a href="#local_ptr_284"><span class="LIDENT">ptr</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="module-Primitives.module-MakeNumberIO.val-read_int16"><span class="LIDENT">read_int16</span></span> <span id="local_ic_285"><span class="LIDENT">ic</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LIDENT">read_block_unsafe</span> <a href="#local_ic_285"><span class="LIDENT">ic</span></a> <span class="INT">2</span><span class="EOL">
</span>        <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_buffer_286"><span class="LIDENT">buffer</span></span> <span id="local_ptr_287"><span class="LIDENT">ptr</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <span class="LPAREN">(</span><span class="UIDENT">Endian</span><span class="DOT">.</span><span class="LIDENT">get_int16</span> <a href="#local_buffer_286"><span class="LIDENT">buffer</span></a> <a href="#local_ptr_287"><span class="LIDENT">ptr</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="module-Primitives.module-MakeNumberIO.val-read_int32"><span class="LIDENT">read_int32</span></span> <span id="local_ic_288"><span class="LIDENT">ic</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LIDENT">read_block_unsafe</span> <a href="#local_ic_288"><span class="LIDENT">ic</span></a> <span class="INT">4</span><span class="EOL">
</span>        <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_buffer_289"><span class="LIDENT">buffer</span></span> <span id="local_ptr_290"><span class="LIDENT">ptr</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <span class="LPAREN">(</span><span class="UIDENT">Endian</span><span class="DOT">.</span><span class="LIDENT">get_int32</span> <a href="#local_buffer_289"><span class="LIDENT">buffer</span></a> <a href="#local_ptr_290"><span class="LIDENT">ptr</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="module-Primitives.module-MakeNumberIO.val-read_int64"><span class="LIDENT">read_int64</span></span> <span id="local_ic_291"><span class="LIDENT">ic</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LIDENT">read_block_unsafe</span> <a href="#local_ic_291"><span class="LIDENT">ic</span></a> <span class="INT">8</span><span class="EOL">
</span>        <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_buffer_292"><span class="LIDENT">buffer</span></span> <span id="local_ptr_293"><span class="LIDENT">ptr</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <span class="LPAREN">(</span><span class="UIDENT">Endian</span><span class="DOT">.</span><span class="LIDENT">get_int64</span> <a href="#local_buffer_292"><span class="LIDENT">buffer</span></a> <a href="#local_ptr_293"><span class="LIDENT">ptr</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="module-Primitives.module-MakeNumberIO.val-read_float32"><span class="LIDENT">read_float32</span></span> <span id="local_ic_294"><span class="LIDENT">ic</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LIDENT">read_int32</span> <a href="#local_ic_294"><span class="LIDENT">ic</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span id="local_x_295"><span class="LIDENT">x</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/int32.ml.html#val-float_of_bits"><span class="UIDENT">Int32</span><span class="DOT">.</span><span class="LIDENT">float_of_bits</span></a> <a href="#local_x_295"><span class="LIDENT">x</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="module-Primitives.module-MakeNumberIO.val-read_float64"><span class="LIDENT">read_float64</span></span> <span id="local_ic_296"><span class="LIDENT">ic</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LIDENT">read_int64</span> <a href="#local_ic_296"><span class="LIDENT">ic</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span id="local_x_297"><span class="LIDENT">x</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/int64.ml.html#val-float_of_bits"><span class="UIDENT">Int64</span><span class="DOT">.</span><span class="LIDENT">float_of_bits</span></a> <a href="#local_x_297"><span class="LIDENT">x</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="COMMENT">(* +-------------------------------------------------------------+
       | Writing numbers                                             |
       +-------------------------------------------------------------+ *)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="module-Primitives.module-MakeNumberIO.val-write_int"><span class="LIDENT">write_int</span></span> <span id="local_oc_298"><span class="LIDENT">oc</span></span> <span id="local_v_299"><span class="LIDENT">v</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LIDENT">write_block_unsafe</span> <a href="#local_oc_298"><span class="LIDENT">oc</span></a> <span class="INT">4</span><span class="EOL">
</span>        <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_buffer_300"><span class="LIDENT">buffer</span></span> <span id="local_ptr_301"><span class="LIDENT">ptr</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="UIDENT">Endian</span><span class="DOT">.</span><span class="LIDENT">set_int32</span> <a href="#local_buffer_300"><span class="LIDENT">buffer</span></a> <a href="#local_ptr_301"><span class="LIDENT">ptr</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/int32.ml.html#val-of_int"><span class="UIDENT">Int32</span><span class="DOT">.</span><span class="LIDENT">of_int</span></a> <a href="#local_v_299"><span class="LIDENT">v</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>          <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="module-Primitives.module-MakeNumberIO.val-write_int16"><span class="LIDENT">write_int16</span></span> <span id="local_oc_302"><span class="LIDENT">oc</span></span> <span id="local_v_303"><span class="LIDENT">v</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LIDENT">write_block_unsafe</span> <a href="#local_oc_302"><span class="LIDENT">oc</span></a> <span class="INT">2</span><span class="EOL">
</span>        <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_buffer_304"><span class="LIDENT">buffer</span></span> <span id="local_ptr_305"><span class="LIDENT">ptr</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="UIDENT">Endian</span><span class="DOT">.</span><span class="LIDENT">set_int16</span> <a href="#local_buffer_304"><span class="LIDENT">buffer</span></a> <a href="#local_ptr_305"><span class="LIDENT">ptr</span></a> <a href="#local_v_303"><span class="LIDENT">v</span></a><span class="SEMI">;</span><span class="EOL">
</span>          <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="module-Primitives.module-MakeNumberIO.val-write_int32"><span class="LIDENT">write_int32</span></span> <span id="local_oc_306"><span class="LIDENT">oc</span></span> <span id="local_v_307"><span class="LIDENT">v</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LIDENT">write_block_unsafe</span> <a href="#local_oc_306"><span class="LIDENT">oc</span></a> <span class="INT">4</span><span class="EOL">
</span>        <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_buffer_308"><span class="LIDENT">buffer</span></span> <span id="local_ptr_309"><span class="LIDENT">ptr</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="UIDENT">Endian</span><span class="DOT">.</span><span class="LIDENT">set_int32</span> <a href="#local_buffer_308"><span class="LIDENT">buffer</span></a> <a href="#local_ptr_309"><span class="LIDENT">ptr</span></a> <a href="#local_v_307"><span class="LIDENT">v</span></a><span class="SEMI">;</span><span class="EOL">
</span>          <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="module-Primitives.module-MakeNumberIO.val-write_int64"><span class="LIDENT">write_int64</span></span> <span id="local_oc_310"><span class="LIDENT">oc</span></span> <span id="local_v_311"><span class="LIDENT">v</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LIDENT">write_block_unsafe</span> <a href="#local_oc_310"><span class="LIDENT">oc</span></a> <span class="INT">8</span><span class="EOL">
</span>        <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_buffer_312"><span class="LIDENT">buffer</span></span> <span id="local_ptr_313"><span class="LIDENT">ptr</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="UIDENT">Endian</span><span class="DOT">.</span><span class="LIDENT">set_int64</span> <a href="#local_buffer_312"><span class="LIDENT">buffer</span></a> <a href="#local_ptr_313"><span class="LIDENT">ptr</span></a> <a href="#local_v_311"><span class="LIDENT">v</span></a><span class="SEMI">;</span><span class="EOL">
</span>          <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="module-Primitives.module-MakeNumberIO.val-write_float32"><span class="LIDENT">write_float32</span></span> <span id="local_oc_314"><span class="LIDENT">oc</span></span> <span id="local_v_315"><span class="LIDENT">v</span></span> <span class="EQUAL">=</span> <span class="LIDENT">write_int32</span> <a href="#local_oc_314"><span class="LIDENT">oc</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/int32.ml.html#val-bits_of_float"><span class="UIDENT">Int32</span><span class="DOT">.</span><span class="LIDENT">bits_of_float</span></a> <a href="#local_v_315"><span class="LIDENT">v</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="module-Primitives.module-MakeNumberIO.val-write_float64"><span class="LIDENT">write_float64</span></span> <span id="local_oc_316"><span class="LIDENT">oc</span></span> <span id="local_v_317"><span class="LIDENT">v</span></span> <span class="EQUAL">=</span> <span class="LIDENT">write_int64</span> <a href="#local_oc_316"><span class="LIDENT">oc</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/int64.ml.html#val-bits_of_float"><span class="UIDENT">Int64</span><span class="DOT">.</span><span class="LIDENT">bits_of_float</span></a> <a href="#local_v_317"><span class="LIDENT">v</span></a><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="END">end</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* +---------------------------------------------------------------+
     | Random access                                                 |
     +---------------------------------------------------------------+ *)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Primitives.val-do_seek"><span class="LIDENT">do_seek</span></span> <span id="local_fun_name_318"><span class="LIDENT">fun_name</span></span> <span id="local_seek_319"><span class="LIDENT">seek</span></span> <span id="local_pos_320"><span class="LIDENT">pos</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <a href="#local_seek_319"><span class="LIDENT">seek</span></a> <a href="#local_pos_320"><span class="LIDENT">pos</span></a> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">SEEK_SET</span> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span id="local_offset_321"><span class="LIDENT">offset</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_offset_321"><span class="LIDENT">offset</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;&gt;)"><span class="INFIXOP0">&lt;&gt;</span></a> <a href="#local_pos_320"><span class="LIDENT">pos</span></a> <span class="THEN">then</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <span class="LPAREN">(</span><span class="UIDENT">Failure</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/printf.ml.html#val-sprintf"><span class="UIDENT">Printf</span><span class="DOT">.</span><span class="LIDENT">sprintf</span></a> <span class="STRING">&quot;Lwt_io.%s: seek failed&quot;</span> <a href="#local_fun_name_318"><span class="LIDENT">fun_name</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="ELSE">else</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Primitives.val-set_position"><span class="LIDENT">set_position</span></span> <span class="COLON">:</span><span class="EOL">
</span>      <span class="TYPE">type</span> <span class="LIDENT">m</span><span class="DOT">.</span><span class="EOL">
</span>      <span class="LIDENT">m</span> <span class="LIDENT">_channel</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">int64</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <a href="../lwt/lwt.ml.html#module-Public_types.type-t"><span class="LIDENT">unit</span> <span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">t</span></a> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="FUN">fun</span> <span id="local_ch_322"><span class="LIDENT">ch</span></span> <span id="local_pos_323"><span class="LIDENT">pos</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_ch_322"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">typ</span><span class="COMMA">,</span> <a href="#local_ch_322"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">mode</span> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Type_normal</span><span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span id="local_seek_324"><span class="LIDENT">seek</span></span><span class="RPAREN">)</span><span class="COMMA">,</span> <span class="UIDENT">Output</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">flush_total</span> <a href="#local_ch_322"><span class="LIDENT">ch</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">do_seek</span> <span class="STRING">&quot;set_position&quot;</span> <a href="#local_seek_324"><span class="LIDENT">seek</span></a> <a href="#local_pos_323"><span class="LIDENT">pos</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="#local_ch_322"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">offset</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_pos_323"><span class="LIDENT">pos</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Type_normal</span><span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span id="local_seek_325"><span class="LIDENT">seek</span></span><span class="RPAREN">)</span><span class="COMMA">,</span> <span class="UIDENT">Input</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_current_326"><span class="LIDENT">current</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/int64.ml.html#val-sub"><span class="UIDENT">Int64</span><span class="DOT">.</span><span class="LIDENT">sub</span></a> <a href="#local_ch_322"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">offset</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/int64.ml.html#val-of_int"><span class="UIDENT">Int64</span><span class="DOT">.</span><span class="LIDENT">of_int</span></a> <span class="LPAREN">(</span><a href="#local_ch_322"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">max</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <a href="#local_ch_322"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span><span class="RPAREN">)</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>      <span class="IF">if</span> <a href="#local_pos_323"><span class="LIDENT">pos</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;=)"><span class="INFIXOP0">&gt;=</span></a> <a href="#local_current_326"><span class="LIDENT">current</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&amp;&amp;)"><span class="AMPERAMPER">&amp;&amp;</span></a> <a href="#local_pos_323"><span class="LIDENT">pos</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;=)"><span class="INFIXOP0">&lt;=</span></a> <a href="#local_ch_322"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">offset</span> <span class="THEN">then</span> <span class="BEGIN">begin</span><span class="EOL">
</span>        <a href="#local_ch_322"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_ch_322"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">max</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/int64.ml.html#val-to_int"><span class="UIDENT">Int64</span><span class="DOT">.</span><span class="LIDENT">to_int</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/int64.ml.html#val-sub"><span class="UIDENT">Int64</span><span class="DOT">.</span><span class="LIDENT">sub</span></a> <a href="#local_ch_322"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">offset</span> <a href="#local_pos_323"><span class="LIDENT">pos</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>        <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="EOL">
</span>      <span class="END">end</span> <span class="ELSE">else</span> <span class="BEGIN">begin</span><span class="EOL">
</span>        <span class="LIDENT">do_seek</span> <span class="STRING">&quot;set_position&quot;</span> <a href="#local_seek_325"><span class="LIDENT">seek</span></a> <a href="#local_pos_323"><span class="LIDENT">pos</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <a href="#local_ch_322"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">offset</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_pos_323"><span class="LIDENT">pos</span></a><span class="SEMI">;</span><span class="EOL">
</span>        <a href="#local_ch_322"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <span class="LESSMINUS">&lt;-</span> <span class="INT">0</span><span class="SEMI">;</span><span class="EOL">
</span>        <a href="#local_ch_322"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">max</span> <span class="LESSMINUS">&lt;-</span> <span class="INT">0</span><span class="SEMI">;</span><span class="EOL">
</span>        <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="EOL">
</span>      <span class="END">end</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Type_bytes</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="IF">if</span> <a href="#local_pos_323"><span class="LIDENT">pos</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;)"><span class="LESS">&lt;</span></a> <span class="INT">0L</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <a href="#local_pos_323"><span class="LIDENT">pos</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/int64.ml.html#val-of_int"><span class="UIDENT">Int64</span><span class="DOT">.</span><span class="LIDENT">of_int</span></a> <a href="#local_ch_322"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">length</span> <span class="THEN">then</span><span class="EOL">
</span>        <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <span class="LPAREN">(</span><span class="UIDENT">Failure</span> <span class="STRING">&quot;Lwt_io.set_position: out of bounds&quot;</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="ELSE">else</span> <span class="BEGIN">begin</span><span class="EOL">
</span>        <a href="#local_ch_322"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <span class="LESSMINUS">&lt;-</span> <a href="../../../ocaml-base-compiler/src/stdlib/int64.ml.html#val-to_int"><span class="UIDENT">Int64</span><span class="DOT">.</span><span class="LIDENT">to_int</span></a> <a href="#local_pos_323"><span class="LIDENT">pos</span></a><span class="SEMI">;</span><span class="EOL">
</span>        <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="EOL">
</span>      <span class="END">end</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Primitives.val-length"><span class="LIDENT">length</span></span> <span id="local_ch_327"><span class="LIDENT">ch</span></span> <span class="EQUAL">=</span> <span class="MATCH">match</span> <a href="#local_ch_327"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">typ</span> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Type_normal</span><span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span id="local_seek_328"><span class="LIDENT">seek</span></span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="#local_seek_328"><span class="LIDENT">seek</span></a> <span class="INT">0L</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">SEEK_END</span> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span id="local_len_329"><span class="LIDENT">len</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">do_seek</span> <span class="STRING">&quot;length&quot;</span> <a href="#local_seek_328"><span class="LIDENT">seek</span></a> <a href="#local_ch_327"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">offset</span> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <a href="#local_len_329"><span class="LIDENT">len</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Type_bytes</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/int64.ml.html#val-of_int"><span class="UIDENT">Int64</span><span class="DOT">.</span><span class="LIDENT">of_int</span></a> <a href="#local_ch_327"><span class="LIDENT">ch</span></a><span class="DOT">.</span><span class="LIDENT">length</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="END">end</span></span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* +-----------------------------------------------------------------+
   | Primitive operations                                            |
   +-----------------------------------------------------------------+ *)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-read_char"><span class="LIDENT">read_char</span></span> <span id="local_wrapper_330"><span class="LIDENT">wrapper</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_channel_331"><span class="LIDENT">channel</span></span> <span class="EQUAL">=</span> <a href="#local_wrapper_330"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">channel</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_ptr_332"><span class="LIDENT">ptr</span></span> <span class="EQUAL">=</span> <a href="#local_channel_331"><span class="LIDENT">channel</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="COMMENT">(* Speed-up in case a character is available in the buffer. It
     increases performances by 10x. *)</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="#local_wrapper_330"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="UIDENT">Idle</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&amp;&amp;)"><span class="AMPERAMPER">&amp;&amp;</span></a> <a href="#local_ptr_332"><span class="LIDENT">ptr</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;)"><span class="LESS">&lt;</span></a> <a href="#local_channel_331"><span class="LIDENT">channel</span></a><span class="DOT">.</span><span class="LIDENT">max</span> <span class="THEN">then</span> <span class="BEGIN">begin</span><span class="EOL">
</span>    <a href="#local_channel_331"><span class="LIDENT">channel</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_ptr_332"><span class="LIDENT">ptr</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <span class="INT">1</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <span class="LPAREN">(</span><a href="lwt_bytes.ml.html#val-unsafe_get"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">unsafe_get</span></a> <a href="#local_channel_331"><span class="LIDENT">channel</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <a href="#local_ptr_332"><span class="LIDENT">ptr</span></a><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="END">end</span> <span class="ELSE">else</span><span class="EOL">
</span>    <span class="LIDENT">primitive</span> <span class="UIDENT">Primitives</span><span class="DOT">.</span><span class="LIDENT">read_char</span> <a href="#local_wrapper_330"><span class="LIDENT">wrapper</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-read_char_opt"><span class="LIDENT">read_char_opt</span></span> <span id="local_wrapper_333"><span class="LIDENT">wrapper</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_channel_334"><span class="LIDENT">channel</span></span> <span class="EQUAL">=</span> <a href="#local_wrapper_333"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">channel</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_ptr_335"><span class="LIDENT">ptr</span></span> <span class="EQUAL">=</span> <a href="#local_channel_334"><span class="LIDENT">channel</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="#local_wrapper_333"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="UIDENT">Idle</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&amp;&amp;)"><span class="AMPERAMPER">&amp;&amp;</span></a> <a href="#local_ptr_335"><span class="LIDENT">ptr</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;)"><span class="LESS">&lt;</span></a> <a href="#local_channel_334"><span class="LIDENT">channel</span></a><span class="DOT">.</span><span class="LIDENT">max</span> <span class="THEN">then</span> <span class="BEGIN">begin</span><span class="EOL">
</span>    <a href="#local_channel_334"><span class="LIDENT">channel</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_ptr_335"><span class="LIDENT">ptr</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <span class="INT">1</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <span class="LPAREN">(</span><span class="UIDENT">Some</span><span class="LPAREN">(</span><a href="lwt_bytes.ml.html#val-unsafe_get"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">unsafe_get</span></a> <a href="#local_channel_334"><span class="LIDENT">channel</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <a href="#local_ptr_335"><span class="LIDENT">ptr</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="END">end</span> <span class="ELSE">else</span><span class="EOL">
</span>    <span class="LIDENT">primitive</span> <span class="UIDENT">Primitives</span><span class="DOT">.</span><span class="LIDENT">read_char_opt</span> <a href="#local_wrapper_333"><span class="LIDENT">wrapper</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-read_line"><span class="LIDENT">read_line</span></span> <span id="local_ic_336"><span class="LIDENT">ic</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">primitive</span> <span class="UIDENT">Primitives</span><span class="DOT">.</span><span class="LIDENT">read_line</span> <a href="#local_ic_336"><span class="LIDENT">ic</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-read_line_opt"><span class="LIDENT">read_line_opt</span></span> <span id="local_ic_337"><span class="LIDENT">ic</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">primitive</span> <span class="UIDENT">Primitives</span><span class="DOT">.</span><span class="LIDENT">read_line_opt</span> <a href="#local_ic_337"><span class="LIDENT">ic</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-read"><span class="LIDENT">read</span></span> <span class="QUESTION">?</span><span id="local_count_338"><span class="LIDENT">count</span></span> <span id="local_ic_339"><span class="LIDENT">ic</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">primitive</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_ic_340"><span class="LIDENT">ic</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Primitives</span><span class="DOT">.</span><span class="LIDENT">read</span> <a href="#local_count_338"><span class="LIDENT">count</span></a> <a href="#local_ic_340"><span class="LIDENT">ic</span></a><span class="RPAREN">)</span> <a href="#local_ic_339"><span class="LIDENT">ic</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-read_into"><span class="LIDENT">read_into</span></span> <span id="local_ic_341"><span class="LIDENT">ic</span></span> <span id="local_str_342"><span class="LIDENT">str</span></span> <span id="local_ofs_343"><span class="LIDENT">ofs</span></span> <span id="local_len_344"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">primitive</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_ic_345"><span class="LIDENT">ic</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Primitives</span><span class="DOT">.</span><span class="LIDENT">read_into</span> <a href="#local_ic_345"><span class="LIDENT">ic</span></a> <a href="#local_str_342"><span class="LIDENT">str</span></a> <a href="#local_ofs_343"><span class="LIDENT">ofs</span></a> <a href="#local_len_344"><span class="LIDENT">len</span></a><span class="RPAREN">)</span> <a href="#local_ic_341"><span class="LIDENT">ic</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-read_into_exactly"><span class="LIDENT">read_into_exactly</span></span> <span id="local_ic_346"><span class="LIDENT">ic</span></span> <span id="local_str_347"><span class="LIDENT">str</span></span> <span id="local_ofs_348"><span class="LIDENT">ofs</span></span> <span id="local_len_349"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">primitive</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_ic_350"><span class="LIDENT">ic</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Primitives</span><span class="DOT">.</span><span class="LIDENT">read_into_exactly</span> <a href="#local_ic_350"><span class="LIDENT">ic</span></a> <a href="#local_str_347"><span class="LIDENT">str</span></a> <a href="#local_ofs_348"><span class="LIDENT">ofs</span></a> <a href="#local_len_349"><span class="LIDENT">len</span></a><span class="RPAREN">)</span> <a href="#local_ic_346"><span class="LIDENT">ic</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-read_into_bigstring"><span class="LIDENT">read_into_bigstring</span></span> <span id="local_ic_351"><span class="LIDENT">ic</span></span> <span id="local_bytes_352"><span class="LIDENT">bytes</span></span> <span id="local_ofs_353"><span class="LIDENT">ofs</span></span> <span id="local_len_354"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">primitive</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_ic_355"><span class="LIDENT">ic</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Primitives</span><span class="DOT">.</span><span class="LIDENT">read_into_bigstring</span> <a href="#local_ic_355"><span class="LIDENT">ic</span></a> <a href="#local_bytes_352"><span class="LIDENT">bytes</span></a> <a href="#local_ofs_353"><span class="LIDENT">ofs</span></a> <a href="#local_len_354"><span class="LIDENT">len</span></a><span class="RPAREN">)</span> <a href="#local_ic_351"><span class="LIDENT">ic</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-read_into_exactly_bigstring"><span class="LIDENT">read_into_exactly_bigstring</span></span> <span id="local_ic_356"><span class="LIDENT">ic</span></span> <span id="local_bytes_357"><span class="LIDENT">bytes</span></span> <span id="local_ofs_358"><span class="LIDENT">ofs</span></span> <span id="local_len_359"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">primitive</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_ic_360"><span class="LIDENT">ic</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Primitives</span><span class="DOT">.</span><span class="LIDENT">read_into_exactly_bigstring</span> <a href="#local_ic_360"><span class="LIDENT">ic</span></a> <a href="#local_bytes_357"><span class="LIDENT">bytes</span></a> <a href="#local_ofs_358"><span class="LIDENT">ofs</span></a> <a href="#local_len_359"><span class="LIDENT">len</span></a><span class="RPAREN">)</span> <a href="#local_ic_356"><span class="LIDENT">ic</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-read_value"><span class="LIDENT">read_value</span></span> <span id="local_ic_361"><span class="LIDENT">ic</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">primitive</span> <span class="UIDENT">Primitives</span><span class="DOT">.</span><span class="LIDENT">read_value</span> <a href="#local_ic_361"><span class="LIDENT">ic</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-flush"><span class="LIDENT">flush</span></span> <span id="local_oc_362"><span class="LIDENT">oc</span></span> <span class="EQUAL">=</span> <span class="LIDENT">primitive</span> <span class="UIDENT">Primitives</span><span class="DOT">.</span><span class="LIDENT">flush</span> <a href="#local_oc_362"><span class="LIDENT">oc</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-write_char"><span class="LIDENT">write_char</span></span> <span id="local_wrapper_363"><span class="LIDENT">wrapper</span></span> <span id="local_x_364"><span class="LIDENT">x</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_channel_365"><span class="LIDENT">channel</span></span> <span class="EQUAL">=</span> <a href="#local_wrapper_363"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">channel</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_ptr_366"><span class="LIDENT">ptr</span></span> <span class="EQUAL">=</span> <a href="#local_channel_365"><span class="LIDENT">channel</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="#local_wrapper_363"><span class="LIDENT">wrapper</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="UIDENT">Idle</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&amp;&amp;)"><span class="AMPERAMPER">&amp;&amp;</span></a> <a href="#local_ptr_366"><span class="LIDENT">ptr</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;)"><span class="LESS">&lt;</span></a> <a href="#local_channel_365"><span class="LIDENT">channel</span></a><span class="DOT">.</span><span class="LIDENT">max</span> <span class="THEN">then</span> <span class="BEGIN">begin</span><span class="EOL">
</span>    <a href="#local_channel_365"><span class="LIDENT">channel</span></a><span class="DOT">.</span><span class="LIDENT">ptr</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_ptr_366"><span class="LIDENT">ptr</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <span class="INT">1</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="lwt_bytes.ml.html#val-unsafe_set"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">unsafe_set</span></a> <a href="#local_channel_365"><span class="LIDENT">channel</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <a href="#local_ptr_366"><span class="LIDENT">ptr</span></a> <a href="#local_x_364"><span class="LIDENT">x</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="COMMENT">(* Fast launching of the auto flusher: *)</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-not"><span class="LIDENT">not</span></a> <a href="#local_channel_365"><span class="LIDENT">channel</span></a><span class="DOT">.</span><span class="LIDENT">auto_flushing</span> <span class="THEN">then</span> <span class="BEGIN">begin</span><span class="EOL">
</span>      <a href="#local_channel_365"><span class="LIDENT">channel</span></a><span class="DOT">.</span><span class="LIDENT">auto_flushing</span> <span class="LESSMINUS">&lt;-</span> <span class="TRUE">true</span><span class="SEMI">;</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a> <span class="LPAREN">(</span><span class="LIDENT">auto_flush</span> <a href="#local_channel_365"><span class="LIDENT">channel</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="EOL">
</span>    <span class="END">end</span> <span class="ELSE">else</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="EOL">
</span>  <span class="END">end</span> <span class="ELSE">else</span><span class="EOL">
</span>    <span class="LIDENT">primitive</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_oc_367"><span class="LIDENT">oc</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Primitives</span><span class="DOT">.</span><span class="LIDENT">write_char</span> <a href="#local_oc_367"><span class="LIDENT">oc</span></a> <a href="#local_x_364"><span class="LIDENT">x</span></a><span class="RPAREN">)</span> <a href="#local_wrapper_363"><span class="LIDENT">wrapper</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-write"><span class="LIDENT">write</span></span> <span id="local_oc_368"><span class="LIDENT">oc</span></span> <span id="local_str_369"><span class="LIDENT">str</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">primitive</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_oc_370"><span class="LIDENT">oc</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Primitives</span><span class="DOT">.</span><span class="LIDENT">write</span> <a href="#local_oc_370"><span class="LIDENT">oc</span></a> <a href="#local_str_369"><span class="LIDENT">str</span></a><span class="RPAREN">)</span> <a href="#local_oc_368"><span class="LIDENT">oc</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-write_line"><span class="LIDENT">write_line</span></span> <span id="local_oc_371"><span class="LIDENT">oc</span></span> <span id="local_x_372"><span class="LIDENT">x</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">primitive</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_oc_373"><span class="LIDENT">oc</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Primitives</span><span class="DOT">.</span><span class="LIDENT">write_line</span> <a href="#local_oc_373"><span class="LIDENT">oc</span></a> <a href="#local_x_372"><span class="LIDENT">x</span></a><span class="RPAREN">)</span> <a href="#local_oc_371"><span class="LIDENT">oc</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-write_from"><span class="LIDENT">write_from</span></span> <span id="local_oc_374"><span class="LIDENT">oc</span></span> <span id="local_str_375"><span class="LIDENT">str</span></span> <span id="local_ofs_376"><span class="LIDENT">ofs</span></span> <span id="local_len_377"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">primitive</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_oc_378"><span class="LIDENT">oc</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Primitives</span><span class="DOT">.</span><span class="LIDENT">write_from</span> <a href="#local_oc_378"><span class="LIDENT">oc</span></a> <a href="#local_str_375"><span class="LIDENT">str</span></a> <a href="#local_ofs_376"><span class="LIDENT">ofs</span></a> <a href="#local_len_377"><span class="LIDENT">len</span></a><span class="RPAREN">)</span> <a href="#local_oc_374"><span class="LIDENT">oc</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-write_from_bigstring"><span class="LIDENT">write_from_bigstring</span></span> <span id="local_oc_379"><span class="LIDENT">oc</span></span> <span id="local_bytes_380"><span class="LIDENT">bytes</span></span> <span id="local_ofs_381"><span class="LIDENT">ofs</span></span> <span id="local_len_382"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">primitive</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_oc_383"><span class="LIDENT">oc</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Primitives</span><span class="DOT">.</span><span class="LIDENT">write_from_bigstring</span> <a href="#local_oc_383"><span class="LIDENT">oc</span></a> <a href="#local_bytes_380"><span class="LIDENT">bytes</span></a> <a href="#local_ofs_381"><span class="LIDENT">ofs</span></a> <a href="#local_len_382"><span class="LIDENT">len</span></a><span class="RPAREN">)</span> <a href="#local_oc_379"><span class="LIDENT">oc</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-write_from_string"><span class="LIDENT">write_from_string</span></span> <span id="local_oc_384"><span class="LIDENT">oc</span></span> <span id="local_str_385"><span class="LIDENT">str</span></span> <span id="local_ofs_386"><span class="LIDENT">ofs</span></span> <span id="local_len_387"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">primitive</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_oc_388"><span class="LIDENT">oc</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Primitives</span><span class="DOT">.</span><span class="LIDENT">write_from_string</span> <a href="#local_oc_388"><span class="LIDENT">oc</span></a> <a href="#local_str_385"><span class="LIDENT">str</span></a> <a href="#local_ofs_386"><span class="LIDENT">ofs</span></a> <a href="#local_len_387"><span class="LIDENT">len</span></a><span class="RPAREN">)</span> <a href="#local_oc_384"><span class="LIDENT">oc</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-write_from_exactly"><span class="LIDENT">write_from_exactly</span></span> <span id="local_oc_389"><span class="LIDENT">oc</span></span> <span id="local_str_390"><span class="LIDENT">str</span></span> <span id="local_ofs_391"><span class="LIDENT">ofs</span></span> <span id="local_len_392"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">primitive</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_oc_393"><span class="LIDENT">oc</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Primitives</span><span class="DOT">.</span><span class="LIDENT">write_from_exactly</span> <a href="#local_oc_393"><span class="LIDENT">oc</span></a> <a href="#local_str_390"><span class="LIDENT">str</span></a> <a href="#local_ofs_391"><span class="LIDENT">ofs</span></a> <a href="#local_len_392"><span class="LIDENT">len</span></a><span class="RPAREN">)</span> <a href="#local_oc_389"><span class="LIDENT">oc</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-write_from_exactly_bigstring"><span class="LIDENT">write_from_exactly_bigstring</span></span> <span id="local_oc_394"><span class="LIDENT">oc</span></span> <span id="local_bytes_395"><span class="LIDENT">bytes</span></span> <span id="local_ofs_396"><span class="LIDENT">ofs</span></span> <span id="local_len_397"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">primitive</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_oc_398"><span class="LIDENT">oc</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Primitives</span><span class="DOT">.</span><span class="LIDENT">write_from_exactly_bigstring</span> <a href="#local_oc_398"><span class="LIDENT">oc</span></a> <a href="#local_bytes_395"><span class="LIDENT">bytes</span></a> <a href="#local_ofs_396"><span class="LIDENT">ofs</span></a> <a href="#local_len_397"><span class="LIDENT">len</span></a><span class="RPAREN">)</span> <a href="#local_oc_394"><span class="LIDENT">oc</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-write_from_string_exactly"><span class="LIDENT">write_from_string_exactly</span></span> <span id="local_oc_399"><span class="LIDENT">oc</span></span> <span id="local_str_400"><span class="LIDENT">str</span></span> <span id="local_ofs_401"><span class="LIDENT">ofs</span></span> <span id="local_len_402"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">primitive</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_oc_403"><span class="LIDENT">oc</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Primitives</span><span class="DOT">.</span><span class="LIDENT">write_from_string_exactly</span> <a href="#local_oc_403"><span class="LIDENT">oc</span></a> <a href="#local_str_400"><span class="LIDENT">str</span></a> <a href="#local_ofs_401"><span class="LIDENT">ofs</span></a> <a href="#local_len_402"><span class="LIDENT">len</span></a><span class="RPAREN">)</span> <a href="#local_oc_399"><span class="LIDENT">oc</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-write_value"><span class="LIDENT">write_value</span></span> <span id="local_oc_404"><span class="LIDENT">oc</span></span> <span class="QUESTION">?</span><span id="local_flags_405"><span class="LIDENT">flags</span></span> <span id="local_x_406"><span class="LIDENT">x</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">primitive</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_oc_407"><span class="LIDENT">oc</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Primitives</span><span class="DOT">.</span><span class="LIDENT">write_value</span> <a href="#local_oc_407"><span class="LIDENT">oc</span></a> <span class="QUESTION">?</span><a href="#local_flags_405"><span class="LIDENT">flags</span></a> <a href="#local_x_406"><span class="LIDENT">x</span></a><span class="RPAREN">)</span> <a href="#local_oc_404"><span class="LIDENT">oc</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-block"><span class="LIDENT">block</span></span> <span id="local_ch_408"><span class="LIDENT">ch</span></span> <span id="local_size_409"><span class="LIDENT">size</span></span> <span id="local_f_410"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">primitive</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_ch_411"><span class="LIDENT">ch</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Primitives</span><span class="DOT">.</span><span class="LIDENT">block</span> <a href="#local_ch_411"><span class="LIDENT">ch</span></a> <a href="#local_size_409"><span class="LIDENT">size</span></a> <a href="#local_f_410"><span class="LIDENT">f</span></a><span class="RPAREN">)</span> <a href="#local_ch_408"><span class="LIDENT">ch</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-direct_access"><span class="LIDENT">direct_access</span></span> <span id="local_ch_412"><span class="LIDENT">ch</span></span> <span id="local_f_413"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">primitive</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_ch_414"><span class="LIDENT">ch</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Primitives</span><span class="DOT">.</span><span class="LIDENT">direct_access</span> <a href="#local_ch_414"><span class="LIDENT">ch</span></a> <a href="#local_f_413"><span class="LIDENT">f</span></a><span class="RPAREN">)</span> <a href="#local_ch_412"><span class="LIDENT">ch</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-set_position"><span class="LIDENT">set_position</span></span> <span id="local_ch_415"><span class="LIDENT">ch</span></span> <span id="local_pos_416"><span class="LIDENT">pos</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">primitive</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_ch_417"><span class="LIDENT">ch</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Primitives</span><span class="DOT">.</span><span class="LIDENT">set_position</span> <a href="#local_ch_417"><span class="LIDENT">ch</span></a> <a href="#local_pos_416"><span class="LIDENT">pos</span></a><span class="RPAREN">)</span> <a href="#local_ch_415"><span class="LIDENT">ch</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-length"><span class="LIDENT">length</span></span> <span id="local_ch_418"><span class="LIDENT">ch</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">primitive</span> <span class="UIDENT">Primitives</span><span class="DOT">.</span><span class="LIDENT">length</span> <a href="#local_ch_418"><span class="LIDENT">ch</span></a><span class="EOL">
</span><span class="EOL">
</span><span id="module-type-NumberIO"><span class="MODULE">module</span> <span class="TYPE">type</span> <span class="UIDENT">NumberIO</span> <span class="EQUAL">=</span> <span class="SIG">sig</span><span class="EOL">
</span>  <span id="module-type-NumberIO.val-read_int"><span class="VAL">val</span> <span class="LIDENT">read_int</span> <span class="COLON">:</span> <span class="LIDENT">input_channel</span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Public_types.type-t"><span class="LIDENT">int</span> <span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">t</span></a></span><span class="EOL">
</span>  <span id="module-type-NumberIO.val-read_int16"><span class="VAL">val</span> <span class="LIDENT">read_int16</span> <span class="COLON">:</span> <span class="LIDENT">input_channel</span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Public_types.type-t"><span class="LIDENT">int</span> <span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">t</span></a></span><span class="EOL">
</span>  <span id="module-type-NumberIO.val-read_int32"><span class="VAL">val</span> <span class="LIDENT">read_int32</span> <span class="COLON">:</span> <span class="LIDENT">input_channel</span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Public_types.type-t"><span class="LIDENT">int32</span> <span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">t</span></a></span><span class="EOL">
</span>  <span id="module-type-NumberIO.val-read_int64"><span class="VAL">val</span> <span class="LIDENT">read_int64</span> <span class="COLON">:</span> <span class="LIDENT">input_channel</span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Public_types.type-t"><span class="LIDENT">int64</span> <span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">t</span></a></span><span class="EOL">
</span>  <span id="module-type-NumberIO.val-read_float32"><span class="VAL">val</span> <span class="LIDENT">read_float32</span> <span class="COLON">:</span> <span class="LIDENT">input_channel</span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Public_types.type-t"><span class="LIDENT">float</span> <span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">t</span></a></span><span class="EOL">
</span>  <span id="module-type-NumberIO.val-read_float64"><span class="VAL">val</span> <span class="LIDENT">read_float64</span> <span class="COLON">:</span> <span class="LIDENT">input_channel</span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Public_types.type-t"><span class="LIDENT">float</span> <span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">t</span></a></span><span class="EOL">
</span>  <span id="module-type-NumberIO.val-write_int"><span class="VAL">val</span> <span class="LIDENT">write_int</span> <span class="COLON">:</span> <span class="LIDENT">output_channel</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">int</span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Public_types.type-t"><span class="LIDENT">unit</span> <span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">t</span></a></span><span class="EOL">
</span>  <span id="module-type-NumberIO.val-write_int16"><span class="VAL">val</span> <span class="LIDENT">write_int16</span> <span class="COLON">:</span> <span class="LIDENT">output_channel</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">int</span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Public_types.type-t"><span class="LIDENT">unit</span> <span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">t</span></a></span><span class="EOL">
</span>  <span id="module-type-NumberIO.val-write_int32"><span class="VAL">val</span> <span class="LIDENT">write_int32</span> <span class="COLON">:</span> <span class="LIDENT">output_channel</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">int32</span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Public_types.type-t"><span class="LIDENT">unit</span> <span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">t</span></a></span><span class="EOL">
</span>  <span id="module-type-NumberIO.val-write_int64"><span class="VAL">val</span> <span class="LIDENT">write_int64</span> <span class="COLON">:</span> <span class="LIDENT">output_channel</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">int64</span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Public_types.type-t"><span class="LIDENT">unit</span> <span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">t</span></a></span><span class="EOL">
</span>  <span id="module-type-NumberIO.val-write_float32"><span class="VAL">val</span> <span class="LIDENT">write_float32</span> <span class="COLON">:</span> <span class="LIDENT">output_channel</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">float</span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Public_types.type-t"><span class="LIDENT">unit</span> <span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">t</span></a></span><span class="EOL">
</span>  <span id="module-type-NumberIO.val-write_float64"><span class="VAL">val</span> <span class="LIDENT">write_float64</span> <span class="COLON">:</span> <span class="LIDENT">output_channel</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">float</span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Public_types.type-t"><span class="LIDENT">unit</span> <span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">t</span></a></span><span class="EOL">
</span><span class="END">end</span></span><span class="EOL">
</span><span class="EOL">
</span><span id="module-MakeNumberIO"><span class="MODULE">module</span> <span class="UIDENT">MakeNumberIO</span> <span class="LPAREN">(</span><span class="UIDENT">Endian</span> <span class="COLON">:</span> <a href="../../../ocplib-endian/src/ocplib-endian.bigstring/endianBigstring.ml.html#module-type-EndianBigstringSig"><span class="UIDENT">EndianBigstring</span><span class="DOT">.</span><span class="UIDENT">EndianBigstringSig</span></a><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span><span class="STRUCT">struct</span><span class="EOL">
</span>  <span id="module-MakeNumberIO.module-Primitives"><span class="MODULE">module</span> <span class="UIDENT">Primitives</span> <span class="EQUAL">=</span> <span class="UIDENT">Primitives</span><span class="DOT">.</span><span class="UIDENT">MakeNumberIO</span> <span class="LPAREN">(</span><span class="UIDENT">Endian</span><span class="RPAREN">)</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-MakeNumberIO.val-read_int"><span class="LIDENT">read_int</span></span> <span id="local_ic_419"><span class="LIDENT">ic</span></span> <span class="EQUAL">=</span> <span class="LIDENT">primitive</span> <span class="UIDENT">Primitives</span><span class="DOT">.</span><span class="LIDENT">read_int</span> <a href="#local_ic_419"><span class="LIDENT">ic</span></a><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-MakeNumberIO.val-read_int16"><span class="LIDENT">read_int16</span></span> <span id="local_ic_420"><span class="LIDENT">ic</span></span> <span class="EQUAL">=</span> <span class="LIDENT">primitive</span> <span class="UIDENT">Primitives</span><span class="DOT">.</span><span class="LIDENT">read_int16</span> <a href="#local_ic_420"><span class="LIDENT">ic</span></a><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-MakeNumberIO.val-read_int32"><span class="LIDENT">read_int32</span></span> <span id="local_ic_421"><span class="LIDENT">ic</span></span> <span class="EQUAL">=</span> <span class="LIDENT">primitive</span> <span class="UIDENT">Primitives</span><span class="DOT">.</span><span class="LIDENT">read_int32</span> <a href="#local_ic_421"><span class="LIDENT">ic</span></a><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-MakeNumberIO.val-read_int64"><span class="LIDENT">read_int64</span></span> <span id="local_ic_422"><span class="LIDENT">ic</span></span> <span class="EQUAL">=</span> <span class="LIDENT">primitive</span> <span class="UIDENT">Primitives</span><span class="DOT">.</span><span class="LIDENT">read_int64</span> <a href="#local_ic_422"><span class="LIDENT">ic</span></a><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-MakeNumberIO.val-read_float32"><span class="LIDENT">read_float32</span></span> <span id="local_ic_423"><span class="LIDENT">ic</span></span> <span class="EQUAL">=</span> <span class="LIDENT">primitive</span> <span class="UIDENT">Primitives</span><span class="DOT">.</span><span class="LIDENT">read_float32</span> <a href="#local_ic_423"><span class="LIDENT">ic</span></a><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-MakeNumberIO.val-read_float64"><span class="LIDENT">read_float64</span></span> <span id="local_ic_424"><span class="LIDENT">ic</span></span> <span class="EQUAL">=</span> <span class="LIDENT">primitive</span> <span class="UIDENT">Primitives</span><span class="DOT">.</span><span class="LIDENT">read_float64</span> <a href="#local_ic_424"><span class="LIDENT">ic</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-MakeNumberIO.val-write_int"><span class="LIDENT">write_int</span></span> <span id="local_oc_425"><span class="LIDENT">oc</span></span> <span id="local_x_426"><span class="LIDENT">x</span></span> <span class="EQUAL">=</span> <span class="LIDENT">primitive</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_oc_427"><span class="LIDENT">oc</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Primitives</span><span class="DOT">.</span><span class="LIDENT">write_int</span> <a href="#local_oc_427"><span class="LIDENT">oc</span></a> <a href="#local_x_426"><span class="LIDENT">x</span></a><span class="RPAREN">)</span> <a href="#local_oc_425"><span class="LIDENT">oc</span></a><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-MakeNumberIO.val-write_int16"><span class="LIDENT">write_int16</span></span> <span id="local_oc_428"><span class="LIDENT">oc</span></span> <span id="local_x_429"><span class="LIDENT">x</span></span> <span class="EQUAL">=</span> <span class="LIDENT">primitive</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_oc_430"><span class="LIDENT">oc</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Primitives</span><span class="DOT">.</span><span class="LIDENT">write_int16</span> <a href="#local_oc_430"><span class="LIDENT">oc</span></a> <a href="#local_x_429"><span class="LIDENT">x</span></a><span class="RPAREN">)</span> <a href="#local_oc_428"><span class="LIDENT">oc</span></a><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-MakeNumberIO.val-write_int32"><span class="LIDENT">write_int32</span></span> <span id="local_oc_431"><span class="LIDENT">oc</span></span> <span id="local_x_432"><span class="LIDENT">x</span></span> <span class="EQUAL">=</span> <span class="LIDENT">primitive</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_oc_433"><span class="LIDENT">oc</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Primitives</span><span class="DOT">.</span><span class="LIDENT">write_int32</span> <a href="#local_oc_433"><span class="LIDENT">oc</span></a> <a href="#local_x_432"><span class="LIDENT">x</span></a><span class="RPAREN">)</span> <a href="#local_oc_431"><span class="LIDENT">oc</span></a><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-MakeNumberIO.val-write_int64"><span class="LIDENT">write_int64</span></span> <span id="local_oc_434"><span class="LIDENT">oc</span></span> <span id="local_x_435"><span class="LIDENT">x</span></span> <span class="EQUAL">=</span> <span class="LIDENT">primitive</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_oc_436"><span class="LIDENT">oc</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Primitives</span><span class="DOT">.</span><span class="LIDENT">write_int64</span> <a href="#local_oc_436"><span class="LIDENT">oc</span></a> <a href="#local_x_435"><span class="LIDENT">x</span></a><span class="RPAREN">)</span> <a href="#local_oc_434"><span class="LIDENT">oc</span></a><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-MakeNumberIO.val-write_float32"><span class="LIDENT">write_float32</span></span> <span id="local_oc_437"><span class="LIDENT">oc</span></span> <span id="local_x_438"><span class="LIDENT">x</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">primitive</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_oc_439"><span class="LIDENT">oc</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Primitives</span><span class="DOT">.</span><span class="LIDENT">write_float32</span> <a href="#local_oc_439"><span class="LIDENT">oc</span></a> <a href="#local_x_438"><span class="LIDENT">x</span></a><span class="RPAREN">)</span> <a href="#local_oc_437"><span class="LIDENT">oc</span></a><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-MakeNumberIO.val-write_float64"><span class="LIDENT">write_float64</span></span> <span id="local_oc_440"><span class="LIDENT">oc</span></span> <span id="local_x_441"><span class="LIDENT">x</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">primitive</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_oc_442"><span class="LIDENT">oc</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Primitives</span><span class="DOT">.</span><span class="LIDENT">write_float64</span> <a href="#local_oc_442"><span class="LIDENT">oc</span></a> <a href="#local_x_441"><span class="LIDENT">x</span></a><span class="RPAREN">)</span> <a href="#local_oc_440"><span class="LIDENT">oc</span></a><span class="EOL">
</span><span class="END">end</span></span><span class="EOL">
</span><span class="EOL">
</span><span id="module-LE"><span class="MODULE">module</span> <span class="UIDENT">LE</span> <span class="EQUAL">=</span> <span class="UIDENT">MakeNumberIO</span> <span class="LPAREN">(</span><a href="../../../ocplib-endian/src/ocplib-endian.bigstring/endianBigstring.ml.html#module-LittleEndian_unsafe"><span class="UIDENT">EndianBigstring</span><span class="DOT">.</span><span class="UIDENT">LittleEndian_unsafe</span></a><span class="RPAREN">)</span></span><span class="EOL">
</span><span id="module-BE"><span class="MODULE">module</span> <span class="UIDENT">BE</span> <span class="EQUAL">=</span> <span class="UIDENT">MakeNumberIO</span> <span class="LPAREN">(</span><a href="../../../ocplib-endian/src/ocplib-endian.bigstring/endianBigstring.ml.html#module-BigEndian_unsafe"><span class="UIDENT">EndianBigstring</span><span class="DOT">.</span><span class="UIDENT">BigEndian_unsafe</span></a><span class="RPAREN">)</span></span><span class="EOL">
</span><span class="EOL">
</span><span id="type-byte_order"><span class="TYPE">type</span> <span class="LIDENT">byte_order</span> <span class="EQUAL">=</span> <a href="lwt_sys.ml.html#type-byte_order"><span class="UIDENT">Lwt_sys</span><span class="DOT">.</span><span class="LIDENT">byte_order</span></a> <span class="EQUAL">=</span> <span id="type-byte_order.constructor-Little_endian"><span class="UIDENT">Little_endian</span></span> <span id="type-byte_order.constructor-Big_endian"><span class="BAR">|</span> <span class="UIDENT">Big_endian</span></span></span><span class="EOL">
</span><span class="LET">let</span> <span id="val-system_byte_order"><span class="LIDENT">system_byte_order</span></span> <span class="EQUAL">=</span> <a href="lwt_sys.ml.html#val-byte_order"><span class="UIDENT">Lwt_sys</span><span class="DOT">.</span><span class="LIDENT">byte_order</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="INCLUDE">include</span> <span class="LPAREN">(</span><span class="VAL">val</span> <span class="LPAREN">(</span><span class="MATCH">match</span> <span class="LIDENT">system_byte_order</span> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Little_endian</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="MODULE">module</span> <span class="UIDENT">LE</span> <span class="COLON">:</span> <span class="UIDENT">NumberIO</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Big_endian</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="MODULE">module</span> <span class="UIDENT">BE</span> <span class="COLON">:</span> <span class="UIDENT">NumberIO</span><span class="RPAREN">)</span><span class="RPAREN">)</span> <span class="COLON">:</span> <span class="UIDENT">NumberIO</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* +-----------------------------------------------------------------+
   | Other                                                           |
   +-----------------------------------------------------------------+ *)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-read_chars"><span class="LIDENT">read_chars</span></span> <span id="local_ic_443"><span class="LIDENT">ic</span></span> <span class="EQUAL">=</span> <a href="../lwt/lwt_stream.ml.html#val-from"><span class="UIDENT">Lwt_stream</span><span class="DOT">.</span><span class="LIDENT">from</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">read_char_opt</span> <a href="#local_ic_443"><span class="LIDENT">ic</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-write_chars"><span class="LIDENT">write_chars</span></span> <span id="local_oc_444"><span class="LIDENT">oc</span></span> <span id="local_chars_445"><span class="LIDENT">chars</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="../lwt/lwt_stream.ml.html#val-iter_s"><span class="UIDENT">Lwt_stream</span><span class="DOT">.</span><span class="LIDENT">iter_s</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_char_446"><span class="LIDENT">char</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">write_char</span> <a href="#local_oc_444"><span class="LIDENT">oc</span></a> <a href="#local_char_446"><span class="LIDENT">char</span></a><span class="RPAREN">)</span> <a href="#local_chars_445"><span class="LIDENT">chars</span></a><span class="EOL">
</span><span class="LET">let</span> <span id="val-read_lines"><span class="LIDENT">read_lines</span></span> <span id="local_ic_447"><span class="LIDENT">ic</span></span> <span class="EQUAL">=</span> <a href="../lwt/lwt_stream.ml.html#val-from"><span class="UIDENT">Lwt_stream</span><span class="DOT">.</span><span class="LIDENT">from</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">read_line_opt</span> <a href="#local_ic_447"><span class="LIDENT">ic</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-write_lines"><span class="LIDENT">write_lines</span></span> <span id="local_oc_448"><span class="LIDENT">oc</span></span> <span id="local_lines_449"><span class="LIDENT">lines</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="../lwt/lwt_stream.ml.html#val-iter_s"><span class="UIDENT">Lwt_stream</span><span class="DOT">.</span><span class="LIDENT">iter_s</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_line_450"><span class="LIDENT">line</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">write_line</span> <a href="#local_oc_448"><span class="LIDENT">oc</span></a> <a href="#local_line_450"><span class="LIDENT">line</span></a><span class="RPAREN">)</span> <a href="#local_lines_449"><span class="LIDENT">lines</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-zero"><span class="LIDENT">zero</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">make</span><span class="EOL">
</span>    <span class="LABEL">~mode:</span><span class="LIDENT">input</span><span class="EOL">
</span>    <span class="LABEL">~buffer:</span><span class="LPAREN">(</span><a href="lwt_bytes.ml.html#val-create"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">create</span></a> <span class="LIDENT">min_buffer_size</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_str_451"><span class="LIDENT">str</span></span> <span id="local_ofs_452"><span class="LIDENT">ofs</span></span> <span id="local_len_453"><span class="LIDENT">len</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="lwt_bytes.ml.html#val-fill"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">fill</span></a> <a href="#local_str_451"><span class="LIDENT">str</span></a> <a href="#local_ofs_452"><span class="LIDENT">ofs</span></a> <a href="#local_len_453"><span class="LIDENT">len</span></a> <span class="CHAR">'\x00'</span><span class="SEMI">;</span> <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <a href="#local_len_453"><span class="LIDENT">len</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-null"><span class="LIDENT">null</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">make</span><span class="EOL">
</span>    <span class="LABEL">~mode:</span><span class="LIDENT">output</span><span class="EOL">
</span>    <span class="LABEL">~buffer:</span><span class="LPAREN">(</span><a href="lwt_bytes.ml.html#val-create"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">create</span></a> <span class="LIDENT">min_buffer_size</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local__str_454"><span class="LIDENT">_str</span></span> <span id="local__ofs_455"><span class="LIDENT">_ofs</span></span> <span id="local_len_456"><span class="LIDENT">len</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <a href="#local_len_456"><span class="LIDENT">len</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* Do not close standard ios on close, otherwise uncaught exceptions
   will not be printed *)</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-stdin"><span class="LIDENT">stdin</span></span> <span class="EQUAL">=</span> <span class="LIDENT">of_fd</span> <span class="LABEL">~mode:</span><span class="LIDENT">input</span> <a href="lwt_unix.ml.html#val-stdin"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">stdin</span></a><span class="EOL">
</span><span class="LET">let</span> <span id="val-stdout"><span class="LIDENT">stdout</span></span> <span class="EQUAL">=</span> <span class="LIDENT">of_fd</span> <span class="LABEL">~mode:</span><span class="LIDENT">output</span> <a href="lwt_unix.ml.html#val-stdout"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">stdout</span></a><span class="EOL">
</span><span class="LET">let</span> <span id="val-stderr"><span class="LIDENT">stderr</span></span> <span class="EQUAL">=</span> <span class="LIDENT">of_fd</span> <span class="LABEL">~mode:</span><span class="LIDENT">output</span> <a href="lwt_unix.ml.html#val-stderr"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">stderr</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-fprint"><span class="LIDENT">fprint</span></span> <span id="local_oc_457"><span class="LIDENT">oc</span></span> <span id="local_txt_458"><span class="LIDENT">txt</span></span> <span class="EQUAL">=</span> <span class="LIDENT">write</span> <a href="#local_oc_457"><span class="LIDENT">oc</span></a> <a href="#local_txt_458"><span class="LIDENT">txt</span></a><span class="EOL">
</span><span class="LET">let</span> <span id="val-fprintl"><span class="LIDENT">fprintl</span></span> <span id="local_oc_459"><span class="LIDENT">oc</span></span> <span id="local_txt_460"><span class="LIDENT">txt</span></span> <span class="EQUAL">=</span> <span class="LIDENT">write_line</span> <a href="#local_oc_459"><span class="LIDENT">oc</span></a> <a href="#local_txt_460"><span class="LIDENT">txt</span></a><span class="EOL">
</span><span class="LET">let</span> <span id="val-fprintf"><span class="LIDENT">fprintf</span></span> <span id="local_oc_461"><span class="LIDENT">oc</span></span> <span id="local_fmt_462"><span class="LIDENT">fmt</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/printf.ml.html#val-ksprintf"><span class="UIDENT">Printf</span><span class="DOT">.</span><span class="LIDENT">ksprintf</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_txt_463"><span class="LIDENT">txt</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">write</span> <a href="#local_oc_461"><span class="LIDENT">oc</span></a> <a href="#local_txt_463"><span class="LIDENT">txt</span></a><span class="RPAREN">)</span> <a href="#local_fmt_462"><span class="LIDENT">fmt</span></a><span class="EOL">
</span><span class="LET">let</span> <span id="val-fprintlf"><span class="LIDENT">fprintlf</span></span> <span id="local_oc_464"><span class="LIDENT">oc</span></span> <span id="local_fmt_465"><span class="LIDENT">fmt</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/printf.ml.html#val-ksprintf"><span class="UIDENT">Printf</span><span class="DOT">.</span><span class="LIDENT">ksprintf</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_txt_466"><span class="LIDENT">txt</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">write_line</span> <a href="#local_oc_464"><span class="LIDENT">oc</span></a> <a href="#local_txt_466"><span class="LIDENT">txt</span></a><span class="RPAREN">)</span> <a href="#local_fmt_465"><span class="LIDENT">fmt</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-print"><span class="LIDENT">print</span></span> <span id="local_txt_467"><span class="LIDENT">txt</span></span> <span class="EQUAL">=</span> <span class="LIDENT">write</span> <span class="LIDENT">stdout</span> <a href="#local_txt_467"><span class="LIDENT">txt</span></a><span class="EOL">
</span><span class="LET">let</span> <span id="val-printl"><span class="LIDENT">printl</span></span> <span id="local_txt_468"><span class="LIDENT">txt</span></span> <span class="EQUAL">=</span> <span class="LIDENT">write_line</span> <span class="LIDENT">stdout</span> <a href="#local_txt_468"><span class="LIDENT">txt</span></a><span class="EOL">
</span><span class="LET">let</span> <span id="val-printf"><span class="LIDENT">printf</span></span> <span id="local_fmt_469"><span class="LIDENT">fmt</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/printf.ml.html#val-ksprintf"><span class="UIDENT">Printf</span><span class="DOT">.</span><span class="LIDENT">ksprintf</span></a> <span class="LIDENT">print</span> <a href="#local_fmt_469"><span class="LIDENT">fmt</span></a><span class="EOL">
</span><span class="LET">let</span> <span id="val-printlf"><span class="LIDENT">printlf</span></span> <span id="local_fmt_470"><span class="LIDENT">fmt</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/printf.ml.html#val-ksprintf"><span class="UIDENT">Printf</span><span class="DOT">.</span><span class="LIDENT">ksprintf</span></a> <span class="LIDENT">printl</span> <a href="#local_fmt_470"><span class="LIDENT">fmt</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-eprint"><span class="LIDENT">eprint</span></span> <span id="local_txt_471"><span class="LIDENT">txt</span></span> <span class="EQUAL">=</span> <span class="LIDENT">write</span> <span class="LIDENT">stderr</span> <a href="#local_txt_471"><span class="LIDENT">txt</span></a><span class="EOL">
</span><span class="LET">let</span> <span id="val-eprintl"><span class="LIDENT">eprintl</span></span> <span id="local_txt_472"><span class="LIDENT">txt</span></span> <span class="EQUAL">=</span> <span class="LIDENT">write_line</span> <span class="LIDENT">stderr</span> <a href="#local_txt_472"><span class="LIDENT">txt</span></a><span class="EOL">
</span><span class="LET">let</span> <span id="val-eprintf"><span class="LIDENT">eprintf</span></span> <span id="local_fmt_473"><span class="LIDENT">fmt</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/printf.ml.html#val-ksprintf"><span class="UIDENT">Printf</span><span class="DOT">.</span><span class="LIDENT">ksprintf</span></a> <span class="LIDENT">eprint</span> <a href="#local_fmt_473"><span class="LIDENT">fmt</span></a><span class="EOL">
</span><span class="LET">let</span> <span id="val-eprintlf"><span class="LIDENT">eprintlf</span></span> <span id="local_fmt_474"><span class="LIDENT">fmt</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/printf.ml.html#val-ksprintf"><span class="UIDENT">Printf</span><span class="DOT">.</span><span class="LIDENT">ksprintf</span></a> <span class="LIDENT">eprintl</span> <a href="#local_fmt_474"><span class="LIDENT">fmt</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-pipe"><span class="LIDENT">pipe</span></span> <span class="QUESTION">?</span><span id="local_cloexec_475"><span class="LIDENT">cloexec</span></span> <span class="QUESTION">?</span><span id="local_in_buffer_476"><span class="LIDENT">in_buffer</span></span> <span class="QUESTION">?</span><span id="local_out_buffer_477"><span class="LIDENT">out_buffer</span></span> <span class="UNDERSCORE">_</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="def_699"><span id="local_fd_r_478"><span class="LIDENT">fd_r</span></span><span class="COMMA">,</span> <span id="local_fd_w_479"><span class="LIDENT">fd_w</span></span></span> <span class="EQUAL">=</span> <a href="lwt_unix.ml.html#val-pipe"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">pipe</span></a> <span class="QUESTION">?</span><a href="#local_cloexec_475"><span class="LIDENT">cloexec</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LPAREN">(</span><span class="LIDENT">of_fd</span> <span class="OPTLABEL">?buffer:</span><a href="#local_in_buffer_476"><span class="LIDENT">in_buffer</span></a> <span class="LABEL">~mode:</span><span class="LIDENT">input</span> <a href="#local_fd_r_478"><span class="LIDENT">fd_r</span></a><span class="COMMA">,</span><span class="EOL">
</span>   <span class="LIDENT">of_fd</span> <span class="OPTLABEL">?buffer:</span><a href="#local_out_buffer_477"><span class="LIDENT">out_buffer</span></a> <span class="LABEL">~mode:</span><span class="LIDENT">output</span> <a href="#local_fd_w_479"><span class="LIDENT">fd_w</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span id="type-file_name"><span class="TYPE">type</span> <span class="LIDENT">file_name</span> <span class="EQUAL">=</span> <span class="LIDENT">string</span></span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-open_file"><span class="LIDENT">open_file</span></span> <span class="COLON">:</span><span class="EOL">
</span>    <span class="TYPE">type</span> <span class="LIDENT">m</span><span class="DOT">.</span><span class="EOL">
</span>    <span class="QUESTION">?</span><span class="LIDENT">buffer</span> <span class="COLON">:</span> <a href="lwt_bytes.ml.html#type-t"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">t</span></a> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="QUESTION">?</span><span class="LIDENT">flags</span> <span class="COLON">:</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">open_flag</span> <span class="LIDENT">list</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="QUESTION">?</span><span class="LIDENT">perm</span> <span class="COLON">:</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">file_perm</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LIDENT">mode</span> <span class="COLON">:</span> <span class="LIDENT">m</span> <span class="LIDENT">mode</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LIDENT">file_name</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Public_types.type-t"><span class="LIDENT">m</span> <span class="LIDENT">channel</span> <span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">t</span></a> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="FUN">fun</span> <span class="QUESTION">?</span><span id="local_buffer_480"><span class="LIDENT">buffer</span></span> <span class="QUESTION">?</span><span id="local_flags_481"><span class="LIDENT">flags</span></span> <span class="QUESTION">?</span><span id="local_perm_482"><span class="LIDENT">perm</span></span> <span class="TILDE">~</span><span id="local_mode_483"><span class="LIDENT">mode</span></span> <span id="local_filename_484"><span class="LIDENT">filename</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_flags_485"><span class="LIDENT">flags</span></span> <span class="EQUAL">=</span> <span class="MATCH">match</span> <a href="#local_flags_481"><span class="LIDENT">flags</span></a><span class="COMMA">,</span> <a href="#local_mode_483"><span class="LIDENT">mode</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_l_486"><span class="LIDENT">l</span></span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="#local_l_486"><span class="LIDENT">l</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">None</span><span class="COMMA">,</span> <span class="UIDENT">Input</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LBRACKET">[</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">O_RDONLY</span><span class="SEMI">;</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">O_NONBLOCK</span><span class="RBRACKET">]</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">None</span><span class="COMMA">,</span> <span class="UIDENT">Output</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LBRACKET">[</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">O_WRONLY</span><span class="SEMI">;</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">O_CREAT</span><span class="SEMI">;</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">O_TRUNC</span><span class="SEMI">;</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">O_NONBLOCK</span><span class="RBRACKET">]</span><span class="EOL">
</span>  <span class="AND">and</span> <span id="local_perm_487"><span class="LIDENT">perm</span></span> <span class="EQUAL">=</span> <span class="MATCH">match</span> <a href="#local_perm_482"><span class="LIDENT">perm</span></a><span class="COMMA">,</span> <a href="#local_mode_483"><span class="LIDENT">mode</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_p_488"><span class="LIDENT">p</span></span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="#local_p_488"><span class="LIDENT">p</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">None</span><span class="COMMA">,</span> <span class="UIDENT">Input</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="INT">0</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">None</span><span class="COMMA">,</span> <span class="UIDENT">Output</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="INT">0o666</span><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <a href="lwt_unix.ml.html#val-openfile"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">openfile</span></a> <a href="#local_filename_484"><span class="LIDENT">filename</span></a> <a href="#local_flags_485"><span class="LIDENT">flags</span></a> <a href="#local_perm_487"><span class="LIDENT">perm</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span id="local_fd_489"><span class="LIDENT">fd</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>  <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <span class="LPAREN">(</span><span class="LIDENT">of_fd</span> <span class="QUESTION">?</span><a href="#local_buffer_480"><span class="LIDENT">buffer</span></a> <span class="TILDE">~</span><a href="#local_mode_483"><span class="LIDENT">mode</span></a> <a href="#local_fd_489"><span class="LIDENT">fd</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-with_file"><span class="LIDENT">with_file</span></span> <span class="QUESTION">?</span><span id="local_buffer_490"><span class="LIDENT">buffer</span></span> <span class="QUESTION">?</span><span id="local_flags_491"><span class="LIDENT">flags</span></span> <span class="QUESTION">?</span><span id="local_perm_492"><span class="LIDENT">perm</span></span> <span class="TILDE">~</span><span id="local_mode_493"><span class="LIDENT">mode</span></span> <span id="local_filename_494"><span class="LIDENT">filename</span></span> <span id="local_f_495"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">open_file</span> <span class="QUESTION">?</span><a href="#local_buffer_490"><span class="LIDENT">buffer</span></a> <span class="QUESTION">?</span><a href="#local_flags_491"><span class="LIDENT">flags</span></a> <span class="QUESTION">?</span><a href="#local_perm_492"><span class="LIDENT">perm</span></a> <span class="TILDE">~</span><a href="#local_mode_493"><span class="LIDENT">mode</span></a> <a href="#local_filename_494"><span class="LIDENT">filename</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span id="local_ic_496"><span class="LIDENT">ic</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>  <a href="../lwt/lwt.ml.html#module-Sequential_composition.val-finalize"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">finalize</span></a><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_f_495"><span class="LIDENT">f</span></a> <a href="#local_ic_496"><span class="LIDENT">ic</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">close</span> <a href="#local_ic_496"><span class="LIDENT">ic</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-prng"><span class="LIDENT">prng</span></span> <span class="EQUAL">=</span> <span class="LAZY">lazy</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/random.ml.html#module-State.val-make_self_init"><span class="UIDENT">Random</span><span class="DOT">.</span><span class="UIDENT">State</span><span class="DOT">.</span><span class="LIDENT">make_self_init</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-temp_file_name"><span class="LIDENT">temp_file_name</span></span> <span id="local_temp_dir_497"><span class="LIDENT">temp_dir</span></span> <span id="local_prefix_498"><span class="LIDENT">prefix</span></span> <span id="local_suffix_499"><span class="LIDENT">suffix</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_rnd_500"><span class="LIDENT">rnd</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/random.ml.html#module-State.val-int"><span class="UIDENT">Random</span><span class="DOT">.</span><span class="UIDENT">State</span><span class="DOT">.</span><span class="LIDENT">int</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/lazy.ml.html#val-force"><span class="UIDENT">Lazy</span><span class="DOT">.</span><span class="LIDENT">force</span></a> <span class="LIDENT">prng</span><span class="RPAREN">)</span> <span class="INT">0x1000000</span> <span class="IN">in</span><span class="EOL">
</span>  <a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#val-concat"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">concat</span></a> <a href="#local_temp_dir_497"><span class="LIDENT">temp_dir</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/printf.ml.html#val-sprintf"><span class="UIDENT">Printf</span><span class="DOT">.</span><span class="LIDENT">sprintf</span></a> <span class="STRING">&quot;%s%06x%s&quot;</span> <a href="#local_prefix_498"><span class="LIDENT">prefix</span></a> <a href="#local_rnd_500"><span class="LIDENT">rnd</span></a> <a href="#local_suffix_499"><span class="LIDENT">suffix</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-open_temp_file"><span class="LIDENT">open_temp_file</span></span> <span class="QUESTION">?</span><span id="local_buffer_501"><span class="LIDENT">buffer</span></span> <span class="QUESTION">?</span><span id="local_flags_502"><span class="LIDENT">flags</span></span> <span class="QUESTION">?</span><span id="local_perm_503"><span class="LIDENT">perm</span></span> <span class="QUESTION">?</span><span id="local_temp_dir_504"><span class="LIDENT">temp_dir</span></span> <span class="QUESTION">?</span><span id="local_prefix_505"><span class="LIDENT">prefix</span></span> <span class="QUESTION">?</span><span class="LPAREN">(</span><span id="local_suffix_506"><span class="LIDENT">suffix</span></span> <span class="EQUAL">=</span> <span class="STRING">&quot;&quot;</span><span class="RPAREN">)</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_flags_507"><span class="LIDENT">flags</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_flags_502"><span class="LIDENT">flags</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span> <span class="LBRACKET">[</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">O_WRONLY</span><span class="SEMI">;</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">O_CREAT</span><span class="SEMI">;</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">O_EXCL</span><span class="SEMI">;</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">O_CLOEXEC</span><span class="RBRACKET">]</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_flags_508"><span class="LIDENT">flags</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_flags_508"><span class="LIDENT">flags</span></a><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_dir_509"><span class="LIDENT">dir</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_temp_dir_504"><span class="LIDENT">temp_dir</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#val-get_temp_dir_name"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">get_temp_dir_name</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_dirname_510"><span class="LIDENT">dirname</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_dirname_510"><span class="LIDENT">dirname</span></a><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_prefix_511"><span class="LIDENT">prefix</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_prefix_505"><span class="LIDENT">prefix</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span> <span class="STRING">&quot;lwt_io_temp_file_&quot;</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_prefix_512"><span class="LIDENT">prefix</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_prefix_512"><span class="LIDENT">prefix</span></a><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="REC">rec</span> <span id="local_attempt_513"><span class="LIDENT">attempt</span></span> <span id="local_n_514"><span class="LIDENT">n</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_fname_515"><span class="LIDENT">fname</span></span> <span class="EQUAL">=</span> <span class="LIDENT">temp_file_name</span> <a href="#local_dir_509"><span class="LIDENT">dir</span></a> <a href="#local_prefix_511"><span class="LIDENT">prefix</span></a> <a href="#local_suffix_506"><span class="LIDENT">suffix</span></a> <span class="IN">in</span><span class="EOL">
</span>    <a href="../lwt/lwt.ml.html#module-Sequential_composition.val-catch"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">catch</span></a><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LIDENT">open_file</span> <span class="QUESTION">?</span><a href="#local_buffer_501"><span class="LIDENT">buffer</span></a> <span class="TILDE">~</span><a href="#local_flags_507"><span class="LIDENT">flags</span></a> <span class="QUESTION">?</span><a href="#local_perm_503"><span class="LIDENT">perm</span></a> <span class="LABEL">~mode:</span><span class="UIDENT">Output</span> <a href="#local_fname_515"><span class="LIDENT">fname</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span id="local_chan_516"><span class="LIDENT">chan</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <span class="LPAREN">(</span><a href="#local_fname_515"><span class="LIDENT">fname</span></a><span class="COMMA">,</span> <a href="#local_chan_516"><span class="LIDENT">chan</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="FUNCTION">function</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">Unix_error</span> <span class="UNDERSCORE">_</span> <span class="WHEN">when</span> <a href="#local_n_514"><span class="LIDENT">n</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;)"><span class="LESS">&lt;</span></a> <span class="INT">1000</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_attempt_513"><span class="LIDENT">attempt</span></a> <span class="LPAREN">(</span><a href="#local_n_514"><span class="LIDENT">n</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <span class="INT">1</span><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="BAR">|</span> <span id="local_exn_517"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <a href="#local_exn_517"><span class="LIDENT">exn</span></a><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <a href="#local_attempt_513"><span class="LIDENT">attempt</span></a> <span class="INT">0</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-with_temp_file"><span class="LIDENT">with_temp_file</span></span> <span class="QUESTION">?</span><span id="local_buffer_518"><span class="LIDENT">buffer</span></span> <span class="QUESTION">?</span><span id="local_flags_519"><span class="LIDENT">flags</span></span> <span class="QUESTION">?</span><span id="local_perm_520"><span class="LIDENT">perm</span></span> <span class="QUESTION">?</span><span id="local_temp_dir_521"><span class="LIDENT">temp_dir</span></span> <span class="QUESTION">?</span><span id="local_prefix_522"><span class="LIDENT">prefix</span></span> <span class="QUESTION">?</span><span id="local_suffix_523"><span class="LIDENT">suffix</span></span> <span id="local_f_524"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">open_temp_file</span><span class="EOL">
</span>    <span class="QUESTION">?</span><a href="#local_buffer_518"><span class="LIDENT">buffer</span></a> <span class="QUESTION">?</span><a href="#local_flags_519"><span class="LIDENT">flags</span></a> <span class="QUESTION">?</span><a href="#local_perm_520"><span class="LIDENT">perm</span></a> <span class="QUESTION">?</span><a href="#local_temp_dir_521"><span class="LIDENT">temp_dir</span></a> <span class="QUESTION">?</span><a href="#local_prefix_522"><span class="LIDENT">prefix</span></a> <span class="QUESTION">?</span><a href="#local_suffix_523"><span class="LIDENT">suffix</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span class="LPAREN">(</span><span id="local_fname_525"><span class="LIDENT">fname</span></span><span class="COMMA">,</span> <span id="local_chan_526"><span class="LIDENT">chan</span></span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>  <a href="../lwt/lwt.ml.html#module-Sequential_composition.val-finalize"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">finalize</span></a><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="#local_f_524"><span class="LIDENT">f</span></a> <span class="LPAREN">(</span><a href="#local_fname_525"><span class="LIDENT">fname</span></a><span class="COMMA">,</span> <a href="#local_chan_526"><span class="LIDENT">chan</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">close</span> <a href="#local_chan_526"><span class="LIDENT">chan</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="lwt_unix.ml.html#val-unlink"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">unlink</span></a> <a href="#local_fname_525"><span class="LIDENT">fname</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-create_temp_dir"><span class="LIDENT">create_temp_dir</span></span><span class="EOL">
</span>    <span class="QUESTION">?</span><span class="LPAREN">(</span><span id="local_perm_527"><span class="LIDENT">perm</span></span> <span class="EQUAL">=</span> <span class="INT">0o755</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="QUESTION">?</span><span class="LPAREN">(</span><span id="local_parent_528"><span class="LIDENT">parent</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#val-get_temp_dir_name"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">get_temp_dir_name</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="QUESTION">?</span><span class="LPAREN">(</span><span id="local_prefix_529"><span class="LIDENT">prefix</span></span> <span class="EQUAL">=</span> <span class="STRING">&quot;lwt_io_temp_dir_&quot;</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="QUESTION">?</span><span class="LPAREN">(</span><span id="local_suffix_530"><span class="LIDENT">suffix</span></span> <span class="EQUAL">=</span> <span class="STRING">&quot;&quot;</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="REC">rec</span> <span id="local_attempt_531"><span class="LIDENT">attempt</span></span> <span id="local_n_532"><span class="LIDENT">n</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_name_533"><span class="LIDENT">name</span></span> <span class="EQUAL">=</span> <span class="LIDENT">temp_file_name</span> <a href="#local_parent_528"><span class="LIDENT">parent</span></a> <a href="#local_prefix_529"><span class="LIDENT">prefix</span></a> <a href="#local_suffix_530"><span class="LIDENT">suffix</span></a> <span class="IN">in</span><span class="EOL">
</span>    <a href="../lwt/lwt.ml.html#module-Sequential_composition.val-catch"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">catch</span></a><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <a href="lwt_unix.ml.html#val-mkdir"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">mkdir</span></a> <a href="#local_name_533"><span class="LIDENT">name</span></a> <a href="#local_perm_527"><span class="LIDENT">perm</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <a href="#local_name_533"><span class="LIDENT">name</span></a><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="FUNCTION">function</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">Unix_error</span> <span class="LPAREN">(</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">EEXIST</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="WHEN">when</span> <a href="#local_n_532"><span class="LIDENT">n</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;)"><span class="LESS">&lt;</span></a> <span class="INT">1000</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_attempt_531"><span class="LIDENT">attempt</span></a> <span class="LPAREN">(</span><a href="#local_n_532"><span class="LIDENT">n</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <span class="INT">1</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="BAR">|</span> <span id="local_exn_534"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <a href="#local_exn_534"><span class="LIDENT">exn</span></a><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <a href="#local_attempt_531"><span class="LIDENT">attempt</span></a> <span class="INT">0</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-win32_unlink"><span class="LIDENT">win32_unlink</span></span> <span id="local_fn_535"><span class="LIDENT">fn</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="../lwt/lwt.ml.html#module-Sequential_composition.val-catch"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">catch</span></a><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="lwt_unix.ml.html#val-unlink"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">unlink</span></a> <a href="#local_fn_535"><span class="LIDENT">fn</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="FUNCTION">function</span><span class="EOL">
</span>     <span class="BAR">|</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">Unix_error</span> <span class="LPAREN">(</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">EACCES</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="AS">as</span> <span id="local_exn_536"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>       <span class="COMMENT">(* Try removing the read-only attribute before retrying unlink. We catch
          any exception here and ignore it in favour of the original [exn]. *)</span><span class="EOL">
</span>       <a href="../lwt/lwt.ml.html#module-Sequential_composition.val-catch"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">catch</span></a><span class="EOL">
</span>         <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>           <a href="lwt_unix.ml.html#val-lstat"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">lstat</span></a> <a href="#local_fn_535"><span class="LIDENT">fn</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span class="LBRACE">{</span><span id="local_st_perm_537"><span class="LIDENT">st_perm</span></span><span class="SEMI">;</span> <span class="UNDERSCORE">_</span><span class="RBRACE">}</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>           <a href="lwt_unix.ml.html#val-chmod"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">chmod</span></a> <a href="#local_fn_535"><span class="LIDENT">fn</span></a> <span class="INT">0o666</span> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>           <a href="../lwt/lwt.ml.html#module-Sequential_composition.val-catch"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">catch</span></a><span class="EOL">
</span>             <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="lwt_unix.ml.html#val-unlink"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">unlink</span></a> <a href="#local_fn_535"><span class="LIDENT">fn</span></a><span class="RPAREN">)</span><span class="EOL">
</span>             <span class="LPAREN">(</span><span class="FUNCTION">function</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>                <span class="COMMENT">(* If everything succeeded but the final removal still failed,
                   restore original permissions *)</span><span class="EOL">
</span>                <a href="lwt_unix.ml.html#val-chmod"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">chmod</span></a> <a href="#local_fn_535"><span class="LIDENT">fn</span></a> <a href="#local_st_perm_537"><span class="LIDENT">st_perm</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>                <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <a href="#local_exn_536"><span class="LIDENT">exn</span></a><span class="RPAREN">)</span><span class="EOL">
</span>         <span class="RPAREN">)</span><span class="EOL">
</span>         <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <a href="#local_exn_536"><span class="LIDENT">exn</span></a><span class="RPAREN">)</span><span class="EOL">
</span>     <span class="BAR">|</span> <span id="local_exn_538"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <a href="#local_exn_538"><span class="LIDENT">exn</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-unlink"><span class="LIDENT">unlink</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-win32"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">win32</span></a> <span class="THEN">then</span><span class="EOL">
</span>    <span class="LIDENT">win32_unlink</span><span class="EOL">
</span>  <span class="ELSE">else</span><span class="EOL">
</span>    <a href="lwt_unix.ml.html#val-unlink"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">unlink</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* This is likely VERY slow for directories with many files. That is probably
   best addressed by switching to blocking calls run inside a worker thread,
   i.e. with Lwt_preemptive. *)</span><span class="EOL">
</span><span class="LET">let</span> <span class="REC">rec</span> <span id="val-delete_recursively"><span class="LIDENT">delete_recursively</span></span> <span id="local_directory_539"><span class="LIDENT">directory</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="lwt_unix.ml.html#val-files_of_directory"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">files_of_directory</span></a> <a href="#local_directory_539"><span class="LIDENT">directory</span></a><span class="EOL">
</span>  <span class="INFIXOP0">|&gt;</span> <a href="../lwt/lwt_stream.ml.html#val-iter_s"><span class="UIDENT">Lwt_stream</span><span class="DOT">.</span><span class="LIDENT">iter_s</span></a> <span class="BEGIN">begin</span> <span class="FUN">fun</span> <span id="local_entry_540"><span class="LIDENT">entry</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_entry_540"><span class="LIDENT">entry</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#module-Sysdeps"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">current_dir_name</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a><span class="EOL">
</span>       <a href="#local_entry_540"><span class="LIDENT">entry</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#module-Sysdeps"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">parent_dir_name</span></a> <span class="THEN">then</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="EOL">
</span>    <span class="ELSE">else</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_path_541"><span class="LIDENT">path</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/filename.ml.html#val-concat"><span class="UIDENT">Filename</span><span class="DOT">.</span><span class="LIDENT">concat</span></a> <a href="#local_directory_539"><span class="LIDENT">directory</span></a> <a href="#local_entry_540"><span class="LIDENT">entry</span></a> <span class="IN">in</span><span class="EOL">
</span>      <a href="lwt_unix.ml.html#val-lstat"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">lstat</span></a> <a href="#local_path_541"><span class="LIDENT">path</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span class="LBRACE">{</span><span id="local_st_kind_542"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">st_kind</span></span><span class="SEMI">;</span> <span class="UNDERSCORE">_</span><span class="RBRACE">}</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="MATCH">match</span> <a href="#local_st_kind_542"><span class="LIDENT">st_kind</span></a> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">S_DIR</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">delete_recursively</span> <a href="#local_path_541"><span class="LIDENT">path</span></a><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">S_LNK</span> <span class="WHEN">when</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-win32"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">win32</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/sys.ml.html#val-cygwin"><span class="UIDENT">Sys</span><span class="DOT">.</span><span class="LIDENT">cygwin</span></a><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>         <a href="lwt_unix.ml.html#val-stat"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">stat</span></a> <a href="#local_path_541"><span class="LIDENT">path</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span class="LBRACE">{</span><span id="local_st_kind_543"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">st_kind</span></span><span class="SEMI">;</span> <span class="UNDERSCORE">_</span><span class="RBRACE">}</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>         <span class="BEGIN">begin</span> <span class="MATCH">match</span> <a href="#local_st_kind_543"><span class="LIDENT">st_kind</span></a> <span class="WITH">with</span><span class="EOL">
</span>         <span class="BAR">|</span> <span class="UIDENT">S_DIR</span> <span class="MINUSGREATER">-&gt;</span> <a href="lwt_unix.ml.html#val-rmdir"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">rmdir</span></a> <a href="#local_path_541"><span class="LIDENT">path</span></a><span class="EOL">
</span>         <span class="BAR">|</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unlink</span> <a href="#local_path_541"><span class="LIDENT">path</span></a><span class="EOL">
</span>         <span class="END">end</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unlink</span> <a href="#local_path_541"><span class="LIDENT">path</span></a><span class="EOL">
</span>  <span class="END">end</span> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>  <a href="lwt_unix.ml.html#val-rmdir"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">rmdir</span></a> <a href="#local_directory_539"><span class="LIDENT">directory</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-with_temp_dir"><span class="LIDENT">with_temp_dir</span></span> <span class="QUESTION">?</span><span id="local_perm_544"><span class="LIDENT">perm</span></span> <span class="QUESTION">?</span><span id="local_parent_545"><span class="LIDENT">parent</span></span> <span class="QUESTION">?</span><span id="local_prefix_546"><span class="LIDENT">prefix</span></span> <span class="QUESTION">?</span><span id="local_suffix_547"><span class="LIDENT">suffix</span></span> <span id="local_f_548"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">create_temp_dir</span> <span class="QUESTION">?</span><a href="#local_perm_544"><span class="LIDENT">perm</span></a> <span class="QUESTION">?</span><a href="#local_parent_545"><span class="LIDENT">parent</span></a> <span class="QUESTION">?</span><a href="#local_prefix_546"><span class="LIDENT">prefix</span></a> <span class="QUESTION">?</span><a href="#local_suffix_547"><span class="LIDENT">suffix</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span id="local_name_549"><span class="LIDENT">name</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>  <a href="../lwt/lwt.ml.html#module-Sequential_composition.val-finalize"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">finalize</span></a><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="#local_f_548"><span class="LIDENT">f</span></a> <a href="#local_name_549"><span class="LIDENT">name</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">delete_recursively</span> <a href="#local_name_549"><span class="LIDENT">name</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-file_length"><span class="LIDENT">file_length</span></span> <span id="local_filename_550"><span class="LIDENT">filename</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="lwt_unix.ml.html#val-stat"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">stat</span></a> <a href="#local_filename_550"><span class="LIDENT">filename</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span id="local_stat_551"><span class="LIDENT">stat</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="#local_stat_551"><span class="LIDENT">stat</span></a><span class="DOT">.</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">st_kind</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">S_DIR</span> <span class="THEN">then</span><span class="EOL">
</span>    <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <span class="LPAREN">(</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LPAREN">(</span><span class="UIDENT">Unix_error</span> <span class="LPAREN">(</span><span class="UIDENT">EISDIR</span><span class="COMMA">,</span> <span class="STRING">&quot;file_length&quot;</span><span class="COMMA">,</span> <a href="#local_filename_550"><span class="LIDENT">filename</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="ELSE">else</span><span class="EOL">
</span>    <span class="LIDENT">with_file</span> <span class="LABEL">~mode:</span><span class="LIDENT">input</span> <a href="#local_filename_550"><span class="LIDENT">filename</span></a> <span class="LIDENT">length</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-close_socket"><span class="LIDENT">close_socket</span></span> <span id="local_fd_552"><span class="LIDENT">fd</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="../lwt/lwt.ml.html#module-Sequential_composition.val-finalize"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">finalize</span></a><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>       <a href="../lwt/lwt.ml.html#module-Sequential_composition.val-catch"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">catch</span></a><span class="EOL">
</span>         <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <a href="lwt_unix.ml.html#val-shutdown"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">shutdown</span></a> <a href="#local_fd_552"><span class="LIDENT">fd</span></a> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">SHUTDOWN_ALL</span><span class="SEMI">;</span><span class="EOL">
</span>            <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="RPAREN">)</span><span class="EOL">
</span>         <span class="LPAREN">(</span><span class="FUNCTION">function</span><span class="EOL">
</span>           <span class="COMMENT">(* Occurs if the peer closes the connection first. *)</span><span class="EOL">
</span>           <span class="BAR">|</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">Unix_error</span> <span class="LPAREN">(</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">ENOTCONN</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="EOL">
</span>           <span class="BAR">|</span> <span id="local_exn_553"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <a href="#local_exn_553"><span class="LIDENT">exn</span></a><span class="RPAREN">)</span> <span class="LBRACKETAT">[@</span><span class="LIDENT">ocaml</span><span class="DOT">.</span><span class="LIDENT">warning</span> <span class="STRING">&quot;-4&quot;</span><span class="RBRACKET">]</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>       <a href="lwt_unix.ml.html#val-close"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">close</span></a> <a href="#local_fd_552"><span class="LIDENT">fd</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-open_connection"><span class="LIDENT">open_connection</span></span> <span class="QUESTION">?</span><span id="local_fd_554"><span class="LIDENT">fd</span></span> <span class="QUESTION">?</span><span id="local_in_buffer_555"><span class="LIDENT">in_buffer</span></span> <span class="QUESTION">?</span><span id="local_out_buffer_556"><span class="LIDENT">out_buffer</span></span> <span id="local_sockaddr_557"><span class="LIDENT">sockaddr</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_fd_558"><span class="LIDENT">fd</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_fd_554"><span class="LIDENT">fd</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="lwt_unix.ml.html#val-socket"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">socket</span></a> <span class="LPAREN">(</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">domain_of_sockaddr</span> <a href="#local_sockaddr_557"><span class="LIDENT">sockaddr</span></a><span class="RPAREN">)</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">SOCK_STREAM</span> <span class="INT">0</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_fd_559"><span class="LIDENT">fd</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="#local_fd_559"><span class="LIDENT">fd</span></a><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_close_560"><span class="LIDENT">close</span></span> <span class="EQUAL">=</span> <span class="LAZY">lazy</span> <span class="LPAREN">(</span><span class="LIDENT">close_socket</span> <a href="#local_fd_558"><span class="LIDENT">fd</span></a><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>  <a href="../lwt/lwt.ml.html#module-Sequential_composition.val-catch"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">catch</span></a><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>       <a href="lwt_unix.ml.html#val-connect"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">connect</span></a> <a href="#local_fd_558"><span class="LIDENT">fd</span></a> <a href="#local_sockaddr_557"><span class="LIDENT">sockaddr</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>       <span class="LPAREN">(</span><span class="TRY">try</span> <a href="lwt_unix.ml.html#val-set_close_on_exec"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">set_close_on_exec</span></a> <a href="#local_fd_558"><span class="LIDENT">fd</span></a> <span class="WITH">with</span> <span class="UIDENT">Invalid_argument</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>       <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <span class="LPAREN">(</span><span class="LIDENT">make</span> <span class="OPTLABEL">?buffer:</span><a href="#local_in_buffer_555"><span class="LIDENT">in_buffer</span></a><span class="EOL">
</span>                     <span class="LABEL">~close:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/lazy.ml.html#val-force"><span class="UIDENT">Lazy</span><span class="DOT">.</span><span class="LIDENT">force</span></a> <a href="#local_close_560"><span class="LIDENT">close</span></a><span class="RPAREN">)</span><span class="EOL">
</span>                     <span class="LABEL">~mode:</span><span class="LIDENT">input</span> <span class="LPAREN">(</span><a href="lwt_bytes.ml.html#val-read"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">read</span></a> <a href="#local_fd_558"><span class="LIDENT">fd</span></a><span class="RPAREN">)</span><span class="COMMA">,</span><span class="EOL">
</span>                   <span class="LIDENT">make</span> <span class="OPTLABEL">?buffer:</span><a href="#local_out_buffer_556"><span class="LIDENT">out_buffer</span></a><span class="EOL">
</span>                     <span class="LABEL">~close:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/lazy.ml.html#val-force"><span class="UIDENT">Lazy</span><span class="DOT">.</span><span class="LIDENT">force</span></a> <a href="#local_close_560"><span class="LIDENT">close</span></a><span class="RPAREN">)</span><span class="EOL">
</span>                     <span class="LABEL">~mode:</span><span class="LIDENT">output</span> <span class="LPAREN">(</span><a href="lwt_bytes.ml.html#val-write"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">write</span></a> <a href="#local_fd_558"><span class="LIDENT">fd</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_exn_561"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>       <a href="lwt_unix.ml.html#val-close"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">close</span></a> <a href="#local_fd_558"><span class="LIDENT">fd</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>       <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <a href="#local_exn_561"><span class="LIDENT">exn</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-with_close_connection"><span class="LIDENT">with_close_connection</span></span> <span id="local_f_562"><span class="LIDENT">f</span></span> <span class="LPAREN">(</span><span id="local_ic_563"><span class="LIDENT">ic</span></span><span class="COMMA">,</span> <span id="local_oc_564"><span class="LIDENT">oc</span></span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="COMMENT">(* If the user already tried to close the socket and got an exception, we
     don't want to raise that exception again during implicit close. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_close_if_not_closed_565"><span class="LIDENT">close_if_not_closed</span></span> <span id="local_channel_566"><span class="LIDENT">channel</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="IF">if</span> <span class="LIDENT">is_closed</span> <a href="#local_channel_566"><span class="LIDENT">channel</span></a> <span class="THEN">then</span> <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a> <span class="ELSE">else</span> <span class="LIDENT">close</span> <a href="#local_channel_566"><span class="LIDENT">channel</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>  <a href="../lwt/lwt.ml.html#module-Sequential_composition.val-finalize"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">finalize</span></a><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_f_562"><span class="LIDENT">f</span></a> <span class="LPAREN">(</span><a href="#local_ic_563"><span class="LIDENT">ic</span></a><span class="COMMA">,</span> <a href="#local_oc_564"><span class="LIDENT">oc</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_close_if_not_closed_565"><span class="LIDENT">close_if_not_closed</span></a> <a href="#local_ic_563"><span class="LIDENT">ic</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&lt;&amp;&gt;)"><span class="INFIXOP0">&lt;&amp;&gt;</span></a> <a href="#local_close_if_not_closed_565"><span class="LIDENT">close_if_not_closed</span></a> <a href="#local_oc_564"><span class="LIDENT">oc</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-with_connection"><span class="LIDENT">with_connection</span></span> <span class="QUESTION">?</span><span id="local_fd_567"><span class="LIDENT">fd</span></span> <span class="QUESTION">?</span><span id="local_in_buffer_568"><span class="LIDENT">in_buffer</span></span> <span class="QUESTION">?</span><span id="local_out_buffer_569"><span class="LIDENT">out_buffer</span></span> <span id="local_sockaddr_570"><span class="LIDENT">sockaddr</span></span> <span id="local_f_571"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">open_connection</span> <span class="QUESTION">?</span><a href="#local_fd_567"><span class="LIDENT">fd</span></a> <span class="QUESTION">?</span><a href="#local_in_buffer_568"><span class="LIDENT">in_buffer</span></a> <span class="QUESTION">?</span><a href="#local_out_buffer_569"><span class="LIDENT">out_buffer</span></a> <a href="#local_sockaddr_570"><span class="LIDENT">sockaddr</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span id="local_channels_572"><span class="LIDENT">channels</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>  <span class="LIDENT">with_close_connection</span> <a href="#local_f_571"><span class="LIDENT">f</span></a> <a href="#local_channels_572"><span class="LIDENT">channels</span></a><span class="EOL">
</span><span class="EOL">
</span><span id="type-server"><span class="TYPE">type</span> <span class="LIDENT">server</span> <span class="EQUAL">=</span> <span class="LBRACE">{</span><span class="EOL">
</span>  <span id="def_692"><span class="LIDENT">shutdown</span> <span class="COLON">:</span> <a href="../../../ocaml-base-compiler/src/stdlib/lazy.ml.html#type-t"><a href="../lwt/lwt.ml.html#module-Public_types.type-t"><span class="LIDENT">unit</span> <span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">t</span></a> <span class="UIDENT">Lazy</span><span class="DOT">.</span><span class="LIDENT">t</span></a><span class="SEMI">;</span></span><span class="EOL">
</span><span class="RBRACE">}</span></span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-shutdown_server"><span class="LIDENT">shutdown_server</span></span> <span id="local_server_573"><span class="LIDENT">server</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/lazy.ml.html#val-force"><span class="UIDENT">Lazy</span><span class="DOT">.</span><span class="LIDENT">force</span></a> <a href="#local_server_573"><span class="LIDENT">server</span></a><span class="DOT">.</span><span class="LIDENT">shutdown</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-shutdown_server_deprecated"><span class="LIDENT">shutdown_server_deprecated</span></span> <span id="local_server_574"><span class="LIDENT">server</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="../lwt/lwt.ml.html#module-Concurrent_composition.val-async"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">async</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">shutdown_server</span> <a href="#local_server_574"><span class="LIDENT">server</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* There are several variants of establish_server that have accumulated over the
   years in Lwt_io. This is their underlying implementation. The functions
   exposed in the API are various wrappers around this one. *)</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-establish_server_generic"><span class="LIDENT">establish_server_generic</span></span><span class="EOL">
</span>    <span id="local_bind_function_575"><span class="LIDENT">bind_function</span></span><span class="EOL">
</span>    <span class="OPTLABEL">?fd:</span><span id="local_preexisting_socket_for_listening_576"><span class="LIDENT">preexisting_socket_for_listening</span></span><span class="EOL">
</span>    <span class="QUESTION">?</span><span class="LPAREN">(</span><span id="local_backlog_577"><span class="LIDENT">backlog</span></span> <span class="EQUAL">=</span> <a href="lwt_unix.ml.html#val-somaxconn"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">somaxconn</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="LBRACKETAT">[@</span><span class="LIDENT">ocaml</span><span class="DOT">.</span><span class="LIDENT">warning</span> <span class="STRING">&quot;-3&quot;</span><span class="RBRACKET">]</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span id="local_listening_address_578"><span class="LIDENT">listening_address</span></span><span class="EOL">
</span>    <span id="local_connection_handler_callback_579"><span class="LIDENT">connection_handler_callback</span></span> <span class="EQUAL">=</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_listening_socket_580"><span class="LIDENT">listening_socket</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_preexisting_socket_for_listening_576"><span class="LIDENT">preexisting_socket_for_listening</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="lwt_unix.ml.html#val-socket"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">socket</span></a><span class="EOL">
</span>        <span class="LPAREN">(</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">domain_of_sockaddr</span> <a href="#local_listening_address_578"><span class="LIDENT">listening_address</span></a><span class="RPAREN">)</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">SOCK_STREAM</span> <span class="INT">0</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_socket_581"><span class="LIDENT">socket</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="#local_socket_581"><span class="LIDENT">socket</span></a><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <a href="lwt_unix.ml.html#val-setsockopt"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">setsockopt</span></a> <a href="#local_listening_socket_580"><span class="LIDENT">listening_socket</span></a> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">SO_REUSEADDR</span> <span class="TRUE">true</span><span class="SEMI">;</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* This promise gets resolved with `Should_stop when the user calls
     Lwt_io.shutdown_server. This begins the shutdown procedure. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="def_678"><span id="local_should_stop_582"><span class="LIDENT">should_stop</span></span><span class="COMMA">,</span> <span id="local_notify_should_stop_583"><span class="LIDENT">notify_should_stop</span></span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <a href="../lwt/lwt.ml.html#module-Pending_promises.val-wait"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">wait</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Some time after Lwt_io.shutdown_server is called, this function
     establish_server_generic will actually close the listening socket. At that
     point, this promise is resolved. This ends the shutdown procedure. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="def_695"><span id="local_wait_until_listening_socket_closed_584"><span class="LIDENT">wait_until_listening_socket_closed</span></span><span class="COMMA">,</span> <span id="local_notify_listening_socket_closed_585"><span class="LIDENT">notify_listening_socket_closed</span></span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <a href="../lwt/lwt.ml.html#module-Pending_promises.val-wait"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">wait</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="REC">rec</span> <span id="local_accept_loop_586"><span class="LIDENT">accept_loop</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_try_to_accept_587"><span class="LIDENT">try_to_accept</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Sequential_composition.val-catch"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">catch</span></a><span class="EOL">
</span>        <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>           <a href="lwt_unix.ml.html#val-accept"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">accept</span></a> <a href="#local_listening_socket_580"><span class="LIDENT">listening_socket</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;|=)"><span class="INFIXOP0">&gt;|=</span></a> <span class="FUN">fun</span> <span id="local_x_588"><span class="LIDENT">x</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>           <span class="BACKQUOTE">`</span><span class="UIDENT">Accepted</span> <a href="#local_x_588"><span class="LIDENT">x</span></a><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="LPAREN">(</span><span class="FUNCTION">function</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">Unix_error</span> <span class="LPAREN">(</span><span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">ECONNABORTED</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <span class="BACKQUOTE">`</span><span class="UIDENT">Try_again</span><span class="EOL">
</span>          <span class="BAR">|</span> <span id="local_e_589"><span class="LIDENT">e</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-fail"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <a href="#local_e_589"><span class="LIDENT">e</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <a href="../lwt/lwt.ml.html#module-Concurrent_composition.val-pick"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">pick</span></a> <span class="LBRACKET">[</span><a href="#local_try_to_accept_587"><span class="LIDENT">try_to_accept</span></a><span class="SEMI">;</span> <a href="#local_should_stop_582"><span class="LIDENT">should_stop</span></a><span class="RBRACKET">]</span> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUNCTION">function</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Accepted</span> <span class="LPAREN">(</span><span id="local_client_socket_590"><span class="LIDENT">client_socket</span></span><span class="COMMA">,</span> <span id="local_client_address_591"><span class="LIDENT">client_address</span></span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="BEGIN">begin</span><span class="EOL">
</span>        <span class="TRY">try</span> <a href="lwt_unix.ml.html#val-set_close_on_exec"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">set_close_on_exec</span></a> <a href="#local_client_socket_590"><span class="LIDENT">client_socket</span></a><span class="EOL">
</span>        <span class="WITH">with</span> <span class="UIDENT">Invalid_argument</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="END">end</span><span class="SEMI">;</span><span class="EOL">
</span><span class="EOL">
</span>      <a href="#local_connection_handler_callback_579"><span class="LIDENT">connection_handler_callback</span></a> <a href="#local_client_address_591"><span class="LIDENT">client_address</span></a> <a href="#local_client_socket_590"><span class="LIDENT">client_socket</span></a><span class="SEMI">;</span><span class="EOL">
</span><span class="EOL">
</span>      <a href="#local_accept_loop_586"><span class="LIDENT">accept_loop</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Should_stop</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="lwt_unix.ml.html#val-close"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">close</span></a> <a href="#local_listening_socket_580"><span class="LIDENT">listening_socket</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="BEGIN">begin</span> <span class="MATCH">match</span> <a href="#local_listening_address_578"><span class="LIDENT">listening_address</span></a> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="UIDENT">ADDR_UNIX</span> <span id="local_path_592"><span class="LIDENT">path</span></span> <span class="WHEN">when</span> <a href="#local_path_592"><span class="LIDENT">path</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;&gt;)"><span class="INFIXOP0">&lt;&gt;</span></a> <span class="STRING">&quot;&quot;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&amp;&amp;)"><span class="AMPERAMPER">&amp;&amp;</span></a> <a href="#local_path_592"><span class="LIDENT">path</span></a><span class="DOT">.</span><span class="LBRACKET">[</span><span class="INT">0</span><span class="RBRACKET">]</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;&gt;)"><span class="INFIXOP0">&lt;&gt;</span></a> <span class="CHAR">'\x00'</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="UIDENT">Unix</span><span class="DOT">.</span><span class="LIDENT">unlink</span> <a href="#local_path_592"><span class="LIDENT">path</span></a><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="END">end</span> <span class="LBRACKETAT">[@</span><span class="LIDENT">ocaml</span><span class="DOT">.</span><span class="LIDENT">warning</span> <span class="STRING">&quot;-4&quot;</span><span class="RBRACKET">]</span><span class="SEMI">;</span><span class="EOL">
</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Resolving.val-wakeup_later"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">wakeup_later</span></a> <a href="#local_notify_listening_socket_closed_585"><span class="LIDENT">notify_listening_socket_closed</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Try_again</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="#local_accept_loop_586"><span class="LIDENT">accept_loop</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_server_593"><span class="LIDENT">server</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LBRACE">{</span><span class="LIDENT">shutdown</span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LAZY">lazy</span> <span class="BEGIN">begin</span><span class="EOL">
</span>        <a href="../lwt/lwt.ml.html#module-Resolving.val-wakeup_later"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">wakeup_later</span></a> <a href="#local_notify_should_stop_583"><span class="LIDENT">notify_should_stop</span></a> <span class="BACKQUOTE">`</span><span class="UIDENT">Should_stop</span><span class="SEMI">;</span><span class="EOL">
</span>        <a href="#local_wait_until_listening_socket_closed_584"><span class="LIDENT">wait_until_listening_socket_closed</span></a><span class="EOL">
</span>      <span class="END">end</span><span class="RBRACE">}</span><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Actually start the server. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_server_has_started_594"><span class="LIDENT">server_has_started</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <a href="#local_bind_function_575"><span class="LIDENT">bind_function</span></a> <a href="#local_listening_socket_580"><span class="LIDENT">listening_socket</span></a> <a href="#local_listening_address_578"><span class="LIDENT">listening_address</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="lwt_unix.ml.html#val-listen"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">listen</span></a> <a href="#local_listening_socket_580"><span class="LIDENT">listening_socket</span></a> <a href="#local_backlog_577"><span class="LIDENT">backlog</span></a><span class="SEMI">;</span><span class="EOL">
</span><span class="EOL">
</span>    <a href="../lwt/lwt.ml.html#module-Concurrent_composition.val-async"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">async</span></a> <a href="#local_accept_loop_586"><span class="LIDENT">accept_loop</span></a><span class="SEMI">;</span><span class="EOL">
</span><span class="EOL">
</span>    <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>  <a href="#local_server_593"><span class="LIDENT">server</span></a><span class="COMMA">,</span> <a href="#local_server_has_started_594"><span class="LIDENT">server_has_started</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-establish_server_with_client_socket"><span class="LIDENT">establish_server_with_client_socket</span></span><span class="EOL">
</span>    <span class="QUESTION">?</span><span id="local_server_fd_595"><span class="LIDENT">server_fd</span></span> <span class="QUESTION">?</span><span id="local_backlog_596"><span class="LIDENT">backlog</span></span> <span class="QUESTION">?</span><span class="LPAREN">(</span><span id="local_no_close_597"><span class="LIDENT">no_close</span></span> <span class="EQUAL">=</span> <span class="FALSE">false</span><span class="RPAREN">)</span> <span id="local_sockaddr_598"><span class="LIDENT">sockaddr</span></span> <span id="local_f_599"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_handler_600"><span class="LIDENT">handler</span></span> <span id="local_client_address_601"><span class="LIDENT">client_address</span></span> <span id="local_client_socket_602"><span class="LIDENT">client_socket</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <a href="../lwt/lwt.ml.html#module-Concurrent_composition.val-async"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">async</span></a> <span class="BEGIN">begin</span> <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="COMMENT">(* Not using Lwt.finalize here, to make sure that exceptions from [f]
         reach !Lwt.async_exception_hook before exceptions from closing the
         channels. *)</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Sequential_composition.val-catch"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">catch</span></a><span class="EOL">
</span>        <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_f_599"><span class="LIDENT">f</span></a> <a href="#local_client_address_601"><span class="LIDENT">client_address</span></a> <a href="#local_client_socket_602"><span class="LIDENT">client_socket</span></a><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_exn_603"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="../lwt/lwt.ml.html#module-Resolution_loop.val-async_exception_hook"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">async_exception_hook</span></a> <a href="#local_exn_603"><span class="LIDENT">exn</span></a><span class="SEMI">;</span><span class="EOL">
</span>          <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="IF">if</span> <a href="#local_no_close_597"><span class="LIDENT">no_close</span></a> <span class="THEN">then</span> <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="EOL">
</span>      <span class="ELSE">else</span><span class="EOL">
</span>        <span class="IF">if</span> <a href="lwt_unix.ml.html#val-state"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">state</span></a> <a href="#local_client_socket_602"><span class="LIDENT">client_socket</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="UIDENT">Closed</span> <span class="THEN">then</span><span class="EOL">
</span>          <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="EOL">
</span>        <span class="ELSE">else</span><span class="EOL">
</span>          <a href="../lwt/lwt.ml.html#module-Sequential_composition.val-catch"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">catch</span></a><span class="EOL">
</span>            <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">close_socket</span> <a href="#local_client_socket_602"><span class="LIDENT">client_socket</span></a><span class="RPAREN">)</span><span class="EOL">
</span>            <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_exn_604"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>              <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="../lwt/lwt.ml.html#module-Resolution_loop.val-async_exception_hook"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">async_exception_hook</span></a> <a href="#local_exn_604"><span class="LIDENT">exn</span></a><span class="SEMI">;</span><span class="EOL">
</span>              <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="END">end</span><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="def_697"><span id="local_server_605"><span class="LIDENT">server</span></span><span class="COMMA">,</span> <span id="local_server_started_606"><span class="LIDENT">server_started</span></span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">establish_server_generic</span><span class="EOL">
</span>      <a href="lwt_unix.ml.html#val-bind"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">bind</span></a> <span class="OPTLABEL">?fd:</span><a href="#local_server_fd_595"><span class="LIDENT">server_fd</span></a> <span class="QUESTION">?</span><a href="#local_backlog_596"><span class="LIDENT">backlog</span></a> <a href="#local_sockaddr_598"><span class="LIDENT">sockaddr</span></a> <a href="#local_handler_600"><span class="LIDENT">handler</span></a><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <a href="#local_server_started_606"><span class="LIDENT">server_started</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>  <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <a href="#local_server_605"><span class="LIDENT">server</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-establish_server_with_client_address_generic"><span class="LIDENT">establish_server_with_client_address_generic</span></span><span class="EOL">
</span>    <span id="local_bind_function_607"><span class="LIDENT">bind_function</span></span><span class="EOL">
</span>    <span class="QUESTION">?</span><span id="local_fd_608"><span class="LIDENT">fd</span></span><span class="EOL">
</span>    <span class="QUESTION">?</span><span class="LPAREN">(</span><span id="local_buffer_size_609"><span class="LIDENT">buffer_size</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><span class="LIDENT">default_buffer_size</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="QUESTION">?</span><span id="local_backlog_610"><span class="LIDENT">backlog</span></span><span class="EOL">
</span>    <span class="QUESTION">?</span><span class="LPAREN">(</span><span id="local_no_close_611"><span class="LIDENT">no_close</span></span> <span class="EQUAL">=</span> <span class="FALSE">false</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span id="local_sockaddr_612"><span class="LIDENT">sockaddr</span></span><span class="EOL">
</span>    <span id="local_handler_613"><span class="LIDENT">handler</span></span> <span class="EQUAL">=</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_best_effort_close_614"><span class="LIDENT">best_effort_close</span></span> <span id="local_channel_615"><span class="LIDENT">channel</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="COMMENT">(* First, check whether the channel is closed. f may have already tried to
       close the channel, received an exception, and handled it somehow. If so,
       trying to close the channel here will trigger the same exception, which
       will go to !Lwt.async_exception_hook, despite the user's efforts. *)</span><span class="EOL">
</span>    <span class="COMMENT">(* The Invalid state is not possible on the channel, because it was not
       created using Lwt_io.atomic. *)</span><span class="EOL">
</span>    <span class="IF">if</span> <span class="LIDENT">is_closed</span> <a href="#local_channel_615"><span class="LIDENT">channel</span></a> <span class="THEN">then</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="EOL">
</span>    <span class="ELSE">else</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Sequential_composition.val-catch"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">catch</span></a><span class="EOL">
</span>        <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">close</span> <a href="#local_channel_615"><span class="LIDENT">channel</span></a><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_exn_616"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="../lwt/lwt.ml.html#module-Resolution_loop.val-async_exception_hook"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">async_exception_hook</span></a> <a href="#local_exn_616"><span class="LIDENT">exn</span></a><span class="SEMI">;</span><span class="EOL">
</span>          <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_handler_617"><span class="LIDENT">handler</span></span> <span id="local_client_address_618"><span class="LIDENT">client_address</span></span> <span id="local_client_socket_619"><span class="LIDENT">client_socket</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <a href="../lwt/lwt.ml.html#module-Concurrent_composition.val-async"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">async</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_close_620"><span class="LIDENT">close</span></span> <span class="EQUAL">=</span> <span class="LAZY">lazy</span> <span class="LPAREN">(</span><span class="LIDENT">close_socket</span> <a href="#local_client_socket_619"><span class="LIDENT">client_socket</span></a><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_input_channel_621"><span class="LIDENT">input_channel</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>        <span class="LIDENT">of_fd</span><span class="EOL">
</span>          <span class="LABEL">~buffer:</span><span class="LPAREN">(</span><a href="lwt_bytes.ml.html#val-create"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">create</span></a> <a href="#local_buffer_size_609"><span class="LIDENT">buffer_size</span></a><span class="RPAREN">)</span><span class="EOL">
</span>          <span class="LABEL">~mode:</span><span class="LIDENT">input</span><span class="EOL">
</span>          <span class="LABEL">~close:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/lazy.ml.html#val-force"><span class="UIDENT">Lazy</span><span class="DOT">.</span><span class="LIDENT">force</span></a> <a href="#local_close_620"><span class="LIDENT">close</span></a><span class="RPAREN">)</span><span class="EOL">
</span>          <a href="#local_client_socket_619"><span class="LIDENT">client_socket</span></a><span class="EOL">
</span>      <span class="IN">in</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_output_channel_622"><span class="LIDENT">output_channel</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>        <span class="LIDENT">of_fd</span><span class="EOL">
</span>          <span class="LABEL">~buffer:</span><span class="LPAREN">(</span><a href="lwt_bytes.ml.html#val-create"><span class="UIDENT">Lwt_bytes</span><span class="DOT">.</span><span class="LIDENT">create</span></a> <a href="#local_buffer_size_609"><span class="LIDENT">buffer_size</span></a><span class="RPAREN">)</span><span class="EOL">
</span>          <span class="LABEL">~mode:</span><span class="LIDENT">output</span><span class="EOL">
</span>          <span class="LABEL">~close:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/lazy.ml.html#val-force"><span class="UIDENT">Lazy</span><span class="DOT">.</span><span class="LIDENT">force</span></a> <a href="#local_close_620"><span class="LIDENT">close</span></a><span class="RPAREN">)</span><span class="EOL">
</span>          <a href="#local_client_socket_619"><span class="LIDENT">client_socket</span></a><span class="EOL">
</span>      <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="COMMENT">(* Not using Lwt.finalize here, to make sure that exceptions from [f]
         reach !Lwt.async_exception_hook before exceptions from closing the
         channels. *)</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Sequential_composition.val-catch"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">catch</span></a><span class="EOL">
</span>        <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="#local_handler_613"><span class="LIDENT">handler</span></a> <a href="#local_client_address_618"><span class="LIDENT">client_address</span></a> <span class="LPAREN">(</span><a href="#local_input_channel_621"><span class="LIDENT">input_channel</span></a><span class="COMMA">,</span> <a href="#local_output_channel_622"><span class="LIDENT">output_channel</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_exn_623"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="../lwt/lwt.ml.html#module-Resolution_loop.val-async_exception_hook"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">async_exception_hook</span></a> <a href="#local_exn_623"><span class="LIDENT">exn</span></a><span class="SEMI">;</span><span class="EOL">
</span>          <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="IF">if</span> <a href="#local_no_close_611"><span class="LIDENT">no_close</span></a> <span class="THEN">then</span> <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="EOL">
</span>      <span class="ELSE">else</span><span class="EOL">
</span>        <a href="#local_best_effort_close_614"><span class="LIDENT">best_effort_close</span></a> <a href="#local_input_channel_621"><span class="LIDENT">input_channel</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <a href="#local_best_effort_close_614"><span class="LIDENT">best_effort_close</span></a> <a href="#local_output_channel_622"><span class="LIDENT">output_channel</span></a><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LIDENT">establish_server_generic</span> <a href="#local_bind_function_607"><span class="LIDENT">bind_function</span></a> <span class="QUESTION">?</span><a href="#local_fd_608"><span class="LIDENT">fd</span></a> <span class="QUESTION">?</span><a href="#local_backlog_610"><span class="LIDENT">backlog</span></a> <a href="#local_sockaddr_612"><span class="LIDENT">sockaddr</span></a> <a href="#local_handler_617"><span class="LIDENT">handler</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-establish_server_with_client_address"><span class="LIDENT">establish_server_with_client_address</span></span><span class="EOL">
</span>    <span class="QUESTION">?</span><span id="local_fd_624"><span class="LIDENT">fd</span></span> <span class="QUESTION">?</span><span id="local_buffer_size_625"><span class="LIDENT">buffer_size</span></span> <span class="QUESTION">?</span><span id="local_backlog_626"><span class="LIDENT">backlog</span></span> <span class="QUESTION">?</span><span id="local_no_close_627"><span class="LIDENT">no_close</span></span> <span id="local_sockaddr_628"><span class="LIDENT">sockaddr</span></span> <span id="local_handler_629"><span class="LIDENT">handler</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="def_684"><span id="local_server_630"><span class="LIDENT">server</span></span><span class="COMMA">,</span> <span id="local_server_started_631"><span class="LIDENT">server_started</span></span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">establish_server_with_client_address_generic</span><span class="EOL">
</span>      <a href="lwt_unix.ml.html#val-bind"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="LIDENT">bind</span></a> <span class="QUESTION">?</span><a href="#local_fd_624"><span class="LIDENT">fd</span></a> <span class="QUESTION">?</span><a href="#local_buffer_size_625"><span class="LIDENT">buffer_size</span></a> <span class="QUESTION">?</span><a href="#local_backlog_626"><span class="LIDENT">backlog</span></a> <span class="QUESTION">?</span><a href="#local_no_close_627"><span class="LIDENT">no_close</span></a> <a href="#local_sockaddr_628"><span class="LIDENT">sockaddr</span></a> <a href="#local_handler_629"><span class="LIDENT">handler</span></a><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <a href="#local_server_started_631"><span class="LIDENT">server_started</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>  <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <a href="#local_server_630"><span class="LIDENT">server</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-establish_server"><span class="LIDENT">establish_server</span></span> <span class="QUESTION">?</span><span id="local_fd_632"><span class="LIDENT">fd</span></span> <span class="QUESTION">?</span><span id="local_buffer_size_633"><span class="LIDENT">buffer_size</span></span> <span class="QUESTION">?</span><span id="local_backlog_634"><span class="LIDENT">backlog</span></span> <span class="QUESTION">?</span><span id="local_no_close_635"><span class="LIDENT">no_close</span></span> <span id="local_sockaddr_636"><span class="LIDENT">sockaddr</span></span> <span id="local_f_637"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_f_638"><span class="LIDENT">f</span></span> <span id="local__addr_639"><span class="LIDENT">_addr</span></span> <span id="local_c_640"><span class="LIDENT">c</span></span> <span class="EQUAL">=</span> <a href="#local_f_637"><span class="LIDENT">f</span></a> <a href="#local_c_640"><span class="LIDENT">c</span></a> <span class="IN">in</span><span class="EOL">
</span>  <span class="LIDENT">establish_server_with_client_address</span><span class="EOL">
</span>    <span class="QUESTION">?</span><a href="#local_fd_632"><span class="LIDENT">fd</span></a> <span class="QUESTION">?</span><a href="#local_buffer_size_633"><span class="LIDENT">buffer_size</span></a> <span class="QUESTION">?</span><a href="#local_backlog_634"><span class="LIDENT">backlog</span></a> <span class="QUESTION">?</span><a href="#local_no_close_635"><span class="LIDENT">no_close</span></a> <a href="#local_sockaddr_636"><span class="LIDENT">sockaddr</span></a> <a href="#local_f_638"><span class="LIDENT">f</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* Old, deprecated version of [establish_server]. This function has to persist
   for a while, in some form, until it is no longer exposed as
   [Lwt_io.Versioned.establish_server_1]. *)</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-establish_server_deprecated"><span class="LIDENT">establish_server_deprecated</span></span> <span class="QUESTION">?</span><span id="local_fd_641"><span class="LIDENT">fd</span></span> <span class="QUESTION">?</span><span id="local_buffer_size_642"><span class="LIDENT">buffer_size</span></span> <span class="QUESTION">?</span><span id="local_backlog_643"><span class="LIDENT">backlog</span></span> <span id="local_sockaddr_644"><span class="LIDENT">sockaddr</span></span> <span id="local_f_645"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_blocking_bind_646"><span class="LIDENT">blocking_bind</span></span> <span id="local_fd_647"><span class="LIDENT">fd</span></span> <span id="local_addr_648"><span class="LIDENT">addr</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <span class="LPAREN">(</span><a href="lwt_unix.ml.html#module-Versioned.val-bind_1"><span class="UIDENT">Lwt_unix</span><span class="DOT">.</span><span class="UIDENT">Versioned</span><span class="DOT">.</span><span class="LIDENT">bind_1</span></a> <a href="#local_fd_647"><span class="LIDENT">fd</span></a> <a href="#local_addr_648"><span class="LIDENT">addr</span></a><span class="RPAREN">)</span> <span class="LBRACKETAT">[@</span><span class="LIDENT">ocaml</span><span class="DOT">.</span><span class="LIDENT">warning</span> <span class="STRING">&quot;-3&quot;</span><span class="RBRACKET">]</span><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_f_649"><span class="LIDENT">f</span></span> <span id="local__addr_650"><span class="LIDENT">_addr</span></span> <span id="local_c_651"><span class="LIDENT">c</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <a href="#local_f_645"><span class="LIDENT">f</span></a> <a href="#local_c_651"><span class="LIDENT">c</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return_unit"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return_unit</span></a><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="def_694"><span id="local_server_652"><span class="LIDENT">server</span></span><span class="COMMA">,</span> <span id="local_server_started_653"><span class="LIDENT">server_started</span></span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">establish_server_with_client_address_generic</span><span class="EOL">
</span>      <a href="#local_blocking_bind_646"><span class="LIDENT">blocking_bind</span></a> <span class="QUESTION">?</span><a href="#local_fd_641"><span class="LIDENT">fd</span></a> <span class="QUESTION">?</span><a href="#local_buffer_size_642"><span class="LIDENT">buffer_size</span></a> <span class="QUESTION">?</span><a href="#local_backlog_643"><span class="LIDENT">backlog</span></a> <span class="LABEL">~no_close:</span><span class="TRUE">true</span> <a href="#local_sockaddr_644"><span class="LIDENT">sockaddr</span></a> <a href="#local_f_649"><span class="LIDENT">f</span></a><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Poll for exceptions in server startup that may have occurred synchronously.
     This emulates an old, deprecated behavior. *)</span><span class="EOL">
</span>  <a href="../lwt/lwt.ml.html#module-Concurrent_composition.val-ignore_result"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">ignore_result</span></a> <a href="#local_server_started_653"><span class="LIDENT">server_started</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <a href="#local_server_652"><span class="LIDENT">server</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-ignore_close"><span class="LIDENT">ignore_close</span></span> <span id="local_ch_654"><span class="LIDENT">ch</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a> <span class="LPAREN">(</span><span class="LIDENT">close</span> <a href="#local_ch_654"><span class="LIDENT">ch</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-make_stream"><span class="LIDENT">make_stream</span></span> <span id="local_f_655"><span class="LIDENT">f</span></span> <span id="local_lazy_ic_656"><span class="LIDENT">lazy_ic</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_lazy_ic_657"><span class="LIDENT">lazy_ic</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LAZY">lazy</span><span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/lazy.ml.html#val-force"><span class="UIDENT">Lazy</span><span class="DOT">.</span><span class="LIDENT">force</span></a> <a href="#local_lazy_ic_656"><span class="LIDENT">lazy_ic</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span id="local_ic_658"><span class="LIDENT">ic</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>         <a href="../../../ocaml-base-compiler/src/stdlib/gc.ml.html#val-finalise"><span class="UIDENT">Gc</span><span class="DOT">.</span><span class="LIDENT">finalise</span></a> <span class="LIDENT">ignore_close</span> <a href="#local_ic_658"><span class="LIDENT">ic</span></a><span class="SEMI">;</span><span class="EOL">
</span>         <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <a href="#local_ic_658"><span class="LIDENT">ic</span></a><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <a href="../lwt/lwt_stream.ml.html#val-from"><span class="UIDENT">Lwt_stream</span><span class="DOT">.</span><span class="LIDENT">from</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/lazy.ml.html#val-force"><span class="UIDENT">Lazy</span><span class="DOT">.</span><span class="LIDENT">force</span></a> <a href="#local_lazy_ic_657"><span class="LIDENT">lazy_ic</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span id="local_ic_659"><span class="LIDENT">ic</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="#local_f_655"><span class="LIDENT">f</span></a> <a href="#local_ic_659"><span class="LIDENT">ic</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span id="local_x_660"><span class="LIDENT">x</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_x_660"><span class="LIDENT">x</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="UIDENT">None</span> <span class="THEN">then</span><span class="EOL">
</span>      <span class="LIDENT">close</span> <a href="#local_ic_659"><span class="LIDENT">ic</span></a> <a href="../lwt/lwt.ml.html#module-Infix.val-(&gt;&gt;=)"><span class="INFIXOP0">&gt;&gt;=</span></a> <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <a href="#local_x_660"><span class="LIDENT">x</span></a><span class="EOL">
</span>    <span class="ELSE">else</span><span class="EOL">
</span>      <a href="../lwt/lwt.ml.html#module-Trivial_promises.val-return"><span class="UIDENT">Lwt</span><span class="DOT">.</span><span class="LIDENT">return</span></a> <a href="#local_x_660"><span class="LIDENT">x</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-lines_of_file"><span class="LIDENT">lines_of_file</span></span> <span id="local_filename_661"><span class="LIDENT">filename</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">make_stream</span> <span class="LIDENT">read_line_opt</span> <span class="LPAREN">(</span><span class="LAZY">lazy</span><span class="LPAREN">(</span><span class="LIDENT">open_file</span> <span class="LABEL">~mode:</span><span class="LIDENT">input</span> <a href="#local_filename_661"><span class="LIDENT">filename</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-lines_to_file"><span class="LIDENT">lines_to_file</span></span> <span id="local_filename_662"><span class="LIDENT">filename</span></span> <span id="local_lines_663"><span class="LIDENT">lines</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">with_file</span> <span class="LABEL">~mode:</span><span class="LIDENT">output</span> <a href="#local_filename_662"><span class="LIDENT">filename</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_oc_664"><span class="LIDENT">oc</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">write_lines</span> <a href="#local_oc_664"><span class="LIDENT">oc</span></a> <a href="#local_lines_663"><span class="LIDENT">lines</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-chars_of_file"><span class="LIDENT">chars_of_file</span></span> <span id="local_filename_665"><span class="LIDENT">filename</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">make_stream</span> <span class="LIDENT">read_char_opt</span> <span class="LPAREN">(</span><span class="LAZY">lazy</span><span class="LPAREN">(</span><span class="LIDENT">open_file</span> <span class="LABEL">~mode:</span><span class="LIDENT">input</span> <a href="#local_filename_665"><span class="LIDENT">filename</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-chars_to_file"><span class="LIDENT">chars_to_file</span></span> <span id="local_filename_666"><span class="LIDENT">filename</span></span> <span id="local_chars_667"><span class="LIDENT">chars</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">with_file</span> <span class="LABEL">~mode:</span><span class="LIDENT">output</span> <a href="#local_filename_666"><span class="LIDENT">filename</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_oc_668"><span class="LIDENT">oc</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">write_chars</span> <a href="#local_oc_668"><span class="LIDENT">oc</span></a> <a href="#local_chars_667"><span class="LIDENT">chars</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-hexdump_stream"><span class="LIDENT">hexdump_stream</span></span> <span id="local_oc_669"><span class="LIDENT">oc</span></span> <span id="local_stream_670"><span class="LIDENT">stream</span></span> <span class="EQUAL">=</span> <span class="LIDENT">write_lines</span> <a href="#local_oc_669"><span class="LIDENT">oc</span></a> <span class="LPAREN">(</span><a href="../lwt/lwt_stream.ml.html#val-hexdump"><span class="UIDENT">Lwt_stream</span><span class="DOT">.</span><span class="LIDENT">hexdump</span></a> <a href="#local_stream_670"><span class="LIDENT">stream</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-hexdump"><span class="LIDENT">hexdump</span></span> <span id="local_oc_671"><span class="LIDENT">oc</span></span> <span id="local_buf_672"><span class="LIDENT">buf</span></span> <span class="EQUAL">=</span> <span class="LIDENT">hexdump_stream</span> <a href="#local_oc_671"><span class="LIDENT">oc</span></a> <span class="LPAREN">(</span><a href="../lwt/lwt_stream.ml.html#val-of_string"><span class="UIDENT">Lwt_stream</span><span class="DOT">.</span><span class="LIDENT">of_string</span></a> <a href="#local_buf_672"><span class="LIDENT">buf</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-set_default_buffer_size"><span class="LIDENT">set_default_buffer_size</span></span> <span id="local_size_673"><span class="LIDENT">size</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">check_buffer_size</span> <span class="STRING">&quot;set_default_buffer_size&quot;</span> <a href="#local_size_673"><span class="LIDENT">size</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="LIDENT">default_buffer_size</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="#local_size_673"><span class="LIDENT">size</span></a><span class="EOL">
</span><span class="LET">let</span> <span id="val-default_buffer_size"><span class="LIDENT">default_buffer_size</span></span> <span class="UNDERSCORE">_</span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><span class="LIDENT">default_buffer_size</span><span class="EOL">
</span><span class="EOL">
</span><span id="module-Versioned"><span class="MODULE">module</span> <span class="UIDENT">Versioned</span> <span class="EQUAL">=</span><span class="EOL">
</span><span class="STRUCT">struct</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Versioned.val-establish_server_1"><span class="LIDENT">establish_server_1</span></span> <span class="EQUAL">=</span> <span class="LIDENT">establish_server_deprecated</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Versioned.val-establish_server_2"><span class="LIDENT">establish_server_2</span></span> <span class="EQUAL">=</span> <span class="LIDENT">establish_server</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Versioned.val-shutdown_server_1"><span class="LIDENT">shutdown_server_1</span></span> <span class="EQUAL">=</span> <span class="LIDENT">shutdown_server_deprecated</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Versioned.val-shutdown_server_2"><span class="LIDENT">shutdown_server_2</span></span> <span class="EQUAL">=</span> <span class="LIDENT">shutdown_server</span><span class="EOL">
</span><span class="END">end</span></span><span class="EOL">
</span></span></code></pre></body></html>
