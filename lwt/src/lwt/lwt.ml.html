<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Source: lwt.ml (lwt.src.lwt)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.css"/><meta name="generator" content="odoc %%VERSION%%"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/></head><body class="odoc-src"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">Lwt</a> &#x00BB; <a href="../index.html">Sources</a> &#x00BB; lwt &#x00BB; lwt.ml</nav><header class="odoc-preamble"><h1>Source file <code><span>lwt.ml</span></code></h1></header><div class="odoc-tocs"><nav class="odoc-toc odoc-global-toc"><ul><li><a href="../../index.html">Lwt</a><ul><li>Library <code>lwt</code><ul><li><a href="../../lwt/Lwt/index.html">Lwt</a></li><li><a href="../../lwt/Lwt_condition/index.html">Lwt_condition</a></li><li><a href="../../lwt/Lwt_list/index.html">Lwt_list</a></li><li><a href="../../lwt/Lwt_mutex/index.html">Lwt_mutex</a></li><li><a href="../../lwt/Lwt_mvar/index.html">Lwt_mvar</a></li><li><a href="../../lwt/Lwt_pool/index.html">Lwt_pool</a></li><li><a href="../../lwt/Lwt_pqueue/index.html">Lwt_pqueue</a></li><li><a href="../../lwt/Lwt_result/index.html">Lwt_result</a></li><li><a href="../../lwt/Lwt_seq/index.html">Lwt_seq</a></li><li><a href="../../lwt/Lwt_sequence/index.html">Lwt_sequence</a></li><li><a href="../../lwt/Lwt_stream/index.html">Lwt_stream</a></li><li><a href="../../lwt/Lwt_switch/index.html">Lwt_switch</a></li></ul></li><li>Library <code>lwt.unix</code><ul><li><a href="../../lwt.unix/Lwt_bytes/index.html">Lwt_bytes</a></li><li><a href="../../lwt.unix/Lwt_config/index.html">Lwt_config</a></li><li><a href="../../lwt.unix/Lwt_engine/index.html">Lwt_engine</a></li><li><a href="../../lwt.unix/Lwt_features/index.html">Lwt_features</a></li><li><a href="../../lwt.unix/Lwt_fmt/index.html">Lwt_fmt</a></li><li><a href="../../lwt.unix/Lwt_gc/index.html">Lwt_gc</a></li><li><a href="../../lwt.unix/Lwt_io/index.html">Lwt_io</a></li><li><a href="../../lwt.unix/Lwt_main/index.html">Lwt_main</a></li><li><a href="../../lwt.unix/Lwt_preemptive/index.html">Lwt_preemptive</a></li><li><a href="../../lwt.unix/Lwt_process/index.html">Lwt_process</a></li><li><a href="../../lwt.unix/Lwt_sys/index.html">Lwt_sys</a></li><li><a href="../../lwt.unix/Lwt_throttle/index.html">Lwt_throttle</a></li><li><a href="../../lwt.unix/Lwt_timeout/index.html">Lwt_timeout</a></li><li><a href="../../lwt.unix/Lwt_unix/index.html">Lwt_unix</a></li></ul></li><li><a href="../index.html">Sources</a><ul><li>lwt<ul><li><a href="#" class="current_unit">lwt.ml</a></li><li><a href="lwt_condition.ml.html">lwt_condition.ml</a></li><li><a href="lwt_list.ml.html">lwt_list.ml</a></li><li><a href="lwt_mutex.ml.html">lwt_mutex.ml</a></li><li><a href="lwt_mvar.ml.html">lwt_mvar.ml</a></li><li><a href="lwt_pool.ml.html">lwt_pool.ml</a></li><li><a href="lwt_pqueue.ml.html">lwt_pqueue.ml</a></li><li><a href="lwt_result.ml.html">lwt_result.ml</a></li><li><a href="lwt_seq.ml.html">lwt_seq.ml</a></li><li><a href="lwt_sequence.ml.html">lwt_sequence.ml</a></li><li><a href="lwt_stream.ml.html">lwt_stream.ml</a></li><li><a href="lwt_switch.ml.html">lwt_switch.ml</a></li></ul></li><li>lwt.unix<ul><li><a href="../lwt.unix/lwt_bytes.ml.html">lwt_bytes.ml</a></li><li><a href="../lwt.unix/lwt_config.ml.html">lwt_config.ml</a></li><li><a href="../lwt.unix/lwt_engine.ml.html">lwt_engine.ml</a></li><li><a href="../lwt.unix/lwt_features.ml.html">lwt_features.ml</a></li><li><a href="../lwt.unix/lwt_fmt.ml.html">lwt_fmt.ml</a></li><li><a href="../lwt.unix/lwt_gc.ml.html">lwt_gc.ml</a></li><li><a href="../lwt.unix/lwt_io.ml.html">lwt_io.ml</a></li><li><a href="../lwt.unix/lwt_main.ml.html">lwt_main.ml</a></li><li><a href="../lwt.unix/lwt_preemptive.ml.html">lwt_preemptive.ml</a></li><li><a href="../lwt.unix/lwt_process.ml.html">lwt_process.ml</a></li><li><a href="../lwt.unix/lwt_sys.ml.html">lwt_sys.ml</a></li><li><a href="../lwt.unix/lwt_throttle.ml.html">lwt_throttle.ml</a></li><li><a href="../lwt.unix/lwt_timeout.ml.html">lwt_timeout.ml</a></li><li><a href="../lwt.unix/lwt_unix.ml.html">lwt_unix.ml</a></li></ul></li></ul></li></ul></li></ul></nav></div><pre class="source_container"><code class="source_line_column"><a id="L1" class="source_line" href="#L1">1</a>
<a id="L2" class="source_line" href="#L2">2</a>
<a id="L3" class="source_line" href="#L3">3</a>
<a id="L4" class="source_line" href="#L4">4</a>
<a id="L5" class="source_line" href="#L5">5</a>
<a id="L6" class="source_line" href="#L6">6</a>
<a id="L7" class="source_line" href="#L7">7</a>
<a id="L8" class="source_line" href="#L8">8</a>
<a id="L9" class="source_line" href="#L9">9</a>
<a id="L10" class="source_line" href="#L10">10</a>
<a id="L11" class="source_line" href="#L11">11</a>
<a id="L12" class="source_line" href="#L12">12</a>
<a id="L13" class="source_line" href="#L13">13</a>
<a id="L14" class="source_line" href="#L14">14</a>
<a id="L15" class="source_line" href="#L15">15</a>
<a id="L16" class="source_line" href="#L16">16</a>
<a id="L17" class="source_line" href="#L17">17</a>
<a id="L18" class="source_line" href="#L18">18</a>
<a id="L19" class="source_line" href="#L19">19</a>
<a id="L20" class="source_line" href="#L20">20</a>
<a id="L21" class="source_line" href="#L21">21</a>
<a id="L22" class="source_line" href="#L22">22</a>
<a id="L23" class="source_line" href="#L23">23</a>
<a id="L24" class="source_line" href="#L24">24</a>
<a id="L25" class="source_line" href="#L25">25</a>
<a id="L26" class="source_line" href="#L26">26</a>
<a id="L27" class="source_line" href="#L27">27</a>
<a id="L28" class="source_line" href="#L28">28</a>
<a id="L29" class="source_line" href="#L29">29</a>
<a id="L30" class="source_line" href="#L30">30</a>
<a id="L31" class="source_line" href="#L31">31</a>
<a id="L32" class="source_line" href="#L32">32</a>
<a id="L33" class="source_line" href="#L33">33</a>
<a id="L34" class="source_line" href="#L34">34</a>
<a id="L35" class="source_line" href="#L35">35</a>
<a id="L36" class="source_line" href="#L36">36</a>
<a id="L37" class="source_line" href="#L37">37</a>
<a id="L38" class="source_line" href="#L38">38</a>
<a id="L39" class="source_line" href="#L39">39</a>
<a id="L40" class="source_line" href="#L40">40</a>
<a id="L41" class="source_line" href="#L41">41</a>
<a id="L42" class="source_line" href="#L42">42</a>
<a id="L43" class="source_line" href="#L43">43</a>
<a id="L44" class="source_line" href="#L44">44</a>
<a id="L45" class="source_line" href="#L45">45</a>
<a id="L46" class="source_line" href="#L46">46</a>
<a id="L47" class="source_line" href="#L47">47</a>
<a id="L48" class="source_line" href="#L48">48</a>
<a id="L49" class="source_line" href="#L49">49</a>
<a id="L50" class="source_line" href="#L50">50</a>
<a id="L51" class="source_line" href="#L51">51</a>
<a id="L52" class="source_line" href="#L52">52</a>
<a id="L53" class="source_line" href="#L53">53</a>
<a id="L54" class="source_line" href="#L54">54</a>
<a id="L55" class="source_line" href="#L55">55</a>
<a id="L56" class="source_line" href="#L56">56</a>
<a id="L57" class="source_line" href="#L57">57</a>
<a id="L58" class="source_line" href="#L58">58</a>
<a id="L59" class="source_line" href="#L59">59</a>
<a id="L60" class="source_line" href="#L60">60</a>
<a id="L61" class="source_line" href="#L61">61</a>
<a id="L62" class="source_line" href="#L62">62</a>
<a id="L63" class="source_line" href="#L63">63</a>
<a id="L64" class="source_line" href="#L64">64</a>
<a id="L65" class="source_line" href="#L65">65</a>
<a id="L66" class="source_line" href="#L66">66</a>
<a id="L67" class="source_line" href="#L67">67</a>
<a id="L68" class="source_line" href="#L68">68</a>
<a id="L69" class="source_line" href="#L69">69</a>
<a id="L70" class="source_line" href="#L70">70</a>
<a id="L71" class="source_line" href="#L71">71</a>
<a id="L72" class="source_line" href="#L72">72</a>
<a id="L73" class="source_line" href="#L73">73</a>
<a id="L74" class="source_line" href="#L74">74</a>
<a id="L75" class="source_line" href="#L75">75</a>
<a id="L76" class="source_line" href="#L76">76</a>
<a id="L77" class="source_line" href="#L77">77</a>
<a id="L78" class="source_line" href="#L78">78</a>
<a id="L79" class="source_line" href="#L79">79</a>
<a id="L80" class="source_line" href="#L80">80</a>
<a id="L81" class="source_line" href="#L81">81</a>
<a id="L82" class="source_line" href="#L82">82</a>
<a id="L83" class="source_line" href="#L83">83</a>
<a id="L84" class="source_line" href="#L84">84</a>
<a id="L85" class="source_line" href="#L85">85</a>
<a id="L86" class="source_line" href="#L86">86</a>
<a id="L87" class="source_line" href="#L87">87</a>
<a id="L88" class="source_line" href="#L88">88</a>
<a id="L89" class="source_line" href="#L89">89</a>
<a id="L90" class="source_line" href="#L90">90</a>
<a id="L91" class="source_line" href="#L91">91</a>
<a id="L92" class="source_line" href="#L92">92</a>
<a id="L93" class="source_line" href="#L93">93</a>
<a id="L94" class="source_line" href="#L94">94</a>
<a id="L95" class="source_line" href="#L95">95</a>
<a id="L96" class="source_line" href="#L96">96</a>
<a id="L97" class="source_line" href="#L97">97</a>
<a id="L98" class="source_line" href="#L98">98</a>
<a id="L99" class="source_line" href="#L99">99</a>
<a id="L100" class="source_line" href="#L100">100</a>
<a id="L101" class="source_line" href="#L101">101</a>
<a id="L102" class="source_line" href="#L102">102</a>
<a id="L103" class="source_line" href="#L103">103</a>
<a id="L104" class="source_line" href="#L104">104</a>
<a id="L105" class="source_line" href="#L105">105</a>
<a id="L106" class="source_line" href="#L106">106</a>
<a id="L107" class="source_line" href="#L107">107</a>
<a id="L108" class="source_line" href="#L108">108</a>
<a id="L109" class="source_line" href="#L109">109</a>
<a id="L110" class="source_line" href="#L110">110</a>
<a id="L111" class="source_line" href="#L111">111</a>
<a id="L112" class="source_line" href="#L112">112</a>
<a id="L113" class="source_line" href="#L113">113</a>
<a id="L114" class="source_line" href="#L114">114</a>
<a id="L115" class="source_line" href="#L115">115</a>
<a id="L116" class="source_line" href="#L116">116</a>
<a id="L117" class="source_line" href="#L117">117</a>
<a id="L118" class="source_line" href="#L118">118</a>
<a id="L119" class="source_line" href="#L119">119</a>
<a id="L120" class="source_line" href="#L120">120</a>
<a id="L121" class="source_line" href="#L121">121</a>
<a id="L122" class="source_line" href="#L122">122</a>
<a id="L123" class="source_line" href="#L123">123</a>
<a id="L124" class="source_line" href="#L124">124</a>
<a id="L125" class="source_line" href="#L125">125</a>
<a id="L126" class="source_line" href="#L126">126</a>
<a id="L127" class="source_line" href="#L127">127</a>
<a id="L128" class="source_line" href="#L128">128</a>
<a id="L129" class="source_line" href="#L129">129</a>
<a id="L130" class="source_line" href="#L130">130</a>
<a id="L131" class="source_line" href="#L131">131</a>
<a id="L132" class="source_line" href="#L132">132</a>
<a id="L133" class="source_line" href="#L133">133</a>
<a id="L134" class="source_line" href="#L134">134</a>
<a id="L135" class="source_line" href="#L135">135</a>
<a id="L136" class="source_line" href="#L136">136</a>
<a id="L137" class="source_line" href="#L137">137</a>
<a id="L138" class="source_line" href="#L138">138</a>
<a id="L139" class="source_line" href="#L139">139</a>
<a id="L140" class="source_line" href="#L140">140</a>
<a id="L141" class="source_line" href="#L141">141</a>
<a id="L142" class="source_line" href="#L142">142</a>
<a id="L143" class="source_line" href="#L143">143</a>
<a id="L144" class="source_line" href="#L144">144</a>
<a id="L145" class="source_line" href="#L145">145</a>
<a id="L146" class="source_line" href="#L146">146</a>
<a id="L147" class="source_line" href="#L147">147</a>
<a id="L148" class="source_line" href="#L148">148</a>
<a id="L149" class="source_line" href="#L149">149</a>
<a id="L150" class="source_line" href="#L150">150</a>
<a id="L151" class="source_line" href="#L151">151</a>
<a id="L152" class="source_line" href="#L152">152</a>
<a id="L153" class="source_line" href="#L153">153</a>
<a id="L154" class="source_line" href="#L154">154</a>
<a id="L155" class="source_line" href="#L155">155</a>
<a id="L156" class="source_line" href="#L156">156</a>
<a id="L157" class="source_line" href="#L157">157</a>
<a id="L158" class="source_line" href="#L158">158</a>
<a id="L159" class="source_line" href="#L159">159</a>
<a id="L160" class="source_line" href="#L160">160</a>
<a id="L161" class="source_line" href="#L161">161</a>
<a id="L162" class="source_line" href="#L162">162</a>
<a id="L163" class="source_line" href="#L163">163</a>
<a id="L164" class="source_line" href="#L164">164</a>
<a id="L165" class="source_line" href="#L165">165</a>
<a id="L166" class="source_line" href="#L166">166</a>
<a id="L167" class="source_line" href="#L167">167</a>
<a id="L168" class="source_line" href="#L168">168</a>
<a id="L169" class="source_line" href="#L169">169</a>
<a id="L170" class="source_line" href="#L170">170</a>
<a id="L171" class="source_line" href="#L171">171</a>
<a id="L172" class="source_line" href="#L172">172</a>
<a id="L173" class="source_line" href="#L173">173</a>
<a id="L174" class="source_line" href="#L174">174</a>
<a id="L175" class="source_line" href="#L175">175</a>
<a id="L176" class="source_line" href="#L176">176</a>
<a id="L177" class="source_line" href="#L177">177</a>
<a id="L178" class="source_line" href="#L178">178</a>
<a id="L179" class="source_line" href="#L179">179</a>
<a id="L180" class="source_line" href="#L180">180</a>
<a id="L181" class="source_line" href="#L181">181</a>
<a id="L182" class="source_line" href="#L182">182</a>
<a id="L183" class="source_line" href="#L183">183</a>
<a id="L184" class="source_line" href="#L184">184</a>
<a id="L185" class="source_line" href="#L185">185</a>
<a id="L186" class="source_line" href="#L186">186</a>
<a id="L187" class="source_line" href="#L187">187</a>
<a id="L188" class="source_line" href="#L188">188</a>
<a id="L189" class="source_line" href="#L189">189</a>
<a id="L190" class="source_line" href="#L190">190</a>
<a id="L191" class="source_line" href="#L191">191</a>
<a id="L192" class="source_line" href="#L192">192</a>
<a id="L193" class="source_line" href="#L193">193</a>
<a id="L194" class="source_line" href="#L194">194</a>
<a id="L195" class="source_line" href="#L195">195</a>
<a id="L196" class="source_line" href="#L196">196</a>
<a id="L197" class="source_line" href="#L197">197</a>
<a id="L198" class="source_line" href="#L198">198</a>
<a id="L199" class="source_line" href="#L199">199</a>
<a id="L200" class="source_line" href="#L200">200</a>
<a id="L201" class="source_line" href="#L201">201</a>
<a id="L202" class="source_line" href="#L202">202</a>
<a id="L203" class="source_line" href="#L203">203</a>
<a id="L204" class="source_line" href="#L204">204</a>
<a id="L205" class="source_line" href="#L205">205</a>
<a id="L206" class="source_line" href="#L206">206</a>
<a id="L207" class="source_line" href="#L207">207</a>
<a id="L208" class="source_line" href="#L208">208</a>
<a id="L209" class="source_line" href="#L209">209</a>
<a id="L210" class="source_line" href="#L210">210</a>
<a id="L211" class="source_line" href="#L211">211</a>
<a id="L212" class="source_line" href="#L212">212</a>
<a id="L213" class="source_line" href="#L213">213</a>
<a id="L214" class="source_line" href="#L214">214</a>
<a id="L215" class="source_line" href="#L215">215</a>
<a id="L216" class="source_line" href="#L216">216</a>
<a id="L217" class="source_line" href="#L217">217</a>
<a id="L218" class="source_line" href="#L218">218</a>
<a id="L219" class="source_line" href="#L219">219</a>
<a id="L220" class="source_line" href="#L220">220</a>
<a id="L221" class="source_line" href="#L221">221</a>
<a id="L222" class="source_line" href="#L222">222</a>
<a id="L223" class="source_line" href="#L223">223</a>
<a id="L224" class="source_line" href="#L224">224</a>
<a id="L225" class="source_line" href="#L225">225</a>
<a id="L226" class="source_line" href="#L226">226</a>
<a id="L227" class="source_line" href="#L227">227</a>
<a id="L228" class="source_line" href="#L228">228</a>
<a id="L229" class="source_line" href="#L229">229</a>
<a id="L230" class="source_line" href="#L230">230</a>
<a id="L231" class="source_line" href="#L231">231</a>
<a id="L232" class="source_line" href="#L232">232</a>
<a id="L233" class="source_line" href="#L233">233</a>
<a id="L234" class="source_line" href="#L234">234</a>
<a id="L235" class="source_line" href="#L235">235</a>
<a id="L236" class="source_line" href="#L236">236</a>
<a id="L237" class="source_line" href="#L237">237</a>
<a id="L238" class="source_line" href="#L238">238</a>
<a id="L239" class="source_line" href="#L239">239</a>
<a id="L240" class="source_line" href="#L240">240</a>
<a id="L241" class="source_line" href="#L241">241</a>
<a id="L242" class="source_line" href="#L242">242</a>
<a id="L243" class="source_line" href="#L243">243</a>
<a id="L244" class="source_line" href="#L244">244</a>
<a id="L245" class="source_line" href="#L245">245</a>
<a id="L246" class="source_line" href="#L246">246</a>
<a id="L247" class="source_line" href="#L247">247</a>
<a id="L248" class="source_line" href="#L248">248</a>
<a id="L249" class="source_line" href="#L249">249</a>
<a id="L250" class="source_line" href="#L250">250</a>
<a id="L251" class="source_line" href="#L251">251</a>
<a id="L252" class="source_line" href="#L252">252</a>
<a id="L253" class="source_line" href="#L253">253</a>
<a id="L254" class="source_line" href="#L254">254</a>
<a id="L255" class="source_line" href="#L255">255</a>
<a id="L256" class="source_line" href="#L256">256</a>
<a id="L257" class="source_line" href="#L257">257</a>
<a id="L258" class="source_line" href="#L258">258</a>
<a id="L259" class="source_line" href="#L259">259</a>
<a id="L260" class="source_line" href="#L260">260</a>
<a id="L261" class="source_line" href="#L261">261</a>
<a id="L262" class="source_line" href="#L262">262</a>
<a id="L263" class="source_line" href="#L263">263</a>
<a id="L264" class="source_line" href="#L264">264</a>
<a id="L265" class="source_line" href="#L265">265</a>
<a id="L266" class="source_line" href="#L266">266</a>
<a id="L267" class="source_line" href="#L267">267</a>
<a id="L268" class="source_line" href="#L268">268</a>
<a id="L269" class="source_line" href="#L269">269</a>
<a id="L270" class="source_line" href="#L270">270</a>
<a id="L271" class="source_line" href="#L271">271</a>
<a id="L272" class="source_line" href="#L272">272</a>
<a id="L273" class="source_line" href="#L273">273</a>
<a id="L274" class="source_line" href="#L274">274</a>
<a id="L275" class="source_line" href="#L275">275</a>
<a id="L276" class="source_line" href="#L276">276</a>
<a id="L277" class="source_line" href="#L277">277</a>
<a id="L278" class="source_line" href="#L278">278</a>
<a id="L279" class="source_line" href="#L279">279</a>
<a id="L280" class="source_line" href="#L280">280</a>
<a id="L281" class="source_line" href="#L281">281</a>
<a id="L282" class="source_line" href="#L282">282</a>
<a id="L283" class="source_line" href="#L283">283</a>
<a id="L284" class="source_line" href="#L284">284</a>
<a id="L285" class="source_line" href="#L285">285</a>
<a id="L286" class="source_line" href="#L286">286</a>
<a id="L287" class="source_line" href="#L287">287</a>
<a id="L288" class="source_line" href="#L288">288</a>
<a id="L289" class="source_line" href="#L289">289</a>
<a id="L290" class="source_line" href="#L290">290</a>
<a id="L291" class="source_line" href="#L291">291</a>
<a id="L292" class="source_line" href="#L292">292</a>
<a id="L293" class="source_line" href="#L293">293</a>
<a id="L294" class="source_line" href="#L294">294</a>
<a id="L295" class="source_line" href="#L295">295</a>
<a id="L296" class="source_line" href="#L296">296</a>
<a id="L297" class="source_line" href="#L297">297</a>
<a id="L298" class="source_line" href="#L298">298</a>
<a id="L299" class="source_line" href="#L299">299</a>
<a id="L300" class="source_line" href="#L300">300</a>
<a id="L301" class="source_line" href="#L301">301</a>
<a id="L302" class="source_line" href="#L302">302</a>
<a id="L303" class="source_line" href="#L303">303</a>
<a id="L304" class="source_line" href="#L304">304</a>
<a id="L305" class="source_line" href="#L305">305</a>
<a id="L306" class="source_line" href="#L306">306</a>
<a id="L307" class="source_line" href="#L307">307</a>
<a id="L308" class="source_line" href="#L308">308</a>
<a id="L309" class="source_line" href="#L309">309</a>
<a id="L310" class="source_line" href="#L310">310</a>
<a id="L311" class="source_line" href="#L311">311</a>
<a id="L312" class="source_line" href="#L312">312</a>
<a id="L313" class="source_line" href="#L313">313</a>
<a id="L314" class="source_line" href="#L314">314</a>
<a id="L315" class="source_line" href="#L315">315</a>
<a id="L316" class="source_line" href="#L316">316</a>
<a id="L317" class="source_line" href="#L317">317</a>
<a id="L318" class="source_line" href="#L318">318</a>
<a id="L319" class="source_line" href="#L319">319</a>
<a id="L320" class="source_line" href="#L320">320</a>
<a id="L321" class="source_line" href="#L321">321</a>
<a id="L322" class="source_line" href="#L322">322</a>
<a id="L323" class="source_line" href="#L323">323</a>
<a id="L324" class="source_line" href="#L324">324</a>
<a id="L325" class="source_line" href="#L325">325</a>
<a id="L326" class="source_line" href="#L326">326</a>
<a id="L327" class="source_line" href="#L327">327</a>
<a id="L328" class="source_line" href="#L328">328</a>
<a id="L329" class="source_line" href="#L329">329</a>
<a id="L330" class="source_line" href="#L330">330</a>
<a id="L331" class="source_line" href="#L331">331</a>
<a id="L332" class="source_line" href="#L332">332</a>
<a id="L333" class="source_line" href="#L333">333</a>
<a id="L334" class="source_line" href="#L334">334</a>
<a id="L335" class="source_line" href="#L335">335</a>
<a id="L336" class="source_line" href="#L336">336</a>
<a id="L337" class="source_line" href="#L337">337</a>
<a id="L338" class="source_line" href="#L338">338</a>
<a id="L339" class="source_line" href="#L339">339</a>
<a id="L340" class="source_line" href="#L340">340</a>
<a id="L341" class="source_line" href="#L341">341</a>
<a id="L342" class="source_line" href="#L342">342</a>
<a id="L343" class="source_line" href="#L343">343</a>
<a id="L344" class="source_line" href="#L344">344</a>
<a id="L345" class="source_line" href="#L345">345</a>
<a id="L346" class="source_line" href="#L346">346</a>
<a id="L347" class="source_line" href="#L347">347</a>
<a id="L348" class="source_line" href="#L348">348</a>
<a id="L349" class="source_line" href="#L349">349</a>
<a id="L350" class="source_line" href="#L350">350</a>
<a id="L351" class="source_line" href="#L351">351</a>
<a id="L352" class="source_line" href="#L352">352</a>
<a id="L353" class="source_line" href="#L353">353</a>
<a id="L354" class="source_line" href="#L354">354</a>
<a id="L355" class="source_line" href="#L355">355</a>
<a id="L356" class="source_line" href="#L356">356</a>
<a id="L357" class="source_line" href="#L357">357</a>
<a id="L358" class="source_line" href="#L358">358</a>
<a id="L359" class="source_line" href="#L359">359</a>
<a id="L360" class="source_line" href="#L360">360</a>
<a id="L361" class="source_line" href="#L361">361</a>
<a id="L362" class="source_line" href="#L362">362</a>
<a id="L363" class="source_line" href="#L363">363</a>
<a id="L364" class="source_line" href="#L364">364</a>
<a id="L365" class="source_line" href="#L365">365</a>
<a id="L366" class="source_line" href="#L366">366</a>
<a id="L367" class="source_line" href="#L367">367</a>
<a id="L368" class="source_line" href="#L368">368</a>
<a id="L369" class="source_line" href="#L369">369</a>
<a id="L370" class="source_line" href="#L370">370</a>
<a id="L371" class="source_line" href="#L371">371</a>
<a id="L372" class="source_line" href="#L372">372</a>
<a id="L373" class="source_line" href="#L373">373</a>
<a id="L374" class="source_line" href="#L374">374</a>
<a id="L375" class="source_line" href="#L375">375</a>
<a id="L376" class="source_line" href="#L376">376</a>
<a id="L377" class="source_line" href="#L377">377</a>
<a id="L378" class="source_line" href="#L378">378</a>
<a id="L379" class="source_line" href="#L379">379</a>
<a id="L380" class="source_line" href="#L380">380</a>
<a id="L381" class="source_line" href="#L381">381</a>
<a id="L382" class="source_line" href="#L382">382</a>
<a id="L383" class="source_line" href="#L383">383</a>
<a id="L384" class="source_line" href="#L384">384</a>
<a id="L385" class="source_line" href="#L385">385</a>
<a id="L386" class="source_line" href="#L386">386</a>
<a id="L387" class="source_line" href="#L387">387</a>
<a id="L388" class="source_line" href="#L388">388</a>
<a id="L389" class="source_line" href="#L389">389</a>
<a id="L390" class="source_line" href="#L390">390</a>
<a id="L391" class="source_line" href="#L391">391</a>
<a id="L392" class="source_line" href="#L392">392</a>
<a id="L393" class="source_line" href="#L393">393</a>
<a id="L394" class="source_line" href="#L394">394</a>
<a id="L395" class="source_line" href="#L395">395</a>
<a id="L396" class="source_line" href="#L396">396</a>
<a id="L397" class="source_line" href="#L397">397</a>
<a id="L398" class="source_line" href="#L398">398</a>
<a id="L399" class="source_line" href="#L399">399</a>
<a id="L400" class="source_line" href="#L400">400</a>
<a id="L401" class="source_line" href="#L401">401</a>
<a id="L402" class="source_line" href="#L402">402</a>
<a id="L403" class="source_line" href="#L403">403</a>
<a id="L404" class="source_line" href="#L404">404</a>
<a id="L405" class="source_line" href="#L405">405</a>
<a id="L406" class="source_line" href="#L406">406</a>
<a id="L407" class="source_line" href="#L407">407</a>
<a id="L408" class="source_line" href="#L408">408</a>
<a id="L409" class="source_line" href="#L409">409</a>
<a id="L410" class="source_line" href="#L410">410</a>
<a id="L411" class="source_line" href="#L411">411</a>
<a id="L412" class="source_line" href="#L412">412</a>
<a id="L413" class="source_line" href="#L413">413</a>
<a id="L414" class="source_line" href="#L414">414</a>
<a id="L415" class="source_line" href="#L415">415</a>
<a id="L416" class="source_line" href="#L416">416</a>
<a id="L417" class="source_line" href="#L417">417</a>
<a id="L418" class="source_line" href="#L418">418</a>
<a id="L419" class="source_line" href="#L419">419</a>
<a id="L420" class="source_line" href="#L420">420</a>
<a id="L421" class="source_line" href="#L421">421</a>
<a id="L422" class="source_line" href="#L422">422</a>
<a id="L423" class="source_line" href="#L423">423</a>
<a id="L424" class="source_line" href="#L424">424</a>
<a id="L425" class="source_line" href="#L425">425</a>
<a id="L426" class="source_line" href="#L426">426</a>
<a id="L427" class="source_line" href="#L427">427</a>
<a id="L428" class="source_line" href="#L428">428</a>
<a id="L429" class="source_line" href="#L429">429</a>
<a id="L430" class="source_line" href="#L430">430</a>
<a id="L431" class="source_line" href="#L431">431</a>
<a id="L432" class="source_line" href="#L432">432</a>
<a id="L433" class="source_line" href="#L433">433</a>
<a id="L434" class="source_line" href="#L434">434</a>
<a id="L435" class="source_line" href="#L435">435</a>
<a id="L436" class="source_line" href="#L436">436</a>
<a id="L437" class="source_line" href="#L437">437</a>
<a id="L438" class="source_line" href="#L438">438</a>
<a id="L439" class="source_line" href="#L439">439</a>
<a id="L440" class="source_line" href="#L440">440</a>
<a id="L441" class="source_line" href="#L441">441</a>
<a id="L442" class="source_line" href="#L442">442</a>
<a id="L443" class="source_line" href="#L443">443</a>
<a id="L444" class="source_line" href="#L444">444</a>
<a id="L445" class="source_line" href="#L445">445</a>
<a id="L446" class="source_line" href="#L446">446</a>
<a id="L447" class="source_line" href="#L447">447</a>
<a id="L448" class="source_line" href="#L448">448</a>
<a id="L449" class="source_line" href="#L449">449</a>
<a id="L450" class="source_line" href="#L450">450</a>
<a id="L451" class="source_line" href="#L451">451</a>
<a id="L452" class="source_line" href="#L452">452</a>
<a id="L453" class="source_line" href="#L453">453</a>
<a id="L454" class="source_line" href="#L454">454</a>
<a id="L455" class="source_line" href="#L455">455</a>
<a id="L456" class="source_line" href="#L456">456</a>
<a id="L457" class="source_line" href="#L457">457</a>
<a id="L458" class="source_line" href="#L458">458</a>
<a id="L459" class="source_line" href="#L459">459</a>
<a id="L460" class="source_line" href="#L460">460</a>
<a id="L461" class="source_line" href="#L461">461</a>
<a id="L462" class="source_line" href="#L462">462</a>
<a id="L463" class="source_line" href="#L463">463</a>
<a id="L464" class="source_line" href="#L464">464</a>
<a id="L465" class="source_line" href="#L465">465</a>
<a id="L466" class="source_line" href="#L466">466</a>
<a id="L467" class="source_line" href="#L467">467</a>
<a id="L468" class="source_line" href="#L468">468</a>
<a id="L469" class="source_line" href="#L469">469</a>
<a id="L470" class="source_line" href="#L470">470</a>
<a id="L471" class="source_line" href="#L471">471</a>
<a id="L472" class="source_line" href="#L472">472</a>
<a id="L473" class="source_line" href="#L473">473</a>
<a id="L474" class="source_line" href="#L474">474</a>
<a id="L475" class="source_line" href="#L475">475</a>
<a id="L476" class="source_line" href="#L476">476</a>
<a id="L477" class="source_line" href="#L477">477</a>
<a id="L478" class="source_line" href="#L478">478</a>
<a id="L479" class="source_line" href="#L479">479</a>
<a id="L480" class="source_line" href="#L480">480</a>
<a id="L481" class="source_line" href="#L481">481</a>
<a id="L482" class="source_line" href="#L482">482</a>
<a id="L483" class="source_line" href="#L483">483</a>
<a id="L484" class="source_line" href="#L484">484</a>
<a id="L485" class="source_line" href="#L485">485</a>
<a id="L486" class="source_line" href="#L486">486</a>
<a id="L487" class="source_line" href="#L487">487</a>
<a id="L488" class="source_line" href="#L488">488</a>
<a id="L489" class="source_line" href="#L489">489</a>
<a id="L490" class="source_line" href="#L490">490</a>
<a id="L491" class="source_line" href="#L491">491</a>
<a id="L492" class="source_line" href="#L492">492</a>
<a id="L493" class="source_line" href="#L493">493</a>
<a id="L494" class="source_line" href="#L494">494</a>
<a id="L495" class="source_line" href="#L495">495</a>
<a id="L496" class="source_line" href="#L496">496</a>
<a id="L497" class="source_line" href="#L497">497</a>
<a id="L498" class="source_line" href="#L498">498</a>
<a id="L499" class="source_line" href="#L499">499</a>
<a id="L500" class="source_line" href="#L500">500</a>
<a id="L501" class="source_line" href="#L501">501</a>
<a id="L502" class="source_line" href="#L502">502</a>
<a id="L503" class="source_line" href="#L503">503</a>
<a id="L504" class="source_line" href="#L504">504</a>
<a id="L505" class="source_line" href="#L505">505</a>
<a id="L506" class="source_line" href="#L506">506</a>
<a id="L507" class="source_line" href="#L507">507</a>
<a id="L508" class="source_line" href="#L508">508</a>
<a id="L509" class="source_line" href="#L509">509</a>
<a id="L510" class="source_line" href="#L510">510</a>
<a id="L511" class="source_line" href="#L511">511</a>
<a id="L512" class="source_line" href="#L512">512</a>
<a id="L513" class="source_line" href="#L513">513</a>
<a id="L514" class="source_line" href="#L514">514</a>
<a id="L515" class="source_line" href="#L515">515</a>
<a id="L516" class="source_line" href="#L516">516</a>
<a id="L517" class="source_line" href="#L517">517</a>
<a id="L518" class="source_line" href="#L518">518</a>
<a id="L519" class="source_line" href="#L519">519</a>
<a id="L520" class="source_line" href="#L520">520</a>
<a id="L521" class="source_line" href="#L521">521</a>
<a id="L522" class="source_line" href="#L522">522</a>
<a id="L523" class="source_line" href="#L523">523</a>
<a id="L524" class="source_line" href="#L524">524</a>
<a id="L525" class="source_line" href="#L525">525</a>
<a id="L526" class="source_line" href="#L526">526</a>
<a id="L527" class="source_line" href="#L527">527</a>
<a id="L528" class="source_line" href="#L528">528</a>
<a id="L529" class="source_line" href="#L529">529</a>
<a id="L530" class="source_line" href="#L530">530</a>
<a id="L531" class="source_line" href="#L531">531</a>
<a id="L532" class="source_line" href="#L532">532</a>
<a id="L533" class="source_line" href="#L533">533</a>
<a id="L534" class="source_line" href="#L534">534</a>
<a id="L535" class="source_line" href="#L535">535</a>
<a id="L536" class="source_line" href="#L536">536</a>
<a id="L537" class="source_line" href="#L537">537</a>
<a id="L538" class="source_line" href="#L538">538</a>
<a id="L539" class="source_line" href="#L539">539</a>
<a id="L540" class="source_line" href="#L540">540</a>
<a id="L541" class="source_line" href="#L541">541</a>
<a id="L542" class="source_line" href="#L542">542</a>
<a id="L543" class="source_line" href="#L543">543</a>
<a id="L544" class="source_line" href="#L544">544</a>
<a id="L545" class="source_line" href="#L545">545</a>
<a id="L546" class="source_line" href="#L546">546</a>
<a id="L547" class="source_line" href="#L547">547</a>
<a id="L548" class="source_line" href="#L548">548</a>
<a id="L549" class="source_line" href="#L549">549</a>
<a id="L550" class="source_line" href="#L550">550</a>
<a id="L551" class="source_line" href="#L551">551</a>
<a id="L552" class="source_line" href="#L552">552</a>
<a id="L553" class="source_line" href="#L553">553</a>
<a id="L554" class="source_line" href="#L554">554</a>
<a id="L555" class="source_line" href="#L555">555</a>
<a id="L556" class="source_line" href="#L556">556</a>
<a id="L557" class="source_line" href="#L557">557</a>
<a id="L558" class="source_line" href="#L558">558</a>
<a id="L559" class="source_line" href="#L559">559</a>
<a id="L560" class="source_line" href="#L560">560</a>
<a id="L561" class="source_line" href="#L561">561</a>
<a id="L562" class="source_line" href="#L562">562</a>
<a id="L563" class="source_line" href="#L563">563</a>
<a id="L564" class="source_line" href="#L564">564</a>
<a id="L565" class="source_line" href="#L565">565</a>
<a id="L566" class="source_line" href="#L566">566</a>
<a id="L567" class="source_line" href="#L567">567</a>
<a id="L568" class="source_line" href="#L568">568</a>
<a id="L569" class="source_line" href="#L569">569</a>
<a id="L570" class="source_line" href="#L570">570</a>
<a id="L571" class="source_line" href="#L571">571</a>
<a id="L572" class="source_line" href="#L572">572</a>
<a id="L573" class="source_line" href="#L573">573</a>
<a id="L574" class="source_line" href="#L574">574</a>
<a id="L575" class="source_line" href="#L575">575</a>
<a id="L576" class="source_line" href="#L576">576</a>
<a id="L577" class="source_line" href="#L577">577</a>
<a id="L578" class="source_line" href="#L578">578</a>
<a id="L579" class="source_line" href="#L579">579</a>
<a id="L580" class="source_line" href="#L580">580</a>
<a id="L581" class="source_line" href="#L581">581</a>
<a id="L582" class="source_line" href="#L582">582</a>
<a id="L583" class="source_line" href="#L583">583</a>
<a id="L584" class="source_line" href="#L584">584</a>
<a id="L585" class="source_line" href="#L585">585</a>
<a id="L586" class="source_line" href="#L586">586</a>
<a id="L587" class="source_line" href="#L587">587</a>
<a id="L588" class="source_line" href="#L588">588</a>
<a id="L589" class="source_line" href="#L589">589</a>
<a id="L590" class="source_line" href="#L590">590</a>
<a id="L591" class="source_line" href="#L591">591</a>
<a id="L592" class="source_line" href="#L592">592</a>
<a id="L593" class="source_line" href="#L593">593</a>
<a id="L594" class="source_line" href="#L594">594</a>
<a id="L595" class="source_line" href="#L595">595</a>
<a id="L596" class="source_line" href="#L596">596</a>
<a id="L597" class="source_line" href="#L597">597</a>
<a id="L598" class="source_line" href="#L598">598</a>
<a id="L599" class="source_line" href="#L599">599</a>
<a id="L600" class="source_line" href="#L600">600</a>
<a id="L601" class="source_line" href="#L601">601</a>
<a id="L602" class="source_line" href="#L602">602</a>
<a id="L603" class="source_line" href="#L603">603</a>
<a id="L604" class="source_line" href="#L604">604</a>
<a id="L605" class="source_line" href="#L605">605</a>
<a id="L606" class="source_line" href="#L606">606</a>
<a id="L607" class="source_line" href="#L607">607</a>
<a id="L608" class="source_line" href="#L608">608</a>
<a id="L609" class="source_line" href="#L609">609</a>
<a id="L610" class="source_line" href="#L610">610</a>
<a id="L611" class="source_line" href="#L611">611</a>
<a id="L612" class="source_line" href="#L612">612</a>
<a id="L613" class="source_line" href="#L613">613</a>
<a id="L614" class="source_line" href="#L614">614</a>
<a id="L615" class="source_line" href="#L615">615</a>
<a id="L616" class="source_line" href="#L616">616</a>
<a id="L617" class="source_line" href="#L617">617</a>
<a id="L618" class="source_line" href="#L618">618</a>
<a id="L619" class="source_line" href="#L619">619</a>
<a id="L620" class="source_line" href="#L620">620</a>
<a id="L621" class="source_line" href="#L621">621</a>
<a id="L622" class="source_line" href="#L622">622</a>
<a id="L623" class="source_line" href="#L623">623</a>
<a id="L624" class="source_line" href="#L624">624</a>
<a id="L625" class="source_line" href="#L625">625</a>
<a id="L626" class="source_line" href="#L626">626</a>
<a id="L627" class="source_line" href="#L627">627</a>
<a id="L628" class="source_line" href="#L628">628</a>
<a id="L629" class="source_line" href="#L629">629</a>
<a id="L630" class="source_line" href="#L630">630</a>
<a id="L631" class="source_line" href="#L631">631</a>
<a id="L632" class="source_line" href="#L632">632</a>
<a id="L633" class="source_line" href="#L633">633</a>
<a id="L634" class="source_line" href="#L634">634</a>
<a id="L635" class="source_line" href="#L635">635</a>
<a id="L636" class="source_line" href="#L636">636</a>
<a id="L637" class="source_line" href="#L637">637</a>
<a id="L638" class="source_line" href="#L638">638</a>
<a id="L639" class="source_line" href="#L639">639</a>
<a id="L640" class="source_line" href="#L640">640</a>
<a id="L641" class="source_line" href="#L641">641</a>
<a id="L642" class="source_line" href="#L642">642</a>
<a id="L643" class="source_line" href="#L643">643</a>
<a id="L644" class="source_line" href="#L644">644</a>
<a id="L645" class="source_line" href="#L645">645</a>
<a id="L646" class="source_line" href="#L646">646</a>
<a id="L647" class="source_line" href="#L647">647</a>
<a id="L648" class="source_line" href="#L648">648</a>
<a id="L649" class="source_line" href="#L649">649</a>
<a id="L650" class="source_line" href="#L650">650</a>
<a id="L651" class="source_line" href="#L651">651</a>
<a id="L652" class="source_line" href="#L652">652</a>
<a id="L653" class="source_line" href="#L653">653</a>
<a id="L654" class="source_line" href="#L654">654</a>
<a id="L655" class="source_line" href="#L655">655</a>
<a id="L656" class="source_line" href="#L656">656</a>
<a id="L657" class="source_line" href="#L657">657</a>
<a id="L658" class="source_line" href="#L658">658</a>
<a id="L659" class="source_line" href="#L659">659</a>
<a id="L660" class="source_line" href="#L660">660</a>
<a id="L661" class="source_line" href="#L661">661</a>
<a id="L662" class="source_line" href="#L662">662</a>
<a id="L663" class="source_line" href="#L663">663</a>
<a id="L664" class="source_line" href="#L664">664</a>
<a id="L665" class="source_line" href="#L665">665</a>
<a id="L666" class="source_line" href="#L666">666</a>
<a id="L667" class="source_line" href="#L667">667</a>
<a id="L668" class="source_line" href="#L668">668</a>
<a id="L669" class="source_line" href="#L669">669</a>
<a id="L670" class="source_line" href="#L670">670</a>
<a id="L671" class="source_line" href="#L671">671</a>
<a id="L672" class="source_line" href="#L672">672</a>
<a id="L673" class="source_line" href="#L673">673</a>
<a id="L674" class="source_line" href="#L674">674</a>
<a id="L675" class="source_line" href="#L675">675</a>
<a id="L676" class="source_line" href="#L676">676</a>
<a id="L677" class="source_line" href="#L677">677</a>
<a id="L678" class="source_line" href="#L678">678</a>
<a id="L679" class="source_line" href="#L679">679</a>
<a id="L680" class="source_line" href="#L680">680</a>
<a id="L681" class="source_line" href="#L681">681</a>
<a id="L682" class="source_line" href="#L682">682</a>
<a id="L683" class="source_line" href="#L683">683</a>
<a id="L684" class="source_line" href="#L684">684</a>
<a id="L685" class="source_line" href="#L685">685</a>
<a id="L686" class="source_line" href="#L686">686</a>
<a id="L687" class="source_line" href="#L687">687</a>
<a id="L688" class="source_line" href="#L688">688</a>
<a id="L689" class="source_line" href="#L689">689</a>
<a id="L690" class="source_line" href="#L690">690</a>
<a id="L691" class="source_line" href="#L691">691</a>
<a id="L692" class="source_line" href="#L692">692</a>
<a id="L693" class="source_line" href="#L693">693</a>
<a id="L694" class="source_line" href="#L694">694</a>
<a id="L695" class="source_line" href="#L695">695</a>
<a id="L696" class="source_line" href="#L696">696</a>
<a id="L697" class="source_line" href="#L697">697</a>
<a id="L698" class="source_line" href="#L698">698</a>
<a id="L699" class="source_line" href="#L699">699</a>
<a id="L700" class="source_line" href="#L700">700</a>
<a id="L701" class="source_line" href="#L701">701</a>
<a id="L702" class="source_line" href="#L702">702</a>
<a id="L703" class="source_line" href="#L703">703</a>
<a id="L704" class="source_line" href="#L704">704</a>
<a id="L705" class="source_line" href="#L705">705</a>
<a id="L706" class="source_line" href="#L706">706</a>
<a id="L707" class="source_line" href="#L707">707</a>
<a id="L708" class="source_line" href="#L708">708</a>
<a id="L709" class="source_line" href="#L709">709</a>
<a id="L710" class="source_line" href="#L710">710</a>
<a id="L711" class="source_line" href="#L711">711</a>
<a id="L712" class="source_line" href="#L712">712</a>
<a id="L713" class="source_line" href="#L713">713</a>
<a id="L714" class="source_line" href="#L714">714</a>
<a id="L715" class="source_line" href="#L715">715</a>
<a id="L716" class="source_line" href="#L716">716</a>
<a id="L717" class="source_line" href="#L717">717</a>
<a id="L718" class="source_line" href="#L718">718</a>
<a id="L719" class="source_line" href="#L719">719</a>
<a id="L720" class="source_line" href="#L720">720</a>
<a id="L721" class="source_line" href="#L721">721</a>
<a id="L722" class="source_line" href="#L722">722</a>
<a id="L723" class="source_line" href="#L723">723</a>
<a id="L724" class="source_line" href="#L724">724</a>
<a id="L725" class="source_line" href="#L725">725</a>
<a id="L726" class="source_line" href="#L726">726</a>
<a id="L727" class="source_line" href="#L727">727</a>
<a id="L728" class="source_line" href="#L728">728</a>
<a id="L729" class="source_line" href="#L729">729</a>
<a id="L730" class="source_line" href="#L730">730</a>
<a id="L731" class="source_line" href="#L731">731</a>
<a id="L732" class="source_line" href="#L732">732</a>
<a id="L733" class="source_line" href="#L733">733</a>
<a id="L734" class="source_line" href="#L734">734</a>
<a id="L735" class="source_line" href="#L735">735</a>
<a id="L736" class="source_line" href="#L736">736</a>
<a id="L737" class="source_line" href="#L737">737</a>
<a id="L738" class="source_line" href="#L738">738</a>
<a id="L739" class="source_line" href="#L739">739</a>
<a id="L740" class="source_line" href="#L740">740</a>
<a id="L741" class="source_line" href="#L741">741</a>
<a id="L742" class="source_line" href="#L742">742</a>
<a id="L743" class="source_line" href="#L743">743</a>
<a id="L744" class="source_line" href="#L744">744</a>
<a id="L745" class="source_line" href="#L745">745</a>
<a id="L746" class="source_line" href="#L746">746</a>
<a id="L747" class="source_line" href="#L747">747</a>
<a id="L748" class="source_line" href="#L748">748</a>
<a id="L749" class="source_line" href="#L749">749</a>
<a id="L750" class="source_line" href="#L750">750</a>
<a id="L751" class="source_line" href="#L751">751</a>
<a id="L752" class="source_line" href="#L752">752</a>
<a id="L753" class="source_line" href="#L753">753</a>
<a id="L754" class="source_line" href="#L754">754</a>
<a id="L755" class="source_line" href="#L755">755</a>
<a id="L756" class="source_line" href="#L756">756</a>
<a id="L757" class="source_line" href="#L757">757</a>
<a id="L758" class="source_line" href="#L758">758</a>
<a id="L759" class="source_line" href="#L759">759</a>
<a id="L760" class="source_line" href="#L760">760</a>
<a id="L761" class="source_line" href="#L761">761</a>
<a id="L762" class="source_line" href="#L762">762</a>
<a id="L763" class="source_line" href="#L763">763</a>
<a id="L764" class="source_line" href="#L764">764</a>
<a id="L765" class="source_line" href="#L765">765</a>
<a id="L766" class="source_line" href="#L766">766</a>
<a id="L767" class="source_line" href="#L767">767</a>
<a id="L768" class="source_line" href="#L768">768</a>
<a id="L769" class="source_line" href="#L769">769</a>
<a id="L770" class="source_line" href="#L770">770</a>
<a id="L771" class="source_line" href="#L771">771</a>
<a id="L772" class="source_line" href="#L772">772</a>
<a id="L773" class="source_line" href="#L773">773</a>
<a id="L774" class="source_line" href="#L774">774</a>
<a id="L775" class="source_line" href="#L775">775</a>
<a id="L776" class="source_line" href="#L776">776</a>
<a id="L777" class="source_line" href="#L777">777</a>
<a id="L778" class="source_line" href="#L778">778</a>
<a id="L779" class="source_line" href="#L779">779</a>
<a id="L780" class="source_line" href="#L780">780</a>
<a id="L781" class="source_line" href="#L781">781</a>
<a id="L782" class="source_line" href="#L782">782</a>
<a id="L783" class="source_line" href="#L783">783</a>
<a id="L784" class="source_line" href="#L784">784</a>
<a id="L785" class="source_line" href="#L785">785</a>
<a id="L786" class="source_line" href="#L786">786</a>
<a id="L787" class="source_line" href="#L787">787</a>
<a id="L788" class="source_line" href="#L788">788</a>
<a id="L789" class="source_line" href="#L789">789</a>
<a id="L790" class="source_line" href="#L790">790</a>
<a id="L791" class="source_line" href="#L791">791</a>
<a id="L792" class="source_line" href="#L792">792</a>
<a id="L793" class="source_line" href="#L793">793</a>
<a id="L794" class="source_line" href="#L794">794</a>
<a id="L795" class="source_line" href="#L795">795</a>
<a id="L796" class="source_line" href="#L796">796</a>
<a id="L797" class="source_line" href="#L797">797</a>
<a id="L798" class="source_line" href="#L798">798</a>
<a id="L799" class="source_line" href="#L799">799</a>
<a id="L800" class="source_line" href="#L800">800</a>
<a id="L801" class="source_line" href="#L801">801</a>
<a id="L802" class="source_line" href="#L802">802</a>
<a id="L803" class="source_line" href="#L803">803</a>
<a id="L804" class="source_line" href="#L804">804</a>
<a id="L805" class="source_line" href="#L805">805</a>
<a id="L806" class="source_line" href="#L806">806</a>
<a id="L807" class="source_line" href="#L807">807</a>
<a id="L808" class="source_line" href="#L808">808</a>
<a id="L809" class="source_line" href="#L809">809</a>
<a id="L810" class="source_line" href="#L810">810</a>
<a id="L811" class="source_line" href="#L811">811</a>
<a id="L812" class="source_line" href="#L812">812</a>
<a id="L813" class="source_line" href="#L813">813</a>
<a id="L814" class="source_line" href="#L814">814</a>
<a id="L815" class="source_line" href="#L815">815</a>
<a id="L816" class="source_line" href="#L816">816</a>
<a id="L817" class="source_line" href="#L817">817</a>
<a id="L818" class="source_line" href="#L818">818</a>
<a id="L819" class="source_line" href="#L819">819</a>
<a id="L820" class="source_line" href="#L820">820</a>
<a id="L821" class="source_line" href="#L821">821</a>
<a id="L822" class="source_line" href="#L822">822</a>
<a id="L823" class="source_line" href="#L823">823</a>
<a id="L824" class="source_line" href="#L824">824</a>
<a id="L825" class="source_line" href="#L825">825</a>
<a id="L826" class="source_line" href="#L826">826</a>
<a id="L827" class="source_line" href="#L827">827</a>
<a id="L828" class="source_line" href="#L828">828</a>
<a id="L829" class="source_line" href="#L829">829</a>
<a id="L830" class="source_line" href="#L830">830</a>
<a id="L831" class="source_line" href="#L831">831</a>
<a id="L832" class="source_line" href="#L832">832</a>
<a id="L833" class="source_line" href="#L833">833</a>
<a id="L834" class="source_line" href="#L834">834</a>
<a id="L835" class="source_line" href="#L835">835</a>
<a id="L836" class="source_line" href="#L836">836</a>
<a id="L837" class="source_line" href="#L837">837</a>
<a id="L838" class="source_line" href="#L838">838</a>
<a id="L839" class="source_line" href="#L839">839</a>
<a id="L840" class="source_line" href="#L840">840</a>
<a id="L841" class="source_line" href="#L841">841</a>
<a id="L842" class="source_line" href="#L842">842</a>
<a id="L843" class="source_line" href="#L843">843</a>
<a id="L844" class="source_line" href="#L844">844</a>
<a id="L845" class="source_line" href="#L845">845</a>
<a id="L846" class="source_line" href="#L846">846</a>
<a id="L847" class="source_line" href="#L847">847</a>
<a id="L848" class="source_line" href="#L848">848</a>
<a id="L849" class="source_line" href="#L849">849</a>
<a id="L850" class="source_line" href="#L850">850</a>
<a id="L851" class="source_line" href="#L851">851</a>
<a id="L852" class="source_line" href="#L852">852</a>
<a id="L853" class="source_line" href="#L853">853</a>
<a id="L854" class="source_line" href="#L854">854</a>
<a id="L855" class="source_line" href="#L855">855</a>
<a id="L856" class="source_line" href="#L856">856</a>
<a id="L857" class="source_line" href="#L857">857</a>
<a id="L858" class="source_line" href="#L858">858</a>
<a id="L859" class="source_line" href="#L859">859</a>
<a id="L860" class="source_line" href="#L860">860</a>
<a id="L861" class="source_line" href="#L861">861</a>
<a id="L862" class="source_line" href="#L862">862</a>
<a id="L863" class="source_line" href="#L863">863</a>
<a id="L864" class="source_line" href="#L864">864</a>
<a id="L865" class="source_line" href="#L865">865</a>
<a id="L866" class="source_line" href="#L866">866</a>
<a id="L867" class="source_line" href="#L867">867</a>
<a id="L868" class="source_line" href="#L868">868</a>
<a id="L869" class="source_line" href="#L869">869</a>
<a id="L870" class="source_line" href="#L870">870</a>
<a id="L871" class="source_line" href="#L871">871</a>
<a id="L872" class="source_line" href="#L872">872</a>
<a id="L873" class="source_line" href="#L873">873</a>
<a id="L874" class="source_line" href="#L874">874</a>
<a id="L875" class="source_line" href="#L875">875</a>
<a id="L876" class="source_line" href="#L876">876</a>
<a id="L877" class="source_line" href="#L877">877</a>
<a id="L878" class="source_line" href="#L878">878</a>
<a id="L879" class="source_line" href="#L879">879</a>
<a id="L880" class="source_line" href="#L880">880</a>
<a id="L881" class="source_line" href="#L881">881</a>
<a id="L882" class="source_line" href="#L882">882</a>
<a id="L883" class="source_line" href="#L883">883</a>
<a id="L884" class="source_line" href="#L884">884</a>
<a id="L885" class="source_line" href="#L885">885</a>
<a id="L886" class="source_line" href="#L886">886</a>
<a id="L887" class="source_line" href="#L887">887</a>
<a id="L888" class="source_line" href="#L888">888</a>
<a id="L889" class="source_line" href="#L889">889</a>
<a id="L890" class="source_line" href="#L890">890</a>
<a id="L891" class="source_line" href="#L891">891</a>
<a id="L892" class="source_line" href="#L892">892</a>
<a id="L893" class="source_line" href="#L893">893</a>
<a id="L894" class="source_line" href="#L894">894</a>
<a id="L895" class="source_line" href="#L895">895</a>
<a id="L896" class="source_line" href="#L896">896</a>
<a id="L897" class="source_line" href="#L897">897</a>
<a id="L898" class="source_line" href="#L898">898</a>
<a id="L899" class="source_line" href="#L899">899</a>
<a id="L900" class="source_line" href="#L900">900</a>
<a id="L901" class="source_line" href="#L901">901</a>
<a id="L902" class="source_line" href="#L902">902</a>
<a id="L903" class="source_line" href="#L903">903</a>
<a id="L904" class="source_line" href="#L904">904</a>
<a id="L905" class="source_line" href="#L905">905</a>
<a id="L906" class="source_line" href="#L906">906</a>
<a id="L907" class="source_line" href="#L907">907</a>
<a id="L908" class="source_line" href="#L908">908</a>
<a id="L909" class="source_line" href="#L909">909</a>
<a id="L910" class="source_line" href="#L910">910</a>
<a id="L911" class="source_line" href="#L911">911</a>
<a id="L912" class="source_line" href="#L912">912</a>
<a id="L913" class="source_line" href="#L913">913</a>
<a id="L914" class="source_line" href="#L914">914</a>
<a id="L915" class="source_line" href="#L915">915</a>
<a id="L916" class="source_line" href="#L916">916</a>
<a id="L917" class="source_line" href="#L917">917</a>
<a id="L918" class="source_line" href="#L918">918</a>
<a id="L919" class="source_line" href="#L919">919</a>
<a id="L920" class="source_line" href="#L920">920</a>
<a id="L921" class="source_line" href="#L921">921</a>
<a id="L922" class="source_line" href="#L922">922</a>
<a id="L923" class="source_line" href="#L923">923</a>
<a id="L924" class="source_line" href="#L924">924</a>
<a id="L925" class="source_line" href="#L925">925</a>
<a id="L926" class="source_line" href="#L926">926</a>
<a id="L927" class="source_line" href="#L927">927</a>
<a id="L928" class="source_line" href="#L928">928</a>
<a id="L929" class="source_line" href="#L929">929</a>
<a id="L930" class="source_line" href="#L930">930</a>
<a id="L931" class="source_line" href="#L931">931</a>
<a id="L932" class="source_line" href="#L932">932</a>
<a id="L933" class="source_line" href="#L933">933</a>
<a id="L934" class="source_line" href="#L934">934</a>
<a id="L935" class="source_line" href="#L935">935</a>
<a id="L936" class="source_line" href="#L936">936</a>
<a id="L937" class="source_line" href="#L937">937</a>
<a id="L938" class="source_line" href="#L938">938</a>
<a id="L939" class="source_line" href="#L939">939</a>
<a id="L940" class="source_line" href="#L940">940</a>
<a id="L941" class="source_line" href="#L941">941</a>
<a id="L942" class="source_line" href="#L942">942</a>
<a id="L943" class="source_line" href="#L943">943</a>
<a id="L944" class="source_line" href="#L944">944</a>
<a id="L945" class="source_line" href="#L945">945</a>
<a id="L946" class="source_line" href="#L946">946</a>
<a id="L947" class="source_line" href="#L947">947</a>
<a id="L948" class="source_line" href="#L948">948</a>
<a id="L949" class="source_line" href="#L949">949</a>
<a id="L950" class="source_line" href="#L950">950</a>
<a id="L951" class="source_line" href="#L951">951</a>
<a id="L952" class="source_line" href="#L952">952</a>
<a id="L953" class="source_line" href="#L953">953</a>
<a id="L954" class="source_line" href="#L954">954</a>
<a id="L955" class="source_line" href="#L955">955</a>
<a id="L956" class="source_line" href="#L956">956</a>
<a id="L957" class="source_line" href="#L957">957</a>
<a id="L958" class="source_line" href="#L958">958</a>
<a id="L959" class="source_line" href="#L959">959</a>
<a id="L960" class="source_line" href="#L960">960</a>
<a id="L961" class="source_line" href="#L961">961</a>
<a id="L962" class="source_line" href="#L962">962</a>
<a id="L963" class="source_line" href="#L963">963</a>
<a id="L964" class="source_line" href="#L964">964</a>
<a id="L965" class="source_line" href="#L965">965</a>
<a id="L966" class="source_line" href="#L966">966</a>
<a id="L967" class="source_line" href="#L967">967</a>
<a id="L968" class="source_line" href="#L968">968</a>
<a id="L969" class="source_line" href="#L969">969</a>
<a id="L970" class="source_line" href="#L970">970</a>
<a id="L971" class="source_line" href="#L971">971</a>
<a id="L972" class="source_line" href="#L972">972</a>
<a id="L973" class="source_line" href="#L973">973</a>
<a id="L974" class="source_line" href="#L974">974</a>
<a id="L975" class="source_line" href="#L975">975</a>
<a id="L976" class="source_line" href="#L976">976</a>
<a id="L977" class="source_line" href="#L977">977</a>
<a id="L978" class="source_line" href="#L978">978</a>
<a id="L979" class="source_line" href="#L979">979</a>
<a id="L980" class="source_line" href="#L980">980</a>
<a id="L981" class="source_line" href="#L981">981</a>
<a id="L982" class="source_line" href="#L982">982</a>
<a id="L983" class="source_line" href="#L983">983</a>
<a id="L984" class="source_line" href="#L984">984</a>
<a id="L985" class="source_line" href="#L985">985</a>
<a id="L986" class="source_line" href="#L986">986</a>
<a id="L987" class="source_line" href="#L987">987</a>
<a id="L988" class="source_line" href="#L988">988</a>
<a id="L989" class="source_line" href="#L989">989</a>
<a id="L990" class="source_line" href="#L990">990</a>
<a id="L991" class="source_line" href="#L991">991</a>
<a id="L992" class="source_line" href="#L992">992</a>
<a id="L993" class="source_line" href="#L993">993</a>
<a id="L994" class="source_line" href="#L994">994</a>
<a id="L995" class="source_line" href="#L995">995</a>
<a id="L996" class="source_line" href="#L996">996</a>
<a id="L997" class="source_line" href="#L997">997</a>
<a id="L998" class="source_line" href="#L998">998</a>
<a id="L999" class="source_line" href="#L999">999</a>
<a id="L1000" class="source_line" href="#L1000">1000</a>
<a id="L1001" class="source_line" href="#L1001">1001</a>
<a id="L1002" class="source_line" href="#L1002">1002</a>
<a id="L1003" class="source_line" href="#L1003">1003</a>
<a id="L1004" class="source_line" href="#L1004">1004</a>
<a id="L1005" class="source_line" href="#L1005">1005</a>
<a id="L1006" class="source_line" href="#L1006">1006</a>
<a id="L1007" class="source_line" href="#L1007">1007</a>
<a id="L1008" class="source_line" href="#L1008">1008</a>
<a id="L1009" class="source_line" href="#L1009">1009</a>
<a id="L1010" class="source_line" href="#L1010">1010</a>
<a id="L1011" class="source_line" href="#L1011">1011</a>
<a id="L1012" class="source_line" href="#L1012">1012</a>
<a id="L1013" class="source_line" href="#L1013">1013</a>
<a id="L1014" class="source_line" href="#L1014">1014</a>
<a id="L1015" class="source_line" href="#L1015">1015</a>
<a id="L1016" class="source_line" href="#L1016">1016</a>
<a id="L1017" class="source_line" href="#L1017">1017</a>
<a id="L1018" class="source_line" href="#L1018">1018</a>
<a id="L1019" class="source_line" href="#L1019">1019</a>
<a id="L1020" class="source_line" href="#L1020">1020</a>
<a id="L1021" class="source_line" href="#L1021">1021</a>
<a id="L1022" class="source_line" href="#L1022">1022</a>
<a id="L1023" class="source_line" href="#L1023">1023</a>
<a id="L1024" class="source_line" href="#L1024">1024</a>
<a id="L1025" class="source_line" href="#L1025">1025</a>
<a id="L1026" class="source_line" href="#L1026">1026</a>
<a id="L1027" class="source_line" href="#L1027">1027</a>
<a id="L1028" class="source_line" href="#L1028">1028</a>
<a id="L1029" class="source_line" href="#L1029">1029</a>
<a id="L1030" class="source_line" href="#L1030">1030</a>
<a id="L1031" class="source_line" href="#L1031">1031</a>
<a id="L1032" class="source_line" href="#L1032">1032</a>
<a id="L1033" class="source_line" href="#L1033">1033</a>
<a id="L1034" class="source_line" href="#L1034">1034</a>
<a id="L1035" class="source_line" href="#L1035">1035</a>
<a id="L1036" class="source_line" href="#L1036">1036</a>
<a id="L1037" class="source_line" href="#L1037">1037</a>
<a id="L1038" class="source_line" href="#L1038">1038</a>
<a id="L1039" class="source_line" href="#L1039">1039</a>
<a id="L1040" class="source_line" href="#L1040">1040</a>
<a id="L1041" class="source_line" href="#L1041">1041</a>
<a id="L1042" class="source_line" href="#L1042">1042</a>
<a id="L1043" class="source_line" href="#L1043">1043</a>
<a id="L1044" class="source_line" href="#L1044">1044</a>
<a id="L1045" class="source_line" href="#L1045">1045</a>
<a id="L1046" class="source_line" href="#L1046">1046</a>
<a id="L1047" class="source_line" href="#L1047">1047</a>
<a id="L1048" class="source_line" href="#L1048">1048</a>
<a id="L1049" class="source_line" href="#L1049">1049</a>
<a id="L1050" class="source_line" href="#L1050">1050</a>
<a id="L1051" class="source_line" href="#L1051">1051</a>
<a id="L1052" class="source_line" href="#L1052">1052</a>
<a id="L1053" class="source_line" href="#L1053">1053</a>
<a id="L1054" class="source_line" href="#L1054">1054</a>
<a id="L1055" class="source_line" href="#L1055">1055</a>
<a id="L1056" class="source_line" href="#L1056">1056</a>
<a id="L1057" class="source_line" href="#L1057">1057</a>
<a id="L1058" class="source_line" href="#L1058">1058</a>
<a id="L1059" class="source_line" href="#L1059">1059</a>
<a id="L1060" class="source_line" href="#L1060">1060</a>
<a id="L1061" class="source_line" href="#L1061">1061</a>
<a id="L1062" class="source_line" href="#L1062">1062</a>
<a id="L1063" class="source_line" href="#L1063">1063</a>
<a id="L1064" class="source_line" href="#L1064">1064</a>
<a id="L1065" class="source_line" href="#L1065">1065</a>
<a id="L1066" class="source_line" href="#L1066">1066</a>
<a id="L1067" class="source_line" href="#L1067">1067</a>
<a id="L1068" class="source_line" href="#L1068">1068</a>
<a id="L1069" class="source_line" href="#L1069">1069</a>
<a id="L1070" class="source_line" href="#L1070">1070</a>
<a id="L1071" class="source_line" href="#L1071">1071</a>
<a id="L1072" class="source_line" href="#L1072">1072</a>
<a id="L1073" class="source_line" href="#L1073">1073</a>
<a id="L1074" class="source_line" href="#L1074">1074</a>
<a id="L1075" class="source_line" href="#L1075">1075</a>
<a id="L1076" class="source_line" href="#L1076">1076</a>
<a id="L1077" class="source_line" href="#L1077">1077</a>
<a id="L1078" class="source_line" href="#L1078">1078</a>
<a id="L1079" class="source_line" href="#L1079">1079</a>
<a id="L1080" class="source_line" href="#L1080">1080</a>
<a id="L1081" class="source_line" href="#L1081">1081</a>
<a id="L1082" class="source_line" href="#L1082">1082</a>
<a id="L1083" class="source_line" href="#L1083">1083</a>
<a id="L1084" class="source_line" href="#L1084">1084</a>
<a id="L1085" class="source_line" href="#L1085">1085</a>
<a id="L1086" class="source_line" href="#L1086">1086</a>
<a id="L1087" class="source_line" href="#L1087">1087</a>
<a id="L1088" class="source_line" href="#L1088">1088</a>
<a id="L1089" class="source_line" href="#L1089">1089</a>
<a id="L1090" class="source_line" href="#L1090">1090</a>
<a id="L1091" class="source_line" href="#L1091">1091</a>
<a id="L1092" class="source_line" href="#L1092">1092</a>
<a id="L1093" class="source_line" href="#L1093">1093</a>
<a id="L1094" class="source_line" href="#L1094">1094</a>
<a id="L1095" class="source_line" href="#L1095">1095</a>
<a id="L1096" class="source_line" href="#L1096">1096</a>
<a id="L1097" class="source_line" href="#L1097">1097</a>
<a id="L1098" class="source_line" href="#L1098">1098</a>
<a id="L1099" class="source_line" href="#L1099">1099</a>
<a id="L1100" class="source_line" href="#L1100">1100</a>
<a id="L1101" class="source_line" href="#L1101">1101</a>
<a id="L1102" class="source_line" href="#L1102">1102</a>
<a id="L1103" class="source_line" href="#L1103">1103</a>
<a id="L1104" class="source_line" href="#L1104">1104</a>
<a id="L1105" class="source_line" href="#L1105">1105</a>
<a id="L1106" class="source_line" href="#L1106">1106</a>
<a id="L1107" class="source_line" href="#L1107">1107</a>
<a id="L1108" class="source_line" href="#L1108">1108</a>
<a id="L1109" class="source_line" href="#L1109">1109</a>
<a id="L1110" class="source_line" href="#L1110">1110</a>
<a id="L1111" class="source_line" href="#L1111">1111</a>
<a id="L1112" class="source_line" href="#L1112">1112</a>
<a id="L1113" class="source_line" href="#L1113">1113</a>
<a id="L1114" class="source_line" href="#L1114">1114</a>
<a id="L1115" class="source_line" href="#L1115">1115</a>
<a id="L1116" class="source_line" href="#L1116">1116</a>
<a id="L1117" class="source_line" href="#L1117">1117</a>
<a id="L1118" class="source_line" href="#L1118">1118</a>
<a id="L1119" class="source_line" href="#L1119">1119</a>
<a id="L1120" class="source_line" href="#L1120">1120</a>
<a id="L1121" class="source_line" href="#L1121">1121</a>
<a id="L1122" class="source_line" href="#L1122">1122</a>
<a id="L1123" class="source_line" href="#L1123">1123</a>
<a id="L1124" class="source_line" href="#L1124">1124</a>
<a id="L1125" class="source_line" href="#L1125">1125</a>
<a id="L1126" class="source_line" href="#L1126">1126</a>
<a id="L1127" class="source_line" href="#L1127">1127</a>
<a id="L1128" class="source_line" href="#L1128">1128</a>
<a id="L1129" class="source_line" href="#L1129">1129</a>
<a id="L1130" class="source_line" href="#L1130">1130</a>
<a id="L1131" class="source_line" href="#L1131">1131</a>
<a id="L1132" class="source_line" href="#L1132">1132</a>
<a id="L1133" class="source_line" href="#L1133">1133</a>
<a id="L1134" class="source_line" href="#L1134">1134</a>
<a id="L1135" class="source_line" href="#L1135">1135</a>
<a id="L1136" class="source_line" href="#L1136">1136</a>
<a id="L1137" class="source_line" href="#L1137">1137</a>
<a id="L1138" class="source_line" href="#L1138">1138</a>
<a id="L1139" class="source_line" href="#L1139">1139</a>
<a id="L1140" class="source_line" href="#L1140">1140</a>
<a id="L1141" class="source_line" href="#L1141">1141</a>
<a id="L1142" class="source_line" href="#L1142">1142</a>
<a id="L1143" class="source_line" href="#L1143">1143</a>
<a id="L1144" class="source_line" href="#L1144">1144</a>
<a id="L1145" class="source_line" href="#L1145">1145</a>
<a id="L1146" class="source_line" href="#L1146">1146</a>
<a id="L1147" class="source_line" href="#L1147">1147</a>
<a id="L1148" class="source_line" href="#L1148">1148</a>
<a id="L1149" class="source_line" href="#L1149">1149</a>
<a id="L1150" class="source_line" href="#L1150">1150</a>
<a id="L1151" class="source_line" href="#L1151">1151</a>
<a id="L1152" class="source_line" href="#L1152">1152</a>
<a id="L1153" class="source_line" href="#L1153">1153</a>
<a id="L1154" class="source_line" href="#L1154">1154</a>
<a id="L1155" class="source_line" href="#L1155">1155</a>
<a id="L1156" class="source_line" href="#L1156">1156</a>
<a id="L1157" class="source_line" href="#L1157">1157</a>
<a id="L1158" class="source_line" href="#L1158">1158</a>
<a id="L1159" class="source_line" href="#L1159">1159</a>
<a id="L1160" class="source_line" href="#L1160">1160</a>
<a id="L1161" class="source_line" href="#L1161">1161</a>
<a id="L1162" class="source_line" href="#L1162">1162</a>
<a id="L1163" class="source_line" href="#L1163">1163</a>
<a id="L1164" class="source_line" href="#L1164">1164</a>
<a id="L1165" class="source_line" href="#L1165">1165</a>
<a id="L1166" class="source_line" href="#L1166">1166</a>
<a id="L1167" class="source_line" href="#L1167">1167</a>
<a id="L1168" class="source_line" href="#L1168">1168</a>
<a id="L1169" class="source_line" href="#L1169">1169</a>
<a id="L1170" class="source_line" href="#L1170">1170</a>
<a id="L1171" class="source_line" href="#L1171">1171</a>
<a id="L1172" class="source_line" href="#L1172">1172</a>
<a id="L1173" class="source_line" href="#L1173">1173</a>
<a id="L1174" class="source_line" href="#L1174">1174</a>
<a id="L1175" class="source_line" href="#L1175">1175</a>
<a id="L1176" class="source_line" href="#L1176">1176</a>
<a id="L1177" class="source_line" href="#L1177">1177</a>
<a id="L1178" class="source_line" href="#L1178">1178</a>
<a id="L1179" class="source_line" href="#L1179">1179</a>
<a id="L1180" class="source_line" href="#L1180">1180</a>
<a id="L1181" class="source_line" href="#L1181">1181</a>
<a id="L1182" class="source_line" href="#L1182">1182</a>
<a id="L1183" class="source_line" href="#L1183">1183</a>
<a id="L1184" class="source_line" href="#L1184">1184</a>
<a id="L1185" class="source_line" href="#L1185">1185</a>
<a id="L1186" class="source_line" href="#L1186">1186</a>
<a id="L1187" class="source_line" href="#L1187">1187</a>
<a id="L1188" class="source_line" href="#L1188">1188</a>
<a id="L1189" class="source_line" href="#L1189">1189</a>
<a id="L1190" class="source_line" href="#L1190">1190</a>
<a id="L1191" class="source_line" href="#L1191">1191</a>
<a id="L1192" class="source_line" href="#L1192">1192</a>
<a id="L1193" class="source_line" href="#L1193">1193</a>
<a id="L1194" class="source_line" href="#L1194">1194</a>
<a id="L1195" class="source_line" href="#L1195">1195</a>
<a id="L1196" class="source_line" href="#L1196">1196</a>
<a id="L1197" class="source_line" href="#L1197">1197</a>
<a id="L1198" class="source_line" href="#L1198">1198</a>
<a id="L1199" class="source_line" href="#L1199">1199</a>
<a id="L1200" class="source_line" href="#L1200">1200</a>
<a id="L1201" class="source_line" href="#L1201">1201</a>
<a id="L1202" class="source_line" href="#L1202">1202</a>
<a id="L1203" class="source_line" href="#L1203">1203</a>
<a id="L1204" class="source_line" href="#L1204">1204</a>
<a id="L1205" class="source_line" href="#L1205">1205</a>
<a id="L1206" class="source_line" href="#L1206">1206</a>
<a id="L1207" class="source_line" href="#L1207">1207</a>
<a id="L1208" class="source_line" href="#L1208">1208</a>
<a id="L1209" class="source_line" href="#L1209">1209</a>
<a id="L1210" class="source_line" href="#L1210">1210</a>
<a id="L1211" class="source_line" href="#L1211">1211</a>
<a id="L1212" class="source_line" href="#L1212">1212</a>
<a id="L1213" class="source_line" href="#L1213">1213</a>
<a id="L1214" class="source_line" href="#L1214">1214</a>
<a id="L1215" class="source_line" href="#L1215">1215</a>
<a id="L1216" class="source_line" href="#L1216">1216</a>
<a id="L1217" class="source_line" href="#L1217">1217</a>
<a id="L1218" class="source_line" href="#L1218">1218</a>
<a id="L1219" class="source_line" href="#L1219">1219</a>
<a id="L1220" class="source_line" href="#L1220">1220</a>
<a id="L1221" class="source_line" href="#L1221">1221</a>
<a id="L1222" class="source_line" href="#L1222">1222</a>
<a id="L1223" class="source_line" href="#L1223">1223</a>
<a id="L1224" class="source_line" href="#L1224">1224</a>
<a id="L1225" class="source_line" href="#L1225">1225</a>
<a id="L1226" class="source_line" href="#L1226">1226</a>
<a id="L1227" class="source_line" href="#L1227">1227</a>
<a id="L1228" class="source_line" href="#L1228">1228</a>
<a id="L1229" class="source_line" href="#L1229">1229</a>
<a id="L1230" class="source_line" href="#L1230">1230</a>
<a id="L1231" class="source_line" href="#L1231">1231</a>
<a id="L1232" class="source_line" href="#L1232">1232</a>
<a id="L1233" class="source_line" href="#L1233">1233</a>
<a id="L1234" class="source_line" href="#L1234">1234</a>
<a id="L1235" class="source_line" href="#L1235">1235</a>
<a id="L1236" class="source_line" href="#L1236">1236</a>
<a id="L1237" class="source_line" href="#L1237">1237</a>
<a id="L1238" class="source_line" href="#L1238">1238</a>
<a id="L1239" class="source_line" href="#L1239">1239</a>
<a id="L1240" class="source_line" href="#L1240">1240</a>
<a id="L1241" class="source_line" href="#L1241">1241</a>
<a id="L1242" class="source_line" href="#L1242">1242</a>
<a id="L1243" class="source_line" href="#L1243">1243</a>
<a id="L1244" class="source_line" href="#L1244">1244</a>
<a id="L1245" class="source_line" href="#L1245">1245</a>
<a id="L1246" class="source_line" href="#L1246">1246</a>
<a id="L1247" class="source_line" href="#L1247">1247</a>
<a id="L1248" class="source_line" href="#L1248">1248</a>
<a id="L1249" class="source_line" href="#L1249">1249</a>
<a id="L1250" class="source_line" href="#L1250">1250</a>
<a id="L1251" class="source_line" href="#L1251">1251</a>
<a id="L1252" class="source_line" href="#L1252">1252</a>
<a id="L1253" class="source_line" href="#L1253">1253</a>
<a id="L1254" class="source_line" href="#L1254">1254</a>
<a id="L1255" class="source_line" href="#L1255">1255</a>
<a id="L1256" class="source_line" href="#L1256">1256</a>
<a id="L1257" class="source_line" href="#L1257">1257</a>
<a id="L1258" class="source_line" href="#L1258">1258</a>
<a id="L1259" class="source_line" href="#L1259">1259</a>
<a id="L1260" class="source_line" href="#L1260">1260</a>
<a id="L1261" class="source_line" href="#L1261">1261</a>
<a id="L1262" class="source_line" href="#L1262">1262</a>
<a id="L1263" class="source_line" href="#L1263">1263</a>
<a id="L1264" class="source_line" href="#L1264">1264</a>
<a id="L1265" class="source_line" href="#L1265">1265</a>
<a id="L1266" class="source_line" href="#L1266">1266</a>
<a id="L1267" class="source_line" href="#L1267">1267</a>
<a id="L1268" class="source_line" href="#L1268">1268</a>
<a id="L1269" class="source_line" href="#L1269">1269</a>
<a id="L1270" class="source_line" href="#L1270">1270</a>
<a id="L1271" class="source_line" href="#L1271">1271</a>
<a id="L1272" class="source_line" href="#L1272">1272</a>
<a id="L1273" class="source_line" href="#L1273">1273</a>
<a id="L1274" class="source_line" href="#L1274">1274</a>
<a id="L1275" class="source_line" href="#L1275">1275</a>
<a id="L1276" class="source_line" href="#L1276">1276</a>
<a id="L1277" class="source_line" href="#L1277">1277</a>
<a id="L1278" class="source_line" href="#L1278">1278</a>
<a id="L1279" class="source_line" href="#L1279">1279</a>
<a id="L1280" class="source_line" href="#L1280">1280</a>
<a id="L1281" class="source_line" href="#L1281">1281</a>
<a id="L1282" class="source_line" href="#L1282">1282</a>
<a id="L1283" class="source_line" href="#L1283">1283</a>
<a id="L1284" class="source_line" href="#L1284">1284</a>
<a id="L1285" class="source_line" href="#L1285">1285</a>
<a id="L1286" class="source_line" href="#L1286">1286</a>
<a id="L1287" class="source_line" href="#L1287">1287</a>
<a id="L1288" class="source_line" href="#L1288">1288</a>
<a id="L1289" class="source_line" href="#L1289">1289</a>
<a id="L1290" class="source_line" href="#L1290">1290</a>
<a id="L1291" class="source_line" href="#L1291">1291</a>
<a id="L1292" class="source_line" href="#L1292">1292</a>
<a id="L1293" class="source_line" href="#L1293">1293</a>
<a id="L1294" class="source_line" href="#L1294">1294</a>
<a id="L1295" class="source_line" href="#L1295">1295</a>
<a id="L1296" class="source_line" href="#L1296">1296</a>
<a id="L1297" class="source_line" href="#L1297">1297</a>
<a id="L1298" class="source_line" href="#L1298">1298</a>
<a id="L1299" class="source_line" href="#L1299">1299</a>
<a id="L1300" class="source_line" href="#L1300">1300</a>
<a id="L1301" class="source_line" href="#L1301">1301</a>
<a id="L1302" class="source_line" href="#L1302">1302</a>
<a id="L1303" class="source_line" href="#L1303">1303</a>
<a id="L1304" class="source_line" href="#L1304">1304</a>
<a id="L1305" class="source_line" href="#L1305">1305</a>
<a id="L1306" class="source_line" href="#L1306">1306</a>
<a id="L1307" class="source_line" href="#L1307">1307</a>
<a id="L1308" class="source_line" href="#L1308">1308</a>
<a id="L1309" class="source_line" href="#L1309">1309</a>
<a id="L1310" class="source_line" href="#L1310">1310</a>
<a id="L1311" class="source_line" href="#L1311">1311</a>
<a id="L1312" class="source_line" href="#L1312">1312</a>
<a id="L1313" class="source_line" href="#L1313">1313</a>
<a id="L1314" class="source_line" href="#L1314">1314</a>
<a id="L1315" class="source_line" href="#L1315">1315</a>
<a id="L1316" class="source_line" href="#L1316">1316</a>
<a id="L1317" class="source_line" href="#L1317">1317</a>
<a id="L1318" class="source_line" href="#L1318">1318</a>
<a id="L1319" class="source_line" href="#L1319">1319</a>
<a id="L1320" class="source_line" href="#L1320">1320</a>
<a id="L1321" class="source_line" href="#L1321">1321</a>
<a id="L1322" class="source_line" href="#L1322">1322</a>
<a id="L1323" class="source_line" href="#L1323">1323</a>
<a id="L1324" class="source_line" href="#L1324">1324</a>
<a id="L1325" class="source_line" href="#L1325">1325</a>
<a id="L1326" class="source_line" href="#L1326">1326</a>
<a id="L1327" class="source_line" href="#L1327">1327</a>
<a id="L1328" class="source_line" href="#L1328">1328</a>
<a id="L1329" class="source_line" href="#L1329">1329</a>
<a id="L1330" class="source_line" href="#L1330">1330</a>
<a id="L1331" class="source_line" href="#L1331">1331</a>
<a id="L1332" class="source_line" href="#L1332">1332</a>
<a id="L1333" class="source_line" href="#L1333">1333</a>
<a id="L1334" class="source_line" href="#L1334">1334</a>
<a id="L1335" class="source_line" href="#L1335">1335</a>
<a id="L1336" class="source_line" href="#L1336">1336</a>
<a id="L1337" class="source_line" href="#L1337">1337</a>
<a id="L1338" class="source_line" href="#L1338">1338</a>
<a id="L1339" class="source_line" href="#L1339">1339</a>
<a id="L1340" class="source_line" href="#L1340">1340</a>
<a id="L1341" class="source_line" href="#L1341">1341</a>
<a id="L1342" class="source_line" href="#L1342">1342</a>
<a id="L1343" class="source_line" href="#L1343">1343</a>
<a id="L1344" class="source_line" href="#L1344">1344</a>
<a id="L1345" class="source_line" href="#L1345">1345</a>
<a id="L1346" class="source_line" href="#L1346">1346</a>
<a id="L1347" class="source_line" href="#L1347">1347</a>
<a id="L1348" class="source_line" href="#L1348">1348</a>
<a id="L1349" class="source_line" href="#L1349">1349</a>
<a id="L1350" class="source_line" href="#L1350">1350</a>
<a id="L1351" class="source_line" href="#L1351">1351</a>
<a id="L1352" class="source_line" href="#L1352">1352</a>
<a id="L1353" class="source_line" href="#L1353">1353</a>
<a id="L1354" class="source_line" href="#L1354">1354</a>
<a id="L1355" class="source_line" href="#L1355">1355</a>
<a id="L1356" class="source_line" href="#L1356">1356</a>
<a id="L1357" class="source_line" href="#L1357">1357</a>
<a id="L1358" class="source_line" href="#L1358">1358</a>
<a id="L1359" class="source_line" href="#L1359">1359</a>
<a id="L1360" class="source_line" href="#L1360">1360</a>
<a id="L1361" class="source_line" href="#L1361">1361</a>
<a id="L1362" class="source_line" href="#L1362">1362</a>
<a id="L1363" class="source_line" href="#L1363">1363</a>
<a id="L1364" class="source_line" href="#L1364">1364</a>
<a id="L1365" class="source_line" href="#L1365">1365</a>
<a id="L1366" class="source_line" href="#L1366">1366</a>
<a id="L1367" class="source_line" href="#L1367">1367</a>
<a id="L1368" class="source_line" href="#L1368">1368</a>
<a id="L1369" class="source_line" href="#L1369">1369</a>
<a id="L1370" class="source_line" href="#L1370">1370</a>
<a id="L1371" class="source_line" href="#L1371">1371</a>
<a id="L1372" class="source_line" href="#L1372">1372</a>
<a id="L1373" class="source_line" href="#L1373">1373</a>
<a id="L1374" class="source_line" href="#L1374">1374</a>
<a id="L1375" class="source_line" href="#L1375">1375</a>
<a id="L1376" class="source_line" href="#L1376">1376</a>
<a id="L1377" class="source_line" href="#L1377">1377</a>
<a id="L1378" class="source_line" href="#L1378">1378</a>
<a id="L1379" class="source_line" href="#L1379">1379</a>
<a id="L1380" class="source_line" href="#L1380">1380</a>
<a id="L1381" class="source_line" href="#L1381">1381</a>
<a id="L1382" class="source_line" href="#L1382">1382</a>
<a id="L1383" class="source_line" href="#L1383">1383</a>
<a id="L1384" class="source_line" href="#L1384">1384</a>
<a id="L1385" class="source_line" href="#L1385">1385</a>
<a id="L1386" class="source_line" href="#L1386">1386</a>
<a id="L1387" class="source_line" href="#L1387">1387</a>
<a id="L1388" class="source_line" href="#L1388">1388</a>
<a id="L1389" class="source_line" href="#L1389">1389</a>
<a id="L1390" class="source_line" href="#L1390">1390</a>
<a id="L1391" class="source_line" href="#L1391">1391</a>
<a id="L1392" class="source_line" href="#L1392">1392</a>
<a id="L1393" class="source_line" href="#L1393">1393</a>
<a id="L1394" class="source_line" href="#L1394">1394</a>
<a id="L1395" class="source_line" href="#L1395">1395</a>
<a id="L1396" class="source_line" href="#L1396">1396</a>
<a id="L1397" class="source_line" href="#L1397">1397</a>
<a id="L1398" class="source_line" href="#L1398">1398</a>
<a id="L1399" class="source_line" href="#L1399">1399</a>
<a id="L1400" class="source_line" href="#L1400">1400</a>
<a id="L1401" class="source_line" href="#L1401">1401</a>
<a id="L1402" class="source_line" href="#L1402">1402</a>
<a id="L1403" class="source_line" href="#L1403">1403</a>
<a id="L1404" class="source_line" href="#L1404">1404</a>
<a id="L1405" class="source_line" href="#L1405">1405</a>
<a id="L1406" class="source_line" href="#L1406">1406</a>
<a id="L1407" class="source_line" href="#L1407">1407</a>
<a id="L1408" class="source_line" href="#L1408">1408</a>
<a id="L1409" class="source_line" href="#L1409">1409</a>
<a id="L1410" class="source_line" href="#L1410">1410</a>
<a id="L1411" class="source_line" href="#L1411">1411</a>
<a id="L1412" class="source_line" href="#L1412">1412</a>
<a id="L1413" class="source_line" href="#L1413">1413</a>
<a id="L1414" class="source_line" href="#L1414">1414</a>
<a id="L1415" class="source_line" href="#L1415">1415</a>
<a id="L1416" class="source_line" href="#L1416">1416</a>
<a id="L1417" class="source_line" href="#L1417">1417</a>
<a id="L1418" class="source_line" href="#L1418">1418</a>
<a id="L1419" class="source_line" href="#L1419">1419</a>
<a id="L1420" class="source_line" href="#L1420">1420</a>
<a id="L1421" class="source_line" href="#L1421">1421</a>
<a id="L1422" class="source_line" href="#L1422">1422</a>
<a id="L1423" class="source_line" href="#L1423">1423</a>
<a id="L1424" class="source_line" href="#L1424">1424</a>
<a id="L1425" class="source_line" href="#L1425">1425</a>
<a id="L1426" class="source_line" href="#L1426">1426</a>
<a id="L1427" class="source_line" href="#L1427">1427</a>
<a id="L1428" class="source_line" href="#L1428">1428</a>
<a id="L1429" class="source_line" href="#L1429">1429</a>
<a id="L1430" class="source_line" href="#L1430">1430</a>
<a id="L1431" class="source_line" href="#L1431">1431</a>
<a id="L1432" class="source_line" href="#L1432">1432</a>
<a id="L1433" class="source_line" href="#L1433">1433</a>
<a id="L1434" class="source_line" href="#L1434">1434</a>
<a id="L1435" class="source_line" href="#L1435">1435</a>
<a id="L1436" class="source_line" href="#L1436">1436</a>
<a id="L1437" class="source_line" href="#L1437">1437</a>
<a id="L1438" class="source_line" href="#L1438">1438</a>
<a id="L1439" class="source_line" href="#L1439">1439</a>
<a id="L1440" class="source_line" href="#L1440">1440</a>
<a id="L1441" class="source_line" href="#L1441">1441</a>
<a id="L1442" class="source_line" href="#L1442">1442</a>
<a id="L1443" class="source_line" href="#L1443">1443</a>
<a id="L1444" class="source_line" href="#L1444">1444</a>
<a id="L1445" class="source_line" href="#L1445">1445</a>
<a id="L1446" class="source_line" href="#L1446">1446</a>
<a id="L1447" class="source_line" href="#L1447">1447</a>
<a id="L1448" class="source_line" href="#L1448">1448</a>
<a id="L1449" class="source_line" href="#L1449">1449</a>
<a id="L1450" class="source_line" href="#L1450">1450</a>
<a id="L1451" class="source_line" href="#L1451">1451</a>
<a id="L1452" class="source_line" href="#L1452">1452</a>
<a id="L1453" class="source_line" href="#L1453">1453</a>
<a id="L1454" class="source_line" href="#L1454">1454</a>
<a id="L1455" class="source_line" href="#L1455">1455</a>
<a id="L1456" class="source_line" href="#L1456">1456</a>
<a id="L1457" class="source_line" href="#L1457">1457</a>
<a id="L1458" class="source_line" href="#L1458">1458</a>
<a id="L1459" class="source_line" href="#L1459">1459</a>
<a id="L1460" class="source_line" href="#L1460">1460</a>
<a id="L1461" class="source_line" href="#L1461">1461</a>
<a id="L1462" class="source_line" href="#L1462">1462</a>
<a id="L1463" class="source_line" href="#L1463">1463</a>
<a id="L1464" class="source_line" href="#L1464">1464</a>
<a id="L1465" class="source_line" href="#L1465">1465</a>
<a id="L1466" class="source_line" href="#L1466">1466</a>
<a id="L1467" class="source_line" href="#L1467">1467</a>
<a id="L1468" class="source_line" href="#L1468">1468</a>
<a id="L1469" class="source_line" href="#L1469">1469</a>
<a id="L1470" class="source_line" href="#L1470">1470</a>
<a id="L1471" class="source_line" href="#L1471">1471</a>
<a id="L1472" class="source_line" href="#L1472">1472</a>
<a id="L1473" class="source_line" href="#L1473">1473</a>
<a id="L1474" class="source_line" href="#L1474">1474</a>
<a id="L1475" class="source_line" href="#L1475">1475</a>
<a id="L1476" class="source_line" href="#L1476">1476</a>
<a id="L1477" class="source_line" href="#L1477">1477</a>
<a id="L1478" class="source_line" href="#L1478">1478</a>
<a id="L1479" class="source_line" href="#L1479">1479</a>
<a id="L1480" class="source_line" href="#L1480">1480</a>
<a id="L1481" class="source_line" href="#L1481">1481</a>
<a id="L1482" class="source_line" href="#L1482">1482</a>
<a id="L1483" class="source_line" href="#L1483">1483</a>
<a id="L1484" class="source_line" href="#L1484">1484</a>
<a id="L1485" class="source_line" href="#L1485">1485</a>
<a id="L1486" class="source_line" href="#L1486">1486</a>
<a id="L1487" class="source_line" href="#L1487">1487</a>
<a id="L1488" class="source_line" href="#L1488">1488</a>
<a id="L1489" class="source_line" href="#L1489">1489</a>
<a id="L1490" class="source_line" href="#L1490">1490</a>
<a id="L1491" class="source_line" href="#L1491">1491</a>
<a id="L1492" class="source_line" href="#L1492">1492</a>
<a id="L1493" class="source_line" href="#L1493">1493</a>
<a id="L1494" class="source_line" href="#L1494">1494</a>
<a id="L1495" class="source_line" href="#L1495">1495</a>
<a id="L1496" class="source_line" href="#L1496">1496</a>
<a id="L1497" class="source_line" href="#L1497">1497</a>
<a id="L1498" class="source_line" href="#L1498">1498</a>
<a id="L1499" class="source_line" href="#L1499">1499</a>
<a id="L1500" class="source_line" href="#L1500">1500</a>
<a id="L1501" class="source_line" href="#L1501">1501</a>
<a id="L1502" class="source_line" href="#L1502">1502</a>
<a id="L1503" class="source_line" href="#L1503">1503</a>
<a id="L1504" class="source_line" href="#L1504">1504</a>
<a id="L1505" class="source_line" href="#L1505">1505</a>
<a id="L1506" class="source_line" href="#L1506">1506</a>
<a id="L1507" class="source_line" href="#L1507">1507</a>
<a id="L1508" class="source_line" href="#L1508">1508</a>
<a id="L1509" class="source_line" href="#L1509">1509</a>
<a id="L1510" class="source_line" href="#L1510">1510</a>
<a id="L1511" class="source_line" href="#L1511">1511</a>
<a id="L1512" class="source_line" href="#L1512">1512</a>
<a id="L1513" class="source_line" href="#L1513">1513</a>
<a id="L1514" class="source_line" href="#L1514">1514</a>
<a id="L1515" class="source_line" href="#L1515">1515</a>
<a id="L1516" class="source_line" href="#L1516">1516</a>
<a id="L1517" class="source_line" href="#L1517">1517</a>
<a id="L1518" class="source_line" href="#L1518">1518</a>
<a id="L1519" class="source_line" href="#L1519">1519</a>
<a id="L1520" class="source_line" href="#L1520">1520</a>
<a id="L1521" class="source_line" href="#L1521">1521</a>
<a id="L1522" class="source_line" href="#L1522">1522</a>
<a id="L1523" class="source_line" href="#L1523">1523</a>
<a id="L1524" class="source_line" href="#L1524">1524</a>
<a id="L1525" class="source_line" href="#L1525">1525</a>
<a id="L1526" class="source_line" href="#L1526">1526</a>
<a id="L1527" class="source_line" href="#L1527">1527</a>
<a id="L1528" class="source_line" href="#L1528">1528</a>
<a id="L1529" class="source_line" href="#L1529">1529</a>
<a id="L1530" class="source_line" href="#L1530">1530</a>
<a id="L1531" class="source_line" href="#L1531">1531</a>
<a id="L1532" class="source_line" href="#L1532">1532</a>
<a id="L1533" class="source_line" href="#L1533">1533</a>
<a id="L1534" class="source_line" href="#L1534">1534</a>
<a id="L1535" class="source_line" href="#L1535">1535</a>
<a id="L1536" class="source_line" href="#L1536">1536</a>
<a id="L1537" class="source_line" href="#L1537">1537</a>
<a id="L1538" class="source_line" href="#L1538">1538</a>
<a id="L1539" class="source_line" href="#L1539">1539</a>
<a id="L1540" class="source_line" href="#L1540">1540</a>
<a id="L1541" class="source_line" href="#L1541">1541</a>
<a id="L1542" class="source_line" href="#L1542">1542</a>
<a id="L1543" class="source_line" href="#L1543">1543</a>
<a id="L1544" class="source_line" href="#L1544">1544</a>
<a id="L1545" class="source_line" href="#L1545">1545</a>
<a id="L1546" class="source_line" href="#L1546">1546</a>
<a id="L1547" class="source_line" href="#L1547">1547</a>
<a id="L1548" class="source_line" href="#L1548">1548</a>
<a id="L1549" class="source_line" href="#L1549">1549</a>
<a id="L1550" class="source_line" href="#L1550">1550</a>
<a id="L1551" class="source_line" href="#L1551">1551</a>
<a id="L1552" class="source_line" href="#L1552">1552</a>
<a id="L1553" class="source_line" href="#L1553">1553</a>
<a id="L1554" class="source_line" href="#L1554">1554</a>
<a id="L1555" class="source_line" href="#L1555">1555</a>
<a id="L1556" class="source_line" href="#L1556">1556</a>
<a id="L1557" class="source_line" href="#L1557">1557</a>
<a id="L1558" class="source_line" href="#L1558">1558</a>
<a id="L1559" class="source_line" href="#L1559">1559</a>
<a id="L1560" class="source_line" href="#L1560">1560</a>
<a id="L1561" class="source_line" href="#L1561">1561</a>
<a id="L1562" class="source_line" href="#L1562">1562</a>
<a id="L1563" class="source_line" href="#L1563">1563</a>
<a id="L1564" class="source_line" href="#L1564">1564</a>
<a id="L1565" class="source_line" href="#L1565">1565</a>
<a id="L1566" class="source_line" href="#L1566">1566</a>
<a id="L1567" class="source_line" href="#L1567">1567</a>
<a id="L1568" class="source_line" href="#L1568">1568</a>
<a id="L1569" class="source_line" href="#L1569">1569</a>
<a id="L1570" class="source_line" href="#L1570">1570</a>
<a id="L1571" class="source_line" href="#L1571">1571</a>
<a id="L1572" class="source_line" href="#L1572">1572</a>
<a id="L1573" class="source_line" href="#L1573">1573</a>
<a id="L1574" class="source_line" href="#L1574">1574</a>
<a id="L1575" class="source_line" href="#L1575">1575</a>
<a id="L1576" class="source_line" href="#L1576">1576</a>
<a id="L1577" class="source_line" href="#L1577">1577</a>
<a id="L1578" class="source_line" href="#L1578">1578</a>
<a id="L1579" class="source_line" href="#L1579">1579</a>
<a id="L1580" class="source_line" href="#L1580">1580</a>
<a id="L1581" class="source_line" href="#L1581">1581</a>
<a id="L1582" class="source_line" href="#L1582">1582</a>
<a id="L1583" class="source_line" href="#L1583">1583</a>
<a id="L1584" class="source_line" href="#L1584">1584</a>
<a id="L1585" class="source_line" href="#L1585">1585</a>
<a id="L1586" class="source_line" href="#L1586">1586</a>
<a id="L1587" class="source_line" href="#L1587">1587</a>
<a id="L1588" class="source_line" href="#L1588">1588</a>
<a id="L1589" class="source_line" href="#L1589">1589</a>
<a id="L1590" class="source_line" href="#L1590">1590</a>
<a id="L1591" class="source_line" href="#L1591">1591</a>
<a id="L1592" class="source_line" href="#L1592">1592</a>
<a id="L1593" class="source_line" href="#L1593">1593</a>
<a id="L1594" class="source_line" href="#L1594">1594</a>
<a id="L1595" class="source_line" href="#L1595">1595</a>
<a id="L1596" class="source_line" href="#L1596">1596</a>
<a id="L1597" class="source_line" href="#L1597">1597</a>
<a id="L1598" class="source_line" href="#L1598">1598</a>
<a id="L1599" class="source_line" href="#L1599">1599</a>
<a id="L1600" class="source_line" href="#L1600">1600</a>
<a id="L1601" class="source_line" href="#L1601">1601</a>
<a id="L1602" class="source_line" href="#L1602">1602</a>
<a id="L1603" class="source_line" href="#L1603">1603</a>
<a id="L1604" class="source_line" href="#L1604">1604</a>
<a id="L1605" class="source_line" href="#L1605">1605</a>
<a id="L1606" class="source_line" href="#L1606">1606</a>
<a id="L1607" class="source_line" href="#L1607">1607</a>
<a id="L1608" class="source_line" href="#L1608">1608</a>
<a id="L1609" class="source_line" href="#L1609">1609</a>
<a id="L1610" class="source_line" href="#L1610">1610</a>
<a id="L1611" class="source_line" href="#L1611">1611</a>
<a id="L1612" class="source_line" href="#L1612">1612</a>
<a id="L1613" class="source_line" href="#L1613">1613</a>
<a id="L1614" class="source_line" href="#L1614">1614</a>
<a id="L1615" class="source_line" href="#L1615">1615</a>
<a id="L1616" class="source_line" href="#L1616">1616</a>
<a id="L1617" class="source_line" href="#L1617">1617</a>
<a id="L1618" class="source_line" href="#L1618">1618</a>
<a id="L1619" class="source_line" href="#L1619">1619</a>
<a id="L1620" class="source_line" href="#L1620">1620</a>
<a id="L1621" class="source_line" href="#L1621">1621</a>
<a id="L1622" class="source_line" href="#L1622">1622</a>
<a id="L1623" class="source_line" href="#L1623">1623</a>
<a id="L1624" class="source_line" href="#L1624">1624</a>
<a id="L1625" class="source_line" href="#L1625">1625</a>
<a id="L1626" class="source_line" href="#L1626">1626</a>
<a id="L1627" class="source_line" href="#L1627">1627</a>
<a id="L1628" class="source_line" href="#L1628">1628</a>
<a id="L1629" class="source_line" href="#L1629">1629</a>
<a id="L1630" class="source_line" href="#L1630">1630</a>
<a id="L1631" class="source_line" href="#L1631">1631</a>
<a id="L1632" class="source_line" href="#L1632">1632</a>
<a id="L1633" class="source_line" href="#L1633">1633</a>
<a id="L1634" class="source_line" href="#L1634">1634</a>
<a id="L1635" class="source_line" href="#L1635">1635</a>
<a id="L1636" class="source_line" href="#L1636">1636</a>
<a id="L1637" class="source_line" href="#L1637">1637</a>
<a id="L1638" class="source_line" href="#L1638">1638</a>
<a id="L1639" class="source_line" href="#L1639">1639</a>
<a id="L1640" class="source_line" href="#L1640">1640</a>
<a id="L1641" class="source_line" href="#L1641">1641</a>
<a id="L1642" class="source_line" href="#L1642">1642</a>
<a id="L1643" class="source_line" href="#L1643">1643</a>
<a id="L1644" class="source_line" href="#L1644">1644</a>
<a id="L1645" class="source_line" href="#L1645">1645</a>
<a id="L1646" class="source_line" href="#L1646">1646</a>
<a id="L1647" class="source_line" href="#L1647">1647</a>
<a id="L1648" class="source_line" href="#L1648">1648</a>
<a id="L1649" class="source_line" href="#L1649">1649</a>
<a id="L1650" class="source_line" href="#L1650">1650</a>
<a id="L1651" class="source_line" href="#L1651">1651</a>
<a id="L1652" class="source_line" href="#L1652">1652</a>
<a id="L1653" class="source_line" href="#L1653">1653</a>
<a id="L1654" class="source_line" href="#L1654">1654</a>
<a id="L1655" class="source_line" href="#L1655">1655</a>
<a id="L1656" class="source_line" href="#L1656">1656</a>
<a id="L1657" class="source_line" href="#L1657">1657</a>
<a id="L1658" class="source_line" href="#L1658">1658</a>
<a id="L1659" class="source_line" href="#L1659">1659</a>
<a id="L1660" class="source_line" href="#L1660">1660</a>
<a id="L1661" class="source_line" href="#L1661">1661</a>
<a id="L1662" class="source_line" href="#L1662">1662</a>
<a id="L1663" class="source_line" href="#L1663">1663</a>
<a id="L1664" class="source_line" href="#L1664">1664</a>
<a id="L1665" class="source_line" href="#L1665">1665</a>
<a id="L1666" class="source_line" href="#L1666">1666</a>
<a id="L1667" class="source_line" href="#L1667">1667</a>
<a id="L1668" class="source_line" href="#L1668">1668</a>
<a id="L1669" class="source_line" href="#L1669">1669</a>
<a id="L1670" class="source_line" href="#L1670">1670</a>
<a id="L1671" class="source_line" href="#L1671">1671</a>
<a id="L1672" class="source_line" href="#L1672">1672</a>
<a id="L1673" class="source_line" href="#L1673">1673</a>
<a id="L1674" class="source_line" href="#L1674">1674</a>
<a id="L1675" class="source_line" href="#L1675">1675</a>
<a id="L1676" class="source_line" href="#L1676">1676</a>
<a id="L1677" class="source_line" href="#L1677">1677</a>
<a id="L1678" class="source_line" href="#L1678">1678</a>
<a id="L1679" class="source_line" href="#L1679">1679</a>
<a id="L1680" class="source_line" href="#L1680">1680</a>
<a id="L1681" class="source_line" href="#L1681">1681</a>
<a id="L1682" class="source_line" href="#L1682">1682</a>
<a id="L1683" class="source_line" href="#L1683">1683</a>
<a id="L1684" class="source_line" href="#L1684">1684</a>
<a id="L1685" class="source_line" href="#L1685">1685</a>
<a id="L1686" class="source_line" href="#L1686">1686</a>
<a id="L1687" class="source_line" href="#L1687">1687</a>
<a id="L1688" class="source_line" href="#L1688">1688</a>
<a id="L1689" class="source_line" href="#L1689">1689</a>
<a id="L1690" class="source_line" href="#L1690">1690</a>
<a id="L1691" class="source_line" href="#L1691">1691</a>
<a id="L1692" class="source_line" href="#L1692">1692</a>
<a id="L1693" class="source_line" href="#L1693">1693</a>
<a id="L1694" class="source_line" href="#L1694">1694</a>
<a id="L1695" class="source_line" href="#L1695">1695</a>
<a id="L1696" class="source_line" href="#L1696">1696</a>
<a id="L1697" class="source_line" href="#L1697">1697</a>
<a id="L1698" class="source_line" href="#L1698">1698</a>
<a id="L1699" class="source_line" href="#L1699">1699</a>
<a id="L1700" class="source_line" href="#L1700">1700</a>
<a id="L1701" class="source_line" href="#L1701">1701</a>
<a id="L1702" class="source_line" href="#L1702">1702</a>
<a id="L1703" class="source_line" href="#L1703">1703</a>
<a id="L1704" class="source_line" href="#L1704">1704</a>
<a id="L1705" class="source_line" href="#L1705">1705</a>
<a id="L1706" class="source_line" href="#L1706">1706</a>
<a id="L1707" class="source_line" href="#L1707">1707</a>
<a id="L1708" class="source_line" href="#L1708">1708</a>
<a id="L1709" class="source_line" href="#L1709">1709</a>
<a id="L1710" class="source_line" href="#L1710">1710</a>
<a id="L1711" class="source_line" href="#L1711">1711</a>
<a id="L1712" class="source_line" href="#L1712">1712</a>
<a id="L1713" class="source_line" href="#L1713">1713</a>
<a id="L1714" class="source_line" href="#L1714">1714</a>
<a id="L1715" class="source_line" href="#L1715">1715</a>
<a id="L1716" class="source_line" href="#L1716">1716</a>
<a id="L1717" class="source_line" href="#L1717">1717</a>
<a id="L1718" class="source_line" href="#L1718">1718</a>
<a id="L1719" class="source_line" href="#L1719">1719</a>
<a id="L1720" class="source_line" href="#L1720">1720</a>
<a id="L1721" class="source_line" href="#L1721">1721</a>
<a id="L1722" class="source_line" href="#L1722">1722</a>
<a id="L1723" class="source_line" href="#L1723">1723</a>
<a id="L1724" class="source_line" href="#L1724">1724</a>
<a id="L1725" class="source_line" href="#L1725">1725</a>
<a id="L1726" class="source_line" href="#L1726">1726</a>
<a id="L1727" class="source_line" href="#L1727">1727</a>
<a id="L1728" class="source_line" href="#L1728">1728</a>
<a id="L1729" class="source_line" href="#L1729">1729</a>
<a id="L1730" class="source_line" href="#L1730">1730</a>
<a id="L1731" class="source_line" href="#L1731">1731</a>
<a id="L1732" class="source_line" href="#L1732">1732</a>
<a id="L1733" class="source_line" href="#L1733">1733</a>
<a id="L1734" class="source_line" href="#L1734">1734</a>
<a id="L1735" class="source_line" href="#L1735">1735</a>
<a id="L1736" class="source_line" href="#L1736">1736</a>
<a id="L1737" class="source_line" href="#L1737">1737</a>
<a id="L1738" class="source_line" href="#L1738">1738</a>
<a id="L1739" class="source_line" href="#L1739">1739</a>
<a id="L1740" class="source_line" href="#L1740">1740</a>
<a id="L1741" class="source_line" href="#L1741">1741</a>
<a id="L1742" class="source_line" href="#L1742">1742</a>
<a id="L1743" class="source_line" href="#L1743">1743</a>
<a id="L1744" class="source_line" href="#L1744">1744</a>
<a id="L1745" class="source_line" href="#L1745">1745</a>
<a id="L1746" class="source_line" href="#L1746">1746</a>
<a id="L1747" class="source_line" href="#L1747">1747</a>
<a id="L1748" class="source_line" href="#L1748">1748</a>
<a id="L1749" class="source_line" href="#L1749">1749</a>
<a id="L1750" class="source_line" href="#L1750">1750</a>
<a id="L1751" class="source_line" href="#L1751">1751</a>
<a id="L1752" class="source_line" href="#L1752">1752</a>
<a id="L1753" class="source_line" href="#L1753">1753</a>
<a id="L1754" class="source_line" href="#L1754">1754</a>
<a id="L1755" class="source_line" href="#L1755">1755</a>
<a id="L1756" class="source_line" href="#L1756">1756</a>
<a id="L1757" class="source_line" href="#L1757">1757</a>
<a id="L1758" class="source_line" href="#L1758">1758</a>
<a id="L1759" class="source_line" href="#L1759">1759</a>
<a id="L1760" class="source_line" href="#L1760">1760</a>
<a id="L1761" class="source_line" href="#L1761">1761</a>
<a id="L1762" class="source_line" href="#L1762">1762</a>
<a id="L1763" class="source_line" href="#L1763">1763</a>
<a id="L1764" class="source_line" href="#L1764">1764</a>
<a id="L1765" class="source_line" href="#L1765">1765</a>
<a id="L1766" class="source_line" href="#L1766">1766</a>
<a id="L1767" class="source_line" href="#L1767">1767</a>
<a id="L1768" class="source_line" href="#L1768">1768</a>
<a id="L1769" class="source_line" href="#L1769">1769</a>
<a id="L1770" class="source_line" href="#L1770">1770</a>
<a id="L1771" class="source_line" href="#L1771">1771</a>
<a id="L1772" class="source_line" href="#L1772">1772</a>
<a id="L1773" class="source_line" href="#L1773">1773</a>
<a id="L1774" class="source_line" href="#L1774">1774</a>
<a id="L1775" class="source_line" href="#L1775">1775</a>
<a id="L1776" class="source_line" href="#L1776">1776</a>
<a id="L1777" class="source_line" href="#L1777">1777</a>
<a id="L1778" class="source_line" href="#L1778">1778</a>
<a id="L1779" class="source_line" href="#L1779">1779</a>
<a id="L1780" class="source_line" href="#L1780">1780</a>
<a id="L1781" class="source_line" href="#L1781">1781</a>
<a id="L1782" class="source_line" href="#L1782">1782</a>
<a id="L1783" class="source_line" href="#L1783">1783</a>
<a id="L1784" class="source_line" href="#L1784">1784</a>
<a id="L1785" class="source_line" href="#L1785">1785</a>
<a id="L1786" class="source_line" href="#L1786">1786</a>
<a id="L1787" class="source_line" href="#L1787">1787</a>
<a id="L1788" class="source_line" href="#L1788">1788</a>
<a id="L1789" class="source_line" href="#L1789">1789</a>
<a id="L1790" class="source_line" href="#L1790">1790</a>
<a id="L1791" class="source_line" href="#L1791">1791</a>
<a id="L1792" class="source_line" href="#L1792">1792</a>
<a id="L1793" class="source_line" href="#L1793">1793</a>
<a id="L1794" class="source_line" href="#L1794">1794</a>
<a id="L1795" class="source_line" href="#L1795">1795</a>
<a id="L1796" class="source_line" href="#L1796">1796</a>
<a id="L1797" class="source_line" href="#L1797">1797</a>
<a id="L1798" class="source_line" href="#L1798">1798</a>
<a id="L1799" class="source_line" href="#L1799">1799</a>
<a id="L1800" class="source_line" href="#L1800">1800</a>
<a id="L1801" class="source_line" href="#L1801">1801</a>
<a id="L1802" class="source_line" href="#L1802">1802</a>
<a id="L1803" class="source_line" href="#L1803">1803</a>
<a id="L1804" class="source_line" href="#L1804">1804</a>
<a id="L1805" class="source_line" href="#L1805">1805</a>
<a id="L1806" class="source_line" href="#L1806">1806</a>
<a id="L1807" class="source_line" href="#L1807">1807</a>
<a id="L1808" class="source_line" href="#L1808">1808</a>
<a id="L1809" class="source_line" href="#L1809">1809</a>
<a id="L1810" class="source_line" href="#L1810">1810</a>
<a id="L1811" class="source_line" href="#L1811">1811</a>
<a id="L1812" class="source_line" href="#L1812">1812</a>
<a id="L1813" class="source_line" href="#L1813">1813</a>
<a id="L1814" class="source_line" href="#L1814">1814</a>
<a id="L1815" class="source_line" href="#L1815">1815</a>
<a id="L1816" class="source_line" href="#L1816">1816</a>
<a id="L1817" class="source_line" href="#L1817">1817</a>
<a id="L1818" class="source_line" href="#L1818">1818</a>
<a id="L1819" class="source_line" href="#L1819">1819</a>
<a id="L1820" class="source_line" href="#L1820">1820</a>
<a id="L1821" class="source_line" href="#L1821">1821</a>
<a id="L1822" class="source_line" href="#L1822">1822</a>
<a id="L1823" class="source_line" href="#L1823">1823</a>
<a id="L1824" class="source_line" href="#L1824">1824</a>
<a id="L1825" class="source_line" href="#L1825">1825</a>
<a id="L1826" class="source_line" href="#L1826">1826</a>
<a id="L1827" class="source_line" href="#L1827">1827</a>
<a id="L1828" class="source_line" href="#L1828">1828</a>
<a id="L1829" class="source_line" href="#L1829">1829</a>
<a id="L1830" class="source_line" href="#L1830">1830</a>
<a id="L1831" class="source_line" href="#L1831">1831</a>
<a id="L1832" class="source_line" href="#L1832">1832</a>
<a id="L1833" class="source_line" href="#L1833">1833</a>
<a id="L1834" class="source_line" href="#L1834">1834</a>
<a id="L1835" class="source_line" href="#L1835">1835</a>
<a id="L1836" class="source_line" href="#L1836">1836</a>
<a id="L1837" class="source_line" href="#L1837">1837</a>
<a id="L1838" class="source_line" href="#L1838">1838</a>
<a id="L1839" class="source_line" href="#L1839">1839</a>
<a id="L1840" class="source_line" href="#L1840">1840</a>
<a id="L1841" class="source_line" href="#L1841">1841</a>
<a id="L1842" class="source_line" href="#L1842">1842</a>
<a id="L1843" class="source_line" href="#L1843">1843</a>
<a id="L1844" class="source_line" href="#L1844">1844</a>
<a id="L1845" class="source_line" href="#L1845">1845</a>
<a id="L1846" class="source_line" href="#L1846">1846</a>
<a id="L1847" class="source_line" href="#L1847">1847</a>
<a id="L1848" class="source_line" href="#L1848">1848</a>
<a id="L1849" class="source_line" href="#L1849">1849</a>
<a id="L1850" class="source_line" href="#L1850">1850</a>
<a id="L1851" class="source_line" href="#L1851">1851</a>
<a id="L1852" class="source_line" href="#L1852">1852</a>
<a id="L1853" class="source_line" href="#L1853">1853</a>
<a id="L1854" class="source_line" href="#L1854">1854</a>
<a id="L1855" class="source_line" href="#L1855">1855</a>
<a id="L1856" class="source_line" href="#L1856">1856</a>
<a id="L1857" class="source_line" href="#L1857">1857</a>
<a id="L1858" class="source_line" href="#L1858">1858</a>
<a id="L1859" class="source_line" href="#L1859">1859</a>
<a id="L1860" class="source_line" href="#L1860">1860</a>
<a id="L1861" class="source_line" href="#L1861">1861</a>
<a id="L1862" class="source_line" href="#L1862">1862</a>
<a id="L1863" class="source_line" href="#L1863">1863</a>
<a id="L1864" class="source_line" href="#L1864">1864</a>
<a id="L1865" class="source_line" href="#L1865">1865</a>
<a id="L1866" class="source_line" href="#L1866">1866</a>
<a id="L1867" class="source_line" href="#L1867">1867</a>
<a id="L1868" class="source_line" href="#L1868">1868</a>
<a id="L1869" class="source_line" href="#L1869">1869</a>
<a id="L1870" class="source_line" href="#L1870">1870</a>
<a id="L1871" class="source_line" href="#L1871">1871</a>
<a id="L1872" class="source_line" href="#L1872">1872</a>
<a id="L1873" class="source_line" href="#L1873">1873</a>
<a id="L1874" class="source_line" href="#L1874">1874</a>
<a id="L1875" class="source_line" href="#L1875">1875</a>
<a id="L1876" class="source_line" href="#L1876">1876</a>
<a id="L1877" class="source_line" href="#L1877">1877</a>
<a id="L1878" class="source_line" href="#L1878">1878</a>
<a id="L1879" class="source_line" href="#L1879">1879</a>
<a id="L1880" class="source_line" href="#L1880">1880</a>
<a id="L1881" class="source_line" href="#L1881">1881</a>
<a id="L1882" class="source_line" href="#L1882">1882</a>
<a id="L1883" class="source_line" href="#L1883">1883</a>
<a id="L1884" class="source_line" href="#L1884">1884</a>
<a id="L1885" class="source_line" href="#L1885">1885</a>
<a id="L1886" class="source_line" href="#L1886">1886</a>
<a id="L1887" class="source_line" href="#L1887">1887</a>
<a id="L1888" class="source_line" href="#L1888">1888</a>
<a id="L1889" class="source_line" href="#L1889">1889</a>
<a id="L1890" class="source_line" href="#L1890">1890</a>
<a id="L1891" class="source_line" href="#L1891">1891</a>
<a id="L1892" class="source_line" href="#L1892">1892</a>
<a id="L1893" class="source_line" href="#L1893">1893</a>
<a id="L1894" class="source_line" href="#L1894">1894</a>
<a id="L1895" class="source_line" href="#L1895">1895</a>
<a id="L1896" class="source_line" href="#L1896">1896</a>
<a id="L1897" class="source_line" href="#L1897">1897</a>
<a id="L1898" class="source_line" href="#L1898">1898</a>
<a id="L1899" class="source_line" href="#L1899">1899</a>
<a id="L1900" class="source_line" href="#L1900">1900</a>
<a id="L1901" class="source_line" href="#L1901">1901</a>
<a id="L1902" class="source_line" href="#L1902">1902</a>
<a id="L1903" class="source_line" href="#L1903">1903</a>
<a id="L1904" class="source_line" href="#L1904">1904</a>
<a id="L1905" class="source_line" href="#L1905">1905</a>
<a id="L1906" class="source_line" href="#L1906">1906</a>
<a id="L1907" class="source_line" href="#L1907">1907</a>
<a id="L1908" class="source_line" href="#L1908">1908</a>
<a id="L1909" class="source_line" href="#L1909">1909</a>
<a id="L1910" class="source_line" href="#L1910">1910</a>
<a id="L1911" class="source_line" href="#L1911">1911</a>
<a id="L1912" class="source_line" href="#L1912">1912</a>
<a id="L1913" class="source_line" href="#L1913">1913</a>
<a id="L1914" class="source_line" href="#L1914">1914</a>
<a id="L1915" class="source_line" href="#L1915">1915</a>
<a id="L1916" class="source_line" href="#L1916">1916</a>
<a id="L1917" class="source_line" href="#L1917">1917</a>
<a id="L1918" class="source_line" href="#L1918">1918</a>
<a id="L1919" class="source_line" href="#L1919">1919</a>
<a id="L1920" class="source_line" href="#L1920">1920</a>
<a id="L1921" class="source_line" href="#L1921">1921</a>
<a id="L1922" class="source_line" href="#L1922">1922</a>
<a id="L1923" class="source_line" href="#L1923">1923</a>
<a id="L1924" class="source_line" href="#L1924">1924</a>
<a id="L1925" class="source_line" href="#L1925">1925</a>
<a id="L1926" class="source_line" href="#L1926">1926</a>
<a id="L1927" class="source_line" href="#L1927">1927</a>
<a id="L1928" class="source_line" href="#L1928">1928</a>
<a id="L1929" class="source_line" href="#L1929">1929</a>
<a id="L1930" class="source_line" href="#L1930">1930</a>
<a id="L1931" class="source_line" href="#L1931">1931</a>
<a id="L1932" class="source_line" href="#L1932">1932</a>
<a id="L1933" class="source_line" href="#L1933">1933</a>
<a id="L1934" class="source_line" href="#L1934">1934</a>
<a id="L1935" class="source_line" href="#L1935">1935</a>
<a id="L1936" class="source_line" href="#L1936">1936</a>
<a id="L1937" class="source_line" href="#L1937">1937</a>
<a id="L1938" class="source_line" href="#L1938">1938</a>
<a id="L1939" class="source_line" href="#L1939">1939</a>
<a id="L1940" class="source_line" href="#L1940">1940</a>
<a id="L1941" class="source_line" href="#L1941">1941</a>
<a id="L1942" class="source_line" href="#L1942">1942</a>
<a id="L1943" class="source_line" href="#L1943">1943</a>
<a id="L1944" class="source_line" href="#L1944">1944</a>
<a id="L1945" class="source_line" href="#L1945">1945</a>
<a id="L1946" class="source_line" href="#L1946">1946</a>
<a id="L1947" class="source_line" href="#L1947">1947</a>
<a id="L1948" class="source_line" href="#L1948">1948</a>
<a id="L1949" class="source_line" href="#L1949">1949</a>
<a id="L1950" class="source_line" href="#L1950">1950</a>
<a id="L1951" class="source_line" href="#L1951">1951</a>
<a id="L1952" class="source_line" href="#L1952">1952</a>
<a id="L1953" class="source_line" href="#L1953">1953</a>
<a id="L1954" class="source_line" href="#L1954">1954</a>
<a id="L1955" class="source_line" href="#L1955">1955</a>
<a id="L1956" class="source_line" href="#L1956">1956</a>
<a id="L1957" class="source_line" href="#L1957">1957</a>
<a id="L1958" class="source_line" href="#L1958">1958</a>
<a id="L1959" class="source_line" href="#L1959">1959</a>
<a id="L1960" class="source_line" href="#L1960">1960</a>
<a id="L1961" class="source_line" href="#L1961">1961</a>
<a id="L1962" class="source_line" href="#L1962">1962</a>
<a id="L1963" class="source_line" href="#L1963">1963</a>
<a id="L1964" class="source_line" href="#L1964">1964</a>
<a id="L1965" class="source_line" href="#L1965">1965</a>
<a id="L1966" class="source_line" href="#L1966">1966</a>
<a id="L1967" class="source_line" href="#L1967">1967</a>
<a id="L1968" class="source_line" href="#L1968">1968</a>
<a id="L1969" class="source_line" href="#L1969">1969</a>
<a id="L1970" class="source_line" href="#L1970">1970</a>
<a id="L1971" class="source_line" href="#L1971">1971</a>
<a id="L1972" class="source_line" href="#L1972">1972</a>
<a id="L1973" class="source_line" href="#L1973">1973</a>
<a id="L1974" class="source_line" href="#L1974">1974</a>
<a id="L1975" class="source_line" href="#L1975">1975</a>
<a id="L1976" class="source_line" href="#L1976">1976</a>
<a id="L1977" class="source_line" href="#L1977">1977</a>
<a id="L1978" class="source_line" href="#L1978">1978</a>
<a id="L1979" class="source_line" href="#L1979">1979</a>
<a id="L1980" class="source_line" href="#L1980">1980</a>
<a id="L1981" class="source_line" href="#L1981">1981</a>
<a id="L1982" class="source_line" href="#L1982">1982</a>
<a id="L1983" class="source_line" href="#L1983">1983</a>
<a id="L1984" class="source_line" href="#L1984">1984</a>
<a id="L1985" class="source_line" href="#L1985">1985</a>
<a id="L1986" class="source_line" href="#L1986">1986</a>
<a id="L1987" class="source_line" href="#L1987">1987</a>
<a id="L1988" class="source_line" href="#L1988">1988</a>
<a id="L1989" class="source_line" href="#L1989">1989</a>
<a id="L1990" class="source_line" href="#L1990">1990</a>
<a id="L1991" class="source_line" href="#L1991">1991</a>
<a id="L1992" class="source_line" href="#L1992">1992</a>
<a id="L1993" class="source_line" href="#L1993">1993</a>
<a id="L1994" class="source_line" href="#L1994">1994</a>
<a id="L1995" class="source_line" href="#L1995">1995</a>
<a id="L1996" class="source_line" href="#L1996">1996</a>
<a id="L1997" class="source_line" href="#L1997">1997</a>
<a id="L1998" class="source_line" href="#L1998">1998</a>
<a id="L1999" class="source_line" href="#L1999">1999</a>
<a id="L2000" class="source_line" href="#L2000">2000</a>
<a id="L2001" class="source_line" href="#L2001">2001</a>
<a id="L2002" class="source_line" href="#L2002">2002</a>
<a id="L2003" class="source_line" href="#L2003">2003</a>
<a id="L2004" class="source_line" href="#L2004">2004</a>
<a id="L2005" class="source_line" href="#L2005">2005</a>
<a id="L2006" class="source_line" href="#L2006">2006</a>
<a id="L2007" class="source_line" href="#L2007">2007</a>
<a id="L2008" class="source_line" href="#L2008">2008</a>
<a id="L2009" class="source_line" href="#L2009">2009</a>
<a id="L2010" class="source_line" href="#L2010">2010</a>
<a id="L2011" class="source_line" href="#L2011">2011</a>
<a id="L2012" class="source_line" href="#L2012">2012</a>
<a id="L2013" class="source_line" href="#L2013">2013</a>
<a id="L2014" class="source_line" href="#L2014">2014</a>
<a id="L2015" class="source_line" href="#L2015">2015</a>
<a id="L2016" class="source_line" href="#L2016">2016</a>
<a id="L2017" class="source_line" href="#L2017">2017</a>
<a id="L2018" class="source_line" href="#L2018">2018</a>
<a id="L2019" class="source_line" href="#L2019">2019</a>
<a id="L2020" class="source_line" href="#L2020">2020</a>
<a id="L2021" class="source_line" href="#L2021">2021</a>
<a id="L2022" class="source_line" href="#L2022">2022</a>
<a id="L2023" class="source_line" href="#L2023">2023</a>
<a id="L2024" class="source_line" href="#L2024">2024</a>
<a id="L2025" class="source_line" href="#L2025">2025</a>
<a id="L2026" class="source_line" href="#L2026">2026</a>
<a id="L2027" class="source_line" href="#L2027">2027</a>
<a id="L2028" class="source_line" href="#L2028">2028</a>
<a id="L2029" class="source_line" href="#L2029">2029</a>
<a id="L2030" class="source_line" href="#L2030">2030</a>
<a id="L2031" class="source_line" href="#L2031">2031</a>
<a id="L2032" class="source_line" href="#L2032">2032</a>
<a id="L2033" class="source_line" href="#L2033">2033</a>
<a id="L2034" class="source_line" href="#L2034">2034</a>
<a id="L2035" class="source_line" href="#L2035">2035</a>
<a id="L2036" class="source_line" href="#L2036">2036</a>
<a id="L2037" class="source_line" href="#L2037">2037</a>
<a id="L2038" class="source_line" href="#L2038">2038</a>
<a id="L2039" class="source_line" href="#L2039">2039</a>
<a id="L2040" class="source_line" href="#L2040">2040</a>
<a id="L2041" class="source_line" href="#L2041">2041</a>
<a id="L2042" class="source_line" href="#L2042">2042</a>
<a id="L2043" class="source_line" href="#L2043">2043</a>
<a id="L2044" class="source_line" href="#L2044">2044</a>
<a id="L2045" class="source_line" href="#L2045">2045</a>
<a id="L2046" class="source_line" href="#L2046">2046</a>
<a id="L2047" class="source_line" href="#L2047">2047</a>
<a id="L2048" class="source_line" href="#L2048">2048</a>
<a id="L2049" class="source_line" href="#L2049">2049</a>
<a id="L2050" class="source_line" href="#L2050">2050</a>
<a id="L2051" class="source_line" href="#L2051">2051</a>
<a id="L2052" class="source_line" href="#L2052">2052</a>
<a id="L2053" class="source_line" href="#L2053">2053</a>
<a id="L2054" class="source_line" href="#L2054">2054</a>
<a id="L2055" class="source_line" href="#L2055">2055</a>
<a id="L2056" class="source_line" href="#L2056">2056</a>
<a id="L2057" class="source_line" href="#L2057">2057</a>
<a id="L2058" class="source_line" href="#L2058">2058</a>
<a id="L2059" class="source_line" href="#L2059">2059</a>
<a id="L2060" class="source_line" href="#L2060">2060</a>
<a id="L2061" class="source_line" href="#L2061">2061</a>
<a id="L2062" class="source_line" href="#L2062">2062</a>
<a id="L2063" class="source_line" href="#L2063">2063</a>
<a id="L2064" class="source_line" href="#L2064">2064</a>
<a id="L2065" class="source_line" href="#L2065">2065</a>
<a id="L2066" class="source_line" href="#L2066">2066</a>
<a id="L2067" class="source_line" href="#L2067">2067</a>
<a id="L2068" class="source_line" href="#L2068">2068</a>
<a id="L2069" class="source_line" href="#L2069">2069</a>
<a id="L2070" class="source_line" href="#L2070">2070</a>
<a id="L2071" class="source_line" href="#L2071">2071</a>
<a id="L2072" class="source_line" href="#L2072">2072</a>
<a id="L2073" class="source_line" href="#L2073">2073</a>
<a id="L2074" class="source_line" href="#L2074">2074</a>
<a id="L2075" class="source_line" href="#L2075">2075</a>
<a id="L2076" class="source_line" href="#L2076">2076</a>
<a id="L2077" class="source_line" href="#L2077">2077</a>
<a id="L2078" class="source_line" href="#L2078">2078</a>
<a id="L2079" class="source_line" href="#L2079">2079</a>
<a id="L2080" class="source_line" href="#L2080">2080</a>
<a id="L2081" class="source_line" href="#L2081">2081</a>
<a id="L2082" class="source_line" href="#L2082">2082</a>
<a id="L2083" class="source_line" href="#L2083">2083</a>
<a id="L2084" class="source_line" href="#L2084">2084</a>
<a id="L2085" class="source_line" href="#L2085">2085</a>
<a id="L2086" class="source_line" href="#L2086">2086</a>
<a id="L2087" class="source_line" href="#L2087">2087</a>
<a id="L2088" class="source_line" href="#L2088">2088</a>
<a id="L2089" class="source_line" href="#L2089">2089</a>
<a id="L2090" class="source_line" href="#L2090">2090</a>
<a id="L2091" class="source_line" href="#L2091">2091</a>
<a id="L2092" class="source_line" href="#L2092">2092</a>
<a id="L2093" class="source_line" href="#L2093">2093</a>
<a id="L2094" class="source_line" href="#L2094">2094</a>
<a id="L2095" class="source_line" href="#L2095">2095</a>
<a id="L2096" class="source_line" href="#L2096">2096</a>
<a id="L2097" class="source_line" href="#L2097">2097</a>
<a id="L2098" class="source_line" href="#L2098">2098</a>
<a id="L2099" class="source_line" href="#L2099">2099</a>
<a id="L2100" class="source_line" href="#L2100">2100</a>
<a id="L2101" class="source_line" href="#L2101">2101</a>
<a id="L2102" class="source_line" href="#L2102">2102</a>
<a id="L2103" class="source_line" href="#L2103">2103</a>
<a id="L2104" class="source_line" href="#L2104">2104</a>
<a id="L2105" class="source_line" href="#L2105">2105</a>
<a id="L2106" class="source_line" href="#L2106">2106</a>
<a id="L2107" class="source_line" href="#L2107">2107</a>
<a id="L2108" class="source_line" href="#L2108">2108</a>
<a id="L2109" class="source_line" href="#L2109">2109</a>
<a id="L2110" class="source_line" href="#L2110">2110</a>
<a id="L2111" class="source_line" href="#L2111">2111</a>
<a id="L2112" class="source_line" href="#L2112">2112</a>
<a id="L2113" class="source_line" href="#L2113">2113</a>
<a id="L2114" class="source_line" href="#L2114">2114</a>
<a id="L2115" class="source_line" href="#L2115">2115</a>
<a id="L2116" class="source_line" href="#L2116">2116</a>
<a id="L2117" class="source_line" href="#L2117">2117</a>
<a id="L2118" class="source_line" href="#L2118">2118</a>
<a id="L2119" class="source_line" href="#L2119">2119</a>
<a id="L2120" class="source_line" href="#L2120">2120</a>
<a id="L2121" class="source_line" href="#L2121">2121</a>
<a id="L2122" class="source_line" href="#L2122">2122</a>
<a id="L2123" class="source_line" href="#L2123">2123</a>
<a id="L2124" class="source_line" href="#L2124">2124</a>
<a id="L2125" class="source_line" href="#L2125">2125</a>
<a id="L2126" class="source_line" href="#L2126">2126</a>
<a id="L2127" class="source_line" href="#L2127">2127</a>
<a id="L2128" class="source_line" href="#L2128">2128</a>
<a id="L2129" class="source_line" href="#L2129">2129</a>
<a id="L2130" class="source_line" href="#L2130">2130</a>
<a id="L2131" class="source_line" href="#L2131">2131</a>
<a id="L2132" class="source_line" href="#L2132">2132</a>
<a id="L2133" class="source_line" href="#L2133">2133</a>
<a id="L2134" class="source_line" href="#L2134">2134</a>
<a id="L2135" class="source_line" href="#L2135">2135</a>
<a id="L2136" class="source_line" href="#L2136">2136</a>
<a id="L2137" class="source_line" href="#L2137">2137</a>
<a id="L2138" class="source_line" href="#L2138">2138</a>
<a id="L2139" class="source_line" href="#L2139">2139</a>
<a id="L2140" class="source_line" href="#L2140">2140</a>
<a id="L2141" class="source_line" href="#L2141">2141</a>
<a id="L2142" class="source_line" href="#L2142">2142</a>
<a id="L2143" class="source_line" href="#L2143">2143</a>
<a id="L2144" class="source_line" href="#L2144">2144</a>
<a id="L2145" class="source_line" href="#L2145">2145</a>
<a id="L2146" class="source_line" href="#L2146">2146</a>
<a id="L2147" class="source_line" href="#L2147">2147</a>
<a id="L2148" class="source_line" href="#L2148">2148</a>
<a id="L2149" class="source_line" href="#L2149">2149</a>
<a id="L2150" class="source_line" href="#L2150">2150</a>
<a id="L2151" class="source_line" href="#L2151">2151</a>
<a id="L2152" class="source_line" href="#L2152">2152</a>
<a id="L2153" class="source_line" href="#L2153">2153</a>
<a id="L2154" class="source_line" href="#L2154">2154</a>
<a id="L2155" class="source_line" href="#L2155">2155</a>
<a id="L2156" class="source_line" href="#L2156">2156</a>
<a id="L2157" class="source_line" href="#L2157">2157</a>
<a id="L2158" class="source_line" href="#L2158">2158</a>
<a id="L2159" class="source_line" href="#L2159">2159</a>
<a id="L2160" class="source_line" href="#L2160">2160</a>
<a id="L2161" class="source_line" href="#L2161">2161</a>
<a id="L2162" class="source_line" href="#L2162">2162</a>
<a id="L2163" class="source_line" href="#L2163">2163</a>
<a id="L2164" class="source_line" href="#L2164">2164</a>
<a id="L2165" class="source_line" href="#L2165">2165</a>
<a id="L2166" class="source_line" href="#L2166">2166</a>
<a id="L2167" class="source_line" href="#L2167">2167</a>
<a id="L2168" class="source_line" href="#L2168">2168</a>
<a id="L2169" class="source_line" href="#L2169">2169</a>
<a id="L2170" class="source_line" href="#L2170">2170</a>
<a id="L2171" class="source_line" href="#L2171">2171</a>
<a id="L2172" class="source_line" href="#L2172">2172</a>
<a id="L2173" class="source_line" href="#L2173">2173</a>
<a id="L2174" class="source_line" href="#L2174">2174</a>
<a id="L2175" class="source_line" href="#L2175">2175</a>
<a id="L2176" class="source_line" href="#L2176">2176</a>
<a id="L2177" class="source_line" href="#L2177">2177</a>
<a id="L2178" class="source_line" href="#L2178">2178</a>
<a id="L2179" class="source_line" href="#L2179">2179</a>
<a id="L2180" class="source_line" href="#L2180">2180</a>
<a id="L2181" class="source_line" href="#L2181">2181</a>
<a id="L2182" class="source_line" href="#L2182">2182</a>
<a id="L2183" class="source_line" href="#L2183">2183</a>
<a id="L2184" class="source_line" href="#L2184">2184</a>
<a id="L2185" class="source_line" href="#L2185">2185</a>
<a id="L2186" class="source_line" href="#L2186">2186</a>
<a id="L2187" class="source_line" href="#L2187">2187</a>
<a id="L2188" class="source_line" href="#L2188">2188</a>
<a id="L2189" class="source_line" href="#L2189">2189</a>
<a id="L2190" class="source_line" href="#L2190">2190</a>
<a id="L2191" class="source_line" href="#L2191">2191</a>
<a id="L2192" class="source_line" href="#L2192">2192</a>
<a id="L2193" class="source_line" href="#L2193">2193</a>
<a id="L2194" class="source_line" href="#L2194">2194</a>
<a id="L2195" class="source_line" href="#L2195">2195</a>
<a id="L2196" class="source_line" href="#L2196">2196</a>
<a id="L2197" class="source_line" href="#L2197">2197</a>
<a id="L2198" class="source_line" href="#L2198">2198</a>
<a id="L2199" class="source_line" href="#L2199">2199</a>
<a id="L2200" class="source_line" href="#L2200">2200</a>
<a id="L2201" class="source_line" href="#L2201">2201</a>
<a id="L2202" class="source_line" href="#L2202">2202</a>
<a id="L2203" class="source_line" href="#L2203">2203</a>
<a id="L2204" class="source_line" href="#L2204">2204</a>
<a id="L2205" class="source_line" href="#L2205">2205</a>
<a id="L2206" class="source_line" href="#L2206">2206</a>
<a id="L2207" class="source_line" href="#L2207">2207</a>
<a id="L2208" class="source_line" href="#L2208">2208</a>
<a id="L2209" class="source_line" href="#L2209">2209</a>
<a id="L2210" class="source_line" href="#L2210">2210</a>
<a id="L2211" class="source_line" href="#L2211">2211</a>
<a id="L2212" class="source_line" href="#L2212">2212</a>
<a id="L2213" class="source_line" href="#L2213">2213</a>
<a id="L2214" class="source_line" href="#L2214">2214</a>
<a id="L2215" class="source_line" href="#L2215">2215</a>
<a id="L2216" class="source_line" href="#L2216">2216</a>
<a id="L2217" class="source_line" href="#L2217">2217</a>
<a id="L2218" class="source_line" href="#L2218">2218</a>
<a id="L2219" class="source_line" href="#L2219">2219</a>
<a id="L2220" class="source_line" href="#L2220">2220</a>
<a id="L2221" class="source_line" href="#L2221">2221</a>
<a id="L2222" class="source_line" href="#L2222">2222</a>
<a id="L2223" class="source_line" href="#L2223">2223</a>
<a id="L2224" class="source_line" href="#L2224">2224</a>
<a id="L2225" class="source_line" href="#L2225">2225</a>
<a id="L2226" class="source_line" href="#L2226">2226</a>
<a id="L2227" class="source_line" href="#L2227">2227</a>
<a id="L2228" class="source_line" href="#L2228">2228</a>
<a id="L2229" class="source_line" href="#L2229">2229</a>
<a id="L2230" class="source_line" href="#L2230">2230</a>
<a id="L2231" class="source_line" href="#L2231">2231</a>
<a id="L2232" class="source_line" href="#L2232">2232</a>
<a id="L2233" class="source_line" href="#L2233">2233</a>
<a id="L2234" class="source_line" href="#L2234">2234</a>
<a id="L2235" class="source_line" href="#L2235">2235</a>
<a id="L2236" class="source_line" href="#L2236">2236</a>
<a id="L2237" class="source_line" href="#L2237">2237</a>
<a id="L2238" class="source_line" href="#L2238">2238</a>
<a id="L2239" class="source_line" href="#L2239">2239</a>
<a id="L2240" class="source_line" href="#L2240">2240</a>
<a id="L2241" class="source_line" href="#L2241">2241</a>
<a id="L2242" class="source_line" href="#L2242">2242</a>
<a id="L2243" class="source_line" href="#L2243">2243</a>
<a id="L2244" class="source_line" href="#L2244">2244</a>
<a id="L2245" class="source_line" href="#L2245">2245</a>
<a id="L2246" class="source_line" href="#L2246">2246</a>
<a id="L2247" class="source_line" href="#L2247">2247</a>
<a id="L2248" class="source_line" href="#L2248">2248</a>
<a id="L2249" class="source_line" href="#L2249">2249</a>
<a id="L2250" class="source_line" href="#L2250">2250</a>
<a id="L2251" class="source_line" href="#L2251">2251</a>
<a id="L2252" class="source_line" href="#L2252">2252</a>
<a id="L2253" class="source_line" href="#L2253">2253</a>
<a id="L2254" class="source_line" href="#L2254">2254</a>
<a id="L2255" class="source_line" href="#L2255">2255</a>
<a id="L2256" class="source_line" href="#L2256">2256</a>
<a id="L2257" class="source_line" href="#L2257">2257</a>
<a id="L2258" class="source_line" href="#L2258">2258</a>
<a id="L2259" class="source_line" href="#L2259">2259</a>
<a id="L2260" class="source_line" href="#L2260">2260</a>
<a id="L2261" class="source_line" href="#L2261">2261</a>
<a id="L2262" class="source_line" href="#L2262">2262</a>
<a id="L2263" class="source_line" href="#L2263">2263</a>
<a id="L2264" class="source_line" href="#L2264">2264</a>
<a id="L2265" class="source_line" href="#L2265">2265</a>
<a id="L2266" class="source_line" href="#L2266">2266</a>
<a id="L2267" class="source_line" href="#L2267">2267</a>
<a id="L2268" class="source_line" href="#L2268">2268</a>
<a id="L2269" class="source_line" href="#L2269">2269</a>
<a id="L2270" class="source_line" href="#L2270">2270</a>
<a id="L2271" class="source_line" href="#L2271">2271</a>
<a id="L2272" class="source_line" href="#L2272">2272</a>
<a id="L2273" class="source_line" href="#L2273">2273</a>
<a id="L2274" class="source_line" href="#L2274">2274</a>
<a id="L2275" class="source_line" href="#L2275">2275</a>
<a id="L2276" class="source_line" href="#L2276">2276</a>
<a id="L2277" class="source_line" href="#L2277">2277</a>
<a id="L2278" class="source_line" href="#L2278">2278</a>
<a id="L2279" class="source_line" href="#L2279">2279</a>
<a id="L2280" class="source_line" href="#L2280">2280</a>
<a id="L2281" class="source_line" href="#L2281">2281</a>
<a id="L2282" class="source_line" href="#L2282">2282</a>
<a id="L2283" class="source_line" href="#L2283">2283</a>
<a id="L2284" class="source_line" href="#L2284">2284</a>
<a id="L2285" class="source_line" href="#L2285">2285</a>
<a id="L2286" class="source_line" href="#L2286">2286</a>
<a id="L2287" class="source_line" href="#L2287">2287</a>
<a id="L2288" class="source_line" href="#L2288">2288</a>
<a id="L2289" class="source_line" href="#L2289">2289</a>
<a id="L2290" class="source_line" href="#L2290">2290</a>
<a id="L2291" class="source_line" href="#L2291">2291</a>
<a id="L2292" class="source_line" href="#L2292">2292</a>
<a id="L2293" class="source_line" href="#L2293">2293</a>
<a id="L2294" class="source_line" href="#L2294">2294</a>
<a id="L2295" class="source_line" href="#L2295">2295</a>
<a id="L2296" class="source_line" href="#L2296">2296</a>
<a id="L2297" class="source_line" href="#L2297">2297</a>
<a id="L2298" class="source_line" href="#L2298">2298</a>
<a id="L2299" class="source_line" href="#L2299">2299</a>
<a id="L2300" class="source_line" href="#L2300">2300</a>
<a id="L2301" class="source_line" href="#L2301">2301</a>
<a id="L2302" class="source_line" href="#L2302">2302</a>
<a id="L2303" class="source_line" href="#L2303">2303</a>
<a id="L2304" class="source_line" href="#L2304">2304</a>
<a id="L2305" class="source_line" href="#L2305">2305</a>
<a id="L2306" class="source_line" href="#L2306">2306</a>
<a id="L2307" class="source_line" href="#L2307">2307</a>
<a id="L2308" class="source_line" href="#L2308">2308</a>
<a id="L2309" class="source_line" href="#L2309">2309</a>
<a id="L2310" class="source_line" href="#L2310">2310</a>
<a id="L2311" class="source_line" href="#L2311">2311</a>
<a id="L2312" class="source_line" href="#L2312">2312</a>
<a id="L2313" class="source_line" href="#L2313">2313</a>
<a id="L2314" class="source_line" href="#L2314">2314</a>
<a id="L2315" class="source_line" href="#L2315">2315</a>
<a id="L2316" class="source_line" href="#L2316">2316</a>
<a id="L2317" class="source_line" href="#L2317">2317</a>
<a id="L2318" class="source_line" href="#L2318">2318</a>
<a id="L2319" class="source_line" href="#L2319">2319</a>
<a id="L2320" class="source_line" href="#L2320">2320</a>
<a id="L2321" class="source_line" href="#L2321">2321</a>
<a id="L2322" class="source_line" href="#L2322">2322</a>
<a id="L2323" class="source_line" href="#L2323">2323</a>
<a id="L2324" class="source_line" href="#L2324">2324</a>
<a id="L2325" class="source_line" href="#L2325">2325</a>
<a id="L2326" class="source_line" href="#L2326">2326</a>
<a id="L2327" class="source_line" href="#L2327">2327</a>
<a id="L2328" class="source_line" href="#L2328">2328</a>
<a id="L2329" class="source_line" href="#L2329">2329</a>
<a id="L2330" class="source_line" href="#L2330">2330</a>
<a id="L2331" class="source_line" href="#L2331">2331</a>
<a id="L2332" class="source_line" href="#L2332">2332</a>
<a id="L2333" class="source_line" href="#L2333">2333</a>
<a id="L2334" class="source_line" href="#L2334">2334</a>
<a id="L2335" class="source_line" href="#L2335">2335</a>
<a id="L2336" class="source_line" href="#L2336">2336</a>
<a id="L2337" class="source_line" href="#L2337">2337</a>
<a id="L2338" class="source_line" href="#L2338">2338</a>
<a id="L2339" class="source_line" href="#L2339">2339</a>
<a id="L2340" class="source_line" href="#L2340">2340</a>
<a id="L2341" class="source_line" href="#L2341">2341</a>
<a id="L2342" class="source_line" href="#L2342">2342</a>
<a id="L2343" class="source_line" href="#L2343">2343</a>
<a id="L2344" class="source_line" href="#L2344">2344</a>
<a id="L2345" class="source_line" href="#L2345">2345</a>
<a id="L2346" class="source_line" href="#L2346">2346</a>
<a id="L2347" class="source_line" href="#L2347">2347</a>
<a id="L2348" class="source_line" href="#L2348">2348</a>
<a id="L2349" class="source_line" href="#L2349">2349</a>
<a id="L2350" class="source_line" href="#L2350">2350</a>
<a id="L2351" class="source_line" href="#L2351">2351</a>
<a id="L2352" class="source_line" href="#L2352">2352</a>
<a id="L2353" class="source_line" href="#L2353">2353</a>
<a id="L2354" class="source_line" href="#L2354">2354</a>
<a id="L2355" class="source_line" href="#L2355">2355</a>
<a id="L2356" class="source_line" href="#L2356">2356</a>
<a id="L2357" class="source_line" href="#L2357">2357</a>
<a id="L2358" class="source_line" href="#L2358">2358</a>
<a id="L2359" class="source_line" href="#L2359">2359</a>
<a id="L2360" class="source_line" href="#L2360">2360</a>
<a id="L2361" class="source_line" href="#L2361">2361</a>
<a id="L2362" class="source_line" href="#L2362">2362</a>
<a id="L2363" class="source_line" href="#L2363">2363</a>
<a id="L2364" class="source_line" href="#L2364">2364</a>
<a id="L2365" class="source_line" href="#L2365">2365</a>
<a id="L2366" class="source_line" href="#L2366">2366</a>
<a id="L2367" class="source_line" href="#L2367">2367</a>
<a id="L2368" class="source_line" href="#L2368">2368</a>
<a id="L2369" class="source_line" href="#L2369">2369</a>
<a id="L2370" class="source_line" href="#L2370">2370</a>
<a id="L2371" class="source_line" href="#L2371">2371</a>
<a id="L2372" class="source_line" href="#L2372">2372</a>
<a id="L2373" class="source_line" href="#L2373">2373</a>
<a id="L2374" class="source_line" href="#L2374">2374</a>
<a id="L2375" class="source_line" href="#L2375">2375</a>
<a id="L2376" class="source_line" href="#L2376">2376</a>
<a id="L2377" class="source_line" href="#L2377">2377</a>
<a id="L2378" class="source_line" href="#L2378">2378</a>
<a id="L2379" class="source_line" href="#L2379">2379</a>
<a id="L2380" class="source_line" href="#L2380">2380</a>
<a id="L2381" class="source_line" href="#L2381">2381</a>
<a id="L2382" class="source_line" href="#L2382">2382</a>
<a id="L2383" class="source_line" href="#L2383">2383</a>
<a id="L2384" class="source_line" href="#L2384">2384</a>
<a id="L2385" class="source_line" href="#L2385">2385</a>
<a id="L2386" class="source_line" href="#L2386">2386</a>
<a id="L2387" class="source_line" href="#L2387">2387</a>
<a id="L2388" class="source_line" href="#L2388">2388</a>
<a id="L2389" class="source_line" href="#L2389">2389</a>
<a id="L2390" class="source_line" href="#L2390">2390</a>
<a id="L2391" class="source_line" href="#L2391">2391</a>
<a id="L2392" class="source_line" href="#L2392">2392</a>
<a id="L2393" class="source_line" href="#L2393">2393</a>
<a id="L2394" class="source_line" href="#L2394">2394</a>
<a id="L2395" class="source_line" href="#L2395">2395</a>
<a id="L2396" class="source_line" href="#L2396">2396</a>
<a id="L2397" class="source_line" href="#L2397">2397</a>
<a id="L2398" class="source_line" href="#L2398">2398</a>
<a id="L2399" class="source_line" href="#L2399">2399</a>
<a id="L2400" class="source_line" href="#L2400">2400</a>
<a id="L2401" class="source_line" href="#L2401">2401</a>
<a id="L2402" class="source_line" href="#L2402">2402</a>
<a id="L2403" class="source_line" href="#L2403">2403</a>
<a id="L2404" class="source_line" href="#L2404">2404</a>
<a id="L2405" class="source_line" href="#L2405">2405</a>
<a id="L2406" class="source_line" href="#L2406">2406</a>
<a id="L2407" class="source_line" href="#L2407">2407</a>
<a id="L2408" class="source_line" href="#L2408">2408</a>
<a id="L2409" class="source_line" href="#L2409">2409</a>
<a id="L2410" class="source_line" href="#L2410">2410</a>
<a id="L2411" class="source_line" href="#L2411">2411</a>
<a id="L2412" class="source_line" href="#L2412">2412</a>
<a id="L2413" class="source_line" href="#L2413">2413</a>
<a id="L2414" class="source_line" href="#L2414">2414</a>
<a id="L2415" class="source_line" href="#L2415">2415</a>
<a id="L2416" class="source_line" href="#L2416">2416</a>
<a id="L2417" class="source_line" href="#L2417">2417</a>
<a id="L2418" class="source_line" href="#L2418">2418</a>
<a id="L2419" class="source_line" href="#L2419">2419</a>
<a id="L2420" class="source_line" href="#L2420">2420</a>
<a id="L2421" class="source_line" href="#L2421">2421</a>
<a id="L2422" class="source_line" href="#L2422">2422</a>
<a id="L2423" class="source_line" href="#L2423">2423</a>
<a id="L2424" class="source_line" href="#L2424">2424</a>
<a id="L2425" class="source_line" href="#L2425">2425</a>
<a id="L2426" class="source_line" href="#L2426">2426</a>
<a id="L2427" class="source_line" href="#L2427">2427</a>
<a id="L2428" class="source_line" href="#L2428">2428</a>
<a id="L2429" class="source_line" href="#L2429">2429</a>
<a id="L2430" class="source_line" href="#L2430">2430</a>
<a id="L2431" class="source_line" href="#L2431">2431</a>
<a id="L2432" class="source_line" href="#L2432">2432</a>
<a id="L2433" class="source_line" href="#L2433">2433</a>
<a id="L2434" class="source_line" href="#L2434">2434</a>
<a id="L2435" class="source_line" href="#L2435">2435</a>
<a id="L2436" class="source_line" href="#L2436">2436</a>
<a id="L2437" class="source_line" href="#L2437">2437</a>
<a id="L2438" class="source_line" href="#L2438">2438</a>
<a id="L2439" class="source_line" href="#L2439">2439</a>
<a id="L2440" class="source_line" href="#L2440">2440</a>
<a id="L2441" class="source_line" href="#L2441">2441</a>
<a id="L2442" class="source_line" href="#L2442">2442</a>
<a id="L2443" class="source_line" href="#L2443">2443</a>
<a id="L2444" class="source_line" href="#L2444">2444</a>
<a id="L2445" class="source_line" href="#L2445">2445</a>
<a id="L2446" class="source_line" href="#L2446">2446</a>
<a id="L2447" class="source_line" href="#L2447">2447</a>
<a id="L2448" class="source_line" href="#L2448">2448</a>
<a id="L2449" class="source_line" href="#L2449">2449</a>
<a id="L2450" class="source_line" href="#L2450">2450</a>
<a id="L2451" class="source_line" href="#L2451">2451</a>
<a id="L2452" class="source_line" href="#L2452">2452</a>
<a id="L2453" class="source_line" href="#L2453">2453</a>
<a id="L2454" class="source_line" href="#L2454">2454</a>
<a id="L2455" class="source_line" href="#L2455">2455</a>
<a id="L2456" class="source_line" href="#L2456">2456</a>
<a id="L2457" class="source_line" href="#L2457">2457</a>
<a id="L2458" class="source_line" href="#L2458">2458</a>
<a id="L2459" class="source_line" href="#L2459">2459</a>
<a id="L2460" class="source_line" href="#L2460">2460</a>
<a id="L2461" class="source_line" href="#L2461">2461</a>
<a id="L2462" class="source_line" href="#L2462">2462</a>
<a id="L2463" class="source_line" href="#L2463">2463</a>
<a id="L2464" class="source_line" href="#L2464">2464</a>
<a id="L2465" class="source_line" href="#L2465">2465</a>
<a id="L2466" class="source_line" href="#L2466">2466</a>
<a id="L2467" class="source_line" href="#L2467">2467</a>
<a id="L2468" class="source_line" href="#L2468">2468</a>
<a id="L2469" class="source_line" href="#L2469">2469</a>
<a id="L2470" class="source_line" href="#L2470">2470</a>
<a id="L2471" class="source_line" href="#L2471">2471</a>
<a id="L2472" class="source_line" href="#L2472">2472</a>
<a id="L2473" class="source_line" href="#L2473">2473</a>
<a id="L2474" class="source_line" href="#L2474">2474</a>
<a id="L2475" class="source_line" href="#L2475">2475</a>
<a id="L2476" class="source_line" href="#L2476">2476</a>
<a id="L2477" class="source_line" href="#L2477">2477</a>
<a id="L2478" class="source_line" href="#L2478">2478</a>
<a id="L2479" class="source_line" href="#L2479">2479</a>
<a id="L2480" class="source_line" href="#L2480">2480</a>
<a id="L2481" class="source_line" href="#L2481">2481</a>
<a id="L2482" class="source_line" href="#L2482">2482</a>
<a id="L2483" class="source_line" href="#L2483">2483</a>
<a id="L2484" class="source_line" href="#L2484">2484</a>
<a id="L2485" class="source_line" href="#L2485">2485</a>
<a id="L2486" class="source_line" href="#L2486">2486</a>
<a id="L2487" class="source_line" href="#L2487">2487</a>
<a id="L2488" class="source_line" href="#L2488">2488</a>
<a id="L2489" class="source_line" href="#L2489">2489</a>
<a id="L2490" class="source_line" href="#L2490">2490</a>
<a id="L2491" class="source_line" href="#L2491">2491</a>
<a id="L2492" class="source_line" href="#L2492">2492</a>
<a id="L2493" class="source_line" href="#L2493">2493</a>
<a id="L2494" class="source_line" href="#L2494">2494</a>
<a id="L2495" class="source_line" href="#L2495">2495</a>
<a id="L2496" class="source_line" href="#L2496">2496</a>
<a id="L2497" class="source_line" href="#L2497">2497</a>
<a id="L2498" class="source_line" href="#L2498">2498</a>
<a id="L2499" class="source_line" href="#L2499">2499</a>
<a id="L2500" class="source_line" href="#L2500">2500</a>
<a id="L2501" class="source_line" href="#L2501">2501</a>
<a id="L2502" class="source_line" href="#L2502">2502</a>
<a id="L2503" class="source_line" href="#L2503">2503</a>
<a id="L2504" class="source_line" href="#L2504">2504</a>
<a id="L2505" class="source_line" href="#L2505">2505</a>
<a id="L2506" class="source_line" href="#L2506">2506</a>
<a id="L2507" class="source_line" href="#L2507">2507</a>
<a id="L2508" class="source_line" href="#L2508">2508</a>
<a id="L2509" class="source_line" href="#L2509">2509</a>
<a id="L2510" class="source_line" href="#L2510">2510</a>
<a id="L2511" class="source_line" href="#L2511">2511</a>
<a id="L2512" class="source_line" href="#L2512">2512</a>
<a id="L2513" class="source_line" href="#L2513">2513</a>
<a id="L2514" class="source_line" href="#L2514">2514</a>
<a id="L2515" class="source_line" href="#L2515">2515</a>
<a id="L2516" class="source_line" href="#L2516">2516</a>
<a id="L2517" class="source_line" href="#L2517">2517</a>
<a id="L2518" class="source_line" href="#L2518">2518</a>
<a id="L2519" class="source_line" href="#L2519">2519</a>
<a id="L2520" class="source_line" href="#L2520">2520</a>
<a id="L2521" class="source_line" href="#L2521">2521</a>
<a id="L2522" class="source_line" href="#L2522">2522</a>
<a id="L2523" class="source_line" href="#L2523">2523</a>
<a id="L2524" class="source_line" href="#L2524">2524</a>
<a id="L2525" class="source_line" href="#L2525">2525</a>
<a id="L2526" class="source_line" href="#L2526">2526</a>
<a id="L2527" class="source_line" href="#L2527">2527</a>
<a id="L2528" class="source_line" href="#L2528">2528</a>
<a id="L2529" class="source_line" href="#L2529">2529</a>
<a id="L2530" class="source_line" href="#L2530">2530</a>
<a id="L2531" class="source_line" href="#L2531">2531</a>
<a id="L2532" class="source_line" href="#L2532">2532</a>
<a id="L2533" class="source_line" href="#L2533">2533</a>
<a id="L2534" class="source_line" href="#L2534">2534</a>
<a id="L2535" class="source_line" href="#L2535">2535</a>
<a id="L2536" class="source_line" href="#L2536">2536</a>
<a id="L2537" class="source_line" href="#L2537">2537</a>
<a id="L2538" class="source_line" href="#L2538">2538</a>
<a id="L2539" class="source_line" href="#L2539">2539</a>
<a id="L2540" class="source_line" href="#L2540">2540</a>
<a id="L2541" class="source_line" href="#L2541">2541</a>
<a id="L2542" class="source_line" href="#L2542">2542</a>
<a id="L2543" class="source_line" href="#L2543">2543</a>
<a id="L2544" class="source_line" href="#L2544">2544</a>
<a id="L2545" class="source_line" href="#L2545">2545</a>
<a id="L2546" class="source_line" href="#L2546">2546</a>
<a id="L2547" class="source_line" href="#L2547">2547</a>
<a id="L2548" class="source_line" href="#L2548">2548</a>
<a id="L2549" class="source_line" href="#L2549">2549</a>
<a id="L2550" class="source_line" href="#L2550">2550</a>
<a id="L2551" class="source_line" href="#L2551">2551</a>
<a id="L2552" class="source_line" href="#L2552">2552</a>
<a id="L2553" class="source_line" href="#L2553">2553</a>
<a id="L2554" class="source_line" href="#L2554">2554</a>
<a id="L2555" class="source_line" href="#L2555">2555</a>
<a id="L2556" class="source_line" href="#L2556">2556</a>
<a id="L2557" class="source_line" href="#L2557">2557</a>
<a id="L2558" class="source_line" href="#L2558">2558</a>
<a id="L2559" class="source_line" href="#L2559">2559</a>
<a id="L2560" class="source_line" href="#L2560">2560</a>
<a id="L2561" class="source_line" href="#L2561">2561</a>
<a id="L2562" class="source_line" href="#L2562">2562</a>
<a id="L2563" class="source_line" href="#L2563">2563</a>
<a id="L2564" class="source_line" href="#L2564">2564</a>
<a id="L2565" class="source_line" href="#L2565">2565</a>
<a id="L2566" class="source_line" href="#L2566">2566</a>
<a id="L2567" class="source_line" href="#L2567">2567</a>
<a id="L2568" class="source_line" href="#L2568">2568</a>
<a id="L2569" class="source_line" href="#L2569">2569</a>
<a id="L2570" class="source_line" href="#L2570">2570</a>
<a id="L2571" class="source_line" href="#L2571">2571</a>
<a id="L2572" class="source_line" href="#L2572">2572</a>
<a id="L2573" class="source_line" href="#L2573">2573</a>
<a id="L2574" class="source_line" href="#L2574">2574</a>
<a id="L2575" class="source_line" href="#L2575">2575</a>
<a id="L2576" class="source_line" href="#L2576">2576</a>
<a id="L2577" class="source_line" href="#L2577">2577</a>
<a id="L2578" class="source_line" href="#L2578">2578</a>
<a id="L2579" class="source_line" href="#L2579">2579</a>
<a id="L2580" class="source_line" href="#L2580">2580</a>
<a id="L2581" class="source_line" href="#L2581">2581</a>
<a id="L2582" class="source_line" href="#L2582">2582</a>
<a id="L2583" class="source_line" href="#L2583">2583</a>
<a id="L2584" class="source_line" href="#L2584">2584</a>
<a id="L2585" class="source_line" href="#L2585">2585</a>
<a id="L2586" class="source_line" href="#L2586">2586</a>
<a id="L2587" class="source_line" href="#L2587">2587</a>
<a id="L2588" class="source_line" href="#L2588">2588</a>
<a id="L2589" class="source_line" href="#L2589">2589</a>
<a id="L2590" class="source_line" href="#L2590">2590</a>
<a id="L2591" class="source_line" href="#L2591">2591</a>
<a id="L2592" class="source_line" href="#L2592">2592</a>
<a id="L2593" class="source_line" href="#L2593">2593</a>
<a id="L2594" class="source_line" href="#L2594">2594</a>
<a id="L2595" class="source_line" href="#L2595">2595</a>
<a id="L2596" class="source_line" href="#L2596">2596</a>
<a id="L2597" class="source_line" href="#L2597">2597</a>
<a id="L2598" class="source_line" href="#L2598">2598</a>
<a id="L2599" class="source_line" href="#L2599">2599</a>
<a id="L2600" class="source_line" href="#L2600">2600</a>
<a id="L2601" class="source_line" href="#L2601">2601</a>
<a id="L2602" class="source_line" href="#L2602">2602</a>
<a id="L2603" class="source_line" href="#L2603">2603</a>
<a id="L2604" class="source_line" href="#L2604">2604</a>
<a id="L2605" class="source_line" href="#L2605">2605</a>
<a id="L2606" class="source_line" href="#L2606">2606</a>
<a id="L2607" class="source_line" href="#L2607">2607</a>
<a id="L2608" class="source_line" href="#L2608">2608</a>
<a id="L2609" class="source_line" href="#L2609">2609</a>
<a id="L2610" class="source_line" href="#L2610">2610</a>
<a id="L2611" class="source_line" href="#L2611">2611</a>
<a id="L2612" class="source_line" href="#L2612">2612</a>
<a id="L2613" class="source_line" href="#L2613">2613</a>
<a id="L2614" class="source_line" href="#L2614">2614</a>
<a id="L2615" class="source_line" href="#L2615">2615</a>
<a id="L2616" class="source_line" href="#L2616">2616</a>
<a id="L2617" class="source_line" href="#L2617">2617</a>
<a id="L2618" class="source_line" href="#L2618">2618</a>
<a id="L2619" class="source_line" href="#L2619">2619</a>
<a id="L2620" class="source_line" href="#L2620">2620</a>
<a id="L2621" class="source_line" href="#L2621">2621</a>
<a id="L2622" class="source_line" href="#L2622">2622</a>
<a id="L2623" class="source_line" href="#L2623">2623</a>
<a id="L2624" class="source_line" href="#L2624">2624</a>
<a id="L2625" class="source_line" href="#L2625">2625</a>
<a id="L2626" class="source_line" href="#L2626">2626</a>
<a id="L2627" class="source_line" href="#L2627">2627</a>
<a id="L2628" class="source_line" href="#L2628">2628</a>
<a id="L2629" class="source_line" href="#L2629">2629</a>
<a id="L2630" class="source_line" href="#L2630">2630</a>
<a id="L2631" class="source_line" href="#L2631">2631</a>
<a id="L2632" class="source_line" href="#L2632">2632</a>
<a id="L2633" class="source_line" href="#L2633">2633</a>
<a id="L2634" class="source_line" href="#L2634">2634</a>
<a id="L2635" class="source_line" href="#L2635">2635</a>
<a id="L2636" class="source_line" href="#L2636">2636</a>
<a id="L2637" class="source_line" href="#L2637">2637</a>
<a id="L2638" class="source_line" href="#L2638">2638</a>
<a id="L2639" class="source_line" href="#L2639">2639</a>
<a id="L2640" class="source_line" href="#L2640">2640</a>
<a id="L2641" class="source_line" href="#L2641">2641</a>
<a id="L2642" class="source_line" href="#L2642">2642</a>
<a id="L2643" class="source_line" href="#L2643">2643</a>
<a id="L2644" class="source_line" href="#L2644">2644</a>
<a id="L2645" class="source_line" href="#L2645">2645</a>
<a id="L2646" class="source_line" href="#L2646">2646</a>
<a id="L2647" class="source_line" href="#L2647">2647</a>
<a id="L2648" class="source_line" href="#L2648">2648</a>
<a id="L2649" class="source_line" href="#L2649">2649</a>
<a id="L2650" class="source_line" href="#L2650">2650</a>
<a id="L2651" class="source_line" href="#L2651">2651</a>
<a id="L2652" class="source_line" href="#L2652">2652</a>
<a id="L2653" class="source_line" href="#L2653">2653</a>
<a id="L2654" class="source_line" href="#L2654">2654</a>
<a id="L2655" class="source_line" href="#L2655">2655</a>
<a id="L2656" class="source_line" href="#L2656">2656</a>
<a id="L2657" class="source_line" href="#L2657">2657</a>
<a id="L2658" class="source_line" href="#L2658">2658</a>
<a id="L2659" class="source_line" href="#L2659">2659</a>
<a id="L2660" class="source_line" href="#L2660">2660</a>
<a id="L2661" class="source_line" href="#L2661">2661</a>
<a id="L2662" class="source_line" href="#L2662">2662</a>
<a id="L2663" class="source_line" href="#L2663">2663</a>
<a id="L2664" class="source_line" href="#L2664">2664</a>
<a id="L2665" class="source_line" href="#L2665">2665</a>
<a id="L2666" class="source_line" href="#L2666">2666</a>
<a id="L2667" class="source_line" href="#L2667">2667</a>
<a id="L2668" class="source_line" href="#L2668">2668</a>
<a id="L2669" class="source_line" href="#L2669">2669</a>
<a id="L2670" class="source_line" href="#L2670">2670</a>
<a id="L2671" class="source_line" href="#L2671">2671</a>
<a id="L2672" class="source_line" href="#L2672">2672</a>
<a id="L2673" class="source_line" href="#L2673">2673</a>
<a id="L2674" class="source_line" href="#L2674">2674</a>
<a id="L2675" class="source_line" href="#L2675">2675</a>
<a id="L2676" class="source_line" href="#L2676">2676</a>
<a id="L2677" class="source_line" href="#L2677">2677</a>
<a id="L2678" class="source_line" href="#L2678">2678</a>
<a id="L2679" class="source_line" href="#L2679">2679</a>
<a id="L2680" class="source_line" href="#L2680">2680</a>
<a id="L2681" class="source_line" href="#L2681">2681</a>
<a id="L2682" class="source_line" href="#L2682">2682</a>
<a id="L2683" class="source_line" href="#L2683">2683</a>
<a id="L2684" class="source_line" href="#L2684">2684</a>
<a id="L2685" class="source_line" href="#L2685">2685</a>
<a id="L2686" class="source_line" href="#L2686">2686</a>
<a id="L2687" class="source_line" href="#L2687">2687</a>
<a id="L2688" class="source_line" href="#L2688">2688</a>
<a id="L2689" class="source_line" href="#L2689">2689</a>
<a id="L2690" class="source_line" href="#L2690">2690</a>
<a id="L2691" class="source_line" href="#L2691">2691</a>
<a id="L2692" class="source_line" href="#L2692">2692</a>
<a id="L2693" class="source_line" href="#L2693">2693</a>
<a id="L2694" class="source_line" href="#L2694">2694</a>
<a id="L2695" class="source_line" href="#L2695">2695</a>
<a id="L2696" class="source_line" href="#L2696">2696</a>
<a id="L2697" class="source_line" href="#L2697">2697</a>
<a id="L2698" class="source_line" href="#L2698">2698</a>
<a id="L2699" class="source_line" href="#L2699">2699</a>
<a id="L2700" class="source_line" href="#L2700">2700</a>
<a id="L2701" class="source_line" href="#L2701">2701</a>
<a id="L2702" class="source_line" href="#L2702">2702</a>
<a id="L2703" class="source_line" href="#L2703">2703</a>
<a id="L2704" class="source_line" href="#L2704">2704</a>
<a id="L2705" class="source_line" href="#L2705">2705</a>
<a id="L2706" class="source_line" href="#L2706">2706</a>
<a id="L2707" class="source_line" href="#L2707">2707</a>
<a id="L2708" class="source_line" href="#L2708">2708</a>
<a id="L2709" class="source_line" href="#L2709">2709</a>
<a id="L2710" class="source_line" href="#L2710">2710</a>
<a id="L2711" class="source_line" href="#L2711">2711</a>
<a id="L2712" class="source_line" href="#L2712">2712</a>
<a id="L2713" class="source_line" href="#L2713">2713</a>
<a id="L2714" class="source_line" href="#L2714">2714</a>
<a id="L2715" class="source_line" href="#L2715">2715</a>
<a id="L2716" class="source_line" href="#L2716">2716</a>
<a id="L2717" class="source_line" href="#L2717">2717</a>
<a id="L2718" class="source_line" href="#L2718">2718</a>
<a id="L2719" class="source_line" href="#L2719">2719</a>
<a id="L2720" class="source_line" href="#L2720">2720</a>
<a id="L2721" class="source_line" href="#L2721">2721</a>
<a id="L2722" class="source_line" href="#L2722">2722</a>
<a id="L2723" class="source_line" href="#L2723">2723</a>
<a id="L2724" class="source_line" href="#L2724">2724</a>
<a id="L2725" class="source_line" href="#L2725">2725</a>
<a id="L2726" class="source_line" href="#L2726">2726</a>
<a id="L2727" class="source_line" href="#L2727">2727</a>
<a id="L2728" class="source_line" href="#L2728">2728</a>
<a id="L2729" class="source_line" href="#L2729">2729</a>
<a id="L2730" class="source_line" href="#L2730">2730</a>
<a id="L2731" class="source_line" href="#L2731">2731</a>
<a id="L2732" class="source_line" href="#L2732">2732</a>
<a id="L2733" class="source_line" href="#L2733">2733</a>
<a id="L2734" class="source_line" href="#L2734">2734</a>
<a id="L2735" class="source_line" href="#L2735">2735</a>
<a id="L2736" class="source_line" href="#L2736">2736</a>
<a id="L2737" class="source_line" href="#L2737">2737</a>
<a id="L2738" class="source_line" href="#L2738">2738</a>
<a id="L2739" class="source_line" href="#L2739">2739</a>
<a id="L2740" class="source_line" href="#L2740">2740</a>
<a id="L2741" class="source_line" href="#L2741">2741</a>
<a id="L2742" class="source_line" href="#L2742">2742</a>
<a id="L2743" class="source_line" href="#L2743">2743</a>
<a id="L2744" class="source_line" href="#L2744">2744</a>
<a id="L2745" class="source_line" href="#L2745">2745</a>
<a id="L2746" class="source_line" href="#L2746">2746</a>
<a id="L2747" class="source_line" href="#L2747">2747</a>
<a id="L2748" class="source_line" href="#L2748">2748</a>
<a id="L2749" class="source_line" href="#L2749">2749</a>
<a id="L2750" class="source_line" href="#L2750">2750</a>
<a id="L2751" class="source_line" href="#L2751">2751</a>
<a id="L2752" class="source_line" href="#L2752">2752</a>
<a id="L2753" class="source_line" href="#L2753">2753</a>
<a id="L2754" class="source_line" href="#L2754">2754</a>
<a id="L2755" class="source_line" href="#L2755">2755</a>
<a id="L2756" class="source_line" href="#L2756">2756</a>
<a id="L2757" class="source_line" href="#L2757">2757</a>
<a id="L2758" class="source_line" href="#L2758">2758</a>
<a id="L2759" class="source_line" href="#L2759">2759</a>
<a id="L2760" class="source_line" href="#L2760">2760</a>
<a id="L2761" class="source_line" href="#L2761">2761</a>
<a id="L2762" class="source_line" href="#L2762">2762</a>
<a id="L2763" class="source_line" href="#L2763">2763</a>
<a id="L2764" class="source_line" href="#L2764">2764</a>
<a id="L2765" class="source_line" href="#L2765">2765</a>
<a id="L2766" class="source_line" href="#L2766">2766</a>
<a id="L2767" class="source_line" href="#L2767">2767</a>
<a id="L2768" class="source_line" href="#L2768">2768</a>
<a id="L2769" class="source_line" href="#L2769">2769</a>
<a id="L2770" class="source_line" href="#L2770">2770</a>
<a id="L2771" class="source_line" href="#L2771">2771</a>
<a id="L2772" class="source_line" href="#L2772">2772</a>
<a id="L2773" class="source_line" href="#L2773">2773</a>
<a id="L2774" class="source_line" href="#L2774">2774</a>
<a id="L2775" class="source_line" href="#L2775">2775</a>
<a id="L2776" class="source_line" href="#L2776">2776</a>
<a id="L2777" class="source_line" href="#L2777">2777</a>
<a id="L2778" class="source_line" href="#L2778">2778</a>
<a id="L2779" class="source_line" href="#L2779">2779</a>
<a id="L2780" class="source_line" href="#L2780">2780</a>
<a id="L2781" class="source_line" href="#L2781">2781</a>
<a id="L2782" class="source_line" href="#L2782">2782</a>
<a id="L2783" class="source_line" href="#L2783">2783</a>
<a id="L2784" class="source_line" href="#L2784">2784</a>
<a id="L2785" class="source_line" href="#L2785">2785</a>
<a id="L2786" class="source_line" href="#L2786">2786</a>
<a id="L2787" class="source_line" href="#L2787">2787</a>
<a id="L2788" class="source_line" href="#L2788">2788</a>
<a id="L2789" class="source_line" href="#L2789">2789</a>
<a id="L2790" class="source_line" href="#L2790">2790</a>
<a id="L2791" class="source_line" href="#L2791">2791</a>
<a id="L2792" class="source_line" href="#L2792">2792</a>
<a id="L2793" class="source_line" href="#L2793">2793</a>
<a id="L2794" class="source_line" href="#L2794">2794</a>
<a id="L2795" class="source_line" href="#L2795">2795</a>
<a id="L2796" class="source_line" href="#L2796">2796</a>
<a id="L2797" class="source_line" href="#L2797">2797</a>
<a id="L2798" class="source_line" href="#L2798">2798</a>
<a id="L2799" class="source_line" href="#L2799">2799</a>
<a id="L2800" class="source_line" href="#L2800">2800</a>
<a id="L2801" class="source_line" href="#L2801">2801</a>
<a id="L2802" class="source_line" href="#L2802">2802</a>
<a id="L2803" class="source_line" href="#L2803">2803</a>
<a id="L2804" class="source_line" href="#L2804">2804</a>
<a id="L2805" class="source_line" href="#L2805">2805</a>
<a id="L2806" class="source_line" href="#L2806">2806</a>
<a id="L2807" class="source_line" href="#L2807">2807</a>
<a id="L2808" class="source_line" href="#L2808">2808</a>
<a id="L2809" class="source_line" href="#L2809">2809</a>
<a id="L2810" class="source_line" href="#L2810">2810</a>
<a id="L2811" class="source_line" href="#L2811">2811</a>
<a id="L2812" class="source_line" href="#L2812">2812</a>
<a id="L2813" class="source_line" href="#L2813">2813</a>
<a id="L2814" class="source_line" href="#L2814">2814</a>
<a id="L2815" class="source_line" href="#L2815">2815</a>
<a id="L2816" class="source_line" href="#L2816">2816</a>
<a id="L2817" class="source_line" href="#L2817">2817</a>
<a id="L2818" class="source_line" href="#L2818">2818</a>
<a id="L2819" class="source_line" href="#L2819">2819</a>
<a id="L2820" class="source_line" href="#L2820">2820</a>
<a id="L2821" class="source_line" href="#L2821">2821</a>
<a id="L2822" class="source_line" href="#L2822">2822</a>
<a id="L2823" class="source_line" href="#L2823">2823</a>
<a id="L2824" class="source_line" href="#L2824">2824</a>
<a id="L2825" class="source_line" href="#L2825">2825</a>
<a id="L2826" class="source_line" href="#L2826">2826</a>
<a id="L2827" class="source_line" href="#L2827">2827</a>
<a id="L2828" class="source_line" href="#L2828">2828</a>
<a id="L2829" class="source_line" href="#L2829">2829</a>
<a id="L2830" class="source_line" href="#L2830">2830</a>
<a id="L2831" class="source_line" href="#L2831">2831</a>
<a id="L2832" class="source_line" href="#L2832">2832</a>
<a id="L2833" class="source_line" href="#L2833">2833</a>
<a id="L2834" class="source_line" href="#L2834">2834</a>
<a id="L2835" class="source_line" href="#L2835">2835</a>
<a id="L2836" class="source_line" href="#L2836">2836</a>
<a id="L2837" class="source_line" href="#L2837">2837</a>
<a id="L2838" class="source_line" href="#L2838">2838</a>
<a id="L2839" class="source_line" href="#L2839">2839</a>
<a id="L2840" class="source_line" href="#L2840">2840</a>
<a id="L2841" class="source_line" href="#L2841">2841</a>
<a id="L2842" class="source_line" href="#L2842">2842</a>
<a id="L2843" class="source_line" href="#L2843">2843</a>
<a id="L2844" class="source_line" href="#L2844">2844</a>
<a id="L2845" class="source_line" href="#L2845">2845</a>
<a id="L2846" class="source_line" href="#L2846">2846</a>
<a id="L2847" class="source_line" href="#L2847">2847</a>
<a id="L2848" class="source_line" href="#L2848">2848</a>
<a id="L2849" class="source_line" href="#L2849">2849</a>
<a id="L2850" class="source_line" href="#L2850">2850</a>
<a id="L2851" class="source_line" href="#L2851">2851</a>
<a id="L2852" class="source_line" href="#L2852">2852</a>
<a id="L2853" class="source_line" href="#L2853">2853</a>
<a id="L2854" class="source_line" href="#L2854">2854</a>
<a id="L2855" class="source_line" href="#L2855">2855</a>
<a id="L2856" class="source_line" href="#L2856">2856</a>
<a id="L2857" class="source_line" href="#L2857">2857</a>
<a id="L2858" class="source_line" href="#L2858">2858</a>
<a id="L2859" class="source_line" href="#L2859">2859</a>
<a id="L2860" class="source_line" href="#L2860">2860</a>
<a id="L2861" class="source_line" href="#L2861">2861</a>
<a id="L2862" class="source_line" href="#L2862">2862</a>
<a id="L2863" class="source_line" href="#L2863">2863</a>
<a id="L2864" class="source_line" href="#L2864">2864</a>
<a id="L2865" class="source_line" href="#L2865">2865</a>
<a id="L2866" class="source_line" href="#L2866">2866</a>
<a id="L2867" class="source_line" href="#L2867">2867</a>
<a id="L2868" class="source_line" href="#L2868">2868</a>
<a id="L2869" class="source_line" href="#L2869">2869</a>
<a id="L2870" class="source_line" href="#L2870">2870</a>
<a id="L2871" class="source_line" href="#L2871">2871</a>
<a id="L2872" class="source_line" href="#L2872">2872</a>
<a id="L2873" class="source_line" href="#L2873">2873</a>
<a id="L2874" class="source_line" href="#L2874">2874</a>
<a id="L2875" class="source_line" href="#L2875">2875</a>
<a id="L2876" class="source_line" href="#L2876">2876</a>
<a id="L2877" class="source_line" href="#L2877">2877</a>
<a id="L2878" class="source_line" href="#L2878">2878</a>
<a id="L2879" class="source_line" href="#L2879">2879</a>
<a id="L2880" class="source_line" href="#L2880">2880</a>
<a id="L2881" class="source_line" href="#L2881">2881</a>
<a id="L2882" class="source_line" href="#L2882">2882</a>
<a id="L2883" class="source_line" href="#L2883">2883</a>
<a id="L2884" class="source_line" href="#L2884">2884</a>
<a id="L2885" class="source_line" href="#L2885">2885</a>
<a id="L2886" class="source_line" href="#L2886">2886</a>
<a id="L2887" class="source_line" href="#L2887">2887</a>
<a id="L2888" class="source_line" href="#L2888">2888</a>
<a id="L2889" class="source_line" href="#L2889">2889</a>
<a id="L2890" class="source_line" href="#L2890">2890</a>
<a id="L2891" class="source_line" href="#L2891">2891</a>
<a id="L2892" class="source_line" href="#L2892">2892</a>
<a id="L2893" class="source_line" href="#L2893">2893</a>
<a id="L2894" class="source_line" href="#L2894">2894</a>
<a id="L2895" class="source_line" href="#L2895">2895</a>
<a id="L2896" class="source_line" href="#L2896">2896</a>
<a id="L2897" class="source_line" href="#L2897">2897</a>
<a id="L2898" class="source_line" href="#L2898">2898</a>
<a id="L2899" class="source_line" href="#L2899">2899</a>
<a id="L2900" class="source_line" href="#L2900">2900</a>
<a id="L2901" class="source_line" href="#L2901">2901</a>
<a id="L2902" class="source_line" href="#L2902">2902</a>
<a id="L2903" class="source_line" href="#L2903">2903</a>
<a id="L2904" class="source_line" href="#L2904">2904</a>
<a id="L2905" class="source_line" href="#L2905">2905</a>
<a id="L2906" class="source_line" href="#L2906">2906</a>
<a id="L2907" class="source_line" href="#L2907">2907</a>
<a id="L2908" class="source_line" href="#L2908">2908</a>
<a id="L2909" class="source_line" href="#L2909">2909</a>
<a id="L2910" class="source_line" href="#L2910">2910</a>
<a id="L2911" class="source_line" href="#L2911">2911</a>
<a id="L2912" class="source_line" href="#L2912">2912</a>
<a id="L2913" class="source_line" href="#L2913">2913</a>
<a id="L2914" class="source_line" href="#L2914">2914</a>
<a id="L2915" class="source_line" href="#L2915">2915</a>
<a id="L2916" class="source_line" href="#L2916">2916</a>
<a id="L2917" class="source_line" href="#L2917">2917</a>
<a id="L2918" class="source_line" href="#L2918">2918</a>
<a id="L2919" class="source_line" href="#L2919">2919</a>
<a id="L2920" class="source_line" href="#L2920">2920</a>
<a id="L2921" class="source_line" href="#L2921">2921</a>
<a id="L2922" class="source_line" href="#L2922">2922</a>
<a id="L2923" class="source_line" href="#L2923">2923</a>
<a id="L2924" class="source_line" href="#L2924">2924</a>
<a id="L2925" class="source_line" href="#L2925">2925</a>
<a id="L2926" class="source_line" href="#L2926">2926</a>
<a id="L2927" class="source_line" href="#L2927">2927</a>
<a id="L2928" class="source_line" href="#L2928">2928</a>
<a id="L2929" class="source_line" href="#L2929">2929</a>
<a id="L2930" class="source_line" href="#L2930">2930</a>
<a id="L2931" class="source_line" href="#L2931">2931</a>
<a id="L2932" class="source_line" href="#L2932">2932</a>
<a id="L2933" class="source_line" href="#L2933">2933</a>
<a id="L2934" class="source_line" href="#L2934">2934</a>
<a id="L2935" class="source_line" href="#L2935">2935</a>
<a id="L2936" class="source_line" href="#L2936">2936</a>
<a id="L2937" class="source_line" href="#L2937">2937</a>
<a id="L2938" class="source_line" href="#L2938">2938</a>
<a id="L2939" class="source_line" href="#L2939">2939</a>
<a id="L2940" class="source_line" href="#L2940">2940</a>
<a id="L2941" class="source_line" href="#L2941">2941</a>
<a id="L2942" class="source_line" href="#L2942">2942</a>
<a id="L2943" class="source_line" href="#L2943">2943</a>
<a id="L2944" class="source_line" href="#L2944">2944</a>
<a id="L2945" class="source_line" href="#L2945">2945</a>
<a id="L2946" class="source_line" href="#L2946">2946</a>
<a id="L2947" class="source_line" href="#L2947">2947</a>
<a id="L2948" class="source_line" href="#L2948">2948</a>
<a id="L2949" class="source_line" href="#L2949">2949</a>
<a id="L2950" class="source_line" href="#L2950">2950</a>
<a id="L2951" class="source_line" href="#L2951">2951</a>
<a id="L2952" class="source_line" href="#L2952">2952</a>
<a id="L2953" class="source_line" href="#L2953">2953</a>
<a id="L2954" class="source_line" href="#L2954">2954</a>
<a id="L2955" class="source_line" href="#L2955">2955</a>
<a id="L2956" class="source_line" href="#L2956">2956</a>
<a id="L2957" class="source_line" href="#L2957">2957</a>
<a id="L2958" class="source_line" href="#L2958">2958</a>
<a id="L2959" class="source_line" href="#L2959">2959</a>
<a id="L2960" class="source_line" href="#L2960">2960</a>
<a id="L2961" class="source_line" href="#L2961">2961</a>
<a id="L2962" class="source_line" href="#L2962">2962</a>
<a id="L2963" class="source_line" href="#L2963">2963</a>
<a id="L2964" class="source_line" href="#L2964">2964</a>
<a id="L2965" class="source_line" href="#L2965">2965</a>
<a id="L2966" class="source_line" href="#L2966">2966</a>
<a id="L2967" class="source_line" href="#L2967">2967</a>
<a id="L2968" class="source_line" href="#L2968">2968</a>
<a id="L2969" class="source_line" href="#L2969">2969</a>
<a id="L2970" class="source_line" href="#L2970">2970</a>
<a id="L2971" class="source_line" href="#L2971">2971</a>
<a id="L2972" class="source_line" href="#L2972">2972</a>
<a id="L2973" class="source_line" href="#L2973">2973</a>
<a id="L2974" class="source_line" href="#L2974">2974</a>
<a id="L2975" class="source_line" href="#L2975">2975</a>
<a id="L2976" class="source_line" href="#L2976">2976</a>
<a id="L2977" class="source_line" href="#L2977">2977</a>
<a id="L2978" class="source_line" href="#L2978">2978</a>
<a id="L2979" class="source_line" href="#L2979">2979</a>
<a id="L2980" class="source_line" href="#L2980">2980</a>
<a id="L2981" class="source_line" href="#L2981">2981</a>
<a id="L2982" class="source_line" href="#L2982">2982</a>
<a id="L2983" class="source_line" href="#L2983">2983</a>
<a id="L2984" class="source_line" href="#L2984">2984</a>
<a id="L2985" class="source_line" href="#L2985">2985</a>
<a id="L2986" class="source_line" href="#L2986">2986</a>
<a id="L2987" class="source_line" href="#L2987">2987</a>
<a id="L2988" class="source_line" href="#L2988">2988</a>
<a id="L2989" class="source_line" href="#L2989">2989</a>
<a id="L2990" class="source_line" href="#L2990">2990</a>
<a id="L2991" class="source_line" href="#L2991">2991</a>
<a id="L2992" class="source_line" href="#L2992">2992</a>
<a id="L2993" class="source_line" href="#L2993">2993</a>
<a id="L2994" class="source_line" href="#L2994">2994</a>
<a id="L2995" class="source_line" href="#L2995">2995</a>
<a id="L2996" class="source_line" href="#L2996">2996</a>
<a id="L2997" class="source_line" href="#L2997">2997</a>
<a id="L2998" class="source_line" href="#L2998">2998</a>
<a id="L2999" class="source_line" href="#L2999">2999</a>
<a id="L3000" class="source_line" href="#L3000">3000</a>
<a id="L3001" class="source_line" href="#L3001">3001</a>
<a id="L3002" class="source_line" href="#L3002">3002</a>
<a id="L3003" class="source_line" href="#L3003">3003</a>
<a id="L3004" class="source_line" href="#L3004">3004</a>
<a id="L3005" class="source_line" href="#L3005">3005</a>
<a id="L3006" class="source_line" href="#L3006">3006</a>
<a id="L3007" class="source_line" href="#L3007">3007</a>
<a id="L3008" class="source_line" href="#L3008">3008</a>
<a id="L3009" class="source_line" href="#L3009">3009</a>
<a id="L3010" class="source_line" href="#L3010">3010</a>
<a id="L3011" class="source_line" href="#L3011">3011</a>
<a id="L3012" class="source_line" href="#L3012">3012</a>
<a id="L3013" class="source_line" href="#L3013">3013</a>
<a id="L3014" class="source_line" href="#L3014">3014</a>
<a id="L3015" class="source_line" href="#L3015">3015</a>
<a id="L3016" class="source_line" href="#L3016">3016</a>
<a id="L3017" class="source_line" href="#L3017">3017</a>
<a id="L3018" class="source_line" href="#L3018">3018</a>
<a id="L3019" class="source_line" href="#L3019">3019</a>
<a id="L3020" class="source_line" href="#L3020">3020</a>
<a id="L3021" class="source_line" href="#L3021">3021</a>
<a id="L3022" class="source_line" href="#L3022">3022</a>
<a id="L3023" class="source_line" href="#L3023">3023</a>
<a id="L3024" class="source_line" href="#L3024">3024</a>
<a id="L3025" class="source_line" href="#L3025">3025</a>
<a id="L3026" class="source_line" href="#L3026">3026</a>
<a id="L3027" class="source_line" href="#L3027">3027</a>
<a id="L3028" class="source_line" href="#L3028">3028</a>
<a id="L3029" class="source_line" href="#L3029">3029</a>
<a id="L3030" class="source_line" href="#L3030">3030</a>
<a id="L3031" class="source_line" href="#L3031">3031</a>
<a id="L3032" class="source_line" href="#L3032">3032</a>
<a id="L3033" class="source_line" href="#L3033">3033</a>
<a id="L3034" class="source_line" href="#L3034">3034</a>
<a id="L3035" class="source_line" href="#L3035">3035</a>
<a id="L3036" class="source_line" href="#L3036">3036</a>
<a id="L3037" class="source_line" href="#L3037">3037</a>
<a id="L3038" class="source_line" href="#L3038">3038</a>
<a id="L3039" class="source_line" href="#L3039">3039</a>
<a id="L3040" class="source_line" href="#L3040">3040</a>
<a id="L3041" class="source_line" href="#L3041">3041</a>
<a id="L3042" class="source_line" href="#L3042">3042</a>
<a id="L3043" class="source_line" href="#L3043">3043</a>
<a id="L3044" class="source_line" href="#L3044">3044</a>
<a id="L3045" class="source_line" href="#L3045">3045</a>
<a id="L3046" class="source_line" href="#L3046">3046</a>
<a id="L3047" class="source_line" href="#L3047">3047</a>
<a id="L3048" class="source_line" href="#L3048">3048</a>
<a id="L3049" class="source_line" href="#L3049">3049</a>
<a id="L3050" class="source_line" href="#L3050">3050</a>
<a id="L3051" class="source_line" href="#L3051">3051</a>
<a id="L3052" class="source_line" href="#L3052">3052</a>
<a id="L3053" class="source_line" href="#L3053">3053</a>
<a id="L3054" class="source_line" href="#L3054">3054</a>
<a id="L3055" class="source_line" href="#L3055">3055</a>
<a id="L3056" class="source_line" href="#L3056">3056</a>
<a id="L3057" class="source_line" href="#L3057">3057</a>
<a id="L3058" class="source_line" href="#L3058">3058</a>
<a id="L3059" class="source_line" href="#L3059">3059</a>
<a id="L3060" class="source_line" href="#L3060">3060</a>
<a id="L3061" class="source_line" href="#L3061">3061</a>
<a id="L3062" class="source_line" href="#L3062">3062</a>
<a id="L3063" class="source_line" href="#L3063">3063</a>
<a id="L3064" class="source_line" href="#L3064">3064</a>
<a id="L3065" class="source_line" href="#L3065">3065</a>
<a id="L3066" class="source_line" href="#L3066">3066</a>
<a id="L3067" class="source_line" href="#L3067">3067</a>
<a id="L3068" class="source_line" href="#L3068">3068</a>
<a id="L3069" class="source_line" href="#L3069">3069</a>
<a id="L3070" class="source_line" href="#L3070">3070</a>
<a id="L3071" class="source_line" href="#L3071">3071</a>
<a id="L3072" class="source_line" href="#L3072">3072</a>
<a id="L3073" class="source_line" href="#L3073">3073</a>
<a id="L3074" class="source_line" href="#L3074">3074</a>
<a id="L3075" class="source_line" href="#L3075">3075</a>
<a id="L3076" class="source_line" href="#L3076">3076</a>
<a id="L3077" class="source_line" href="#L3077">3077</a>
<a id="L3078" class="source_line" href="#L3078">3078</a>
<a id="L3079" class="source_line" href="#L3079">3079</a>
<a id="L3080" class="source_line" href="#L3080">3080</a>
<a id="L3081" class="source_line" href="#L3081">3081</a>
<a id="L3082" class="source_line" href="#L3082">3082</a>
<a id="L3083" class="source_line" href="#L3083">3083</a>
<a id="L3084" class="source_line" href="#L3084">3084</a>
<a id="L3085" class="source_line" href="#L3085">3085</a>
<a id="L3086" class="source_line" href="#L3086">3086</a>
<a id="L3087" class="source_line" href="#L3087">3087</a>
<a id="L3088" class="source_line" href="#L3088">3088</a>
<a id="L3089" class="source_line" href="#L3089">3089</a>
<a id="L3090" class="source_line" href="#L3090">3090</a>
<a id="L3091" class="source_line" href="#L3091">3091</a>
<a id="L3092" class="source_line" href="#L3092">3092</a>
<a id="L3093" class="source_line" href="#L3093">3093</a>
<a id="L3094" class="source_line" href="#L3094">3094</a>
<a id="L3095" class="source_line" href="#L3095">3095</a>
<a id="L3096" class="source_line" href="#L3096">3096</a>
<a id="L3097" class="source_line" href="#L3097">3097</a>
<a id="L3098" class="source_line" href="#L3098">3098</a>
<a id="L3099" class="source_line" href="#L3099">3099</a>
<a id="L3100" class="source_line" href="#L3100">3100</a>
<a id="L3101" class="source_line" href="#L3101">3101</a>
<a id="L3102" class="source_line" href="#L3102">3102</a>
<a id="L3103" class="source_line" href="#L3103">3103</a>
<a id="L3104" class="source_line" href="#L3104">3104</a>
<a id="L3105" class="source_line" href="#L3105">3105</a>
<a id="L3106" class="source_line" href="#L3106">3106</a>
<a id="L3107" class="source_line" href="#L3107">3107</a>
<a id="L3108" class="source_line" href="#L3108">3108</a>
<a id="L3109" class="source_line" href="#L3109">3109</a>
<a id="L3110" class="source_line" href="#L3110">3110</a>
<a id="L3111" class="source_line" href="#L3111">3111</a>
<a id="L3112" class="source_line" href="#L3112">3112</a>
<a id="L3113" class="source_line" href="#L3113">3113</a>
<a id="L3114" class="source_line" href="#L3114">3114</a>
<a id="L3115" class="source_line" href="#L3115">3115</a>
<a id="L3116" class="source_line" href="#L3116">3116</a>
<a id="L3117" class="source_line" href="#L3117">3117</a>
<a id="L3118" class="source_line" href="#L3118">3118</a>
<a id="L3119" class="source_line" href="#L3119">3119</a>
<a id="L3120" class="source_line" href="#L3120">3120</a>
<a id="L3121" class="source_line" href="#L3121">3121</a>
<a id="L3122" class="source_line" href="#L3122">3122</a>
<a id="L3123" class="source_line" href="#L3123">3123</a>
<a id="L3124" class="source_line" href="#L3124">3124</a>
<a id="L3125" class="source_line" href="#L3125">3125</a>
<a id="L3126" class="source_line" href="#L3126">3126</a>
<a id="L3127" class="source_line" href="#L3127">3127</a>
<a id="L3128" class="source_line" href="#L3128">3128</a>
<a id="L3129" class="source_line" href="#L3129">3129</a>
<a id="L3130" class="source_line" href="#L3130">3130</a>
<a id="L3131" class="source_line" href="#L3131">3131</a>
<a id="L3132" class="source_line" href="#L3132">3132</a>
<a id="L3133" class="source_line" href="#L3133">3133</a>
<a id="L3134" class="source_line" href="#L3134">3134</a>
<a id="L3135" class="source_line" href="#L3135">3135</a>
<a id="L3136" class="source_line" href="#L3136">3136</a>
<a id="L3137" class="source_line" href="#L3137">3137</a>
<a id="L3138" class="source_line" href="#L3138">3138</a>
<a id="L3139" class="source_line" href="#L3139">3139</a>
<a id="L3140" class="source_line" href="#L3140">3140</a>
<a id="L3141" class="source_line" href="#L3141">3141</a>
<a id="L3142" class="source_line" href="#L3142">3142</a>
<a id="L3143" class="source_line" href="#L3143">3143</a>
<a id="L3144" class="source_line" href="#L3144">3144</a>
<a id="L3145" class="source_line" href="#L3145">3145</a>
<a id="L3146" class="source_line" href="#L3146">3146</a>
<a id="L3147" class="source_line" href="#L3147">3147</a>
<a id="L3148" class="source_line" href="#L3148">3148</a>
<a id="L3149" class="source_line" href="#L3149">3149</a>
<a id="L3150" class="source_line" href="#L3150">3150</a>
<a id="L3151" class="source_line" href="#L3151">3151</a>
<a id="L3152" class="source_line" href="#L3152">3152</a>
<a id="L3153" class="source_line" href="#L3153">3153</a>
<a id="L3154" class="source_line" href="#L3154">3154</a>
<a id="L3155" class="source_line" href="#L3155">3155</a>
<a id="L3156" class="source_line" href="#L3156">3156</a>
<a id="L3157" class="source_line" href="#L3157">3157</a>
<a id="L3158" class="source_line" href="#L3158">3158</a>
<a id="L3159" class="source_line" href="#L3159">3159</a>
<a id="L3160" class="source_line" href="#L3160">3160</a>
<a id="L3161" class="source_line" href="#L3161">3161</a>
<a id="L3162" class="source_line" href="#L3162">3162</a>
<a id="L3163" class="source_line" href="#L3163">3163</a>
<a id="L3164" class="source_line" href="#L3164">3164</a>
<a id="L3165" class="source_line" href="#L3165">3165</a>
<a id="L3166" class="source_line" href="#L3166">3166</a>
<a id="L3167" class="source_line" href="#L3167">3167</a>
<a id="L3168" class="source_line" href="#L3168">3168</a>
<a id="L3169" class="source_line" href="#L3169">3169</a>
<a id="L3170" class="source_line" href="#L3170">3170</a>
<a id="L3171" class="source_line" href="#L3171">3171</a>
<a id="L3172" class="source_line" href="#L3172">3172</a>
<a id="L3173" class="source_line" href="#L3173">3173</a>
<a id="L3174" class="source_line" href="#L3174">3174</a>
<a id="L3175" class="source_line" href="#L3175">3175</a>
<a id="L3176" class="source_line" href="#L3176">3176</a>
<a id="L3177" class="source_line" href="#L3177">3177</a>
<a id="L3178" class="source_line" href="#L3178">3178</a>
<a id="L3179" class="source_line" href="#L3179">3179</a>
<a id="L3180" class="source_line" href="#L3180">3180</a>
<a id="L3181" class="source_line" href="#L3181">3181</a>
<a id="L3182" class="source_line" href="#L3182">3182</a>
<a id="L3183" class="source_line" href="#L3183">3183</a>
<a id="L3184" class="source_line" href="#L3184">3184</a>
<a id="L3185" class="source_line" href="#L3185">3185</a>
<a id="L3186" class="source_line" href="#L3186">3186</a>
<a id="L3187" class="source_line" href="#L3187">3187</a>
<a id="L3188" class="source_line" href="#L3188">3188</a>
<a id="L3189" class="source_line" href="#L3189">3189</a>
<a id="L3190" class="source_line" href="#L3190">3190</a>
<a id="L3191" class="source_line" href="#L3191">3191</a>
<a id="L3192" class="source_line" href="#L3192">3192</a>
<a id="L3193" class="source_line" href="#L3193">3193</a>
<a id="L3194" class="source_line" href="#L3194">3194</a>
<a id="L3195" class="source_line" href="#L3195">3195</a>
<a id="L3196" class="source_line" href="#L3196">3196</a>
<a id="L3197" class="source_line" href="#L3197">3197</a>
<a id="L3198" class="source_line" href="#L3198">3198</a>
<a id="L3199" class="source_line" href="#L3199">3199</a>
<a id="L3200" class="source_line" href="#L3200">3200</a>
<a id="L3201" class="source_line" href="#L3201">3201</a>
<a id="L3202" class="source_line" href="#L3202">3202</a>
<a id="L3203" class="source_line" href="#L3203">3203</a>
<a id="L3204" class="source_line" href="#L3204">3204</a>
<a id="L3205" class="source_line" href="#L3205">3205</a>
<a id="L3206" class="source_line" href="#L3206">3206</a>
<a id="L3207" class="source_line" href="#L3207">3207</a>
<a id="L3208" class="source_line" href="#L3208">3208</a>
<a id="L3209" class="source_line" href="#L3209">3209</a>
<a id="L3210" class="source_line" href="#L3210">3210</a>
<a id="L3211" class="source_line" href="#L3211">3211</a>
<a id="L3212" class="source_line" href="#L3212">3212</a>
<a id="L3213" class="source_line" href="#L3213">3213</a>
<a id="L3214" class="source_line" href="#L3214">3214</a>
<a id="L3215" class="source_line" href="#L3215">3215</a>
<a id="L3216" class="source_line" href="#L3216">3216</a>
<a id="L3217" class="source_line" href="#L3217">3217</a>
<a id="L3218" class="source_line" href="#L3218">3218</a>
<a id="L3219" class="source_line" href="#L3219">3219</a>
<a id="L3220" class="source_line" href="#L3220">3220</a>
<a id="L3221" class="source_line" href="#L3221">3221</a>
<a id="L3222" class="source_line" href="#L3222">3222</a>
<a id="L3223" class="source_line" href="#L3223">3223</a>
<a id="L3224" class="source_line" href="#L3224">3224</a>
<a id="L3225" class="source_line" href="#L3225">3225</a>
<a id="L3226" class="source_line" href="#L3226">3226</a>
<a id="L3227" class="source_line" href="#L3227">3227</a>
<a id="L3228" class="source_line" href="#L3228">3228</a>
<a id="L3229" class="source_line" href="#L3229">3229</a>
<a id="L3230" class="source_line" href="#L3230">3230</a>
<a id="L3231" class="source_line" href="#L3231">3231</a>
<a id="L3232" class="source_line" href="#L3232">3232</a>
</code><code class="source_code"><span><span class="COMMENT">(* This file is part of Lwt, released under the MIT license. See LICENSE.md for
   details, or visit https://github.com/ocsigen/lwt/blob/master/LICENSE.md. *)</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* Reading guide

   Welcome to the implementation of the Lwt core! This is a big file, but we
   hope that reading it (parts at a time!) will not be scary :) Here is why:


   * Sectioning

   The code is broken up into sections, each one of which is an internal module.
   Most of the modules have a signature, which serves as a neat table of
   contents.

   It is recommended that you read this file with code folding enabled. If you
   fold all the modules, you can visualize the logical structure of Lwt quite
   easily. You can then expand modules as needed, depending on what part of the
   implementation you are interested in. Without code folding, you face an
   intimidating wall of code :( You can still visually parse the file, however,
   because there are plenty of blank lines to help section things off. You can
   also view this file folded online:

     https://gist.github.com/aantron/9fab0bdead98a60fccf06e0189186863
     https://gist.github.com/aantron/97b58520d5bb4858ccac6f54700a24d7

   The signatures are unusual: big comments are absent. They are moved into the
   modules, so that they are hidden by code folding when you (the reader!) are
   not interested in those modules.


   * Documentation

   The documentation begins with an overview of major concepts and components.
   This overview puts everything into context. You don't have to read the whole
   thing. The overview begins with basic concepts, moves on to advanced ones,
   and then gets into the truly esoteric. You can read about each concept on an
   as-needed basis. However, once you have read the whole overview, you will be
   aware of *everything* that is needed to understand, and work with, the core
   of Lwt.

   Littered in the code are additional comments, that go in-depth on various
   local implementation details, opportunities, regrets, and the like.

   The sections (modules) of the code correspond closely to sections of the
   overview.


   * Whitespace

   The total line count of this file may seem frightening, but one third of it
   is whitespace and comments, both there to help you read the remaining two
   thirds!

   Also, within those two thirds, there are large groups of functions that are
   repetitive and formulaic, so there is much less conceptually-unique code in
   Lwt than you might think at first.


   * Please edit the code and the docs!

   This code is meant to be readable, and to be edited. If you are reading
   something, and think there is a better way to express it, please go ahead and
   open a pull request to the Lwt repository at

     https://github.com/ocsigen/lwt

   Even if your pull request somehow doesn't get merged, you will have educated
   the maintainers, not to mention other contributors, and users. This is true
   even if the change is trivial -- sometimes, maintainers just need to be
   educated multiple times before they see the wisdom of it :/

   Likewise, if you would like to make a code contribution to the Lwt core, it
   is quite welcome, and we hope that this code is readable enough for you to be
   able to make it!


   Enjoy! *)</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* Overview

   In this file, there is a &quot;model&quot; function -- [Lwt.bind] -- which pulls
   together many (though not all) of the concepts and helpers discussed in this
   overview. To find it, search for &quot;let bind,&quot; and you can examine it while
   reading the overview. The authors of this file intend to put extra effort
   into writing nice comments inside [Lwt.bind] :)


   0. Main mechanism and two aspects

   The Lwt interface ([lwt.mli]) provides one main mechanism, promises, and two
   &quot;aspects,&quot; which are *not* necessary to understand the main mechanism
   promises, but they are still there:

   - promise cancellation
   - sequence-associated storage

   If you are not interested in cancellation or storage, you can ignore these
   two complications, and still get a pretty good understanding of the code. To
   help, all identifiers related to cancellation contain the string &quot;cancel,&quot;
   and all identifiers related to storage contain &quot;storage.&quot;


   1. Promises

   A promise is a cell that can be in one of two states: &quot;resolved&quot; or
   &quot;pending.&quot;

   - Resolved promises

     A resolved promise is either &quot;fulfilled&quot; with a value, or &quot;rejected&quot; with
     an exception. The state of a resolved promise will never change again: a
     resolved promise is immutable. A resolved promise is basically equivalent
     to an [('a, exn) Stdlib.result]. Resolved promises are produced in two
     ways:

     - [Lwt.return], [Lwt.fail], and related functions, produce &quot;trivial&quot;
       promises that are resolved from the start.
     - The other way is to resolve a promise that started out pending.

     Note that rejected promises have nothing to do with unhandled exceptions.

   - Pending promises

     ...are those that may become resolved in the future. Each pending promise
     carries a list of callbacks. These callbacks are added by functions like
     [Lwt.bind], and called by Lwt if/when the promise is resolved. These
     callbacks typically end up resolving additional promises; see section
     &quot;Resolution loop&quot; below.

     Pending promises are produced in three ways, according to how they can be
     resolved:

     - Initial promises

       ...are created by [Lwt.wait] and [Lwt.task]. The user of Lwt resolves
       these promises manually, through the resolvers returned by those
       functions.

     - Sequential composition

       For example, [Lwt.bind]. These promises only are only resolved when the
       preceding sequence of promises resolves. The user cannot resolve these
       promises directly (but see the section on cancellation below).

     - Concurrent composition

       For example, [Lwt.join] or [Lwt.choose]. These promises are only resolved
       when all or one of a set of &quot;preceding&quot; promises resolve. The user cannot
       resolve these promises directly (but see the section on cancellation
       below).


   2. Resolvers

   Resolvers are given to the user by [Lwt.wait] and [Lwt.task], and can be used
   by the user to resolve the corresponding promises. Note that this means the
   user only ever gets resolvers for initial promises.

   Internally, resolvers are the exact same objects as the promises they
   resolve, even though the resolver is exposed as a reference of a different
   type by [lwt.mli]. For details on why, see section &quot;Type system abuse&quot; below.


   3. Callbacks

   ...are attached by Lwt to pending promises, and are run by Lwt if/when those
   promises are resolved. These callbacks are not directly exposed through
   [lwt.mli] -- they are a low-level mechanism. For example, to implement
   [Lwt.bind p f], Lwt attaches a callback to [p] that does some internal Lwt
   book-keeping, and then calls [f] if [p] is fulfilled, and does something else
   if [p] is rejected.

   Callbacks come in two flavors: regular callbacks and cancel callbacks. The
   only material differences between them are that:

   - regular callbacks are always called when a promise is resolved, but cancel
     callbacks are called, in addition, only if the promise is canceled, and
   - all cancel callbacks of a promise are called before any regular callback
     is called.

   Cancellation is a special case of resolution, in particular, a special case
   of rejection, but see the section on cancellation later below.


   4. Resolution loop

   Resolving a pending promise triggers its callbacks, and those might resolve
   more pending promises, triggering more callbacks, etc. This behavior is the
   *resolution loop*. Lwt has some machinery to avoid stack overflow and other
   unfortunate situations during this loop.

   This chaining of promise resolutions through callbacks can be seen as a kind
   of promise dependency graph, in which the nodes are pending promises, and the
   edges are callbacks. During the resolution loop, Lwt starts at some initial
   promise that is getting resolved by the user, and recursively resolves all
   dependent promises. The graph is modified: resolved promises are no longer
   pending, so they are no longer part of the graph.

   Some of these dependencies are explicit to Lwt, e.g. the callbacks registered
   by [Lwt.bind]. Others are not visible to Lwt, because the user can always
   register a callback using a function like [Lwt.on_success], and use that
   callback to resolve another initial promise. All the explicit dependencies
   are created by Lwt's own sequential and concurrent composition functions
   (so, [Lwt.bind], [Lwt.join], etc). Whether dependencies are explicit or not
   is relevant only to cancellation.


   5. Cancellation

   As described above, ordinary promise resolution proceeds from an initial
   promise, forward along callbacks through the dependency graph. Since it
   starts from an initial promise, it can only be triggered using a resolver.

   Cancellation is a sort of dual to ordinary resolution. Instead of starting at
   an initial promise/resolver, cancellation starts at *any* promise. It then
   goes *backwards* through the explicit dependency graph, looking for
   cancelable initial promises to cancel -- those that were created by
   [Lwt.task]. After finding them, cancellation resolves them normally with
   [Rejected Lwt.Canceled], causing an ordinary promise resolution process.

   To summarize, cancellation is a way to trigger an *ordinary* resolution of
   promises created with [Lwt.task], by first searching for them in the promise
   dependency graph (which is assembled by [Lwt.bind], [Lwt.join], etc).

   This backwards search is triggered only by [Lwt.cancel]. It is also possible
   for the user to cancel a promise directly by rejecting it with
   [Lwt.Canceled], but in all cases where the user can do so, the search would
   be redundant anyway -- the user has only two ways of directly rejecting a
   promise with [Lwt.Canceled] (or any exception, for that matter):

   - The user can create an initial promise, then reject it through its
     resolver. The search is redundant because it would find only the same
     initial promise to cancel.
   - The user can create a trivial promise by calling [Lwt.fail Lwt.Canceled].
     The search is again redundant; in this case it would find nothing to
     cancel.

   Note that there is a quirk: only promises created by [Lwt.task] are
   susceptible to being canceled by [Lwt.cancel], but the user can manually
   cancel initial promises created by both [Lwt.task] and [Lwt.wait].

   Due to [Lwt.cancel], promise cancellation, and therefore resolution, can be
   initiated by the user without access to a resolver. This is important for
   reasoning about state changes in the implementation of Lwt, and is referenced
   in some implementation detail comments.


   6. No I/O

   The Lwt core deliberately doesn't do I/O. The resolution loop stops running
   once no promises can be resolved immediately. It has to be restarted later
   by some surrounding I/O loop. This I/O loop typically keeps track of pending
   promises that represent blocked or in-progress I/O; other pending promises
   that indirectly depend on I/O are not explicitly tracked. They are retained
   in memory by references captured inside callbacks.

   On Unix and Windows, a separate top-level loop, typically [Lwt_main.run], is
   necessary to repeatedly call [select], [epoll], or [kevent], and resolve
   blocked I/O promises.

   In JavaScript, references to promises are retained by JavaScript code, which
   is, in turn, triggered by the JS engine. In other words, the top-level loop
   is buried inside the JS engine.

   This separation of the Lwt core from the top-level I/O loop keeps the core
   portable.


   7. Promise &quot;proxying&quot;

   In [Lwt.bind : 'a t -&gt; ('a -&gt; 'b t) -&gt; 'b t], the outer ['b t] is created by
   [bind] first, and returned to the user. The inner ['b t] is created by the
   user later, and then returned to [bind]. At that point, [bind] needs to make
   the inner and outer ['b t]s behave identically.

   This is accomplished by making one of the promises point to the other. The
   first of the promises thus becomes a &quot;proxy,&quot; and the other is its
   &quot;underlying&quot; promise.

   After that, all operations that would be performed by Lwt on the proxy are
   instead performed on the underlying promise. This is ensured by the numerous
   calls to the internal function [underlying] in this file.

   Because of the pervasive use of [underlying], proxies can be more or less
   ignored on a first reading the code. However, becoming a proxy is a kind of
   state change, and any promise that is returned by a callback to [bind], or to
   a similar Lwt function, might become a proxy. That means: just about any
   promise that is handed to the user, might become a proxy promise by the next
   time Lwt sees it. This is important for reasoning about possible state
   changes in implementation of Lwt, and is referenced in some implementation
   detail comments.


   8. Sequence-associated storage

   Lwt has a global key-value map. The map can be preserved across sequential
   composition functions, so that it has the same state in the user's callback
   [f] as it did at the time the user called [Lwt.bind p f].

   The details are pretty straightforward, and discussed in module
   [Sequence_associated_storage]. The main thing to be aware of is the many
   references to [current_storage] throughout Lwt, which are needed to properly
   save and restore the mapping.


   9. Type system abuse

   The implementation uses the type system somewhat extensively. Gentle
   introductions can be found here:

     https://discuss.ocaml.org/t/161/7
     https://discuss.ocaml.org/t/161/16

   A short summary follows.

   The promise state is, internally, a GADT which encodes the state in its type
   parameters. Thus, if you do [let p = underlying p], the shadowing reference
   [p] is statically known *not* to be a proxy, and the compiler knows that the
   corresponding match case [Proxy _] is impossible.

   The external promise type, ['a t], and the external resolver type, ['a u],
   are not GADTs. Furthermore, they are, respectively, covariant and
   contravariant in ['a], while the internal promise type is invariant in ['a].
   For these reasons, there are nasty casts between ['a t], ['a u], and the
   internal promise type. The implementation is, of course, written in terms of
   the internal type.

   Casting from an ['a t] to an internal promise produces a reference for
   which the state is &quot;unknown&quot;: this is simulated with a helper GADT, which
   encodes existential types. There are several similar casts, which are used
   to document possible state changes between the time a promise is created,
   and the later time it is used in a callback. You can see these casts in
   action in [Lwt.bind]. The cast syntax is pretty light, and, besides being
   commented in [bind], all such casts are documented in modules [Public_types]
   and [Basic_helpers].


   If you've made it this far, you are an Lwt expert! Rejoice! *)</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* [Lwt_sequence] is deprecated â€“ we don't want users outside Lwt using it.
   However, it is still used internally by Lwt. So, briefly disable warning 3
   (&quot;deprecated&quot;), and create a local, non-deprecated alias for
   [Lwt_sequence] that can be referred to by the rest of the code in this
   module without triggering any more warnings. *)</span><span class="EOL">
</span><span class="LBRACKETATATAT">[@@@</span><span class="LIDENT">ocaml</span><span class="DOT">.</span><span class="LIDENT">warning</span> <span class="STRING">&quot;-3&quot;</span><span class="RBRACKET">]</span><span class="EOL">
</span><span id="module-Lwt_sequence"><span class="MODULE">module</span> <span class="UIDENT">Lwt_sequence</span> <span class="EQUAL">=</span> <a href="lwt_sequence.ml.html"><span class="UIDENT">Lwt_sequence</span></a></span><span class="EOL">
</span><span class="LBRACKETATATAT">[@@@</span><span class="LIDENT">ocaml</span><span class="DOT">.</span><span class="LIDENT">warning</span> <span class="STRING">&quot;+3&quot;</span><span class="RBRACKET">]</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* Some sequence-associated storage types

   Sequence-associated storage is defined and documented later, in module
   [Sequence_associated_storage]. However, the following types are mentioned in
   the definition of [promise], so they must be defined here first. *)</span><span class="EOL">
</span><span id="module-Storage_map"><span class="MODULE">module</span> <span class="UIDENT">Storage_map</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="../../../ocaml-base-compiler/src/stdlib/map.ml.html#module-Make"><span class="UIDENT">Map</span><span class="DOT">.</span><span class="UIDENT">Make</span></a><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="STRUCT">struct</span><span class="EOL">
</span>      <span id="def_802"><span class="TYPE">type</span> <span class="LIDENT">t</span> <span class="EQUAL">=</span> <span class="LIDENT">int</span></span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_compare_1"><span class="LIDENT">compare</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-compare"><span class="LIDENT">compare</span></a><span class="EOL">
</span>    <span class="END">end</span><span class="RPAREN">)</span></span><span class="EOL">
</span><span id="type-storage"><span class="TYPE">type</span> <span class="LIDENT">storage</span> <span class="EQUAL">=</span> <span class="LPAREN">(</span><span class="LIDENT">unit</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span><span class="RPAREN">)</span> <span class="UIDENT">Storage_map</span><span class="DOT">.</span><span class="LIDENT">t</span></span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span id="module-Main_internal_types"><span class="MODULE">module</span> <span class="UIDENT">Main_internal_types</span> <span class="EQUAL">=</span><span class="EOL">
</span><span class="STRUCT">struct</span><span class="EOL">
</span>  <span class="COMMENT">(* Phantom types for use with types [promise] and [state]. These are never
     constructed; the purpose of the constructors is to prove to the type
     checker that these types are distinct from each other. Warning 37, &quot;unused
     constructor,&quot; therefore has to be temporarily suppressed. *)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LBRACKETATATAT">[@@@</span><span class="LIDENT">ocaml</span><span class="DOT">.</span><span class="LIDENT">warning</span> <span class="STRING">&quot;-37&quot;</span><span class="RBRACKET">]</span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Main_internal_types.type-underlying"><span class="TYPE">type</span> <span class="LIDENT">underlying</span> <span class="EQUAL">=</span> <span class="PRIVATE">private</span> <span id="module-Main_internal_types.type-underlying.constructor-Underlying_and_this_constructor_is_not_used"><span class="UIDENT">Underlying_and_this_constructor_is_not_used</span></span></span><span class="EOL">
</span>  <span id="module-Main_internal_types.type-proxy"><span class="TYPE">type</span> <span class="LIDENT">proxy</span> <span class="EQUAL">=</span> <span class="PRIVATE">private</span> <span id="module-Main_internal_types.type-proxy.constructor-Proxy_and_this_constructor_is_not_used"><span class="UIDENT">Proxy_and_this_constructor_is_not_used</span></span></span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Main_internal_types.type-resolved"><span class="TYPE">type</span> <span class="LIDENT">resolved</span> <span class="EQUAL">=</span> <span class="PRIVATE">private</span> <span id="module-Main_internal_types.type-resolved.constructor-Resolved_and_this_constructor_is_not_used"><span class="UIDENT">Resolved_and_this_constructor_is_not_used</span></span></span><span class="EOL">
</span>  <span id="module-Main_internal_types.type-pending"><span class="TYPE">type</span> <span class="LIDENT">pending</span> <span class="EQUAL">=</span> <span class="PRIVATE">private</span> <span id="module-Main_internal_types.type-pending.constructor-Pending_and_this_constructor_is_not_used"><span class="UIDENT">Pending_and_this_constructor_is_not_used</span></span></span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LBRACKETATATAT">[@@@</span><span class="LIDENT">ocaml</span><span class="DOT">.</span><span class="LIDENT">warning</span> <span class="STRING">&quot;+37&quot;</span><span class="RBRACKET">]</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Promises proper. *)</span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Main_internal_types.type-promise"><span class="TYPE">type</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="QUOTE">'</span><span class="LIDENT">u</span><span class="COMMA">,</span> <span class="QUOTE">'</span><span class="LIDENT">c</span><span class="RPAREN">)</span> <span class="LIDENT">promise</span> <span class="EQUAL">=</span> <span class="LBRACE">{</span><span class="EOL">
</span>    <span id="def_801"><span class="MUTABLE">mutable</span> <span class="LIDENT">state</span> <span class="COLON">:</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="QUOTE">'</span><span class="LIDENT">u</span><span class="COMMA">,</span> <span class="QUOTE">'</span><span class="LIDENT">c</span><span class="RPAREN">)</span> <span class="LIDENT">state</span><span class="SEMI">;</span></span><span class="EOL">
</span>  <span class="RBRACE">}</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Main_internal_types.type-state"><span class="AND">and</span> <span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="LIDENT">state</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span id="module-Main_internal_types.type-state.constructor-Fulfilled"><span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span>                  <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="LIDENT">underlying</span><span class="COMMA">,</span> <span class="LIDENT">resolved</span><span class="RPAREN">)</span> <span class="LIDENT">state</span></span><span class="EOL">
</span>    <span id="module-Main_internal_types.type-state.constructor-Rejected"><span class="BAR">|</span> <span class="UIDENT">Rejected</span>  <span class="COLON">:</span> <span class="LIDENT">exn</span>                 <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="LIDENT">underlying</span><span class="COMMA">,</span> <span class="LIDENT">resolved</span><span class="RPAREN">)</span> <span class="LIDENT">state</span></span><span class="EOL">
</span>    <span id="module-Main_internal_types.type-state.constructor-Pending"><span class="BAR">|</span> <span class="UIDENT">Pending</span>   <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">callbacks</span>        <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="LIDENT">underlying</span><span class="COMMA">,</span> <span class="LIDENT">pending</span><span class="RPAREN">)</span>  <span class="LIDENT">state</span></span><span class="EOL">
</span>    <span id="module-Main_internal_types.type-state.constructor-Proxy"><span class="BAR">|</span> <span class="UIDENT">Proxy</span>     <span class="COLON">:</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="QUOTE">'</span><span class="LIDENT">c</span><span class="RPAREN">)</span> <span class="LIDENT">promise</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="LIDENT">proxy</span><span class="COMMA">,</span>      <span class="QUOTE">'</span><span class="LIDENT">c</span><span class="RPAREN">)</span>       <span class="LIDENT">state</span></span></span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Note:

     A promise whose state is [Proxy _] is a &quot;proxy&quot; promise. A promise whose
     state is *not* [Proxy _] is an &quot;underlying&quot; promise.

     The &quot;underlying promise of [p]&quot; is:

     - [p], if [p] is itself underlying.
     - Otherwise, [p] is a proxy and has state [Proxy p']. The underlying
       promise of [p] is the underlying promise of [p'].

     In other words, to find the underlying promise of a proxy, Lwt follows the
     [Proxy _] links to the end. *)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Note:

     When a promise is resolved, or becomes a proxy, its state field is
     mutated. This invalidates the type invariants on the promise. See internal
     function [set_promise_state] for details about that.

     When an Lwt function has a reference to a promise, and also registers a
     callback that has a reference to the same promise, the invariants on the
     reference may become invalid by the time the callback is called. All such
     callbacks have comments explaining what the valid invariants are at that
     point, and/or casts to (1) get the correct typing and (2) document the
     potential state change for readers of the code. *)</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Callback information for pending promises. *)</span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Main_internal_types.type-callbacks"><span class="AND">and</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">callbacks</span> <span class="EQUAL">=</span> <span class="LBRACE">{</span><span class="EOL">
</span>    <span id="def_797"><span class="MUTABLE">mutable</span> <span class="LIDENT">regular_callbacks</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">regular_callback_list</span><span class="SEMI">;</span></span><span class="EOL">
</span>    <span id="def_805"><span class="MUTABLE">mutable</span> <span class="LIDENT">cancel_callbacks</span>  <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">cancel_callback_list</span><span class="SEMI">;</span></span><span class="EOL">
</span>    <span id="def_789"><span class="MUTABLE">mutable</span> <span class="LIDENT">how_to_cancel</span>     <span class="COLON">:</span> <span class="LIDENT">how_to_cancel</span><span class="SEMI">;</span></span><span class="EOL">
</span>    <span id="def_785"><span class="MUTABLE">mutable</span> <span class="LIDENT">cleanups_deferred</span> <span class="COLON">:</span> <span class="LIDENT">int</span><span class="SEMI">;</span></span><span class="EOL">
</span>  <span class="RBRACE">}</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Main_internal_types.type-regular_callback"><span class="AND">and</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">regular_callback</span> <span class="EQUAL">=</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">resolved_state</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Main_internal_types.type-cancel_callback"><span class="AND">and</span> <span class="LIDENT">cancel_callback</span> <span class="EQUAL">=</span> <span class="LIDENT">unit</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Main_internal_types.type-resolved_state"><span class="AND">and</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">resolved_state</span> <span class="EQUAL">=</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="LIDENT">underlying</span><span class="COMMA">,</span> <span class="LIDENT">resolved</span><span class="RPAREN">)</span> <span class="LIDENT">state</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Main_internal_types.type-how_to_cancel"><span class="AND">and</span> <span class="LIDENT">how_to_cancel</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span id="module-Main_internal_types.type-how_to_cancel.constructor-Not_cancelable"><span class="BAR">|</span> <span class="UIDENT">Not_cancelable</span>              <span class="COLON">:</span>                           <span class="LIDENT">how_to_cancel</span></span><span class="EOL">
</span>    <span id="module-Main_internal_types.type-how_to_cancel.constructor-Cancel_this_promise"><span class="BAR">|</span> <span class="UIDENT">Cancel_this_promise</span>         <span class="COLON">:</span>                           <span class="LIDENT">how_to_cancel</span></span><span class="EOL">
</span>    <span id="module-Main_internal_types.type-how_to_cancel.constructor-Propagate_cancel_to_one"><span class="BAR">|</span> <span class="UIDENT">Propagate_cancel_to_one</span>     <span class="COLON">:</span> <span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="LIDENT">promise</span>      <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">how_to_cancel</span></span><span class="EOL">
</span>    <span id="module-Main_internal_types.type-how_to_cancel.constructor-Propagate_cancel_to_several"><span class="BAR">|</span> <span class="UIDENT">Propagate_cancel_to_several</span> <span class="COLON">:</span> <span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="LIDENT">promise</span> <span class="LIDENT">list</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">how_to_cancel</span></span></span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Main_internal_types.type-regular_callback_list"><span class="AND">and</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">regular_callback_list</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span id="module-Main_internal_types.type-regular_callback_list.constructor-Regular_callback_list_empty"><span class="BAR">|</span> <span class="UIDENT">Regular_callback_list_empty</span></span><span class="EOL">
</span>    <span id="module-Main_internal_types.type-regular_callback_list.constructor-Regular_callback_list_concat"><span class="BAR">|</span> <span class="UIDENT">Regular_callback_list_concat</span> <span class="OF">of</span><span class="EOL">
</span>      <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">regular_callback_list</span> <span class="STAR">*</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">regular_callback_list</span></span><span class="EOL">
</span>    <span id="module-Main_internal_types.type-regular_callback_list.constructor-Regular_callback_list_implicitly_removed_callback"><span class="BAR">|</span> <span class="UIDENT">Regular_callback_list_implicitly_removed_callback</span> <span class="OF">of</span><span class="EOL">
</span>      <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">regular_callback</span></span><span class="EOL">
</span>    <span id="module-Main_internal_types.type-regular_callback_list.constructor-Regular_callback_list_explicitly_removable_callback"><span class="BAR">|</span> <span class="UIDENT">Regular_callback_list_explicitly_removable_callback</span> <span class="OF">of</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#type-ref"><span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">regular_callback</span> <span class="LIDENT">option</span> <span class="LIDENT">ref</span></a></span></span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Main_internal_types.type-cancel_callback_list"><span class="AND">and</span> <span class="UNDERSCORE">_</span> <span class="LIDENT">cancel_callback_list</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span id="module-Main_internal_types.type-cancel_callback_list.constructor-Cancel_callback_list_empty"><span class="BAR">|</span> <span class="UIDENT">Cancel_callback_list_empty</span> <span class="COLON">:</span><span class="EOL">
</span>      <span class="UNDERSCORE">_</span> <span class="LIDENT">cancel_callback_list</span></span><span class="EOL">
</span>    <span id="module-Main_internal_types.type-cancel_callback_list.constructor-Cancel_callback_list_concat"><span class="BAR">|</span> <span class="UIDENT">Cancel_callback_list_concat</span> <span class="COLON">:</span><span class="EOL">
</span>      <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">cancel_callback_list</span> <span class="STAR">*</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">cancel_callback_list</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">cancel_callback_list</span></span><span class="EOL">
</span>    <span id="module-Main_internal_types.type-cancel_callback_list.constructor-Cancel_callback_list_callback"><span class="BAR">|</span> <span class="UIDENT">Cancel_callback_list_callback</span> <span class="COLON">:</span><span class="EOL">
</span>      <span class="LIDENT">storage</span> <span class="STAR">*</span> <span class="LIDENT">cancel_callback</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="UNDERSCORE">_</span> <span class="LIDENT">cancel_callback_list</span></span><span class="EOL">
</span>    <span id="module-Main_internal_types.type-cancel_callback_list.constructor-Cancel_callback_list_remove_sequence_node"><span class="BAR">|</span> <span class="UIDENT">Cancel_callback_list_remove_sequence_node</span> <span class="COLON">:</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="LIDENT">promise</span> <span class="UIDENT">Lwt_sequence</span><span class="DOT">.</span><span class="LIDENT">node</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">cancel_callback_list</span></span></span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Notes:

     These type definitions are guilty of performing several optimizations,
     without which they would be much easier to understand.

     - The type parameters of ['a resolved_state] guarantee that it is either
       [Fulfilled _] or [Rejected _]. So, it is equivalent to
       [('a, exn) Stdlib.result], and, indeed, should have an identical
       memory representation.

     - As per the Overview, there are regular callbacks and cancel callbacks.
       Cancel callbacks are called only on cancellation, and, then, before any
       regular callbacks are called.

       Despite the different types for the two kinds of callbacks, they are
       otherwise the same. Cancel callbacks just don't need a result state
       argument, because it is known to be [Rejected Canceled].

     - Regular callbacks are not allowed to raise exceptions. All regular
       callbacks are created in this file, so this can be checked.

       Cancel callbacks can raise exceptions, but if they do so, the exceptions
       are passed to [async_exception_hook].

     - [how_to_cancel] implements the dependency graph mentioned in the
       Overview. It is traversed backwards during [Lwt.cancel]. It is a GADT
       because we don't care about the actual types of the promise references
       stored, or their invariants. The constructors correspond to pending
       promise kinds as follows:
         - [Not_cancelable]: initial, [Lwt.wait].
         - [Cancel_this_promise]: initial, [Lwt.task].
         - [Propagate_cancel_to_one]: sequential composition, e.g. [Lwt.bind].
         - [Propagate_cancel_to_several]: concurrent composition, e.g.
           [Lwt.join].

     - The two callback list types are ordinary append-friendly lists, with two
       optimizations inlined:

       - ['a regular_callback_list] apparently has two &quot;kinds&quot; of regular
         callbacks, implicitly removed and explicitly removable. All callbacks
         are removable. It's just that, for some callbacks, they will only be
         removed at the same time that the promise they are attached to becomes
         resolved. When that happens, the entire state of that promise changes
         to [Fulfilled _] or [Rejected _], and the reference to the whole
         callback list is simply lost. This &quot;removes&quot; the callback. For these
         callbacks, ['a regular_callback_list] attempts to trim an option and a
         reference cell with the
         [Regular_callback_list_implicitly_removed_callback] constructor.

       - ['a cancel_callback_list] has
         [Cancel_callback_list_remove_sequence_node node], which is the same as
         [Cancel_callback_list_callback (_, (fun _ -&gt;
           Lwt_sequence.remove node))].
         This was probably done to avoid a closure allocation.

     - The [cleanups_deferred] field is explained in module
       [Pending_callbacks]. *)</span><span class="EOL">
</span><span class="END">end</span></span><span class="EOL">
</span><span class="OPEN">open</span> <span class="UIDENT">Main_internal_types</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span id="module-Public_types"><span class="MODULE">module</span> <span class="UIDENT">Public_types</span> <span class="EQUAL">=</span><span class="EOL">
</span><span class="STRUCT">struct</span><span class="EOL">
</span>  <span id="module-Public_types.type-t"><span class="TYPE">type</span> <span class="PLUS">+</span><span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span></span><span class="EOL">
</span>  <span id="module-Public_types.type-u"><span class="TYPE">type</span> <span class="MINUS">-</span><span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">u</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Public_types.val-to_public_promise"><span class="LIDENT">to_public_promise</span></span> <span class="COLON">:</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="LIDENT">promise</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/obj.ml.html#val-magic"><span class="UIDENT">Obj</span><span class="DOT">.</span><span class="LIDENT">magic</span></a><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Public_types.val-to_public_resolver"><span class="LIDENT">to_public_resolver</span></span> <span class="COLON">:</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="LIDENT">promise</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">u</span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/obj.ml.html#val-magic"><span class="UIDENT">Obj</span><span class="DOT">.</span><span class="LIDENT">magic</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Public_types.type-packed_promise"><span class="TYPE">type</span> <span class="UNDERSCORE">_</span> <span class="LIDENT">packed_promise</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span id="module-Public_types.type-packed_promise.constructor-Internal"><span id="type-packed_promise.constructor-Internal"><span class="BAR">|</span> <span class="UIDENT">Internal</span> <span class="COLON">:</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="LIDENT">promise</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">packed_promise</span></span></span><span class="EOL">
</span>    <span class="LBRACKETATAT">[@@</span><span class="LIDENT">ocaml</span><span class="DOT">.</span><span class="LIDENT">unboxed</span><span class="RBRACKET">]</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Public_types.val-to_internal_promise"><span class="LIDENT">to_internal_promise</span></span> <span class="LPAREN">(</span><span id="local_p_2"><span class="LIDENT">p</span></span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span><span class="RPAREN">)</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">packed_promise</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="UIDENT">Internal</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/obj.ml.html#val-magic"><span class="UIDENT">Obj</span><span class="DOT">.</span><span class="LIDENT">magic</span></a> <a href="#local_p_2"><span class="LIDENT">p</span></a><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Public_types.val-to_internal_resolver"><span class="LIDENT">to_internal_resolver</span></span> <span class="LPAREN">(</span><span id="local_r_3"><span class="LIDENT">r</span></span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">u</span><span class="RPAREN">)</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">packed_promise</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="UIDENT">Internal</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/obj.ml.html#val-magic"><span class="UIDENT">Obj</span><span class="DOT">.</span><span class="LIDENT">magic</span></a> <a href="#local_r_3"><span class="LIDENT">r</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Most functions that take a public promise (['a t]) convert it to an
     internal promise as follows:

       (* p : 'a t *)

       let Internal p = to_internal_promise p in

       (* p : ('a, u, c) promise, where u and c are fresh types, i.e. the
          invariants on p are unknown. *)

     This cast is a no-op cast. It only produces a reference with a different
     type. The introduction and immediate elimination of [Internal _] seems to
     be optimized away even on older versions of OCaml that don't have Flambda
     and don't support [[@@ocaml.unboxed]]. *)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* This could probably save an allocation by using [Obj.magic]. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Public_types.val-state_of_result"><span class="LIDENT">state_of_result</span></span> <span class="EQUAL">=</span> <span class="FUNCTION">function</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Ok</span> <span id="local_x_4"><span class="LIDENT">x</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Fulfilled</span> <a href="#local_x_4"><span class="LIDENT">x</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Error</span> <span id="local_exn_5"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Rejected</span> <a href="#local_exn_5"><span class="LIDENT">exn</span></a><span class="EOL">
</span><span class="END">end</span></span><span class="EOL">
</span><span class="INCLUDE">include</span> <span class="UIDENT">Public_types</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span id="module-Basic_helpers"><span class="MODULE">module</span> <span class="UIDENT">Basic_helpers</span> <span class="COLON">:</span><span class="EOL">
</span><span class="SIG">sig</span><span class="EOL">
</span>  <span id="module-Basic_helpers.val-identical"><span class="VAL">val</span> <span class="LIDENT">identical</span> <span class="COLON">:</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="LIDENT">promise</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="LIDENT">promise</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">bool</span></span><span class="EOL">
</span>  <span id="module-Basic_helpers.val-underlying"><span class="VAL">val</span> <span class="LIDENT">underlying</span> <span class="COLON">:</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="QUOTE">'</span><span class="LIDENT">u</span><span class="COMMA">,</span> <span class="QUOTE">'</span><span class="LIDENT">c</span><span class="RPAREN">)</span> <span class="LIDENT">promise</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="LIDENT">underlying</span><span class="COMMA">,</span> <span class="QUOTE">'</span><span class="LIDENT">c</span><span class="RPAREN">)</span> <span class="LIDENT">promise</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Basic_helpers.type-state_changed"><span class="TYPE">type</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="QUOTE">'</span><span class="LIDENT">u</span><span class="COMMA">,</span> <span class="QUOTE">'</span><span class="LIDENT">c</span><span class="RPAREN">)</span> <span class="LIDENT">state_changed</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span id="module-Basic_helpers.type-state_changed.constructor-State_may_have_changed"><span class="BAR">|</span> <span class="UIDENT">State_may_have_changed</span> <span class="OF">of</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="QUOTE">'</span><span class="LIDENT">u</span><span class="COMMA">,</span> <span class="QUOTE">'</span><span class="LIDENT">c</span><span class="RPAREN">)</span> <span class="LIDENT">promise</span></span><span class="EOL">
</span>    <span class="LBRACKETATAT">[@@</span><span class="LIDENT">ocaml</span><span class="DOT">.</span><span class="LIDENT">unboxed</span><span class="RBRACKET">]</span></span><span class="EOL">
</span>  <span id="module-Basic_helpers.val-set_promise_state"><span class="VAL">val</span> <span class="LIDENT">set_promise_state</span> <span class="COLON">:</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="LIDENT">promise</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="QUOTE">'</span><span class="LIDENT">u</span><span class="COMMA">,</span> <span class="QUOTE">'</span><span class="LIDENT">c</span><span class="RPAREN">)</span> <span class="LIDENT">state</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="QUOTE">'</span><span class="LIDENT">u</span><span class="COMMA">,</span> <span class="QUOTE">'</span><span class="LIDENT">c</span><span class="RPAREN">)</span> <span class="LIDENT">state_changed</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Basic_helpers.type-may_now_be_proxy"><span class="TYPE">type</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">may_now_be_proxy</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span id="module-Basic_helpers.type-may_now_be_proxy.constructor-State_may_now_be_pending_proxy"><span class="BAR">|</span> <span class="UIDENT">State_may_now_be_pending_proxy</span> <span class="COLON">:</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="LIDENT">pending</span><span class="RPAREN">)</span> <span class="LIDENT">promise</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">may_now_be_proxy</span></span><span class="EOL">
</span>    <span class="LBRACKETATAT">[@@</span><span class="LIDENT">ocaml</span><span class="DOT">.</span><span class="LIDENT">unboxed</span><span class="RBRACKET">]</span></span><span class="EOL">
</span>  <span id="module-Basic_helpers.val-may_now_be_proxy"><span class="VAL">val</span> <span class="LIDENT">may_now_be_proxy</span> <span class="COLON">:</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="LIDENT">underlying</span><span class="COMMA">,</span> <span class="LIDENT">pending</span><span class="RPAREN">)</span> <span class="LIDENT">promise</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">may_now_be_proxy</span></span><span class="EOL">
</span><span class="END">end</span> <span class="EQUAL">=</span><span class="EOL">
</span><span class="STRUCT">struct</span><span class="EOL">
</span>  <span class="COMMENT">(* Checks physical equality ([==]) of two internal promises. Unlike [==], does
     not force unification of their invariants. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Basic_helpers.val-identical"><span class="LIDENT">identical</span></span> <span id="local_p1_6"><span class="LIDENT">p1</span></span> <span id="local_p2_7"><span class="LIDENT">p2</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="LIDENT">to_public_promise</span> <a href="#local_p1_6"><span class="LIDENT">p1</span></a><span class="RPAREN">)</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(==)"><span class="INFIXOP0">==</span></a> <span class="LPAREN">(</span><span class="LIDENT">to_public_promise</span> <a href="#local_p2_7"><span class="LIDENT">p2</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* [underlying p] evaluates to the underlying promise of [p].

     If multiple [Proxy _] links are traversed, [underlying] updates all the
     proxies to point immediately to their final underlying promise. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="REC">rec</span> <span id="module-Basic_helpers.val-underlying"><span class="LIDENT">underlying</span></span><span class="EOL">
</span>      <span class="COLON">:</span> <span class="TYPE">type</span> <span class="LIDENT">u</span> <span class="LIDENT">c</span><span class="DOT">.</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="LIDENT">u</span><span class="COMMA">,</span> <span class="LIDENT">c</span><span class="RPAREN">)</span> <span class="LIDENT">promise</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="LIDENT">underlying</span><span class="COMMA">,</span> <span class="LIDENT">c</span><span class="RPAREN">)</span> <span class="LIDENT">promise</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="FUN">fun</span> <span id="local_p_8"><span class="LIDENT">p</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_p_8"><span class="LIDENT">p</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><a href="#local_p_8"><span class="LIDENT">p</span></a> <span class="COLON">:</span> <span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="LIDENT">underlying</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="LIDENT">promise</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_p_8"><span class="LIDENT">p</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_p_8"><span class="LIDENT">p</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Proxy</span> <span id="local_p'_9"><span class="LIDENT">p'</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_p''_10"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p'_9"><span class="LIDENT">p'</span></a> <span class="IN">in</span><span class="EOL">
</span>      <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-not"><span class="LIDENT">not</span></a> <span class="LPAREN">(</span><span class="LIDENT">identical</span> <a href="#local_p''_10"><span class="LIDENT">p''</span></a> <a href="#local_p'_9"><span class="LIDENT">p'</span></a><span class="RPAREN">)</span> <span class="THEN">then</span><span class="EOL">
</span>        <a href="#local_p_8"><span class="LIDENT">p</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="LESSMINUS">&lt;-</span> <span class="UIDENT">Proxy</span> <a href="#local_p''_10"><span class="LIDENT">p''</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <a href="#local_p''_10"><span class="LIDENT">p''</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Basic_helpers.type-state_changed"><span class="TYPE">type</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="QUOTE">'</span><span class="LIDENT">u</span><span class="COMMA">,</span> <span class="QUOTE">'</span><span class="LIDENT">c</span><span class="RPAREN">)</span> <span class="LIDENT">state_changed</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span id="module-Basic_helpers.type-state_changed.constructor-State_may_have_changed"><span class="BAR">|</span> <span class="UIDENT">State_may_have_changed</span> <span class="OF">of</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="QUOTE">'</span><span class="LIDENT">u</span><span class="COMMA">,</span> <span class="QUOTE">'</span><span class="LIDENT">c</span><span class="RPAREN">)</span> <span class="LIDENT">promise</span></span><span class="EOL">
</span>    <span class="LBRACKETATAT">[@@</span><span class="LIDENT">ocaml</span><span class="DOT">.</span><span class="LIDENT">unboxed</span><span class="RBRACKET">]</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Basic_helpers.val-set_promise_state"><span class="LIDENT">set_promise_state</span></span> <span id="local_p_11"><span class="LIDENT">p</span></span> <span id="local_state_12"><span class="LIDENT">state</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_p_13"><span class="LIDENT">p</span></span> <span class="COLON">:</span> <span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="LIDENT">promise</span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/obj.ml.html#val-magic"><span class="UIDENT">Obj</span><span class="DOT">.</span><span class="LIDENT">magic</span></a> <a href="#local_p_11"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>    <a href="#local_p_13"><span class="LIDENT">p</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_state_12"><span class="LIDENT">state</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="UIDENT">State_may_have_changed</span> <a href="#local_p_13"><span class="LIDENT">p</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* [set_promise_state p state] mutates the state of [p], and evaluates to a
     (wrapped) reference to [p] with the same invariants as on [state]. The
     original reference [p] should be shadowed when calling this function:

       let State_may_have_changed p = set_promise_state p (Fulfilled 42) in ...

     This is a kind of cheap imitation of linear typing, which is good enough
     for the needs of [lwt.ml].

     Internal functions that transitively call [set_promise_state] likewise
     return the new reference. This ends at some top-level function, typically
     either a callback or a function in the public API. There, the new reference
     is still bound, but is then explicitly ignored.

     The state of a promise is never updated directly outside this module
     [Basic_helpers]. All updates elsewhere are done through
     [set_promise_state].

     To avoid problems with type-level invariants not matching reality, data
     structures do not store promises with concrete invariants -- except
     resolved promises, which are immutable. Indeed, if one looks at
     definitions of data structures that can store pending promises, e.g. the
     [how_to_cancel] graph, the invariants are existentially quantified.

     Note: it's possible to statically disallow the setting of the [state] field
     by making type [promise] private. However, that seems to require writing a
     signature that is a near-duplicate of [Main_internal_types], or some abuse
     of functors. *)</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Basic_helpers.type-may_now_be_proxy"><span class="TYPE">type</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">may_now_be_proxy</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span id="module-Basic_helpers.type-may_now_be_proxy.constructor-State_may_now_be_pending_proxy"><span class="BAR">|</span> <span class="UIDENT">State_may_now_be_pending_proxy</span> <span class="COLON">:</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="LIDENT">pending</span><span class="RPAREN">)</span> <span class="LIDENT">promise</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">may_now_be_proxy</span></span><span class="EOL">
</span>    <span class="LBRACKETATAT">[@@</span><span class="LIDENT">ocaml</span><span class="DOT">.</span><span class="LIDENT">unboxed</span><span class="RBRACKET">]</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Basic_helpers.val-may_now_be_proxy"><span class="LIDENT">may_now_be_proxy</span></span> <span id="local_p_14"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="UIDENT">State_may_now_be_pending_proxy</span> <a href="#local_p_14"><span class="LIDENT">p</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Many functions, for example [Lwt.bind] and [Lwt.join], create a fresh
     pending promise [p] and return it to the user.

     They do not return a corresponding resolver. That means that only the
     function itself (typically, a callback registered by it) can resolve [p].
     The only thing the user can do directly is try to cancel [p], but, since
     [p] is not an initial promise, the cancellation attempt simply propagates
     past [p] to [p]'s predecessors. If that eventually results in canceling
     [p], it will be through the normal mechanisms of the function (e.g.
     [Lwt.bind]'s callback).

     As a result, the only possible state change, before the callback, is that
     [p] may have become a proxy. Now,

     - If [p] does not undergo this state change and become a proxy, it remains
       an underlying, pending promise.
     - If [p] does become a proxy, it will be a proxy for another promise [p']
       created fresh by [Lwt.bind], to which this same argument applies. See
       [make_into_proxy].

     So, by induction on the length of the proxy ([Proxy _]) chain, at the time
     the callback is called, [p] is either an underlying, pending promise, or a
     proxy for a pending promise.

     The cast

       let State_may_now_be_pending_proxy p = may_now_be_proxy p in ...

     encodes the possibility of this state change. It replaces a reference

       p : ('a, underlying, pending)

     with

       p : ('a, $Unknown, pending)

     and is typically seen at the beginning of callbacks registered by
     [Lwt.bind] and similar functions.

     The cast is a no-op cast. The introduction and immediate elimination of
     [State_may_have_changed _] seems to be optimized away even on old versions
     of OCaml. *)</span><span class="EOL">
</span><span class="END">end</span></span><span class="EOL">
</span><span class="OPEN">open</span> <span class="UIDENT">Basic_helpers</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* Small helpers to avoid catching ocaml-runtime exceptions *)</span><span class="EOL">
</span><span id="module-Exception_filter"><span class="MODULE">module</span> <span class="UIDENT">Exception_filter</span> <span class="EQUAL">=</span> <span class="STRUCT">struct</span><span class="EOL">
</span>  <span id="module-Exception_filter.type-t"><span class="TYPE">type</span> <span class="LIDENT">t</span> <span class="EQUAL">=</span> <span class="LIDENT">exn</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">bool</span></span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Exception_filter.val-handle_all"><span class="LIDENT">handle_all</span></span> <span class="EQUAL">=</span> <span class="FUN">fun</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="TRUE">true</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Exception_filter.val-handle_all_except_runtime"><span class="LIDENT">handle_all_except_runtime</span></span> <span class="EQUAL">=</span> <span class="FUNCTION">function</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Out_of_memory</span> <span class="MINUSGREATER">-&gt;</span> <span class="FALSE">false</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Stack_overflow</span> <span class="MINUSGREATER">-&gt;</span> <span class="FALSE">false</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="TRUE">true</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Exception_filter.val-v"><span class="LIDENT">v</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="COMMENT">(* Default value: the legacy behaviour to avoid breaking programs *)</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ref"><span class="LIDENT">ref</span></a> <span class="LIDENT">handle_all</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Exception_filter.val-set"><span class="LIDENT">set</span></span> <span id="local_f_15"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span> <span class="LIDENT">v</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="#local_f_15"><span class="LIDENT">f</span></a><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Exception_filter.val-run"><span class="LIDENT">run</span></span> <span id="local_e_16"><span class="LIDENT">e</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><span class="LIDENT">v</span> <a href="#local_e_16"><span class="LIDENT">e</span></a><span class="EOL">
</span><span class="END">end</span></span><span class="EOL">
</span><span class="EOL">
</span><span id="module-Sequence_associated_storage"><span class="MODULE">module</span> <span class="UIDENT">Sequence_associated_storage</span> <span class="COLON">:</span><span class="EOL">
</span><span class="SIG">sig</span><span class="EOL">
</span>  <span class="COMMENT">(* Public interface *)</span><span class="EOL">
</span>  <span id="module-Sequence_associated_storage.type-key"><span class="TYPE">type</span> <span class="QUOTE">'</span><span class="LIDENT">v</span> <span class="LIDENT">key</span></span><span class="EOL">
</span>  <span id="module-Sequence_associated_storage.val-new_key"><span class="VAL">val</span> <span class="LIDENT">new_key</span> <span class="COLON">:</span> <span class="LIDENT">unit</span> <span class="MINUSGREATER">-&gt;</span> <span class="UNDERSCORE">_</span> <span class="LIDENT">key</span></span><span class="EOL">
</span>  <span id="module-Sequence_associated_storage.val-get"><span class="VAL">val</span> <span class="LIDENT">get</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">v</span> <span class="LIDENT">key</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">v</span> <span class="LIDENT">option</span></span><span class="EOL">
</span>  <span id="module-Sequence_associated_storage.val-with_value"><span class="VAL">val</span> <span class="LIDENT">with_value</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">v</span> <span class="LIDENT">key</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">v</span> <span class="LIDENT">option</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="LIDENT">unit</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">b</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">b</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Internal interface *)</span><span class="EOL">
</span>  <span id="module-Sequence_associated_storage.val-current_storage"><span class="VAL">val</span> <span class="LIDENT">current_storage</span> <span class="COLON">:</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#type-ref"><span class="LIDENT">storage</span> <span class="LIDENT">ref</span></a></span><span class="EOL">
</span><span class="END">end</span> <span class="EQUAL">=</span><span class="EOL">
</span><span class="STRUCT">struct</span><span class="EOL">
</span>  <span class="COMMENT">(* The idea behind sequence-associated storage is to preserve some values
     during a call to [bind] or other sequential composition operation, and
     restore those values in the callback function:

       Lwt.with_value my_key (Some &quot;foo&quot;) (fun () -&gt;
       p &gt;|= fun () -&gt;
       assert (Lwt.get my_key = Some &quot;foo&quot;))
         (* Will succeed even if this callback is called later. *)

     Note that it does not matter that the callback is defined within an
     argument of [with_value], i.e., this does the same:

       let f = fun () -&gt; assert (Lwt.get my_key = Some &quot;foo&quot;) in
       Lwt.with_value my_key (Some &quot;foo&quot;) (fun () -&gt; p &gt;|= f)

     All that matters is that the top-most sequencing operation (in this case,
     map) is executed by that argument.

     This is implemented using a single global heterogeneous key-value map.
     Sequential composition functions snapshot this map when they are called,
     and restore the snapshot right before calling the user's callback. The same
     happens for cancel triggers added by [on_cancel].

     Maintainer's note: I think using this mechanism should be discouraged in
     new code. *)</span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Sequence_associated_storage.type-key"><span class="TYPE">type</span> <span class="QUOTE">'</span><span class="LIDENT">v</span> <span class="LIDENT">key</span> <span class="EQUAL">=</span> <span class="LBRACE">{</span><span class="EOL">
</span>    <span id="def_783"><span class="LIDENT">id</span> <span class="COLON">:</span> <span class="LIDENT">int</span><span class="SEMI">;</span></span><span class="EOL">
</span>    <span id="def_807"><span class="MUTABLE">mutable</span> <span class="LIDENT">value</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">v</span> <span class="LIDENT">option</span><span class="SEMI">;</span></span><span class="EOL">
</span>  <span class="RBRACE">}</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Sequence_associated_storage.val-next_key_id"><span class="LIDENT">next_key_id</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ref"><span class="LIDENT">ref</span></a> <span class="INT">0</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Sequence_associated_storage.val-new_key"><span class="LIDENT">new_key</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_id_17"><span class="LIDENT">id</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><span class="LIDENT">next_key_id</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="LIDENT">next_key_id</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="#local_id_17"><span class="LIDENT">id</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <span class="INT">1</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LBRACE">{</span><span class="LIDENT">id</span> <span class="EQUAL">=</span> <a href="#local_id_17"><span class="LIDENT">id</span></a><span class="SEMI">;</span> <span class="LIDENT">value</span> <span class="EQUAL">=</span> <span class="UIDENT">None</span><span class="RBRACE">}</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Sequence_associated_storage.val-current_storage"><span class="LIDENT">current_storage</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ref"><span class="LIDENT">ref</span></a> <span class="UIDENT">Storage_map</span><span class="DOT">.</span><span class="LIDENT">empty</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Sequence_associated_storage.val-get"><span class="LIDENT">get</span></span> <span id="local_key_18"><span class="LIDENT">key</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="IF">if</span> <span class="UIDENT">Storage_map</span><span class="DOT">.</span><span class="LIDENT">mem</span> <a href="#local_key_18"><span class="LIDENT">key</span></a><span class="DOT">.</span><span class="LIDENT">id</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><span class="LIDENT">current_storage</span> <span class="THEN">then</span> <span class="BEGIN">begin</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_refresh_19"><span class="LIDENT">refresh</span></span> <span class="EQUAL">=</span> <span class="UIDENT">Storage_map</span><span class="DOT">.</span><span class="LIDENT">find</span> <a href="#local_key_18"><span class="LIDENT">key</span></a><span class="DOT">.</span><span class="LIDENT">id</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><span class="LIDENT">current_storage</span> <span class="IN">in</span><span class="EOL">
</span>      <a href="#local_refresh_19"><span class="LIDENT">refresh</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_value_20"><span class="LIDENT">value</span></span> <span class="EQUAL">=</span> <a href="#local_key_18"><span class="LIDENT">key</span></a><span class="DOT">.</span><span class="LIDENT">value</span> <span class="IN">in</span><span class="EOL">
</span>      <a href="#local_key_18"><span class="LIDENT">key</span></a><span class="DOT">.</span><span class="LIDENT">value</span> <span class="LESSMINUS">&lt;-</span> <span class="UIDENT">None</span><span class="SEMI">;</span><span class="EOL">
</span>      <a href="#local_value_20"><span class="LIDENT">value</span></a><span class="EOL">
</span>    <span class="END">end</span><span class="EOL">
</span>    <span class="ELSE">else</span><span class="EOL">
</span>      <span class="UIDENT">None</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Sequence_associated_storage.val-with_value"><span class="LIDENT">with_value</span></span> <span id="local_key_21"><span class="LIDENT">key</span></span> <span id="local_value_22"><span class="LIDENT">value</span></span> <span id="local_f_23"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_new_storage_24"><span class="LIDENT">new_storage</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="MATCH">match</span> <a href="#local_value_22"><span class="LIDENT">value</span></a> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Some</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_refresh_25"><span class="LIDENT">refresh</span></span> <span class="EQUAL">=</span> <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_key_21"><span class="LIDENT">key</span></a><span class="DOT">.</span><span class="LIDENT">value</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_value_22"><span class="LIDENT">value</span></a> <span class="IN">in</span><span class="EOL">
</span>        <span class="UIDENT">Storage_map</span><span class="DOT">.</span><span class="LIDENT">add</span> <a href="#local_key_21"><span class="LIDENT">key</span></a><span class="DOT">.</span><span class="LIDENT">id</span> <a href="#local_refresh_25"><span class="LIDENT">refresh</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><span class="LIDENT">current_storage</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="UIDENT">Storage_map</span><span class="DOT">.</span><span class="LIDENT">remove</span> <a href="#local_key_21"><span class="LIDENT">key</span></a><span class="DOT">.</span><span class="LIDENT">id</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><span class="LIDENT">current_storage</span><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_saved_storage_26"><span class="LIDENT">saved_storage</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><span class="LIDENT">current_storage</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="LIDENT">current_storage</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="#local_new_storage_24"><span class="LIDENT">new_storage</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="TRY">try</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_result_27"><span class="LIDENT">result</span></span> <span class="EQUAL">=</span> <a href="#local_f_23"><span class="LIDENT">f</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>      <span class="LIDENT">current_storage</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="#local_saved_storage_26"><span class="LIDENT">saved_storage</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <a href="#local_result_27"><span class="LIDENT">result</span></a><span class="EOL">
</span>    <span class="WITH">with</span> <span id="local_exn_28"><span class="LIDENT">exn</span></span> <span class="WHEN">when</span> <span class="UIDENT">Exception_filter</span><span class="DOT">.</span><span class="LIDENT">run</span> <a href="#local_exn_28"><span class="LIDENT">exn</span></a> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">current_storage</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="#local_saved_storage_26"><span class="LIDENT">saved_storage</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-raise"><span class="LIDENT">raise</span></a> <a href="#local_exn_28"><span class="LIDENT">exn</span></a><span class="EOL">
</span><span class="END">end</span></span><span class="EOL">
</span><span class="INCLUDE">include</span> <span class="UIDENT">Sequence_associated_storage</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span id="module-Pending_callbacks"><span class="MODULE">module</span> <span class="UIDENT">Pending_callbacks</span> <span class="COLON">:</span><span class="EOL">
</span><span class="SIG">sig</span><span class="EOL">
</span>  <span class="COMMENT">(* Mutating callback lists attached to pending promises *)</span><span class="EOL">
</span>  <span id="module-Pending_callbacks.val-add_implicitly_removed_callback"><span class="VAL">val</span> <span class="LIDENT">add_implicitly_removed_callback</span> <span class="COLON">:</span><span class="EOL">
</span>    <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">callbacks</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">regular_callback</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span></span><span class="EOL">
</span>  <span id="module-Pending_callbacks.val-add_explicitly_removable_callback_to_each_of"><span class="VAL">val</span> <span class="LIDENT">add_explicitly_removable_callback_to_each_of</span> <span class="COLON">:</span><span class="EOL">
</span>    <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="LIDENT">list</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">regular_callback</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span></span><span class="EOL">
</span>  <span id="module-Pending_callbacks.val-add_explicitly_removable_callback_and_give_remove_function"><span class="VAL">val</span> <span class="LIDENT">add_explicitly_removable_callback_and_give_remove_function</span> <span class="COLON">:</span><span class="EOL">
</span>    <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="LIDENT">list</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">regular_callback</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">cancel_callback</span></span><span class="EOL">
</span>  <span id="module-Pending_callbacks.val-add_cancel_callback"><span class="VAL">val</span> <span class="LIDENT">add_cancel_callback</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">callbacks</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">cancel_callback</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span></span><span class="EOL">
</span>  <span id="module-Pending_callbacks.val-merge_callbacks"><span class="VAL">val</span> <span class="LIDENT">merge_callbacks</span> <span class="COLON">:</span> <span class="LIDENT">from</span><span class="COLON">:</span><span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">callbacks</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">into</span><span class="COLON">:</span><span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">callbacks</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span></span><span class="EOL">
</span><span class="END">end</span> <span class="EQUAL">=</span><span class="EOL">
</span><span class="STRUCT">struct</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Pending_callbacks.val-concat_regular_callbacks"><span class="LIDENT">concat_regular_callbacks</span></span> <span id="local_l1_29"><span class="LIDENT">l1</span></span> <span id="local_l2_30"><span class="LIDENT">l2</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="BEGIN">begin</span> <span class="MATCH">match</span> <a href="#local_l1_29"><span class="LIDENT">l1</span></a><span class="COMMA">,</span> <a href="#local_l2_30"><span class="LIDENT">l2</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Regular_callback_list_empty</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_l2_30"><span class="LIDENT">l2</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UIDENT">Regular_callback_list_empty</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_l1_29"><span class="LIDENT">l1</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Regular_callback_list_concat</span> <span class="LPAREN">(</span><a href="#local_l1_29"><span class="LIDENT">l1</span></a><span class="COMMA">,</span> <a href="#local_l2_30"><span class="LIDENT">l2</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="END">end</span> <span class="LBRACKETAT">[@</span><span class="LIDENT">ocaml</span><span class="DOT">.</span><span class="LIDENT">warning</span> <span class="STRING">&quot;-4&quot;</span><span class="RBRACKET">]</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Pending_callbacks.val-concat_cancel_callbacks"><span class="LIDENT">concat_cancel_callbacks</span></span> <span id="local_l1_31"><span class="LIDENT">l1</span></span> <span id="local_l2_32"><span class="LIDENT">l2</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="BEGIN">begin</span> <span class="MATCH">match</span> <a href="#local_l1_31"><span class="LIDENT">l1</span></a><span class="COMMA">,</span> <a href="#local_l2_32"><span class="LIDENT">l2</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Cancel_callback_list_empty</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_l2_32"><span class="LIDENT">l2</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UIDENT">Cancel_callback_list_empty</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_l1_31"><span class="LIDENT">l1</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Cancel_callback_list_concat</span> <span class="LPAREN">(</span><a href="#local_l1_31"><span class="LIDENT">l1</span></a><span class="COMMA">,</span> <a href="#local_l2_32"><span class="LIDENT">l2</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="END">end</span> <span class="LBRACKETAT">[@</span><span class="LIDENT">ocaml</span><span class="DOT">.</span><span class="LIDENT">warning</span> <span class="STRING">&quot;-4&quot;</span><span class="RBRACKET">]</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* In a callback list, filters out cells of explicitly removable callbacks
     that have been removed. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="REC">rec</span> <span id="module-Pending_callbacks.val-clean_up_callback_cells"><span class="LIDENT">clean_up_callback_cells</span></span> <span class="EQUAL">=</span> <span class="FUNCTION">function</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Regular_callback_list_explicitly_removable_callback</span> <span class="LBRACE">{</span><span class="LIDENT">contents</span> <span class="EQUAL">=</span> <span class="UIDENT">None</span><span class="RBRACE">}</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="UIDENT">Regular_callback_list_empty</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Regular_callback_list_explicitly_removable_callback</span> <span class="LBRACE">{</span><span class="LIDENT">contents</span> <span class="EQUAL">=</span> <span class="UIDENT">Some</span> <span class="UNDERSCORE">_</span><span class="RBRACE">}</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Regular_callback_list_implicitly_removed_callback</span> <span class="UNDERSCORE">_</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Regular_callback_list_empty</span> <span class="AS">as</span> <span id="local_callbacks_33"><span class="LIDENT">callbacks</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="#local_callbacks_33"><span class="LIDENT">callbacks</span></a><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Regular_callback_list_concat</span> <span class="LPAREN">(</span><span id="local_l1_34"><span class="LIDENT">l1</span></span><span class="COMMA">,</span> <span id="local_l2_35"><span class="LIDENT">l2</span></span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_l1_36"><span class="LIDENT">l1</span></span> <span class="EQUAL">=</span> <span class="LIDENT">clean_up_callback_cells</span> <a href="#local_l1_34"><span class="LIDENT">l1</span></a> <span class="IN">in</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_l2_37"><span class="LIDENT">l2</span></span> <span class="EQUAL">=</span> <span class="LIDENT">clean_up_callback_cells</span> <a href="#local_l2_35"><span class="LIDENT">l2</span></a> <span class="IN">in</span><span class="EOL">
</span>      <span class="LIDENT">concat_regular_callbacks</span> <a href="#local_l1_36"><span class="LIDENT">l1</span></a> <a href="#local_l2_37"><span class="LIDENT">l2</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* See [clear_explicitly_removable_callback_cell] and [merge_callbacks]. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Pending_callbacks.val-cleanup_throttle"><span class="LIDENT">cleanup_throttle</span></span> <span class="EQUAL">=</span> <span class="INT">42</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Explicitly removable callbacks are added (mainly) by [Lwt.choose] and its
     similar functions. In [Lwt.choose [p; p']], if [p'] resolves first, the
     callback added by [Lwt.choose] to [p] is removed.

     The removal itself is accomplished when this function clears the reference
     cell [cell], which contains the reference to that callback.

     If [p] is a long-pending promise that repeatedly participates in
     [Lwt.choose], perhaps in a loop, it will accumulate a large number of
     cleared reference cells in this fashion. To avoid a memory leak, they must
     be cleaned up. However, the cells are not cleaned up on *every* removal,
     presumably because scanning the callback list that often, and rebuilding
     it, can get expensive.

     Cleanup is throttled by maintaining a counter, [cleanups_deferred], on each
     pending promise. The counter is incremented each time this function wants
     to clean the callback list (right after clearing a cell). When the counter
     reaches [cleanup_throttle], the callback list is actually scanned and
     cleared callback cells are removed. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Pending_callbacks.val-clear_explicitly_removable_callback_cell"><span class="LIDENT">clear_explicitly_removable_callback_cell</span></span> <span id="local_cell_38"><span class="LIDENT">cell</span></span> <span class="LABEL">~originally_added_to:</span><span id="local_ps_39"><span class="LIDENT">ps</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <a href="#local_cell_38"><span class="LIDENT">cell</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <span class="UIDENT">None</span><span class="SEMI">;</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="COMMENT">(* Go through the promises the cell had originally been added to, and either
       defer a cleanup, or actually clean up their callback lists. *)</span><span class="EOL">
</span>    <a href="#local_ps_39"><span class="LIDENT">ps</span></a> <span class="INFIXOP0">|&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-iter"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">iter</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_p_40"><span class="LIDENT">p</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p_41"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p_40"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>      <span class="MATCH">match</span> <span class="LPAREN">(</span><span class="LIDENT">underlying</span> <a href="#local_p_41"><span class="LIDENT">p</span></a><span class="RPAREN">)</span><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>      <span class="COMMENT">(* Some of the promises may already have been resolved at the time this
         function is called. *)</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span id="local_callbacks_42"><span class="LIDENT">callbacks</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="MATCH">match</span> <a href="#local_callbacks_42"><span class="LIDENT">callbacks</span></a><span class="DOT">.</span><span class="LIDENT">regular_callbacks</span> <span class="WITH">with</span><span class="EOL">
</span>        <span class="COMMENT">(* If the promise has only one regular callback, and it is removable, it
           must have been the cell cleared in this function, above. In that
           case, just set its callback list to empty. *)</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Regular_callback_list_explicitly_removable_callback</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="#local_callbacks_42"><span class="LIDENT">callbacks</span></a><span class="DOT">.</span><span class="LIDENT">regular_callbacks</span> <span class="LESSMINUS">&lt;-</span> <span class="UIDENT">Regular_callback_list_empty</span><span class="EOL">
</span><span class="EOL">
</span>        <span class="COMMENT">(* Maintainer's note: I think this function shouldn't try to trigger a
           cleanup in the first two cases, but I am preserving them for now, as
           this is how the code was written in the past. *)</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Regular_callback_list_empty</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Regular_callback_list_implicitly_removed_callback</span> <span class="UNDERSCORE">_</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Regular_callback_list_concat</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_cleanups_deferred_43"><span class="LIDENT">cleanups_deferred</span></span> <span class="EQUAL">=</span> <a href="#local_callbacks_42"><span class="LIDENT">callbacks</span></a><span class="DOT">.</span><span class="LIDENT">cleanups_deferred</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <span class="INT">1</span> <span class="IN">in</span><span class="EOL">
</span>          <span class="IF">if</span> <a href="#local_cleanups_deferred_43"><span class="LIDENT">cleanups_deferred</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <span class="LIDENT">cleanup_throttle</span> <span class="THEN">then</span> <span class="BEGIN">begin</span><span class="EOL">
</span>            <a href="#local_callbacks_42"><span class="LIDENT">callbacks</span></a><span class="DOT">.</span><span class="LIDENT">cleanups_deferred</span> <span class="LESSMINUS">&lt;-</span> <span class="INT">0</span><span class="SEMI">;</span><span class="EOL">
</span>            <a href="#local_callbacks_42"><span class="LIDENT">callbacks</span></a><span class="DOT">.</span><span class="LIDENT">regular_callbacks</span> <span class="LESSMINUS">&lt;-</span><span class="EOL">
</span>              <span class="LIDENT">clean_up_callback_cells</span> <a href="#local_callbacks_42"><span class="LIDENT">callbacks</span></a><span class="DOT">.</span><span class="LIDENT">regular_callbacks</span><span class="EOL">
</span>          <span class="END">end</span> <span class="ELSE">else</span><span class="EOL">
</span>            <a href="#local_callbacks_42"><span class="LIDENT">callbacks</span></a><span class="DOT">.</span><span class="LIDENT">cleanups_deferred</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_cleanups_deferred_43"><span class="LIDENT">cleanups_deferred</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Concatenates both kinds of callbacks on [~from] to the corresponding lists
     of [~into]. The callback lists on [~from] are *not* then cleared, because
     this function is called only by [Sequential_composition.make_into_proxy],
     which immediately changes the state of [~from] and loses references to the
     original callback lists.

     The [cleanups_deferred] fields of both promises are summed, and if the sum
     exceeds [cleanup_throttle], a cleanup of regular callbacks is triggered.
     This is to prevent memory leaks; see
     [clear_explicitly_removable_callback_cell]. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Pending_callbacks.val-merge_callbacks"><span class="LIDENT">merge_callbacks</span></span> <span class="TILDE">~</span><span id="local_from_44"><span class="LIDENT">from</span></span> <span class="TILDE">~</span><span id="local_into_45"><span class="LIDENT">into</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_regular_callbacks_46"><span class="LIDENT">regular_callbacks</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LIDENT">concat_regular_callbacks</span> <a href="#local_into_45"><span class="LIDENT">into</span></a><span class="DOT">.</span><span class="LIDENT">regular_callbacks</span> <a href="#local_from_44"><span class="LIDENT">from</span></a><span class="DOT">.</span><span class="LIDENT">regular_callbacks</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_cleanups_deferred_47"><span class="LIDENT">cleanups_deferred</span></span> <span class="EQUAL">=</span> <a href="#local_into_45"><span class="LIDENT">into</span></a><span class="DOT">.</span><span class="LIDENT">cleanups_deferred</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <a href="#local_from_44"><span class="LIDENT">from</span></a><span class="DOT">.</span><span class="LIDENT">cleanups_deferred</span> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="def_799"><span id="local_regular_callbacks_48"><span class="LIDENT">regular_callbacks</span></span><span class="COMMA">,</span> <span id="local_cleanups_deferred_49"><span class="LIDENT">cleanups_deferred</span></span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="IF">if</span> <a href="#local_cleanups_deferred_47"><span class="LIDENT">cleanups_deferred</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <span class="LIDENT">cleanup_throttle</span> <span class="THEN">then</span><span class="EOL">
</span>        <span class="LIDENT">clean_up_callback_cells</span> <a href="#local_regular_callbacks_46"><span class="LIDENT">regular_callbacks</span></a><span class="COMMA">,</span> <span class="INT">0</span><span class="EOL">
</span>      <span class="ELSE">else</span><span class="EOL">
</span>        <a href="#local_regular_callbacks_46"><span class="LIDENT">regular_callbacks</span></a><span class="COMMA">,</span> <a href="#local_cleanups_deferred_47"><span class="LIDENT">cleanups_deferred</span></a><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_cancel_callbacks_50"><span class="LIDENT">cancel_callbacks</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LIDENT">concat_cancel_callbacks</span> <a href="#local_into_45"><span class="LIDENT">into</span></a><span class="DOT">.</span><span class="LIDENT">cancel_callbacks</span> <a href="#local_from_44"><span class="LIDENT">from</span></a><span class="DOT">.</span><span class="LIDENT">cancel_callbacks</span> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <a href="#local_into_45"><span class="LIDENT">into</span></a><span class="DOT">.</span><span class="LIDENT">regular_callbacks</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_regular_callbacks_48"><span class="LIDENT">regular_callbacks</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <a href="#local_into_45"><span class="LIDENT">into</span></a><span class="DOT">.</span><span class="LIDENT">cancel_callbacks</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_cancel_callbacks_50"><span class="LIDENT">cancel_callbacks</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <a href="#local_into_45"><span class="LIDENT">into</span></a><span class="DOT">.</span><span class="LIDENT">cleanups_deferred</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_cleanups_deferred_49"><span class="LIDENT">cleanups_deferred</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* General, internal, function for adding a regular callback. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Pending_callbacks.val-add_regular_callback_list_node"><span class="LIDENT">add_regular_callback_list_node</span></span> <span id="local_callbacks_51"><span class="LIDENT">callbacks</span></span> <span id="local_node_52"><span class="LIDENT">node</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <a href="#local_callbacks_51"><span class="LIDENT">callbacks</span></a><span class="DOT">.</span><span class="LIDENT">regular_callbacks</span> <span class="LESSMINUS">&lt;-</span><span class="EOL">
</span>      <span class="MATCH">match</span> <a href="#local_callbacks_51"><span class="LIDENT">callbacks</span></a><span class="DOT">.</span><span class="LIDENT">regular_callbacks</span> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Regular_callback_list_empty</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <a href="#local_node_52"><span class="LIDENT">node</span></a><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Regular_callback_list_implicitly_removed_callback</span> <span class="UNDERSCORE">_</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Regular_callback_list_explicitly_removable_callback</span> <span class="UNDERSCORE">_</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Regular_callback_list_concat</span> <span class="UNDERSCORE">_</span> <span class="AS">as</span> <span id="local_existing_53"><span class="LIDENT">existing</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="UIDENT">Regular_callback_list_concat</span> <span class="LPAREN">(</span><a href="#local_node_52"><span class="LIDENT">node</span></a><span class="COMMA">,</span> <a href="#local_existing_53"><span class="LIDENT">existing</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Pending_callbacks.val-add_implicitly_removed_callback"><span class="LIDENT">add_implicitly_removed_callback</span></span> <span id="local_callbacks_54"><span class="LIDENT">callbacks</span></span> <span id="local_f_55"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">add_regular_callback_list_node</span><span class="EOL">
</span>      <a href="#local_callbacks_54"><span class="LIDENT">callbacks</span></a> <span class="LPAREN">(</span><span class="UIDENT">Regular_callback_list_implicitly_removed_callback</span> <a href="#local_f_55"><span class="LIDENT">f</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Adds [callback] as removable to each promise in [ps]. The first promise in
     [ps] to trigger [callback] removes [callback] from the other promises; this
     guarantees that [callback] is called at most once. All the promises in [ps]
     must be pending.

     This is an internal function, indirectly used by the implementations of
     [Lwt.choose] and related functions. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Pending_callbacks.val-add_explicitly_removable_callback_and_give_cell"><span class="LIDENT">add_explicitly_removable_callback_and_give_cell</span></span> <span id="local_ps_56"><span class="LIDENT">ps</span></span> <span id="local_f_57"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="REC">rec</span> <span id="local_cell_58"><span class="LIDENT">cell</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ref"><span class="LIDENT">ref</span></a> <span class="LPAREN">(</span><span class="UIDENT">Some</span> <a href="#local_self_removing_callback_wrapper_59"><span class="LIDENT">self_removing_callback_wrapper</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="AND">and</span> <span id="local_self_removing_callback_wrapper_59"><span class="LIDENT">self_removing_callback_wrapper</span></span> <span id="local_result_60"><span class="LIDENT">result</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LIDENT">clear_explicitly_removable_callback_cell</span> <a href="#local_cell_58"><span class="LIDENT">cell</span></a> <span class="LABEL">~originally_added_to:</span><a href="#local_ps_56"><span class="LIDENT">ps</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <a href="#local_f_57"><span class="LIDENT">f</span></a> <a href="#local_result_60"><span class="LIDENT">result</span></a><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_node_61"><span class="LIDENT">node</span></span> <span class="EQUAL">=</span> <span class="UIDENT">Regular_callback_list_explicitly_removable_callback</span> <a href="#local_cell_58"><span class="LIDENT">cell</span></a> <span class="IN">in</span><span class="EOL">
</span>    <a href="#local_ps_56"><span class="LIDENT">ps</span></a> <span class="INFIXOP0">|&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-iter"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">iter</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_p_62"><span class="LIDENT">p</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p_63"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p_62"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>      <span class="MATCH">match</span> <span class="LPAREN">(</span><span class="LIDENT">underlying</span> <a href="#local_p_63"><span class="LIDENT">p</span></a><span class="RPAREN">)</span><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span id="local_callbacks_64"><span class="LIDENT">callbacks</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">add_regular_callback_list_node</span> <a href="#local_callbacks_64"><span class="LIDENT">callbacks</span></a> <a href="#local_node_61"><span class="LIDENT">node</span></a><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="ASSERT">assert</span> <span class="FALSE">false</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="ASSERT">assert</span> <span class="FALSE">false</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span><span class="EOL">
</span>    <a href="#local_cell_58"><span class="LIDENT">cell</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Pending_callbacks.val-add_explicitly_removable_callback_to_each_of"><span class="LIDENT">add_explicitly_removable_callback_to_each_of</span></span> <span id="local_ps_65"><span class="LIDENT">ps</span></span> <span id="local_f_66"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a> <span class="LPAREN">(</span><span class="LIDENT">add_explicitly_removable_callback_and_give_cell</span> <a href="#local_ps_65"><span class="LIDENT">ps</span></a> <a href="#local_f_66"><span class="LIDENT">f</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* This is basically just to support [Lwt.protected], which needs to remove
     the callback in circumstances other than the callback being called. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Pending_callbacks.val-add_explicitly_removable_callback_and_give_remove_function"><span class="LIDENT">add_explicitly_removable_callback_and_give_remove_function</span></span> <span id="local_ps_67"><span class="LIDENT">ps</span></span> <span id="local_f_68"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_cell_69"><span class="LIDENT">cell</span></span> <span class="EQUAL">=</span> <span class="LIDENT">add_explicitly_removable_callback_and_give_cell</span> <a href="#local_ps_67"><span class="LIDENT">ps</span></a> <a href="#local_f_68"><span class="LIDENT">f</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">clear_explicitly_removable_callback_cell</span> <a href="#local_cell_69"><span class="LIDENT">cell</span></a> <span class="LABEL">~originally_added_to:</span><a href="#local_ps_67"><span class="LIDENT">ps</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Pending_callbacks.val-add_cancel_callback"><span class="LIDENT">add_cancel_callback</span></span> <span id="local_callbacks_70"><span class="LIDENT">callbacks</span></span> <span id="local_f_71"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_node_72"><span class="LIDENT">node</span></span> <span class="EQUAL">=</span> <span class="UIDENT">Cancel_callback_list_callback</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><span class="LIDENT">current_storage</span><span class="COMMA">,</span> <a href="#local_f_71"><span class="LIDENT">f</span></a><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <a href="#local_callbacks_70"><span class="LIDENT">callbacks</span></a><span class="DOT">.</span><span class="LIDENT">cancel_callbacks</span> <span class="LESSMINUS">&lt;-</span><span class="EOL">
</span>      <span class="MATCH">match</span> <a href="#local_callbacks_70"><span class="LIDENT">callbacks</span></a><span class="DOT">.</span><span class="LIDENT">cancel_callbacks</span> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Cancel_callback_list_empty</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <a href="#local_node_72"><span class="LIDENT">node</span></a><span class="EOL">
</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Cancel_callback_list_callback</span> <span class="UNDERSCORE">_</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Cancel_callback_list_remove_sequence_node</span> <span class="UNDERSCORE">_</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Cancel_callback_list_concat</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="UIDENT">Cancel_callback_list_concat</span> <span class="LPAREN">(</span><a href="#local_node_72"><span class="LIDENT">node</span></a><span class="COMMA">,</span> <a href="#local_callbacks_70"><span class="LIDENT">callbacks</span></a><span class="DOT">.</span><span class="LIDENT">cancel_callbacks</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="END">end</span></span><span class="EOL">
</span><span class="OPEN">open</span> <span class="UIDENT">Pending_callbacks</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span id="module-Resolution_loop"><span class="MODULE">module</span> <span class="UIDENT">Resolution_loop</span> <span class="COLON">:</span><span class="EOL">
</span><span class="SIG">sig</span><span class="EOL">
</span>  <span class="COMMENT">(* All user-provided callbacks are called by Lwt only through this module. It
     tracks the current callback stack depth, and decides whether each callback
     call should be deferred or not. *)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Internal interface used only in this module Lwt *)</span><span class="EOL">
</span>  <span id="module-Resolution_loop.val-resolve"><span class="VAL">val</span> <span class="LIDENT">resolve</span> <span class="COLON">:</span><span class="EOL">
</span>    <span class="OPTLABEL">?allow_deferring:</span><span class="LIDENT">bool</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="OPTLABEL">?maximum_callback_nesting_depth:</span><span class="LIDENT">int</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="LIDENT">underlying</span><span class="COMMA">,</span> <span class="LIDENT">pending</span><span class="RPAREN">)</span> <span class="LIDENT">promise</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">resolved_state</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="LIDENT">underlying</span><span class="COMMA">,</span> <span class="LIDENT">resolved</span><span class="RPAREN">)</span> <span class="LIDENT">state_changed</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Resolution_loop.val-run_callbacks_or_defer_them"><span class="VAL">val</span> <span class="LIDENT">run_callbacks_or_defer_them</span> <span class="COLON">:</span><span class="EOL">
</span>    <span class="OPTLABEL">?allow_deferring:</span><span class="LIDENT">bool</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="OPTLABEL">?maximum_callback_nesting_depth:</span><span class="LIDENT">int</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">callbacks</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">resolved_state</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">unit</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Resolution_loop.val-run_callback_or_defer_it"><span class="VAL">val</span> <span class="LIDENT">run_callback_or_defer_it</span> <span class="COLON">:</span><span class="EOL">
</span>    <span class="OPTLABEL">?run_immediately_and_ensure_tail_call:</span><span class="LIDENT">bool</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LIDENT">callback</span><span class="COLON">:</span><span class="LPAREN">(</span><span class="LIDENT">unit</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LIDENT">if_deferred</span><span class="COLON">:</span><span class="LPAREN">(</span><span class="LIDENT">unit</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="STAR">*</span> <span class="QUOTE">'</span><span class="LIDENT">b</span> <span class="LIDENT">regular_callback</span> <span class="STAR">*</span> <span class="QUOTE">'</span><span class="LIDENT">b</span> <span class="LIDENT">resolved_state</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="QUOTE">'</span><span class="LIDENT">a</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Resolution_loop.val-handle_with_async_exception_hook"><span class="VAL">val</span> <span class="LIDENT">handle_with_async_exception_hook</span> <span class="COLON">:</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Internal interface exposed to other modules in Lwt *)</span><span class="EOL">
</span>  <span id="module-Resolution_loop.val-abandon_wakeups"><span class="VAL">val</span> <span class="LIDENT">abandon_wakeups</span> <span class="COLON">:</span> <span class="LIDENT">unit</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Public interface *)</span><span class="EOL">
</span>  <span id="module-Resolution_loop.exception-Canceled"><span id="exception-Canceled"><span class="EXCEPTION">exception</span> <span class="UIDENT">Canceled</span></span></span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Resolution_loop.val-async_exception_hook"><span class="VAL">val</span> <span class="LIDENT">async_exception_hook</span> <span class="COLON">:</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#type-ref"><span class="LPAREN">(</span><span class="LIDENT">exn</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span><span class="RPAREN">)</span> <span class="LIDENT">ref</span></a></span><span class="EOL">
</span><span class="END">end</span> <span class="EQUAL">=</span><span class="EOL">
</span><span class="STRUCT">struct</span><span class="EOL">
</span>  <span class="COMMENT">(* When Lwt needs to call a callback, it enters the resolution loop. This
     typically happens when Lwt sets the state of one promise to [Fulfilled _]
     or [Rejected _]. The callbacks that were attached to the promise when it
     was pending must then be called.

     This also happens in a few other situations. For example, when [Lwt.bind]
     is called on a promise, but that promise is already resolved, the callback
     passed to [bind] must be called.

     The callbacks triggered during the resolution loop might resolve more
     promises, triggering more callbacks, and so on. This is what makes the
     resolution loop a {e loop}.

     Lwt generally tries to call each callback immediately. However, this can
     lead to a progressive deepening of the call stack, until there is a stack
     overflow. This can't be avoided by doing tail calls, because Lwt always
     needs to do exception handling around callbacks calls: each callback call
     is followed by an exception handler. Instead, what Lwt does is track the
     current callback call depth. Once that depth reaches a certain number,
     [default_maximum_callback_nesting_depth], defined below, further callbacks
     are deferred into a queue instead. That queue is drained when Lwt exits
     from the top-most callback call that triggered the resolution loop in the
     first place.

     To ensure that this deferral mechanism is always properly invoked, all
     callbacks called by Lwt are called through one of three functions provided
     by this module:

     - [resolve], which calls all the callbacks associated to a pending promise
       (and resolves it, changing its state).
     - [run_callbacks_or_defer_them], which is internally used by [resolve] to
       call callbacks that are in a record of type ['a callbacks], which records
       are associated with pending promises. This function is exposed because
       the current implementation of [Lwt.cancel] needs to call it directly.
       Promise resolution and callback calling are separated in a unique way in
       [cancel].
     - [run_callback_or_defer_it], which is used by [Lwt.bind] and similar
       functions to call single callbacks when the promises passed to
       [Lwt.bind], etc., are already resolved.

     Current Lwt actually has a messy mix of callback-calling behaviors. For
     example, [Lwt.bind] is expected to always call its callback immediately,
     while [Lwt.wakeup_later] is expected to defer all callbacks of the promise
     resolved, {e unless} Lwt is not already inside the resolution loop.

     We planned to make these behaviors uniform in Lwt 4.0.0, but decided
     against it due to the risk of breaking users. See

     - https://github.com/ocsigen/lwt/pull/500
     - https://github.com/ocsigen/lwt/pull/519

     As part of the preparation for the change, the above callback-invoking
     functions support several optional arguments to emulate the various
     behaviors. We decided not to remove this machinery, because we might want
     to expose different APIs to Lwt in the future.

     - [~allow_deferring:false] allows ignoring the callback stack depth, and
       calling the callbacks immediately. This emulates the old resolution
       behavior.
     - [~maximum_callback_nesting_depth:1] allows limiting the depth which
       triggers deferral on a per-call-site basis. This is used by
       [Lwt.wakeup_later].
     - [~run_immediately_and_ensure_tail_call:true] is like
       [~allow_deferring:false], which ignores the callback stack depth.
       However, to ensure that the callback is tail-called, Lwt doesn't even
       update the callback stack depth for the benefit of *other* callback
       calls. It just blindly calls the callback.

     See discussion of callback-calling semantics in:

       https://github.com/ocsigen/lwt/issues/329

     * Context

     The resolution loop effectively handles all promises that can be resolved
     immediately, without blocking on I/O. A complete program that does I/O
     calls [Lwt_main.run]. See &quot;No I/O&quot; in the Overview. *)</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Resolution_loop.val-async_exception_hook"><span class="LIDENT">async_exception_hook</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ref"><span class="LIDENT">ref</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_exn_73"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-prerr_string"><span class="LIDENT">prerr_string</span></a> <span class="STRING">&quot;Fatal error: exception &quot;</span><span class="SEMI">;</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-prerr_string"><span class="LIDENT">prerr_string</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/printexc.ml.html#val-to_string"><span class="UIDENT">Printexc</span><span class="DOT">.</span><span class="LIDENT">to_string</span></a> <a href="#local_exn_73"><span class="LIDENT">exn</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-prerr_char"><span class="LIDENT">prerr_char</span></a> <span class="CHAR">'\n'</span><span class="SEMI">;</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/printexc.ml.html#val-print_backtrace"><span class="UIDENT">Printexc</span><span class="DOT">.</span><span class="LIDENT">print_backtrace</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-stderr"><span class="LIDENT">stderr</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-flush"><span class="LIDENT">flush</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-stderr"><span class="LIDENT">stderr</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-exit"><span class="LIDENT">exit</span></a> <span class="INT">2</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Resolution_loop.val-handle_with_async_exception_hook"><span class="LIDENT">handle_with_async_exception_hook</span></span> <span id="local_f_74"><span class="LIDENT">f</span></span> <span id="local_v_75"><span class="LIDENT">v</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="COMMENT">(* Note that this function does not care if [f] evaluates to a promise. In
       particular, if [f v] evaluates to [p] and [p] is already rejected or will
       be reject later, it is not the responsibility of this function to pass
       the exception to [!async_exception_hook]. *)</span><span class="EOL">
</span>    <span class="TRY">try</span> <a href="#local_f_74"><span class="LIDENT">f</span></a> <a href="#local_v_75"><span class="LIDENT">v</span></a><span class="EOL">
</span>    <span class="WITH">with</span> <span id="local_exn_76"><span class="LIDENT">exn</span></span> <span class="WHEN">when</span> <span class="UIDENT">Exception_filter</span><span class="DOT">.</span><span class="LIDENT">run</span> <a href="#local_exn_76"><span class="LIDENT">exn</span></a> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><span class="LIDENT">async_exception_hook</span> <a href="#local_exn_76"><span class="LIDENT">exn</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Resolution_loop.exception-Canceled"><span class="EXCEPTION">exception</span> <span class="UIDENT">Canceled</span></span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Runs the callbacks (formerly) associated to a promise. Cancel callbacks are
     run first, if the promise was canceled. These are followed by regular
     callbacks.

     The reason for the &quot;formerly&quot; is that the promise's state has already been
     set to [Fulfilled _] or [Rejected _], so the callbacks are no longer
     reachable through the promise reference. This is why the direct [callbacks]
     record must be given to this function. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Resolution_loop.val-run_callbacks"><span class="LIDENT">run_callbacks</span></span><span class="EOL">
</span>      <span class="LPAREN">(</span><span id="local_callbacks_77"><span class="LIDENT">callbacks</span></span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">callbacks</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span id="local_result_78"><span class="LIDENT">result</span></span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">resolved_state</span><span class="RPAREN">)</span> <span class="COLON">:</span> <span class="LIDENT">unit</span> <span class="EQUAL">=</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_run_cancel_callbacks_79"><span class="LIDENT">run_cancel_callbacks</span></span> <span id="local_fs_80"><span class="LIDENT">fs</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LET">let</span> <span class="REC">rec</span> <span id="local_iter_callback_list_81"><span class="LIDENT">iter_callback_list</span></span> <span id="local_fs_82"><span class="LIDENT">fs</span></span> <span id="local_rest_83"><span class="LIDENT">rest</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>        <span class="MATCH">match</span> <a href="#local_fs_82"><span class="LIDENT">fs</span></a> <span class="WITH">with</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Cancel_callback_list_empty</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="#local_iter_list_89"><span class="LIDENT">iter_list</span></a> <a href="#local_rest_83"><span class="LIDENT">rest</span></a><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Cancel_callback_list_callback</span> <span class="LPAREN">(</span><span id="local_storage_84"><span class="LIDENT">storage</span></span><span class="COMMA">,</span> <span id="local_f_85"><span class="LIDENT">f</span></span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LIDENT">current_storage</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="#local_storage_84"><span class="LIDENT">storage</span></a><span class="SEMI">;</span><span class="EOL">
</span>          <span class="LIDENT">handle_with_async_exception_hook</span> <a href="#local_f_85"><span class="LIDENT">f</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>          <a href="#local_iter_list_89"><span class="LIDENT">iter_list</span></a> <a href="#local_rest_83"><span class="LIDENT">rest</span></a><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Cancel_callback_list_remove_sequence_node</span> <span id="local_node_86"><span class="LIDENT">node</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="UIDENT">Lwt_sequence</span><span class="DOT">.</span><span class="LIDENT">remove</span> <a href="#local_node_86"><span class="LIDENT">node</span></a><span class="SEMI">;</span><span class="EOL">
</span>          <a href="#local_iter_list_89"><span class="LIDENT">iter_list</span></a> <a href="#local_rest_83"><span class="LIDENT">rest</span></a><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Cancel_callback_list_concat</span> <span class="LPAREN">(</span><span id="local_fs_87"><span class="LIDENT">fs</span></span><span class="COMMA">,</span> <span id="local_fs'_88"><span class="LIDENT">fs'</span></span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="#local_iter_callback_list_81"><span class="LIDENT">iter_callback_list</span></a> <a href="#local_fs_87"><span class="LIDENT">fs</span></a> <span class="LPAREN">(</span><a href="#local_fs'_88"><span class="LIDENT">fs'</span></a><span class="COLONCOLON">::</span><a href="#local_rest_83"><span class="LIDENT">rest</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="AND">and</span> <span id="local_iter_list_89"><span class="LIDENT">iter_list</span></span> <span id="local_rest_90"><span class="LIDENT">rest</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>        <span class="MATCH">match</span> <a href="#local_rest_90"><span class="LIDENT">rest</span></a> <span class="WITH">with</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="BAR">|</span> <span id="local_fs_91"><span class="LIDENT">fs</span></span><span class="COLONCOLON">::</span><span id="local_rest_92"><span class="LIDENT">rest</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_iter_callback_list_81"><span class="LIDENT">iter_callback_list</span></a> <a href="#local_fs_91"><span class="LIDENT">fs</span></a> <a href="#local_rest_92"><span class="LIDENT">rest</span></a><span class="EOL">
</span><span class="EOL">
</span>      <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>      <a href="#local_iter_callback_list_81"><span class="LIDENT">iter_callback_list</span></a> <a href="#local_fs_80"><span class="LIDENT">fs</span></a> <span class="LBRACKET">[</span><span class="RBRACKET">]</span><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_run_regular_callbacks_93"><span class="LIDENT">run_regular_callbacks</span></span> <span id="local_fs_94"><span class="LIDENT">fs</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LET">let</span> <span class="REC">rec</span> <span id="local_iter_callback_list_95"><span class="LIDENT">iter_callback_list</span></span> <span id="local_fs_96"><span class="LIDENT">fs</span></span> <span id="local_rest_97"><span class="LIDENT">rest</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>        <span class="MATCH">match</span> <a href="#local_fs_96"><span class="LIDENT">fs</span></a> <span class="WITH">with</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Regular_callback_list_empty</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="#local_iter_list_102"><span class="LIDENT">iter_list</span></a> <a href="#local_rest_97"><span class="LIDENT">rest</span></a><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Regular_callback_list_implicitly_removed_callback</span> <span id="local_f_98"><span class="LIDENT">f</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="#local_f_98"><span class="LIDENT">f</span></a> <a href="#local_result_78"><span class="LIDENT">result</span></a><span class="SEMI">;</span><span class="EOL">
</span>          <a href="#local_iter_list_102"><span class="LIDENT">iter_list</span></a> <a href="#local_rest_97"><span class="LIDENT">rest</span></a><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Regular_callback_list_explicitly_removable_callback</span><span class="EOL">
</span>            <span class="LBRACE">{</span><span class="LIDENT">contents</span> <span class="EQUAL">=</span> <span class="UIDENT">None</span><span class="RBRACE">}</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="#local_iter_list_102"><span class="LIDENT">iter_list</span></a> <a href="#local_rest_97"><span class="LIDENT">rest</span></a><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Regular_callback_list_explicitly_removable_callback</span><span class="EOL">
</span>            <span class="LBRACE">{</span><span class="LIDENT">contents</span> <span class="EQUAL">=</span> <span class="UIDENT">Some</span> <span id="local_f_99"><span class="LIDENT">f</span></span><span class="RBRACE">}</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="#local_f_99"><span class="LIDENT">f</span></a> <a href="#local_result_78"><span class="LIDENT">result</span></a><span class="SEMI">;</span><span class="EOL">
</span>          <a href="#local_iter_list_102"><span class="LIDENT">iter_list</span></a> <a href="#local_rest_97"><span class="LIDENT">rest</span></a><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Regular_callback_list_concat</span> <span class="LPAREN">(</span><span id="local_fs_100"><span class="LIDENT">fs</span></span><span class="COMMA">,</span> <span id="local_fs'_101"><span class="LIDENT">fs'</span></span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="#local_iter_callback_list_95"><span class="LIDENT">iter_callback_list</span></a> <a href="#local_fs_100"><span class="LIDENT">fs</span></a> <span class="LPAREN">(</span><a href="#local_fs'_101"><span class="LIDENT">fs'</span></a><span class="COLONCOLON">::</span><a href="#local_rest_97"><span class="LIDENT">rest</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="AND">and</span> <span id="local_iter_list_102"><span class="LIDENT">iter_list</span></span> <span id="local_rest_103"><span class="LIDENT">rest</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>        <span class="MATCH">match</span> <a href="#local_rest_103"><span class="LIDENT">rest</span></a> <span class="WITH">with</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="BAR">|</span> <span id="local_fs_104"><span class="LIDENT">fs</span></span><span class="COLONCOLON">::</span><span id="local_rest_105"><span class="LIDENT">rest</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_iter_callback_list_95"><span class="LIDENT">iter_callback_list</span></a> <a href="#local_fs_104"><span class="LIDENT">fs</span></a> <a href="#local_rest_105"><span class="LIDENT">rest</span></a><span class="EOL">
</span><span class="EOL">
</span>      <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>      <a href="#local_iter_callback_list_95"><span class="LIDENT">iter_callback_list</span></a> <a href="#local_fs_94"><span class="LIDENT">fs</span></a> <span class="LBRACKET">[</span><span class="RBRACKET">]</span><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="COMMENT">(* Pattern matching is much faster than polymorphic comparison. *)</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_is_canceled_106"><span class="LIDENT">is_canceled</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="MATCH">match</span> <a href="#local_result_78"><span class="LIDENT">result</span></a> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UIDENT">Canceled</span> <span class="MINUSGREATER">-&gt;</span> <span class="TRUE">true</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="FALSE">false</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="FALSE">false</span><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_is_canceled_106"><span class="LIDENT">is_canceled</span></a> <span class="THEN">then</span><span class="EOL">
</span>      <a href="#local_run_cancel_callbacks_79"><span class="LIDENT">run_cancel_callbacks</span></a> <a href="#local_callbacks_77"><span class="LIDENT">callbacks</span></a><span class="DOT">.</span><span class="LIDENT">cancel_callbacks</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="#local_run_regular_callbacks_93"><span class="LIDENT">run_regular_callbacks</span></a> <a href="#local_callbacks_77"><span class="LIDENT">callbacks</span></a><span class="DOT">.</span><span class="LIDENT">regular_callbacks</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Resolution_loop.val-default_maximum_callback_nesting_depth"><span class="LIDENT">default_maximum_callback_nesting_depth</span></span> <span class="EQUAL">=</span> <span class="INT">42</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Resolution_loop.val-current_callback_nesting_depth"><span class="LIDENT">current_callback_nesting_depth</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ref"><span class="LIDENT">ref</span></a> <span class="INT">0</span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Resolution_loop.type-deferred_callbacks"><span class="TYPE">type</span> <span class="LIDENT">deferred_callbacks</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span id="module-Resolution_loop.type-deferred_callbacks.constructor-Deferred"><span class="UIDENT">Deferred</span> <span class="COLON">:</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">callbacks</span> <span class="STAR">*</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">resolved_state</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">deferred_callbacks</span></span><span class="EOL">
</span>    <span class="LBRACKETATAT">[@@</span><span class="LIDENT">ocaml</span><span class="DOT">.</span><span class="LIDENT">unboxed</span><span class="RBRACKET">]</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Resolution_loop.val-deferred_callbacks"><span class="LIDENT">deferred_callbacks</span></span> <span class="COLON">:</span> <a href="../../../ocaml-base-compiler/src/stdlib/queue.ml.html#type-t"><span class="LIDENT">deferred_callbacks</span> <span class="UIDENT">Queue</span><span class="DOT">.</span><span class="LIDENT">t</span></a> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/queue.ml.html#val-create"><span class="UIDENT">Queue</span><span class="DOT">.</span><span class="LIDENT">create</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Before entering a resolution loop, it is necessary to take a snapshot of
     the current state of sequence-associated storage. This is because many of
     the callbacks that will be run will modify the storage. The storage is
     restored to the snapshot when the resolution loop is exited. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Resolution_loop.val-enter_resolution_loop"><span class="LIDENT">enter_resolution_loop</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">current_callback_nesting_depth</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><span class="LIDENT">current_callback_nesting_depth</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <span class="INT">1</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_storage_snapshot_107"><span class="LIDENT">storage_snapshot</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><span class="LIDENT">current_storage</span> <span class="IN">in</span><span class="EOL">
</span>    <a href="#local_storage_snapshot_107"><span class="LIDENT">storage_snapshot</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Resolution_loop.val-leave_resolution_loop"><span class="LIDENT">leave_resolution_loop</span></span> <span class="LPAREN">(</span><span id="local_storage_snapshot_108"><span class="LIDENT">storage_snapshot</span></span> <span class="COLON">:</span> <span class="LIDENT">storage</span><span class="RPAREN">)</span> <span class="COLON">:</span> <span class="LIDENT">unit</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><span class="LIDENT">current_callback_nesting_depth</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="INT">1</span> <span class="THEN">then</span> <span class="BEGIN">begin</span><span class="EOL">
</span>      <span class="WHILE">while</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-not"><span class="LIDENT">not</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/queue.ml.html#val-is_empty"><span class="UIDENT">Queue</span><span class="DOT">.</span><span class="LIDENT">is_empty</span></a> <span class="LIDENT">deferred_callbacks</span><span class="RPAREN">)</span> <span class="DO">do</span><span class="EOL">
</span>        <span class="LET">let</span> <span class="UIDENT">Deferred</span> <span class="LPAREN">(</span><span id="local_callbacks_109"><span class="LIDENT">callbacks</span></span><span class="COMMA">,</span> <span id="local_result_110"><span class="LIDENT">result</span></span><span class="RPAREN">)</span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/queue.ml.html#val-pop"><span class="UIDENT">Queue</span><span class="DOT">.</span><span class="LIDENT">pop</span></a> <span class="LIDENT">deferred_callbacks</span> <span class="IN">in</span><span class="EOL">
</span>        <span class="LIDENT">run_callbacks</span> <a href="#local_callbacks_109"><span class="LIDENT">callbacks</span></a> <a href="#local_result_110"><span class="LIDENT">result</span></a><span class="EOL">
</span>      <span class="DONE">done</span><span class="EOL">
</span>    <span class="END">end</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">current_callback_nesting_depth</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><span class="LIDENT">current_callback_nesting_depth</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <span class="INT">1</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">current_storage</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="#local_storage_snapshot_108"><span class="LIDENT">storage_snapshot</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Resolution_loop.val-run_in_resolution_loop"><span class="LIDENT">run_in_resolution_loop</span></span> <span id="local_f_111"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_storage_snapshot_112"><span class="LIDENT">storage_snapshot</span></span> <span class="EQUAL">=</span> <span class="LIDENT">enter_resolution_loop</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_result_113"><span class="LIDENT">result</span></span> <span class="EQUAL">=</span> <a href="#local_f_111"><span class="LIDENT">f</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="LIDENT">leave_resolution_loop</span> <a href="#local_storage_snapshot_112"><span class="LIDENT">storage_snapshot</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <a href="#local_result_113"><span class="LIDENT">result</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* This is basically a hack to fix https://github.com/ocsigen/lwt/issues/48.
     If currently resolving promises, it immediately exits all recursive
     entries of the resolution loop, goes to the top level, runs any deferred
     callbacks, and exits the top-level resolution loop.

     The name should probably be [abaondon_resolution_loop]. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Resolution_loop.val-abandon_wakeups"><span class="LIDENT">abandon_wakeups</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><span class="LIDENT">current_callback_nesting_depth</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;&gt;)"><span class="INFIXOP0">&lt;&gt;</span></a> <span class="INT">0</span> <span class="THEN">then</span><span class="EOL">
</span>      <span class="LIDENT">leave_resolution_loop</span> <span class="UIDENT">Storage_map</span><span class="DOT">.</span><span class="LIDENT">empty</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Resolution_loop.val-run_callbacks_or_defer_them"><span class="LIDENT">run_callbacks_or_defer_them</span></span><span class="EOL">
</span>      <span class="QUESTION">?</span><span class="LPAREN">(</span><span id="local_allow_deferring_114"><span class="LIDENT">allow_deferring</span></span> <span class="EQUAL">=</span> <span class="TRUE">true</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="QUESTION">?</span><span class="LPAREN">(</span><span id="local_maximum_callback_nesting_depth_115"><span class="LIDENT">maximum_callback_nesting_depth</span></span> <span class="EQUAL">=</span> <span class="LIDENT">default_maximum_callback_nesting_depth</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span id="local_callbacks_116"><span class="LIDENT">callbacks</span></span> <span id="local_result_117"><span class="LIDENT">result</span></span> <span class="EQUAL">=</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_should_defer_118"><span class="LIDENT">should_defer</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <a href="#local_allow_deferring_114"><span class="LIDENT">allow_deferring</span></a><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&amp;&amp;)"><span class="AMPERAMPER">&amp;&amp;</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><span class="LIDENT">current_callback_nesting_depth</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;=)"><span class="INFIXOP0">&gt;=</span></a> <a href="#local_maximum_callback_nesting_depth_115"><span class="LIDENT">maximum_callback_nesting_depth</span></a><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_should_defer_118"><span class="LIDENT">should_defer</span></a> <span class="THEN">then</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/queue.ml.html#val-push"><span class="UIDENT">Queue</span><span class="DOT">.</span><span class="LIDENT">push</span></a> <span class="LPAREN">(</span><span class="UIDENT">Deferred</span> <span class="LPAREN">(</span><a href="#local_callbacks_116"><span class="LIDENT">callbacks</span></a><span class="COMMA">,</span> <a href="#local_result_117"><span class="LIDENT">result</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span> <span class="LIDENT">deferred_callbacks</span><span class="EOL">
</span>    <span class="ELSE">else</span><span class="EOL">
</span>      <span class="LIDENT">run_in_resolution_loop</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LIDENT">run_callbacks</span> <a href="#local_callbacks_116"><span class="LIDENT">callbacks</span></a> <a href="#local_result_117"><span class="LIDENT">result</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Resolution_loop.val-resolve"><span class="LIDENT">resolve</span></span> <span class="QUESTION">?</span><span id="local_allow_deferring_119"><span class="LIDENT">allow_deferring</span></span> <span class="QUESTION">?</span><span id="local_maximum_callback_nesting_depth_120"><span class="LIDENT">maximum_callback_nesting_depth</span></span> <span id="local_p_121"><span class="LIDENT">p</span></span> <span id="local_result_122"><span class="LIDENT">result</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="UIDENT">Pending</span> <span id="local_callbacks_123"><span class="LIDENT">callbacks</span></span> <span class="EQUAL">=</span> <a href="#local_p_121"><span class="LIDENT">p</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_p_124"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">set_promise_state</span> <a href="#local_p_121"><span class="LIDENT">p</span></a> <a href="#local_result_122"><span class="LIDENT">result</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LIDENT">run_callbacks_or_defer_them</span><span class="EOL">
</span>      <span class="QUESTION">?</span><a href="#local_allow_deferring_119"><span class="LIDENT">allow_deferring</span></a> <span class="QUESTION">?</span><a href="#local_maximum_callback_nesting_depth_120"><span class="LIDENT">maximum_callback_nesting_depth</span></a> <a href="#local_callbacks_123"><span class="LIDENT">callbacks</span></a> <a href="#local_result_122"><span class="LIDENT">result</span></a><span class="SEMI">;</span><span class="EOL">
</span><span class="EOL">
</span>    <a href="#local_p_124"><span class="LIDENT">p</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Resolution_loop.val-run_callback_or_defer_it"><span class="LIDENT">run_callback_or_defer_it</span></span><span class="EOL">
</span>      <span class="QUESTION">?</span><span class="LPAREN">(</span><span id="local_run_immediately_and_ensure_tail_call_125"><span class="LIDENT">run_immediately_and_ensure_tail_call</span></span> <span class="EQUAL">=</span> <span class="FALSE">false</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="LABEL">~callback:</span><span id="local_f_126"><span class="LIDENT">f</span></span><span class="EOL">
</span>      <span class="TILDE">~</span><span id="local_if_deferred_127"><span class="LIDENT">if_deferred</span></span> <span class="EQUAL">=</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_run_immediately_and_ensure_tail_call_125"><span class="LIDENT">run_immediately_and_ensure_tail_call</span></a> <span class="THEN">then</span><span class="EOL">
</span>      <a href="#local_f_126"><span class="LIDENT">f</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="ELSE">else</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_should_defer_128"><span class="LIDENT">should_defer</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>        <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><span class="LIDENT">current_callback_nesting_depth</span><span class="EOL">
</span>          <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;=)"><span class="INFIXOP0">&gt;=</span></a> <span class="LIDENT">default_maximum_callback_nesting_depth</span><span class="EOL">
</span>      <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="IF">if</span> <a href="#local_should_defer_128"><span class="LIDENT">should_defer</span></a> <span class="THEN">then</span> <span class="BEGIN">begin</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="def_800"><span id="local_immediate_result_129"><span class="LIDENT">immediate_result</span></span><span class="COMMA">,</span> <span id="local_deferred_callback_130"><span class="LIDENT">deferred_callback</span></span><span class="COMMA">,</span> <span id="local_deferred_result_131"><span class="LIDENT">deferred_result</span></span></span> <span class="EQUAL">=</span><span class="EOL">
</span>          <a href="#local_if_deferred_127"><span class="LIDENT">if_deferred</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_deferred_record_132"><span class="LIDENT">deferred_record</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>          <span class="LBRACE">{</span><span class="EOL">
</span>            <span class="LIDENT">regular_callbacks</span> <span class="EQUAL">=</span><span class="EOL">
</span>              <span class="UIDENT">Regular_callback_list_implicitly_removed_callback</span><span class="EOL">
</span>                <a href="#local_deferred_callback_130"><span class="LIDENT">deferred_callback</span></a><span class="SEMI">;</span><span class="EOL">
</span>            <span class="LIDENT">cancel_callbacks</span> <span class="EQUAL">=</span> <span class="UIDENT">Cancel_callback_list_empty</span><span class="SEMI">;</span><span class="EOL">
</span>            <span class="LIDENT">how_to_cancel</span> <span class="EQUAL">=</span> <span class="UIDENT">Not_cancelable</span><span class="SEMI">;</span><span class="EOL">
</span>            <span class="LIDENT">cleanups_deferred</span> <span class="EQUAL">=</span> <span class="INT">0</span><span class="EOL">
</span>          <span class="RBRACE">}</span><span class="EOL">
</span>        <span class="IN">in</span><span class="EOL">
</span>        <a href="../../../ocaml-base-compiler/src/stdlib/queue.ml.html#val-push"><span class="UIDENT">Queue</span><span class="DOT">.</span><span class="LIDENT">push</span></a><span class="EOL">
</span>          <span class="LPAREN">(</span><span class="UIDENT">Deferred</span> <span class="LPAREN">(</span><a href="#local_deferred_record_132"><span class="LIDENT">deferred_record</span></a><span class="COMMA">,</span> <a href="#local_deferred_result_131"><span class="LIDENT">deferred_result</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span> <span class="LIDENT">deferred_callbacks</span><span class="SEMI">;</span><span class="EOL">
</span>        <a href="#local_immediate_result_129"><span class="LIDENT">immediate_result</span></a><span class="EOL">
</span>      <span class="END">end</span><span class="EOL">
</span>      <span class="ELSE">else</span><span class="EOL">
</span>        <span class="LIDENT">run_in_resolution_loop</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="#local_f_126"><span class="LIDENT">f</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="END">end</span></span><span class="EOL">
</span><span class="INCLUDE">include</span> <span class="UIDENT">Resolution_loop</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span id="module-Resolving"><span class="MODULE">module</span> <span class="UIDENT">Resolving</span> <span class="COLON">:</span><span class="EOL">
</span><span class="SIG">sig</span><span class="EOL">
</span>  <span id="module-Resolving.val-wakeup_later_result"><span class="VAL">val</span> <span class="LIDENT">wakeup_later_result</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">u</span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#type-result"><span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="LIDENT">exn</span><span class="RPAREN">)</span> <span class="LIDENT">result</span></a> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span></span><span class="EOL">
</span>  <span id="module-Resolving.val-wakeup_later"><span class="VAL">val</span> <span class="LIDENT">wakeup_later</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">u</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span></span><span class="EOL">
</span>  <span id="module-Resolving.val-wakeup_later_exn"><span class="VAL">val</span> <span class="LIDENT">wakeup_later_exn</span> <span class="COLON">:</span> <span class="UNDERSCORE">_</span> <span class="LIDENT">u</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">exn</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Resolving.val-wakeup_result"><span class="VAL">val</span> <span class="LIDENT">wakeup_result</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">u</span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#type-result"><span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="LIDENT">exn</span><span class="RPAREN">)</span> <span class="LIDENT">result</span></a> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span></span><span class="EOL">
</span>  <span id="module-Resolving.val-wakeup"><span class="VAL">val</span> <span class="LIDENT">wakeup</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">u</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span></span><span class="EOL">
</span>  <span id="module-Resolving.val-wakeup_exn"><span class="VAL">val</span> <span class="LIDENT">wakeup_exn</span> <span class="COLON">:</span> <span class="UNDERSCORE">_</span> <span class="LIDENT">u</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">exn</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Resolving.val-cancel"><span class="VAL">val</span> <span class="LIDENT">cancel</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span></span><span class="EOL">
</span><span class="END">end</span> <span class="EQUAL">=</span><span class="EOL">
</span><span class="STRUCT">struct</span><span class="EOL">
</span>  <span class="COMMENT">(* Note that this function deviates from the &quot;ideal&quot; callback deferral
     behavior: it runs callbacks directly on the current stack. It should
     therefore be possible to cause a stack overflow using this function. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Resolving.val-wakeup_general"><span class="LIDENT">wakeup_general</span></span> <span id="local_api_function_name_133"><span class="LIDENT">api_function_name</span></span> <span id="local_r_134"><span class="LIDENT">r</span></span> <span id="local_result_135"><span class="LIDENT">result</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p_136"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_resolver</span> <a href="#local_r_134"><span class="LIDENT">r</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_p_137"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p_136"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_p_137"><span class="LIDENT">p</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UIDENT">Canceled</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/printf.ml.html#val-ksprintf"><span class="UIDENT">Printf</span><span class="DOT">.</span><span class="LIDENT">ksprintf</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-invalid_arg"><span class="LIDENT">invalid_arg</span></a> <span class="STRING">&quot;Lwt.%s&quot;</span> <a href="#local_api_function_name_133"><span class="LIDENT">api_function_name</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/printf.ml.html#val-ksprintf"><span class="UIDENT">Printf</span><span class="DOT">.</span><span class="LIDENT">ksprintf</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-invalid_arg"><span class="LIDENT">invalid_arg</span></a> <span class="STRING">&quot;Lwt.%s&quot;</span> <a href="#local_api_function_name_133"><span class="LIDENT">api_function_name</span></a><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_result_138"><span class="LIDENT">result</span></span> <span class="EQUAL">=</span> <span class="LIDENT">state_of_result</span> <a href="#local_result_135"><span class="LIDENT">result</span></a> <span class="IN">in</span><span class="EOL">
</span>      <span class="LET">let</span> <span class="UIDENT">State_may_have_changed</span> <span id="local_p_139"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">resolve</span> <span class="LABEL">~allow_deferring:</span><span class="FALSE">false</span> <a href="#local_p_137"><span class="LIDENT">p</span></a> <a href="#local_result_138"><span class="LIDENT">result</span></a> <span class="IN">in</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a> <a href="#local_p_139"><span class="LIDENT">p</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Resolving.val-wakeup_result"><span class="LIDENT">wakeup_result</span></span> <span id="local_r_140"><span class="LIDENT">r</span></span> <span id="local_result_141"><span class="LIDENT">result</span></span> <span class="EQUAL">=</span> <span class="LIDENT">wakeup_general</span> <span class="STRING">&quot;wakeup_result&quot;</span> <a href="#local_r_140"><span class="LIDENT">r</span></a> <a href="#local_result_141"><span class="LIDENT">result</span></a><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Resolving.val-wakeup"><span class="LIDENT">wakeup</span></span> <span id="local_r_142"><span class="LIDENT">r</span></span> <span id="local_v_143"><span class="LIDENT">v</span></span> <span class="EQUAL">=</span> <span class="LIDENT">wakeup_general</span> <span class="STRING">&quot;wakeup&quot;</span> <a href="#local_r_142"><span class="LIDENT">r</span></a> <span class="LPAREN">(</span><span class="UIDENT">Ok</span> <a href="#local_v_143"><span class="LIDENT">v</span></a><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Resolving.val-wakeup_exn"><span class="LIDENT">wakeup_exn</span></span> <span id="local_r_144"><span class="LIDENT">r</span></span> <span id="local_exn_145"><span class="LIDENT">exn</span></span> <span class="EQUAL">=</span> <span class="LIDENT">wakeup_general</span> <span class="STRING">&quot;wakeup_exn&quot;</span> <a href="#local_r_144"><span class="LIDENT">r</span></a> <span class="LPAREN">(</span><span class="UIDENT">Error</span> <a href="#local_exn_145"><span class="LIDENT">exn</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Resolving.val-wakeup_later_general"><span class="LIDENT">wakeup_later_general</span></span> <span id="local_api_function_name_146"><span class="LIDENT">api_function_name</span></span> <span id="local_r_147"><span class="LIDENT">r</span></span> <span id="local_result_148"><span class="LIDENT">result</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p_149"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_resolver</span> <a href="#local_r_147"><span class="LIDENT">r</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_p_150"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p_149"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_p_150"><span class="LIDENT">p</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UIDENT">Canceled</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/printf.ml.html#val-ksprintf"><span class="UIDENT">Printf</span><span class="DOT">.</span><span class="LIDENT">ksprintf</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-invalid_arg"><span class="LIDENT">invalid_arg</span></a> <span class="STRING">&quot;Lwt.%s&quot;</span> <a href="#local_api_function_name_146"><span class="LIDENT">api_function_name</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/printf.ml.html#val-ksprintf"><span class="UIDENT">Printf</span><span class="DOT">.</span><span class="LIDENT">ksprintf</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-invalid_arg"><span class="LIDENT">invalid_arg</span></a> <span class="STRING">&quot;Lwt.%s&quot;</span> <a href="#local_api_function_name_146"><span class="LIDENT">api_function_name</span></a><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_result_151"><span class="LIDENT">result</span></span> <span class="EQUAL">=</span> <span class="LIDENT">state_of_result</span> <a href="#local_result_148"><span class="LIDENT">result</span></a> <span class="IN">in</span><span class="EOL">
</span>      <span class="LET">let</span> <span class="UIDENT">State_may_have_changed</span> <span id="local_p_152"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>        <span class="LIDENT">resolve</span> <span class="LABEL">~maximum_callback_nesting_depth:</span><span class="INT">1</span> <a href="#local_p_150"><span class="LIDENT">p</span></a> <a href="#local_result_151"><span class="LIDENT">result</span></a> <span class="IN">in</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a> <a href="#local_p_152"><span class="LIDENT">p</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Resolving.val-wakeup_later_result"><span class="LIDENT">wakeup_later_result</span></span> <span id="local_r_153"><span class="LIDENT">r</span></span> <span id="local_result_154"><span class="LIDENT">result</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">wakeup_later_general</span> <span class="STRING">&quot;wakeup_later_result&quot;</span> <a href="#local_r_153"><span class="LIDENT">r</span></a> <a href="#local_result_154"><span class="LIDENT">result</span></a><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Resolving.val-wakeup_later"><span class="LIDENT">wakeup_later</span></span> <span id="local_r_155"><span class="LIDENT">r</span></span> <span id="local_v_156"><span class="LIDENT">v</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">wakeup_later_general</span> <span class="STRING">&quot;wakeup_later&quot;</span> <a href="#local_r_155"><span class="LIDENT">r</span></a> <span class="LPAREN">(</span><span class="UIDENT">Ok</span> <a href="#local_v_156"><span class="LIDENT">v</span></a><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Resolving.val-wakeup_later_exn"><span class="LIDENT">wakeup_later_exn</span></span> <span id="local_r_157"><span class="LIDENT">r</span></span> <span id="local_exn_158"><span class="LIDENT">exn</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">wakeup_later_general</span> <span class="STRING">&quot;wakeup_later_exn&quot;</span> <a href="#local_r_157"><span class="LIDENT">r</span></a> <span class="LPAREN">(</span><span class="UIDENT">Error</span> <a href="#local_exn_158"><span class="LIDENT">exn</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Resolving.type-packed_callbacks"><span class="TYPE">type</span> <span class="LIDENT">packed_callbacks</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span id="module-Resolving.type-packed_callbacks.constructor-Packed"><span class="BAR">|</span> <span class="UIDENT">Packed</span> <span class="COLON">:</span> <span class="UNDERSCORE">_</span> <span class="LIDENT">callbacks</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">packed_callbacks</span></span><span class="EOL">
</span>    <span class="LBRACKETATAT">[@@</span><span class="LIDENT">ocaml</span><span class="DOT">.</span><span class="LIDENT">unboxed</span><span class="RBRACKET">]</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Note that this function deviates from the &quot;ideal&quot; callback deferral
     behavior: it runs callbacks directly on the current stack. It should
     therefore be possible to cause a stack overflow using this function. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Resolving.val-cancel"><span class="LIDENT">cancel</span></span> <span id="local_p_159"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_canceled_result_160"><span class="LIDENT">canceled_result</span></span> <span class="EQUAL">=</span> <span class="UIDENT">Rejected</span> <span class="UIDENT">Canceled</span> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="COMMENT">(* Walks the promise dependency graph backwards, looking for cancelable
       initial promises, and cancels (only) them.

       Found initial promises are canceled immediately, as they are found, by
       setting their state to [Rejected Canceled]. This is to prevent them from
       being &quot;found twice&quot; if they are reachable by two or more distinct paths
       through the promise dependency graph.

       The callbacks of these initial promises are then run, in a separate
       phase. These callbacks propagate cancellation forwards to any dependent
       promises. See &quot;Cancellation&quot; in the Overview. *)</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_propagate_cancel_161"><span class="LIDENT">propagate_cancel</span></span> <span class="COLON">:</span> <span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="LIDENT">promise</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">packed_callbacks</span> <span class="LIDENT">list</span> <span class="EQUAL">=</span><span class="EOL">
</span>        <span class="FUN">fun</span> <span id="local_p_162"><span class="LIDENT">p</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span class="REC">rec</span> <span id="local_cancel_and_collect_callbacks_163"><span class="LIDENT">cancel_and_collect_callbacks</span></span> <span class="COLON">:</span><span class="EOL">
</span>          <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="QUOTE">'</span><span class="LIDENT">u</span> <span class="QUOTE">'</span><span class="LIDENT">c</span><span class="DOT">.</span> <span class="LIDENT">packed_callbacks</span> <span class="LIDENT">list</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="QUOTE">'</span><span class="LIDENT">u</span><span class="COMMA">,</span> <span class="QUOTE">'</span><span class="LIDENT">c</span><span class="RPAREN">)</span> <span class="LIDENT">promise</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <span class="LIDENT">packed_callbacks</span> <span class="LIDENT">list</span> <span class="EQUAL">=</span><span class="EOL">
</span>          <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="TYPE">type</span> <span class="LIDENT">c</span><span class="RPAREN">)</span> <span id="local_callbacks_accumulator_164"><span class="LIDENT">callbacks_accumulator</span></span> <span class="LPAREN">(</span><span id="local_p_165"><span class="LIDENT">p</span></span> <span class="COLON">:</span> <span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="LIDENT">c</span><span class="RPAREN">)</span> <span class="LIDENT">promise</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_p_166"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p_165"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>        <span class="MATCH">match</span> <a href="#local_p_166"><span class="LIDENT">p</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>        <span class="COMMENT">(* If the promise is not still pending, it can't be canceled. *)</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="#local_callbacks_accumulator_164"><span class="LIDENT">callbacks_accumulator</span></a><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="#local_callbacks_accumulator_164"><span class="LIDENT">callbacks_accumulator</span></a><span class="EOL">
</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span id="local_callbacks_167"><span class="LIDENT">callbacks</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="MATCH">match</span> <a href="#local_callbacks_167"><span class="LIDENT">callbacks</span></a><span class="DOT">.</span><span class="LIDENT">how_to_cancel</span> <span class="WITH">with</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="UIDENT">Not_cancelable</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <a href="#local_callbacks_accumulator_164"><span class="LIDENT">callbacks_accumulator</span></a><span class="EOL">
</span>          <span class="BAR">|</span> <span class="UIDENT">Cancel_this_promise</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <span class="LET">let</span> <span class="UIDENT">State_may_have_changed</span> <span id="local_p_168"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>              <span class="LIDENT">set_promise_state</span> <a href="#local_p_166"><span class="LIDENT">p</span></a> <a href="#local_canceled_result_160"><span class="LIDENT">canceled_result</span></a> <span class="IN">in</span><span class="EOL">
</span>            <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a> <a href="#local_p_168"><span class="LIDENT">p</span></a><span class="SEMI">;</span><span class="EOL">
</span>            <span class="LPAREN">(</span><span class="UIDENT">Packed</span> <a href="#local_callbacks_167"><span class="LIDENT">callbacks</span></a><span class="RPAREN">)</span><span class="COLONCOLON">::</span><a href="#local_callbacks_accumulator_164"><span class="LIDENT">callbacks_accumulator</span></a><span class="EOL">
</span>          <span class="BAR">|</span> <span class="UIDENT">Propagate_cancel_to_one</span> <span id="local_p'_169"><span class="LIDENT">p'</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <a href="#local_cancel_and_collect_callbacks_163"><span class="LIDENT">cancel_and_collect_callbacks</span></a> <a href="#local_callbacks_accumulator_164"><span class="LIDENT">callbacks_accumulator</span></a> <a href="#local_p'_169"><span class="LIDENT">p'</span></a><span class="EOL">
</span>          <span class="BAR">|</span> <span class="UIDENT">Propagate_cancel_to_several</span> <span id="local_ps_170"><span class="LIDENT">ps</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-fold_left"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">fold_left</span></a> <a href="#local_cancel_and_collect_callbacks_163"><span class="LIDENT">cancel_and_collect_callbacks</span></a> <a href="#local_callbacks_accumulator_164"><span class="LIDENT">callbacks_accumulator</span></a> <a href="#local_ps_170"><span class="LIDENT">ps</span></a><span class="EOL">
</span>      <span class="IN">in</span><span class="EOL">
</span>      <a href="#local_cancel_and_collect_callbacks_163"><span class="LIDENT">cancel_and_collect_callbacks</span></a> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <a href="#local_p_162"><span class="LIDENT">p</span></a><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p_171"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p_159"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_callbacks_172"><span class="LIDENT">callbacks</span></span> <span class="EQUAL">=</span> <a href="#local_propagate_cancel_161"><span class="LIDENT">propagate_cancel</span></a> <a href="#local_p_171"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <a href="#local_callbacks_172"><span class="LIDENT">callbacks</span></a> <span class="INFIXOP0">|&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-iter"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">iter</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="UIDENT">Packed</span> <span id="local_callbacks_173"><span class="LIDENT">callbacks</span></span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">run_callbacks_or_defer_them</span><span class="EOL">
</span>        <span class="LABEL">~allow_deferring:</span><span class="FALSE">false</span> <a href="#local_callbacks_173"><span class="LIDENT">callbacks</span></a> <a href="#local_canceled_result_160"><span class="LIDENT">canceled_result</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="END">end</span></span><span class="EOL">
</span><span class="INCLUDE">include</span> <span class="UIDENT">Resolving</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span id="module-Trivial_promises"><span class="MODULE">module</span> <span class="UIDENT">Trivial_promises</span> <span class="COLON">:</span><span class="EOL">
</span><span class="SIG">sig</span><span class="EOL">
</span>  <span id="module-Trivial_promises.val-return"><span class="VAL">val</span> <span class="LIDENT">return</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span></span><span class="EOL">
</span>  <span id="module-Trivial_promises.val-fail"><span class="VAL">val</span> <span class="LIDENT">fail</span> <span class="COLON">:</span> <span class="LIDENT">exn</span> <span class="MINUSGREATER">-&gt;</span> <span class="UNDERSCORE">_</span> <span class="LIDENT">t</span></span><span class="EOL">
</span>  <span id="module-Trivial_promises.val-of_result"><span class="VAL">val</span> <span class="LIDENT">of_result</span> <span class="COLON">:</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#type-result"><span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="LIDENT">exn</span><span class="RPAREN">)</span> <span class="LIDENT">result</span></a> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Trivial_promises.val-return_unit"><span class="VAL">val</span> <span class="LIDENT">return_unit</span> <span class="COLON">:</span> <span class="LIDENT">unit</span> <span class="LIDENT">t</span></span><span class="EOL">
</span>  <span id="module-Trivial_promises.val-return_true"><span class="VAL">val</span> <span class="LIDENT">return_true</span> <span class="COLON">:</span> <span class="LIDENT">bool</span> <span class="LIDENT">t</span></span><span class="EOL">
</span>  <span id="module-Trivial_promises.val-return_false"><span class="VAL">val</span> <span class="LIDENT">return_false</span> <span class="COLON">:</span> <span class="LIDENT">bool</span> <span class="LIDENT">t</span></span><span class="EOL">
</span>  <span id="module-Trivial_promises.val-return_none"><span class="VAL">val</span> <span class="LIDENT">return_none</span> <span class="COLON">:</span> <span class="UNDERSCORE">_</span> <span class="LIDENT">option</span> <span class="LIDENT">t</span></span><span class="EOL">
</span>  <span id="module-Trivial_promises.val-return_some"><span class="VAL">val</span> <span class="LIDENT">return_some</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">option</span> <span class="LIDENT">t</span></span><span class="EOL">
</span>  <span id="module-Trivial_promises.val-return_ok"><span class="VAL">val</span> <span class="LIDENT">return_ok</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#type-result"><span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="LIDENT">result</span></a> <span class="LIDENT">t</span></span><span class="EOL">
</span>  <span id="module-Trivial_promises.val-return_error"><span class="VAL">val</span> <span class="LIDENT">return_error</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">e</span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#type-result"><span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="QUOTE">'</span><span class="LIDENT">e</span><span class="RPAREN">)</span> <span class="LIDENT">result</span></a> <span class="LIDENT">t</span></span><span class="EOL">
</span>  <span id="module-Trivial_promises.val-return_nil"><span class="VAL">val</span> <span class="LIDENT">return_nil</span> <span class="COLON">:</span> <span class="UNDERSCORE">_</span> <span class="LIDENT">list</span> <span class="LIDENT">t</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Trivial_promises.val-fail_with"><span class="VAL">val</span> <span class="LIDENT">fail_with</span> <span class="COLON">:</span> <span class="LIDENT">string</span> <span class="MINUSGREATER">-&gt;</span> <span class="UNDERSCORE">_</span> <span class="LIDENT">t</span></span><span class="EOL">
</span>  <span id="module-Trivial_promises.val-fail_invalid_arg"><span class="VAL">val</span> <span class="LIDENT">fail_invalid_arg</span> <span class="COLON">:</span> <span class="LIDENT">string</span> <span class="MINUSGREATER">-&gt;</span> <span class="UNDERSCORE">_</span> <span class="LIDENT">t</span></span><span class="EOL">
</span><span class="END">end</span> <span class="EQUAL">=</span><span class="EOL">
</span><span class="STRUCT">struct</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Trivial_promises.val-return"><span class="LIDENT">return</span></span> <span id="local_v_174"><span class="LIDENT">v</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">to_public_promise</span> <span class="LBRACE">{</span><span class="LIDENT">state</span> <span class="EQUAL">=</span> <span class="UIDENT">Fulfilled</span> <a href="#local_v_174"><span class="LIDENT">v</span></a><span class="RBRACE">}</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Trivial_promises.val-of_result"><span class="LIDENT">of_result</span></span> <span id="local_result_175"><span class="LIDENT">result</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">to_public_promise</span> <span class="LBRACE">{</span><span class="LIDENT">state</span> <span class="EQUAL">=</span> <span class="LIDENT">state_of_result</span> <a href="#local_result_175"><span class="LIDENT">result</span></a><span class="RBRACE">}</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Trivial_promises.val-fail"><span class="LIDENT">fail</span></span> <span id="local_exn_176"><span class="LIDENT">exn</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">to_public_promise</span> <span class="LBRACE">{</span><span class="LIDENT">state</span> <span class="EQUAL">=</span> <span class="UIDENT">Rejected</span> <a href="#local_exn_176"><span class="LIDENT">exn</span></a><span class="RBRACE">}</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Trivial_promises.val-return_unit"><span class="LIDENT">return_unit</span></span> <span class="EQUAL">=</span> <span class="LIDENT">return</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Trivial_promises.val-return_none"><span class="LIDENT">return_none</span></span> <span class="EQUAL">=</span> <span class="LIDENT">return</span> <span class="UIDENT">None</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Trivial_promises.val-return_some"><span class="LIDENT">return_some</span></span> <span id="local_x_177"><span class="LIDENT">x</span></span> <span class="EQUAL">=</span> <span class="LIDENT">return</span> <span class="LPAREN">(</span><span class="UIDENT">Some</span> <a href="#local_x_177"><span class="LIDENT">x</span></a><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Trivial_promises.val-return_nil"><span class="LIDENT">return_nil</span></span> <span class="EQUAL">=</span> <span class="LIDENT">return</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Trivial_promises.val-return_true"><span class="LIDENT">return_true</span></span> <span class="EQUAL">=</span> <span class="LIDENT">return</span> <span class="TRUE">true</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Trivial_promises.val-return_false"><span class="LIDENT">return_false</span></span> <span class="EQUAL">=</span> <span class="LIDENT">return</span> <span class="FALSE">false</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Trivial_promises.val-return_ok"><span class="LIDENT">return_ok</span></span> <span id="local_x_178"><span class="LIDENT">x</span></span> <span class="EQUAL">=</span> <span class="LIDENT">return</span> <span class="LPAREN">(</span><span class="UIDENT">Ok</span> <a href="#local_x_178"><span class="LIDENT">x</span></a><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Trivial_promises.val-return_error"><span class="LIDENT">return_error</span></span> <span id="local_x_179"><span class="LIDENT">x</span></span> <span class="EQUAL">=</span> <span class="LIDENT">return</span> <span class="LPAREN">(</span><span class="UIDENT">Error</span> <a href="#local_x_179"><span class="LIDENT">x</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Trivial_promises.val-fail_with"><span class="LIDENT">fail_with</span></span> <span id="local_msg_180"><span class="LIDENT">msg</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">to_public_promise</span> <span class="LBRACE">{</span><span class="LIDENT">state</span> <span class="EQUAL">=</span> <span class="UIDENT">Rejected</span> <span class="LPAREN">(</span><span class="UIDENT">Failure</span> <a href="#local_msg_180"><span class="LIDENT">msg</span></a><span class="RPAREN">)</span><span class="RBRACE">}</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Trivial_promises.val-fail_invalid_arg"><span class="LIDENT">fail_invalid_arg</span></span> <span id="local_msg_181"><span class="LIDENT">msg</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">to_public_promise</span> <span class="LBRACE">{</span><span class="LIDENT">state</span> <span class="EQUAL">=</span> <span class="UIDENT">Rejected</span> <span class="LPAREN">(</span><span class="UIDENT">Invalid_argument</span> <a href="#local_msg_181"><span class="LIDENT">msg</span></a><span class="RPAREN">)</span><span class="RBRACE">}</span><span class="EOL">
</span><span class="END">end</span></span><span class="EOL">
</span><span class="INCLUDE">include</span> <span class="UIDENT">Trivial_promises</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span id="module-Pending_promises"><span class="MODULE">module</span> <span class="UIDENT">Pending_promises</span> <span class="COLON">:</span><span class="EOL">
</span><span class="SIG">sig</span><span class="EOL">
</span>  <span class="COMMENT">(* Internal *)</span><span class="EOL">
</span>  <span id="module-Pending_promises.val-new_pending"><span class="VAL">val</span> <span class="LIDENT">new_pending</span> <span class="COLON">:</span><span class="EOL">
</span>    <span class="LIDENT">how_to_cancel</span><span class="COLON">:</span><span class="LIDENT">how_to_cancel</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="LIDENT">underlying</span><span class="COMMA">,</span> <span class="LIDENT">pending</span><span class="RPAREN">)</span> <span class="LIDENT">promise</span></span><span class="EOL">
</span>  <span id="module-Pending_promises.val-propagate_cancel_to_several"><span class="VAL">val</span> <span class="LIDENT">propagate_cancel_to_several</span> <span class="COLON">:</span> <span class="UNDERSCORE">_</span> <span class="LIDENT">t</span> <span class="LIDENT">list</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">how_to_cancel</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Initial pending promises (public) *)</span><span class="EOL">
</span>  <span id="module-Pending_promises.val-wait"><span class="VAL">val</span> <span class="LIDENT">wait</span> <span class="COLON">:</span> <span class="LIDENT">unit</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="STAR">*</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">u</span></span><span class="EOL">
</span>  <span id="module-Pending_promises.val-task"><span class="VAL">val</span> <span class="LIDENT">task</span> <span class="COLON">:</span> <span class="LIDENT">unit</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="STAR">*</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">u</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Pending_promises.val-add_task_r"><span class="VAL">val</span> <span class="LIDENT">add_task_r</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">u</span> <span class="UIDENT">Lwt_sequence</span><span class="DOT">.</span><span class="LIDENT">t</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span></span><span class="EOL">
</span>  <span id="module-Pending_promises.val-add_task_l"><span class="VAL">val</span> <span class="LIDENT">add_task_l</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">u</span> <span class="UIDENT">Lwt_sequence</span><span class="DOT">.</span><span class="LIDENT">t</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Pending_promises.val-protected"><span class="VAL">val</span> <span class="LIDENT">protected</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span></span><span class="EOL">
</span>  <span id="module-Pending_promises.val-no_cancel"><span class="VAL">val</span> <span class="LIDENT">no_cancel</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span></span><span class="EOL">
</span><span class="END">end</span> <span class="EQUAL">=</span><span class="EOL">
</span><span class="STRUCT">struct</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Pending_promises.val-new_pending"><span class="LIDENT">new_pending</span></span> <span class="TILDE">~</span><span id="local_how_to_cancel_182"><span class="LIDENT">how_to_cancel</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_state_183"><span class="LIDENT">state</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="UIDENT">Pending</span> <span class="LBRACE">{</span><span class="EOL">
</span>        <span class="LIDENT">regular_callbacks</span> <span class="EQUAL">=</span> <span class="UIDENT">Regular_callback_list_empty</span><span class="SEMI">;</span><span class="EOL">
</span>        <span class="LIDENT">cancel_callbacks</span> <span class="EQUAL">=</span> <span class="UIDENT">Cancel_callback_list_empty</span><span class="SEMI">;</span><span class="EOL">
</span>        <a href="#local_how_to_cancel_182"><span class="LIDENT">how_to_cancel</span></a><span class="SEMI">;</span><span class="EOL">
</span>        <span class="LIDENT">cleanups_deferred</span> <span class="EQUAL">=</span> <span class="INT">0</span><span class="SEMI">;</span><span class="EOL">
</span>      <span class="RBRACE">}</span><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span>    <span class="LBRACE">{</span><a href="#local_state_183"><span class="LIDENT">state</span></a><span class="RBRACE">}</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Pending_promises.val-propagate_cancel_to_several"><span class="LIDENT">propagate_cancel_to_several</span></span> <span id="local_ps_184"><span class="LIDENT">ps</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="COMMENT">(* Using a dirty cast here to avoid rebuilding the list :( Not bothering
       with the invariants, because [Propagate_cancel_to_several] packs them,
       and code that matches on [Propagate_cancel_to_several] doesn't care about
       them anyway. *)</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_cast_promise_list_185"><span class="LIDENT">cast_promise_list</span></span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="LIDENT">list</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="LIDENT">promise</span> <span class="LIDENT">list</span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/obj.ml.html#val-magic"><span class="UIDENT">Obj</span><span class="DOT">.</span><span class="LIDENT">magic</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="UIDENT">Propagate_cancel_to_several</span> <span class="LPAREN">(</span><a href="#local_cast_promise_list_185"><span class="LIDENT">cast_promise_list</span></a> <a href="#local_ps_184"><span class="LIDENT">ps</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Pending_promises.val-wait"><span class="LIDENT">wait</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_p_186"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">new_pending</span> <span class="LABEL">~how_to_cancel:</span><span class="UIDENT">Not_cancelable</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="LIDENT">to_public_promise</span> <a href="#local_p_186"><span class="LIDENT">p</span></a><span class="COMMA">,</span> <span class="LIDENT">to_public_resolver</span> <a href="#local_p_186"><span class="LIDENT">p</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Pending_promises.val-task"><span class="LIDENT">task</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_p_187"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">new_pending</span> <span class="LABEL">~how_to_cancel:</span><span class="UIDENT">Cancel_this_promise</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="LIDENT">to_public_promise</span> <a href="#local_p_187"><span class="LIDENT">p</span></a><span class="COMMA">,</span> <span class="LIDENT">to_public_resolver</span> <a href="#local_p_187"><span class="LIDENT">p</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Pending_promises.val-cast_sequence_node"><span class="LIDENT">cast_sequence_node</span></span><span class="EOL">
</span>      <span class="LPAREN">(</span><span id="local_node_188"><span class="LIDENT">node</span></span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">u</span> <span class="UIDENT">Lwt_sequence</span><span class="DOT">.</span><span class="LIDENT">node</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span id="local__actual_content_189"><span class="LIDENT">_actual_content</span></span><span class="COLON">:</span><span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="QUOTE">'</span><span class="LIDENT">u</span><span class="COMMA">,</span> <span class="QUOTE">'</span><span class="LIDENT">c</span><span class="RPAREN">)</span> <span class="LIDENT">promise</span><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="COLON">:</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="QUOTE">'</span><span class="LIDENT">u</span><span class="COMMA">,</span> <span class="QUOTE">'</span><span class="LIDENT">c</span><span class="RPAREN">)</span> <span class="LIDENT">promise</span> <span class="UIDENT">Lwt_sequence</span><span class="DOT">.</span><span class="LIDENT">node</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/obj.ml.html#val-magic"><span class="UIDENT">Obj</span><span class="DOT">.</span><span class="LIDENT">magic</span></a> <a href="#local_node_188"><span class="LIDENT">node</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Pending_promises.val-add_task_r"><span class="LIDENT">add_task_r</span></span> <span id="local_sequence_190"><span class="LIDENT">sequence</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_p_191"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">new_pending</span> <span class="LABEL">~how_to_cancel:</span><span class="UIDENT">Cancel_this_promise</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_node_192"><span class="LIDENT">node</span></span> <span class="EQUAL">=</span> <span class="UIDENT">Lwt_sequence</span><span class="DOT">.</span><span class="LIDENT">add_r</span> <span class="LPAREN">(</span><span class="LIDENT">to_public_resolver</span> <a href="#local_p_191"><span class="LIDENT">p</span></a><span class="RPAREN">)</span> <a href="#local_sequence_190"><span class="LIDENT">sequence</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_node_193"><span class="LIDENT">node</span></span> <span class="EQUAL">=</span> <span class="LIDENT">cast_sequence_node</span> <a href="#local_node_192"><span class="LIDENT">node</span></a> <a href="#local_p_191"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="UIDENT">Pending</span> <span id="local_callbacks_194"><span class="LIDENT">callbacks</span></span> <span class="EQUAL">=</span> <a href="#local_p_191"><span class="LIDENT">p</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="IN">in</span><span class="EOL">
</span>    <a href="#local_callbacks_194"><span class="LIDENT">callbacks</span></a><span class="DOT">.</span><span class="LIDENT">cancel_callbacks</span> <span class="LESSMINUS">&lt;-</span><span class="EOL">
</span>      <span class="UIDENT">Cancel_callback_list_remove_sequence_node</span> <a href="#local_node_193"><span class="LIDENT">node</span></a><span class="SEMI">;</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LIDENT">to_public_promise</span> <a href="#local_p_191"><span class="LIDENT">p</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Pending_promises.val-add_task_l"><span class="LIDENT">add_task_l</span></span> <span id="local_sequence_195"><span class="LIDENT">sequence</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_p_196"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">new_pending</span> <span class="LABEL">~how_to_cancel:</span><span class="UIDENT">Cancel_this_promise</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_node_197"><span class="LIDENT">node</span></span> <span class="EQUAL">=</span> <span class="UIDENT">Lwt_sequence</span><span class="DOT">.</span><span class="LIDENT">add_l</span> <span class="LPAREN">(</span><span class="LIDENT">to_public_resolver</span> <a href="#local_p_196"><span class="LIDENT">p</span></a><span class="RPAREN">)</span> <a href="#local_sequence_195"><span class="LIDENT">sequence</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_node_198"><span class="LIDENT">node</span></span> <span class="EQUAL">=</span> <span class="LIDENT">cast_sequence_node</span> <a href="#local_node_197"><span class="LIDENT">node</span></a> <a href="#local_p_196"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="UIDENT">Pending</span> <span id="local_callbacks_199"><span class="LIDENT">callbacks</span></span> <span class="EQUAL">=</span> <a href="#local_p_196"><span class="LIDENT">p</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="IN">in</span><span class="EOL">
</span>    <a href="#local_callbacks_199"><span class="LIDENT">callbacks</span></a><span class="DOT">.</span><span class="LIDENT">cancel_callbacks</span> <span class="LESSMINUS">&lt;-</span><span class="EOL">
</span>      <span class="UIDENT">Cancel_callback_list_remove_sequence_node</span> <a href="#local_node_198"><span class="LIDENT">node</span></a><span class="SEMI">;</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LIDENT">to_public_promise</span> <a href="#local_p_196"><span class="LIDENT">p</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Pending_promises.val-protected"><span class="LIDENT">protected</span></span> <span id="local_p_200"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p_internal_201"><span class="LIDENT">p_internal</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p_200"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="MATCH">match</span> <span class="LPAREN">(</span><span class="LIDENT">underlying</span> <a href="#local_p_internal_201"><span class="LIDENT">p_internal</span></a><span class="RPAREN">)</span><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_p_200"><span class="LIDENT">p</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_p_200"><span class="LIDENT">p</span></a><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_p'_202"><span class="LIDENT">p'</span></span> <span class="EQUAL">=</span> <span class="LIDENT">new_pending</span> <span class="LABEL">~how_to_cancel:</span><span class="UIDENT">Cancel_this_promise</span> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_callback_203"><span class="LIDENT">callback</span></span> <span id="local_p_result_204"><span class="LIDENT">p_result</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>        <span class="LET">let</span> <span class="UIDENT">State_may_now_be_pending_proxy</span> <span id="local_p'_205"><span class="LIDENT">p'</span></span> <span class="EQUAL">=</span> <span class="LIDENT">may_now_be_proxy</span> <a href="#local_p'_202"><span class="LIDENT">p'</span></a> <span class="IN">in</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_p'_206"><span class="LIDENT">p'</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p'_205"><span class="LIDENT">p'</span></a> <span class="IN">in</span><span class="EOL">
</span>        <span class="COMMENT">(* In this callback, [p'] will either still itself be pending, or it
           will have become a proxy for a pending promise. The reasoning for
           this is almost the same as in the comment at [may_now_be_proxy]. The
           differences are:

           - [p'] *is* an initial promise, so it *can* get canceled. However, if
             it does, the [on_cancel] handler installed below will remove this
             callback.
           - [p'] never gets passed to [make_into_proxy], the only effect of
             which is that it cannot be the underlying promise of another
             (proxy) promise. So, [p'] can only appear at the head of a chain of
             [Proxy _] links, and it's not necessary to worry about whether the
             inductive reasoning at [may_now_be_proxy] applies. *)</span><span class="EOL">
</span><span class="EOL">
</span>        <span class="LET">let</span> <span class="UIDENT">State_may_have_changed</span> <span id="local_p'_207"><span class="LIDENT">p'</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>          <span class="LIDENT">resolve</span> <span class="LABEL">~allow_deferring:</span><span class="FALSE">false</span> <a href="#local_p'_206"><span class="LIDENT">p'</span></a> <a href="#local_p_result_204"><span class="LIDENT">p_result</span></a> <span class="IN">in</span><span class="EOL">
</span>        <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a> <a href="#local_p'_207"><span class="LIDENT">p'</span></a><span class="EOL">
</span>      <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_remove_the_callback_208"><span class="LIDENT">remove_the_callback</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>        <span class="LIDENT">add_explicitly_removable_callback_and_give_remove_function</span><span class="EOL">
</span>          <span class="LBRACKET">[</span><a href="#local_p_200"><span class="LIDENT">p</span></a><span class="RBRACKET">]</span> <a href="#local_callback_203"><span class="LIDENT">callback</span></a><span class="EOL">
</span>      <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="LET">let</span> <span class="UIDENT">Pending</span> <span id="local_p'_callbacks_209"><span class="LIDENT">p'_callbacks</span></span> <span class="EQUAL">=</span> <a href="#local_p'_202"><span class="LIDENT">p'</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="IN">in</span><span class="EOL">
</span>      <span class="LIDENT">add_cancel_callback</span> <a href="#local_p'_callbacks_209"><span class="LIDENT">p'_callbacks</span></a> <a href="#local_remove_the_callback_208"><span class="LIDENT">remove_the_callback</span></a><span class="SEMI">;</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="LIDENT">to_public_promise</span> <a href="#local_p'_202"><span class="LIDENT">p'</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Pending_promises.val-no_cancel"><span class="LIDENT">no_cancel</span></span> <span id="local_p_210"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p_internal_211"><span class="LIDENT">p_internal</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p_210"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="MATCH">match</span> <span class="LPAREN">(</span><span class="LIDENT">underlying</span> <a href="#local_p_internal_211"><span class="LIDENT">p_internal</span></a><span class="RPAREN">)</span><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_p_210"><span class="LIDENT">p</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_p_210"><span class="LIDENT">p</span></a><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span id="local_p_callbacks_212"><span class="LIDENT">p_callbacks</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_p'_213"><span class="LIDENT">p'</span></span> <span class="EQUAL">=</span> <span class="LIDENT">new_pending</span> <span class="LABEL">~how_to_cancel:</span><span class="UIDENT">Not_cancelable</span> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_callback_214"><span class="LIDENT">callback</span></span> <span id="local_p_result_215"><span class="LIDENT">p_result</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>        <span class="LET">let</span> <span class="UIDENT">State_may_now_be_pending_proxy</span> <span id="local_p'_216"><span class="LIDENT">p'</span></span> <span class="EQUAL">=</span> <span class="LIDENT">may_now_be_proxy</span> <a href="#local_p'_213"><span class="LIDENT">p'</span></a> <span class="IN">in</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_p'_217"><span class="LIDENT">p'</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p'_216"><span class="LIDENT">p'</span></a> <span class="IN">in</span><span class="EOL">
</span>        <span class="COMMENT">(* In this callback, [p'] will either still itself be pending, or it
           will have become a proxy for a pending promise. The reasoning for
           this is as in [protected] and [may_now_be_proxy], but even simpler,
           because [p'] is not cancelable. *)</span><span class="EOL">
</span><span class="EOL">
</span>        <span class="LET">let</span> <span class="UIDENT">State_may_have_changed</span> <span id="local_p'_218"><span class="LIDENT">p'</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>          <span class="LIDENT">resolve</span> <span class="LABEL">~allow_deferring:</span><span class="FALSE">false</span> <a href="#local_p'_217"><span class="LIDENT">p'</span></a> <a href="#local_p_result_215"><span class="LIDENT">p_result</span></a> <span class="IN">in</span><span class="EOL">
</span>        <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a> <a href="#local_p'_218"><span class="LIDENT">p'</span></a><span class="EOL">
</span>      <span class="IN">in</span><span class="EOL">
</span>      <span class="LIDENT">add_implicitly_removed_callback</span> <a href="#local_p_callbacks_212"><span class="LIDENT">p_callbacks</span></a> <a href="#local_callback_214"><span class="LIDENT">callback</span></a><span class="SEMI">;</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="LIDENT">to_public_promise</span> <a href="#local_p'_213"><span class="LIDENT">p'</span></a><span class="EOL">
</span><span class="END">end</span></span><span class="EOL">
</span><span class="INCLUDE">include</span> <span class="UIDENT">Pending_promises</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span id="module-Sequential_composition"><span class="MODULE">module</span> <span class="UIDENT">Sequential_composition</span> <span class="COLON">:</span><span class="EOL">
</span><span class="SIG">sig</span><span class="EOL">
</span>  <span class="COMMENT">(* Main interface (public) *)</span><span class="EOL">
</span>  <span id="module-Sequential_composition.val-bind"><span class="VAL">val</span> <span class="LIDENT">bind</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">b</span> <span class="LIDENT">t</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">b</span> <span class="LIDENT">t</span></span><span class="EOL">
</span>  <span id="module-Sequential_composition.val-map"><span class="VAL">val</span> <span class="LIDENT">map</span> <span class="COLON">:</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">b</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">b</span> <span class="LIDENT">t</span></span><span class="EOL">
</span>  <span id="module-Sequential_composition.val-reraise"><span class="EXTERNAL">external</span> <span class="LIDENT">reraise</span> <span class="COLON">:</span> <span class="LIDENT">exn</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="EQUAL">=</span> <span class="STRING">&quot;%reraise&quot;</span></span><span class="EOL">
</span>  <span id="module-Sequential_composition.val-catch"><span class="VAL">val</span> <span class="LIDENT">catch</span> <span class="COLON">:</span> <span class="LPAREN">(</span><span class="LIDENT">unit</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="LIDENT">exn</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span></span><span class="EOL">
</span>  <span id="module-Sequential_composition.val-finalize"><span class="VAL">val</span> <span class="LIDENT">finalize</span> <span class="COLON">:</span> <span class="LPAREN">(</span><span class="LIDENT">unit</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="LIDENT">unit</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span> <span class="LIDENT">t</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span></span><span class="EOL">
</span>  <span id="module-Sequential_composition.val-try_bind"><span class="VAL">val</span> <span class="LIDENT">try_bind</span> <span class="COLON">:</span> <span class="LPAREN">(</span><span class="LIDENT">unit</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">b</span> <span class="LIDENT">t</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="LIDENT">exn</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">b</span> <span class="LIDENT">t</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">b</span> <span class="LIDENT">t</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Cancel callbacks (public). *)</span><span class="EOL">
</span>  <span id="module-Sequential_composition.val-on_cancel"><span class="VAL">val</span> <span class="LIDENT">on_cancel</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="LIDENT">unit</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Non-promise callbacks (public) *)</span><span class="EOL">
</span>  <span id="module-Sequential_composition.val-on_success"><span class="VAL">val</span> <span class="LIDENT">on_success</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span></span><span class="EOL">
</span>  <span id="module-Sequential_composition.val-on_failure"><span class="VAL">val</span> <span class="LIDENT">on_failure</span> <span class="COLON">:</span> <span class="UNDERSCORE">_</span> <span class="LIDENT">t</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="LIDENT">exn</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span></span><span class="EOL">
</span>  <span id="module-Sequential_composition.val-on_termination"><span class="VAL">val</span> <span class="LIDENT">on_termination</span> <span class="COLON">:</span> <span class="UNDERSCORE">_</span> <span class="LIDENT">t</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="LIDENT">unit</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span></span><span class="EOL">
</span>  <span id="module-Sequential_composition.val-on_any"><span class="VAL">val</span> <span class="LIDENT">on_any</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="LIDENT">exn</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Backtrace support (internal; for use by the PPX) *)</span><span class="EOL">
</span>  <span id="module-Sequential_composition.val-backtrace_bind"><span class="VAL">val</span> <span class="LIDENT">backtrace_bind</span> <span class="COLON">:</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="LIDENT">exn</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">exn</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">b</span> <span class="LIDENT">t</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">b</span> <span class="LIDENT">t</span></span><span class="EOL">
</span>  <span id="module-Sequential_composition.val-backtrace_catch"><span class="VAL">val</span> <span class="LIDENT">backtrace_catch</span> <span class="COLON">:</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="LIDENT">exn</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">exn</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="LIDENT">unit</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="LIDENT">exn</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span></span><span class="EOL">
</span>  <span id="module-Sequential_composition.val-backtrace_finalize"><span class="VAL">val</span> <span class="LIDENT">backtrace_finalize</span> <span class="COLON">:</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="LIDENT">exn</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">exn</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="LIDENT">unit</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="LIDENT">unit</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span> <span class="LIDENT">t</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span></span><span class="EOL">
</span>  <span id="module-Sequential_composition.val-backtrace_try_bind"><span class="VAL">val</span> <span class="LIDENT">backtrace_try_bind</span> <span class="COLON">:</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="LIDENT">exn</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">exn</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="LIDENT">unit</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">b</span> <span class="LIDENT">t</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="LIDENT">exn</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">b</span> <span class="LIDENT">t</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">b</span> <span class="LIDENT">t</span></span><span class="EOL">
</span><span class="END">end</span> <span class="EQUAL">=</span><span class="EOL">
</span><span class="STRUCT">struct</span><span class="EOL">
</span>  <span class="COMMENT">(* There are five primary sequential composition functions: [bind], [map],
     [catch], [finalize], and [try_bind]. Of these, [try_bind] is the most
     general -- all the others can be implemented in terms of it.

     Lwt conflates concurrency with error propagation. If Lwt did not do this,
     there would be only two primary functions: [bind] and [map], and, of these
     two, [bind] is the most general. Since [bind] is the most relevant
     specifically to concurrency, and is also the most familiar function in Lwt,
     its implementation serves as a kind of &quot;model&quot; for the rest. It is the most
     commented, and all the other functions follow a similar pattern to [bind].

     Four of the primary functions have [backtrace_*] versions, which are not
     truly public, and exist to support the PPX. [backtrace_map] does not exist
     because the PPX does not need it.

     The remaining four functions in this section attach &quot;lower-level-ish&quot;
     non-promise-producing callbacks to promises: these are the [on_*]
     functions. Of these, [on_any] is the most general. If Lwt did not conflate
     concurrency with error handling, there would only be one: [on_success]. *)</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Makes [~user_provided_promise] into a proxy of [~outer_promise]. After
     [make_into_proxy], these two promise references &quot;behave identically.&quot;

     Note that this is not symmetric: [user_provided_promise] always becomes the
     proxy. [make_into_proxy] is called only by [bind] and similar functions in
     this module. This means that:

     - the only way for a promise to become a proxy is by being returned from
       the callback given by the user to [bind], or a similar function, and
     - the only way for a promise to become underlying for a promise other than
       itself is to be the outer promise originally returned to the user from
       [bind], or a similar function.

     These two facts are important for reasoning about how and which promises
     can become proxies, underlying, etc.; in particular, it is used in the
     argument in [may_now_be_proxy] for correct predictions about state changes.

     [~outer_promise] is always a pending promise when [make_into_proxy] is
     called; for the explanation, see [may_now_be_proxy] (though the caller of
     [make_into_proxy] always calls [underlying] first to pass the underlying
     pending promise to [make_into_proxy]).

     The reasons proxying is used, instead of adding a callback to
     [~user_provided_promise] to resolve [~outer_promise] when the former
     becomes resolved probably are:

     - Promises have more behaviors than resolution. One would have to add a
       cancellation handler to [~outer_promise] to propagate the cancellation
       back to [~user_provided_promise], for example. It may be easier to just
       think of them as the same promise.
     - If using callbacks, resolving [~user_provided_promise] would not
       immediately resolve [~outer_promise]. Another callback added to
       [~user_provided_promise] might see [~user_provided_promise] resolved,
       but [~outer_promise] still pending, depending on the order in which
       callbacks are run. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Sequential_composition.val-make_into_proxy"><span class="LIDENT">make_into_proxy</span></span><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="TYPE">type</span> <span class="LIDENT">c</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="TILDE">~</span><span class="LPAREN">(</span><span id="local_outer_promise_219"><span class="LIDENT">outer_promise</span></span> <span class="COLON">:</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="LIDENT">underlying</span><span class="COMMA">,</span> <span class="LIDENT">pending</span><span class="RPAREN">)</span> <span class="LIDENT">promise</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="TILDE">~</span><span class="LPAREN">(</span><span id="local_user_provided_promise_220"><span class="LIDENT">user_provided_promise</span></span> <span class="COLON">:</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="LIDENT">c</span><span class="RPAREN">)</span> <span class="LIDENT">promise</span><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="COLON">:</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="LIDENT">underlying</span><span class="COMMA">,</span> <span class="LIDENT">c</span><span class="RPAREN">)</span> <span class="LIDENT">state_changed</span> <span class="EQUAL">=</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="COMMENT">(* Using [p'] as it's the name used inside [bind], etc., for promises with
       this role -- [p'] is the promise returned by the user's function. *)</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_p'_221"><span class="LIDENT">p'</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_user_provided_promise_220"><span class="LIDENT">user_provided_promise</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="IF">if</span> <span class="LIDENT">identical</span> <a href="#local_p'_221"><span class="LIDENT">p'</span></a> <a href="#local_outer_promise_219"><span class="LIDENT">outer_promise</span></a> <span class="THEN">then</span><span class="EOL">
</span>      <span class="UIDENT">State_may_have_changed</span> <a href="#local_p'_221"><span class="LIDENT">p'</span></a><span class="EOL">
</span>      <span class="COMMENT">(* We really want to return [State_may_have_changed outer_promise], but
         the reference through [p'] has the right type. *)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="ELSE">else</span><span class="EOL">
</span>      <span class="MATCH">match</span> <a href="#local_p'_221"><span class="LIDENT">p'</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LIDENT">resolve</span> <span class="LABEL">~allow_deferring:</span><span class="FALSE">false</span> <a href="#local_outer_promise_219"><span class="LIDENT">outer_promise</span></a> <a href="#local_p'_221"><span class="LIDENT">p'</span></a><span class="DOT">.</span><span class="LIDENT">state</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LIDENT">resolve</span> <span class="LABEL">~allow_deferring:</span><span class="FALSE">false</span> <a href="#local_outer_promise_219"><span class="LIDENT">outer_promise</span></a> <a href="#local_p'_221"><span class="LIDENT">p'</span></a><span class="DOT">.</span><span class="LIDENT">state</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span id="local_p'_callbacks_222"><span class="LIDENT">p'_callbacks</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LET">let</span> <span class="UIDENT">Pending</span> <span id="local_outer_callbacks_223"><span class="LIDENT">outer_callbacks</span></span> <span class="EQUAL">=</span> <a href="#local_outer_promise_219"><span class="LIDENT">outer_promise</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>        <span class="LIDENT">merge_callbacks</span> <span class="LABEL">~from:</span><a href="#local_p'_callbacks_222"><span class="LIDENT">p'_callbacks</span></a> <span class="LABEL">~into:</span><a href="#local_outer_callbacks_223"><span class="LIDENT">outer_callbacks</span></a><span class="SEMI">;</span><span class="EOL">
</span>        <a href="#local_outer_callbacks_223"><span class="LIDENT">outer_callbacks</span></a><span class="DOT">.</span><span class="LIDENT">how_to_cancel</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_p'_callbacks_222"><span class="LIDENT">p'_callbacks</span></a><span class="DOT">.</span><span class="LIDENT">how_to_cancel</span><span class="SEMI">;</span><span class="EOL">
</span><span class="EOL">
</span>        <span class="LET">let</span> <span class="UIDENT">State_may_have_changed</span> <span id="local_p'_224"><span class="LIDENT">p'</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>          <span class="LIDENT">set_promise_state</span> <a href="#local_p'_221"><span class="LIDENT">p'</span></a> <span class="LPAREN">(</span><span class="UIDENT">Proxy</span> <a href="#local_outer_promise_219"><span class="LIDENT">outer_promise</span></a><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>        <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a> <a href="#local_p'_224"><span class="LIDENT">p'</span></a><span class="SEMI">;</span><span class="EOL">
</span><span class="EOL">
</span>        <span class="UIDENT">State_may_have_changed</span> <a href="#local_outer_promise_219"><span class="LIDENT">outer_promise</span></a><span class="EOL">
</span>        <span class="COMMENT">(* The state hasn't actually changed, but we still have to wrap
           [outer_promise] for type checking. *)</span><span class="EOL">
</span><span class="EOL">
</span>        <span class="COMMENT">(* The state of [p'] may instead have changed -- it may have become a
           proxy. However, callers of [make_into_proxy] don't know if
           [user_provided_promise] was a proxy or not (that's why we call
           underlying on it at the top of this function, to get [p']). We can
           therefore take a dangerous shortcut and not bother returning a new
           reference to [user_provided_promise] for shadowing. *)</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Maintainer's note: a lot of the code below can probably be deduplicated in
     some way, especially if assuming Flambda. *)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Sequential_composition.val-bind"><span class="LIDENT">bind</span></span> <span id="local_p_225"><span class="LIDENT">p</span></span> <span id="local_f_226"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p_227"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p_225"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_p_228"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p_227"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="COMMENT">(* In case [Lwt.bind] needs to defer the call to [f], this function will be
       called to create:

       1. The promise, [p''], that must be returned to the caller immediately.
       2. The callback that resolves [p''].

       [Lwt.bind] defers the call to [f] in two circumstances:

       1. The promise [p] is pending.
       2. The promise [p] is fulfilled, but the current callback call nesting
          depth is such that the call to [f] must go into the callback queue, in
          order to avoid stack overflow.

      Mechanism (2) is currently disabled. It may be used in an alternative Lwt
      API.

      Functions other than [Lwt.bind] have analogous deferral behavior. *)</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_create_result_promise_and_callback_if_deferred_229"><span class="LIDENT">create_result_promise_and_callback_if_deferred</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_p''_230"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span> <span class="LIDENT">new_pending</span> <span class="LABEL">~how_to_cancel:</span><span class="LPAREN">(</span><span class="UIDENT">Propagate_cancel_to_one</span> <a href="#local_p_228"><span class="LIDENT">p</span></a><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>      <span class="COMMENT">(* The result promise is a fresh pending promise.

         Initially, trying to cancel this fresh pending promise [p''] will
         propagate the cancellation attempt to [p] (backwards through the
         promise dependency graph). If/when [p] is fulfilled, Lwt will call the
         user's callback [f] below, which will provide a new promise [p'], and
         [p'] will become a proxy of [p'']. At that point, trying to cancel
         [p''] will be equivalent to trying to cancel [p'], so the behavior will
         depend on how the user obtained [p']. *)</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_saved_storage_231"><span class="LIDENT">saved_storage</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><span class="LIDENT">current_storage</span> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_callback_232"><span class="LIDENT">callback</span></span> <span id="local_p_result_233"><span class="LIDENT">p_result</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>        <span class="MATCH">match</span> <a href="#local_p_result_233"><span class="LIDENT">p_result</span></a> <span class="WITH">with</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span id="local_v_234"><span class="LIDENT">v</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LIDENT">current_storage</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="#local_saved_storage_231"><span class="LIDENT">saved_storage</span></a><span class="SEMI">;</span><span class="EOL">
</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_p'_235"><span class="LIDENT">p'</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <span class="TRY">try</span> <a href="#local_f_226"><span class="LIDENT">f</span></a> <a href="#local_v_234"><span class="LIDENT">v</span></a> <span class="WITH">with</span> <span id="local_exn_236"><span class="LIDENT">exn</span></span><span class="EOL">
</span>            <span class="WHEN">when</span> <span class="UIDENT">Exception_filter</span><span class="DOT">.</span><span class="LIDENT">run</span> <a href="#local_exn_236"><span class="LIDENT">exn</span></a> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">fail</span> <a href="#local_exn_236"><span class="LIDENT">exn</span></a><span class="EOL">
</span>          <span class="IN">in</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p'_237"><span class="LIDENT">p'</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p'_235"><span class="LIDENT">p'</span></a> <span class="IN">in</span><span class="EOL">
</span>          <span class="COMMENT">(* Run the user's function [f]. *)</span><span class="EOL">
</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">State_may_now_be_pending_proxy</span> <span id="local_p''_238"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span> <span class="LIDENT">may_now_be_proxy</span> <a href="#local_p''_230"><span class="LIDENT">p''</span></a> <span class="IN">in</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_p''_239"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p''_238"><span class="LIDENT">p''</span></a> <span class="IN">in</span><span class="EOL">
</span>          <span class="COMMENT">(* [p''] was an underlying promise when it was created above, but it
             may have become a proxy by the time this code is being executed.
             However, it is still either an underlying pending promise, or a
             proxy for a pending promise. Therefore, [may_now_be_proxy] produces
             a reference with the right type variables. We immediately get
             [p'']'s current underlying promise. *)</span><span class="EOL">
</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">State_may_have_changed</span> <span id="local_p''_240"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <span class="LIDENT">make_into_proxy</span> <span class="LABEL">~outer_promise:</span><a href="#local_p''_239"><span class="LIDENT">p''</span></a> <span class="LABEL">~user_provided_promise:</span><a href="#local_p'_237"><span class="LIDENT">p'</span></a> <span class="IN">in</span><span class="EOL">
</span>          <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a> <a href="#local_p''_240"><span class="LIDENT">p''</span></a><span class="EOL">
</span>          <span class="COMMENT">(* Make the outer promise [p''] behaviorally identical to the promise
             [p'] returned by [f] by making [p'] into a proxy of [p'']. *)</span><span class="EOL">
</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UNDERSCORE">_</span> <span class="AS">as</span> <span id="local_p_result_241"><span class="LIDENT">p_result</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">State_may_now_be_pending_proxy</span> <span id="local_p''_242"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span> <span class="LIDENT">may_now_be_proxy</span> <a href="#local_p''_230"><span class="LIDENT">p''</span></a> <span class="IN">in</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_p''_243"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p''_242"><span class="LIDENT">p''</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">State_may_have_changed</span> <span id="local_p''_244"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <span class="LIDENT">resolve</span> <span class="LABEL">~allow_deferring:</span><span class="FALSE">false</span> <a href="#local_p''_243"><span class="LIDENT">p''</span></a> <a href="#local_p_result_241"><span class="LIDENT">p_result</span></a> <span class="IN">in</span><span class="EOL">
</span>          <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a> <a href="#local_p''_244"><span class="LIDENT">p''</span></a><span class="EOL">
</span>      <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="LIDENT">to_public_promise</span> <a href="#local_p''_230"><span class="LIDENT">p''</span></a><span class="COMMA">,</span> <a href="#local_callback_232"><span class="LIDENT">callback</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_p_228"><span class="LIDENT">p</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span id="local_v_245"><span class="LIDENT">v</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">run_callback_or_defer_it</span><span class="EOL">
</span>        <span class="LABEL">~run_immediately_and_ensure_tail_call:</span><span class="TRUE">true</span><span class="EOL">
</span>        <span class="LABEL">~callback:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_f_226"><span class="LIDENT">f</span></a> <a href="#local_v_245"><span class="LIDENT">v</span></a><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="LABEL">~if_deferred:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="def_798"><span class="LPAREN">(</span><span id="local_p''_246"><span class="LIDENT">p''</span></span><span class="COMMA">,</span> <span id="local_callback_247"><span class="LIDENT">callback</span></span><span class="RPAREN">)</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <a href="#local_create_result_promise_and_callback_if_deferred_229"><span class="LIDENT">create_result_promise_and_callback_if_deferred</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>          <span class="LPAREN">(</span><a href="#local_p''_246"><span class="LIDENT">p''</span></a><span class="COMMA">,</span> <a href="#local_callback_247"><span class="LIDENT">callback</span></a><span class="COMMA">,</span> <a href="#local_p_228"><span class="LIDENT">p</span></a><span class="DOT">.</span><span class="LIDENT">state</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UNDERSCORE">_</span> <span class="AS">as</span> <span id="local_result_248"><span class="LIDENT">result</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">to_public_promise</span> <span class="LBRACE">{</span><span class="LIDENT">state</span> <span class="EQUAL">=</span> <a href="#local_result_248"><span class="LIDENT">result</span></a><span class="RBRACE">}</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span id="local_p_callbacks_249"><span class="LIDENT">p_callbacks</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="def_786"><span class="LPAREN">(</span><span id="local_p''_250"><span class="LIDENT">p''</span></span><span class="COMMA">,</span> <span id="local_callback_251"><span class="LIDENT">callback</span></span><span class="RPAREN">)</span></span> <span class="EQUAL">=</span> <a href="#local_create_result_promise_and_callback_if_deferred_229"><span class="LIDENT">create_result_promise_and_callback_if_deferred</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>      <span class="LIDENT">add_implicitly_removed_callback</span> <a href="#local_p_callbacks_249"><span class="LIDENT">p_callbacks</span></a> <a href="#local_callback_251"><span class="LIDENT">callback</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <a href="#local_p''_250"><span class="LIDENT">p''</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Sequential_composition.val-backtrace_bind"><span class="LIDENT">backtrace_bind</span></span> <span id="local_add_loc_252"><span class="LIDENT">add_loc</span></span> <span id="local_p_253"><span class="LIDENT">p</span></span> <span id="local_f_254"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p_255"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p_253"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_p_256"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p_255"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_create_result_promise_and_callback_if_deferred_257"><span class="LIDENT">create_result_promise_and_callback_if_deferred</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_p''_258"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span> <span class="LIDENT">new_pending</span> <span class="LABEL">~how_to_cancel:</span><span class="LPAREN">(</span><span class="UIDENT">Propagate_cancel_to_one</span> <a href="#local_p_256"><span class="LIDENT">p</span></a><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_saved_storage_259"><span class="LIDENT">saved_storage</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><span class="LIDENT">current_storage</span> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_callback_260"><span class="LIDENT">callback</span></span> <span id="local_p_result_261"><span class="LIDENT">p_result</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>        <span class="MATCH">match</span> <a href="#local_p_result_261"><span class="LIDENT">p_result</span></a> <span class="WITH">with</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span id="local_v_262"><span class="LIDENT">v</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LIDENT">current_storage</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="#local_saved_storage_259"><span class="LIDENT">saved_storage</span></a><span class="SEMI">;</span><span class="EOL">
</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_p'_263"><span class="LIDENT">p'</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <span class="TRY">try</span> <a href="#local_f_254"><span class="LIDENT">f</span></a> <a href="#local_v_262"><span class="LIDENT">v</span></a><span class="EOL">
</span>            <span class="WITH">with</span> <span id="local_exn_264"><span class="LIDENT">exn</span></span> <span class="WHEN">when</span> <span class="UIDENT">Exception_filter</span><span class="DOT">.</span><span class="LIDENT">run</span> <a href="#local_exn_264"><span class="LIDENT">exn</span></a> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>              <span class="LIDENT">fail</span> <span class="LPAREN">(</span><a href="#local_add_loc_252"><span class="LIDENT">add_loc</span></a> <a href="#local_exn_264"><span class="LIDENT">exn</span></a><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p'_265"><span class="LIDENT">p'</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p'_263"><span class="LIDENT">p'</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">State_may_now_be_pending_proxy</span> <span id="local_p''_266"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span> <span class="LIDENT">may_now_be_proxy</span> <a href="#local_p''_258"><span class="LIDENT">p''</span></a> <span class="IN">in</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_p''_267"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p''_266"><span class="LIDENT">p''</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">State_may_have_changed</span> <span id="local_p''_268"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <span class="LIDENT">make_into_proxy</span> <span class="LABEL">~outer_promise:</span><a href="#local_p''_267"><span class="LIDENT">p''</span></a> <span class="LABEL">~user_provided_promise:</span><a href="#local_p'_265"><span class="LIDENT">p'</span></a> <span class="IN">in</span><span class="EOL">
</span>          <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a> <a href="#local_p''_268"><span class="LIDENT">p''</span></a><span class="EOL">
</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span id="local_exn_269"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">State_may_now_be_pending_proxy</span> <span id="local_p''_270"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span> <span class="LIDENT">may_now_be_proxy</span> <a href="#local_p''_258"><span class="LIDENT">p''</span></a> <span class="IN">in</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_p''_271"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p''_270"><span class="LIDENT">p''</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">State_may_have_changed</span> <span id="local_p''_272"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <span class="LIDENT">resolve</span> <span class="LABEL">~allow_deferring:</span><span class="FALSE">false</span> <a href="#local_p''_271"><span class="LIDENT">p''</span></a> <span class="LPAREN">(</span><span class="UIDENT">Rejected</span> <span class="LPAREN">(</span><a href="#local_add_loc_252"><span class="LIDENT">add_loc</span></a> <a href="#local_exn_269"><span class="LIDENT">exn</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>          <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a> <a href="#local_p''_272"><span class="LIDENT">p''</span></a><span class="EOL">
</span>      <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="LIDENT">to_public_promise</span> <a href="#local_p''_258"><span class="LIDENT">p''</span></a><span class="COMMA">,</span> <a href="#local_callback_260"><span class="LIDENT">callback</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_p_256"><span class="LIDENT">p</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span id="local_v_273"><span class="LIDENT">v</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">run_callback_or_defer_it</span><span class="EOL">
</span>        <span class="LABEL">~run_immediately_and_ensure_tail_call:</span><span class="TRUE">true</span><span class="EOL">
</span>        <span class="LABEL">~callback:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_f_254"><span class="LIDENT">f</span></a> <a href="#local_v_273"><span class="LIDENT">v</span></a><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="LABEL">~if_deferred:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="def_806"><span class="LPAREN">(</span><span id="local_p''_274"><span class="LIDENT">p''</span></span><span class="COMMA">,</span> <span id="local_callback_275"><span class="LIDENT">callback</span></span><span class="RPAREN">)</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <a href="#local_create_result_promise_and_callback_if_deferred_257"><span class="LIDENT">create_result_promise_and_callback_if_deferred</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>          <span class="LPAREN">(</span><a href="#local_p''_274"><span class="LIDENT">p''</span></a><span class="COMMA">,</span> <a href="#local_callback_275"><span class="LIDENT">callback</span></a><span class="COMMA">,</span> <a href="#local_p_256"><span class="LIDENT">p</span></a><span class="DOT">.</span><span class="LIDENT">state</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span id="local_exn_276"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">to_public_promise</span> <span class="LBRACE">{</span><span class="LIDENT">state</span> <span class="EQUAL">=</span> <span class="UIDENT">Rejected</span> <span class="LPAREN">(</span><a href="#local_add_loc_252"><span class="LIDENT">add_loc</span></a> <a href="#local_exn_276"><span class="LIDENT">exn</span></a><span class="RPAREN">)</span><span class="RBRACE">}</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span id="local_p_callbacks_277"><span class="LIDENT">p_callbacks</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="def_787"><span class="LPAREN">(</span><span id="local_p''_278"><span class="LIDENT">p''</span></span><span class="COMMA">,</span> <span id="local_callback_279"><span class="LIDENT">callback</span></span><span class="RPAREN">)</span></span> <span class="EQUAL">=</span> <a href="#local_create_result_promise_and_callback_if_deferred_257"><span class="LIDENT">create_result_promise_and_callback_if_deferred</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>      <span class="LIDENT">add_implicitly_removed_callback</span> <a href="#local_p_callbacks_277"><span class="LIDENT">p_callbacks</span></a> <a href="#local_callback_279"><span class="LIDENT">callback</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <a href="#local_p''_278"><span class="LIDENT">p''</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Sequential_composition.val-map"><span class="LIDENT">map</span></span> <span id="local_f_280"><span class="LIDENT">f</span></span> <span id="local_p_281"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p_282"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p_281"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_p_283"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p_282"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_create_result_promise_and_callback_if_deferred_284"><span class="LIDENT">create_result_promise_and_callback_if_deferred</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_p''_285"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span> <span class="LIDENT">new_pending</span> <span class="LABEL">~how_to_cancel:</span><span class="LPAREN">(</span><span class="UIDENT">Propagate_cancel_to_one</span> <a href="#local_p_283"><span class="LIDENT">p</span></a><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_saved_storage_286"><span class="LIDENT">saved_storage</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><span class="LIDENT">current_storage</span> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_callback_287"><span class="LIDENT">callback</span></span> <span id="local_p_result_288"><span class="LIDENT">p_result</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>        <span class="MATCH">match</span> <a href="#local_p_result_288"><span class="LIDENT">p_result</span></a> <span class="WITH">with</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span id="local_v_289"><span class="LIDENT">v</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LIDENT">current_storage</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="#local_saved_storage_286"><span class="LIDENT">saved_storage</span></a><span class="SEMI">;</span><span class="EOL">
</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_p''_result_290"><span class="LIDENT">p''_result</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <span class="TRY">try</span> <span class="UIDENT">Fulfilled</span> <span class="LPAREN">(</span><a href="#local_f_280"><span class="LIDENT">f</span></a> <a href="#local_v_289"><span class="LIDENT">v</span></a><span class="RPAREN">)</span> <span class="WITH">with</span> <span id="local_exn_291"><span class="LIDENT">exn</span></span><span class="EOL">
</span>            <span class="WHEN">when</span> <span class="UIDENT">Exception_filter</span><span class="DOT">.</span><span class="LIDENT">run</span> <a href="#local_exn_291"><span class="LIDENT">exn</span></a> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Rejected</span> <a href="#local_exn_291"><span class="LIDENT">exn</span></a><span class="EOL">
</span>          <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">State_may_now_be_pending_proxy</span> <span id="local_p''_292"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span> <span class="LIDENT">may_now_be_proxy</span> <a href="#local_p''_285"><span class="LIDENT">p''</span></a> <span class="IN">in</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_p''_293"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p''_292"><span class="LIDENT">p''</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">State_may_have_changed</span> <span id="local_p''_294"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <span class="LIDENT">resolve</span> <span class="LABEL">~allow_deferring:</span><span class="FALSE">false</span> <a href="#local_p''_293"><span class="LIDENT">p''</span></a> <a href="#local_p''_result_290"><span class="LIDENT">p''_result</span></a> <span class="IN">in</span><span class="EOL">
</span>          <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a> <a href="#local_p''_294"><span class="LIDENT">p''</span></a><span class="EOL">
</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UNDERSCORE">_</span> <span class="AS">as</span> <span id="local_p_result_295"><span class="LIDENT">p_result</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">State_may_now_be_pending_proxy</span> <span id="local_p''_296"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span> <span class="LIDENT">may_now_be_proxy</span> <a href="#local_p''_285"><span class="LIDENT">p''</span></a> <span class="IN">in</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_p''_297"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p''_296"><span class="LIDENT">p''</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">State_may_have_changed</span> <span id="local_p''_298"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <span class="LIDENT">resolve</span> <span class="LABEL">~allow_deferring:</span><span class="FALSE">false</span> <a href="#local_p''_297"><span class="LIDENT">p''</span></a> <a href="#local_p_result_295"><span class="LIDENT">p_result</span></a> <span class="IN">in</span><span class="EOL">
</span>          <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a> <a href="#local_p''_298"><span class="LIDENT">p''</span></a><span class="EOL">
</span>      <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="LIDENT">to_public_promise</span> <a href="#local_p''_285"><span class="LIDENT">p''</span></a><span class="COMMA">,</span> <a href="#local_callback_287"><span class="LIDENT">callback</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_p_283"><span class="LIDENT">p</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span id="local_v_299"><span class="LIDENT">v</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">run_callback_or_defer_it</span><span class="EOL">
</span>        <span class="LABEL">~run_immediately_and_ensure_tail_call:</span><span class="TRUE">true</span><span class="EOL">
</span>        <span class="LABEL">~callback:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LIDENT">to_public_promise</span><span class="EOL">
</span>            <span class="LBRACE">{</span><span class="LIDENT">state</span> <span class="EQUAL">=</span><span class="EOL">
</span>              <span class="TRY">try</span> <span class="UIDENT">Fulfilled</span> <span class="LPAREN">(</span><a href="#local_f_280"><span class="LIDENT">f</span></a> <a href="#local_v_299"><span class="LIDENT">v</span></a><span class="RPAREN">)</span><span class="EOL">
</span>              <span class="WITH">with</span> <span id="local_exn_300"><span class="LIDENT">exn</span></span> <span class="WHEN">when</span> <span class="UIDENT">Exception_filter</span><span class="DOT">.</span><span class="LIDENT">run</span> <a href="#local_exn_300"><span class="LIDENT">exn</span></a> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Rejected</span> <a href="#local_exn_300"><span class="LIDENT">exn</span></a><span class="RBRACE">}</span><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="LABEL">~if_deferred:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="def_796"><span class="LPAREN">(</span><span id="local_p''_301"><span class="LIDENT">p''</span></span><span class="COMMA">,</span> <span id="local_callback_302"><span class="LIDENT">callback</span></span><span class="RPAREN">)</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <a href="#local_create_result_promise_and_callback_if_deferred_284"><span class="LIDENT">create_result_promise_and_callback_if_deferred</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>          <span class="LPAREN">(</span><a href="#local_p''_301"><span class="LIDENT">p''</span></a><span class="COMMA">,</span> <a href="#local_callback_302"><span class="LIDENT">callback</span></a><span class="COMMA">,</span> <a href="#local_p_283"><span class="LIDENT">p</span></a><span class="DOT">.</span><span class="LIDENT">state</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UNDERSCORE">_</span> <span class="AS">as</span> <span id="local_result_303"><span class="LIDENT">result</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">to_public_promise</span> <span class="LBRACE">{</span><span class="LIDENT">state</span> <span class="EQUAL">=</span> <a href="#local_result_303"><span class="LIDENT">result</span></a><span class="RBRACE">}</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span id="local_p_callbacks_304"><span class="LIDENT">p_callbacks</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="def_793"><span class="LPAREN">(</span><span id="local_p''_305"><span class="LIDENT">p''</span></span><span class="COMMA">,</span> <span id="local_callback_306"><span class="LIDENT">callback</span></span><span class="RPAREN">)</span></span> <span class="EQUAL">=</span> <a href="#local_create_result_promise_and_callback_if_deferred_284"><span class="LIDENT">create_result_promise_and_callback_if_deferred</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>      <span class="LIDENT">add_implicitly_removed_callback</span> <a href="#local_p_callbacks_304"><span class="LIDENT">p_callbacks</span></a> <a href="#local_callback_306"><span class="LIDENT">callback</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <a href="#local_p''_305"><span class="LIDENT">p''</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Sequential_composition.val-reraise"><span class="EXTERNAL">external</span> <span class="LIDENT">reraise</span> <span class="COLON">:</span> <span class="LIDENT">exn</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="EQUAL">=</span> <span class="STRING">&quot;%reraise&quot;</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Sequential_composition.val-catch"><span class="LIDENT">catch</span></span> <span id="local_f_307"><span class="LIDENT">f</span></span> <span id="local_h_308"><span class="LIDENT">h</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_p_309"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="TRY">try</span> <a href="#local_f_307"><span class="LIDENT">f</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="WITH">with</span> <span id="local_exn_310"><span class="LIDENT">exn</span></span> <span class="WHEN">when</span> <span class="UIDENT">Exception_filter</span><span class="DOT">.</span><span class="LIDENT">run</span> <a href="#local_exn_310"><span class="LIDENT">exn</span></a> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">fail</span> <a href="#local_exn_310"><span class="LIDENT">exn</span></a><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p_311"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p_309"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_p_312"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p_311"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_create_result_promise_and_callback_if_deferred_313"><span class="LIDENT">create_result_promise_and_callback_if_deferred</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_p''_314"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span> <span class="LIDENT">new_pending</span> <span class="LABEL">~how_to_cancel:</span><span class="LPAREN">(</span><span class="UIDENT">Propagate_cancel_to_one</span> <a href="#local_p_312"><span class="LIDENT">p</span></a><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_saved_storage_315"><span class="LIDENT">saved_storage</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><span class="LIDENT">current_storage</span> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_callback_316"><span class="LIDENT">callback</span></span> <span id="local_p_result_317"><span class="LIDENT">p_result</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>        <span class="MATCH">match</span> <a href="#local_p_result_317"><span class="LIDENT">p_result</span></a> <span class="WITH">with</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span class="UNDERSCORE">_</span> <span class="AS">as</span> <span id="local_p_result_318"><span class="LIDENT">p_result</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">State_may_now_be_pending_proxy</span> <span id="local_p''_319"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span> <span class="LIDENT">may_now_be_proxy</span> <a href="#local_p''_314"><span class="LIDENT">p''</span></a> <span class="IN">in</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_p''_320"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p''_319"><span class="LIDENT">p''</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">State_may_have_changed</span> <span id="local_p''_321"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <span class="LIDENT">resolve</span> <span class="LABEL">~allow_deferring:</span><span class="FALSE">false</span> <a href="#local_p''_320"><span class="LIDENT">p''</span></a> <a href="#local_p_result_318"><span class="LIDENT">p_result</span></a> <span class="IN">in</span><span class="EOL">
</span>          <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a> <a href="#local_p''_321"><span class="LIDENT">p''</span></a><span class="EOL">
</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span id="local_exn_322"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LIDENT">current_storage</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="#local_saved_storage_315"><span class="LIDENT">saved_storage</span></a><span class="SEMI">;</span><span class="EOL">
</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_p'_323"><span class="LIDENT">p'</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <span class="TRY">try</span> <a href="#local_h_308"><span class="LIDENT">h</span></a> <a href="#local_exn_322"><span class="LIDENT">exn</span></a><span class="EOL">
</span>            <span class="WITH">with</span> <span id="local_exn_324"><span class="LIDENT">exn</span></span> <span class="WHEN">when</span> <span class="UIDENT">Exception_filter</span><span class="DOT">.</span><span class="LIDENT">run</span> <a href="#local_exn_324"><span class="LIDENT">exn</span></a> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">fail</span> <a href="#local_exn_324"><span class="LIDENT">exn</span></a><span class="EOL">
</span>          <span class="IN">in</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p'_325"><span class="LIDENT">p'</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p'_323"><span class="LIDENT">p'</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">State_may_now_be_pending_proxy</span> <span id="local_p''_326"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span> <span class="LIDENT">may_now_be_proxy</span> <a href="#local_p''_314"><span class="LIDENT">p''</span></a> <span class="IN">in</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_p''_327"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p''_326"><span class="LIDENT">p''</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">State_may_have_changed</span> <span id="local_p''_328"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <span class="LIDENT">make_into_proxy</span> <span class="LABEL">~outer_promise:</span><a href="#local_p''_327"><span class="LIDENT">p''</span></a> <span class="LABEL">~user_provided_promise:</span><a href="#local_p'_325"><span class="LIDENT">p'</span></a> <span class="IN">in</span><span class="EOL">
</span>          <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a> <a href="#local_p''_328"><span class="LIDENT">p''</span></a><span class="EOL">
</span>      <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="LIDENT">to_public_promise</span> <a href="#local_p''_314"><span class="LIDENT">p''</span></a><span class="COMMA">,</span> <a href="#local_callback_316"><span class="LIDENT">callback</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_p_312"><span class="LIDENT">p</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">to_public_promise</span> <a href="#local_p_312"><span class="LIDENT">p</span></a><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span id="local_exn_329"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">run_callback_or_defer_it</span><span class="EOL">
</span>        <span class="LABEL">~run_immediately_and_ensure_tail_call:</span><span class="TRUE">true</span><span class="EOL">
</span>        <span class="LABEL">~callback:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_h_308"><span class="LIDENT">h</span></a> <a href="#local_exn_329"><span class="LIDENT">exn</span></a><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="LABEL">~if_deferred:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="def_782"><span class="LPAREN">(</span><span id="local_p''_330"><span class="LIDENT">p''</span></span><span class="COMMA">,</span> <span id="local_callback_331"><span class="LIDENT">callback</span></span><span class="RPAREN">)</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <a href="#local_create_result_promise_and_callback_if_deferred_313"><span class="LIDENT">create_result_promise_and_callback_if_deferred</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>          <span class="LPAREN">(</span><a href="#local_p''_330"><span class="LIDENT">p''</span></a><span class="COMMA">,</span> <a href="#local_callback_331"><span class="LIDENT">callback</span></a><span class="COMMA">,</span> <a href="#local_p_312"><span class="LIDENT">p</span></a><span class="DOT">.</span><span class="LIDENT">state</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span id="local_p_callbacks_332"><span class="LIDENT">p_callbacks</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="def_795"><span class="LPAREN">(</span><span id="local_p''_333"><span class="LIDENT">p''</span></span><span class="COMMA">,</span> <span id="local_callback_334"><span class="LIDENT">callback</span></span><span class="RPAREN">)</span></span> <span class="EQUAL">=</span> <a href="#local_create_result_promise_and_callback_if_deferred_313"><span class="LIDENT">create_result_promise_and_callback_if_deferred</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>      <span class="LIDENT">add_implicitly_removed_callback</span> <a href="#local_p_callbacks_332"><span class="LIDENT">p_callbacks</span></a> <a href="#local_callback_334"><span class="LIDENT">callback</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <a href="#local_p''_333"><span class="LIDENT">p''</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Sequential_composition.val-backtrace_catch"><span class="LIDENT">backtrace_catch</span></span> <span id="local_add_loc_335"><span class="LIDENT">add_loc</span></span> <span id="local_f_336"><span class="LIDENT">f</span></span> <span id="local_h_337"><span class="LIDENT">h</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_p_338"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="TRY">try</span> <a href="#local_f_336"><span class="LIDENT">f</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="WITH">with</span> <span id="local_exn_339"><span class="LIDENT">exn</span></span> <span class="WHEN">when</span> <span class="UIDENT">Exception_filter</span><span class="DOT">.</span><span class="LIDENT">run</span> <a href="#local_exn_339"><span class="LIDENT">exn</span></a> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">fail</span> <a href="#local_exn_339"><span class="LIDENT">exn</span></a><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p_340"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p_338"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_p_341"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p_340"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_create_result_promise_and_callback_if_deferred_342"><span class="LIDENT">create_result_promise_and_callback_if_deferred</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_p''_343"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span> <span class="LIDENT">new_pending</span> <span class="LABEL">~how_to_cancel:</span><span class="LPAREN">(</span><span class="UIDENT">Propagate_cancel_to_one</span> <a href="#local_p_341"><span class="LIDENT">p</span></a><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_saved_storage_344"><span class="LIDENT">saved_storage</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><span class="LIDENT">current_storage</span> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_callback_345"><span class="LIDENT">callback</span></span> <span id="local_p_result_346"><span class="LIDENT">p_result</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>        <span class="MATCH">match</span> <a href="#local_p_result_346"><span class="LIDENT">p_result</span></a> <span class="WITH">with</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span class="UNDERSCORE">_</span> <span class="AS">as</span> <span id="local_p_result_347"><span class="LIDENT">p_result</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">State_may_now_be_pending_proxy</span> <span id="local_p''_348"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span> <span class="LIDENT">may_now_be_proxy</span> <a href="#local_p''_343"><span class="LIDENT">p''</span></a> <span class="IN">in</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_p''_349"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p''_348"><span class="LIDENT">p''</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">State_may_have_changed</span> <span id="local_p''_350"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <span class="LIDENT">resolve</span> <span class="LABEL">~allow_deferring:</span><span class="FALSE">false</span> <a href="#local_p''_349"><span class="LIDENT">p''</span></a> <a href="#local_p_result_347"><span class="LIDENT">p_result</span></a> <span class="IN">in</span><span class="EOL">
</span>          <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a> <a href="#local_p''_350"><span class="LIDENT">p''</span></a><span class="EOL">
</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span id="local_exn_351"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LIDENT">current_storage</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="#local_saved_storage_344"><span class="LIDENT">saved_storage</span></a><span class="SEMI">;</span><span class="EOL">
</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_p'_352"><span class="LIDENT">p'</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <span class="TRY">try</span> <a href="#local_h_337"><span class="LIDENT">h</span></a> <a href="#local_exn_351"><span class="LIDENT">exn</span></a><span class="EOL">
</span>            <span class="WITH">with</span> <span id="local_exn_353"><span class="LIDENT">exn</span></span> <span class="WHEN">when</span> <span class="UIDENT">Exception_filter</span><span class="DOT">.</span><span class="LIDENT">run</span> <a href="#local_exn_353"><span class="LIDENT">exn</span></a> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>              <span class="LIDENT">fail</span> <span class="LPAREN">(</span><a href="#local_add_loc_335"><span class="LIDENT">add_loc</span></a> <a href="#local_exn_353"><span class="LIDENT">exn</span></a><span class="RPAREN">)</span><span class="EOL">
</span>          <span class="IN">in</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p'_354"><span class="LIDENT">p'</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p'_352"><span class="LIDENT">p'</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">State_may_now_be_pending_proxy</span> <span id="local_p''_355"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span> <span class="LIDENT">may_now_be_proxy</span> <a href="#local_p''_343"><span class="LIDENT">p''</span></a> <span class="IN">in</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_p''_356"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p''_355"><span class="LIDENT">p''</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">State_may_have_changed</span> <span id="local_p''_357"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <span class="LIDENT">make_into_proxy</span> <span class="LABEL">~outer_promise:</span><a href="#local_p''_356"><span class="LIDENT">p''</span></a> <span class="LABEL">~user_provided_promise:</span><a href="#local_p'_354"><span class="LIDENT">p'</span></a> <span class="IN">in</span><span class="EOL">
</span>          <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a> <a href="#local_p''_357"><span class="LIDENT">p''</span></a><span class="EOL">
</span>      <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="LIDENT">to_public_promise</span> <a href="#local_p''_343"><span class="LIDENT">p''</span></a><span class="COMMA">,</span> <a href="#local_callback_345"><span class="LIDENT">callback</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_p_341"><span class="LIDENT">p</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">to_public_promise</span> <a href="#local_p_341"><span class="LIDENT">p</span></a><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span id="local_exn_358"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">run_callback_or_defer_it</span><span class="EOL">
</span>        <span class="LABEL">~run_immediately_and_ensure_tail_call:</span><span class="TRUE">true</span><span class="EOL">
</span>        <span class="LABEL">~callback:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_h_337"><span class="LIDENT">h</span></a> <span class="LPAREN">(</span><a href="#local_add_loc_335"><span class="LIDENT">add_loc</span></a> <a href="#local_exn_358"><span class="LIDENT">exn</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="LABEL">~if_deferred:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="def_803"><span class="LPAREN">(</span><span id="local_p''_359"><span class="LIDENT">p''</span></span><span class="COMMA">,</span> <span id="local_callback_360"><span class="LIDENT">callback</span></span><span class="RPAREN">)</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <a href="#local_create_result_promise_and_callback_if_deferred_342"><span class="LIDENT">create_result_promise_and_callback_if_deferred</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>          <span class="LPAREN">(</span><a href="#local_p''_359"><span class="LIDENT">p''</span></a><span class="COMMA">,</span> <a href="#local_callback_360"><span class="LIDENT">callback</span></a><span class="COMMA">,</span> <a href="#local_p_341"><span class="LIDENT">p</span></a><span class="DOT">.</span><span class="LIDENT">state</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span id="local_p_callbacks_361"><span class="LIDENT">p_callbacks</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="def_794"><span class="LPAREN">(</span><span id="local_p''_362"><span class="LIDENT">p''</span></span><span class="COMMA">,</span> <span id="local_callback_363"><span class="LIDENT">callback</span></span><span class="RPAREN">)</span></span> <span class="EQUAL">=</span> <a href="#local_create_result_promise_and_callback_if_deferred_342"><span class="LIDENT">create_result_promise_and_callback_if_deferred</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>      <span class="LIDENT">add_implicitly_removed_callback</span> <a href="#local_p_callbacks_361"><span class="LIDENT">p_callbacks</span></a> <a href="#local_callback_363"><span class="LIDENT">callback</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <a href="#local_p''_362"><span class="LIDENT">p''</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Sequential_composition.val-try_bind"><span class="LIDENT">try_bind</span></span> <span id="local_f_364"><span class="LIDENT">f</span></span> <span id="local_f'_365"><span class="LIDENT">f'</span></span> <span id="local_h_366"><span class="LIDENT">h</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_p_367"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="TRY">try</span> <a href="#local_f_364"><span class="LIDENT">f</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="WITH">with</span> <span id="local_exn_368"><span class="LIDENT">exn</span></span> <span class="WHEN">when</span> <span class="UIDENT">Exception_filter</span><span class="DOT">.</span><span class="LIDENT">run</span> <a href="#local_exn_368"><span class="LIDENT">exn</span></a> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">fail</span> <a href="#local_exn_368"><span class="LIDENT">exn</span></a><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p_369"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p_367"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_p_370"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p_369"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_create_result_promise_and_callback_if_deferred_371"><span class="LIDENT">create_result_promise_and_callback_if_deferred</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_p''_372"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span> <span class="LIDENT">new_pending</span> <span class="LABEL">~how_to_cancel:</span><span class="LPAREN">(</span><span class="UIDENT">Propagate_cancel_to_one</span> <a href="#local_p_370"><span class="LIDENT">p</span></a><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_saved_storage_373"><span class="LIDENT">saved_storage</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><span class="LIDENT">current_storage</span> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_callback_374"><span class="LIDENT">callback</span></span> <span id="local_p_result_375"><span class="LIDENT">p_result</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>        <span class="MATCH">match</span> <a href="#local_p_result_375"><span class="LIDENT">p_result</span></a> <span class="WITH">with</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span id="local_v_376"><span class="LIDENT">v</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LIDENT">current_storage</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="#local_saved_storage_373"><span class="LIDENT">saved_storage</span></a><span class="SEMI">;</span><span class="EOL">
</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_p'_377"><span class="LIDENT">p'</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <span class="TRY">try</span> <a href="#local_f'_365"><span class="LIDENT">f'</span></a> <a href="#local_v_376"><span class="LIDENT">v</span></a><span class="EOL">
</span>            <span class="WITH">with</span> <span id="local_exn_378"><span class="LIDENT">exn</span></span> <span class="WHEN">when</span> <span class="UIDENT">Exception_filter</span><span class="DOT">.</span><span class="LIDENT">run</span> <a href="#local_exn_378"><span class="LIDENT">exn</span></a> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">fail</span> <a href="#local_exn_378"><span class="LIDENT">exn</span></a><span class="EOL">
</span>          <span class="IN">in</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p'_379"><span class="LIDENT">p'</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p'_377"><span class="LIDENT">p'</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">State_may_now_be_pending_proxy</span> <span id="local_p''_380"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span> <span class="LIDENT">may_now_be_proxy</span> <a href="#local_p''_372"><span class="LIDENT">p''</span></a> <span class="IN">in</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_p''_381"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p''_380"><span class="LIDENT">p''</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">State_may_have_changed</span> <span id="local_p''_382"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <span class="LIDENT">make_into_proxy</span> <span class="LABEL">~outer_promise:</span><a href="#local_p''_381"><span class="LIDENT">p''</span></a> <span class="LABEL">~user_provided_promise:</span><a href="#local_p'_379"><span class="LIDENT">p'</span></a> <span class="IN">in</span><span class="EOL">
</span>          <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a> <a href="#local_p''_382"><span class="LIDENT">p''</span></a><span class="EOL">
</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span id="local_exn_383"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LIDENT">current_storage</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="#local_saved_storage_373"><span class="LIDENT">saved_storage</span></a><span class="SEMI">;</span><span class="EOL">
</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_p'_384"><span class="LIDENT">p'</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <span class="TRY">try</span> <a href="#local_h_366"><span class="LIDENT">h</span></a> <a href="#local_exn_383"><span class="LIDENT">exn</span></a><span class="EOL">
</span>            <span class="WITH">with</span> <span id="local_exn_385"><span class="LIDENT">exn</span></span> <span class="WHEN">when</span> <span class="UIDENT">Exception_filter</span><span class="DOT">.</span><span class="LIDENT">run</span> <a href="#local_exn_385"><span class="LIDENT">exn</span></a> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">fail</span> <a href="#local_exn_385"><span class="LIDENT">exn</span></a><span class="EOL">
</span>          <span class="IN">in</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p'_386"><span class="LIDENT">p'</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p'_384"><span class="LIDENT">p'</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">State_may_now_be_pending_proxy</span> <span id="local_p''_387"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span> <span class="LIDENT">may_now_be_proxy</span> <a href="#local_p''_372"><span class="LIDENT">p''</span></a> <span class="IN">in</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_p''_388"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p''_387"><span class="LIDENT">p''</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">State_may_have_changed</span> <span id="local_p''_389"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <span class="LIDENT">make_into_proxy</span> <span class="LABEL">~outer_promise:</span><a href="#local_p''_388"><span class="LIDENT">p''</span></a> <span class="LABEL">~user_provided_promise:</span><a href="#local_p'_386"><span class="LIDENT">p'</span></a> <span class="IN">in</span><span class="EOL">
</span>          <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a> <a href="#local_p''_389"><span class="LIDENT">p''</span></a><span class="EOL">
</span>      <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="LIDENT">to_public_promise</span> <a href="#local_p''_372"><span class="LIDENT">p''</span></a><span class="COMMA">,</span> <a href="#local_callback_374"><span class="LIDENT">callback</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_p_370"><span class="LIDENT">p</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span id="local_v_390"><span class="LIDENT">v</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">run_callback_or_defer_it</span><span class="EOL">
</span>        <span class="LABEL">~run_immediately_and_ensure_tail_call:</span><span class="TRUE">true</span><span class="EOL">
</span>        <span class="LABEL">~callback:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_f'_365"><span class="LIDENT">f'</span></a> <a href="#local_v_390"><span class="LIDENT">v</span></a><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="LABEL">~if_deferred:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="def_808"><span class="LPAREN">(</span><span id="local_p''_391"><span class="LIDENT">p''</span></span><span class="COMMA">,</span> <span id="local_callback_392"><span class="LIDENT">callback</span></span><span class="RPAREN">)</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <a href="#local_create_result_promise_and_callback_if_deferred_371"><span class="LIDENT">create_result_promise_and_callback_if_deferred</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>          <span class="LPAREN">(</span><a href="#local_p''_391"><span class="LIDENT">p''</span></a><span class="COMMA">,</span> <a href="#local_callback_392"><span class="LIDENT">callback</span></a><span class="COMMA">,</span> <a href="#local_p_370"><span class="LIDENT">p</span></a><span class="DOT">.</span><span class="LIDENT">state</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span id="local_exn_393"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">run_callback_or_defer_it</span><span class="EOL">
</span>        <span class="LABEL">~run_immediately_and_ensure_tail_call:</span><span class="TRUE">true</span><span class="EOL">
</span>        <span class="LABEL">~callback:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_h_366"><span class="LIDENT">h</span></a> <a href="#local_exn_393"><span class="LIDENT">exn</span></a><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="LABEL">~if_deferred:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="def_791"><span class="LPAREN">(</span><span id="local_p''_394"><span class="LIDENT">p''</span></span><span class="COMMA">,</span> <span id="local_callback_395"><span class="LIDENT">callback</span></span><span class="RPAREN">)</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <a href="#local_create_result_promise_and_callback_if_deferred_371"><span class="LIDENT">create_result_promise_and_callback_if_deferred</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>          <span class="LPAREN">(</span><a href="#local_p''_394"><span class="LIDENT">p''</span></a><span class="COMMA">,</span> <a href="#local_callback_395"><span class="LIDENT">callback</span></a><span class="COMMA">,</span> <a href="#local_p_370"><span class="LIDENT">p</span></a><span class="DOT">.</span><span class="LIDENT">state</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span id="local_p_callbacks_396"><span class="LIDENT">p_callbacks</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="def_784"><span class="LPAREN">(</span><span id="local_p''_397"><span class="LIDENT">p''</span></span><span class="COMMA">,</span> <span id="local_callback_398"><span class="LIDENT">callback</span></span><span class="RPAREN">)</span></span> <span class="EQUAL">=</span> <a href="#local_create_result_promise_and_callback_if_deferred_371"><span class="LIDENT">create_result_promise_and_callback_if_deferred</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>      <span class="LIDENT">add_implicitly_removed_callback</span> <a href="#local_p_callbacks_396"><span class="LIDENT">p_callbacks</span></a> <a href="#local_callback_398"><span class="LIDENT">callback</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <a href="#local_p''_397"><span class="LIDENT">p''</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Sequential_composition.val-backtrace_try_bind"><span class="LIDENT">backtrace_try_bind</span></span> <span id="local_add_loc_399"><span class="LIDENT">add_loc</span></span> <span id="local_f_400"><span class="LIDENT">f</span></span> <span id="local_f'_401"><span class="LIDENT">f'</span></span> <span id="local_h_402"><span class="LIDENT">h</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_p_403"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="TRY">try</span> <a href="#local_f_400"><span class="LIDENT">f</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="WITH">with</span> <span id="local_exn_404"><span class="LIDENT">exn</span></span> <span class="WHEN">when</span> <span class="UIDENT">Exception_filter</span><span class="DOT">.</span><span class="LIDENT">run</span> <a href="#local_exn_404"><span class="LIDENT">exn</span></a> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">fail</span> <a href="#local_exn_404"><span class="LIDENT">exn</span></a><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p_405"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p_403"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_p_406"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p_405"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_create_result_promise_and_callback_if_deferred_407"><span class="LIDENT">create_result_promise_and_callback_if_deferred</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_p''_408"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span> <span class="LIDENT">new_pending</span> <span class="LABEL">~how_to_cancel:</span><span class="LPAREN">(</span><span class="UIDENT">Propagate_cancel_to_one</span> <a href="#local_p_406"><span class="LIDENT">p</span></a><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_saved_storage_409"><span class="LIDENT">saved_storage</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><span class="LIDENT">current_storage</span> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_callback_410"><span class="LIDENT">callback</span></span> <span id="local_p_result_411"><span class="LIDENT">p_result</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>        <span class="MATCH">match</span> <a href="#local_p_result_411"><span class="LIDENT">p_result</span></a> <span class="WITH">with</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span id="local_v_412"><span class="LIDENT">v</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LIDENT">current_storage</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="#local_saved_storage_409"><span class="LIDENT">saved_storage</span></a><span class="SEMI">;</span><span class="EOL">
</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_p'_413"><span class="LIDENT">p'</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <span class="TRY">try</span> <a href="#local_f'_401"><span class="LIDENT">f'</span></a> <a href="#local_v_412"><span class="LIDENT">v</span></a><span class="EOL">
</span>            <span class="WITH">with</span> <span id="local_exn_414"><span class="LIDENT">exn</span></span> <span class="WHEN">when</span> <span class="UIDENT">Exception_filter</span><span class="DOT">.</span><span class="LIDENT">run</span> <a href="#local_exn_414"><span class="LIDENT">exn</span></a> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>              <span class="LIDENT">fail</span> <span class="LPAREN">(</span><a href="#local_add_loc_399"><span class="LIDENT">add_loc</span></a> <a href="#local_exn_414"><span class="LIDENT">exn</span></a><span class="RPAREN">)</span><span class="EOL">
</span>          <span class="IN">in</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p'_415"><span class="LIDENT">p'</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p'_413"><span class="LIDENT">p'</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">State_may_now_be_pending_proxy</span> <span id="local_p''_416"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span> <span class="LIDENT">may_now_be_proxy</span> <a href="#local_p''_408"><span class="LIDENT">p''</span></a> <span class="IN">in</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_p''_417"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p''_416"><span class="LIDENT">p''</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">State_may_have_changed</span> <span id="local_p''_418"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <span class="LIDENT">make_into_proxy</span> <span class="LABEL">~outer_promise:</span><a href="#local_p''_417"><span class="LIDENT">p''</span></a> <span class="LABEL">~user_provided_promise:</span><a href="#local_p'_415"><span class="LIDENT">p'</span></a> <span class="IN">in</span><span class="EOL">
</span>          <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a> <a href="#local_p''_418"><span class="LIDENT">p''</span></a><span class="EOL">
</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span id="local_exn_419"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LIDENT">current_storage</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="#local_saved_storage_409"><span class="LIDENT">saved_storage</span></a><span class="SEMI">;</span><span class="EOL">
</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_p'_420"><span class="LIDENT">p'</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <span class="TRY">try</span> <a href="#local_h_402"><span class="LIDENT">h</span></a> <a href="#local_exn_419"><span class="LIDENT">exn</span></a><span class="EOL">
</span>            <span class="WITH">with</span> <span id="local_exn_421"><span class="LIDENT">exn</span></span> <span class="WHEN">when</span> <span class="UIDENT">Exception_filter</span><span class="DOT">.</span><span class="LIDENT">run</span> <a href="#local_exn_421"><span class="LIDENT">exn</span></a> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>              <span class="LIDENT">fail</span> <span class="LPAREN">(</span><a href="#local_add_loc_399"><span class="LIDENT">add_loc</span></a> <a href="#local_exn_421"><span class="LIDENT">exn</span></a><span class="RPAREN">)</span><span class="EOL">
</span>          <span class="IN">in</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p'_422"><span class="LIDENT">p'</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p'_420"><span class="LIDENT">p'</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">State_may_now_be_pending_proxy</span> <span id="local_p''_423"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span> <span class="LIDENT">may_now_be_proxy</span> <a href="#local_p''_408"><span class="LIDENT">p''</span></a> <span class="IN">in</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_p''_424"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p''_423"><span class="LIDENT">p''</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">State_may_have_changed</span> <span id="local_p''_425"><span class="LIDENT">p''</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <span class="LIDENT">make_into_proxy</span> <span class="LABEL">~outer_promise:</span><a href="#local_p''_424"><span class="LIDENT">p''</span></a> <span class="LABEL">~user_provided_promise:</span><a href="#local_p'_422"><span class="LIDENT">p'</span></a> <span class="IN">in</span><span class="EOL">
</span>          <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a> <a href="#local_p''_425"><span class="LIDENT">p''</span></a><span class="EOL">
</span>      <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="LIDENT">to_public_promise</span> <a href="#local_p''_408"><span class="LIDENT">p''</span></a><span class="COMMA">,</span> <a href="#local_callback_410"><span class="LIDENT">callback</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_p_406"><span class="LIDENT">p</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span id="local_v_426"><span class="LIDENT">v</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">run_callback_or_defer_it</span><span class="EOL">
</span>        <span class="LABEL">~run_immediately_and_ensure_tail_call:</span><span class="TRUE">true</span><span class="EOL">
</span>        <span class="LABEL">~callback:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_f'_401"><span class="LIDENT">f'</span></a> <a href="#local_v_426"><span class="LIDENT">v</span></a><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="LABEL">~if_deferred:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="def_810"><span class="LPAREN">(</span><span id="local_p''_427"><span class="LIDENT">p''</span></span><span class="COMMA">,</span> <span id="local_callback_428"><span class="LIDENT">callback</span></span><span class="RPAREN">)</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <a href="#local_create_result_promise_and_callback_if_deferred_407"><span class="LIDENT">create_result_promise_and_callback_if_deferred</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>          <span class="LPAREN">(</span><a href="#local_p''_427"><span class="LIDENT">p''</span></a><span class="COMMA">,</span> <a href="#local_callback_428"><span class="LIDENT">callback</span></a><span class="COMMA">,</span> <a href="#local_p_406"><span class="LIDENT">p</span></a><span class="DOT">.</span><span class="LIDENT">state</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span id="local_exn_429"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">run_callback_or_defer_it</span><span class="EOL">
</span>        <span class="LABEL">~run_immediately_and_ensure_tail_call:</span><span class="TRUE">true</span><span class="EOL">
</span>        <span class="LABEL">~callback:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_h_402"><span class="LIDENT">h</span></a> <span class="LPAREN">(</span><a href="#local_add_loc_399"><span class="LIDENT">add_loc</span></a> <a href="#local_exn_429"><span class="LIDENT">exn</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="LABEL">~if_deferred:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="def_788"><span class="LPAREN">(</span><span id="local_p''_430"><span class="LIDENT">p''</span></span><span class="COMMA">,</span> <span id="local_callback_431"><span class="LIDENT">callback</span></span><span class="RPAREN">)</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <a href="#local_create_result_promise_and_callback_if_deferred_407"><span class="LIDENT">create_result_promise_and_callback_if_deferred</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>          <span class="LPAREN">(</span><a href="#local_p''_430"><span class="LIDENT">p''</span></a><span class="COMMA">,</span> <a href="#local_callback_431"><span class="LIDENT">callback</span></a><span class="COMMA">,</span> <a href="#local_p_406"><span class="LIDENT">p</span></a><span class="DOT">.</span><span class="LIDENT">state</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span id="local_p_callbacks_432"><span class="LIDENT">p_callbacks</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="def_809"><span class="LPAREN">(</span><span id="local_p''_433"><span class="LIDENT">p''</span></span><span class="COMMA">,</span> <span id="local_callback_434"><span class="LIDENT">callback</span></span><span class="RPAREN">)</span></span> <span class="EQUAL">=</span> <a href="#local_create_result_promise_and_callback_if_deferred_407"><span class="LIDENT">create_result_promise_and_callback_if_deferred</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>      <span class="LIDENT">add_implicitly_removed_callback</span> <a href="#local_p_callbacks_432"><span class="LIDENT">p_callbacks</span></a> <a href="#local_callback_434"><span class="LIDENT">callback</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <a href="#local_p''_433"><span class="LIDENT">p''</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Sequential_composition.val-finalize"><span class="LIDENT">finalize</span></span> <span id="local_f_435"><span class="LIDENT">f</span></span> <span id="local_f'_436"><span class="LIDENT">f'</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">try_bind</span> <a href="#local_f_435"><span class="LIDENT">f</span></a><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_x_437"><span class="LIDENT">x</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">bind</span> <span class="LPAREN">(</span><a href="#local_f'_436"><span class="LIDENT">f'</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="RPAREN">)</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">return</span> <a href="#local_x_437"><span class="LIDENT">x</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_e_438"><span class="LIDENT">e</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">bind</span> <span class="LPAREN">(</span><a href="#local_f'_436"><span class="LIDENT">f'</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="RPAREN">)</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">fail</span> <a href="#local_e_438"><span class="LIDENT">e</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Sequential_composition.val-backtrace_finalize"><span class="LIDENT">backtrace_finalize</span></span> <span id="local_add_loc_439"><span class="LIDENT">add_loc</span></span> <span id="local_f_440"><span class="LIDENT">f</span></span> <span id="local_f'_441"><span class="LIDENT">f'</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">backtrace_try_bind</span> <a href="#local_add_loc_439"><span class="LIDENT">add_loc</span></a> <a href="#local_f_440"><span class="LIDENT">f</span></a><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_x_442"><span class="LIDENT">x</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">bind</span> <span class="LPAREN">(</span><a href="#local_f'_441"><span class="LIDENT">f'</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="RPAREN">)</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">return</span> <a href="#local_x_442"><span class="LIDENT">x</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_e_443"><span class="LIDENT">e</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">bind</span> <span class="LPAREN">(</span><a href="#local_f'_441"><span class="LIDENT">f'</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="RPAREN">)</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">fail</span> <span class="LPAREN">(</span><a href="#local_add_loc_439"><span class="LIDENT">add_loc</span></a> <a href="#local_e_443"><span class="LIDENT">e</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Sequential_composition.val-on_cancel"><span class="LIDENT">on_cancel</span></span> <span id="local_p_444"><span class="LIDENT">p</span></span> <span id="local_f_445"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p_446"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p_444"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_p_447"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p_446"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_p_447"><span class="LIDENT">p</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UIDENT">Canceled</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">run_callback_or_defer_it</span><span class="EOL">
</span>        <span class="LABEL">~run_immediately_and_ensure_tail_call:</span><span class="TRUE">true</span><span class="EOL">
</span>        <span class="LABEL">~callback:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">handle_with_async_exception_hook</span> <a href="#local_f_445"><span class="LIDENT">f</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="LABEL">~if_deferred:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LPAREN">(</span><span class="LPAREN">(</span><span class="RPAREN">)</span><span class="COMMA">,</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">handle_with_async_exception_hook</span> <a href="#local_f_445"><span class="LIDENT">f</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="COMMA">,</span> <span class="UIDENT">Fulfilled</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span id="local_callbacks_448"><span class="LIDENT">callbacks</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">add_cancel_callback</span> <a href="#local_callbacks_448"><span class="LIDENT">callbacks</span></a> <a href="#local_f_445"><span class="LIDENT">f</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Sequential_composition.val-on_success"><span class="LIDENT">on_success</span></span> <span id="local_p_449"><span class="LIDENT">p</span></span> <span id="local_f_450"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p_451"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p_449"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_p_452"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p_451"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_callback_if_deferred_453"><span class="LIDENT">callback_if_deferred</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_saved_storage_454"><span class="LIDENT">saved_storage</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><span class="LIDENT">current_storage</span> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="FUN">fun</span> <span id="local_result_455"><span class="LIDENT">result</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="MATCH">match</span> <a href="#local_result_455"><span class="LIDENT">result</span></a> <span class="WITH">with</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span id="local_v_456"><span class="LIDENT">v</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LIDENT">current_storage</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="#local_saved_storage_454"><span class="LIDENT">saved_storage</span></a><span class="SEMI">;</span><span class="EOL">
</span>          <span class="LIDENT">handle_with_async_exception_hook</span> <a href="#local_f_450"><span class="LIDENT">f</span></a> <a href="#local_v_456"><span class="LIDENT">v</span></a><span class="EOL">
</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_p_452"><span class="LIDENT">p</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span id="local_v_457"><span class="LIDENT">v</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">run_callback_or_defer_it</span><span class="EOL">
</span>        <span class="LABEL">~run_immediately_and_ensure_tail_call:</span><span class="TRUE">true</span><span class="EOL">
</span>        <span class="LABEL">~callback:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">handle_with_async_exception_hook</span> <a href="#local_f_450"><span class="LIDENT">f</span></a> <a href="#local_v_457"><span class="LIDENT">v</span></a><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="LABEL">~if_deferred:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_callback_458"><span class="LIDENT">callback</span></span> <span class="EQUAL">=</span> <a href="#local_callback_if_deferred_453"><span class="LIDENT">callback_if_deferred</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>          <span class="LPAREN">(</span><span class="LPAREN">(</span><span class="RPAREN">)</span><span class="COMMA">,</span> <a href="#local_callback_458"><span class="LIDENT">callback</span></a><span class="COMMA">,</span> <a href="#local_p_452"><span class="LIDENT">p</span></a><span class="DOT">.</span><span class="LIDENT">state</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span id="local_p_callbacks_459"><span class="LIDENT">p_callbacks</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_callback_460"><span class="LIDENT">callback</span></span> <span class="EQUAL">=</span> <a href="#local_callback_if_deferred_453"><span class="LIDENT">callback_if_deferred</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>      <span class="LIDENT">add_implicitly_removed_callback</span> <a href="#local_p_callbacks_459"><span class="LIDENT">p_callbacks</span></a> <a href="#local_callback_460"><span class="LIDENT">callback</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Sequential_composition.val-on_failure"><span class="LIDENT">on_failure</span></span> <span id="local_p_461"><span class="LIDENT">p</span></span> <span id="local_f_462"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p_463"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p_461"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_p_464"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p_463"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_callback_if_deferred_465"><span class="LIDENT">callback_if_deferred</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_saved_storage_466"><span class="LIDENT">saved_storage</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><span class="LIDENT">current_storage</span> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="FUN">fun</span> <span id="local_result_467"><span class="LIDENT">result</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="MATCH">match</span> <a href="#local_result_467"><span class="LIDENT">result</span></a> <span class="WITH">with</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span id="local_exn_468"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LIDENT">current_storage</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="#local_saved_storage_466"><span class="LIDENT">saved_storage</span></a><span class="SEMI">;</span><span class="EOL">
</span>          <span class="LIDENT">handle_with_async_exception_hook</span> <a href="#local_f_462"><span class="LIDENT">f</span></a> <a href="#local_exn_468"><span class="LIDENT">exn</span></a><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_p_464"><span class="LIDENT">p</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span id="local_exn_469"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">run_callback_or_defer_it</span><span class="EOL">
</span>        <span class="LABEL">~run_immediately_and_ensure_tail_call:</span><span class="TRUE">true</span><span class="EOL">
</span>        <span class="LABEL">~callback:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">handle_with_async_exception_hook</span> <a href="#local_f_462"><span class="LIDENT">f</span></a> <a href="#local_exn_469"><span class="LIDENT">exn</span></a><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="LABEL">~if_deferred:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_callback_470"><span class="LIDENT">callback</span></span> <span class="EQUAL">=</span> <a href="#local_callback_if_deferred_465"><span class="LIDENT">callback_if_deferred</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>          <span class="LPAREN">(</span><span class="LPAREN">(</span><span class="RPAREN">)</span><span class="COMMA">,</span> <a href="#local_callback_470"><span class="LIDENT">callback</span></a><span class="COMMA">,</span> <a href="#local_p_464"><span class="LIDENT">p</span></a><span class="DOT">.</span><span class="LIDENT">state</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span id="local_p_callbacks_471"><span class="LIDENT">p_callbacks</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_callback_472"><span class="LIDENT">callback</span></span> <span class="EQUAL">=</span> <a href="#local_callback_if_deferred_465"><span class="LIDENT">callback_if_deferred</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>      <span class="LIDENT">add_implicitly_removed_callback</span> <a href="#local_p_callbacks_471"><span class="LIDENT">p_callbacks</span></a> <a href="#local_callback_472"><span class="LIDENT">callback</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Sequential_composition.val-on_termination"><span class="LIDENT">on_termination</span></span> <span id="local_p_473"><span class="LIDENT">p</span></span> <span id="local_f_474"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p_475"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p_473"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_p_476"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p_475"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_callback_if_deferred_477"><span class="LIDENT">callback_if_deferred</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_saved_storage_478"><span class="LIDENT">saved_storage</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><span class="LIDENT">current_storage</span> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="FUN">fun</span> <span id="local__result_479"><span class="LIDENT">_result</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LIDENT">current_storage</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="#local_saved_storage_478"><span class="LIDENT">saved_storage</span></a><span class="SEMI">;</span><span class="EOL">
</span>        <span class="LIDENT">handle_with_async_exception_hook</span> <a href="#local_f_474"><span class="LIDENT">f</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_p_476"><span class="LIDENT">p</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">run_callback_or_defer_it</span><span class="EOL">
</span>        <span class="LABEL">~run_immediately_and_ensure_tail_call:</span><span class="TRUE">true</span><span class="EOL">
</span>        <span class="LABEL">~callback:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">handle_with_async_exception_hook</span> <a href="#local_f_474"><span class="LIDENT">f</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="LABEL">~if_deferred:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_callback_480"><span class="LIDENT">callback</span></span> <span class="EQUAL">=</span> <a href="#local_callback_if_deferred_477"><span class="LIDENT">callback_if_deferred</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>          <span class="LPAREN">(</span><span class="LPAREN">(</span><span class="RPAREN">)</span><span class="COMMA">,</span> <a href="#local_callback_480"><span class="LIDENT">callback</span></a><span class="COMMA">,</span> <a href="#local_p_476"><span class="LIDENT">p</span></a><span class="DOT">.</span><span class="LIDENT">state</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">run_callback_or_defer_it</span><span class="EOL">
</span>      <span class="LABEL">~run_immediately_and_ensure_tail_call:</span><span class="TRUE">true</span><span class="EOL">
</span>        <span class="LABEL">~callback:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">handle_with_async_exception_hook</span> <a href="#local_f_474"><span class="LIDENT">f</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="LABEL">~if_deferred:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_callback_481"><span class="LIDENT">callback</span></span> <span class="EQUAL">=</span> <a href="#local_callback_if_deferred_477"><span class="LIDENT">callback_if_deferred</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>          <span class="LPAREN">(</span><span class="LPAREN">(</span><span class="RPAREN">)</span><span class="COMMA">,</span> <a href="#local_callback_481"><span class="LIDENT">callback</span></a><span class="COMMA">,</span> <a href="#local_p_476"><span class="LIDENT">p</span></a><span class="DOT">.</span><span class="LIDENT">state</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span id="local_p_callbacks_482"><span class="LIDENT">p_callbacks</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_callback_483"><span class="LIDENT">callback</span></span> <span class="EQUAL">=</span> <a href="#local_callback_if_deferred_477"><span class="LIDENT">callback_if_deferred</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>      <span class="LIDENT">add_implicitly_removed_callback</span> <a href="#local_p_callbacks_482"><span class="LIDENT">p_callbacks</span></a> <a href="#local_callback_483"><span class="LIDENT">callback</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Sequential_composition.val-on_any"><span class="LIDENT">on_any</span></span> <span id="local_p_484"><span class="LIDENT">p</span></span> <span id="local_f_485"><span class="LIDENT">f</span></span> <span id="local_g_486"><span class="LIDENT">g</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p_487"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p_484"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_p_488"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p_487"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_callback_if_deferred_489"><span class="LIDENT">callback_if_deferred</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_saved_storage_490"><span class="LIDENT">saved_storage</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><span class="LIDENT">current_storage</span> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="FUN">fun</span> <span id="local_result_491"><span class="LIDENT">result</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="MATCH">match</span> <a href="#local_result_491"><span class="LIDENT">result</span></a> <span class="WITH">with</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span id="local_v_492"><span class="LIDENT">v</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LIDENT">current_storage</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="#local_saved_storage_490"><span class="LIDENT">saved_storage</span></a><span class="SEMI">;</span><span class="EOL">
</span>          <span class="LIDENT">handle_with_async_exception_hook</span> <a href="#local_f_485"><span class="LIDENT">f</span></a> <a href="#local_v_492"><span class="LIDENT">v</span></a><span class="EOL">
</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span id="local_exn_493"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LIDENT">current_storage</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="#local_saved_storage_490"><span class="LIDENT">saved_storage</span></a><span class="SEMI">;</span><span class="EOL">
</span>          <span class="LIDENT">handle_with_async_exception_hook</span> <a href="#local_g_486"><span class="LIDENT">g</span></a> <a href="#local_exn_493"><span class="LIDENT">exn</span></a><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_p_488"><span class="LIDENT">p</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span id="local_v_494"><span class="LIDENT">v</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">run_callback_or_defer_it</span><span class="EOL">
</span>        <span class="LABEL">~run_immediately_and_ensure_tail_call:</span><span class="TRUE">true</span><span class="EOL">
</span>        <span class="LABEL">~callback:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">handle_with_async_exception_hook</span> <a href="#local_f_485"><span class="LIDENT">f</span></a> <a href="#local_v_494"><span class="LIDENT">v</span></a><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="LABEL">~if_deferred:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_callback_495"><span class="LIDENT">callback</span></span> <span class="EQUAL">=</span> <a href="#local_callback_if_deferred_489"><span class="LIDENT">callback_if_deferred</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>          <span class="LPAREN">(</span><span class="LPAREN">(</span><span class="RPAREN">)</span><span class="COMMA">,</span> <a href="#local_callback_495"><span class="LIDENT">callback</span></a><span class="COMMA">,</span> <a href="#local_p_488"><span class="LIDENT">p</span></a><span class="DOT">.</span><span class="LIDENT">state</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span id="local_exn_496"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">run_callback_or_defer_it</span><span class="EOL">
</span>        <span class="LABEL">~run_immediately_and_ensure_tail_call:</span><span class="TRUE">true</span><span class="EOL">
</span>        <span class="LABEL">~callback:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">handle_with_async_exception_hook</span> <a href="#local_g_486"><span class="LIDENT">g</span></a> <a href="#local_exn_496"><span class="LIDENT">exn</span></a><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="LABEL">~if_deferred:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_callback_497"><span class="LIDENT">callback</span></span> <span class="EQUAL">=</span> <a href="#local_callback_if_deferred_489"><span class="LIDENT">callback_if_deferred</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>          <span class="LPAREN">(</span><span class="LPAREN">(</span><span class="RPAREN">)</span><span class="COMMA">,</span> <a href="#local_callback_497"><span class="LIDENT">callback</span></a><span class="COMMA">,</span> <a href="#local_p_488"><span class="LIDENT">p</span></a><span class="DOT">.</span><span class="LIDENT">state</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span id="local_p_callbacks_498"><span class="LIDENT">p_callbacks</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_callback_499"><span class="LIDENT">callback</span></span> <span class="EQUAL">=</span> <a href="#local_callback_if_deferred_489"><span class="LIDENT">callback_if_deferred</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>      <span class="LIDENT">add_implicitly_removed_callback</span> <a href="#local_p_callbacks_498"><span class="LIDENT">p_callbacks</span></a> <a href="#local_callback_499"><span class="LIDENT">callback</span></a><span class="EOL">
</span><span class="END">end</span></span><span class="EOL">
</span><span class="INCLUDE">include</span> <span class="UIDENT">Sequential_composition</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* This belongs with the [protected] and such, but it depends on primitives from
   [Sequential_composition]. *)</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-wrap_in_cancelable"><span class="LIDENT">wrap_in_cancelable</span></span> <span id="local_p_500"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span><span class="EOL">
</span> <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p_internal_501"><span class="LIDENT">p_internal</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p_500"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span> <span class="LET">let</span> <span id="local_p_underlying_502"><span class="LIDENT">p_underlying</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p_internal_501"><span class="LIDENT">p_internal</span></a> <span class="IN">in</span><span class="EOL">
</span> <span class="MATCH">match</span> <a href="#local_p_underlying_502"><span class="LIDENT">p_underlying</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span> <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_p_500"><span class="LIDENT">p</span></a><span class="EOL">
</span> <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_p_500"><span class="LIDENT">p</span></a><span class="EOL">
</span> <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>   <span class="LET">let</span> <span id="def_792"><span id="local_p'_503"><span class="LIDENT">p'</span></span><span class="COMMA">,</span> <span id="local_r_504"><span class="LIDENT">r</span></span></span> <span class="EQUAL">=</span> <span class="LIDENT">task</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>   <span class="LIDENT">on_cancel</span> <a href="#local_p'_503"><span class="LIDENT">p'</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">cancel</span> <a href="#local_p_500"><span class="LIDENT">p</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>   <span class="LIDENT">on_any</span> <a href="#local_p_500"><span class="LIDENT">p</span></a> <span class="LPAREN">(</span><span class="LIDENT">wakeup</span> <a href="#local_r_504"><span class="LIDENT">r</span></a><span class="RPAREN">)</span> <span class="LPAREN">(</span><span class="LIDENT">wakeup_exn</span> <a href="#local_r_504"><span class="LIDENT">r</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>   <a href="#local_p'_503"><span class="LIDENT">p'</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span id="module-Concurrent_composition"><span class="MODULE">module</span> <span class="UIDENT">Concurrent_composition</span> <span class="COLON">:</span><span class="EOL">
</span><span class="SIG">sig</span><span class="EOL">
</span>  <span id="module-Concurrent_composition.val-dont_wait"><span class="VAL">val</span> <span class="LIDENT">dont_wait</span> <span class="COLON">:</span> <span class="LPAREN">(</span><span class="LIDENT">unit</span> <span class="MINUSGREATER">-&gt;</span> <span class="UNDERSCORE">_</span> <span class="LIDENT">t</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="LIDENT">exn</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span></span><span class="EOL">
</span>  <span id="module-Concurrent_composition.val-async"><span class="VAL">val</span> <span class="LIDENT">async</span> <span class="COLON">:</span> <span class="LPAREN">(</span><span class="LIDENT">unit</span> <span class="MINUSGREATER">-&gt;</span> <span class="UNDERSCORE">_</span> <span class="LIDENT">t</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span></span><span class="EOL">
</span>  <span id="module-Concurrent_composition.val-ignore_result"><span class="VAL">val</span> <span class="LIDENT">ignore_result</span> <span class="COLON">:</span> <span class="UNDERSCORE">_</span> <span class="LIDENT">t</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Concurrent_composition.val-both"><span class="VAL">val</span> <span class="LIDENT">both</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">b</span> <span class="LIDENT">t</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="STAR">*</span> <span class="QUOTE">'</span><span class="LIDENT">b</span><span class="RPAREN">)</span> <span class="LIDENT">t</span></span><span class="EOL">
</span>  <span id="module-Concurrent_composition.val-join"><span class="VAL">val</span> <span class="LIDENT">join</span> <span class="COLON">:</span> <span class="LIDENT">unit</span> <span class="LIDENT">t</span> <span class="LIDENT">list</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span> <span class="LIDENT">t</span></span><span class="EOL">
</span>  <span id="module-Concurrent_composition.val-all"><span class="VAL">val</span> <span class="LIDENT">all</span> <span class="COLON">:</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span><span class="RPAREN">)</span> <span class="LIDENT">list</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">list</span><span class="RPAREN">)</span> <span class="LIDENT">t</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Concurrent_composition.val-choose"><span class="VAL">val</span> <span class="LIDENT">choose</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="LIDENT">list</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span></span><span class="EOL">
</span>  <span id="module-Concurrent_composition.val-pick"><span class="VAL">val</span> <span class="LIDENT">pick</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="LIDENT">list</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Concurrent_composition.val-nchoose"><span class="VAL">val</span> <span class="LIDENT">nchoose</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="LIDENT">list</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">list</span> <span class="LIDENT">t</span></span><span class="EOL">
</span>  <span id="module-Concurrent_composition.val-npick"><span class="VAL">val</span> <span class="LIDENT">npick</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="LIDENT">list</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">list</span> <span class="LIDENT">t</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Concurrent_composition.val-nchoose_split"><span class="VAL">val</span> <span class="LIDENT">nchoose_split</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="LIDENT">list</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">list</span> <span class="STAR">*</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="LIDENT">list</span><span class="RPAREN">)</span> <span class="LIDENT">t</span></span><span class="EOL">
</span><span class="END">end</span> <span class="EQUAL">=</span><span class="EOL">
</span><span class="STRUCT">struct</span><span class="EOL">
</span>  <span id="module-Concurrent_composition.val-reraise"><span class="EXTERNAL">external</span> <span class="LIDENT">reraise</span> <span class="COLON">:</span> <span class="LIDENT">exn</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="EQUAL">=</span> <span class="STRING">&quot;%reraise&quot;</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Concurrent_composition.val-dont_wait"><span class="LIDENT">dont_wait</span></span> <span id="local_f_505"><span class="LIDENT">f</span></span> <span id="local_h_506"><span class="LIDENT">h</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_p_507"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="TRY">try</span> <a href="#local_f_505"><span class="LIDENT">f</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="WITH">with</span> <span id="local_exn_508"><span class="LIDENT">exn</span></span> <span class="WHEN">when</span> <span class="UIDENT">Exception_filter</span><span class="DOT">.</span><span class="LIDENT">run</span> <a href="#local_exn_508"><span class="LIDENT">exn</span></a> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">fail</span> <a href="#local_exn_508"><span class="LIDENT">exn</span></a><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p_509"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p_507"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="MATCH">match</span> <span class="LPAREN">(</span><span class="LIDENT">underlying</span> <a href="#local_p_509"><span class="LIDENT">p</span></a><span class="RPAREN">)</span><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span id="local_exn_510"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="#local_h_506"><span class="LIDENT">h</span></a> <a href="#local_exn_510"><span class="LIDENT">exn</span></a><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span id="local_p_callbacks_511"><span class="LIDENT">p_callbacks</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_callback_512"><span class="LIDENT">callback</span></span> <span id="local_result_513"><span class="LIDENT">result</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>        <span class="MATCH">match</span> <a href="#local_result_513"><span class="LIDENT">result</span></a> <span class="WITH">with</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span id="local_exn_514"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="#local_h_506"><span class="LIDENT">h</span></a> <a href="#local_exn_514"><span class="LIDENT">exn</span></a><span class="EOL">
</span>      <span class="IN">in</span><span class="EOL">
</span>      <span class="LIDENT">add_implicitly_removed_callback</span> <a href="#local_p_callbacks_511"><span class="LIDENT">p_callbacks</span></a> <a href="#local_callback_512"><span class="LIDENT">callback</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Concurrent_composition.val-async"><span class="LIDENT">async</span></span> <span id="local_f_515"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_p_516"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="TRY">try</span> <a href="#local_f_515"><span class="LIDENT">f</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="WITH">with</span> <span id="local_exn_517"><span class="LIDENT">exn</span></span> <span class="WHEN">when</span> <span class="UIDENT">Exception_filter</span><span class="DOT">.</span><span class="LIDENT">run</span> <a href="#local_exn_517"><span class="LIDENT">exn</span></a> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">fail</span> <a href="#local_exn_517"><span class="LIDENT">exn</span></a><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p_518"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p_516"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="MATCH">match</span> <span class="LPAREN">(</span><span class="LIDENT">underlying</span> <a href="#local_p_518"><span class="LIDENT">p</span></a><span class="RPAREN">)</span><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span id="local_exn_519"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><span class="LIDENT">async_exception_hook</span> <a href="#local_exn_519"><span class="LIDENT">exn</span></a><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span id="local_p_callbacks_520"><span class="LIDENT">p_callbacks</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_callback_521"><span class="LIDENT">callback</span></span> <span id="local_result_522"><span class="LIDENT">result</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>        <span class="MATCH">match</span> <a href="#local_result_522"><span class="LIDENT">result</span></a> <span class="WITH">with</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span id="local_exn_523"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><span class="LIDENT">async_exception_hook</span> <a href="#local_exn_523"><span class="LIDENT">exn</span></a><span class="EOL">
</span>      <span class="IN">in</span><span class="EOL">
</span>      <span class="LIDENT">add_implicitly_removed_callback</span> <a href="#local_p_callbacks_520"><span class="LIDENT">p_callbacks</span></a> <a href="#local_callback_521"><span class="LIDENT">callback</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Concurrent_composition.val-ignore_result"><span class="LIDENT">ignore_result</span></span> <span id="local_p_524"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p_525"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p_524"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="MATCH">match</span> <span class="LPAREN">(</span><span class="LIDENT">underlying</span> <a href="#local_p_525"><span class="LIDENT">p</span></a><span class="RPAREN">)</span><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span id="local_exn_526"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">reraise</span> <a href="#local_exn_526"><span class="LIDENT">exn</span></a><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span id="local_p_callbacks_527"><span class="LIDENT">p_callbacks</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_callback_528"><span class="LIDENT">callback</span></span> <span id="local_result_529"><span class="LIDENT">result</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>        <span class="MATCH">match</span> <a href="#local_result_529"><span class="LIDENT">result</span></a> <span class="WITH">with</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span id="local_exn_530"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><span class="LIDENT">async_exception_hook</span> <a href="#local_exn_530"><span class="LIDENT">exn</span></a><span class="EOL">
</span>      <span class="IN">in</span><span class="EOL">
</span>      <span class="LIDENT">add_implicitly_removed_callback</span> <a href="#local_p_callbacks_527"><span class="LIDENT">p_callbacks</span></a> <a href="#local_callback_528"><span class="LIDENT">callback</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Concurrent_composition.val-join"><span class="LIDENT">join</span></span> <span id="local_ps_531"><span class="LIDENT">ps</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_p'_532"><span class="LIDENT">p'</span></span> <span class="EQUAL">=</span> <span class="LIDENT">new_pending</span> <span class="LABEL">~how_to_cancel:</span><span class="LPAREN">(</span><span class="LIDENT">propagate_cancel_to_several</span> <a href="#local_ps_531"><span class="LIDENT">ps</span></a><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_number_pending_in_ps_533"><span class="LIDENT">number_pending_in_ps</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ref"><span class="LIDENT">ref</span></a> <span class="INT">0</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_join_result_534"><span class="LIDENT">join_result</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ref"><span class="LIDENT">ref</span></a> <span class="LPAREN">(</span><span class="UIDENT">Fulfilled</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="COMMENT">(* Callback attached to each promise in [ps] that is still pending at the
       time [join] is called. *)</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_callback_535"><span class="LIDENT">callback</span></span> <span id="local_new_result_536"><span class="LIDENT">new_result</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LET">let</span> <span class="UIDENT">State_may_now_be_pending_proxy</span> <span id="local_p'_537"><span class="LIDENT">p'</span></span> <span class="EQUAL">=</span> <span class="LIDENT">may_now_be_proxy</span> <a href="#local_p'_532"><span class="LIDENT">p'</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="BEGIN">begin</span> <span class="MATCH">match</span> <a href="#local_new_result_536"><span class="LIDENT">new_result</span></a> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="COMMENT">(* For the first promise in [ps] to be rejected, set the result of the
         [join] to rejected with the same exception.. *)</span><span class="EOL">
</span>        <span class="MATCH">match</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="#local_join_result_534"><span class="LIDENT">join_result</span></a> <span class="WITH">with</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_join_result_534"><span class="LIDENT">join_result</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="#local_new_result_536"><span class="LIDENT">new_result</span></a><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="END">end</span><span class="SEMI">;</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="COMMENT">(* In all cases, decrement the number of promises still pending, and
         resolve the [join] once all promises resolve. *)</span><span class="EOL">
</span>      <a href="#local_number_pending_in_ps_533"><span class="LIDENT">number_pending_in_ps</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="#local_number_pending_in_ps_533"><span class="LIDENT">number_pending_in_ps</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <span class="INT">1</span><span class="SEMI">;</span><span class="EOL">
</span>      <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="#local_number_pending_in_ps_533"><span class="LIDENT">number_pending_in_ps</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="INT">0</span> <span class="THEN">then</span> <span class="BEGIN">begin</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_p'_538"><span class="LIDENT">p'</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p'_537"><span class="LIDENT">p'</span></a> <span class="IN">in</span><span class="EOL">
</span>        <span class="LET">let</span> <span class="UIDENT">State_may_have_changed</span> <span id="local_p'_539"><span class="LIDENT">p'</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>          <span class="LIDENT">resolve</span> <span class="LABEL">~allow_deferring:</span><span class="FALSE">false</span> <span class="LPAREN">(</span><span class="LIDENT">underlying</span> <a href="#local_p'_538"><span class="LIDENT">p'</span></a><span class="RPAREN">)</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="#local_join_result_534"><span class="LIDENT">join_result</span></a> <span class="IN">in</span><span class="EOL">
</span>        <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a> <a href="#local_p'_539"><span class="LIDENT">p'</span></a><span class="EOL">
</span>      <span class="END">end</span><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="COMMENT">(* Attach the above callback. Simultaneously count how many pending promises
       there are in [ps] (initially). If that number is zero, the [join] must
       resolve immediately. *)</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="REC">rec</span> <span id="local_attach_callback_or_resolve_immediately_540"><span class="LIDENT">attach_callback_or_resolve_immediately</span></span> <span id="local_ps_541"><span class="LIDENT">ps</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="MATCH">match</span> <a href="#local_ps_541"><span class="LIDENT">ps</span></a> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="#local_number_pending_in_ps_533"><span class="LIDENT">number_pending_in_ps</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="INT">0</span> <span class="THEN">then</span><span class="EOL">
</span>          <span class="LIDENT">to_public_promise</span> <span class="LBRACE">{</span><span class="LIDENT">state</span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="#local_join_result_534"><span class="LIDENT">join_result</span></a><span class="RBRACE">}</span><span class="EOL">
</span>        <span class="ELSE">else</span><span class="EOL">
</span>          <span class="LIDENT">to_public_promise</span> <a href="#local_p'_532"><span class="LIDENT">p'</span></a><span class="EOL">
</span><span class="EOL">
</span>      <span class="BAR">|</span> <span id="local_p_542"><span class="LIDENT">p</span></span><span class="COLONCOLON">::</span><span id="local_ps_543"><span class="LIDENT">ps</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p_544"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p_542"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>        <span class="MATCH">match</span> <span class="LPAREN">(</span><span class="LIDENT">underlying</span> <a href="#local_p_544"><span class="LIDENT">p</span></a><span class="RPAREN">)</span><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span id="local_p_callbacks_545"><span class="LIDENT">p_callbacks</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="#local_number_pending_in_ps_533"><span class="LIDENT">number_pending_in_ps</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="#local_number_pending_in_ps_533"><span class="LIDENT">number_pending_in_ps</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <span class="INT">1</span><span class="SEMI">;</span><span class="EOL">
</span>          <span class="LIDENT">add_implicitly_removed_callback</span> <a href="#local_p_callbacks_545"><span class="LIDENT">p_callbacks</span></a> <a href="#local_callback_535"><span class="LIDENT">callback</span></a><span class="SEMI">;</span><span class="EOL">
</span>          <a href="#local_attach_callback_or_resolve_immediately_540"><span class="LIDENT">attach_callback_or_resolve_immediately</span></a> <a href="#local_ps_543"><span class="LIDENT">ps</span></a><span class="EOL">
</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UNDERSCORE">_</span> <span class="AS">as</span> <span id="local_p_result_546"><span class="LIDENT">p_result</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="COMMENT">(* As in the callback above, but for already-resolved promises in
             [ps]: reject the [join] with the same exception as in the first
             rejected promise found. [join] still waits for any pending promises
             before actually resolving, though. *)</span><span class="EOL">
</span>          <span class="BEGIN">begin</span> <span class="MATCH">match</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="#local_join_result_534"><span class="LIDENT">join_result</span></a> <span class="WITH">with</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_join_result_534"><span class="LIDENT">join_result</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="#local_p_result_546"><span class="LIDENT">p_result</span></a><span class="SEMI">;</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>          <span class="END">end</span><span class="SEMI">;</span><span class="EOL">
</span>          <a href="#local_attach_callback_or_resolve_immediately_540"><span class="LIDENT">attach_callback_or_resolve_immediately</span></a> <a href="#local_ps_543"><span class="LIDENT">ps</span></a><span class="EOL">
</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="#local_attach_callback_or_resolve_immediately_540"><span class="LIDENT">attach_callback_or_resolve_immediately</span></a> <a href="#local_ps_543"><span class="LIDENT">ps</span></a><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <a href="#local_attach_callback_or_resolve_immediately_540"><span class="LIDENT">attach_callback_or_resolve_immediately</span></a> <a href="#local_ps_531"><span class="LIDENT">ps</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* this is 3 words, smaller than the 2 times 2 words a pair of references
     would take. *)</span><span class="EOL">
</span>  <span id="module-Concurrent_composition.type-pair"><span class="TYPE">type</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span><span class="QUOTE">'</span><span class="LIDENT">b</span><span class="RPAREN">)</span> <span class="LIDENT">pair</span> <span class="EQUAL">=</span> <span class="LBRACE">{</span><span class="EOL">
</span>    <span id="def_790"><span class="MUTABLE">mutable</span> <span class="LIDENT">x1</span><span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">option</span><span class="SEMI">;</span></span><span class="EOL">
</span>    <span id="def_804"><span class="MUTABLE">mutable</span> <span class="LIDENT">x2</span><span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">b</span> <span class="LIDENT">option</span><span class="SEMI">;</span></span><span class="EOL">
</span>  <span class="RBRACE">}</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Concurrent_composition.val-both"><span class="LIDENT">both</span></span> <span id="local_p1_547"><span class="LIDENT">p1</span></span> <span id="local_p2_548"><span class="LIDENT">p2</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_pair_549"><span class="LIDENT">pair</span></span> <span class="EQUAL">=</span> <span class="LBRACE">{</span><span class="LIDENT">x1</span> <span class="EQUAL">=</span> <span class="UIDENT">None</span><span class="SEMI">;</span> <span class="LIDENT">x2</span> <span class="EQUAL">=</span> <span class="UIDENT">None</span><span class="RBRACE">}</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_p1'_550"><span class="LIDENT">p1'</span></span> <span class="EQUAL">=</span> <span class="LIDENT">bind</span> <a href="#local_p1_547"><span class="LIDENT">p1</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_v_551"><span class="LIDENT">v</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_pair_549"><span class="LIDENT">pair</span></a><span class="DOT">.</span><span class="LIDENT">x1</span> <span class="LESSMINUS">&lt;-</span> <span class="UIDENT">Some</span> <a href="#local_v_551"><span class="LIDENT">v</span></a><span class="SEMI">;</span> <span class="LIDENT">return_unit</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_p2'_552"><span class="LIDENT">p2'</span></span> <span class="EQUAL">=</span> <span class="LIDENT">bind</span> <a href="#local_p2_548"><span class="LIDENT">p2</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_v_553"><span class="LIDENT">v</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_pair_549"><span class="LIDENT">pair</span></a><span class="DOT">.</span><span class="LIDENT">x2</span> <span class="LESSMINUS">&lt;-</span> <span class="UIDENT">Some</span> <a href="#local_v_553"><span class="LIDENT">v</span></a><span class="SEMI">;</span> <span class="LIDENT">return_unit</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="LIDENT">join</span> <span class="LBRACKET">[</span><a href="#local_p1'_550"><span class="LIDENT">p1'</span></a><span class="SEMI">;</span> <a href="#local_p2'_552"><span class="LIDENT">p2'</span></a><span class="RBRACKET">]</span> <span class="INFIXOP0">|&gt;</span> <span class="LIDENT">map</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="MATCH">match</span> <a href="#local_pair_549"><span class="LIDENT">pair</span></a><span class="DOT">.</span><span class="LIDENT">x1</span><span class="COMMA">,</span> <a href="#local_pair_549"><span class="LIDENT">pair</span></a><span class="DOT">.</span><span class="LIDENT">x2</span> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_v1_554"><span class="LIDENT">v1</span></span><span class="COMMA">,</span> <span class="UIDENT">Some</span> <span id="local_v2_555"><span class="LIDENT">v2</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_v1_554"><span class="LIDENT">v1</span></a><span class="COMMA">,</span> <a href="#local_v2_555"><span class="LIDENT">v2</span></a><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="ASSERT">assert</span> <span class="FALSE">false</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Concurrent_composition.val-all"><span class="LIDENT">all</span></span> <span id="local_ps_556"><span class="LIDENT">ps</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_ps_556"><span class="LIDENT">ps</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">return_nil</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="LBRACKET">[</span><span id="local_x_557"><span class="LIDENT">x</span></span><span class="RBRACKET">]</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">map</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_y_558"><span class="LIDENT">y</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="LBRACKET">[</span><a href="#local_y_558"><span class="LIDENT">y</span></a><span class="RBRACKET">]</span><span class="RPAREN">)</span> <a href="#local_x_557"><span class="LIDENT">x</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="LBRACKET">[</span><span id="local_x_559"><span class="LIDENT">x</span></span><span class="SEMI">;</span> <span id="local_y_560"><span class="LIDENT">y</span></span><span class="RBRACKET">]</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">map</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span id="local_x_561"><span class="LIDENT">x</span></span><span class="COMMA">,</span> <span id="local_y_562"><span class="LIDENT">y</span></span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LBRACKET">[</span><a href="#local_x_561"><span class="LIDENT">x</span></a><span class="SEMI">;</span> <a href="#local_y_562"><span class="LIDENT">y</span></a><span class="RBRACKET">]</span><span class="RPAREN">)</span> <span class="LPAREN">(</span><span class="LIDENT">both</span> <a href="#local_x_559"><span class="LIDENT">x</span></a> <a href="#local_y_560"><span class="LIDENT">y</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_vs_563"><span class="LIDENT">vs</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/array.ml.html#val-make"><span class="UIDENT">Array</span><span class="DOT">.</span><span class="LIDENT">make</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-length"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">length</span></a> <a href="#local_ps_556"><span class="LIDENT">ps</span></a><span class="RPAREN">)</span> <span class="UIDENT">None</span> <span class="IN">in</span><span class="EOL">
</span>      <a href="#local_ps_556"><span class="LIDENT">ps</span></a><span class="EOL">
</span>      <span class="INFIXOP0">|&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-mapi"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">mapi</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_index_568"><span class="LIDENT">index</span></span> <span id="local_p_569"><span class="LIDENT">p</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LIDENT">bind</span> <a href="#local_p_569"><span class="LIDENT">p</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_v_570"><span class="LIDENT">v</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_vs_563"><span class="LIDENT">vs</span></a><span class="DOT">.</span><span class="LPAREN">(</span><a href="#local_index_568"><span class="LIDENT">index</span></a><span class="RPAREN">)</span> <span class="LESSMINUS">&lt;-</span> <span class="UIDENT">Some</span> <a href="#local_v_570"><span class="LIDENT">v</span></a><span class="SEMI">;</span> <span class="LIDENT">return_unit</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="INFIXOP0">|&gt;</span> <span class="LIDENT">join</span><span class="EOL">
</span>      <span class="INFIXOP0">|&gt;</span> <span class="LIDENT">map</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="REC">rec</span> <span id="local_to_list_unopt_564"><span class="LIDENT">to_list_unopt</span></span> <span id="local_i_565"><span class="LIDENT">i</span></span> <span id="local_acc_566"><span class="LIDENT">acc</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <span class="IF">if</span> <a href="#local_i_565"><span class="LIDENT">i</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;)"><span class="LESS">&lt;</span></a> <span class="INT">0</span> <span class="THEN">then</span><span class="EOL">
</span>              <a href="#local_acc_566"><span class="LIDENT">acc</span></a><span class="EOL">
</span>            <span class="ELSE">else</span><span class="EOL">
</span>              <span class="MATCH">match</span> <a href="../../../ocaml-base-compiler/src/stdlib/array.ml.html#val-unsafe_get"><span class="UIDENT">Array</span><span class="DOT">.</span><span class="LIDENT">unsafe_get</span></a> <a href="#local_vs_563"><span class="LIDENT">vs</span></a> <a href="#local_i_565"><span class="LIDENT">i</span></a> <span class="WITH">with</span><span class="EOL">
</span>              <span class="BAR">|</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span> <span class="ASSERT">assert</span> <span class="FALSE">false</span><span class="EOL">
</span>              <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_x_567"><span class="LIDENT">x</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_to_list_unopt_564"><span class="LIDENT">to_list_unopt</span></a> <span class="LPAREN">(</span><a href="#local_i_565"><span class="LIDENT">i</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <span class="INT">1</span><span class="RPAREN">)</span> <span class="LPAREN">(</span><a href="#local_x_567"><span class="LIDENT">x</span></a><span class="COLONCOLON">::</span><a href="#local_acc_566"><span class="LIDENT">acc</span></a><span class="RPAREN">)</span><span class="EOL">
</span>          <span class="IN">in</span><span class="EOL">
</span>          <a href="#local_to_list_unopt_564"><span class="LIDENT">to_list_unopt</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/array.ml.html#val-length"><span class="UIDENT">Array</span><span class="DOT">.</span><span class="LIDENT">length</span></a> <a href="#local_vs_563"><span class="LIDENT">vs</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <span class="INT">1</span><span class="RPAREN">)</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Maintainer's note: the next few functions are helpers for [choose] and
     [pick]. Perhaps they should be factored into some kind of generic
     [choose]/[pick] implementation, which may actually be optimal anyway with
     Flambda. *)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Concurrent_composition.val-count_resolved_promises_in"><span class="LIDENT">count_resolved_promises_in</span></span> <span class="LPAREN">(</span><span id="local_ps_571"><span class="LIDENT">ps</span></span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="LIDENT">list</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="REC">rec</span> <span id="local_count_and_gather_rejected_572"><span class="LIDENT">count_and_gather_rejected</span></span> <span id="local_total_573"><span class="LIDENT">total</span></span> <span id="local_rejected_574"><span class="LIDENT">rejected</span></span> <span id="local_ps_575"><span class="LIDENT">ps</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>       <span class="MATCH">match</span> <a href="#local_ps_575"><span class="LIDENT">ps</span></a> <span class="WITH">with</span><span class="EOL">
</span>       <span class="BAR">|</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Error</span> <span class="LPAREN">(</span><a href="#local_total_573"><span class="LIDENT">total</span></a><span class="COMMA">,</span> <a href="#local_rejected_574"><span class="LIDENT">rejected</span></a><span class="RPAREN">)</span><span class="EOL">
</span>       <span class="BAR">|</span> <span id="local_p_576"><span class="LIDENT">p</span></span> <span class="COLONCOLON">::</span> <span id="local_ps_577"><span class="LIDENT">ps</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_q_578"><span class="LIDENT">q</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p_576"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>            <span class="MATCH">match</span> <span class="LPAREN">(</span><span class="LIDENT">underlying</span> <a href="#local_q_578"><span class="LIDENT">q</span></a><span class="RPAREN">)</span><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>            <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_count_and_gather_rejected_572"><span class="LIDENT">count_and_gather_rejected</span></a> <a href="#local_total_573"><span class="LIDENT">total</span></a> <a href="#local_rejected_574"><span class="LIDENT">rejected</span></a> <a href="#local_ps_577"><span class="LIDENT">ps</span></a><span class="EOL">
</span>            <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_count_and_gather_rejected_572"><span class="LIDENT">count_and_gather_rejected</span></a> <span class="LPAREN">(</span><a href="#local_total_573"><span class="LIDENT">total</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <span class="INT">1</span><span class="RPAREN">)</span> <span class="LPAREN">(</span><a href="#local_p_576"><span class="LIDENT">p</span></a> <span class="COLONCOLON">::</span> <a href="#local_rejected_574"><span class="LIDENT">rejected</span></a><span class="RPAREN">)</span> <a href="#local_ps_577"><span class="LIDENT">ps</span></a><span class="EOL">
</span>            <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_count_and_gather_rejected_572"><span class="LIDENT">count_and_gather_rejected</span></a> <a href="#local_total_573"><span class="LIDENT">total</span></a> <a href="#local_rejected_574"><span class="LIDENT">rejected</span></a> <a href="#local_ps_577"><span class="LIDENT">ps</span></a><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="REC">rec</span> <span id="local_count_fulfilled_579"><span class="LIDENT">count_fulfilled</span></span> <span id="local_total_580"><span class="LIDENT">total</span></span> <span id="local_ps_581"><span class="LIDENT">ps</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>       <span class="MATCH">match</span> <a href="#local_ps_581"><span class="LIDENT">ps</span></a> <span class="WITH">with</span><span class="EOL">
</span>       <span class="BAR">|</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Ok</span> <a href="#local_total_580"><span class="LIDENT">total</span></a><span class="EOL">
</span>       <span class="BAR">|</span> <span id="local_p_582"><span class="LIDENT">p</span></span> <span class="COLONCOLON">::</span> <span id="local_ps_583"><span class="LIDENT">ps</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_q_584"><span class="LIDENT">q</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p_582"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>            <span class="MATCH">match</span> <span class="LPAREN">(</span><span class="LIDENT">underlying</span> <a href="#local_q_584"><span class="LIDENT">q</span></a><span class="RPAREN">)</span><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>            <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_count_fulfilled_579"><span class="LIDENT">count_fulfilled</span></a> <span class="LPAREN">(</span><a href="#local_total_580"><span class="LIDENT">total</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <span class="INT">1</span><span class="RPAREN">)</span> <a href="#local_ps_583"><span class="LIDENT">ps</span></a><span class="EOL">
</span>            <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_count_and_gather_rejected_572"><span class="LIDENT">count_and_gather_rejected</span></a> <span class="INT">1</span> <span class="LBRACKET">[</span><a href="#local_p_582"><span class="LIDENT">p</span></a><span class="RBRACKET">]</span> <a href="#local_ps_583"><span class="LIDENT">ps</span></a><span class="EOL">
</span>            <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_count_fulfilled_579"><span class="LIDENT">count_fulfilled</span></a> <a href="#local_total_580"><span class="LIDENT">total</span></a> <a href="#local_ps_583"><span class="LIDENT">ps</span></a><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span>    <a href="#local_count_fulfilled_579"><span class="LIDENT">count_fulfilled</span></a> <span class="INT">0</span> <a href="#local_ps_571"><span class="LIDENT">ps</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Evaluates to the [n]th promise in [ps], among only those promises in [ps]
     that are resolved. The caller is expected to ensure that there are at
     least [n] resolved promises in [ps]. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="REC">rec</span> <span id="module-Concurrent_composition.val-nth_resolved"><span class="LIDENT">nth_resolved</span></span> <span class="LPAREN">(</span><span id="local_ps_585"><span class="LIDENT">ps</span></span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="LIDENT">list</span><span class="RPAREN">)</span> <span class="LPAREN">(</span><span id="local_n_586"><span class="LIDENT">n</span></span> <span class="COLON">:</span> <span class="LIDENT">int</span><span class="RPAREN">)</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_ps_585"><span class="LIDENT">ps</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="ASSERT">assert</span> <span class="FALSE">false</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span id="local_p_587"><span class="LIDENT">p</span></span><span class="COLONCOLON">::</span><span id="local_ps_588"><span class="LIDENT">ps</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p'_589"><span class="LIDENT">p'</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p_587"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>      <span class="MATCH">match</span> <span class="LPAREN">(</span><span class="LIDENT">underlying</span> <a href="#local_p'_589"><span class="LIDENT">p'</span></a><span class="RPAREN">)</span><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LIDENT">nth_resolved</span> <a href="#local_ps_588"><span class="LIDENT">ps</span></a> <a href="#local_n_586"><span class="LIDENT">n</span></a><span class="EOL">
</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="IF">if</span> <a href="#local_n_586"><span class="LIDENT">n</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;=)"><span class="INFIXOP0">&lt;=</span></a> <span class="INT">0</span> <span class="THEN">then</span> <a href="#local_p_587"><span class="LIDENT">p</span></a><span class="EOL">
</span>        <span class="ELSE">else</span> <span class="LIDENT">nth_resolved</span> <a href="#local_ps_588"><span class="LIDENT">ps</span></a> <span class="LPAREN">(</span><a href="#local_n_586"><span class="LIDENT">n</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <span class="INT">1</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="IF">if</span> <a href="#local_n_586"><span class="LIDENT">n</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;=)"><span class="INFIXOP0">&lt;=</span></a> <span class="INT">0</span> <span class="THEN">then</span> <a href="#local_p_587"><span class="LIDENT">p</span></a><span class="EOL">
</span>        <span class="ELSE">else</span> <span class="LIDENT">nth_resolved</span> <a href="#local_ps_588"><span class="LIDENT">ps</span></a> <span class="LPAREN">(</span><a href="#local_n_586"><span class="LIDENT">n</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <span class="INT">1</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Like [nth_resolved], but cancels all pending promises found while
     traversing [ps]. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="REC">rec</span> <span id="module-Concurrent_composition.val-nth_resolved_and_cancel_pending"><span class="LIDENT">nth_resolved_and_cancel_pending</span></span> <span class="LPAREN">(</span><span id="local_ps_590"><span class="LIDENT">ps</span></span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="LIDENT">list</span><span class="RPAREN">)</span> <span class="LPAREN">(</span><span id="local_n_591"><span class="LIDENT">n</span></span> <span class="COLON">:</span> <span class="LIDENT">int</span><span class="RPAREN">)</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_ps_590"><span class="LIDENT">ps</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="ASSERT">assert</span> <span class="FALSE">false</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span id="local_p_592"><span class="LIDENT">p</span></span><span class="COLONCOLON">::</span><span id="local_ps_593"><span class="LIDENT">ps</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p'_594"><span class="LIDENT">p'</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p_592"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>      <span class="MATCH">match</span> <span class="LPAREN">(</span><span class="LIDENT">underlying</span> <a href="#local_p'_594"><span class="LIDENT">p'</span></a><span class="RPAREN">)</span><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LIDENT">cancel</span> <a href="#local_p_592"><span class="LIDENT">p</span></a><span class="SEMI">;</span><span class="EOL">
</span>        <span class="LIDENT">nth_resolved_and_cancel_pending</span> <a href="#local_ps_593"><span class="LIDENT">ps</span></a> <a href="#local_n_591"><span class="LIDENT">n</span></a><span class="EOL">
</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="IF">if</span> <a href="#local_n_591"><span class="LIDENT">n</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;=)"><span class="INFIXOP0">&lt;=</span></a> <span class="INT">0</span> <span class="THEN">then</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-iter"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">iter</span></a> <span class="LIDENT">cancel</span> <a href="#local_ps_593"><span class="LIDENT">ps</span></a><span class="SEMI">;</span> <a href="#local_p_592"><span class="LIDENT">p</span></a><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="ELSE">else</span> <span class="LIDENT">nth_resolved_and_cancel_pending</span> <a href="#local_ps_593"><span class="LIDENT">ps</span></a> <span class="LPAREN">(</span><a href="#local_n_591"><span class="LIDENT">n</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <span class="INT">1</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="IF">if</span> <a href="#local_n_591"><span class="LIDENT">n</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;=)"><span class="INFIXOP0">&lt;=</span></a> <span class="INT">0</span> <span class="THEN">then</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-iter"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">iter</span></a> <span class="LIDENT">cancel</span> <a href="#local_ps_593"><span class="LIDENT">ps</span></a><span class="SEMI">;</span> <a href="#local_p_592"><span class="LIDENT">p</span></a><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="ELSE">else</span> <span class="LIDENT">nth_resolved_and_cancel_pending</span> <a href="#local_ps_593"><span class="LIDENT">ps</span></a> <span class="LPAREN">(</span><a href="#local_n_591"><span class="LIDENT">n</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <span class="INT">1</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* The PRNG state is initialized with a constant to make non-IO-based programs
     deterministic. *)</span><span class="EOL">
</span>  <span class="COMMENT">(* Maintainer's note: is this necessary? *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Concurrent_composition.val-prng"><span class="LIDENT">prng</span></span> <span class="EQUAL">=</span> <span class="LAZY">lazy</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/random.ml.html#module-State.val-make"><span class="UIDENT">Random</span><span class="DOT">.</span><span class="UIDENT">State</span><span class="DOT">.</span><span class="LIDENT">make</span></a> <span class="LBRACKETBAR">[|</span><span class="BARRBRACKET">|]</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Concurrent_composition.val-choose"><span class="LIDENT">choose</span></span> <span id="local_ps_595"><span class="LIDENT">ps</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_ps_595"><span class="LIDENT">ps</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="THEN">then</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-invalid_arg"><span class="LIDENT">invalid_arg</span></a><span class="EOL">
</span>        <span class="STRING">&quot;Lwt.choose [] would return a promise that is pending forever&quot;</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="MATCH">match</span> <span class="LIDENT">count_resolved_promises_in</span> <a href="#local_ps_595"><span class="LIDENT">ps</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Ok</span> <span class="INT">0</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_p_596"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">new_pending</span> <span class="LABEL">~how_to_cancel:</span><span class="LPAREN">(</span><span class="LIDENT">propagate_cancel_to_several</span> <a href="#local_ps_595"><span class="LIDENT">ps</span></a><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_callback_597"><span class="LIDENT">callback</span></span> <span id="local_result_598"><span class="LIDENT">result</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>        <span class="LET">let</span> <span class="UIDENT">State_may_now_be_pending_proxy</span> <span id="local_p_599"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">may_now_be_proxy</span> <a href="#local_p_596"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_p_600"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p_599"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>        <span class="LET">let</span> <span class="UIDENT">State_may_have_changed</span> <span id="local_p_601"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>          <span class="LIDENT">resolve</span> <span class="LABEL">~allow_deferring:</span><span class="FALSE">false</span> <a href="#local_p_600"><span class="LIDENT">p</span></a> <a href="#local_result_598"><span class="LIDENT">result</span></a> <span class="IN">in</span><span class="EOL">
</span>        <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a> <a href="#local_p_601"><span class="LIDENT">p</span></a><span class="EOL">
</span>      <span class="IN">in</span><span class="EOL">
</span>      <span class="LIDENT">add_explicitly_removable_callback_to_each_of</span> <a href="#local_ps_595"><span class="LIDENT">ps</span></a> <a href="#local_callback_597"><span class="LIDENT">callback</span></a><span class="SEMI">;</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="LIDENT">to_public_promise</span> <a href="#local_p_596"><span class="LIDENT">p</span></a><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Ok</span> <span class="INT">1</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">nth_resolved</span> <a href="#local_ps_595"><span class="LIDENT">ps</span></a> <span class="INT">0</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Ok</span> <span id="local_n_602"><span class="LIDENT">n</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">nth_resolved</span> <a href="#local_ps_595"><span class="LIDENT">ps</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/random.ml.html#module-State.val-int"><span class="UIDENT">Random</span><span class="DOT">.</span><span class="UIDENT">State</span><span class="DOT">.</span><span class="LIDENT">int</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/lazy.ml.html#val-force"><span class="UIDENT">Lazy</span><span class="DOT">.</span><span class="LIDENT">force</span></a> <span class="LIDENT">prng</span><span class="RPAREN">)</span> <a href="#local_n_602"><span class="LIDENT">n</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Error</span> <span class="LPAREN">(</span><span id="local_n_603"><span class="LIDENT">n</span></span><span class="COMMA">,</span> <span id="local_ps_604"><span class="LIDENT">ps</span></span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">nth_resolved</span> <a href="#local_ps_604"><span class="LIDENT">ps</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/random.ml.html#module-State.val-int"><span class="UIDENT">Random</span><span class="DOT">.</span><span class="UIDENT">State</span><span class="DOT">.</span><span class="LIDENT">int</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/lazy.ml.html#val-force"><span class="UIDENT">Lazy</span><span class="DOT">.</span><span class="LIDENT">force</span></a> <span class="LIDENT">prng</span><span class="RPAREN">)</span> <a href="#local_n_603"><span class="LIDENT">n</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Concurrent_composition.val-pick"><span class="LIDENT">pick</span></span> <span id="local_ps_605"><span class="LIDENT">ps</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_ps_605"><span class="LIDENT">ps</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="THEN">then</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-invalid_arg"><span class="LIDENT">invalid_arg</span></a> <span class="STRING">&quot;Lwt.pick [] would return a promise that is pending forever&quot;</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="MATCH">match</span> <span class="LIDENT">count_resolved_promises_in</span> <a href="#local_ps_605"><span class="LIDENT">ps</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Ok</span> <span class="INT">0</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_p_606"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">new_pending</span> <span class="LABEL">~how_to_cancel:</span><span class="LPAREN">(</span><span class="LIDENT">propagate_cancel_to_several</span> <a href="#local_ps_605"><span class="LIDENT">ps</span></a><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_callback_607"><span class="LIDENT">callback</span></span> <span id="local_result_608"><span class="LIDENT">result</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>        <span class="LET">let</span> <span class="UIDENT">State_may_now_be_pending_proxy</span> <span id="local_p_609"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">may_now_be_proxy</span> <a href="#local_p_606"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>        <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-iter"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">iter</span></a> <span class="LIDENT">cancel</span> <a href="#local_ps_605"><span class="LIDENT">ps</span></a><span class="SEMI">;</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_p_610"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p_609"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>        <span class="LET">let</span> <span class="UIDENT">State_may_have_changed</span> <span id="local_p_611"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>          <span class="LIDENT">resolve</span> <span class="LABEL">~allow_deferring:</span><span class="FALSE">false</span> <a href="#local_p_610"><span class="LIDENT">p</span></a> <a href="#local_result_608"><span class="LIDENT">result</span></a> <span class="IN">in</span><span class="EOL">
</span>        <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a> <a href="#local_p_611"><span class="LIDENT">p</span></a><span class="EOL">
</span>      <span class="IN">in</span><span class="EOL">
</span>      <span class="LIDENT">add_explicitly_removable_callback_to_each_of</span> <a href="#local_ps_605"><span class="LIDENT">ps</span></a> <a href="#local_callback_607"><span class="LIDENT">callback</span></a><span class="SEMI">;</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="LIDENT">to_public_promise</span> <a href="#local_p_606"><span class="LIDENT">p</span></a><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Ok</span> <span class="INT">1</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">nth_resolved_and_cancel_pending</span> <a href="#local_ps_605"><span class="LIDENT">ps</span></a> <span class="INT">0</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Ok</span> <span id="local_n_612"><span class="LIDENT">n</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">nth_resolved_and_cancel_pending</span> <a href="#local_ps_605"><span class="LIDENT">ps</span></a><span class="EOL">
</span>        <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/random.ml.html#module-State.val-int"><span class="UIDENT">Random</span><span class="DOT">.</span><span class="UIDENT">State</span><span class="DOT">.</span><span class="LIDENT">int</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/lazy.ml.html#val-force"><span class="UIDENT">Lazy</span><span class="DOT">.</span><span class="LIDENT">force</span></a> <span class="LIDENT">prng</span><span class="RPAREN">)</span> <a href="#local_n_612"><span class="LIDENT">n</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Error</span> <span class="LPAREN">(</span><span id="local_n_613"><span class="LIDENT">n</span></span><span class="COMMA">,</span> <span id="local_qs_614"><span class="LIDENT">qs</span></span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-iter"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">iter</span></a> <span class="LIDENT">cancel</span> <a href="#local_ps_605"><span class="LIDENT">ps</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <span class="LIDENT">nth_resolved</span> <a href="#local_qs_614"><span class="LIDENT">qs</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/random.ml.html#module-State.val-int"><span class="UIDENT">Random</span><span class="DOT">.</span><span class="UIDENT">State</span><span class="DOT">.</span><span class="LIDENT">int</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/lazy.ml.html#val-force"><span class="UIDENT">Lazy</span><span class="DOT">.</span><span class="LIDENT">force</span></a> <span class="LIDENT">prng</span><span class="RPAREN">)</span> <a href="#local_n_613"><span class="LIDENT">n</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* If [nchoose ps] or [npick ps] found all promises in [ps] pending, the
     callback added to each promise in [ps] eventually calls this function. The
     function collects promises in [ps] that have become fulfilled, or finds one
     promise in [ps] that has been rejected. It then returns the desired state
     of the final promise: either the list of results collected, or the
     exception found. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="REC">rec</span> <span id="module-Concurrent_composition.val-collect_fulfilled_promises_after_pending"><span class="LIDENT">collect_fulfilled_promises_after_pending</span></span><span class="EOL">
</span>      <span class="LPAREN">(</span><span id="local_results_615"><span class="LIDENT">results</span></span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">list</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span id="local_ps_616"><span class="LIDENT">ps</span></span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="LIDENT">list</span><span class="RPAREN">)</span> <span class="COLON">:</span><span class="EOL">
</span>        <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">list</span> <span class="LIDENT">resolved_state</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_ps_616"><span class="LIDENT">ps</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="UIDENT">Fulfilled</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-rev"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">rev</span></a> <a href="#local_results_615"><span class="LIDENT">results</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="BAR">|</span> <span id="local_p_617"><span class="LIDENT">p</span></span><span class="COLONCOLON">::</span><span id="local_ps_618"><span class="LIDENT">ps</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p_619"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p_617"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="MATCH">match</span> <span class="LPAREN">(</span><span class="LIDENT">underlying</span> <a href="#local_p_619"><span class="LIDENT">p</span></a><span class="RPAREN">)</span><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span id="local_v_620"><span class="LIDENT">v</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LIDENT">collect_fulfilled_promises_after_pending</span> <span class="LPAREN">(</span><a href="#local_v_620"><span class="LIDENT">v</span></a><span class="COLONCOLON">::</span><a href="#local_results_615"><span class="LIDENT">results</span></a><span class="RPAREN">)</span> <a href="#local_ps_618"><span class="LIDENT">ps</span></a><span class="EOL">
</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UNDERSCORE">_</span> <span class="AS">as</span> <span id="local_result_621"><span class="LIDENT">result</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <a href="#local_result_621"><span class="LIDENT">result</span></a><span class="EOL">
</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LIDENT">collect_fulfilled_promises_after_pending</span> <a href="#local_results_615"><span class="LIDENT">results</span></a> <a href="#local_ps_618"><span class="LIDENT">ps</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Concurrent_composition.val-nchoose"><span class="LIDENT">nchoose</span></span> <span id="local_ps_622"><span class="LIDENT">ps</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="COMMENT">(* If at least one promise in [ps] is found fulfilled, this function is
       called to find all such promises. *)</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_ps_622"><span class="LIDENT">ps</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="THEN">then</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-invalid_arg"><span class="LIDENT">invalid_arg</span></a><span class="EOL">
</span>        <span class="STRING">&quot;Lwt.nchoose [] would return a promise that is pending forever&quot;</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="REC">rec</span> <span id="local_collect_already_fulfilled_promises_or_find_rejected_623"><span class="LIDENT">collect_already_fulfilled_promises_or_find_rejected</span></span> <span id="local_acc_624"><span class="LIDENT">acc</span></span> <span id="local_ps_625"><span class="LIDENT">ps</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="MATCH">match</span> <a href="#local_ps_625"><span class="LIDENT">ps</span></a> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LIDENT">return</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-rev"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">rev</span></a> <a href="#local_acc_624"><span class="LIDENT">acc</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="BAR">|</span> <span id="local_p_626"><span class="LIDENT">p</span></span><span class="COLONCOLON">::</span><span id="local_ps_627"><span class="LIDENT">ps</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p_628"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p_626"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>        <span class="MATCH">match</span> <span class="LPAREN">(</span><span class="LIDENT">underlying</span> <a href="#local_p_628"><span class="LIDENT">p</span></a><span class="RPAREN">)</span><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span id="local_v_629"><span class="LIDENT">v</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="#local_collect_already_fulfilled_promises_or_find_rejected_623"><span class="LIDENT">collect_already_fulfilled_promises_or_find_rejected</span></a> <span class="LPAREN">(</span><a href="#local_v_629"><span class="LIDENT">v</span></a><span class="COLONCOLON">::</span><a href="#local_acc_624"><span class="LIDENT">acc</span></a><span class="RPAREN">)</span> <a href="#local_ps_627"><span class="LIDENT">ps</span></a><span class="EOL">
</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UNDERSCORE">_</span> <span class="AS">as</span> <span id="local_result_630"><span class="LIDENT">result</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LIDENT">to_public_promise</span> <span class="LBRACE">{</span><span class="LIDENT">state</span> <span class="EQUAL">=</span> <a href="#local_result_630"><span class="LIDENT">result</span></a><span class="RBRACE">}</span><span class="EOL">
</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="#local_collect_already_fulfilled_promises_or_find_rejected_623"><span class="LIDENT">collect_already_fulfilled_promises_or_find_rejected</span></a> <a href="#local_acc_624"><span class="LIDENT">acc</span></a> <a href="#local_ps_627"><span class="LIDENT">ps</span></a><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="COMMENT">(* Looks for already-resolved promises in [ps]. If none are fulfilled or
       rejected, adds a callback to all promises in [ps] (all of which are
       pending). *)</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="REC">rec</span> <span id="local_check_for_already_resolved_promises_631"><span class="LIDENT">check_for_already_resolved_promises</span></span> <span id="local_ps'_632"><span class="LIDENT">ps'</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="MATCH">match</span> <a href="#local_ps'_632"><span class="LIDENT">ps'</span></a> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_p_633"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">new_pending</span> <span class="LABEL">~how_to_cancel:</span><span class="LPAREN">(</span><span class="LIDENT">propagate_cancel_to_several</span> <a href="#local_ps_622"><span class="LIDENT">ps</span></a><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_callback_634"><span class="LIDENT">callback</span></span> <span id="local__result_635"><span class="LIDENT">_result</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">State_may_now_be_pending_proxy</span> <span id="local_p_636"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">may_now_be_proxy</span> <a href="#local_p_633"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_p_637"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p_636"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_result_638"><span class="LIDENT">result</span></span> <span class="EQUAL">=</span> <span class="LIDENT">collect_fulfilled_promises_after_pending</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <a href="#local_ps_622"><span class="LIDENT">ps</span></a> <span class="IN">in</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">State_may_have_changed</span> <span id="local_p_639"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <span class="LIDENT">resolve</span> <span class="LABEL">~allow_deferring:</span><span class="FALSE">false</span> <a href="#local_p_637"><span class="LIDENT">p</span></a> <a href="#local_result_638"><span class="LIDENT">result</span></a> <span class="IN">in</span><span class="EOL">
</span>          <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a> <a href="#local_p_639"><span class="LIDENT">p</span></a><span class="EOL">
</span>        <span class="IN">in</span><span class="EOL">
</span>        <span class="LIDENT">add_explicitly_removable_callback_to_each_of</span> <a href="#local_ps_622"><span class="LIDENT">ps</span></a> <a href="#local_callback_634"><span class="LIDENT">callback</span></a><span class="SEMI">;</span><span class="EOL">
</span><span class="EOL">
</span>        <span class="LIDENT">to_public_promise</span> <a href="#local_p_633"><span class="LIDENT">p</span></a><span class="EOL">
</span><span class="EOL">
</span>      <span class="BAR">|</span> <span id="local_p_640"><span class="LIDENT">p</span></span><span class="COLONCOLON">::</span><span id="local_ps_641"><span class="LIDENT">ps</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p_642"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p_640"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>        <span class="MATCH">match</span> <span class="LPAREN">(</span><span class="LIDENT">underlying</span> <a href="#local_p_642"><span class="LIDENT">p</span></a><span class="RPAREN">)</span><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span id="local_v_643"><span class="LIDENT">v</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="#local_collect_already_fulfilled_promises_or_find_rejected_623"><span class="LIDENT">collect_already_fulfilled_promises_or_find_rejected</span></a> <span class="LBRACKET">[</span><a href="#local_v_643"><span class="LIDENT">v</span></a><span class="RBRACKET">]</span> <a href="#local_ps_641"><span class="LIDENT">ps</span></a><span class="EOL">
</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UNDERSCORE">_</span> <span class="AS">as</span> <span id="local_result_644"><span class="LIDENT">result</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LIDENT">to_public_promise</span> <span class="LBRACE">{</span><span class="LIDENT">state</span> <span class="EQUAL">=</span> <a href="#local_result_644"><span class="LIDENT">result</span></a><span class="RBRACE">}</span><span class="EOL">
</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="#local_check_for_already_resolved_promises_631"><span class="LIDENT">check_for_already_resolved_promises</span></a> <a href="#local_ps_641"><span class="LIDENT">ps</span></a><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_p_645"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <a href="#local_check_for_already_resolved_promises_631"><span class="LIDENT">check_for_already_resolved_promises</span></a> <a href="#local_ps_622"><span class="LIDENT">ps</span></a> <span class="IN">in</span><span class="EOL">
</span>    <a href="#local_p_645"><span class="LIDENT">p</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* See [nchoose]. This function differs only in having additional calls to
     [cancel]. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Concurrent_composition.val-npick"><span class="LIDENT">npick</span></span> <span id="local_ps_646"><span class="LIDENT">ps</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_ps_646"><span class="LIDENT">ps</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="THEN">then</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-invalid_arg"><span class="LIDENT">invalid_arg</span></a> <span class="STRING">&quot;Lwt.npick [] would return a promise that is pending forever&quot;</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="REC">rec</span> <span id="local_collect_already_fulfilled_promises_or_find_rejected_647"><span class="LIDENT">collect_already_fulfilled_promises_or_find_rejected</span></span> <span id="local_acc_648"><span class="LIDENT">acc</span></span> <span id="local_ps'_649"><span class="LIDENT">ps'</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="MATCH">match</span> <a href="#local_ps'_649"><span class="LIDENT">ps'</span></a> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-iter"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">iter</span></a> <span class="LIDENT">cancel</span> <a href="#local_ps_646"><span class="LIDENT">ps</span></a><span class="SEMI">;</span><span class="EOL">
</span>        <span class="LIDENT">return</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-rev"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">rev</span></a> <a href="#local_acc_648"><span class="LIDENT">acc</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="BAR">|</span> <span id="local_p_650"><span class="LIDENT">p</span></span><span class="COLONCOLON">::</span><span id="local_ps'_651"><span class="LIDENT">ps'</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p_652"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p_650"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>        <span class="MATCH">match</span> <span class="LPAREN">(</span><span class="LIDENT">underlying</span> <a href="#local_p_652"><span class="LIDENT">p</span></a><span class="RPAREN">)</span><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span id="local_v_653"><span class="LIDENT">v</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="#local_collect_already_fulfilled_promises_or_find_rejected_647"><span class="LIDENT">collect_already_fulfilled_promises_or_find_rejected</span></a> <span class="LPAREN">(</span><a href="#local_v_653"><span class="LIDENT">v</span></a><span class="COLONCOLON">::</span><a href="#local_acc_648"><span class="LIDENT">acc</span></a><span class="RPAREN">)</span> <a href="#local_ps'_651"><span class="LIDENT">ps'</span></a><span class="EOL">
</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UNDERSCORE">_</span> <span class="AS">as</span> <span id="local_result_654"><span class="LIDENT">result</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-iter"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">iter</span></a> <span class="LIDENT">cancel</span> <a href="#local_ps_646"><span class="LIDENT">ps</span></a><span class="SEMI">;</span><span class="EOL">
</span>          <span class="LIDENT">to_public_promise</span> <span class="LBRACE">{</span><span class="LIDENT">state</span> <span class="EQUAL">=</span> <a href="#local_result_654"><span class="LIDENT">result</span></a><span class="RBRACE">}</span><span class="EOL">
</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="#local_collect_already_fulfilled_promises_or_find_rejected_647"><span class="LIDENT">collect_already_fulfilled_promises_or_find_rejected</span></a> <a href="#local_acc_648"><span class="LIDENT">acc</span></a> <a href="#local_ps'_651"><span class="LIDENT">ps'</span></a><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="REC">rec</span> <span id="local_check_for_already_resolved_promises_655"><span class="LIDENT">check_for_already_resolved_promises</span></span> <span id="local_ps'_656"><span class="LIDENT">ps'</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="MATCH">match</span> <a href="#local_ps'_656"><span class="LIDENT">ps'</span></a> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_p_657"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">new_pending</span> <span class="LABEL">~how_to_cancel:</span><span class="LPAREN">(</span><span class="LIDENT">propagate_cancel_to_several</span> <a href="#local_ps_646"><span class="LIDENT">ps</span></a><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_callback_658"><span class="LIDENT">callback</span></span> <span id="local__result_659"><span class="LIDENT">_result</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">State_may_now_be_pending_proxy</span> <span id="local_p_660"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">may_now_be_proxy</span> <a href="#local_p_657"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_p_661"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p_660"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_result_662"><span class="LIDENT">result</span></span> <span class="EQUAL">=</span> <span class="LIDENT">collect_fulfilled_promises_after_pending</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <a href="#local_ps_646"><span class="LIDENT">ps</span></a> <span class="IN">in</span><span class="EOL">
</span>          <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-iter"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">iter</span></a> <span class="LIDENT">cancel</span> <a href="#local_ps_646"><span class="LIDENT">ps</span></a><span class="SEMI">;</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">State_may_have_changed</span> <span id="local_p_663"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <span class="LIDENT">resolve</span> <span class="LABEL">~allow_deferring:</span><span class="FALSE">false</span> <a href="#local_p_661"><span class="LIDENT">p</span></a> <a href="#local_result_662"><span class="LIDENT">result</span></a> <span class="IN">in</span><span class="EOL">
</span>          <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a> <a href="#local_p_663"><span class="LIDENT">p</span></a><span class="EOL">
</span>        <span class="IN">in</span><span class="EOL">
</span>        <span class="LIDENT">add_explicitly_removable_callback_to_each_of</span> <a href="#local_ps_646"><span class="LIDENT">ps</span></a> <a href="#local_callback_658"><span class="LIDENT">callback</span></a><span class="SEMI">;</span><span class="EOL">
</span><span class="EOL">
</span>        <span class="LIDENT">to_public_promise</span> <a href="#local_p_657"><span class="LIDENT">p</span></a><span class="EOL">
</span><span class="EOL">
</span>      <span class="BAR">|</span> <span id="local_p_664"><span class="LIDENT">p</span></span><span class="COLONCOLON">::</span><span id="local_ps'_665"><span class="LIDENT">ps'</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p_666"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p_664"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>        <span class="MATCH">match</span> <span class="LPAREN">(</span><span class="LIDENT">underlying</span> <a href="#local_p_666"><span class="LIDENT">p</span></a><span class="RPAREN">)</span><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span id="local_v_667"><span class="LIDENT">v</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="#local_collect_already_fulfilled_promises_or_find_rejected_647"><span class="LIDENT">collect_already_fulfilled_promises_or_find_rejected</span></a> <span class="LBRACKET">[</span><a href="#local_v_667"><span class="LIDENT">v</span></a><span class="RBRACKET">]</span> <a href="#local_ps'_665"><span class="LIDENT">ps'</span></a><span class="EOL">
</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UNDERSCORE">_</span> <span class="AS">as</span> <span id="local_result_668"><span class="LIDENT">result</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-iter"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">iter</span></a> <span class="LIDENT">cancel</span> <a href="#local_ps_646"><span class="LIDENT">ps</span></a><span class="SEMI">;</span><span class="EOL">
</span>          <span class="LIDENT">to_public_promise</span> <span class="LBRACE">{</span><span class="LIDENT">state</span> <span class="EQUAL">=</span> <a href="#local_result_668"><span class="LIDENT">result</span></a><span class="RBRACE">}</span><span class="EOL">
</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="#local_check_for_already_resolved_promises_655"><span class="LIDENT">check_for_already_resolved_promises</span></a> <a href="#local_ps'_665"><span class="LIDENT">ps'</span></a><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_p_669"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <a href="#local_check_for_already_resolved_promises_655"><span class="LIDENT">check_for_already_resolved_promises</span></a> <a href="#local_ps_646"><span class="LIDENT">ps</span></a> <span class="IN">in</span><span class="EOL">
</span>    <a href="#local_p_669"><span class="LIDENT">p</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Same general pattern as [npick] and [nchoose]. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Concurrent_composition.val-nchoose_split"><span class="LIDENT">nchoose_split</span></span> <span id="local_ps_670"><span class="LIDENT">ps</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_ps_670"><span class="LIDENT">ps</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="THEN">then</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-invalid_arg"><span class="LIDENT">invalid_arg</span></a><span class="EOL">
</span>        <span class="STRING">&quot;Lwt.nchoose_split [] would return a promise that is pending forever&quot;</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="REC">rec</span> <span id="local_finish_671"><span class="LIDENT">finish</span></span><span class="EOL">
</span>        <span class="LPAREN">(</span><span id="local_to_resolve_672"><span class="LIDENT">to_resolve</span></span> <span class="COLON">:</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">list</span> <span class="STAR">*</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="LIDENT">list</span><span class="COMMA">,</span> <span class="LIDENT">underlying</span><span class="COMMA">,</span> <span class="LIDENT">pending</span><span class="RPAREN">)</span> <span class="LIDENT">promise</span><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="LPAREN">(</span><span id="local_fulfilled_673"><span class="LIDENT">fulfilled</span></span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">list</span><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="LPAREN">(</span><span id="local_pending_674"><span class="LIDENT">pending</span></span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="LIDENT">list</span><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="LPAREN">(</span><span id="local_ps_675"><span class="LIDENT">ps</span></span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="LIDENT">list</span><span class="RPAREN">)</span><span class="EOL">
</span>          <span class="COLON">:</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">list</span> <span class="STAR">*</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="LIDENT">list</span><span class="COMMA">,</span> <span class="LIDENT">underlying</span><span class="COMMA">,</span> <span class="LIDENT">resolved</span><span class="RPAREN">)</span> <span class="LIDENT">state_changed</span> <span class="EQUAL">=</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="MATCH">match</span> <a href="#local_ps_675"><span class="LIDENT">ps</span></a> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LIDENT">resolve</span> <span class="LABEL">~allow_deferring:</span><span class="FALSE">false</span> <a href="#local_to_resolve_672"><span class="LIDENT">to_resolve</span></a><span class="EOL">
</span>          <span class="LPAREN">(</span><span class="UIDENT">Fulfilled</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-rev"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">rev</span></a> <a href="#local_fulfilled_673"><span class="LIDENT">fulfilled</span></a><span class="COMMA">,</span> <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-rev"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">rev</span></a> <a href="#local_pending_674"><span class="LIDENT">pending</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="BAR">|</span> <span id="local_p_676"><span class="LIDENT">p</span></span><span class="COLONCOLON">::</span><span id="local_ps_677"><span class="LIDENT">ps</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p_internal_678"><span class="LIDENT">p_internal</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p_676"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>        <span class="MATCH">match</span> <span class="LPAREN">(</span><span class="LIDENT">underlying</span> <a href="#local_p_internal_678"><span class="LIDENT">p_internal</span></a><span class="RPAREN">)</span><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span id="local_v_679"><span class="LIDENT">v</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="#local_finish_671"><span class="LIDENT">finish</span></a> <a href="#local_to_resolve_672"><span class="LIDENT">to_resolve</span></a> <span class="LPAREN">(</span><a href="#local_v_679"><span class="LIDENT">v</span></a><span class="COLONCOLON">::</span><a href="#local_fulfilled_673"><span class="LIDENT">fulfilled</span></a><span class="RPAREN">)</span> <a href="#local_pending_674"><span class="LIDENT">pending</span></a> <a href="#local_ps_677"><span class="LIDENT">ps</span></a><span class="EOL">
</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UNDERSCORE">_</span> <span class="AS">as</span> <span id="local_result_680"><span class="LIDENT">result</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LIDENT">resolve</span> <span class="LABEL">~allow_deferring:</span><span class="FALSE">false</span> <a href="#local_to_resolve_672"><span class="LIDENT">to_resolve</span></a> <a href="#local_result_680"><span class="LIDENT">result</span></a><span class="EOL">
</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="#local_finish_671"><span class="LIDENT">finish</span></a> <a href="#local_to_resolve_672"><span class="LIDENT">to_resolve</span></a> <a href="#local_fulfilled_673"><span class="LIDENT">fulfilled</span></a> <span class="LPAREN">(</span><a href="#local_p_676"><span class="LIDENT">p</span></a><span class="COLONCOLON">::</span><a href="#local_pending_674"><span class="LIDENT">pending</span></a><span class="RPAREN">)</span> <a href="#local_ps_677"><span class="LIDENT">ps</span></a><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="REC">rec</span> <span id="local_collect_already_resolved_promises_681"><span class="LIDENT">collect_already_resolved_promises</span></span> <span id="local_results_682"><span class="LIDENT">results</span></span> <span id="local_pending_683"><span class="LIDENT">pending</span></span> <span id="local_ps_684"><span class="LIDENT">ps</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="MATCH">match</span> <a href="#local_ps_684"><span class="LIDENT">ps</span></a> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="COMMENT">(* Maintainer's note: should the pending promise list also be
           reversed? It is reversed in finish. *)</span><span class="EOL">
</span>        <span class="LIDENT">return</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-rev"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">rev</span></a> <a href="#local_results_682"><span class="LIDENT">results</span></a><span class="COMMA">,</span> <a href="#local_pending_683"><span class="LIDENT">pending</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>      <span class="BAR">|</span> <span id="local_p_685"><span class="LIDENT">p</span></span><span class="COLONCOLON">::</span><span id="local_ps_686"><span class="LIDENT">ps</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p_internal_687"><span class="LIDENT">p_internal</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p_685"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>        <span class="MATCH">match</span> <span class="LPAREN">(</span><span class="LIDENT">underlying</span> <a href="#local_p_internal_687"><span class="LIDENT">p_internal</span></a><span class="RPAREN">)</span><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span id="local_v_688"><span class="LIDENT">v</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="#local_collect_already_resolved_promises_681"><span class="LIDENT">collect_already_resolved_promises</span></a> <span class="LPAREN">(</span><a href="#local_v_688"><span class="LIDENT">v</span></a><span class="COLONCOLON">::</span><a href="#local_results_682"><span class="LIDENT">results</span></a><span class="RPAREN">)</span> <a href="#local_pending_683"><span class="LIDENT">pending</span></a> <a href="#local_ps_686"><span class="LIDENT">ps</span></a><span class="EOL">
</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UNDERSCORE">_</span> <span class="AS">as</span> <span id="local_result_689"><span class="LIDENT">result</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LIDENT">to_public_promise</span> <span class="LBRACE">{</span><span class="LIDENT">state</span> <span class="EQUAL">=</span> <a href="#local_result_689"><span class="LIDENT">result</span></a><span class="RBRACE">}</span><span class="EOL">
</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="#local_collect_already_resolved_promises_681"><span class="LIDENT">collect_already_resolved_promises</span></a> <a href="#local_results_682"><span class="LIDENT">results</span></a> <span class="LPAREN">(</span><a href="#local_p_685"><span class="LIDENT">p</span></a><span class="COLONCOLON">::</span><a href="#local_pending_683"><span class="LIDENT">pending</span></a><span class="RPAREN">)</span> <a href="#local_ps_686"><span class="LIDENT">ps</span></a><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="REC">rec</span> <span id="local_check_for_already_resolved_promises_690"><span class="LIDENT">check_for_already_resolved_promises</span></span> <span id="local_pending_acc_691"><span class="LIDENT">pending_acc</span></span> <span id="local_ps'_692"><span class="LIDENT">ps'</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="MATCH">match</span> <a href="#local_ps'_692"><span class="LIDENT">ps'</span></a> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_p_693"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">new_pending</span> <span class="LABEL">~how_to_cancel:</span><span class="LPAREN">(</span><span class="LIDENT">propagate_cancel_to_several</span> <a href="#local_ps_670"><span class="LIDENT">ps</span></a><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_callback_694"><span class="LIDENT">callback</span></span> <span id="local__result_695"><span class="LIDENT">_result</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">State_may_now_be_pending_proxy</span> <span id="local_p_696"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">may_now_be_proxy</span> <a href="#local_p_693"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_p_697"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">underlying</span> <a href="#local_p_696"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>          <span class="LET">let</span> <span class="UIDENT">State_may_have_changed</span> <span id="local_p_698"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <a href="#local_finish_671"><span class="LIDENT">finish</span></a> <a href="#local_p_697"><span class="LIDENT">p</span></a> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <a href="#local_ps_670"><span class="LIDENT">ps</span></a> <span class="IN">in</span><span class="EOL">
</span>          <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a> <a href="#local_p_698"><span class="LIDENT">p</span></a><span class="EOL">
</span>        <span class="IN">in</span><span class="EOL">
</span>        <span class="LIDENT">add_explicitly_removable_callback_to_each_of</span> <a href="#local_ps_670"><span class="LIDENT">ps</span></a> <a href="#local_callback_694"><span class="LIDENT">callback</span></a><span class="SEMI">;</span><span class="EOL">
</span><span class="EOL">
</span>        <span class="LIDENT">to_public_promise</span> <a href="#local_p_693"><span class="LIDENT">p</span></a><span class="EOL">
</span><span class="EOL">
</span>      <span class="BAR">|</span> <span id="local_p_699"><span class="LIDENT">p</span></span><span class="COLONCOLON">::</span><span id="local_ps'_700"><span class="LIDENT">ps'</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p_internal_701"><span class="LIDENT">p_internal</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p_699"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>        <span class="MATCH">match</span> <span class="LPAREN">(</span><span class="LIDENT">underlying</span> <a href="#local_p_internal_701"><span class="LIDENT">p_internal</span></a><span class="RPAREN">)</span><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span id="local_v_702"><span class="LIDENT">v</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="#local_collect_already_resolved_promises_681"><span class="LIDENT">collect_already_resolved_promises</span></a> <span class="LBRACKET">[</span><a href="#local_v_702"><span class="LIDENT">v</span></a><span class="RBRACKET">]</span> <a href="#local_pending_acc_691"><span class="LIDENT">pending_acc</span></a> <a href="#local_ps'_700"><span class="LIDENT">ps'</span></a><span class="EOL">
</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UNDERSCORE">_</span> <span class="AS">as</span> <span id="local_result_703"><span class="LIDENT">result</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LIDENT">to_public_promise</span> <span class="LBRACE">{</span><span class="LIDENT">state</span> <span class="EQUAL">=</span> <a href="#local_result_703"><span class="LIDENT">result</span></a><span class="RBRACE">}</span><span class="EOL">
</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="#local_check_for_already_resolved_promises_690"><span class="LIDENT">check_for_already_resolved_promises</span></a> <span class="LPAREN">(</span><a href="#local_p_699"><span class="LIDENT">p</span></a><span class="COLONCOLON">::</span><a href="#local_pending_acc_691"><span class="LIDENT">pending_acc</span></a><span class="RPAREN">)</span> <a href="#local_ps'_700"><span class="LIDENT">ps'</span></a><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_p_704"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <a href="#local_check_for_already_resolved_promises_690"><span class="LIDENT">check_for_already_resolved_promises</span></a> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <a href="#local_ps_670"><span class="LIDENT">ps</span></a> <span class="IN">in</span><span class="EOL">
</span>    <a href="#local_p_704"><span class="LIDENT">p</span></a><span class="EOL">
</span><span class="END">end</span></span><span class="EOL">
</span><span class="INCLUDE">include</span> <span class="UIDENT">Concurrent_composition</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span id="module-Miscellaneous"><span class="MODULE">module</span> <span class="UIDENT">Miscellaneous</span> <span class="COLON">:</span><span class="EOL">
</span><span class="SIG">sig</span><span class="EOL">
</span>  <span class="COMMENT">(* Promise state query *)</span><span class="EOL">
</span>  <span id="module-Miscellaneous.type-state"><span class="TYPE">type</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">state</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span id="module-Miscellaneous.type-state.constructor-Return"><span id="type-state.constructor-Return"><span class="BAR">|</span> <span class="UIDENT">Return</span> <span class="OF">of</span> <span class="QUOTE">'</span><span class="LIDENT">a</span></span></span><span class="EOL">
</span>    <span id="module-Miscellaneous.type-state.constructor-Fail"><span id="type-state.constructor-Fail"><span class="BAR">|</span> <span class="UIDENT">Fail</span> <span class="OF">of</span> <span class="LIDENT">exn</span></span></span><span class="EOL">
</span>    <span id="module-Miscellaneous.type-state.constructor-Sleep"><span id="type-state.constructor-Sleep"><span class="BAR">|</span> <span class="UIDENT">Sleep</span></span></span></span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Miscellaneous.val-state"><span class="VAL">val</span> <span class="LIDENT">state</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">state</span></span><span class="EOL">
</span>  <span id="module-Miscellaneous.val-is_sleeping"><span class="VAL">val</span> <span class="LIDENT">is_sleeping</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">bool</span></span><span class="EOL">
</span>  <span id="module-Miscellaneous.val-debug_state_is"><span class="VAL">val</span> <span class="LIDENT">debug_state_is</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">state</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">bool</span> <span class="LIDENT">t</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Function lifters *)</span><span class="EOL">
</span>  <span id="module-Miscellaneous.val-apply"><span class="VAL">val</span> <span class="LIDENT">apply</span> <span class="COLON">:</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">b</span> <span class="LIDENT">t</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">b</span> <span class="LIDENT">t</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Miscellaneous.val-wrap"><span class="VAL">val</span> <span class="LIDENT">wrap</span> <span class="COLON">:</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="LIDENT">unit</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">b</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="QUOTE">'</span><span class="LIDENT">b</span> <span class="LIDENT">t</span></span><span class="EOL">
</span>  <span id="module-Miscellaneous.val-wrap1"><span class="VAL">val</span> <span class="LIDENT">wrap1</span> <span class="COLON">:</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a1</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">b</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a1</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">b</span> <span class="LIDENT">t</span><span class="RPAREN">)</span></span><span class="EOL">
</span>  <span id="module-Miscellaneous.val-wrap2"><span class="VAL">val</span> <span class="LIDENT">wrap2</span> <span class="COLON">:</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a1</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a2</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">b</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a1</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a2</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">b</span> <span class="LIDENT">t</span><span class="RPAREN">)</span></span><span class="EOL">
</span>  <span id="module-Miscellaneous.val-wrap3"><span class="VAL">val</span> <span class="LIDENT">wrap3</span> <span class="COLON">:</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a1</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a2</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a3</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">b</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a1</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a2</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a3</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">b</span> <span class="LIDENT">t</span><span class="RPAREN">)</span></span><span class="EOL">
</span>  <span id="module-Miscellaneous.val-wrap4"><span class="VAL">val</span> <span class="LIDENT">wrap4</span> <span class="COLON">:</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a1</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a2</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a3</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a4</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">b</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a1</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a2</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a3</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a4</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">b</span> <span class="LIDENT">t</span><span class="RPAREN">)</span></span><span class="EOL">
</span>  <span id="module-Miscellaneous.val-wrap5"><span class="VAL">val</span> <span class="LIDENT">wrap5</span> <span class="COLON">:</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a1</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a2</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a3</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a4</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a5</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">b</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a1</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a2</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a3</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a4</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a5</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">b</span> <span class="LIDENT">t</span><span class="RPAREN">)</span></span><span class="EOL">
</span>  <span id="module-Miscellaneous.val-wrap6"><span class="VAL">val</span> <span class="LIDENT">wrap6</span> <span class="COLON">:</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a1</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a2</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a3</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a4</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a5</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a6</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">b</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a1</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a2</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a3</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a4</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a5</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a6</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">b</span> <span class="LIDENT">t</span><span class="RPAREN">)</span></span><span class="EOL">
</span>  <span id="module-Miscellaneous.val-wrap7"><span class="VAL">val</span> <span class="LIDENT">wrap7</span> <span class="COLON">:</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a1</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a2</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a3</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a4</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a5</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a6</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a7</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">b</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a1</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a2</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a3</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a4</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a5</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a6</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a7</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">b</span> <span class="LIDENT">t</span><span class="RPAREN">)</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Paused promises *)</span><span class="EOL">
</span>  <span id="module-Miscellaneous.val-pause"><span class="VAL">val</span> <span class="LIDENT">pause</span> <span class="COLON">:</span> <span class="LIDENT">unit</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span> <span class="LIDENT">t</span></span><span class="EOL">
</span>  <span id="module-Miscellaneous.val-wakeup_paused"><span class="VAL">val</span> <span class="LIDENT">wakeup_paused</span> <span class="COLON">:</span> <span class="LIDENT">unit</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span></span><span class="EOL">
</span>  <span id="module-Miscellaneous.val-paused_count"><span class="VAL">val</span> <span class="LIDENT">paused_count</span> <span class="COLON">:</span> <span class="LIDENT">unit</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">int</span></span><span class="EOL">
</span>  <span id="module-Miscellaneous.val-register_pause_notifier"><span class="VAL">val</span> <span class="LIDENT">register_pause_notifier</span> <span class="COLON">:</span> <span class="LPAREN">(</span><span class="LIDENT">int</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span></span><span class="EOL">
</span>  <span id="module-Miscellaneous.val-abandon_paused"><span class="VAL">val</span> <span class="LIDENT">abandon_paused</span> <span class="COLON">:</span> <span class="LIDENT">unit</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Internal interface for other modules in Lwt *)</span><span class="EOL">
</span>  <span id="module-Miscellaneous.val-poll"><span class="VAL">val</span> <span class="LIDENT">poll</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">option</span></span><span class="EOL">
</span><span class="END">end</span> <span class="EQUAL">=</span><span class="EOL">
</span><span class="STRUCT">struct</span><span class="EOL">
</span>  <span id="module-Miscellaneous.type-state"><span class="TYPE">type</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">state</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span id="module-Miscellaneous.type-state.constructor-Return"><span class="BAR">|</span> <span class="UIDENT">Return</span> <span class="OF">of</span> <span class="QUOTE">'</span><span class="LIDENT">a</span></span><span class="EOL">
</span>    <span id="module-Miscellaneous.type-state.constructor-Fail"><span class="BAR">|</span> <span class="UIDENT">Fail</span> <span class="OF">of</span> <span class="LIDENT">exn</span></span><span class="EOL">
</span>    <span id="module-Miscellaneous.type-state.constructor-Sleep"><span class="BAR">|</span> <span class="UIDENT">Sleep</span></span></span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Miscellaneous.val-reraise"><span class="EXTERNAL">external</span> <span class="LIDENT">reraise</span> <span class="COLON">:</span> <span class="LIDENT">exn</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="EQUAL">=</span> <span class="STRING">&quot;%reraise&quot;</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Miscellaneous.val-state"><span class="LIDENT">state</span></span> <span id="local_p_705"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p_706"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p_705"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="MATCH">match</span> <span class="LPAREN">(</span><span class="LIDENT">underlying</span> <a href="#local_p_706"><span class="LIDENT">p</span></a><span class="RPAREN">)</span><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span id="local_v_707"><span class="LIDENT">v</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Return</span> <a href="#local_v_707"><span class="LIDENT">v</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span id="local_exn_708"><span class="LIDENT">exn</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Fail</span> <a href="#local_exn_708"><span class="LIDENT">exn</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Sleep</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Miscellaneous.val-debug_state_is"><span class="LIDENT">debug_state_is</span></span> <span id="local_expected_state_709"><span class="LIDENT">expected_state</span></span> <span id="local_p_710"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">return</span> <span class="LPAREN">(</span><span class="LIDENT">state</span> <a href="#local_p_710"><span class="LIDENT">p</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <a href="#local_expected_state_709"><span class="LIDENT">expected_state</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Miscellaneous.val-is_sleeping"><span class="LIDENT">is_sleeping</span></span> <span id="local_p_711"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p_712"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p_711"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="MATCH">match</span> <span class="LPAREN">(</span><span class="LIDENT">underlying</span> <a href="#local_p_712"><span class="LIDENT">p</span></a><span class="RPAREN">)</span><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="FALSE">false</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="FALSE">false</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="TRUE">true</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Miscellaneous.val-poll"><span class="LIDENT">poll</span></span> <span id="local_p_713"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="UIDENT">Internal</span> <span id="local_p_714"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">to_internal_promise</span> <a href="#local_p_713"><span class="LIDENT">p</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="MATCH">match</span> <span class="LPAREN">(</span><span class="LIDENT">underlying</span> <a href="#local_p_714"><span class="LIDENT">p</span></a><span class="RPAREN">)</span><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span id="local_e_715"><span class="LIDENT">e</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">reraise</span> <a href="#local_e_715"><span class="LIDENT">e</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Fulfilled</span> <span id="local_v_716"><span class="LIDENT">v</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Some</span> <a href="#local_v_716"><span class="LIDENT">v</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Pending</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">None</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Miscellaneous.val-apply"><span class="LIDENT">apply</span></span> <span id="local_f_717"><span class="LIDENT">f</span></span> <span id="local_x_718"><span class="LIDENT">x</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="TRY">try</span> <a href="#local_f_717"><span class="LIDENT">f</span></a> <a href="#local_x_718"><span class="LIDENT">x</span></a> <span class="WITH">with</span> <span id="local_exn_719"><span class="LIDENT">exn</span></span> <span class="WHEN">when</span> <span class="UIDENT">Exception_filter</span><span class="DOT">.</span><span class="LIDENT">run</span> <a href="#local_exn_719"><span class="LIDENT">exn</span></a> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">fail</span> <a href="#local_exn_719"><span class="LIDENT">exn</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Miscellaneous.val-wrap"><span class="LIDENT">wrap</span></span> <span id="local_f_720"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="TRY">try</span> <span class="LIDENT">return</span> <span class="LPAREN">(</span><a href="#local_f_720"><span class="LIDENT">f</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="WITH">with</span> <span id="local_exn_721"><span class="LIDENT">exn</span></span> <span class="WHEN">when</span> <span class="UIDENT">Exception_filter</span><span class="DOT">.</span><span class="LIDENT">run</span> <a href="#local_exn_721"><span class="LIDENT">exn</span></a> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">fail</span> <a href="#local_exn_721"><span class="LIDENT">exn</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Miscellaneous.val-wrap1"><span class="LIDENT">wrap1</span></span> <span id="local_f_722"><span class="LIDENT">f</span></span> <span id="local_x1_723"><span class="LIDENT">x1</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="TRY">try</span> <span class="LIDENT">return</span> <span class="LPAREN">(</span><a href="#local_f_722"><span class="LIDENT">f</span></a> <a href="#local_x1_723"><span class="LIDENT">x1</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="WITH">with</span> <span id="local_exn_724"><span class="LIDENT">exn</span></span> <span class="WHEN">when</span> <span class="UIDENT">Exception_filter</span><span class="DOT">.</span><span class="LIDENT">run</span> <a href="#local_exn_724"><span class="LIDENT">exn</span></a> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">fail</span> <a href="#local_exn_724"><span class="LIDENT">exn</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Miscellaneous.val-wrap2"><span class="LIDENT">wrap2</span></span> <span id="local_f_725"><span class="LIDENT">f</span></span> <span id="local_x1_726"><span class="LIDENT">x1</span></span> <span id="local_x2_727"><span class="LIDENT">x2</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="TRY">try</span> <span class="LIDENT">return</span> <span class="LPAREN">(</span><a href="#local_f_725"><span class="LIDENT">f</span></a> <a href="#local_x1_726"><span class="LIDENT">x1</span></a> <a href="#local_x2_727"><span class="LIDENT">x2</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="WITH">with</span> <span id="local_exn_728"><span class="LIDENT">exn</span></span> <span class="WHEN">when</span> <span class="UIDENT">Exception_filter</span><span class="DOT">.</span><span class="LIDENT">run</span> <a href="#local_exn_728"><span class="LIDENT">exn</span></a> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">fail</span> <a href="#local_exn_728"><span class="LIDENT">exn</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Miscellaneous.val-wrap3"><span class="LIDENT">wrap3</span></span> <span id="local_f_729"><span class="LIDENT">f</span></span> <span id="local_x1_730"><span class="LIDENT">x1</span></span> <span id="local_x2_731"><span class="LIDENT">x2</span></span> <span id="local_x3_732"><span class="LIDENT">x3</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="TRY">try</span> <span class="LIDENT">return</span> <span class="LPAREN">(</span><a href="#local_f_729"><span class="LIDENT">f</span></a> <a href="#local_x1_730"><span class="LIDENT">x1</span></a> <a href="#local_x2_731"><span class="LIDENT">x2</span></a> <a href="#local_x3_732"><span class="LIDENT">x3</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="WITH">with</span> <span id="local_exn_733"><span class="LIDENT">exn</span></span> <span class="WHEN">when</span> <span class="UIDENT">Exception_filter</span><span class="DOT">.</span><span class="LIDENT">run</span> <a href="#local_exn_733"><span class="LIDENT">exn</span></a> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">fail</span> <a href="#local_exn_733"><span class="LIDENT">exn</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Miscellaneous.val-wrap4"><span class="LIDENT">wrap4</span></span> <span id="local_f_734"><span class="LIDENT">f</span></span> <span id="local_x1_735"><span class="LIDENT">x1</span></span> <span id="local_x2_736"><span class="LIDENT">x2</span></span> <span id="local_x3_737"><span class="LIDENT">x3</span></span> <span id="local_x4_738"><span class="LIDENT">x4</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="TRY">try</span> <span class="LIDENT">return</span> <span class="LPAREN">(</span><a href="#local_f_734"><span class="LIDENT">f</span></a> <a href="#local_x1_735"><span class="LIDENT">x1</span></a> <a href="#local_x2_736"><span class="LIDENT">x2</span></a> <a href="#local_x3_737"><span class="LIDENT">x3</span></a> <a href="#local_x4_738"><span class="LIDENT">x4</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="WITH">with</span> <span id="local_exn_739"><span class="LIDENT">exn</span></span> <span class="WHEN">when</span> <span class="UIDENT">Exception_filter</span><span class="DOT">.</span><span class="LIDENT">run</span> <a href="#local_exn_739"><span class="LIDENT">exn</span></a> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">fail</span> <a href="#local_exn_739"><span class="LIDENT">exn</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Miscellaneous.val-wrap5"><span class="LIDENT">wrap5</span></span> <span id="local_f_740"><span class="LIDENT">f</span></span> <span id="local_x1_741"><span class="LIDENT">x1</span></span> <span id="local_x2_742"><span class="LIDENT">x2</span></span> <span id="local_x3_743"><span class="LIDENT">x3</span></span> <span id="local_x4_744"><span class="LIDENT">x4</span></span> <span id="local_x5_745"><span class="LIDENT">x5</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="TRY">try</span> <span class="LIDENT">return</span> <span class="LPAREN">(</span><a href="#local_f_740"><span class="LIDENT">f</span></a> <a href="#local_x1_741"><span class="LIDENT">x1</span></a> <a href="#local_x2_742"><span class="LIDENT">x2</span></a> <a href="#local_x3_743"><span class="LIDENT">x3</span></a> <a href="#local_x4_744"><span class="LIDENT">x4</span></a> <a href="#local_x5_745"><span class="LIDENT">x5</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="WITH">with</span> <span id="local_exn_746"><span class="LIDENT">exn</span></span> <span class="WHEN">when</span> <span class="UIDENT">Exception_filter</span><span class="DOT">.</span><span class="LIDENT">run</span> <a href="#local_exn_746"><span class="LIDENT">exn</span></a> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">fail</span> <a href="#local_exn_746"><span class="LIDENT">exn</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Miscellaneous.val-wrap6"><span class="LIDENT">wrap6</span></span> <span id="local_f_747"><span class="LIDENT">f</span></span> <span id="local_x1_748"><span class="LIDENT">x1</span></span> <span id="local_x2_749"><span class="LIDENT">x2</span></span> <span id="local_x3_750"><span class="LIDENT">x3</span></span> <span id="local_x4_751"><span class="LIDENT">x4</span></span> <span id="local_x5_752"><span class="LIDENT">x5</span></span> <span id="local_x6_753"><span class="LIDENT">x6</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="TRY">try</span> <span class="LIDENT">return</span> <span class="LPAREN">(</span><a href="#local_f_747"><span class="LIDENT">f</span></a> <a href="#local_x1_748"><span class="LIDENT">x1</span></a> <a href="#local_x2_749"><span class="LIDENT">x2</span></a> <a href="#local_x3_750"><span class="LIDENT">x3</span></a> <a href="#local_x4_751"><span class="LIDENT">x4</span></a> <a href="#local_x5_752"><span class="LIDENT">x5</span></a> <a href="#local_x6_753"><span class="LIDENT">x6</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="WITH">with</span> <span id="local_exn_754"><span class="LIDENT">exn</span></span> <span class="WHEN">when</span> <span class="UIDENT">Exception_filter</span><span class="DOT">.</span><span class="LIDENT">run</span> <a href="#local_exn_754"><span class="LIDENT">exn</span></a> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">fail</span> <a href="#local_exn_754"><span class="LIDENT">exn</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Miscellaneous.val-wrap7"><span class="LIDENT">wrap7</span></span> <span id="local_f_755"><span class="LIDENT">f</span></span> <span id="local_x1_756"><span class="LIDENT">x1</span></span> <span id="local_x2_757"><span class="LIDENT">x2</span></span> <span id="local_x3_758"><span class="LIDENT">x3</span></span> <span id="local_x4_759"><span class="LIDENT">x4</span></span> <span id="local_x5_760"><span class="LIDENT">x5</span></span> <span id="local_x6_761"><span class="LIDENT">x6</span></span> <span id="local_x7_762"><span class="LIDENT">x7</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="TRY">try</span> <span class="LIDENT">return</span> <span class="LPAREN">(</span><a href="#local_f_755"><span class="LIDENT">f</span></a> <a href="#local_x1_756"><span class="LIDENT">x1</span></a> <a href="#local_x2_757"><span class="LIDENT">x2</span></a> <a href="#local_x3_758"><span class="LIDENT">x3</span></a> <a href="#local_x4_759"><span class="LIDENT">x4</span></a> <a href="#local_x5_760"><span class="LIDENT">x5</span></a> <a href="#local_x6_761"><span class="LIDENT">x6</span></a> <a href="#local_x7_762"><span class="LIDENT">x7</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="WITH">with</span> <span id="local_exn_763"><span class="LIDENT">exn</span></span> <span class="WHEN">when</span> <span class="UIDENT">Exception_filter</span><span class="DOT">.</span><span class="LIDENT">run</span> <a href="#local_exn_763"><span class="LIDENT">exn</span></a> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">fail</span> <a href="#local_exn_763"><span class="LIDENT">exn</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Miscellaneous.val-pause_hook"><span class="LIDENT">pause_hook</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ref"><span class="LIDENT">ref</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Miscellaneous.val-paused"><span class="LIDENT">paused</span></span> <span class="EQUAL">=</span> <span class="UIDENT">Lwt_sequence</span><span class="DOT">.</span><span class="LIDENT">create</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Miscellaneous.val-{paused_count}1/shadowed/(lwt-src-lwt-lwt.ml)"><span class="LIDENT">paused_count</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ref"><span class="LIDENT">ref</span></a> <span class="INT">0</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Miscellaneous.val-pause"><span class="LIDENT">pause</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_p_764"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">add_task_r</span> <span class="LIDENT">paused</span> <span class="IN">in</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-incr"><span class="LIDENT">incr</span></a> <span class="LIDENT">paused_count</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><span class="LIDENT">pause_hook</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><span class="LIDENT">paused_count</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="#local_p_764"><span class="LIDENT">p</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Miscellaneous.val-wakeup_paused"><span class="LIDENT">wakeup_paused</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="IF">if</span> <span class="UIDENT">Lwt_sequence</span><span class="DOT">.</span><span class="LIDENT">is_empty</span> <span class="LIDENT">paused</span> <span class="THEN">then</span><span class="EOL">
</span>      <span class="LIDENT">paused_count</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <span class="INT">0</span><span class="EOL">
</span>    <span class="ELSE">else</span> <span class="BEGIN">begin</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_tmp_765"><span class="LIDENT">tmp</span></span> <span class="EQUAL">=</span> <span class="UIDENT">Lwt_sequence</span><span class="DOT">.</span><span class="LIDENT">create</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>      <span class="UIDENT">Lwt_sequence</span><span class="DOT">.</span><span class="LIDENT">transfer_r</span> <span class="LIDENT">paused</span> <a href="#local_tmp_765"><span class="LIDENT">tmp</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <span class="LIDENT">paused_count</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <span class="INT">0</span><span class="SEMI">;</span><span class="EOL">
</span>      <span class="UIDENT">Lwt_sequence</span><span class="DOT">.</span><span class="LIDENT">iter_l</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_r_766"><span class="LIDENT">r</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">wakeup</span> <a href="#local_r_766"><span class="LIDENT">r</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="RPAREN">)</span> <a href="#local_tmp_765"><span class="LIDENT">tmp</span></a><span class="EOL">
</span>    <span class="END">end</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Miscellaneous.val-register_pause_notifier"><span class="LIDENT">register_pause_notifier</span></span> <span id="local_f_767"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span> <span class="LIDENT">pause_hook</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="#local_f_767"><span class="LIDENT">f</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Miscellaneous.val-abandon_paused"><span class="LIDENT">abandon_paused</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="UIDENT">Lwt_sequence</span><span class="DOT">.</span><span class="LIDENT">clear</span> <span class="LIDENT">paused</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">paused_count</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <span class="INT">0</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Miscellaneous.val-paused_count"><span class="LIDENT">paused_count</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><span class="LIDENT">paused_count</span><span class="EOL">
</span><span class="END">end</span></span><span class="EOL">
</span><span class="INCLUDE">include</span> <span class="UIDENT">Miscellaneous</span><span class="EOL">
</span><span class="EOL">
</span><span id="module-Let_syntax"><span class="MODULE">module</span> <span class="UIDENT">Let_syntax</span> <span class="EQUAL">=</span><span class="EOL">
</span><span class="STRUCT">struct</span><span class="EOL">
</span>  <span id="module-Let_syntax.module-Let_syntax"><span class="MODULE">module</span> <span class="UIDENT">Let_syntax</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="STRUCT">struct</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="module-Let_syntax.module-Let_syntax.val-return"><span class="LIDENT">return</span></span> <span class="EQUAL">=</span> <span class="LIDENT">return</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="module-Let_syntax.module-Let_syntax.val-map"><span class="LIDENT">map</span></span> <span id="local_t_768"><span class="LIDENT">t</span></span> <span class="TILDE">~</span><span id="local_f_769"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span> <span class="LIDENT">map</span> <a href="#local_f_769"><span class="LIDENT">f</span></a> <a href="#local_t_768"><span class="LIDENT">t</span></a><span class="EOL">
</span>    <span class="LET">let</span> <span id="module-Let_syntax.module-Let_syntax.val-bind"><span class="LIDENT">bind</span></span> <span id="local_t_770"><span class="LIDENT">t</span></span> <span class="TILDE">~</span><span id="local_f_771"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span> <span class="LIDENT">bind</span> <a href="#local_t_770"><span class="LIDENT">t</span></a> <a href="#local_f_771"><span class="LIDENT">f</span></a><span class="EOL">
</span>    <span class="LET">let</span> <span id="module-Let_syntax.module-Let_syntax.val-both"><span class="LIDENT">both</span></span> <span class="EQUAL">=</span> <span class="LIDENT">both</span><span class="EOL">
</span><span class="EOL">
</span>    <span id="module-Let_syntax.module-Let_syntax.module-Open_on_rhs"><span class="MODULE">module</span> <span class="UIDENT">Open_on_rhs</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="STRUCT">struct</span><span class="EOL">
</span>    <span class="END">end</span></span><span class="EOL">
</span>  <span class="END">end</span></span><span class="EOL">
</span><span class="END">end</span></span><span class="EOL">
</span><span class="EOL">
</span><span id="module-Infix"><span class="MODULE">module</span> <span class="UIDENT">Infix</span> <span class="EQUAL">=</span><span class="EOL">
</span><span class="STRUCT">struct</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Infix.val-(&gt;&gt;=)"><span class="LPAREN">(</span><span class="INFIXOP0">&gt;&gt;=</span><span class="RPAREN">)</span></span> <span class="EQUAL">=</span> <span class="LIDENT">bind</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Infix.val-(=&lt;&lt;)"><span class="LPAREN">(</span><span class="INFIXOP0">=&lt;&lt;</span><span class="RPAREN">)</span></span> <span id="local_f_772"><span class="LIDENT">f</span></span> <span id="local_p_773"><span class="LIDENT">p</span></span> <span class="EQUAL">=</span> <span class="LIDENT">bind</span> <a href="#local_p_773"><span class="LIDENT">p</span></a> <a href="#local_f_772"><span class="LIDENT">f</span></a><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Infix.val-(&gt;|=)"><span class="LPAREN">(</span><span class="INFIXOP0">&gt;|=</span><span class="RPAREN">)</span></span> <span id="local_p_774"><span class="LIDENT">p</span></span> <span id="local_f_775"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span> <span class="LIDENT">map</span> <a href="#local_f_775"><span class="LIDENT">f</span></a> <a href="#local_p_774"><span class="LIDENT">p</span></a><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Infix.val-(=|&lt;)"><span class="LPAREN">(</span><span class="INFIXOP0">=|&lt;</span><span class="RPAREN">)</span></span> <span class="EQUAL">=</span> <span class="LIDENT">map</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Infix.val-(&lt;&amp;&gt;)"><span class="LPAREN">(</span><span class="INFIXOP0">&lt;&amp;&gt;</span><span class="RPAREN">)</span></span> <span id="local_p_776"><span class="LIDENT">p</span></span> <span id="local_p'_777"><span class="LIDENT">p'</span></span> <span class="EQUAL">=</span> <span class="LIDENT">join</span> <span class="LBRACKET">[</span><a href="#local_p_776"><span class="LIDENT">p</span></a><span class="SEMI">;</span> <a href="#local_p'_777"><span class="LIDENT">p'</span></a><span class="RBRACKET">]</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Infix.val-(&lt;?&gt;)"><span class="LPAREN">(</span><span class="INFIXOP0">&lt;?&gt;</span><span class="RPAREN">)</span></span> <span id="local_p_778"><span class="LIDENT">p</span></span> <span id="local_p'_779"><span class="LIDENT">p'</span></span> <span class="EQUAL">=</span> <span class="LIDENT">choose</span> <span class="LBRACKET">[</span><a href="#local_p_778"><span class="LIDENT">p</span></a><span class="SEMI">;</span> <a href="#local_p'_779"><span class="LIDENT">p'</span></a><span class="RBRACKET">]</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="INCLUDE">include</span> <span class="UIDENT">Let_syntax</span><span class="EOL">
</span><span class="END">end</span></span><span class="EOL">
</span><span class="INCLUDE">include</span> <span class="LPAREN">(</span> <span class="UIDENT">Infix</span> <span class="COLON">:</span> <span class="MODULE">module</span> <span class="TYPE">type</span> <span class="OF">of</span> <span class="UIDENT">Infix</span> <span class="WITH">with</span> <span class="MODULE">module</span> <span class="UIDENT">Let_syntax</span> <span class="COLONEQUAL">:=</span> <span class="UIDENT">Let_syntax</span><span class="DOT">.</span><span class="UIDENT">Let_syntax</span> <span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span id="module-Syntax"><span class="MODULE">module</span> <span class="UIDENT">Syntax</span> <span class="EQUAL">=</span><span class="EOL">
</span><span class="STRUCT">struct</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Syntax.val-(let*)"><span class="LPAREN">(</span><span class="LETOP">let*</span><span class="RPAREN">)</span></span> <span class="EQUAL">=</span> <span class="LIDENT">bind</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Syntax.val-(and*)"><span class="LPAREN">(</span><span class="ANDOP">and*</span><span class="RPAREN">)</span></span> <span class="EQUAL">=</span> <span class="LIDENT">both</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Syntax.val-(let+)"><span class="LPAREN">(</span><span class="LETOP">let+</span><span class="RPAREN">)</span></span> <span id="local_x_780"><span class="LIDENT">x</span></span> <span id="local_f_781"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span> <span class="LIDENT">map</span> <a href="#local_f_781"><span class="LIDENT">f</span></a> <a href="#local_x_780"><span class="LIDENT">x</span></a><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Syntax.val-(and+)"><span class="LPAREN">(</span><span class="ANDOP">and+</span><span class="RPAREN">)</span></span> <span class="EQUAL">=</span> <span class="LIDENT">both</span><span class="EOL">
</span><span class="END">end</span></span><span class="EOL">
</span></span></code></pre></body></html>
