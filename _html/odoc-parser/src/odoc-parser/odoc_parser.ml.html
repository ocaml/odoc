<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Source: odoc_parser.ml (odoc-parser.src.odoc-parser)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.css"/><meta name="generator" content="odoc %%VERSION%%"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/></head><body class="odoc-src"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">odoc-parser</a> &#x00BB; <a href="../index.html">Sources</a> &#x00BB; odoc-parser &#x00BB; odoc_parser.ml</nav><header class="odoc-preamble"><h1>Source file <code><span>odoc_parser.ml</span></code></h1></header><div class="odoc-tocs"><nav class="odoc-toc odoc-global-toc"><ul><li><a href="../../index.html">odoc-parser</a><ul><li>Library <code>odoc-parser</code><ul><li><a href="../../odoc-parser/Odoc_parser/index.html">Odoc_parser</a></li></ul></li><li><a href="../index.html">Sources</a><ul><li>odoc-parser<ul><li><a href="ast.ml.html">ast.ml</a></li><li><a href="compat.ml.html">compat.ml</a></li><li><a href="lexer.ml.html">lexer.ml</a></li><li><a href="loc.ml.html">loc.ml</a></li><li><a href="#" class="current_unit">odoc_parser.ml</a></li><li><a href="odoc_parser__.ml.html">odoc_parser__.ml</a></li><li><a href="parse_error.ml.html">parse_error.ml</a></li><li><a href="syntax.ml.html">syntax.ml</a></li><li><a href="token.ml.html">token.ml</a></li><li><a href="warning.ml.html">warning.ml</a></li></ul></li></ul></li></ul></li></ul></nav></div><pre class="source_container"><code class="source_line_column"><a id="L1" class="source_line" href="#L1">1</a>
<a id="L2" class="source_line" href="#L2">2</a>
<a id="L3" class="source_line" href="#L3">3</a>
<a id="L4" class="source_line" href="#L4">4</a>
<a id="L5" class="source_line" href="#L5">5</a>
<a id="L6" class="source_line" href="#L6">6</a>
<a id="L7" class="source_line" href="#L7">7</a>
<a id="L8" class="source_line" href="#L8">8</a>
<a id="L9" class="source_line" href="#L9">9</a>
<a id="L10" class="source_line" href="#L10">10</a>
<a id="L11" class="source_line" href="#L11">11</a>
<a id="L12" class="source_line" href="#L12">12</a>
<a id="L13" class="source_line" href="#L13">13</a>
<a id="L14" class="source_line" href="#L14">14</a>
<a id="L15" class="source_line" href="#L15">15</a>
<a id="L16" class="source_line" href="#L16">16</a>
<a id="L17" class="source_line" href="#L17">17</a>
<a id="L18" class="source_line" href="#L18">18</a>
<a id="L19" class="source_line" href="#L19">19</a>
<a id="L20" class="source_line" href="#L20">20</a>
<a id="L21" class="source_line" href="#L21">21</a>
<a id="L22" class="source_line" href="#L22">22</a>
<a id="L23" class="source_line" href="#L23">23</a>
<a id="L24" class="source_line" href="#L24">24</a>
<a id="L25" class="source_line" href="#L25">25</a>
<a id="L26" class="source_line" href="#L26">26</a>
<a id="L27" class="source_line" href="#L27">27</a>
<a id="L28" class="source_line" href="#L28">28</a>
<a id="L29" class="source_line" href="#L29">29</a>
<a id="L30" class="source_line" href="#L30">30</a>
<a id="L31" class="source_line" href="#L31">31</a>
<a id="L32" class="source_line" href="#L32">32</a>
<a id="L33" class="source_line" href="#L33">33</a>
<a id="L34" class="source_line" href="#L34">34</a>
<a id="L35" class="source_line" href="#L35">35</a>
<a id="L36" class="source_line" href="#L36">36</a>
<a id="L37" class="source_line" href="#L37">37</a>
<a id="L38" class="source_line" href="#L38">38</a>
<a id="L39" class="source_line" href="#L39">39</a>
<a id="L40" class="source_line" href="#L40">40</a>
<a id="L41" class="source_line" href="#L41">41</a>
<a id="L42" class="source_line" href="#L42">42</a>
<a id="L43" class="source_line" href="#L43">43</a>
<a id="L44" class="source_line" href="#L44">44</a>
<a id="L45" class="source_line" href="#L45">45</a>
<a id="L46" class="source_line" href="#L46">46</a>
<a id="L47" class="source_line" href="#L47">47</a>
<a id="L48" class="source_line" href="#L48">48</a>
<a id="L49" class="source_line" href="#L49">49</a>
<a id="L50" class="source_line" href="#L50">50</a>
<a id="L51" class="source_line" href="#L51">51</a>
<a id="L52" class="source_line" href="#L52">52</a>
<a id="L53" class="source_line" href="#L53">53</a>
<a id="L54" class="source_line" href="#L54">54</a>
<a id="L55" class="source_line" href="#L55">55</a>
<a id="L56" class="source_line" href="#L56">56</a>
<a id="L57" class="source_line" href="#L57">57</a>
<a id="L58" class="source_line" href="#L58">58</a>
<a id="L59" class="source_line" href="#L59">59</a>
<a id="L60" class="source_line" href="#L60">60</a>
<a id="L61" class="source_line" href="#L61">61</a>
<a id="L62" class="source_line" href="#L62">62</a>
<a id="L63" class="source_line" href="#L63">63</a>
<a id="L64" class="source_line" href="#L64">64</a>
<a id="L65" class="source_line" href="#L65">65</a>
<a id="L66" class="source_line" href="#L66">66</a>
<a id="L67" class="source_line" href="#L67">67</a>
<a id="L68" class="source_line" href="#L68">68</a>
<a id="L69" class="source_line" href="#L69">69</a>
<a id="L70" class="source_line" href="#L70">70</a>
<a id="L71" class="source_line" href="#L71">71</a>
<a id="L72" class="source_line" href="#L72">72</a>
<a id="L73" class="source_line" href="#L73">73</a>
<a id="L74" class="source_line" href="#L74">74</a>
<a id="L75" class="source_line" href="#L75">75</a>
<a id="L76" class="source_line" href="#L76">76</a>
<a id="L77" class="source_line" href="#L77">77</a>
<a id="L78" class="source_line" href="#L78">78</a>
<a id="L79" class="source_line" href="#L79">79</a>
<a id="L80" class="source_line" href="#L80">80</a>
<a id="L81" class="source_line" href="#L81">81</a>
<a id="L82" class="source_line" href="#L82">82</a>
<a id="L83" class="source_line" href="#L83">83</a>
<a id="L84" class="source_line" href="#L84">84</a>
<a id="L85" class="source_line" href="#L85">85</a>
<a id="L86" class="source_line" href="#L86">86</a>
<a id="L87" class="source_line" href="#L87">87</a>
<a id="L88" class="source_line" href="#L88">88</a>
<a id="L89" class="source_line" href="#L89">89</a>
<a id="L90" class="source_line" href="#L90">90</a>
<a id="L91" class="source_line" href="#L91">91</a>
<a id="L92" class="source_line" href="#L92">92</a>
<a id="L93" class="source_line" href="#L93">93</a>
<a id="L94" class="source_line" href="#L94">94</a>
<a id="L95" class="source_line" href="#L95">95</a>
<a id="L96" class="source_line" href="#L96">96</a>
<a id="L97" class="source_line" href="#L97">97</a>
<a id="L98" class="source_line" href="#L98">98</a>
<a id="L99" class="source_line" href="#L99">99</a>
<a id="L100" class="source_line" href="#L100">100</a>
<a id="L101" class="source_line" href="#L101">101</a>
<a id="L102" class="source_line" href="#L102">102</a>
<a id="L103" class="source_line" href="#L103">103</a>
<a id="L104" class="source_line" href="#L104">104</a>
<a id="L105" class="source_line" href="#L105">105</a>
<a id="L106" class="source_line" href="#L106">106</a>
<a id="L107" class="source_line" href="#L107">107</a>
<a id="L108" class="source_line" href="#L108">108</a>
<a id="L109" class="source_line" href="#L109">109</a>
<a id="L110" class="source_line" href="#L110">110</a>
<a id="L111" class="source_line" href="#L111">111</a>
<a id="L112" class="source_line" href="#L112">112</a>
<a id="L113" class="source_line" href="#L113">113</a>
<a id="L114" class="source_line" href="#L114">114</a>
<a id="L115" class="source_line" href="#L115">115</a>
<a id="L116" class="source_line" href="#L116">116</a>
<a id="L117" class="source_line" href="#L117">117</a>
<a id="L118" class="source_line" href="#L118">118</a>
<a id="L119" class="source_line" href="#L119">119</a>
<a id="L120" class="source_line" href="#L120">120</a>
<a id="L121" class="source_line" href="#L121">121</a>
</code><code class="source_code"><span><span id="module-Ast"><span class="MODULE">module</span> <span class="UIDENT">Ast</span> <span class="EQUAL">=</span> <a href="ast.ml.html"><span class="UIDENT">Ast</span></a></span><span class="EOL">
</span><span id="module-Loc"><span class="MODULE">module</span> <span class="UIDENT">Loc</span> <span class="EQUAL">=</span> <a href="loc.ml.html"><span class="UIDENT">Loc</span></a></span><span class="EOL">
</span><span id="module-Warning"><span class="MODULE">module</span> <span class="UIDENT">Warning</span> <span class="EQUAL">=</span> <a href="warning.ml.html"><span class="UIDENT">Warning</span></a></span><span class="EOL">
</span><span class="EOL">
</span><span id="type-t"><span class="TYPE">type</span> <span class="LIDENT">t</span> <span class="EQUAL">=</span> <span class="LBRACE">{</span><span class="EOL">
</span>  <span id="def_46"><span class="LIDENT">ast</span> <span class="COLON">:</span> <span class="UIDENT">Ast</span><span class="DOT">.</span><span class="LIDENT">t</span><span class="SEMI">;</span></span><span class="EOL">
</span>  <span id="def_49"><span class="LIDENT">warnings</span> <span class="COLON">:</span> <span class="UIDENT">Warning</span><span class="DOT">.</span><span class="LIDENT">t</span> <span class="LIDENT">list</span><span class="SEMI">;</span></span><span class="EOL">
</span>  <span id="def_47"><span class="LIDENT">reversed_newlines</span> <span class="COLON">:</span> <span class="LPAREN">(</span><span class="LIDENT">int</span> <span class="STAR">*</span> <span class="LIDENT">int</span><span class="RPAREN">)</span> <span class="LIDENT">list</span><span class="SEMI">;</span></span><span class="EOL">
</span>  <span id="def_48"><span class="LIDENT">original_pos</span> <span class="COLON">:</span> <a href="../../../ocaml-base-compiler/src/stdlib/lexing.ml.html#type-position"><span class="UIDENT">Lexing</span><span class="DOT">.</span><span class="LIDENT">position</span></a><span class="SEMI">;</span></span><span class="EOL">
</span><span class="RBRACE">}</span></span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* odoc uses an ocamllex lexer. The &quot;engine&quot; for such lexers is the standard
   [Lexing] module.

   As the [Lexing] module reads the input, it keeps track of only the byte
   offset into the input. It is normally the job of each particular lexer
   implementation to decide which character sequences count as newlines, and
   keep track of line/column locations. This is usually done by writing several
   extra regular expressions, and calling [Lexing.new_line] at the right time.

   Keeping track of newlines like this makes the odoc lexer somewhat too
   diffiult to read, however. To factor the aspect of keeping track of newlines
   fully out of the odoc lexer, instead of having it keep track of newlines as
   it's scanning the input, the input is pre-scanned before feeding it into the
   lexer. A table of all the newlines is assembled, and used to convert offsets
   into line/column pairs after the lexer emits tokens.

   [reversed_newlines ~input ~comment_location offset] returns a list of pairs
   of (line number * offset), allowing the easy conversion from the byte
   [offset], relative to the beginning of a comment, into a location, relative
   to the beginning of the file containing the comment. This can then be used
   to convert from byte offset to line number / column number - a Loc.point,
   and additionally for converting back from a Loc.point to a Lexing.position.
*)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-reversed_newlines"><span class="LIDENT">reversed_newlines</span></span> <span class="COLON">:</span> <span class="LIDENT">input</span><span class="COLON">:</span><span class="LIDENT">string</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="LIDENT">int</span> <span class="STAR">*</span> <span class="LIDENT">int</span><span class="RPAREN">)</span> <span class="LIDENT">list</span> <span class="EQUAL">=</span><span class="EOL">
</span> <span class="FUN">fun</span> <span class="TILDE">~</span><span id="local_input_1"><span class="LIDENT">input</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="REC">rec</span> <span id="local_find_newlines_2"><span class="LIDENT">find_newlines</span></span> <span id="local_line_number_3"><span class="LIDENT">line_number</span></span> <span id="local_input_index_4"><span class="LIDENT">input_index</span></span> <span id="local_newlines_accumulator_5"><span class="LIDENT">newlines_accumulator</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_input_index_4"><span class="LIDENT">input_index</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;=)"><span class="INFIXOP0">&gt;=</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/string.ml.html#val-length"><span class="UIDENT">String</span><span class="DOT">.</span><span class="LIDENT">length</span></a> <a href="#local_input_1"><span class="LIDENT">input</span></a> <span class="THEN">then</span> <a href="#local_newlines_accumulator_5"><span class="LIDENT">newlines_accumulator</span></a><span class="EOL">
</span>    <span class="ELSE">else</span> <span class="IF">if</span><span class="EOL">
</span>      <span class="COMMENT">(* This is good enough to detect CR-LF also. *)</span><span class="EOL">
</span>      <a href="#local_input_1"><span class="LIDENT">input</span></a><span class="DOT">.</span><span class="LBRACKET">[</span><a href="#local_input_index_4"><span class="LIDENT">input_index</span></a><span class="RBRACKET">]</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="CHAR">'\n'</span><span class="EOL">
</span>    <span class="THEN">then</span><span class="EOL">
</span>      <a href="#local_find_newlines_2"><span class="LIDENT">find_newlines</span></a> <span class="LPAREN">(</span><a href="#local_line_number_3"><span class="LIDENT">line_number</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <span class="INT">1</span><span class="RPAREN">)</span> <span class="LPAREN">(</span><a href="#local_input_index_4"><span class="LIDENT">input_index</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <span class="INT">1</span><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="LPAREN">(</span><span class="LPAREN">(</span><a href="#local_line_number_3"><span class="LIDENT">line_number</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <span class="INT">1</span><span class="COMMA">,</span> <a href="#local_input_index_4"><span class="LIDENT">input_index</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <span class="INT">1</span><span class="RPAREN">)</span> <span class="COLONCOLON">::</span> <a href="#local_newlines_accumulator_5"><span class="LIDENT">newlines_accumulator</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="ELSE">else</span> <a href="#local_find_newlines_2"><span class="LIDENT">find_newlines</span></a> <a href="#local_line_number_3"><span class="LIDENT">line_number</span></a> <span class="LPAREN">(</span><a href="#local_input_index_4"><span class="LIDENT">input_index</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <span class="INT">1</span><span class="RPAREN">)</span> <a href="#local_newlines_accumulator_5"><span class="LIDENT">newlines_accumulator</span></a><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <a href="#local_find_newlines_2"><span class="LIDENT">find_newlines</span></a> <span class="INT">1</span> <span class="INT">0</span> <span class="LBRACKET">[</span> <span class="LPAREN">(</span><span class="INT">1</span><span class="COMMA">,</span> <span class="INT">0</span><span class="RPAREN">)</span> <span class="RBRACKET">]</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* [offset_to_location] converts from an offset within the comment text, where
   [reversed_newlines] is the result of the above function and [comment_location]
   is the location of the comment within its file. The function is meant to be
   partially applied to its first two arguments, at which point it is passed to
   the lexer, so it can apply the table to its emitted tokens. *)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-offset_to_location"><span class="LIDENT">offset_to_location</span></span> <span class="COLON">:</span><span class="EOL">
</span>    <span class="LIDENT">reversed_newlines</span><span class="COLON">:</span><span class="LPAREN">(</span><span class="LIDENT">int</span> <span class="STAR">*</span> <span class="LIDENT">int</span><span class="RPAREN">)</span> <span class="LIDENT">list</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LIDENT">comment_location</span><span class="COLON">:</span><a href="../../../ocaml-base-compiler/src/stdlib/lexing.ml.html#type-position"><span class="UIDENT">Lexing</span><span class="DOT">.</span><span class="LIDENT">position</span></a> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LIDENT">int</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="UIDENT">Loc</span><span class="DOT">.</span><span class="LIDENT">point</span> <span class="EQUAL">=</span><span class="EOL">
</span> <span class="FUN">fun</span> <span class="TILDE">~</span><span id="local_reversed_newlines_6"><span class="LIDENT">reversed_newlines</span></span> <span class="TILDE">~</span><span id="local_comment_location_7"><span class="LIDENT">comment_location</span></span> <span id="local_byte_offset_8"><span class="LIDENT">byte_offset</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="REC">rec</span> <span id="local_scan_to_last_newline_9"><span class="LIDENT">scan_to_last_newline</span></span> <span id="local_reversed_newlines_prefix_10"><span class="LIDENT">reversed_newlines_prefix</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_reversed_newlines_prefix_10"><span class="LIDENT">reversed_newlines_prefix</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="MINUSGREATER">-&gt;</span> <span class="ASSERT">assert</span> <span class="FALSE">false</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="LPAREN">(</span><span id="local_line_in_comment_11"><span class="LIDENT">line_in_comment</span></span><span class="COMMA">,</span> <span id="local_line_start_offset_12"><span class="LIDENT">line_start_offset</span></span><span class="RPAREN">)</span> <span class="COLONCOLON">::</span> <span id="local_prefix_13"><span class="LIDENT">prefix</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="IF">if</span> <a href="#local_line_start_offset_12"><span class="LIDENT">line_start_offset</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <a href="#local_byte_offset_8"><span class="LIDENT">byte_offset</span></a> <span class="THEN">then</span> <a href="#local_scan_to_last_newline_9"><span class="LIDENT">scan_to_last_newline</span></a> <a href="#local_prefix_13"><span class="LIDENT">prefix</span></a><span class="EOL">
</span>        <span class="ELSE">else</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_column_in_comment_14"><span class="LIDENT">column_in_comment</span></span> <span class="EQUAL">=</span> <a href="#local_byte_offset_8"><span class="LIDENT">byte_offset</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <a href="#local_line_start_offset_12"><span class="LIDENT">line_start_offset</span></a> <span class="IN">in</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_line_in_file_15"><span class="LIDENT">line_in_file</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <a href="#local_line_in_comment_11"><span class="LIDENT">line_in_comment</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <a href="#local_comment_location_7"><span class="LIDENT">comment_location</span></a><span class="DOT">.</span><span class="UIDENT">Lexing</span><span class="DOT">.</span><span class="LIDENT">pos_lnum</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <span class="INT">1</span><span class="EOL">
</span>          <span class="IN">in</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_column_in_file_16"><span class="LIDENT">column_in_file</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>            <span class="IF">if</span> <a href="#local_line_in_comment_11"><span class="LIDENT">line_in_comment</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="INT">1</span> <span class="THEN">then</span><span class="EOL">
</span>              <a href="#local_column_in_comment_14"><span class="LIDENT">column_in_comment</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <a href="#local_comment_location_7"><span class="LIDENT">comment_location</span></a><span class="DOT">.</span><span class="UIDENT">Lexing</span><span class="DOT">.</span><span class="LIDENT">pos_cnum</span><span class="EOL">
</span>              <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <a href="#local_comment_location_7"><span class="LIDENT">comment_location</span></a><span class="DOT">.</span><span class="UIDENT">Lexing</span><span class="DOT">.</span><span class="LIDENT">pos_bol</span><span class="EOL">
</span>            <span class="ELSE">else</span> <a href="#local_column_in_comment_14"><span class="LIDENT">column_in_comment</span></a><span class="EOL">
</span>          <span class="IN">in</span><span class="EOL">
</span>          <span class="LBRACE">{</span> <span class="UIDENT">Loc</span><span class="DOT">.</span><span class="LIDENT">line</span> <span class="EQUAL">=</span> <a href="#local_line_in_file_15"><span class="LIDENT">line_in_file</span></a><span class="SEMI">;</span> <span class="LIDENT">column</span> <span class="EQUAL">=</span> <a href="#local_column_in_file_16"><span class="LIDENT">column_in_file</span></a> <span class="RBRACE">}</span><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <a href="#local_scan_to_last_newline_9"><span class="LIDENT">scan_to_last_newline</span></a> <a href="#local_reversed_newlines_6"><span class="LIDENT">reversed_newlines</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* Given a Loc.point and the result of [parse_comment], this function returns
   a valid Lexing.position *)</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-position_of_point"><span class="LIDENT">position_of_point</span></span> <span class="COLON">:</span> <span class="LIDENT">t</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Loc</span><span class="DOT">.</span><span class="LIDENT">point</span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/lexing.ml.html#type-position"><span class="UIDENT">Lexing</span><span class="DOT">.</span><span class="LIDENT">position</span></a> <span class="EQUAL">=</span><span class="EOL">
</span> <span class="FUN">fun</span> <span id="local_v_17"><span class="LIDENT">v</span></span> <span id="local_point_18"><span class="LIDENT">point</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="def_45"><span class="LBRACE">{</span> <span id="local_reversed_newlines_19"><span class="LIDENT">reversed_newlines</span></span><span class="SEMI">;</span> <span id="local_original_pos_20"><span class="LIDENT">original_pos</span></span><span class="SEMI">;</span> <span class="UNDERSCORE">_</span> <span class="RBRACE">}</span></span> <span class="EQUAL">=</span> <a href="#local_v_17"><span class="LIDENT">v</span></a> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_line_in_comment_21"><span class="LIDENT">line_in_comment</span></span> <span class="EQUAL">=</span> <a href="#local_point_18"><span class="LIDENT">point</span></a><span class="DOT">.</span><span class="UIDENT">Loc</span><span class="DOT">.</span><span class="LIDENT">line</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <a href="#local_original_pos_20"><span class="LIDENT">original_pos</span></a><span class="DOT">.</span><span class="LIDENT">pos_lnum</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <span class="INT">1</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="REC">rec</span> <span id="local_find_pos_bol_22"><span class="LIDENT">find_pos_bol</span></span> <span id="local_reversed_newlines_prefix_23"><span class="LIDENT">reversed_newlines_prefix</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_reversed_newlines_prefix_23"><span class="LIDENT">reversed_newlines_prefix</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="MINUSGREATER">-&gt;</span> <span class="ASSERT">assert</span> <span class="FALSE">false</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="LBRACKET">[</span> <span class="UNDERSCORE">_</span> <span class="RBRACKET">]</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_original_pos_20"><span class="LIDENT">original_pos</span></a><span class="DOT">.</span><span class="LIDENT">pos_bol</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="LPAREN">(</span><span id="local_line_number_24"><span class="LIDENT">line_number</span></span><span class="COMMA">,</span> <span id="local_line_start_offset_25"><span class="LIDENT">line_start_offset</span></span><span class="RPAREN">)</span> <span class="COLONCOLON">::</span> <span id="local_prefix_26"><span class="LIDENT">prefix</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="IF">if</span> <a href="#local_line_number_24"><span class="LIDENT">line_number</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <a href="#local_line_in_comment_21"><span class="LIDENT">line_in_comment</span></a> <span class="THEN">then</span> <a href="#local_find_pos_bol_22"><span class="LIDENT">find_pos_bol</span></a> <a href="#local_prefix_26"><span class="LIDENT">prefix</span></a><span class="EOL">
</span>        <span class="ELSE">else</span> <a href="#local_line_start_offset_25"><span class="LIDENT">line_start_offset</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <a href="#local_original_pos_20"><span class="LIDENT">original_pos</span></a><span class="DOT">.</span><span class="LIDENT">pos_cnum</span><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_pos_bol_27"><span class="LIDENT">pos_bol</span></span> <span class="EQUAL">=</span> <a href="#local_find_pos_bol_22"><span class="LIDENT">find_pos_bol</span></a> <a href="#local_reversed_newlines_19"><span class="LIDENT">reversed_newlines</span></a> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_pos_lnum_28"><span class="LIDENT">pos_lnum</span></span> <span class="EQUAL">=</span> <a href="#local_point_18"><span class="LIDENT">point</span></a><span class="DOT">.</span><span class="UIDENT">Loc</span><span class="DOT">.</span><span class="LIDENT">line</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_pos_cnum_29"><span class="LIDENT">pos_cnum</span></span> <span class="EQUAL">=</span> <a href="#local_point_18"><span class="LIDENT">point</span></a><span class="DOT">.</span><span class="LIDENT">column</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <a href="#local_pos_bol_27"><span class="LIDENT">pos_bol</span></a> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_pos_fname_30"><span class="LIDENT">pos_fname</span></span> <span class="EQUAL">=</span> <a href="#local_original_pos_20"><span class="LIDENT">original_pos</span></a><span class="DOT">.</span><span class="LIDENT">pos_fname</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LBRACE">{</span> <a href="#local_pos_bol_27"><span class="UIDENT">Lexing</span><span class="DOT">.</span><span class="LIDENT">pos_bol</span></a><span class="SEMI">;</span> <a href="#local_pos_lnum_28"><span class="LIDENT">pos_lnum</span></a><span class="SEMI">;</span> <a href="#local_pos_cnum_29"><span class="LIDENT">pos_cnum</span></a><span class="SEMI">;</span> <a href="#local_pos_fname_30"><span class="LIDENT">pos_fname</span></a> <span class="RBRACE">}</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* The main entry point for this module *)</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-parse_comment"><span class="LIDENT">parse_comment</span></span> <span class="TILDE">~</span><span id="local_location_31"><span class="LIDENT">location</span></span> <span class="TILDE">~</span><span id="local_text_32"><span class="LIDENT">text</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_warnings_33"><span class="LIDENT">warnings</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ref"><span class="LIDENT">ref</span></a> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_reversed_newlines_34"><span class="LIDENT">reversed_newlines</span></span> <span class="EQUAL">=</span> <span class="LIDENT">reversed_newlines</span> <span class="LABEL">~input:</span><a href="#local_text_32"><span class="LIDENT">text</span></a> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_token_stream_35"><span class="LIDENT">token_stream</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_lexbuf_36"><span class="LIDENT">lexbuf</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/lexing.ml.html#val-from_string"><span class="UIDENT">Lexing</span><span class="DOT">.</span><span class="LIDENT">from_string</span></a> <a href="#local_text_32"><span class="LIDENT">text</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_offset_to_location_37"><span class="LIDENT">offset_to_location</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LIDENT">offset_to_location</span> <span class="TILDE">~</span><a href="#local_reversed_newlines_34"><span class="LIDENT">reversed_newlines</span></a> <span class="LABEL">~comment_location:</span><a href="#local_location_31"><span class="LIDENT">location</span></a><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_input_38"><span class="LIDENT">input</span></span> <span class="COLON">:</span> <a href="lexer.ml.html#type-input"><span class="UIDENT">Lexer</span><span class="DOT">.</span><span class="LIDENT">input</span></a> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LBRACE">{</span> <span class="LIDENT">file</span> <span class="EQUAL">=</span> <a href="#local_location_31"><span class="LIDENT">location</span></a><span class="DOT">.</span><span class="UIDENT">Lexing</span><span class="DOT">.</span><span class="LIDENT">pos_fname</span><span class="SEMI">;</span> <a href="#local_offset_to_location_37"><span class="LIDENT">offset_to_location</span></a><span class="SEMI">;</span> <a href="#local_warnings_33"><span class="LIDENT">warnings</span></a><span class="SEMI">;</span> <a href="#local_lexbuf_36"><span class="LIDENT">lexbuf</span></a> <span class="RBRACE">}</span><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span>    <a href="../../../camlp-streams/src/camlp-streams/stream.ml.html#val-from"><span class="UIDENT">Stream</span><span class="DOT">.</span><span class="LIDENT">from</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local__token_index_39"><span class="LIDENT">_token_index</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Some</span> <span class="LPAREN">(</span><a href="lexer.ml.html#val-token"><span class="UIDENT">Lexer</span><span class="DOT">.</span><span class="LIDENT">token</span></a> <a href="#local_input_38"><span class="LIDENT">input</span></a> <a href="#local_lexbuf_36"><span class="LIDENT">lexbuf</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="def_44"><span id="local_ast_40"><span class="LIDENT">ast</span></span><span class="COMMA">,</span> <span id="local_warnings_41"><span class="LIDENT">warnings</span></span></span> <span class="EQUAL">=</span> <a href="syntax.ml.html#val-parse"><span class="UIDENT">Syntax</span><span class="DOT">.</span><span class="LIDENT">parse</span></a> <a href="#local_warnings_33"><span class="LIDENT">warnings</span></a> <a href="#local_token_stream_35"><span class="LIDENT">token_stream</span></a> <span class="IN">in</span><span class="EOL">
</span>  <span class="LBRACE">{</span> <a href="#local_ast_40"><span class="LIDENT">ast</span></a><span class="SEMI">;</span> <a href="#local_warnings_41"><span class="LIDENT">warnings</span></a><span class="SEMI">;</span> <a href="#local_reversed_newlines_34"><span class="LIDENT">reversed_newlines</span></a><span class="SEMI">;</span> <span class="LIDENT">original_pos</span> <span class="EQUAL">=</span> <a href="#local_location_31"><span class="LIDENT">location</span></a> <span class="RBRACE">}</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* Accessor functions, as [t] is opaque *)</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-warnings"><span class="LIDENT">warnings</span></span> <span id="local_t_42"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span> <a href="#local_t_42"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">warnings</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-ast"><span class="LIDENT">ast</span></span> <span id="local_t_43"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span> <a href="#local_t_43"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">ast</span><span class="EOL">
</span></span></code></pre></body></html>
