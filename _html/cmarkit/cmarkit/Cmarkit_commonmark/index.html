<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Cmarkit_commonmark (cmarkit.cmarkit.Cmarkit_commonmark)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.css"/><meta name="generator" content="odoc %%VERSION%%"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>let base_url = '../../../';
let search_urls = ['../../sherlodoc_db.js','../../../sherlodoc.js'];
</script><script src="../../../odoc_search.js" defer="defer"></script></head><body class="odoc"><nav class="odoc-nav"><a href="../../index.html">Up</a> ‚Äì <a href="../../../index.html">üè†</a> &#x00BB; <a href="../../index.html">Cmarkit  <span class="version">v0.3.0</span></a> &#x00BB; Library <code>cmarkit</code> &#x00BB; Cmarkit_commonmark</nav><div class="odoc-search"><div class="search-inner"><input class="search-bar" placeholder="üîé Type '/' to search..."/><div class="search-snake"></div><div class="search-result"></div></div></div><header class="odoc-preamble"><h1>Module <code><span>Cmarkit_commonmark</span></code></h1><p>Rendering CommonMark to CommonMark.</p><p>Generates CommonMark. If your document was parsed with <code>layout:true</code>, it preserves most of the source layout on output. This won't be perfect, make sure you understand the <a href="#layout" title="layout">details</a> before reporting issues.</p><p>See <span class="xref-unresolved" title="index.quick">an example</span>.</p><p><b>Warning.</b> Rendering outputs are unstable. They may be tweaked even between minor versions of the library.</p></header><div class="odoc-tocs"><nav class="odoc-toc odoc-local-toc"><ul><li><a href="#rendering">Rendering</a></li><li><a href="#renderer">Renderer</a></li><li><a href="#render">Render functions</a><ul><li><a href="#indents">Newlines and indentation</a></li><li><a href="#bslash">Backslash escaping</a></li></ul></li><li><a href="#layout">Source layout preservation</a><ul><li><a href="#rendering_class">Classifying renderings</a></li><li><a href="#known_diffs">Known correct differences</a></li><li><a href="#known_incorrect">Known incorrect renderings</a></li></ul></li></ul></nav><nav class="odoc-toc odoc-global-toc"><ul><li><a href="../../index.html">Cmarkit  <span class="version">v0.3.0</span></a><ul><li>Library <code>cmarkit</code><ul><li><a href="../Cmarkit/index.html">Cmarkit</a></li><li><a href="#" class="current_unit">Cmarkit_commonmark</a><ul><li><a href="Char_set/index.html">Char_set</a></li></ul></li><li><a href="../Cmarkit_html/index.html">Cmarkit_html</a></li><li><a href="../Cmarkit_latex/index.html">Cmarkit_latex</a></li><li><a href="../Cmarkit_renderer/index.html">Cmarkit_renderer</a></li></ul></li></ul></li></ul></nav></div><div class="odoc-content"><h2 id="rendering"><a href="#rendering" class="anchor"></a>Rendering</h2><div class="odoc-spec"><div class="spec value anchored" id="val-of_doc"><a href="#val-of_doc" class="anchor"></a><code><span><span class="keyword">val</span> of_doc : <span><a href="../Cmarkit/Doc/index.html#type-t">Cmarkit.Doc.t</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p><code>of_doc d</code> is a CommonMark document for <code>d</code>. See <a href="#val-renderer"><code>renderer</code></a> for more details.</p></div></div><h2 id="renderer"><a href="#renderer" class="anchor"></a>Renderer</h2><div class="odoc-spec"><div class="spec value anchored" id="val-renderer"><a href="#val-renderer" class="anchor"></a><code><span><span class="keyword">val</span> renderer : <span>unit <span class="arrow">&#45;&gt;</span></span> <a href="../Cmarkit_renderer/index.html#type-t">Cmarkit_renderer.t</a></span></code></div><div class="spec-doc"><p><code>renderer ()</code> is the default CommonMark renderer. This renders the strict CommonMark abstract syntax tree and the supported Cmarkit <a href="../Cmarkit/index.html#extensions" title="extensions">extensions</a>.</p><p>The inline, block and document renderers always return <code>true</code>. Unknown block and inline values are rendered by an HTML comment (as permitted by the CommonMark specification).</p><p>See <a href="../Cmarkit_renderer/index.html#example" title="example">this example</a> to extend or selectively override the renderer.</p></div></div><h2 id="render"><a href="#render" class="anchor"></a>Render functions</h2><p>Only useful if you extend the renderer.</p><h3 id="indents"><a href="#indents" class="anchor"></a>Newlines and indentation</h3><div class="odoc-spec"><div class="spec value anchored" id="val-newline"><a href="#val-newline" class="anchor"></a><code><span><span class="keyword">val</span> newline : <span><a href="../Cmarkit_renderer/index.html#type-context">Cmarkit_renderer.context</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>newline c</code> starts a new line, except on the first call on <code>c</code> which is a nop.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-indent"><a href="#type-indent" class="anchor"></a><code><span><span class="keyword">type</span> indent</span><span> = </span><span>[ </span></code><ol><li id="type-indent.I" class="def variant constructor anchored"><a href="#type-indent.I" class="anchor"></a><code><span>| </span><span>`I <span class="keyword">of</span> int</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Identation by given amount.</p><span class="comment-delim">*)</span></div></li><li id="type-indent.L" class="def variant constructor anchored"><a href="#type-indent.L" class="anchor"></a><code><span>| </span><span>`L <span class="keyword">of</span> int * string * int * <span><a href="../../../ocaml-base-compiler/stdlib/Stdlib/Uchar/index.html#type-t">Uchar.t</a> option</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Indent before, list marker, indent after, list item task extension</p><span class="comment-delim">*)</span></div></li><li id="type-indent.Q" class="def variant constructor anchored"><a href="#type-indent.Q" class="anchor"></a><code><span>| </span><span>`Q <span class="keyword">of</span> int</span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Identation followed by a block quote marker and a space</p><span class="comment-delim">*)</span></div></li><li id="type-indent.Fn" class="def variant constructor anchored"><a href="#type-indent.Fn" class="anchor"></a><code><span>| </span><span>`Fn <span class="keyword">of</span> int * <a href="../Cmarkit/Label/index.html#type-t">Cmarkit.Label.t</a></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Indent before, label (footnote extension)</p><span class="comment-delim">*)</span></div></li></ol><code><span> ]</span></code></div><div class="spec-doc"><p>The type for specifying block indentation.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-push_indent"><a href="#val-push_indent" class="anchor"></a><code><span><span class="keyword">val</span> push_indent : <span><a href="../Cmarkit_renderer/index.html#type-context">Cmarkit_renderer.context</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-indent">indent</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>push_indent c i</code> pushes <code>i</code> on the current indentation of <code>c</code>. This does not render anything.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pop_indent"><a href="#val-pop_indent" class="anchor"></a><code><span><span class="keyword">val</span> pop_indent : <span><a href="../Cmarkit_renderer/index.html#type-context">Cmarkit_renderer.context</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>pop_indent c</code> pops the last indentation pushed on <code>c</code>. This does not render anything.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-indent"><a href="#val-indent" class="anchor"></a><code><span><span class="keyword">val</span> indent : <span><a href="../Cmarkit_renderer/index.html#type-context">Cmarkit_renderer.context</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>indent i c</code> outputs current indentation on <code>c</code>. Note that <code>`L</code> and <code>`Fn</code> get replaced by an <code>`I</code> indent on subsequent lines, that is the list or foonote marker is output only once.</p></div></div><h3 id="bslash"><a href="#bslash" class="anchor"></a>Backslash escaping</h3><div class="odoc-spec"><div class="spec module anchored" id="module-Char_set"><a href="#module-Char_set" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Char_set/index.html">Char_set</a></span><span> : <a href="../../../ocaml-base-compiler/stdlib/Stdlib/Set/module-type-S/index.html">Set.S</a> <span class="keyword">with</span> <span><span class="keyword">type</span> <a href="../../../ocaml-base-compiler/stdlib/Stdlib/Set/module-type-S/index.html#type-elt">elt</a> = char</span></span></code></div><div class="spec-doc"><p>Sets of US-ASCII characters.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-escaped_string"><a href="#val-escaped_string" class="anchor"></a><code><span><span class="keyword">val</span> escaped_string : 
  <span><span class="optlabel">?esc_ctrl</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../Cmarkit_renderer/index.html#type-context">Cmarkit_renderer.context</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="Char_set/index.html#type-t">Char_set.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p><code>escaped_string ?esc_ctrl c cs s</code> renders <code>s</code> on <code>c</code> with characters in <code>cs</code> backslash escaped. If <code>esc_ctrl</code> is <code>true</code> (default) <a href="https://spec.commonmark.org/0.30/#ascii-control-character">ASCII control characters</a> are escaped to decimal escapes.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-buffer_add_escaped_string"><a href="#val-buffer_add_escaped_string" class="anchor"></a><code><span><span class="keyword">val</span> buffer_add_escaped_string : 
  <span><span class="optlabel">?esc_ctrl</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../../ocaml-base-compiler/stdlib/Stdlib/Buffer/index.html#type-t">Buffer.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="Char_set/index.html#type-t">Char_set.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p><code>buffer_add_escaped_string b cs s</code> is <a href="#val-escaped_string"><code>escaped_string</code></a> but appends to a buffer value.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-escaped_text"><a href="#val-escaped_text" class="anchor"></a><code><span><span class="keyword">val</span> escaped_text : <span><a href="../Cmarkit_renderer/index.html#type-context">Cmarkit_renderer.context</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>escaped_text c s</code> renders <code>s</code> on <code>c</code> trying to be smart about escaping Commonmark structural symbols for <a href="../Cmarkit/Inline/index.html#extension-Text"><code>Cmarkit.Inline.Text</code></a> inlines. We assume text can be anywhere in a sequence of inlines and in particular that it can start a line. This function also takes into account the existence of the <a href="../Cmarkit/index.html#extensions" title="extensions">extensions</a>.</p><p>As such we escape:</p><ul><li>These block markers: <code>-</code>‚ÄÇ<code>+</code>‚ÄÇ<code>_</code>‚ÄÇ<code>=</code> only if present at <code>s.[0]</code>.</li><li>Only the first of runs of them: <code>#</code>‚ÄÇ<code>`</code></li><li>Only the first of a run longer than 1: <code>~</code> (<a href="../Cmarkit/index.html#ext_strikethrough" title="ext_strikethrough">strikethrough extension</a>).</li><li><code>&amp;</code> if followed by an US-ASCII letter or <code>#</code>.</li><li><code>!</code> if it is the last character of <code>s</code>.</li><li><code>.</code> or <code>)</code> only if preceeded by at most 9 digits to the start of text.</li><li>Everywhere, <code>*</code>‚ÄÇ<code>_</code>‚ÄÇ<code>\ </code>‚ÄÇ<code>&lt;</code>‚ÄÇ<code>&gt;</code>‚ÄÇ<code>[</code>‚ÄÇ<code>]</code>, <a href="https://spec.commonmark.org/0.30/#ascii-control-character">ASCII control characters</a>, <code>$</code> (<a href="../Cmarkit/index.html#ext_math_inline" title="ext_math_inline">inline math extension</a>), <code>|</code> (<a href="../Cmarkit/index.html#ext_tables" title="ext_tables">table extension</a>)</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-buffer_add_escaped_text"><a href="#val-buffer_add_escaped_text" class="anchor"></a><code><span><span class="keyword">val</span> buffer_add_escaped_text : <span><a href="../../../ocaml-base-compiler/stdlib/Stdlib/Buffer/index.html#type-t">Buffer.t</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>buffer_add_escaped_text b s</code> is <a href="#val-escaped_text"><code>escaped_text</code></a> but appends to a buffer value.</p></div></div><h2 id="layout"><a href="#layout" class="anchor"></a>Source layout preservation</h2><p>The abstract syntax tree has a few block cases and data fields to represent the source document layout. This allows to update CommonMark documents without normalizing them too much when they are <a href="../Cmarkit/Doc/index.html#val-of_string" title="Cmarkit.Doc.of_string">parsed</a> with <code>layout:true</code>.</p><p>To keep things reasonably simple a few things are <b>not</b> attempted like:</p><ol><li>Preserving entities and character references.</li><li>Preserving the exact line by line indentation layout of container blocks.</li><li>Preserving lazy continuation lines.</li><li>Keeping track of used newlines except for the first one.</li><li>Preserving layout source location information when it can be reconstructed from the document data source location.</li></ol><p>In general we try to keep the following desirable properties for the abstract syntax tree definition:</p><ol><li>Layout information should not interfere with document data or be affected by it. Otherwise data updates also needs to update the layout data, which is error prone and unconvenient.</li><li>Abstract syntax trees resulting from the source document, from renders of the source document parsed with or without <code>layout:tree</code> should all render to the same HTML.</li></ol><p>In practice CommonMark being not context free point 1. is not always achieved. In particular in <a href="../Cmarkit/Inline/index.html#extension-Code_span"><code>Cmarkit.Inline.Code_span</code></a> the number of delimiting backticks depends on the code content (<a href="../Cmarkit/Inline/Code_span/index.html#val-of_string"><code>Cmarkit.Inline.Code_span.of_string</code></a>, computes that for you).</p><p>The renderer performs almost no checks on the layout data. You should be careful if you fill these yourself since you could generate CommonMark that will be misinterpreted. Layout data of pristine nodes coming out of <a href="../Cmarkit/Doc/index.html#val-of_string"><code>Cmarkit.Doc.of_string</code></a>, created with the <a href="../Cmarkit/Inline/index.html"><code>Cmarkit.Inline</code></a> and <a href="../Cmarkit/Block/index.html"><code>Cmarkit.Block</code></a> constructors should not need your attention (respect their input constraints though).</p><h3 id="rendering_class"><a href="#rendering_class" class="anchor"></a>Classifying renderings</h3><p>We say that a CommonMark render:</p><ul><li><p>is <em>correct</em>, if the result renders the same HTML as the source document. This can be checked with the <code>cmarkit</code> tool included in the distribution:</p><pre class="language-ocaml"><code>cmarkit commonmark --html-diff mydoc.md</code></pre><p>If a difference shows up, the rendering is said to be <em>incorrect</em>.</p></li><li><p><em>round trips</em>, if the result is byte-for-byte equal to the source document. This can be checked with the <code>cmarkit</code> tool included in the distribution:</p><pre class="language-ocaml"><code>cmarkit commonmark --diff mydoc.md</code></pre><p>If a difference shows up, the rendering does not round trip but it may still be correct.</p></li></ul><h3 id="known_diffs"><a href="#known_diffs" class="anchor"></a>Known correct differences</h3><p>In general lack of round trip is due to:</p><ul><li>Loss of layout on input (see above).</li><li>Eager escaping of CommonMark delimiters (the escape strategy is <a href="#val-escaped_text" title="escaped_text">here</a>).</li><li>Churn around blank lines which can be part of blocks without adhering to their structural convention.</li></ul><p>Please do not report issues for differences that are due to the following:</p><ol><li>Source US-ASCII control characters in textual data render as decimal character references in the output.</li><li>Source entity and character references are lost during parsing and thus replaced by their definition in the output.</li><li>Source tab stop advances may be replaced by spaces in the output.</li><li>Source escaped characters may end up unescaped in the output.</li><li>Source unescaped characters may end up escaped in the output.</li><li>Source lazy continuation lines are made part of blocks in the output.</li><li>Source indented blank lines following indented code blocks lose four spaces of indentation (as per specification these are not part of the block).</li><li>Source unindented blank lines in indented code blocks are indented in the output.</li><li>Source fenced code block indentation is retained from the opening fence and used for the following lines in the output.</li><li>Source block quote indentation is retained from the first line and used for the following lines in the output. The optional space following the quotation mark <code>'&gt;'</code> is made mandatory.</li><li>Source list item indentation is regularized, in particular blank lines will indent.</li><li>Source list item that start with an empty line get a space after their marker.</li><li>The newline used in the output is the one found in the rendered <a href="../Cmarkit/Doc/index.html#type-t"><code>Cmarkit.Doc.t</code></a> value.</li></ol><p><em>Simple</em> and <em>implemented</em> round trip improvements to the renderer are welcome.</p><h3 id="known_incorrect"><a href="#known_incorrect" class="anchor"></a>Known incorrect renderings</h3><p>Please do not report issues incorrect renderings that are due to the following (and unlikely to be fixed):</p><ol><li><p>Use of entities and character references around structural CommonMark symbols can make things go wrong. These get resolved after inline parsing because they can't be used to stand for structural CommonMark symbols, however once they have been resolved they can interact with parsing. Here is an example:</p><pre class="language-ocaml"><code>*emph&amp;nbsp;*</code></pre><p>It parses as emphasis. But if we render it to CommonMark non-breaking space renders as is and we get:</p><pre class="language-ocaml"><code>*emph *</code></pre><p>which no longer parses as emphasis.</p><p>Note in this particular case it is possible to do something about it by being smarter about the context when escaping. However there's a trade-off between renderer complexity and the (conjectured) paucity of these cases.</p></li></ol><p>Otherwise, if you spot an incorrect rendering please report a minimal reproduction case.</p><p><em>Simple</em> and <em>implemented</em> round trip improvements to the renderer are welcome.</p></div></body></html>
