<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Cmarkit_renderer (cmarkit.cmarkit.Cmarkit_renderer)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.css"/><meta name="generator" content="odoc %%VERSION%%"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>let base_url = '../../../';
let search_urls = ['../../sherlodoc_db.js','../../../sherlodoc.js'];
</script><script src="../../../odoc_search.js" defer="defer"></script></head><body class="odoc"><nav class="odoc-nav"><a href="../../index.html">Up</a> ‚Äì <a href="../../../index.html">üè†</a> &#x00BB; <a href="../../index.html">Cmarkit  <span class="version">v0.3.0</span></a> &#x00BB; Library <code>cmarkit</code> &#x00BB; Cmarkit_renderer</nav><div class="odoc-search"><div class="search-inner"><input class="search-bar" placeholder="üîé Type '/' to search..."/><div class="search-snake"></div><div class="search-result"></div></div></div><header class="odoc-preamble"><h1>Module <code><span>Cmarkit_renderer</span></code></h1><p>Renderer abstraction.</p><p>Stateful renderer abstraction to render documents in <a href="../../../ocaml-base-compiler/stdlib/Stdlib/Buffer/index.html#type-t"><code>Stdlib.Buffer.t</code></a> values.</p><p><b>Note.</b> This is a low-level interface. For quick and standard renderings see <a href="../Cmarkit_html/index.html#val-of_doc"><code>Cmarkit_html.of_doc</code></a>, <a href="../Cmarkit_latex/index.html#val-of_doc"><code>Cmarkit_latex.of_doc</code></a> and <a href="../Cmarkit_commonmark/index.html#val-of_doc"><code>Cmarkit_commonmark.of_doc</code></a>. If you want to extend them, see <a href="#example" title="example">this example</a>.</p></header><div class="odoc-tocs"><nav class="odoc-toc odoc-local-toc"><ul><li><a href="#rendering">Rendering</a></li><li><a href="#renderers">Renderers</a><ul><li><a href="#accessors">Accessors</a></li></ul></li><li><a href="#context">Rendering contexts</a></li><li><a href="#example">Extending renderers</a></li></ul></nav><nav class="odoc-toc odoc-global-toc"><ul><li><a href="../../index.html">Cmarkit  <span class="version">v0.3.0</span></a><ul><li>Library <code>cmarkit</code><ul><li><a href="../Cmarkit/index.html">Cmarkit</a></li><li><a href="../Cmarkit_commonmark/index.html">Cmarkit_commonmark</a></li><li><a href="../Cmarkit_html/index.html">Cmarkit_html</a></li><li><a href="../Cmarkit_latex/index.html">Cmarkit_latex</a></li><li><a href="#" class="current_unit">Cmarkit_renderer</a><ul><li><a href="Context/index.html">Context</a></li></ul></li></ul></li></ul></li></ul></nav></div><div class="odoc-content"><h2 id="rendering"><a href="#rendering" class="anchor"></a>Rendering</h2><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div><div class="spec-doc"><p>The type for renderers.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-doc_to_string"><a href="#val-doc_to_string" class="anchor"></a><code><span><span class="keyword">val</span> doc_to_string : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Cmarkit/Doc/index.html#type-t">Cmarkit.Doc.t</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p><code>doc_to_string r d</code> renders document <code>d</code> to a string using renderer <code>r</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-buffer_add_doc"><a href="#val-buffer_add_doc" class="anchor"></a><code><span><span class="keyword">val</span> buffer_add_doc : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../ocaml-base-compiler/stdlib/Stdlib/Buffer/index.html#type-t">Buffer.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Cmarkit/Doc/index.html#type-t">Cmarkit.Doc.t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>buffer_add_doc r b d</code> renders document <code>d</code> on buffer <code>b</code> using renderer <code>r</code>.</p></div></div><h2 id="renderers"><a href="#renderers" class="anchor"></a>Renderers</h2><div class="odoc-spec"><div class="spec type anchored" id="type-context"><a href="#type-context" class="anchor"></a><code><span><span class="keyword">type</span> context</span></code></div><div class="spec-doc"><p>The type for rendering contexts, holds a renderer, a <a href="../../../ocaml-base-compiler/stdlib/Stdlib/Buffer/index.html#type-t"><code>Stdlib.Buffer.t</code></a> value to act on and rendering state.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-inline"><a href="#type-inline" class="anchor"></a><code><span><span class="keyword">type</span> inline</span><span> = <span><a href="#type-context">context</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Cmarkit/Inline/index.html#type-t">Cmarkit.Inline.t</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p>The type for inline renderers.</p><p>Return <code>false</code> if you are not interested in rendering the given inline. Use <a href="Context/index.html#val-inline"><code>Context.inline</code></a> and <a href="Context/index.html#val-block"><code>Context.block</code></a> on the given context if you need to invoke the renderer recursively.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-block"><a href="#type-block" class="anchor"></a><code><span><span class="keyword">type</span> block</span><span> = <span><a href="#type-context">context</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Cmarkit/Block/index.html#type-t">Cmarkit.Block.t</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p>The type for block renderers.</p><p>Return <code>false</code> if you are not interested in rendering the given block. Use <a href="Context/index.html#val-inline"><code>Context.inline</code></a> and <a href="Context/index.html#val-block"><code>Context.block</code></a> with the given context if you need to invoke the renderer recursively.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-doc"><a href="#type-doc" class="anchor"></a><code><span><span class="keyword">type</span> doc</span><span> = <span><a href="#type-context">context</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Cmarkit/Doc/index.html#type-t">Cmarkit.Doc.t</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p>The type for document renderers.</p><p>Return <code>false</code> if you are not interested in rendering the given document. Use <a href="Context/index.html#val-inline"><code>Context.inline</code></a>, <a href="Context/index.html#val-block"><code>Context.block</code></a> and <a href="Context/index.html#val-doc"><code>Context.doc</code></a> with the given context if you need to invoke the renderer recursively.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-make"><a href="#val-make" class="anchor"></a><code><span><span class="keyword">val</span> make : 
  <span><span class="optlabel">?init_context</span>:<span>(<span><a href="#type-context">context</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Cmarkit/Doc/index.html#type-t">Cmarkit.Doc.t</a> <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?inline</span>:<a href="#type-inline">inline</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?block</span>:<a href="#type-block">block</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?doc</span>:<a href="#type-doc">doc</a> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>make ?init_context ?inline ?block ?doc ()</code> is a renderer using <code>inline</code>, <code>block</code>, <code>doc</code> to render documents. They all default to <code>(fun _ _ -&gt; false)</code>, which means that by default they defer to next renderer (see <a href="#val-compose"><code>compose</code></a>).</p><p><code>init_context</code> is used to initialize the context for the renderer before a document render. It defaults to <code>fun _ _ -&gt; ()</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-compose"><a href="#val-compose" class="anchor"></a><code><span><span class="keyword">val</span> compose : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>compose g f</code> renders first with <code>f</code> and if a renderer returns <code>false</code>, falls back on its counterpart in <code>g</code>.</p><p>The <a href="#val-init_context"><code>init_context</code></a> of the result calls <code>g</code>'s initialization context function first, followed by the one of <code>f</code>. This means <code>f</code>'s initialization function can assume the context is already setup for <code>g</code>.</p></div></div><h3 id="accessors"><a href="#accessors" class="anchor"></a>Accessors</h3><p>Normally you should not need these but you may want to peek into other renderers.</p><div class="odoc-spec"><div class="spec value anchored" id="val-init_context"><a href="#val-init_context" class="anchor"></a><code><span><span class="keyword">val</span> init_context : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-context">context</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Cmarkit/Doc/index.html#type-t">Cmarkit.Doc.t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>init_context r</code> is the context initalization function for <code>r</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-inline"><a href="#val-inline" class="anchor"></a><code><span><span class="keyword">val</span> inline : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-inline">inline</a></span></code></div><div class="spec-doc"><p><code>inline r</code> is the inline renderer of <code>r</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-block"><a href="#val-block" class="anchor"></a><code><span><span class="keyword">val</span> block : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-block">block</a></span></code></div><div class="spec-doc"><p><code>block_renderer r</code> is the block renderer of <code>r</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-doc"><a href="#val-doc" class="anchor"></a><code><span><span class="keyword">val</span> doc : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-doc">doc</a></span></code></div><div class="spec-doc"><p><code>doc_renderer r</code> is the documentation renderer of <code>r</code>.</p></div></div><h2 id="context"><a href="#context" class="anchor"></a>Rendering contexts</h2><div class="odoc-spec"><div class="spec module anchored" id="module-Context"><a href="#module-Context" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Context/index.html">Context</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Rendering contexts.</p></div></div><h2 id="example"><a href="#example" class="anchor"></a>Extending renderers</h2><p>This example extends the <a href="../Cmarkit_html/index.html#val-renderer"><code>Cmarkit_html.renderer</code></a> but it applies <em>mutatis mutandis</em> to the other backend document renderers.</p><p>Let's assume you want to:</p><ul><li>Extend the abstract syntax tree with a <code>Doc</code> block which allows to splice documents in another one (note that splicing is already built-in via the <a href="../Cmarkit/Block/index.html#extension-Blocks"><code>Cmarkit.Block.Blocks</code></a> block case).</li><li>Change the rendering of <a href="../Cmarkit/Inline/index.html#extension-Image"><code>Cmarkit.Inline.Image</code></a> inlines to render HTML <code>video</code> or <code>audio</code> elements depending on the link's destination suffix.</li><li>For the rest use the built-in <a href="../Cmarkit_html/index.html#val-renderer"><code>Cmarkit_html.renderer</code></a> renderer as it exists.</li></ul><p>This boils down to:</p><ol><li>Add a new case to the abstract syntax tree.</li><li>Define a <code>custom_html</code> renderer which treats <a href="../Cmarkit/Inline/index.html#extension-Image"><code>Cmarkit.Inline.Image</code></a> and the new <code>Doc</code> case the way we see it fit and return <code>false</code> otherwise to use the built-in renderer.</li><li><a href="#val-compose"><code>compose</code></a> <code>custom_html</code> with <a href="../Cmarkit_html/index.html#val-renderer"><code>Cmarkit_html.renderer</code></a></li></ol><pre class="language-ocaml"><code>type Cmarkit.Block.t += Doc of Cmarkit.Doc.t (* 1 *)

let media_link c l =
  let has_ext s ext = String.ends_with ~suffix:ext s in
  let is_video s = List.exists (has_ext s) [&quot;.mp4&quot;; &quot;.webm&quot;] in
  let is_audio s = List.exists (has_ext s) [&quot;.mp3&quot;; &quot;.flac&quot;] in
  let defs = Cmarkit_renderer.Context.get_defs c in
  match Cmarkit.Inline.Link.reference_definition defs l with
  | Some Cmarkit.Link_definition.Def (ld, _) -&gt;
      let start_tag = match Cmarkit.Link_definition.dest ld with
      | Some (src, _) when is_video src -&gt; Some (&quot;&lt;video&quot;, src)
      | Some (src, _) when is_audio src -&gt; Some (&quot;&lt;audio&quot;, src)
      | None | Some _ -&gt; None
      in
      begin match start_tag with
      | None -&gt; false (* let the default HTML renderer handle that *)
      | Some (start_tag, src) -&gt;
          (* More could be done with the reference title and link text *)
          Cmarkit_renderer.Context.string c start_tag;
          Cmarkit_renderer.Context.string c {| src=&quot;|};
          Cmarkit_html.pct_encoded_string c src;
          Cmarkit_renderer.Context.string c {|&quot; /&gt;|};
          true
      end
  | None | Some _ -&gt; false (* let the default HTML renderer that *)

let custom_html =
  let inline c = function
  | Cmarkit.Inline.Image (l, _) -&gt; media_link c l
  | _ -&gt; false (* let the default HTML renderer handle that *)
  in
  let block c = function
  | Doc d -&gt;
      (* It's important to recurse via Cmarkit_renderer.Context.block *)
      Cmarkit_renderer.Context.block c (Cmarkit.Doc.block d); true
  | _ -&gt; false (* let the default HTML renderer handle that *)
  in
  Cmarkit_renderer.make ~inline ~block () (* 2 *)

let custom_html_of_doc ~safe doc =
  let default = Cmarkit_html.renderer ~safe () in
  let r = Cmarkit_renderer.compose default custom_html in (* 3 *)
  Cmarkit_renderer.doc_to_string r doc</code></pre><p>The <code>custom_html_of_doc</code> function performs your extended renderings.</p></div></body></html>
