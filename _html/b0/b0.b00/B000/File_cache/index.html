<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>File_cache (b0.b0.b00.B000.File_cache)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../../odoc.css"/><meta name="generator" content="odoc %%VERSION%%"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>let base_url = '../../../../';
let search_urls = ['../../../sherlodoc_db.js','../../../../sherlodoc.js'];
</script><script src="../../../../odoc_search.js" defer="defer"></script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> ‚Äì <a href="../../../../index.html">üè†</a> &#x00BB; <a href="../../../index.html">B0  <span class="version">v0.0.5</span></a> &#x00BB; Library <code>b0.b00</code> &#x00BB; <a href="../index.html">B000</a> &#x00BB; File_cache</nav><div class="odoc-search"><div class="search-inner"><input class="search-bar" placeholder="üîé Type '/' to search..."/><div class="search-snake"></div><div class="search-result"></div></div></div><header class="odoc-preamble"><h1>Module <code><span>B000.File_cache</span></code></h1><p>File caches.</p><p>A file cache maps a key to a metadata hunk and an ordered list of file <em>contents</em> (filenames are irrelevant).</p><p>Cache bindings are used to recreate the effect of build operations without having to rerun them. The key identifies the operation (usually via a hash), the ordered files are those written by the operation and the metadata has additional output information (e.g. exit codes, standard outputs, etc.).</p><p>For some scenarios it may still be useful to store relative not only file contents but also relative file paths associated to them. Thus for certain keys these are stored along side the file contents.</p><p><b>Note.</b> In general, whenever a cache operation modifies the file system and errors with <code>Error _</code> the resulting file system state is undefined.</p></header><div class="odoc-tocs"><nav class="odoc-toc odoc-local-toc"><ul><li><a href="#file_cache">File caches</a></li></ul></nav><nav class="odoc-toc odoc-global-toc"><ul><li><a href="../../../index.html">B0  <span class="version">v0.0.5</span></a><ul><li><a href="../../../b00_manual.html">B00 manual</a></li><li><a href="../../../cmdlet_manual.html">Cmdlet manual</a></li><li><a href="../../../driver_dev.html">B0 driver development manual</a></li><li><a href="../../../manual.html">B0 manual</a></li><li><a href="../../../old_manual.html">B0 manual</a></li><li><a href="../../../opam.html"><code>opam</code> support manual</a></li><li><a href="../../../rationale.html">Why b0 ?</a></li><li><a href="../../../release.html">B0 release support manual</a></li><li><a href="../../../todo.html">Design considerations and todo</a></li><li><a href="../../../unit_manual.html">Build unit manual</a></li><li>Library <code>b0</code><ul><li><a href="../../../b0/B0_build/index.html">B0_build</a></li><li><a href="../../../b0/B0_cli/index.html">B0_cli</a></li><li><a href="../../../b0/B0_cmdlet/index.html">B0_cmdlet</a></li><li><a href="../../../b0/B0_def/index.html">B0_def</a></li><li><a href="../../../b0/B0_dir/index.html">B0_dir</a></li><li><a href="../../../b0/B0_driver/index.html">B0_driver</a></li><li><a href="../../../b0/B0_file/index.html">B0_file</a></li><li><a href="../../../b0/B0_meta/index.html">B0_meta</a></li><li><a href="../../../b0/B0_pack/index.html">B0_pack</a></li><li><a href="../../../b0/B0_unit/index.html">B0_unit</a></li></ul></li><li>Library <code>b0.b0</code><ul><li><a href="../../../b0.b0/B0_b0/index.html">B0_b0</a></li><li><a href="../../../b0.b0/B0_cmd_build/index.html">B0_cmd_build</a></li><li><a href="../../../b0.b0/B0_cmd_cmd/index.html">B0_cmd_cmd</a></li><li><a href="../../../b0.b0/B0_cmd_cmdlet/index.html">B0_cmd_cmdlet</a></li><li><a href="../../../b0.b0/B0_cmd_delete/index.html">B0_cmd_delete</a></li><li><a href="../../../b0.b0/B0_cmd_file/index.html">B0_cmd_file</a></li><li><a href="../../../b0.b0/B0_cmd_list/index.html">B0_cmd_list</a></li><li><a href="../../../b0.b0/B0_cmd_log/index.html">B0_cmd_log</a></li><li><a href="../../../b0.b0/B0_cmd_pack/index.html">B0_cmd_pack</a></li><li><a href="../../../b0.b0/B0_cmd_root/index.html">B0_cmd_root</a></li><li><a href="../../../b0.b0/B0_cmd_scope/index.html">B0_cmd_scope</a></li><li><a href="../../../b0.b0/B0_cmd_unit/index.html">B0_cmd_unit</a></li><li><a href="../../../b0.b0/B0_main/index.html">B0_main</a></li></ul></li><li>Library <code>b0.b00</code><ul><li><a href="../../B00/index.html">B00</a></li><li><a href="../index.html">B000</a><ul><li><a href="../Trash/index.html">Trash</a></li><li><a href="#" class="current_unit">File_cache</a></li><li><a href="../Op/index.html">Op</a></li><li><a href="../Reviver/index.html">Reviver</a></li><li><a href="../Guard/index.html">Guard</a></li><li><a href="../Exec/index.html">Exec</a></li></ul></li><li><a href="../../B000_conv/index.html">B000_conv</a></li></ul></li><li>Library <code>b0.b00.kit</code><ul><li><a href="../../../b0.b00.kit/B00_base64/index.html">B00_base64</a></li><li><a href="../../../b0.b00.kit/B00_cli/index.html">B00_cli</a></li><li><a href="../../../b0.b00.kit/B00_cmark/index.html">B00_cmark</a></li><li><a href="../../../b0.b00.kit/B00_editor/index.html">B00_editor</a></li><li><a href="../../../b0.b00.kit/B00_fexts/index.html">B00_fexts</a></li><li><a href="../../../b0.b00.kit/B00_findex/index.html">B00_findex</a></li><li><a href="../../../b0.b00.kit/B00_github/index.html">B00_github</a></li><li><a href="../../../b0.b00.kit/B00_htmlg/index.html">B00_htmlg</a></li><li><a href="../../../b0.b00.kit/B00_http/index.html">B00_http</a></li><li><a href="../../../b0.b00.kit/B00_jsoo/index.html">B00_jsoo</a></li><li><a href="../../../b0.b00.kit/B00_lines/index.html">B00_lines</a></li><li><a href="../../../b0.b00.kit/B00_ocaml/index.html">B00_ocaml</a></li><li><a href="../../../b0.b00.kit/B00_odoc/index.html">B00_odoc</a></li><li><a href="../../../b0.b00.kit/B00_os/index.html">B00_os</a></li><li><a href="../../../b0.b00.kit/B00_pager/index.html">B00_pager</a></li><li><a href="../../../b0.b00.kit/B00_pdf_viewer/index.html">B00_pdf_viewer</a></li><li><a href="../../../b0.b00.kit/B00_rsync/index.html">B00_rsync</a></li><li><a href="../../../b0.b00.kit/B00_serialk_json/index.html">B00_serialk_json</a></li><li><a href="../../../b0.b00.kit/B00_serialk_sexp/index.html">B00_serialk_sexp</a></li><li><a href="../../../b0.b00.kit/B00_serialk_text/index.html">B00_serialk_text</a></li><li><a href="../../../b0.b00.kit/B00_trace/index.html">B00_trace</a></li><li><a href="../../../b0.b00.kit/B00_vcs/index.html">B00_vcs</a></li><li><a href="../../../b0.b00.kit/B00_www_browser/index.html">B00_www_browser</a></li></ul></li><li>Library <code>b0.kit</code><ul><li><a href="../../../b0.kit/B0_expect/index.html">B0_expect</a></li><li><a href="../../../b0.kit/B0_jsoo/index.html">B0_jsoo</a></li><li><a href="../../../b0.kit/B0_kit/index.html">B0_kit</a></li><li><a href="../../../b0.kit/B0_ocaml/index.html">B0_ocaml</a></li><li><a href="../../../b0.kit/B0_ocaml_eco/index.html">B0_ocaml_eco</a></li><li><a href="../../../b0.kit/B0_opam/index.html">B0_opam</a></li><li><a href="../../../b0.kit/B0_release/index.html">B0_release</a></li><li><a href="../../../b0.kit/B0_srcs/index.html">B0_srcs</a></li></ul></li><li>Library <code>b0.std</code><ul><li><a href="../../../b0.std/B0_std/index.html">B0_std</a></li></ul></li></ul></li></ul></nav></div><div class="odoc-content"><h2 id="file_cache"><a href="#file_cache" class="anchor"></a>File caches</h2><div class="odoc-spec"><div class="spec type anchored" id="type-key"><a href="#type-key" class="anchor"></a><code><span><span class="keyword">type</span> key</span><span> = string</span></code></div><div class="spec-doc"><p>The type for keys. A key maps to a metadata hunk and an ordered list of file contents. The module treats keys as sequence of bytes however since they are used as file names they should satisfy the <a href="../../../b0.std/B0_std/Fpath/index.html#val-is_seg"><code>B0_std.Fpath.is_seg</code></a> predicate; this is not checked by the module.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div><div class="spec-doc"><p>The type for file caches.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-create"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : <span><a href="../../../b0.std/B0_std/Fpath/index.html#type-t">B0_std.Fpath.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<a href="#type-t">t</a>, string)</span> <a href="../../../../ocaml-base-compiler/stdlib/Stdlib/index.html#type-result">result</a></span></span></code></div><div class="spec-doc"><p><code>create dir</code> is a file cache using directory <code>dir</code> for data storage. The full path to <code>dir</code> is created by the call if <code>dir</code> doesn't exist.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-dir"><a href="#val-dir" class="anchor"></a><code><span><span class="keyword">val</span> dir : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../b0.std/B0_std/Fpath/index.html#type-t">B0_std.Fpath.t</a></span></code></div><div class="spec-doc"><p><code>dir c</code> is <code>c</code>'s storage directory.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-keys"><a href="#val-keys" class="anchor"></a><code><span><span class="keyword">val</span> keys : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span><a href="#type-key">key</a> list</span>, string)</span> <a href="../../../../ocaml-base-compiler/stdlib/Stdlib/index.html#type-result">result</a></span></span></code></div><div class="spec-doc"><p><code>keys c</code> are the keys of cache <code>c</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-key_stats"><a href="#val-key_stats" class="anchor"></a><code><span><span class="keyword">val</span> key_stats : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-key">key</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(int * int * float, string)</span> <a href="../../../../ocaml-base-compiler/stdlib/Stdlib/index.html#type-result">result</a></span></span></code></div><div class="spec-doc"><p><code>key_stats c key</code> is statistical information about key <code>key</code>. Namely the number of files (including the metadata and manifest), the key size in bytes and the access time of the key ‚Äì this is the latest access time of one of its consituents the relevance of which depends on your file system.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-mem"><a href="#val-mem" class="anchor"></a><code><span><span class="keyword">val</span> mem : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-key">key</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>mem c k</code> is <code>true</code> iff <code>k</code> is bound in <code>c</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-add"><a href="#val-add" class="anchor"></a><code><span><span class="keyword">val</span> add : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-key">key</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span><span><a href="../../../b0.std/B0_std/Fpath/index.html#type-t">B0_std.Fpath.t</a> list</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(bool, string)</span> <a href="../../../../ocaml-base-compiler/stdlib/Stdlib/index.html#type-result">result</a></span></span></code></div><div class="spec-doc"><p><code>add c k m fs</code>, binds the metadata <code>m</code> and the <em>contents</em> of the ordered list of files <code>fs</code> to <code>k</code> in <code>c</code>. The function returns:</p><ul><li><code>Ok true</code> if the operation succeeds.</li><li><code>Ok false</code> if a file of <code>fs</code> could not be accessed. In this case <code>k</code> is guaranteed to be unbound in <code>c</code>.</li><li><code>Error _</code> if an unexpected error occurs. In that case the resulting state of the cache for key <code>k</code> is undefined.</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-manifest_add"><a href="#val-manifest_add" class="anchor"></a><code><span><span class="keyword">val</span> manifest_add : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-key">key</a> <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">root</span>:<a href="../../../b0.std/B0_std/Fpath/index.html#type-t">B0_std.Fpath.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../../../b0.std/B0_std/Fpath/index.html#type-t">B0_std.Fpath.t</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(bool, string)</span> <a href="../../../../ocaml-base-compiler/stdlib/Stdlib/index.html#type-result">result</a></span></span></code></div><div class="spec-doc"><p><code>manifest_add c k m ~root fs</code> is like <a href="#val-add"><code>add</code></a> except it also stores the file paths <code>fs</code> relativized with respect to <code>root</code>. This means the actual file paths need not to be provided to revive the operation see <a href="#val-manifest_revive"><code>manifest_revive</code></a>. This errors if one of the files in <code>fs</code> is not prefixed by <code>root</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-rem"><a href="#val-rem" class="anchor"></a><code><span><span class="keyword">val</span> rem : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-key">key</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(bool, string)</span> <a href="../../../../ocaml-base-compiler/stdlib/Stdlib/index.html#type-result">result</a></span></span></code></div><div class="spec-doc"><p><code>rem c k</code> removes the binding of <code>k</code> in <code>c</code>. <code>Ok true</code> is returned if <code>k</code> was bound in <code>c</code> and <code>Ok false</code> otherwise.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-find"><a href="#val-find" class="anchor"></a><code><span><span class="keyword">val</span> find : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-key">key</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><span>(<span><a href="../../../b0.std/B0_std/Fpath/index.html#type-t">B0_std.Fpath.t</a> option</span> * <a href="../../../b0.std/B0_std/Fpath/index.html#type-t">B0_std.Fpath.t</a> * <span><a href="../../../b0.std/B0_std/Fpath/index.html#type-t">B0_std.Fpath.t</a> list</span>)</span> option</span>,
    string)</span>
    <a href="../../../../ocaml-base-compiler/stdlib/Stdlib/index.html#type-result">result</a></span></span></code></div><div class="spec-doc"><p><code>find c k</code> is <code>Some (mf, m, fs)</code> if <code>k</code> is bound in <code>c</code> with <code>mf</code> the file that holds the file manifest (if any), <code>m</code> the file that holds the key metadata and <code>fs</code> the files that hold the file contents of the key in the order given on <a href="#val-add"><code>add</code></a> (or in the order of the manifest). The result is <code>None</code> if <code>k</code> is unbound in <code>c</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-revive"><a href="#val-revive" class="anchor"></a><code><span><span class="keyword">val</span> revive : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-key">key</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="../../../b0.std/B0_std/Fpath/index.html#type-t">B0_std.Fpath.t</a> list</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span>string option</span>, string)</span> <a href="../../../../ocaml-base-compiler/stdlib/Stdlib/index.html#type-result">result</a></span></span></code></div><div class="spec-doc"><p><code>revive c k fs</code> binds the file contents of key <code>k</code> to the file <em>path</em>s <code>fs</code>. These file paths are overwritten if they exist and intermediate directories are created if needed (with permissions <code>0o755</code>). The function returns:</p><ul><li><code>Ok (Some m</code> in case of success, with <code>m</code> the metadata of the key. In this case the files <code>fs</code> are guaranteed to exist and to match those of the key files in the order given on <a href="#val-add"><code>add</code></a>.</li><li><code>Ok None</code> if the length of <code>fs</code> does not match the sequence of files of <code>k</code> or if <code>k</code> is unbound in <code>c</code>. In this case the file paths <code>fs</code> are left untouched.</li><li><code>Error _</code> if an unexpected error occurs. In that case the resulting state of the file system for paths <code>fs</code> is undefined.</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-manifest_revive"><a href="#val-manifest_revive" class="anchor"></a><code><span><span class="keyword">val</span> manifest_revive : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-key">key</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">root</span>:<a href="../../../b0.std/B0_std/Fpath/index.html#type-t">B0_std.Fpath.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><span>(<span><a href="../../../b0.std/B0_std/Fpath/index.html#type-t">B0_std.Fpath.t</a> list</span> * string)</span> option</span>, string)</span> <a href="../../../../ocaml-base-compiler/stdlib/Stdlib/index.html#type-result">result</a></span></span></code></div><div class="spec-doc"><p><code>manifest_revive</code> is like <a href="#val-revive"><code>revive</code></a> however the file paths that are written to are determined by the cache's file manifest whose path are made absolute using <code>root</code> and returned in the result. <code>None</code> is returned if the key existed but had no manifest.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-trim_size"><a href="#val-trim_size" class="anchor"></a><code><span><span class="keyword">val</span> trim_size : 
  <span><span class="optlabel">?is_unused</span>:<span>(<span><a href="#type-key">key</a> <span class="arrow">&#45;&gt;</span></span> bool)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">max_byte_size</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">pct</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span>(unit, string)</span> <a href="../../../../ocaml-base-compiler/stdlib/Stdlib/index.html#type-result">result</a></span></span></code></div><div class="spec-doc"><p><code>trim_size c ~is_unused max_byte_size ~pct</code> deletes keys of <code>c</code> until the cache either weights at most <code>max_byte_size</code> or is <code>pct</code> of its current size; whichever is the smaller. The function deletes by order of increasing key access time (see <a href="#val-key_stats"><code>key_stats</code></a>) but unused keys determined by <code>is_unused</code> are deleted first (defaults to <code>fun _ -&gt; false</code>).</p></div></div></div></body></html>
