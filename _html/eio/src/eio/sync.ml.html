<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Source: sync.ml (eio.src.eio)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.css"/><meta name="generator" content="odoc %%VERSION%%"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/></head><body class="odoc-src"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">eio</a> &#x00BB; <a href="../index.html">Sources</a> &#x00BB; eio &#x00BB; sync.ml</nav><header class="odoc-preamble"><h1>Source file <code><span>sync.ml</span></code></h1></header><div class="odoc-tocs"><nav class="odoc-toc odoc-global-toc"><ul><li><a href="../../index.html">eio</a><ul><li>Library <code>eio</code><ul><li><a href="../../eio/Eio/index.html">Eio</a></li></ul></li><li>Library <code>eio.core</code></li><li>Library <code>eio.mock</code><ul><li><a href="../../eio.mock/Eio_mock/index.html">Eio_mock</a></li></ul></li><li>Library <code>eio.runtime_events</code><ul><li><a href="../../eio.runtime_events/Eio_runtime_events/index.html">Eio_runtime_events</a></li></ul></li><li>Library <code>eio.unix</code><ul><li><a href="../../eio.unix/Eio_unix/index.html">Eio_unix</a></li></ul></li><li>Library <code>eio.utils</code><ul><li><a href="../../eio.utils/Eio_utils/index.html">Eio_utils</a></li></ul></li><li><a href="../index.html">Sources</a><ul><li>eio<ul><li><a href="buf_read.ml.html">buf_read.ml</a></li><li><a href="buf_write.ml.html">buf_write.ml</a></li><li><a href="condition.ml.html">condition.ml</a></li><li><a href="domain_manager.ml.html">domain_manager.ml</a></li><li><a href="eio.ml.html">eio.ml</a></li><li><a href="eio__.ml.html">eio__.ml</a></li><li><a href="eio_mutex.ml.html">eio_mutex.ml</a></li><li><a href="executor_pool.ml.html">executor_pool.ml</a></li><li><a href="file.ml.html">file.ml</a></li><li><a href="flow.ml.html">flow.ml</a></li><li><a href="fs.ml.html">fs.ml</a></li><li><a href="hook.ml.html">hook.ml</a></li><li><a href="lazy.ml.html">lazy.ml</a></li><li><a href="net.ml.html">net.ml</a></li><li><a href="path.ml.html">path.ml</a></li><li><a href="pool.ml.html">pool.ml</a></li><li><a href="process.ml.html">process.ml</a></li><li><a href="resource.ml.html">resource.ml</a></li><li><a href="sem_state.ml.html">sem_state.ml</a></li><li><a href="semaphore.ml.html">semaphore.ml</a></li><li><a href="std.ml.html">std.ml</a></li><li><a href="stream.ml.html">stream.ml</a></li><li><a href="#" class="current_unit">sync.ml</a></li><li><a href="time.ml.html">time.ml</a></li><li><a href="waiters.ml.html">waiters.ml</a></li></ul></li><li>eio.core<ul><li><a href="../eio.core/broadcast.ml.html">broadcast.ml</a></li><li><a href="../eio.core/cancel.ml.html">cancel.ml</a></li><li><a href="../eio.core/cells.ml.html">cells.ml</a></li><li><a href="../eio.core/debug.ml.html">debug.ml</a></li><li><a href="../eio.core/dla.ml.html">dla.ml</a></li><li><a href="../eio.core/eio__core.ml.html">eio__core.ml</a></li><li><a href="../eio.core/eio__core__.ml.html">eio__core__.ml</a></li><li><a href="../eio.core/exn.ml.html">exn.ml</a></li><li><a href="../eio.core/fiber.ml.html">fiber.ml</a></li><li><a href="../eio.core/promise.ml.html">promise.ml</a></li><li><a href="../eio.core/single_waiter.ml.html">single_waiter.ml</a></li><li><a href="../eio.core/suspend.ml.html">suspend.ml</a></li><li><a href="../eio.core/switch.ml.html">switch.ml</a></li><li><a href="../eio.core/trace.ml.html">trace.ml</a></li></ul></li><li>eio.mock<ul><li><a href="../eio.mock/action.ml.html">action.ml</a></li><li><a href="../eio.mock/backend.ml.html">backend.ml</a></li><li><a href="../eio.mock/clock.ml.html">clock.ml</a></li><li><a href="../eio.mock/domain_manager.ml.html">domain_manager.ml</a></li><li><a href="../eio.mock/eio_mock.ml.html">eio_mock.ml</a></li><li><a href="../eio.mock/eio_mock__.ml.html">eio_mock__.ml</a></li><li><a href="../eio.mock/flow.ml.html">flow.ml</a></li><li><a href="../eio.mock/handler.ml.html">handler.ml</a></li><li><a href="../eio.mock/net.ml.html">net.ml</a></li></ul></li><li>eio.runtime_events<ul><li><a href="../eio.runtime_events/eio_runtime_events.ml.html">eio_runtime_events.ml</a></li></ul></li><li>eio.unix<ul><li><a href="../eio.unix/cap.ml.html">cap.ml</a></li><li><a href="../eio.unix/eio_unix.ml.html">eio_unix.ml</a></li><li><a href="../eio.unix/eio_unix__.ml.html">eio_unix__.ml</a></li><li><a href="../eio.unix/fd.ml.html">fd.ml</a></li><li><a href="../eio.unix/fork_action.ml.html">fork_action.ml</a></li><li><a href="../eio.unix/inherit_fds.ml.html">inherit_fds.ml</a></li><li><a href="../eio.unix/net.ml.html">net.ml</a></li><li><a href="../eio.unix/pi.ml.html">pi.ml</a></li><li><a href="../eio.unix/private.ml.html">private.ml</a></li><li><a href="../eio.unix/process.ml.html">process.ml</a></li><li><a href="../eio.unix/rcfd.ml.html">rcfd.ml</a></li><li><a href="../eio.unix/resource.ml.html">resource.ml</a></li><li><a href="../eio.unix/thread_pool.ml.html">thread_pool.ml</a></li><li><a href="../eio.unix/types.ml.html">types.ml</a></li></ul></li><li>eio.utils<ul><li><a href="../eio.utils/eio_utils.ml.html">eio_utils.ml</a></li><li><a href="../eio.utils/eio_utils__.ml.html">eio_utils__.ml</a></li><li><a href="../eio.utils/lf_queue.ml.html">lf_queue.ml</a></li><li><a href="../eio.utils/suspended.ml.html">suspended.ml</a></li><li><a href="../eio.utils/zzz.ml.html">zzz.ml</a></li></ul></li></ul></li></ul></li></ul></nav></div><pre class="source_container"><code class="source_line_column"><a id="L1" class="source_line" href="#L1">1</a>
<a id="L2" class="source_line" href="#L2">2</a>
<a id="L3" class="source_line" href="#L3">3</a>
<a id="L4" class="source_line" href="#L4">4</a>
<a id="L5" class="source_line" href="#L5">5</a>
<a id="L6" class="source_line" href="#L6">6</a>
<a id="L7" class="source_line" href="#L7">7</a>
<a id="L8" class="source_line" href="#L8">8</a>
<a id="L9" class="source_line" href="#L9">9</a>
<a id="L10" class="source_line" href="#L10">10</a>
<a id="L11" class="source_line" href="#L11">11</a>
<a id="L12" class="source_line" href="#L12">12</a>
<a id="L13" class="source_line" href="#L13">13</a>
<a id="L14" class="source_line" href="#L14">14</a>
<a id="L15" class="source_line" href="#L15">15</a>
<a id="L16" class="source_line" href="#L16">16</a>
<a id="L17" class="source_line" href="#L17">17</a>
<a id="L18" class="source_line" href="#L18">18</a>
<a id="L19" class="source_line" href="#L19">19</a>
<a id="L20" class="source_line" href="#L20">20</a>
<a id="L21" class="source_line" href="#L21">21</a>
<a id="L22" class="source_line" href="#L22">22</a>
<a id="L23" class="source_line" href="#L23">23</a>
<a id="L24" class="source_line" href="#L24">24</a>
<a id="L25" class="source_line" href="#L25">25</a>
<a id="L26" class="source_line" href="#L26">26</a>
<a id="L27" class="source_line" href="#L27">27</a>
<a id="L28" class="source_line" href="#L28">28</a>
<a id="L29" class="source_line" href="#L29">29</a>
<a id="L30" class="source_line" href="#L30">30</a>
<a id="L31" class="source_line" href="#L31">31</a>
<a id="L32" class="source_line" href="#L32">32</a>
<a id="L33" class="source_line" href="#L33">33</a>
<a id="L34" class="source_line" href="#L34">34</a>
<a id="L35" class="source_line" href="#L35">35</a>
<a id="L36" class="source_line" href="#L36">36</a>
<a id="L37" class="source_line" href="#L37">37</a>
<a id="L38" class="source_line" href="#L38">38</a>
<a id="L39" class="source_line" href="#L39">39</a>
<a id="L40" class="source_line" href="#L40">40</a>
<a id="L41" class="source_line" href="#L41">41</a>
<a id="L42" class="source_line" href="#L42">42</a>
<a id="L43" class="source_line" href="#L43">43</a>
<a id="L44" class="source_line" href="#L44">44</a>
<a id="L45" class="source_line" href="#L45">45</a>
<a id="L46" class="source_line" href="#L46">46</a>
<a id="L47" class="source_line" href="#L47">47</a>
<a id="L48" class="source_line" href="#L48">48</a>
<a id="L49" class="source_line" href="#L49">49</a>
<a id="L50" class="source_line" href="#L50">50</a>
<a id="L51" class="source_line" href="#L51">51</a>
<a id="L52" class="source_line" href="#L52">52</a>
<a id="L53" class="source_line" href="#L53">53</a>
<a id="L54" class="source_line" href="#L54">54</a>
<a id="L55" class="source_line" href="#L55">55</a>
<a id="L56" class="source_line" href="#L56">56</a>
<a id="L57" class="source_line" href="#L57">57</a>
<a id="L58" class="source_line" href="#L58">58</a>
<a id="L59" class="source_line" href="#L59">59</a>
<a id="L60" class="source_line" href="#L60">60</a>
<a id="L61" class="source_line" href="#L61">61</a>
<a id="L62" class="source_line" href="#L62">62</a>
<a id="L63" class="source_line" href="#L63">63</a>
<a id="L64" class="source_line" href="#L64">64</a>
<a id="L65" class="source_line" href="#L65">65</a>
<a id="L66" class="source_line" href="#L66">66</a>
<a id="L67" class="source_line" href="#L67">67</a>
<a id="L68" class="source_line" href="#L68">68</a>
<a id="L69" class="source_line" href="#L69">69</a>
<a id="L70" class="source_line" href="#L70">70</a>
<a id="L71" class="source_line" href="#L71">71</a>
<a id="L72" class="source_line" href="#L72">72</a>
<a id="L73" class="source_line" href="#L73">73</a>
<a id="L74" class="source_line" href="#L74">74</a>
<a id="L75" class="source_line" href="#L75">75</a>
<a id="L76" class="source_line" href="#L76">76</a>
<a id="L77" class="source_line" href="#L77">77</a>
<a id="L78" class="source_line" href="#L78">78</a>
<a id="L79" class="source_line" href="#L79">79</a>
<a id="L80" class="source_line" href="#L80">80</a>
<a id="L81" class="source_line" href="#L81">81</a>
<a id="L82" class="source_line" href="#L82">82</a>
<a id="L83" class="source_line" href="#L83">83</a>
<a id="L84" class="source_line" href="#L84">84</a>
<a id="L85" class="source_line" href="#L85">85</a>
<a id="L86" class="source_line" href="#L86">86</a>
<a id="L87" class="source_line" href="#L87">87</a>
<a id="L88" class="source_line" href="#L88">88</a>
<a id="L89" class="source_line" href="#L89">89</a>
<a id="L90" class="source_line" href="#L90">90</a>
<a id="L91" class="source_line" href="#L91">91</a>
<a id="L92" class="source_line" href="#L92">92</a>
<a id="L93" class="source_line" href="#L93">93</a>
<a id="L94" class="source_line" href="#L94">94</a>
<a id="L95" class="source_line" href="#L95">95</a>
<a id="L96" class="source_line" href="#L96">96</a>
<a id="L97" class="source_line" href="#L97">97</a>
<a id="L98" class="source_line" href="#L98">98</a>
<a id="L99" class="source_line" href="#L99">99</a>
<a id="L100" class="source_line" href="#L100">100</a>
<a id="L101" class="source_line" href="#L101">101</a>
<a id="L102" class="source_line" href="#L102">102</a>
<a id="L103" class="source_line" href="#L103">103</a>
<a id="L104" class="source_line" href="#L104">104</a>
<a id="L105" class="source_line" href="#L105">105</a>
<a id="L106" class="source_line" href="#L106">106</a>
<a id="L107" class="source_line" href="#L107">107</a>
<a id="L108" class="source_line" href="#L108">108</a>
<a id="L109" class="source_line" href="#L109">109</a>
<a id="L110" class="source_line" href="#L110">110</a>
<a id="L111" class="source_line" href="#L111">111</a>
<a id="L112" class="source_line" href="#L112">112</a>
<a id="L113" class="source_line" href="#L113">113</a>
<a id="L114" class="source_line" href="#L114">114</a>
<a id="L115" class="source_line" href="#L115">115</a>
<a id="L116" class="source_line" href="#L116">116</a>
<a id="L117" class="source_line" href="#L117">117</a>
<a id="L118" class="source_line" href="#L118">118</a>
<a id="L119" class="source_line" href="#L119">119</a>
<a id="L120" class="source_line" href="#L120">120</a>
<a id="L121" class="source_line" href="#L121">121</a>
<a id="L122" class="source_line" href="#L122">122</a>
<a id="L123" class="source_line" href="#L123">123</a>
<a id="L124" class="source_line" href="#L124">124</a>
<a id="L125" class="source_line" href="#L125">125</a>
<a id="L126" class="source_line" href="#L126">126</a>
<a id="L127" class="source_line" href="#L127">127</a>
<a id="L128" class="source_line" href="#L128">128</a>
<a id="L129" class="source_line" href="#L129">129</a>
<a id="L130" class="source_line" href="#L130">130</a>
<a id="L131" class="source_line" href="#L131">131</a>
<a id="L132" class="source_line" href="#L132">132</a>
<a id="L133" class="source_line" href="#L133">133</a>
<a id="L134" class="source_line" href="#L134">134</a>
<a id="L135" class="source_line" href="#L135">135</a>
<a id="L136" class="source_line" href="#L136">136</a>
<a id="L137" class="source_line" href="#L137">137</a>
<a id="L138" class="source_line" href="#L138">138</a>
<a id="L139" class="source_line" href="#L139">139</a>
<a id="L140" class="source_line" href="#L140">140</a>
<a id="L141" class="source_line" href="#L141">141</a>
<a id="L142" class="source_line" href="#L142">142</a>
<a id="L143" class="source_line" href="#L143">143</a>
<a id="L144" class="source_line" href="#L144">144</a>
<a id="L145" class="source_line" href="#L145">145</a>
<a id="L146" class="source_line" href="#L146">146</a>
<a id="L147" class="source_line" href="#L147">147</a>
<a id="L148" class="source_line" href="#L148">148</a>
<a id="L149" class="source_line" href="#L149">149</a>
<a id="L150" class="source_line" href="#L150">150</a>
<a id="L151" class="source_line" href="#L151">151</a>
<a id="L152" class="source_line" href="#L152">152</a>
<a id="L153" class="source_line" href="#L153">153</a>
<a id="L154" class="source_line" href="#L154">154</a>
<a id="L155" class="source_line" href="#L155">155</a>
<a id="L156" class="source_line" href="#L156">156</a>
<a id="L157" class="source_line" href="#L157">157</a>
<a id="L158" class="source_line" href="#L158">158</a>
<a id="L159" class="source_line" href="#L159">159</a>
<a id="L160" class="source_line" href="#L160">160</a>
<a id="L161" class="source_line" href="#L161">161</a>
<a id="L162" class="source_line" href="#L162">162</a>
<a id="L163" class="source_line" href="#L163">163</a>
<a id="L164" class="source_line" href="#L164">164</a>
<a id="L165" class="source_line" href="#L165">165</a>
<a id="L166" class="source_line" href="#L166">166</a>
<a id="L167" class="source_line" href="#L167">167</a>
<a id="L168" class="source_line" href="#L168">168</a>
<a id="L169" class="source_line" href="#L169">169</a>
<a id="L170" class="source_line" href="#L170">170</a>
<a id="L171" class="source_line" href="#L171">171</a>
<a id="L172" class="source_line" href="#L172">172</a>
<a id="L173" class="source_line" href="#L173">173</a>
<a id="L174" class="source_line" href="#L174">174</a>
<a id="L175" class="source_line" href="#L175">175</a>
<a id="L176" class="source_line" href="#L176">176</a>
<a id="L177" class="source_line" href="#L177">177</a>
<a id="L178" class="source_line" href="#L178">178</a>
<a id="L179" class="source_line" href="#L179">179</a>
<a id="L180" class="source_line" href="#L180">180</a>
<a id="L181" class="source_line" href="#L181">181</a>
<a id="L182" class="source_line" href="#L182">182</a>
<a id="L183" class="source_line" href="#L183">183</a>
<a id="L184" class="source_line" href="#L184">184</a>
<a id="L185" class="source_line" href="#L185">185</a>
<a id="L186" class="source_line" href="#L186">186</a>
<a id="L187" class="source_line" href="#L187">187</a>
<a id="L188" class="source_line" href="#L188">188</a>
<a id="L189" class="source_line" href="#L189">189</a>
<a id="L190" class="source_line" href="#L190">190</a>
<a id="L191" class="source_line" href="#L191">191</a>
<a id="L192" class="source_line" href="#L192">192</a>
<a id="L193" class="source_line" href="#L193">193</a>
<a id="L194" class="source_line" href="#L194">194</a>
<a id="L195" class="source_line" href="#L195">195</a>
<a id="L196" class="source_line" href="#L196">196</a>
<a id="L197" class="source_line" href="#L197">197</a>
<a id="L198" class="source_line" href="#L198">198</a>
<a id="L199" class="source_line" href="#L199">199</a>
<a id="L200" class="source_line" href="#L200">200</a>
<a id="L201" class="source_line" href="#L201">201</a>
<a id="L202" class="source_line" href="#L202">202</a>
<a id="L203" class="source_line" href="#L203">203</a>
<a id="L204" class="source_line" href="#L204">204</a>
<a id="L205" class="source_line" href="#L205">205</a>
<a id="L206" class="source_line" href="#L206">206</a>
<a id="L207" class="source_line" href="#L207">207</a>
<a id="L208" class="source_line" href="#L208">208</a>
<a id="L209" class="source_line" href="#L209">209</a>
<a id="L210" class="source_line" href="#L210">210</a>
<a id="L211" class="source_line" href="#L211">211</a>
<a id="L212" class="source_line" href="#L212">212</a>
<a id="L213" class="source_line" href="#L213">213</a>
<a id="L214" class="source_line" href="#L214">214</a>
<a id="L215" class="source_line" href="#L215">215</a>
<a id="L216" class="source_line" href="#L216">216</a>
<a id="L217" class="source_line" href="#L217">217</a>
<a id="L218" class="source_line" href="#L218">218</a>
<a id="L219" class="source_line" href="#L219">219</a>
<a id="L220" class="source_line" href="#L220">220</a>
<a id="L221" class="source_line" href="#L221">221</a>
<a id="L222" class="source_line" href="#L222">222</a>
<a id="L223" class="source_line" href="#L223">223</a>
<a id="L224" class="source_line" href="#L224">224</a>
<a id="L225" class="source_line" href="#L225">225</a>
<a id="L226" class="source_line" href="#L226">226</a>
<a id="L227" class="source_line" href="#L227">227</a>
<a id="L228" class="source_line" href="#L228">228</a>
<a id="L229" class="source_line" href="#L229">229</a>
<a id="L230" class="source_line" href="#L230">230</a>
<a id="L231" class="source_line" href="#L231">231</a>
<a id="L232" class="source_line" href="#L232">232</a>
<a id="L233" class="source_line" href="#L233">233</a>
<a id="L234" class="source_line" href="#L234">234</a>
<a id="L235" class="source_line" href="#L235">235</a>
<a id="L236" class="source_line" href="#L236">236</a>
<a id="L237" class="source_line" href="#L237">237</a>
<a id="L238" class="source_line" href="#L238">238</a>
<a id="L239" class="source_line" href="#L239">239</a>
<a id="L240" class="source_line" href="#L240">240</a>
<a id="L241" class="source_line" href="#L241">241</a>
<a id="L242" class="source_line" href="#L242">242</a>
<a id="L243" class="source_line" href="#L243">243</a>
<a id="L244" class="source_line" href="#L244">244</a>
<a id="L245" class="source_line" href="#L245">245</a>
<a id="L246" class="source_line" href="#L246">246</a>
<a id="L247" class="source_line" href="#L247">247</a>
<a id="L248" class="source_line" href="#L248">248</a>
<a id="L249" class="source_line" href="#L249">249</a>
<a id="L250" class="source_line" href="#L250">250</a>
<a id="L251" class="source_line" href="#L251">251</a>
<a id="L252" class="source_line" href="#L252">252</a>
<a id="L253" class="source_line" href="#L253">253</a>
<a id="L254" class="source_line" href="#L254">254</a>
<a id="L255" class="source_line" href="#L255">255</a>
<a id="L256" class="source_line" href="#L256">256</a>
<a id="L257" class="source_line" href="#L257">257</a>
<a id="L258" class="source_line" href="#L258">258</a>
<a id="L259" class="source_line" href="#L259">259</a>
<a id="L260" class="source_line" href="#L260">260</a>
<a id="L261" class="source_line" href="#L261">261</a>
<a id="L262" class="source_line" href="#L262">262</a>
<a id="L263" class="source_line" href="#L263">263</a>
<a id="L264" class="source_line" href="#L264">264</a>
<a id="L265" class="source_line" href="#L265">265</a>
<a id="L266" class="source_line" href="#L266">266</a>
<a id="L267" class="source_line" href="#L267">267</a>
<a id="L268" class="source_line" href="#L268">268</a>
<a id="L269" class="source_line" href="#L269">269</a>
<a id="L270" class="source_line" href="#L270">270</a>
<a id="L271" class="source_line" href="#L271">271</a>
<a id="L272" class="source_line" href="#L272">272</a>
<a id="L273" class="source_line" href="#L273">273</a>
<a id="L274" class="source_line" href="#L274">274</a>
<a id="L275" class="source_line" href="#L275">275</a>
<a id="L276" class="source_line" href="#L276">276</a>
<a id="L277" class="source_line" href="#L277">277</a>
<a id="L278" class="source_line" href="#L278">278</a>
<a id="L279" class="source_line" href="#L279">279</a>
<a id="L280" class="source_line" href="#L280">280</a>
<a id="L281" class="source_line" href="#L281">281</a>
<a id="L282" class="source_line" href="#L282">282</a>
<a id="L283" class="source_line" href="#L283">283</a>
<a id="L284" class="source_line" href="#L284">284</a>
<a id="L285" class="source_line" href="#L285">285</a>
<a id="L286" class="source_line" href="#L286">286</a>
<a id="L287" class="source_line" href="#L287">287</a>
<a id="L288" class="source_line" href="#L288">288</a>
<a id="L289" class="source_line" href="#L289">289</a>
<a id="L290" class="source_line" href="#L290">290</a>
<a id="L291" class="source_line" href="#L291">291</a>
<a id="L292" class="source_line" href="#L292">292</a>
<a id="L293" class="source_line" href="#L293">293</a>
<a id="L294" class="source_line" href="#L294">294</a>
<a id="L295" class="source_line" href="#L295">295</a>
<a id="L296" class="source_line" href="#L296">296</a>
<a id="L297" class="source_line" href="#L297">297</a>
<a id="L298" class="source_line" href="#L298">298</a>
<a id="L299" class="source_line" href="#L299">299</a>
<a id="L300" class="source_line" href="#L300">300</a>
<a id="L301" class="source_line" href="#L301">301</a>
<a id="L302" class="source_line" href="#L302">302</a>
<a id="L303" class="source_line" href="#L303">303</a>
<a id="L304" class="source_line" href="#L304">304</a>
<a id="L305" class="source_line" href="#L305">305</a>
<a id="L306" class="source_line" href="#L306">306</a>
<a id="L307" class="source_line" href="#L307">307</a>
<a id="L308" class="source_line" href="#L308">308</a>
<a id="L309" class="source_line" href="#L309">309</a>
<a id="L310" class="source_line" href="#L310">310</a>
<a id="L311" class="source_line" href="#L311">311</a>
<a id="L312" class="source_line" href="#L312">312</a>
<a id="L313" class="source_line" href="#L313">313</a>
<a id="L314" class="source_line" href="#L314">314</a>
<a id="L315" class="source_line" href="#L315">315</a>
<a id="L316" class="source_line" href="#L316">316</a>
<a id="L317" class="source_line" href="#L317">317</a>
<a id="L318" class="source_line" href="#L318">318</a>
<a id="L319" class="source_line" href="#L319">319</a>
<a id="L320" class="source_line" href="#L320">320</a>
<a id="L321" class="source_line" href="#L321">321</a>
<a id="L322" class="source_line" href="#L322">322</a>
<a id="L323" class="source_line" href="#L323">323</a>
<a id="L324" class="source_line" href="#L324">324</a>
<a id="L325" class="source_line" href="#L325">325</a>
<a id="L326" class="source_line" href="#L326">326</a>
<a id="L327" class="source_line" href="#L327">327</a>
<a id="L328" class="source_line" href="#L328">328</a>
<a id="L329" class="source_line" href="#L329">329</a>
<a id="L330" class="source_line" href="#L330">330</a>
<a id="L331" class="source_line" href="#L331">331</a>
<a id="L332" class="source_line" href="#L332">332</a>
<a id="L333" class="source_line" href="#L333">333</a>
<a id="L334" class="source_line" href="#L334">334</a>
<a id="L335" class="source_line" href="#L335">335</a>
<a id="L336" class="source_line" href="#L336">336</a>
<a id="L337" class="source_line" href="#L337">337</a>
<a id="L338" class="source_line" href="#L338">338</a>
<a id="L339" class="source_line" href="#L339">339</a>
<a id="L340" class="source_line" href="#L340">340</a>
<a id="L341" class="source_line" href="#L341">341</a>
<a id="L342" class="source_line" href="#L342">342</a>
<a id="L343" class="source_line" href="#L343">343</a>
<a id="L344" class="source_line" href="#L344">344</a>
<a id="L345" class="source_line" href="#L345">345</a>
<a id="L346" class="source_line" href="#L346">346</a>
<a id="L347" class="source_line" href="#L347">347</a>
<a id="L348" class="source_line" href="#L348">348</a>
<a id="L349" class="source_line" href="#L349">349</a>
<a id="L350" class="source_line" href="#L350">350</a>
<a id="L351" class="source_line" href="#L351">351</a>
<a id="L352" class="source_line" href="#L352">352</a>
<a id="L353" class="source_line" href="#L353">353</a>
<a id="L354" class="source_line" href="#L354">354</a>
<a id="L355" class="source_line" href="#L355">355</a>
<a id="L356" class="source_line" href="#L356">356</a>
<a id="L357" class="source_line" href="#L357">357</a>
<a id="L358" class="source_line" href="#L358">358</a>
<a id="L359" class="source_line" href="#L359">359</a>
<a id="L360" class="source_line" href="#L360">360</a>
<a id="L361" class="source_line" href="#L361">361</a>
<a id="L362" class="source_line" href="#L362">362</a>
<a id="L363" class="source_line" href="#L363">363</a>
<a id="L364" class="source_line" href="#L364">364</a>
<a id="L365" class="source_line" href="#L365">365</a>
<a id="L366" class="source_line" href="#L366">366</a>
<a id="L367" class="source_line" href="#L367">367</a>
<a id="L368" class="source_line" href="#L368">368</a>
<a id="L369" class="source_line" href="#L369">369</a>
<a id="L370" class="source_line" href="#L370">370</a>
<a id="L371" class="source_line" href="#L371">371</a>
<a id="L372" class="source_line" href="#L372">372</a>
<a id="L373" class="source_line" href="#L373">373</a>
<a id="L374" class="source_line" href="#L374">374</a>
<a id="L375" class="source_line" href="#L375">375</a>
<a id="L376" class="source_line" href="#L376">376</a>
<a id="L377" class="source_line" href="#L377">377</a>
<a id="L378" class="source_line" href="#L378">378</a>
<a id="L379" class="source_line" href="#L379">379</a>
<a id="L380" class="source_line" href="#L380">380</a>
<a id="L381" class="source_line" href="#L381">381</a>
<a id="L382" class="source_line" href="#L382">382</a>
<a id="L383" class="source_line" href="#L383">383</a>
<a id="L384" class="source_line" href="#L384">384</a>
<a id="L385" class="source_line" href="#L385">385</a>
<a id="L386" class="source_line" href="#L386">386</a>
<a id="L387" class="source_line" href="#L387">387</a>
<a id="L388" class="source_line" href="#L388">388</a>
<a id="L389" class="source_line" href="#L389">389</a>
<a id="L390" class="source_line" href="#L390">390</a>
<a id="L391" class="source_line" href="#L391">391</a>
<a id="L392" class="source_line" href="#L392">392</a>
<a id="L393" class="source_line" href="#L393">393</a>
<a id="L394" class="source_line" href="#L394">394</a>
<a id="L395" class="source_line" href="#L395">395</a>
<a id="L396" class="source_line" href="#L396">396</a>
<a id="L397" class="source_line" href="#L397">397</a>
<a id="L398" class="source_line" href="#L398">398</a>
<a id="L399" class="source_line" href="#L399">399</a>
<a id="L400" class="source_line" href="#L400">400</a>
<a id="L401" class="source_line" href="#L401">401</a>
<a id="L402" class="source_line" href="#L402">402</a>
<a id="L403" class="source_line" href="#L403">403</a>
<a id="L404" class="source_line" href="#L404">404</a>
<a id="L405" class="source_line" href="#L405">405</a>
<a id="L406" class="source_line" href="#L406">406</a>
<a id="L407" class="source_line" href="#L407">407</a>
<a id="L408" class="source_line" href="#L408">408</a>
<a id="L409" class="source_line" href="#L409">409</a>
<a id="L410" class="source_line" href="#L410">410</a>
<a id="L411" class="source_line" href="#L411">411</a>
<a id="L412" class="source_line" href="#L412">412</a>
<a id="L413" class="source_line" href="#L413">413</a>
<a id="L414" class="source_line" href="#L414">414</a>
<a id="L415" class="source_line" href="#L415">415</a>
<a id="L416" class="source_line" href="#L416">416</a>
<a id="L417" class="source_line" href="#L417">417</a>
<a id="L418" class="source_line" href="#L418">418</a>
<a id="L419" class="source_line" href="#L419">419</a>
<a id="L420" class="source_line" href="#L420">420</a>
<a id="L421" class="source_line" href="#L421">421</a>
<a id="L422" class="source_line" href="#L422">422</a>
<a id="L423" class="source_line" href="#L423">423</a>
<a id="L424" class="source_line" href="#L424">424</a>
<a id="L425" class="source_line" href="#L425">425</a>
<a id="L426" class="source_line" href="#L426">426</a>
<a id="L427" class="source_line" href="#L427">427</a>
<a id="L428" class="source_line" href="#L428">428</a>
<a id="L429" class="source_line" href="#L429">429</a>
<a id="L430" class="source_line" href="#L430">430</a>
<a id="L431" class="source_line" href="#L431">431</a>
<a id="L432" class="source_line" href="#L432">432</a>
<a id="L433" class="source_line" href="#L433">433</a>
<a id="L434" class="source_line" href="#L434">434</a>
<a id="L435" class="source_line" href="#L435">435</a>
<a id="L436" class="source_line" href="#L436">436</a>
<a id="L437" class="source_line" href="#L437">437</a>
<a id="L438" class="source_line" href="#L438">438</a>
<a id="L439" class="source_line" href="#L439">439</a>
<a id="L440" class="source_line" href="#L440">440</a>
<a id="L441" class="source_line" href="#L441">441</a>
<a id="L442" class="source_line" href="#L442">442</a>
<a id="L443" class="source_line" href="#L443">443</a>
<a id="L444" class="source_line" href="#L444">444</a>
<a id="L445" class="source_line" href="#L445">445</a>
<a id="L446" class="source_line" href="#L446">446</a>
<a id="L447" class="source_line" href="#L447">447</a>
<a id="L448" class="source_line" href="#L448">448</a>
<a id="L449" class="source_line" href="#L449">449</a>
<a id="L450" class="source_line" href="#L450">450</a>
<a id="L451" class="source_line" href="#L451">451</a>
<a id="L452" class="source_line" href="#L452">452</a>
<a id="L453" class="source_line" href="#L453">453</a>
<a id="L454" class="source_line" href="#L454">454</a>
<a id="L455" class="source_line" href="#L455">455</a>
<a id="L456" class="source_line" href="#L456">456</a>
<a id="L457" class="source_line" href="#L457">457</a>
<a id="L458" class="source_line" href="#L458">458</a>
<a id="L459" class="source_line" href="#L459">459</a>
<a id="L460" class="source_line" href="#L460">460</a>
<a id="L461" class="source_line" href="#L461">461</a>
<a id="L462" class="source_line" href="#L462">462</a>
<a id="L463" class="source_line" href="#L463">463</a>
<a id="L464" class="source_line" href="#L464">464</a>
<a id="L465" class="source_line" href="#L465">465</a>
<a id="L466" class="source_line" href="#L466">466</a>
<a id="L467" class="source_line" href="#L467">467</a>
<a id="L468" class="source_line" href="#L468">468</a>
<a id="L469" class="source_line" href="#L469">469</a>
<a id="L470" class="source_line" href="#L470">470</a>
<a id="L471" class="source_line" href="#L471">471</a>
<a id="L472" class="source_line" href="#L472">472</a>
<a id="L473" class="source_line" href="#L473">473</a>
<a id="L474" class="source_line" href="#L474">474</a>
<a id="L475" class="source_line" href="#L475">475</a>
<a id="L476" class="source_line" href="#L476">476</a>
<a id="L477" class="source_line" href="#L477">477</a>
<a id="L478" class="source_line" href="#L478">478</a>
<a id="L479" class="source_line" href="#L479">479</a>
<a id="L480" class="source_line" href="#L480">480</a>
<a id="L481" class="source_line" href="#L481">481</a>
<a id="L482" class="source_line" href="#L482">482</a>
<a id="L483" class="source_line" href="#L483">483</a>
<a id="L484" class="source_line" href="#L484">484</a>
<a id="L485" class="source_line" href="#L485">485</a>
<a id="L486" class="source_line" href="#L486">486</a>
<a id="L487" class="source_line" href="#L487">487</a>
<a id="L488" class="source_line" href="#L488">488</a>
<a id="L489" class="source_line" href="#L489">489</a>
<a id="L490" class="source_line" href="#L490">490</a>
<a id="L491" class="source_line" href="#L491">491</a>
<a id="L492" class="source_line" href="#L492">492</a>
<a id="L493" class="source_line" href="#L493">493</a>
<a id="L494" class="source_line" href="#L494">494</a>
<a id="L495" class="source_line" href="#L495">495</a>
<a id="L496" class="source_line" href="#L496">496</a>
<a id="L497" class="source_line" href="#L497">497</a>
<a id="L498" class="source_line" href="#L498">498</a>
<a id="L499" class="source_line" href="#L499">499</a>
<a id="L500" class="source_line" href="#L500">500</a>
<a id="L501" class="source_line" href="#L501">501</a>
<a id="L502" class="source_line" href="#L502">502</a>
<a id="L503" class="source_line" href="#L503">503</a>
<a id="L504" class="source_line" href="#L504">504</a>
<a id="L505" class="source_line" href="#L505">505</a>
<a id="L506" class="source_line" href="#L506">506</a>
<a id="L507" class="source_line" href="#L507">507</a>
<a id="L508" class="source_line" href="#L508">508</a>
<a id="L509" class="source_line" href="#L509">509</a>
<a id="L510" class="source_line" href="#L510">510</a>
<a id="L511" class="source_line" href="#L511">511</a>
<a id="L512" class="source_line" href="#L512">512</a>
<a id="L513" class="source_line" href="#L513">513</a>
<a id="L514" class="source_line" href="#L514">514</a>
<a id="L515" class="source_line" href="#L515">515</a>
<a id="L516" class="source_line" href="#L516">516</a>
<a id="L517" class="source_line" href="#L517">517</a>
<a id="L518" class="source_line" href="#L518">518</a>
<a id="L519" class="source_line" href="#L519">519</a>
<a id="L520" class="source_line" href="#L520">520</a>
<a id="L521" class="source_line" href="#L521">521</a>
<a id="L522" class="source_line" href="#L522">522</a>
<a id="L523" class="source_line" href="#L523">523</a>
<a id="L524" class="source_line" href="#L524">524</a>
<a id="L525" class="source_line" href="#L525">525</a>
<a id="L526" class="source_line" href="#L526">526</a>
<a id="L527" class="source_line" href="#L527">527</a>
<a id="L528" class="source_line" href="#L528">528</a>
<a id="L529" class="source_line" href="#L529">529</a>
<a id="L530" class="source_line" href="#L530">530</a>
<a id="L531" class="source_line" href="#L531">531</a>
<a id="L532" class="source_line" href="#L532">532</a>
<a id="L533" class="source_line" href="#L533">533</a>
<a id="L534" class="source_line" href="#L534">534</a>
<a id="L535" class="source_line" href="#L535">535</a>
<a id="L536" class="source_line" href="#L536">536</a>
<a id="L537" class="source_line" href="#L537">537</a>
<a id="L538" class="source_line" href="#L538">538</a>
<a id="L539" class="source_line" href="#L539">539</a>
<a id="L540" class="source_line" href="#L540">540</a>
<a id="L541" class="source_line" href="#L541">541</a>
<a id="L542" class="source_line" href="#L542">542</a>
<a id="L543" class="source_line" href="#L543">543</a>
<a id="L544" class="source_line" href="#L544">544</a>
<a id="L545" class="source_line" href="#L545">545</a>
<a id="L546" class="source_line" href="#L546">546</a>
<a id="L547" class="source_line" href="#L547">547</a>
<a id="L548" class="source_line" href="#L548">548</a>
<a id="L549" class="source_line" href="#L549">549</a>
<a id="L550" class="source_line" href="#L550">550</a>
<a id="L551" class="source_line" href="#L551">551</a>
<a id="L552" class="source_line" href="#L552">552</a>
</code><code class="source_code"><span><span class="COMMENT">(* A lock-free synchronous channel with cancellation, using Cells.

   Producers and consumers are paired off and then the producer transfers its
   value to the consumer. This is effectively a bounded queue with a capacity
   of zero.

   Both producers and consumers can cancel while waiting.

   There is an atomic int ([balance]), plus two queues ([consumers] and
   [producers]) made using Cells. When [balance] is positive, it is the number
   of producers waiting with values that no one is yet responsible for
   resuming. When negative, it is the (negative) number of waiting consumers
   that no one is responsible for resuming.

   To put an item:

   1. The producer increments [balance].
   2. If it was negative, the producer resumes one waiting consumer on the [consumers] queue.
      Otherwise, it suspends itself on the [producers] queue.

   To take an item:

   1. The consumer decrements [balance].
   2. If it was positive, the consumer resumes one waiting producer on the [producers] queue.
      Otherwise, it suspends itself on the [consumers] queue.

   Therefore, we never try to resume on a queue unless another party has
   started the process of suspending on it.

   The system will not become idle while a client is responsible for resuming
   something. Therefore, when idle:

   - If [balance &lt;= 0] then there are no waiting producers.
   - If [balance &gt;= 0] then there are no waiting consumers.
   - So, we never have waiting consumers and producers at the same time.

   As usual with Cells, either party may get to the new cell first. Whichever party
   arrives first writes a callback, which the other party will then call when they arrive.

   Note on terminology:

   - The &quot;suspender&quot; of a cell is the party that incremented the queue's suspend index,
     and the &quot;resumer&quot; of a cell is the party that incremented the resume index.

   - Whether &quot;suspending&quot; or &quot;resuming&quot; a cell, you may still have to suspend
     your fiber and resume it later.

   States

   There are four cell states:

   - [In_transition] indicates that the cell is still being initialised, or might be
     getting cancelled. Either way, the suspending party is actively working to
     change the cell's state.

   - [Item] indicates that the producer is ready to provide an item.

   - [Slot] indicates that the consumer is ready to receive an item.

   - [Finished] indicates that the cell is no longer being used (the value has
     been consumed or the cell has finished being cancelled).

   The possible sequences of states on the [producers] queue are:

   In_transition -C&gt; Slot -P&gt; Finished    (consumer arrives first)
                 `P&gt; Item -C&gt; Finished    (producer arrives first)
                          `P&gt; In_transition -P&gt; Finished   (producer cancels)
                                            `C&gt; Slot -P&gt; Finished   (cancellation interrupted)

   Only the producer can cancel here. For the [consumers] queue it's the
   opposite - the consumer can cancel its [Slot].

   Cancellation

   Note that there are two kinds of cancellation here:

   1. A cancelled cell is not considered part of its queue. Anyone seeing one
      (due to a race) will skip over it and use the next cell.

   2. After a consumer and producer have been paired off (and the cell removed
      from its queue), the consumer callback may reject the value. If this
      happens, the producer must start all over again to find another consumer.

   Whenever a consumer sets its callback to reject values, it should then start
   the process of cancelling its cell (if acting as a suspender) so that the
   cell can be GC'd.

   A consumer can only cancel its cell when it's on the [consumers] queue.
   If it's on [producers], it knows a wake up will be coming shortly anyway.
   A consumer cancels its cell as follows:

   1. The consumer sets its cell in [consumers] to [In_transition].
   2. It increments [balance] (from a negative value). It is now committed to cancelling.
   3. It sets its cell to [Finished].

   (1) will fail if the cell got resumed first. In that case the consumer just
   rejects the cancellation attempt.

   (2) will fail if [balance &gt;= 0]. In that case the consumer has not cancelled,
   and is about to be resumed instead. It tries to return to the [Slot] state.
   If that fails, the cell now contains an Item and the consumer takes it.

   (3) will fail if a producer arrived after the consumer committed to cancelling.
   In that case, the consumer passes the Item on to the next consumer (there
   must be another one, since both the consumer and producer incremented
   [balance] from a negative value).

   Cancelling a producer is very similar to cancelling a consumer, just with the
   [producers] queue and decrementing the balance from a positive value.

   Non-blocking take

   To perform a non-blocking take:

   1. The consumer decrements [balance] from a positive number.
   2. The consumer takes the next resume cell from [producers].
   3. The consumer takes the [Item] from the cell, setting it to [Finished].

   (1) will fail if there are no unassigned items available.
   Then the [take_nonblocking] returns [None], as there are no items waiting.

   (3) will fail if the producer is initialising or cancelling. In either case,
   the consumer sets its cell to a request with a dummy callback that rejects
   all values and continues immediately.

   Close

   The LSB of the balance atomic is used to indicate that the stream has been closed.
   When closed, the balance is always zero and no new consumers or producers can be added.
   The closing thread is responsible for cancelling all pre-existing users.

   The exchange

   Once a producer and consumer have been paired off (and so their cell is now Finished),
   the producer's value is passed to the consumer's callback. If the consumer accepts it,
   then both fibers are resumed. If not, the producer starts again (incrementing [balance]
   again) and waits for another consumer.

   The above has not been formally verified (exercise for reader!). *)</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* Import these directly because we copy this file for the dscheck tests. *)</span><span class="EOL">
</span><span id="module-Fiber_context"><span class="MODULE">module</span> <span class="UIDENT">Fiber_context</span> <span class="EQUAL">=</span> <a href="../eio.core/eio__core.ml.html#module-Private.module-Fiber_context"><span class="UIDENT">Eio__core</span><span class="DOT">.</span><span class="UIDENT">Private</span><span class="DOT">.</span><span class="UIDENT">Fiber_context</span></a></span><span class="EOL">
</span><span id="module-Suspend"><span class="MODULE">module</span> <span class="UIDENT">Suspend</span> <span class="EQUAL">=</span> <a href="../eio.core/eio__core.ml.html#module-Private.module-Suspend"><span class="UIDENT">Eio__core</span><span class="DOT">.</span><span class="UIDENT">Private</span><span class="DOT">.</span><span class="UIDENT">Suspend</span></a></span><span class="EOL">
</span><span id="module-Cancel"><span class="MODULE">module</span> <span class="UIDENT">Cancel</span> <span class="EQUAL">=</span> <a href="../eio.core/eio__core.ml.html#module-Cancel"><span class="UIDENT">Eio__core</span><span class="DOT">.</span><span class="UIDENT">Cancel</span></a></span><span class="EOL">
</span><span class="EOL">
</span><span id="type-producer_result"><span class="TYPE">type</span> <span class="LIDENT">producer_result</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span id="type-producer_result.constructor-Sent"><span class="BAR">|</span> <span class="UIDENT">Sent</span></span>                <span class="COMMENT">(* Consumer accepted item. *)</span><span class="EOL">
</span>  <span id="type-producer_result.constructor-Rejected"><span class="BAR">|</span> <span class="UIDENT">Rejected</span></span>            <span class="COMMENT">(* Consumer rejected the item. Retry. *)</span><span class="EOL">
</span>  <span id="type-producer_result.constructor-Failed"><span class="BAR">|</span> <span class="UIDENT">Failed</span> <span class="OF">of</span> <span class="LIDENT">exn</span></span></span>       <span class="COMMENT">(* Cancelled or closed. *)</span><span class="EOL">
</span><span class="EOL">
</span><span id="type-item"><span class="TYPE">type</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">item</span> <span class="EQUAL">=</span> <span class="LBRACE">{</span><span class="EOL">
</span>  <span id="def_123"><span class="LIDENT">v</span> <span class="COLON">:</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#type-result"><span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="LBRACKET">[</span><span class="BACKQUOTE">`</span><span class="UIDENT">Closed</span><span class="RBRACKET">]</span><span class="RPAREN">)</span> <span class="LIDENT">result</span></a><span class="SEMI">;</span></span><span class="EOL">
</span>  <span id="def_122"><span class="LIDENT">kp</span> <span class="COLON">:</span> <span class="LIDENT">producer_result</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span><span class="SEMI">;</span></span><span class="EOL">
</span>  <span id="def_124"><span class="LIDENT">cancel</span> <span class="COLON">:</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#type-t"><span class="LBRACKET">[</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Resuming</span>                         <span class="COMMENT">(* In the process of resuming, so can't cancel. *)</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Suspended</span> <span class="OF">of</span> <span class="LPAREN">(</span><span class="LIDENT">unit</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">bool</span><span class="RPAREN">)</span>      <span class="COMMENT">(* Call this function to attempt to leave the queue. *)</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Cancelled</span> <span class="OF">of</span> <span class="LIDENT">exn</span>                 <span class="COMMENT">(* Already cancelled. *)</span><span class="EOL">
</span>  <span class="RBRACKET">]</span> <span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">t</span></a><span class="SEMI">;</span></span><span class="EOL">
</span><span class="RBRACE">}</span></span><span class="EOL">
</span><span class="EOL">
</span><span id="type-cell"><span class="TYPE">type</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">cell</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span id="type-cell.constructor-In_transition"><span class="BAR">|</span> <span class="UIDENT">In_transition</span></span><span class="EOL">
</span>  <span id="type-cell.constructor-Slot"><span class="BAR">|</span> <span class="UIDENT">Slot</span> <span class="OF">of</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#type-result"><span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="LBRACKET">[</span><span class="BACKQUOTE">`</span><span class="UIDENT">Closed</span><span class="RBRACKET">]</span><span class="RPAREN">)</span> <span class="LIDENT">result</span></a> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">bool</span><span class="RPAREN">)</span></span><span class="EOL">
</span>  <span id="type-cell.constructor-Item"><span class="BAR">|</span> <span class="UIDENT">Item</span> <span class="OF">of</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">item</span></span><span class="EOL">
</span>  <span id="type-cell.constructor-Finished"><span class="BAR">|</span> <span class="UIDENT">Finished</span></span></span><span class="EOL">
</span><span class="EOL">
</span><span id="module-Cell"><span class="MODULE">module</span> <span class="UIDENT">Cell</span> <span class="EQUAL">=</span> <span class="STRUCT">struct</span><span class="EOL">
</span>  <span id="module-Cell.type-t"><span class="TYPE">type</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="EQUAL">=</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">cell</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Cell.val-init"><span class="LIDENT">init</span></span> <span class="EQUAL">=</span> <span class="UIDENT">In_transition</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Cell.val-segment_order"><span class="LIDENT">segment_order</span></span> <span class="EQUAL">=</span> <span class="INT">2</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Cell.val-dump"><span class="LIDENT">dump</span></span> <span id="local_f_1"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span> <span class="FUNCTION">function</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">In_transition</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Fmt</span><span class="DOT">.</span><span class="LIDENT">string</span> <a href="#local_f_1"><span class="LIDENT">f</span></a> <span class="STRING">&quot;In_transition&quot;</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Slot</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Fmt</span><span class="DOT">.</span><span class="LIDENT">string</span> <a href="#local_f_1"><span class="LIDENT">f</span></a> <span class="STRING">&quot;Slot&quot;</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Item</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Fmt</span><span class="DOT">.</span><span class="LIDENT">string</span> <a href="#local_f_1"><span class="LIDENT">f</span></a> <span class="STRING">&quot;Item&quot;</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Finished</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Fmt</span><span class="DOT">.</span><span class="LIDENT">string</span> <a href="#local_f_1"><span class="LIDENT">f</span></a> <span class="STRING">&quot;Finished&quot;</span><span class="EOL">
</span><span class="END">end</span></span><span class="EOL">
</span><span class="EOL">
</span><span id="module-Q"><span class="MODULE">module</span> <span class="UIDENT">Q</span> <span class="EQUAL">=</span> <a href="../eio.core/cells.ml.html#module-Make"><span class="UIDENT">Cells</span><span class="DOT">.</span><span class="UIDENT">Make</span></a><span class="LPAREN">(</span><span class="UIDENT">Cell</span><span class="RPAREN">)</span></span><span class="EOL">
</span><span class="EOL">
</span><span id="type-update_result"><span class="TYPE">type</span> <span class="LIDENT">update_result</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span id="type-update_result.constructor-Updated"><span class="BAR">|</span> <span class="UIDENT">Updated</span></span><span class="EOL">
</span>  <span id="type-update_result.constructor-Update_refused"><span class="BAR">|</span> <span class="UIDENT">Update_refused</span></span><span class="EOL">
</span>  <span id="type-update_result.constructor-Balance_closed"><span class="BAR">|</span> <span class="UIDENT">Balance_closed</span></span></span><span class="EOL">
</span><span class="EOL">
</span><span id="module-Balance"><span class="MODULE">module</span> <span class="UIDENT">Balance</span> <span class="COLON">:</span> <span class="SIG">sig</span><span class="EOL">
</span>  <span id="module-Balance.type-t"><span class="TYPE">type</span> <span class="LIDENT">t</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Balance.val-make"><span class="VAL">val</span> <span class="LIDENT">make</span> <span class="COLON">:</span> <span class="LIDENT">unit</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">t</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Balance.val-close"><span class="VAL">val</span> <span class="LIDENT">close</span> <span class="COLON">:</span> <span class="LIDENT">t</span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#type-result"><span class="LPAREN">(</span><span class="LIDENT">int</span><span class="COMMA">,</span> <span class="LBRACKETGREATER">[&gt;</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Closed</span><span class="RBRACKET">]</span><span class="RPAREN">)</span> <span class="LIDENT">result</span></a></span><span class="EOL">
</span>  <span class="COMMENT">(* Mark as closed and return the previous state. *)</span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Balance.val-get"><span class="VAL">val</span> <span class="LIDENT">get</span> <span class="COLON">:</span> <span class="LIDENT">t</span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#type-result"><span class="LPAREN">(</span><span class="LIDENT">int</span><span class="COMMA">,</span> <span class="LBRACKETGREATER">[&gt;</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Closed</span><span class="RBRACKET">]</span><span class="RPAREN">)</span> <span class="LIDENT">result</span></a></span><span class="EOL">
</span>  <span class="DOCSTRING">(** [get t] is the number of items available (if non-negative) or the
      number of consumers waiting for an item. *)</span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Balance.val-fetch_and_add"><span class="VAL">val</span> <span class="LIDENT">fetch_and_add</span> <span class="COLON">:</span> <span class="LIDENT">t</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">int</span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#type-result"><span class="LPAREN">(</span><span class="LIDENT">int</span><span class="COMMA">,</span> <span class="LBRACKETGREATER">[&gt;</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Closed</span><span class="RBRACKET">]</span><span class="RPAREN">)</span> <span class="LIDENT">result</span></a></span><span class="EOL">
</span>  <span class="DOCSTRING">(** [fetch_and_add t diff] increases the value by [diff] and returns the old value. *)</span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Balance.val-incr_if_negative"><span class="VAL">val</span> <span class="LIDENT">incr_if_negative</span> <span class="COLON">:</span> <span class="LIDENT">t</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">update_result</span></span><span class="EOL">
</span>  <span id="module-Balance.val-decr_if_positive"><span class="VAL">val</span> <span class="LIDENT">decr_if_positive</span> <span class="COLON">:</span> <span class="LIDENT">t</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">update_result</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Balance.val-pp"><span class="VAL">val</span> <span class="LIDENT">pp</span> <span class="COLON">:</span> <span class="LIDENT">t</span> <span class="UIDENT">Fmt</span><span class="DOT">.</span><span class="LIDENT">t</span></span><span class="EOL">
</span><span class="END">end</span> <span class="EQUAL">=</span> <span class="STRUCT">struct</span><span class="EOL">
</span>  <span id="module-Balance.type-t"><span class="TYPE">type</span> <span class="LIDENT">t</span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#type-t"><span class="LIDENT">int</span> <span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">t</span></a></span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Balance.val-closed"><span class="LIDENT">closed</span></span> <span class="EQUAL">=</span> <span class="INT">1</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Balance.val-counter"><span class="LIDENT">counter</span></span> <span id="local_x_2"><span class="LIDENT">x</span></span> <span class="EQUAL">=</span> <a href="#local_x_2"><span class="LIDENT">x</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(asr)"><span class="INFIXOP4">asr</span></a> <span class="INT">1</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Balance.val-is_closed"><span class="LIDENT">is_closed</span></span> <span id="local_x_3"><span class="LIDENT">x</span></span> <span class="EQUAL">=</span> <span class="LPAREN">(</span><a href="#local_x_3"><span class="LIDENT">x</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(land)"><span class="INFIXOP3">land</span></a> <span class="INT">1</span><span class="RPAREN">)</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;&gt;)"><span class="INFIXOP0">&lt;&gt;</span></a> <span class="INT">0</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Balance.val-value"><span class="LIDENT">value</span></span> <span id="local_x_4"><span class="LIDENT">x</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="IF">if</span> <span class="LIDENT">is_closed</span> <a href="#local_x_4"><span class="LIDENT">x</span></a> <span class="THEN">then</span> <span class="UIDENT">Error</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Closed</span> <span class="ELSE">else</span> <span class="UIDENT">Ok</span> <span class="LPAREN">(</span><span class="LIDENT">counter</span> <a href="#local_x_4"><span class="LIDENT">x</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Balance.val-fetch_and_add"><span class="LIDENT">fetch_and_add</span></span> <span id="local_x_5"><span class="LIDENT">x</span></span> <span id="local_diff_6"><span class="LIDENT">diff</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">value</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-fetch_and_add"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">fetch_and_add</span></a> <a href="#local_x_5"><span class="LIDENT">x</span></a> <span class="LPAREN">(</span><a href="#local_diff_6"><span class="LIDENT">diff</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(lsl)"><span class="INFIXOP4">lsl</span></a> <span class="INT">1</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="REC">rec</span> <span id="module-Balance.val-decr_if_positive"><span class="LIDENT">decr_if_positive</span></span> <span id="local_t_7"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_x_8"><span class="LIDENT">x</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-get"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">get</span></a> <a href="#local_t_7"><span class="LIDENT">t</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="IF">if</span> <span class="LIDENT">is_closed</span> <a href="#local_x_8"><span class="LIDENT">x</span></a> <span class="THEN">then</span> <span class="UIDENT">Balance_closed</span><span class="EOL">
</span>    <span class="ELSE">else</span> <span class="IF">if</span> <span class="LIDENT">counter</span> <a href="#local_x_8"><span class="LIDENT">x</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <span class="INT">0</span> <span class="THEN">then</span> <span class="LPAREN">(</span><span class="EOL">
</span>      <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-compare_and_set"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">compare_and_set</span></a> <a href="#local_t_7"><span class="LIDENT">t</span></a> <a href="#local_x_8"><span class="LIDENT">x</span></a> <span class="LPAREN">(</span><a href="#local_x_8"><span class="LIDENT">x</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <span class="INT">2</span><span class="RPAREN">)</span> <span class="THEN">then</span> <span class="UIDENT">Updated</span><span class="EOL">
</span>      <span class="ELSE">else</span> <span class="LIDENT">decr_if_positive</span> <a href="#local_t_7"><span class="LIDENT">t</span></a><span class="EOL">
</span>    <span class="RPAREN">)</span> <span class="ELSE">else</span> <span class="UIDENT">Update_refused</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="REC">rec</span> <span id="module-Balance.val-incr_if_negative"><span class="LIDENT">incr_if_negative</span></span> <span id="local_t_9"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_x_10"><span class="LIDENT">x</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-get"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">get</span></a> <a href="#local_t_9"><span class="LIDENT">t</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="IF">if</span> <span class="LIDENT">is_closed</span> <a href="#local_x_10"><span class="LIDENT">x</span></a> <span class="THEN">then</span> <span class="UIDENT">Balance_closed</span><span class="EOL">
</span>    <span class="ELSE">else</span> <span class="IF">if</span> <span class="LIDENT">counter</span> <a href="#local_x_10"><span class="LIDENT">x</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;)"><span class="LESS">&lt;</span></a> <span class="INT">0</span> <span class="THEN">then</span> <span class="LPAREN">(</span><span class="EOL">
</span>      <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-compare_and_set"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">compare_and_set</span></a> <a href="#local_t_9"><span class="LIDENT">t</span></a> <a href="#local_x_10"><span class="LIDENT">x</span></a> <span class="LPAREN">(</span><a href="#local_x_10"><span class="LIDENT">x</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <span class="INT">2</span><span class="RPAREN">)</span> <span class="THEN">then</span> <span class="UIDENT">Updated</span><span class="EOL">
</span>      <span class="ELSE">else</span> <span class="LIDENT">incr_if_negative</span> <a href="#local_t_9"><span class="LIDENT">t</span></a><span class="EOL">
</span>    <span class="RPAREN">)</span> <span class="ELSE">else</span> <span class="UIDENT">Update_refused</span><span class="EOL">
</span>    <span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Balance.val-make"><span class="LIDENT">make</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-make"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">make</span></a> <span class="INT">0</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Balance.val-close"><span class="LIDENT">close</span></span> <span id="local_t_11"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">value</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-exchange"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">exchange</span></a> <a href="#local_t_11"><span class="LIDENT">t</span></a> <span class="LIDENT">closed</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Balance.val-get"><span class="LIDENT">get</span></span> <span id="local_t_12"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span> <span class="LIDENT">value</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-get"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">get</span></a> <a href="#local_t_12"><span class="LIDENT">t</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Balance.val-pp"><span class="LIDENT">pp</span></span> <span id="local_f_13"><span class="LIDENT">f</span></span> <span id="local_t_14"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="MATCH">match</span> <span class="LIDENT">get</span> <a href="#local_t_14"><span class="LIDENT">t</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Ok</span> <span id="local_x_15"><span class="LIDENT">x</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Fmt</span><span class="DOT">.</span><span class="LIDENT">int</span> <a href="#local_f_13"><span class="LIDENT">f</span></a> <a href="#local_x_15"><span class="LIDENT">x</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Error</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Closed</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Fmt</span><span class="DOT">.</span><span class="LIDENT">string</span> <a href="#local_f_13"><span class="LIDENT">f</span></a> <span class="STRING">&quot;(closed)&quot;</span><span class="EOL">
</span><span class="END">end</span></span><span class="EOL">
</span><span class="EOL">
</span><span id="type-t"><span class="TYPE">type</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="EQUAL">=</span> <span class="LBRACE">{</span><span class="EOL">
</span>  <span id="def_127"><span class="LIDENT">balance</span> <span class="COLON">:</span> <span class="UIDENT">Balance</span><span class="DOT">.</span><span class="LIDENT">t</span><span class="SEMI">;</span></span><span class="EOL">
</span>  <span id="def_125"><span class="LIDENT">consumers</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="UIDENT">Q</span><span class="DOT">.</span><span class="LIDENT">t</span><span class="SEMI">;</span></span><span class="EOL">
</span>  <span id="def_126"><span class="LIDENT">producers</span> <span class="COLON">:</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="UIDENT">Q</span><span class="DOT">.</span><span class="LIDENT">t</span><span class="SEMI">;</span></span><span class="EOL">
</span><span class="RBRACE">}</span></span><span class="EOL">
</span><span class="EOL">
</span><span id="type-loc"><span class="TYPE">type</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">loc</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span id="type-loc.constructor-Short"><span class="BAR">|</span> <span class="UIDENT">Short</span> <span class="OF">of</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#type-t"><span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="UIDENT">Cell</span><span class="DOT">.</span><span class="LIDENT">t</span> <span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">t</span></a></span>                 <span class="COMMENT">(* Acting as resumer of cell *)</span><span class="EOL">
</span>  <span id="type-loc.constructor-Long"><span class="BAR">|</span> <span class="UIDENT">Long</span> <span class="OF">of</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="UIDENT">Q</span><span class="DOT">.</span><span class="LIDENT">segment</span> <span class="STAR">*</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#type-t"><span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="UIDENT">Cell</span><span class="DOT">.</span><span class="LIDENT">t</span> <span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">t</span></a><span class="RPAREN">)</span></span></span> <span class="COMMENT">(* Acting as suspender of cell; can cancel *)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-dump"><span class="LIDENT">dump</span></span> <span id="local_f_16"><span class="LIDENT">f</span></span> <span id="local_t_17"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="UIDENT">Fmt</span><span class="DOT">.</span><span class="LIDENT">pf</span> <a href="#local_f_16"><span class="LIDENT">f</span></a> <span class="STRING">&quot;@[&lt;v2&gt;Sync (balance=%a)@,@[&lt;v2&gt;Consumers:@,%a@]@,@[&lt;v2&gt;Producers:@,%a@]@]&quot;</span><span class="EOL">
</span>    <span class="UIDENT">Balance</span><span class="DOT">.</span><span class="LIDENT">pp</span> <a href="#local_t_17"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">balance</span><span class="EOL">
</span>    <span class="UIDENT">Q</span><span class="DOT">.</span><span class="LIDENT">dump</span> <a href="#local_t_17"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">consumers</span><span class="EOL">
</span>    <span class="UIDENT">Q</span><span class="DOT">.</span><span class="LIDENT">dump</span> <a href="#local_t_17"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">producers</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* Give [item] to consumer [kc]. [item]'s cell is now Finished. *)</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-exchange"><span class="LIDENT">exchange</span></span> <span id="local_item_18"><span class="LIDENT">item</span></span> <span id="local_kc_19"><span class="LIDENT">kc</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="#local_item_18"><span class="LIDENT">item</span></a><span class="DOT">.</span><span class="LIDENT">kp</span> <span class="LPAREN">(</span><span class="IF">if</span> <a href="#local_kc_19"><span class="LIDENT">kc</span></a> <a href="#local_item_18"><span class="LIDENT">item</span></a><span class="DOT">.</span><span class="LIDENT">v</span> <span class="THEN">then</span> <span class="UIDENT">Sent</span> <span class="ELSE">else</span> <span class="UIDENT">Rejected</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* Add [value] to [cell].
   If the cell is in transition, place [value] there and let the other party handle it later.
   If the peer's value is already present, do the exchange.
   If the peer cancelled the cell then try the next one on the given resume queue (if we're adding
   to a suspend queue then it can't be cancelled, because the caller controls cancellation).
   This is only used when our fiber is already suspended,
   since we can't create [value] before we have the continuation. *)</span><span class="EOL">
</span><span class="LET">let</span> <span class="REC">rec</span> <span id="val-add_to_cell"><span class="LIDENT">add_to_cell</span></span> <span id="local_queue_20"><span class="LIDENT">queue</span></span> <span id="local_value_21"><span class="LIDENT">value</span></span> <span id="local_cell_22"><span class="LIDENT">cell</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="MATCH">match</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-get"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">get</span></a> <a href="#local_cell_22"><span class="LIDENT">cell</span></a><span class="COMMA">,</span> <a href="#local_value_21"><span class="LIDENT">value</span></a> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Finished</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">add_to_cell</span> <a href="#local_queue_20"><span class="LIDENT">queue</span></a> <a href="#local_value_21"><span class="LIDENT">value</span></a> <span class="LPAREN">(</span><span class="UIDENT">Q</span><span class="DOT">.</span><span class="LIDENT">next_resume</span> <a href="#local_queue_20"><span class="LIDENT">queue</span></a><span class="RPAREN">)</span>     <span class="COMMENT">(* Cancelled - skip *)</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="LPAREN">(</span><span class="UIDENT">Slot</span> <span id="local_kc_24"><span class="LIDENT">kc</span></span>   <span class="AS">as</span> <span id="local_old_23"><span class="LIDENT">old</span></span><span class="RPAREN">)</span><span class="COMMA">,</span> <span class="UIDENT">Item</span> <span id="local_item_25"><span class="LIDENT">item</span></span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="LPAREN">(</span><span class="UIDENT">Item</span> <span id="local_item_27"><span class="LIDENT">item</span></span> <span class="AS">as</span> <span id="local_old_26"><span class="LIDENT">old</span></span><span class="RPAREN">)</span><span class="COMMA">,</span> <span class="UIDENT">Slot</span> <span id="local_kc_28"><span class="LIDENT">kc</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-compare_and_set"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">compare_and_set</span></a> <a href="#local_cell_22"><span class="LIDENT">cell</span></a> <a href="#local_old_26"><span class="LIDENT">old</span></a> <span class="UIDENT">Finished</span> <span class="THEN">then</span> <span class="LIDENT">exchange</span> <a href="#local_item_27"><span class="LIDENT">item</span></a> <a href="#local_kc_28"><span class="LIDENT">kc</span></a><span class="EOL">
</span>    <span class="ELSE">else</span> <span class="LIDENT">add_to_cell</span> <a href="#local_queue_20"><span class="LIDENT">queue</span></a> <a href="#local_value_21"><span class="LIDENT">value</span></a> <a href="#local_cell_22"><span class="LIDENT">cell</span></a><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">In_transition</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-compare_and_set"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">compare_and_set</span></a> <a href="#local_cell_22"><span class="LIDENT">cell</span></a> <span class="UIDENT">In_transition</span> <a href="#local_value_21"><span class="LIDENT">value</span></a> <span class="THEN">then</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="ELSE">else</span> <span class="LIDENT">add_to_cell</span> <a href="#local_queue_20"><span class="LIDENT">queue</span></a> <a href="#local_value_21"><span class="LIDENT">value</span></a> <a href="#local_cell_22"><span class="LIDENT">cell</span></a><span class="EOL">
</span>  <span class="BAR">|</span> <span class="LPAREN">(</span><span class="UIDENT">Slot</span> <span class="UNDERSCORE">_</span> <span class="BAR">|</span> <span class="UIDENT">Item</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="ASSERT">assert</span> <span class="FALSE">false</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* Cancelling *)</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* Cancel [cell] on our suspend queue.
   This function works for both consumers and producers, as we can tell from
   the value what our role is (and if there isn't a value, we're finished anyway).
   Neither party will try to cancel before writing its own value.
   Returns [true] if the caller cancelled successfully,
   or [false] if it must wait (as it's being resumed). *)</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-cancel"><span class="LIDENT">cancel</span></span> <span id="local_t_29"><span class="LIDENT">t</span></span> <span class="LPAREN">(</span><span id="local_segment_30"><span class="LIDENT">segment</span></span><span class="COMMA">,</span> <span id="local_cell_31"><span class="LIDENT">cell</span></span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_cancel2_32"><span class="LIDENT">cancel2</span></span> <span id="local_update_balance_33"><span class="LIDENT">update_balance</span></span> <span class="TILDE">~</span><span id="local_old_34"><span class="LIDENT">old</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-compare_and_set"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">compare_and_set</span></a> <a href="#local_cell_31"><span class="LIDENT">cell</span></a> <a href="#local_old_34"><span class="LIDENT">old</span></a> <span class="UIDENT">In_transition</span> <span class="THEN">then</span> <span class="LPAREN">(</span><span class="EOL">
</span>      <span class="MATCH">match</span> <a href="#local_update_balance_33"><span class="LIDENT">update_balance</span></a> <a href="#local_t_29"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">balance</span> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Updated</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="COMMENT">(* At this point, we are committed to cancelling. *)</span><span class="EOL">
</span>        <span class="BEGIN">begin</span> <span class="MATCH">match</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-exchange"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">exchange</span></a> <a href="#local_cell_31"><span class="LIDENT">cell</span></a> <span class="UIDENT">Finished</span> <span class="WITH">with</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="UIDENT">Finished</span> <span class="MINUSGREATER">-&gt;</span> <span class="ASSERT">assert</span> <span class="FALSE">false</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="UIDENT">In_transition</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Q</span><span class="DOT">.</span><span class="LIDENT">cancel_cell</span> <a href="#local_segment_30"><span class="LIDENT">segment</span></a><span class="EOL">
</span>          <span class="BAR">|</span> <span class="UIDENT">Item</span> <span id="local_request_35"><span class="LIDENT">request</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">add_to_cell</span> <a href="#local_t_29"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">consumers</span> <span class="LPAREN">(</span><span class="UIDENT">Item</span> <a href="#local_request_35"><span class="LIDENT">request</span></a><span class="RPAREN">)</span> <span class="LPAREN">(</span><span class="UIDENT">Q</span><span class="DOT">.</span><span class="LIDENT">next_resume</span> <a href="#local_t_29"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">consumers</span><span class="RPAREN">)</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="UIDENT">Slot</span> <span id="local_kc_36"><span class="LIDENT">kc</span></span>      <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">add_to_cell</span> <a href="#local_t_29"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">producers</span> <span class="LPAREN">(</span><span class="UIDENT">Slot</span> <a href="#local_kc_36"><span class="LIDENT">kc</span></a><span class="RPAREN">)</span>      <span class="LPAREN">(</span><span class="UIDENT">Q</span><span class="DOT">.</span><span class="LIDENT">next_resume</span> <a href="#local_t_29"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">producers</span><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="END">end</span><span class="SEMI">;</span><span class="EOL">
</span>        <span class="TRUE">true</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Update_refused</span> <span class="BAR">|</span> <span class="UIDENT">Balance_closed</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="COMMENT">(* We decided not to cancel. We know a resume is coming. *)</span><span class="EOL">
</span>        <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-compare_and_set"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">compare_and_set</span></a> <a href="#local_cell_31"><span class="LIDENT">cell</span></a> <span class="UIDENT">In_transition</span> <a href="#local_old_34"><span class="LIDENT">old</span></a> <span class="THEN">then</span> <span class="FALSE">false</span><span class="EOL">
</span>        <span class="ELSE">else</span> <span class="LPAREN">(</span><span class="EOL">
</span>          <span class="MATCH">match</span> <a href="#local_old_34"><span class="LIDENT">old</span></a><span class="COMMA">,</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-get"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">get</span></a> <a href="#local_cell_31"><span class="LIDENT">cell</span></a> <span class="WITH">with</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="UIDENT">Slot</span> <span id="local_kc_37"><span class="LIDENT">kc</span></span><span class="COMMA">,</span> <span class="UIDENT">Item</span> <span id="local_request_38"><span class="LIDENT">request</span></span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="UIDENT">Item</span> <span id="local_request_39"><span class="LIDENT">request</span></span><span class="COMMA">,</span> <span class="UIDENT">Slot</span> <span id="local_kc_40"><span class="LIDENT">kc</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-set"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">set</span></a> <a href="#local_cell_31"><span class="LIDENT">cell</span></a> <span class="UIDENT">Finished</span><span class="SEMI">;</span><span class="EOL">
</span>            <span class="LIDENT">exchange</span> <a href="#local_request_39"><span class="LIDENT">request</span></a> <a href="#local_kc_40"><span class="LIDENT">kc</span></a><span class="SEMI">;</span><span class="EOL">
</span>            <span class="FALSE">false</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="ASSERT">assert</span> <span class="FALSE">false</span><span class="EOL">
</span>        <span class="RPAREN">)</span><span class="EOL">
</span>    <span class="RPAREN">)</span> <span class="ELSE">else</span> <span class="FALSE">false</span>          <span class="COMMENT">(* The peer resumed us first *)</span><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <span class="MATCH">match</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-get"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">get</span></a> <a href="#local_cell_31"><span class="LIDENT">cell</span></a> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Finished</span> <span class="MINUSGREATER">-&gt;</span> <span class="FALSE">false</span>     <span class="COMMENT">(* The peer resumed us first *)</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Slot</span> <span class="UNDERSCORE">_</span> <span class="AS">as</span> <span id="local_old_41"><span class="LIDENT">old</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_cancel2_32"><span class="LIDENT">cancel2</span></a> <span class="UIDENT">Balance</span><span class="DOT">.</span><span class="LIDENT">incr_if_negative</span> <span class="TILDE">~</span><a href="#local_old_41"><span class="LIDENT">old</span></a>      <span class="COMMENT">(* We are a consumer *)</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Item</span> <span class="UNDERSCORE">_</span> <span class="AS">as</span> <span id="local_old_42"><span class="LIDENT">old</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_cancel2_32"><span class="LIDENT">cancel2</span></a> <span class="UIDENT">Balance</span><span class="DOT">.</span><span class="LIDENT">decr_if_positive</span> <span class="TILDE">~</span><a href="#local_old_42"><span class="LIDENT">old</span></a>      <span class="COMMENT">(* We are a producer *)</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">In_transition</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="COMMENT">(* Either we're initialising the cell, in which case we haven't told the
       application how to cancel this location yet, or we're already
       cancelling, but cancelling twice isn't permitted. *)</span><span class="EOL">
</span>    <span class="ASSERT">assert</span> <span class="FALSE">false</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* A producer can't cancel if it is resuming on the [consumers] queue, and will instead
   just wait for the slot in that case, which will arrive soon. However, after getting
   a slot the producer may be rejected and be asked to start again on the [producers] queue,
   so we need to remember that we were cancelled to prevent that. It's also possible that
   we're already restarting but haven't got around to updating [request.cancel] yet; we'll
   notice the new [`Cancelled] state when we do. *)</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-cancel_put"><span class="LIDENT">cancel_put</span></span> <span id="local_request_43"><span class="LIDENT">request</span></span> <span id="local_ex_44"><span class="LIDENT">ex</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="MATCH">match</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-exchange"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">exchange</span></a> <a href="#local_request_43"><span class="LIDENT">request</span></a><span class="DOT">.</span><span class="LIDENT">cancel</span> <span class="LPAREN">(</span><span class="BACKQUOTE">`</span><span class="UIDENT">Cancelled</span> <a href="#local_ex_44"><span class="LIDENT">ex</span></a><span class="RPAREN">)</span> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Cancelled</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-failwith"><span class="failwith">failwith</span></a> <span class="STRING">&quot;Already cancelled!&quot;</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Resuming</span> <span class="MINUSGREATER">-&gt;</span> <span class="FALSE">false</span>  <span class="COMMENT">(* Cancellation fails for now, but we remember we wanted to cancel. *)</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Suspended</span> <span id="local_cancel_45"><span class="LIDENT">cancel</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_cancel_45"><span class="LIDENT">cancel</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* Putting. *)</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* Like [add_to_cell], but we haven't created our value yet as we haven't suspended the fiber. *)</span><span class="EOL">
</span><span class="LET">let</span> <span class="REC">rec</span> <span id="val-producer_resume_cell"><span class="LIDENT">producer_resume_cell</span></span> <span id="local_t_46"><span class="LIDENT">t</span></span> <span class="TILDE">~</span><span id="local_success_47"><span class="LIDENT">success</span></span> <span class="TILDE">~</span><span id="local_in_transition_48"><span class="LIDENT">in_transition</span></span> <span id="local_cell_49"><span class="LIDENT">cell</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="MATCH">match</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-get"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">get</span></a> <span class="LPAREN">(</span><a href="#local_cell_49"><span class="LIDENT">cell</span></a> <span class="COLON">:</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#type-t"><span class="UNDERSCORE">_</span> <span class="UIDENT">Cell</span><span class="DOT">.</span><span class="LIDENT">t</span> <span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">t</span></a><span class="RPAREN">)</span> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Item</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="ASSERT">assert</span> <span class="FALSE">false</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">In_transition</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_in_transition_48"><span class="LIDENT">in_transition</span></a> <a href="#local_cell_49"><span class="LIDENT">cell</span></a><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Finished</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">producer_resume_cell</span> <a href="#local_t_46"><span class="LIDENT">t</span></a> <span class="TILDE">~</span><a href="#local_success_47"><span class="LIDENT">success</span></a> <span class="TILDE">~</span><a href="#local_in_transition_48"><span class="LIDENT">in_transition</span></a> <span class="LPAREN">(</span><span class="UIDENT">Q</span><span class="DOT">.</span><span class="LIDENT">next_resume</span> <a href="#local_t_46"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">consumers</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Slot</span> <span id="local_k_51"><span class="LIDENT">k</span></span> <span class="AS">as</span> <span id="local_old_50"><span class="LIDENT">old</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-compare_and_set"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">compare_and_set</span></a> <a href="#local_cell_49"><span class="LIDENT">cell</span></a> <a href="#local_old_50"><span class="LIDENT">old</span></a> <span class="UIDENT">Finished</span> <span class="THEN">then</span> <a href="#local_success_47"><span class="LIDENT">success</span></a> <a href="#local_k_51"><span class="LIDENT">k</span></a><span class="EOL">
</span>    <span class="ELSE">else</span> <span class="LIDENT">producer_resume_cell</span> <a href="#local_t_46"><span class="LIDENT">t</span></a> <span class="TILDE">~</span><a href="#local_success_47"><span class="LIDENT">success</span></a> <span class="TILDE">~</span><a href="#local_in_transition_48"><span class="LIDENT">in_transition</span></a> <a href="#local_cell_49"><span class="LIDENT">cell</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* This is essentially the main [put] function, but parameterised so it can be shared with
   the rejoin-after-rejection case. *)</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-producer_join"><span class="LIDENT">producer_join</span></span> <span class="LPAREN">(</span><span id="local_t_52"><span class="LIDENT">t</span></span> <span class="COLON">:</span> <span class="UNDERSCORE">_</span> <span class="LIDENT">t</span><span class="RPAREN">)</span> <span class="TILDE">~</span><span id="local_success_53"><span class="LIDENT">success</span></span> <span class="TILDE">~</span><span id="local_suspend_54"><span class="LIDENT">suspend</span></span> <span class="TILDE">~</span><span id="local_closed_55"><span class="LIDENT">closed</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="MATCH">match</span> <span class="UIDENT">Balance</span><span class="DOT">.</span><span class="LIDENT">fetch_and_add</span> <a href="#local_t_52"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">balance</span> <span class="LPAREN">(</span><span class="PLUS">+</span><span class="INT">1</span><span class="RPAREN">)</span> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Error</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Closed</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_closed_55"><span class="LIDENT">closed</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Ok</span> <span id="local_old_56"><span class="LIDENT">old</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_old_56"><span class="LIDENT">old</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;)"><span class="LESS">&lt;</span></a> <span class="INT">0</span> <span class="THEN">then</span> <span class="LPAREN">(</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_cell_57"><span class="LIDENT">cell</span></span> <span class="EQUAL">=</span> <span class="UIDENT">Q</span><span class="DOT">.</span><span class="LIDENT">next_resume</span> <a href="#local_t_52"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">consumers</span> <span class="IN">in</span><span class="EOL">
</span>      <span class="LIDENT">producer_resume_cell</span> <a href="#local_t_52"><span class="LIDENT">t</span></a> <a href="#local_cell_57"><span class="LIDENT">cell</span></a><span class="EOL">
</span>        <span class="TILDE">~</span><a href="#local_success_53"><span class="LIDENT">success</span></a><span class="EOL">
</span>        <span class="LABEL">~in_transition:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_cell_58"><span class="LIDENT">cell</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_suspend_54"><span class="LIDENT">suspend</span></a> <span class="LPAREN">(</span><span class="UIDENT">Short</span> <a href="#local_cell_58"><span class="LIDENT">cell</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="RPAREN">)</span> <span class="ELSE">else</span> <span class="LPAREN">(</span><span class="EOL">
</span>      <a href="#local_suspend_54"><span class="LIDENT">suspend</span></a> <span class="LPAREN">(</span><span class="UIDENT">Long</span> <span class="LPAREN">(</span><span class="UIDENT">Q</span><span class="DOT">.</span><span class="LIDENT">next_suspend</span> <a href="#local_t_52"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">producers</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-put_closed_err"><span class="LIDENT">put_closed_err</span></span> <span class="EQUAL">=</span> <span class="UIDENT">Invalid_argument</span> <span class="STRING">&quot;Stream closed&quot;</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* Called when a consumer took our value but then rejected it.
   We start the put operation again, except that our fiber is already suspended
   so no need to do that again. We're probably running in the consumer's domain
   (unless the consumer provided their callback while we were cancelling). *)</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-put_already_suspended"><span class="LIDENT">put_already_suspended</span></span> <span id="local_t_59"><span class="LIDENT">t</span></span> <span id="local_request_60"><span class="LIDENT">request</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">producer_join</span> <a href="#local_t_59"><span class="LIDENT">t</span></a><span class="EOL">
</span>    <span class="LABEL">~success:</span><span class="LPAREN">(</span><span class="LIDENT">exchange</span> <a href="#local_request_60"><span class="LIDENT">request</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="LABEL">~closed:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_request_60"><span class="LIDENT">request</span></a><span class="DOT">.</span><span class="LIDENT">kp</span> <span class="LPAREN">(</span><span class="UIDENT">Failed</span> <span class="LIDENT">put_closed_err</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="LABEL">~suspend:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_loc_61"><span class="LIDENT">loc</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LET">let</span> <span class="UIDENT">Short</span> <span id="local_cell_62"><span class="LIDENT">cell</span></span> <span class="BAR">|</span> <span class="UIDENT">Long</span> <span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span id="local_cell_63"><span class="LIDENT">cell</span></span><span class="RPAREN">)</span> <span class="EQUAL">=</span> <a href="#local_loc_61"><span class="LIDENT">loc</span></a> <span class="IN">in</span><span class="EOL">
</span>        <span class="LIDENT">add_to_cell</span> <a href="#local_t_59"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">consumers</span> <span class="LPAREN">(</span><span class="UIDENT">Item</span> <a href="#local_request_60"><span class="LIDENT">request</span></a><span class="RPAREN">)</span> <a href="#local_cell_63"><span class="LIDENT">cell</span></a><span class="SEMI">;</span><span class="EOL">
</span>        <span class="LET">let</span> <span class="REC">rec</span> <span id="local_aux_64"><span class="LIDENT">aux</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>          <span class="MATCH">match</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-get"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">get</span></a> <a href="#local_request_60"><span class="LIDENT">request</span></a><span class="DOT">.</span><span class="LIDENT">cancel</span><span class="COMMA">,</span> <a href="#local_loc_61"><span class="LIDENT">loc</span></a> <span class="WITH">with</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="LPAREN">(</span><span class="BACKQUOTE">`</span><span class="UIDENT">Suspended</span> <span class="UNDERSCORE">_</span> <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Resuming</span> <span class="AS">as</span> <span id="local_prev_65"><span class="LIDENT">prev</span></span><span class="RPAREN">)</span><span class="COMMA">,</span> <span class="UIDENT">Long</span> <span id="local_loc_66"><span class="LIDENT">loc</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <span class="COMMENT">(* We might be suspended for a while. Update the cancel function with the new location. *)</span><span class="EOL">
</span>            <span class="LET">let</span> <span id="local_cancel_fn_67"><span class="LIDENT">cancel_fn</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span> <span class="LIDENT">cancel</span> <a href="#local_t_59"><span class="LIDENT">t</span></a> <a href="#local_loc_66"><span class="LIDENT">loc</span></a> <span class="IN">in</span><span class="EOL">
</span>            <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-not"><span class="LIDENT">not</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-compare_and_set"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">compare_and_set</span></a> <a href="#local_request_60"><span class="LIDENT">request</span></a><span class="DOT">.</span><span class="LIDENT">cancel</span> <a href="#local_prev_65"><span class="LIDENT">prev</span></a> <span class="LPAREN">(</span><span class="BACKQUOTE">`</span><span class="UIDENT">Suspended</span> <a href="#local_cancel_fn_67"><span class="LIDENT">cancel_fn</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span> <span class="THEN">then</span> <a href="#local_aux_64"><span class="LIDENT">aux</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Cancelled</span> <span id="local_ex_68"><span class="LIDENT">ex</span></span><span class="COMMA">,</span> <span class="UIDENT">Long</span> <span id="local_loc_69"><span class="LIDENT">loc</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <span class="COMMENT">(* We got cancelled after the peer removed our cell and before we updated the
               cancel function with the new location, or we were cancelled while doing a
               (non-cancellable) resume. Deal with it now. *)</span><span class="EOL">
</span>            <span class="IF">if</span> <span class="LIDENT">cancel</span> <a href="#local_t_59"><span class="LIDENT">t</span></a> <a href="#local_loc_69"><span class="LIDENT">loc</span></a> <span class="THEN">then</span> <a href="#local_request_60"><span class="LIDENT">request</span></a><span class="DOT">.</span><span class="LIDENT">kp</span> <span class="LPAREN">(</span><span class="UIDENT">Failed</span> <a href="#local_ex_68"><span class="LIDENT">ex</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>            <span class="COMMENT">(* else we got resumed first *)</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UIDENT">Short</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <span class="COMMENT">(* We can't cancel while in the process of resuming a cell on the [consumers] queue.
               We could set [cancel] to [`Resuming] here, but there's no need as trying to use the
               old cancel function will find the old cell is cancelled and set [request.cancel]
               to [`Cancelled]), as required. *)</span><span class="EOL">
</span>            <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="IN">in</span> <a href="#local_aux_64"><span class="LIDENT">aux</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* We tried to [put] and no slot was immediately available.
   Suspend the fiber and use the continuation to finish initialising the cell.
   Note that we may be suspending the fiber even when using the &quot;resume&quot; queue,
   if the consumer is still in the process of writing its slot. *)</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-put_suspend"><span class="LIDENT">put_suspend</span></span> <span id="local_t_70"><span class="LIDENT">t</span></span> <span id="local_v_71"><span class="LIDENT">v</span></span> <span id="local_loc_72"><span class="LIDENT">loc</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="UIDENT">Suspend</span><span class="DOT">.</span><span class="LIDENT">enter_unchecked</span> <span class="STRING">&quot;Sync.put&quot;</span> <span class="INFIXOP1">@@</span> <span class="FUN">fun</span> <span id="local_ctx_73"><span class="LIDENT">ctx</span></span> <span id="local_enqueue_74"><span class="LIDENT">enqueue</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_cancel_75"><span class="LIDENT">cancel</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_loc_72"><span class="LIDENT">loc</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Short</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Resuming</span>      <span class="COMMENT">(* Can't cancel this *)</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Long</span> <span id="local_loc_76"><span class="LIDENT">loc</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Suspended</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">cancel</span> <a href="#local_t_70"><span class="LIDENT">t</span></a> <a href="#local_loc_76"><span class="LIDENT">loc</span></a><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="REC">rec</span> <span id="local_item_77"><span class="LIDENT">item</span></span> <span class="EQUAL">=</span> <span class="LBRACE">{</span><span class="EOL">
</span>    <span class="LIDENT">v</span> <span class="EQUAL">=</span> <span class="UIDENT">Ok</span> <a href="#local_v_71"><span class="LIDENT">v</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">cancel</span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-make"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">make</span></a> <a href="#local_cancel_75"><span class="LIDENT">cancel</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">kp</span> <span class="EQUAL">=</span> <span class="FUNCTION">function</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Failed</span> <span id="local_e_78"><span class="LIDENT">e</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_enqueue_74"><span class="LIDENT">enqueue</span></a> <span class="LPAREN">(</span><span class="UIDENT">Error</span> <a href="#local_e_78"><span class="LIDENT">e</span></a><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Sent</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_enqueue_74"><span class="LIDENT">enqueue</span></a> <span class="LPAREN">(</span><span class="UIDENT">Ok</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="RPAREN">)</span>                   <span class="COMMENT">(* Success! *)</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Rejected</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">put_already_suspended</span> <a href="#local_t_70"><span class="LIDENT">t</span></a> <a href="#local_item_77"><span class="LIDENT">item</span></a>  <span class="COMMENT">(* Consumer rejected value. Restart. *)</span><span class="EOL">
</span>  <span class="RBRACE">}</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="UIDENT">Short</span> <span id="local_cell_79"><span class="LIDENT">cell</span></span> <span class="BAR">|</span> <span class="UIDENT">Long</span> <span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span id="local_cell_80"><span class="LIDENT">cell</span></span><span class="RPAREN">)</span> <span class="EQUAL">=</span> <a href="#local_loc_72"><span class="LIDENT">loc</span></a> <span class="IN">in</span><span class="EOL">
</span>  <span class="LIDENT">add_to_cell</span> <a href="#local_t_70"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">consumers</span> <span class="LPAREN">(</span><span class="UIDENT">Item</span> <a href="#local_item_77"><span class="LIDENT">item</span></a><span class="RPAREN">)</span> <a href="#local_cell_80"><span class="LIDENT">cell</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="COMMENT">(* Set up the cancel handler in either case because we might change queues later: *)</span><span class="EOL">
</span>  <span class="MATCH">match</span> <span class="UIDENT">Fiber_context</span><span class="DOT">.</span><span class="LIDENT">get_error</span> <a href="#local_ctx_73"><span class="LIDENT">ctx</span></a> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_ex_81"><span class="LIDENT">ex</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="IF">if</span> <span class="LIDENT">cancel_put</span> <a href="#local_item_77"><span class="LIDENT">item</span></a> <a href="#local_ex_81"><span class="LIDENT">ex</span></a> <span class="THEN">then</span> <a href="#local_enqueue_74"><span class="LIDENT">enqueue</span></a> <span class="LPAREN">(</span><span class="UIDENT">Error</span> <a href="#local_ex_81"><span class="LIDENT">ex</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="COMMENT">(* else being resumed *)</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="UIDENT">Fiber_context</span><span class="DOT">.</span><span class="LIDENT">set_cancel_fn</span> <a href="#local_ctx_73"><span class="LIDENT">ctx</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_ex_82"><span class="LIDENT">ex</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="IF">if</span> <span class="LIDENT">cancel_put</span> <a href="#local_item_77"><span class="LIDENT">item</span></a> <a href="#local_ex_82"><span class="LIDENT">ex</span></a> <span class="THEN">then</span> <a href="#local_enqueue_74"><span class="LIDENT">enqueue</span></a> <span class="LPAREN">(</span><span class="UIDENT">Error</span> <a href="#local_ex_82"><span class="LIDENT">ex</span></a><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="COMMENT">(* else being resumed *)</span><span class="EOL">
</span>      <span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span class="REC">rec</span> <span id="val-put"><span class="LIDENT">put</span></span> <span class="LPAREN">(</span><span id="local_t_83"><span class="LIDENT">t</span></span> <span class="COLON">:</span> <span class="UNDERSCORE">_</span> <span class="LIDENT">t</span><span class="RPAREN">)</span> <span id="local_v_84"><span class="LIDENT">v</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">producer_join</span> <a href="#local_t_83"><span class="LIDENT">t</span></a><span class="EOL">
</span>    <span class="LABEL">~success:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_kc_85"><span class="LIDENT">kc</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="IF">if</span> <a href="#local_kc_85"><span class="LIDENT">kc</span></a> <span class="LPAREN">(</span><span class="UIDENT">Ok</span> <a href="#local_v_84"><span class="LIDENT">v</span></a><span class="RPAREN">)</span> <span class="THEN">then</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="ELSE">else</span> <span class="LIDENT">put</span> <a href="#local_t_83"><span class="LIDENT">t</span></a> <a href="#local_v_84"><span class="LIDENT">v</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="LABEL">~suspend:</span><span class="LPAREN">(</span><span class="LIDENT">put_suspend</span> <a href="#local_t_83"><span class="LIDENT">t</span></a> <a href="#local_v_84"><span class="LIDENT">v</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="LABEL">~closed:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-raise"><span class="LIDENT">raise</span></a> <span class="LIDENT">put_closed_err</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* Taking. *)</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* Mirror of [producer_resume_cell]. *)</span><span class="EOL">
</span><span class="LET">let</span> <span class="REC">rec</span> <span id="val-consumer_resume_cell"><span class="LIDENT">consumer_resume_cell</span></span> <span id="local_t_86"><span class="LIDENT">t</span></span> <span class="TILDE">~</span><span id="local_success_87"><span class="LIDENT">success</span></span> <span class="TILDE">~</span><span id="local_in_transition_88"><span class="LIDENT">in_transition</span></span> <span id="local_cell_89"><span class="LIDENT">cell</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="MATCH">match</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-get"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">get</span></a> <span class="LPAREN">(</span><a href="#local_cell_89"><span class="LIDENT">cell</span></a> <span class="COLON">:</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#type-t"><span class="UNDERSCORE">_</span> <span class="UIDENT">Cell</span><span class="DOT">.</span><span class="LIDENT">t</span> <span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">t</span></a><span class="RPAREN">)</span> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Slot</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="ASSERT">assert</span> <span class="FALSE">false</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">In_transition</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_in_transition_88"><span class="LIDENT">in_transition</span></a> <a href="#local_cell_89"><span class="LIDENT">cell</span></a><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Finished</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">consumer_resume_cell</span> <a href="#local_t_86"><span class="LIDENT">t</span></a> <span class="TILDE">~</span><a href="#local_success_87"><span class="LIDENT">success</span></a> <span class="TILDE">~</span><a href="#local_in_transition_88"><span class="LIDENT">in_transition</span></a> <span class="LPAREN">(</span><span class="UIDENT">Q</span><span class="DOT">.</span><span class="LIDENT">next_resume</span> <a href="#local_t_86"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">producers</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Item</span> <span id="local_req_91"><span class="LIDENT">req</span></span> <span class="AS">as</span> <span id="local_old_90"><span class="LIDENT">old</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-compare_and_set"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">compare_and_set</span></a> <a href="#local_cell_89"><span class="LIDENT">cell</span></a> <a href="#local_old_90"><span class="LIDENT">old</span></a> <span class="UIDENT">Finished</span> <span class="THEN">then</span> <a href="#local_success_87"><span class="LIDENT">success</span></a> <a href="#local_req_91"><span class="LIDENT">req</span></a><span class="EOL">
</span>    <span class="ELSE">else</span> <span class="LIDENT">consumer_resume_cell</span> <a href="#local_t_86"><span class="LIDENT">t</span></a> <span class="TILDE">~</span><a href="#local_success_87"><span class="LIDENT">success</span></a> <span class="TILDE">~</span><a href="#local_in_transition_88"><span class="LIDENT">in_transition</span></a> <a href="#local_cell_89"><span class="LIDENT">cell</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-take_suspend"><span class="LIDENT">take_suspend</span></span> <span id="local_t_92"><span class="LIDENT">t</span></span> <span id="local_loc_93"><span class="LIDENT">loc</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="UIDENT">Suspend</span><span class="DOT">.</span><span class="LIDENT">enter_unchecked</span> <span class="STRING">&quot;Sync.take&quot;</span> <span class="INFIXOP1">@@</span> <span class="FUN">fun</span> <span id="local_ctx_94"><span class="LIDENT">ctx</span></span> <span id="local_enqueue_95"><span class="LIDENT">enqueue</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="UIDENT">Short</span> <span id="local_cell_96"><span class="LIDENT">cell</span></span> <span class="BAR">|</span> <span class="UIDENT">Long</span> <span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span id="local_cell_97"><span class="LIDENT">cell</span></span><span class="RPAREN">)</span> <span class="EQUAL">=</span> <a href="#local_loc_93"><span class="LIDENT">loc</span></a> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_kc_98"><span class="LIDENT">kc</span></span> <span id="local_v_99"><span class="LIDENT">v</span></span> <span class="EQUAL">=</span> <a href="#local_enqueue_95"><span class="LIDENT">enqueue</span></a> <span class="LPAREN">(</span><span class="UIDENT">Ok</span> <a href="#local_v_99"><span class="LIDENT">v</span></a><span class="RPAREN">)</span><span class="SEMI">;</span> <span class="TRUE">true</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LIDENT">add_to_cell</span> <a href="#local_t_92"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">producers</span> <span class="LPAREN">(</span><span class="UIDENT">Slot</span> <a href="#local_kc_98"><span class="LIDENT">kc</span></a><span class="RPAREN">)</span> <a href="#local_cell_97"><span class="LIDENT">cell</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="MATCH">match</span> <a href="#local_loc_93"><span class="LIDENT">loc</span></a> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Short</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Long</span> <span id="local_loc_100"><span class="LIDENT">loc</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="MATCH">match</span> <span class="UIDENT">Fiber_context</span><span class="DOT">.</span><span class="LIDENT">get_error</span> <a href="#local_ctx_94"><span class="LIDENT">ctx</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_ex_101"><span class="LIDENT">ex</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="IF">if</span> <span class="LIDENT">cancel</span> <a href="#local_t_92"><span class="LIDENT">t</span></a> <a href="#local_loc_100"><span class="LIDENT">loc</span></a> <span class="THEN">then</span> <a href="#local_enqueue_95"><span class="LIDENT">enqueue</span></a> <span class="LPAREN">(</span><span class="UIDENT">Error</span> <a href="#local_ex_101"><span class="LIDENT">ex</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>      <span class="COMMENT">(* else being resumed *)</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="UIDENT">Fiber_context</span><span class="DOT">.</span><span class="LIDENT">set_cancel_fn</span> <a href="#local_ctx_94"><span class="LIDENT">ctx</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_ex_102"><span class="LIDENT">ex</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="IF">if</span> <span class="LIDENT">cancel</span> <a href="#local_t_92"><span class="LIDENT">t</span></a> <a href="#local_loc_100"><span class="LIDENT">loc</span></a> <span class="THEN">then</span> <a href="#local_enqueue_95"><span class="LIDENT">enqueue</span></a> <span class="LPAREN">(</span><span class="UIDENT">Error</span> <a href="#local_ex_102"><span class="LIDENT">ex</span></a><span class="RPAREN">)</span><span class="EOL">
</span>          <span class="COMMENT">(* else being resumed *)</span><span class="EOL">
</span>        <span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-{take}1/shadowed/(eio-src-eio-sync.ml)"><span class="LIDENT">take</span></span> <span class="LPAREN">(</span><span id="local_t_103"><span class="LIDENT">t</span></span> <span class="COLON">:</span> <span class="UNDERSCORE">_</span> <span class="LIDENT">t</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="MATCH">match</span> <span class="UIDENT">Balance</span><span class="DOT">.</span><span class="LIDENT">fetch_and_add</span> <a href="#local_t_103"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">balance</span> <span class="LPAREN">(</span><span class="MINUS">-</span><span class="INT">1</span><span class="RPAREN">)</span> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Error</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Closed</span> <span class="AS">as</span> <span id="local_e_104"><span class="LIDENT">e</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_e_104"><span class="LIDENT">e</span></a><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Ok</span> <span id="local_old_105"><span class="LIDENT">old</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_old_105"><span class="LIDENT">old</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <span class="INT">0</span> <span class="THEN">then</span> <span class="LPAREN">(</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_cell_106"><span class="LIDENT">cell</span></span> <span class="EQUAL">=</span> <span class="UIDENT">Q</span><span class="DOT">.</span><span class="LIDENT">next_resume</span> <a href="#local_t_103"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">producers</span> <span class="IN">in</span><span class="EOL">
</span>      <span class="LIDENT">consumer_resume_cell</span> <a href="#local_t_103"><span class="LIDENT">t</span></a> <a href="#local_cell_106"><span class="LIDENT">cell</span></a><span class="EOL">
</span>        <span class="LABEL">~success:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_item_107"><span class="LIDENT">item</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_item_107"><span class="LIDENT">item</span></a><span class="DOT">.</span><span class="LIDENT">kp</span> <span class="UIDENT">Sent</span><span class="SEMI">;</span> <a href="#local_item_107"><span class="LIDENT">item</span></a><span class="DOT">.</span><span class="LIDENT">v</span><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="LABEL">~in_transition:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_cell_108"><span class="LIDENT">cell</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">take_suspend</span> <a href="#local_t_103"><span class="LIDENT">t</span></a> <span class="LPAREN">(</span><span class="UIDENT">Short</span> <a href="#local_cell_108"><span class="LIDENT">cell</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="RPAREN">)</span> <span class="ELSE">else</span> <span class="LPAREN">(</span><span class="EOL">
</span>      <span class="LIDENT">take_suspend</span> <a href="#local_t_103"><span class="LIDENT">t</span></a> <span class="LPAREN">(</span><span class="UIDENT">Long</span> <span class="LPAREN">(</span><span class="UIDENT">Q</span><span class="DOT">.</span><span class="LIDENT">next_suspend</span> <a href="#local_t_103"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">consumers</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="RPAREN">)</span><span class="EOL">
</span>    <span class="EOL">
</span><span class="LET">let</span> <span id="val-take"><span class="LIDENT">take</span></span> <span id="local_t_109"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LPAREN">(</span><span class="LIDENT">take</span> <a href="#local_t_109"><span class="LIDENT">t</span></a><span class="EOL">
</span>   <span class="COLON">:</span>  <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#type-result"><span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="LBRACKET">[</span>  <span class="BACKQUOTE">`</span><span class="UIDENT">Closed</span> <span class="RBRACKET">]</span><span class="RPAREN">)</span> <span class="LIDENT">result</span></a> <span class="EOL">
</span>   <span class="COLONGREATER">:&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#type-result"><span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="LBRACKETGREATER">[&gt;</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Closed</span> <span class="RBRACKET">]</span><span class="RPAREN">)</span> <span class="LIDENT">result</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-reject"><span class="LIDENT">reject</span></span> <span class="EQUAL">=</span> <span class="UIDENT">Slot</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="FALSE">false</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-{take_nonblocking}2/shadowed/(eio-src-eio-sync.ml)"><span class="LIDENT">take_nonblocking</span></span> <span class="LPAREN">(</span><span id="local_t_110"><span class="LIDENT">t</span></span> <span class="COLON">:</span> <span class="UNDERSCORE">_</span> <span class="LIDENT">t</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="MATCH">match</span> <span class="UIDENT">Balance</span><span class="DOT">.</span><span class="LIDENT">decr_if_positive</span> <a href="#local_t_110"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">balance</span> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Balance_closed</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Error</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Closed</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Update_refused</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Error</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Would_block</span>   <span class="COMMENT">(* No waiting producers for us *)</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Updated</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="REC">rec</span> <span id="local_aux_111"><span class="LIDENT">aux</span></span> <span id="local_cell_112"><span class="LIDENT">cell</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LIDENT">consumer_resume_cell</span> <a href="#local_t_110"><span class="LIDENT">t</span></a> <a href="#local_cell_112"><span class="LIDENT">cell</span></a><span class="EOL">
</span>        <span class="LABEL">~success:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_item_113"><span class="LIDENT">item</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <a href="#local_item_113"><span class="LIDENT">item</span></a><span class="DOT">.</span><span class="LIDENT">kp</span> <span class="UIDENT">Sent</span><span class="SEMI">;</span>          <span class="COMMENT">(* Always accept the item *)</span><span class="EOL">
</span>            <span class="LPAREN">(</span><a href="#local_item_113"><span class="LIDENT">item</span></a><span class="DOT">.</span><span class="LIDENT">v</span> <span class="COLONGREATER">:&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#type-result"><span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="LBRACKET">[</span><span class="BACKQUOTE">`</span><span class="UIDENT">Closed</span> <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Would_block</span><span class="RBRACKET">]</span><span class="RPAREN">)</span> <span class="LIDENT">result</span></a><span class="RPAREN">)</span><span class="EOL">
</span>          <span class="RPAREN">)</span><span class="EOL">
</span>        <span class="LABEL">~in_transition:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_cell_114"><span class="LIDENT">cell</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <span class="COMMENT">(* Our producer is still in the process of writing its [Item], but
               we're non-blocking and can't wait. We're always acting as the
               resumer, so we can't cancel the cell. Instead, we provide a
               consumer callback that always rejects.
               todo: could spin for a bit here first - the Item will probably arrive soon,
               and that would avoid making the producer start again. *)</span><span class="EOL">
</span>            <a href="../../../ocaml-base-compiler/src/stdlib/domain.ml.html#val-cpu_relax"><span class="UIDENT">Domain</span><span class="DOT">.</span><span class="LIDENT">cpu_relax</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="SEMI">;</span>        <span class="COMMENT">(* Brief wait to encourage producer to finish *)</span><span class="EOL">
</span>            <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-compare_and_set"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">compare_and_set</span></a> <a href="#local_cell_114"><span class="LIDENT">cell</span></a> <span class="UIDENT">In_transition</span> <span class="LIDENT">reject</span> <span class="THEN">then</span> <span class="UIDENT">Error</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Would_block</span> <span class="EOL">
</span>            <span class="ELSE">else</span> <a href="#local_aux_111"><span class="LIDENT">aux</span></a> <a href="#local_cell_114"><span class="LIDENT">cell</span></a><span class="EOL">
</span>          <span class="RPAREN">)</span><span class="EOL">
</span>    <span class="IN">in</span> <a href="#local_aux_111"><span class="LIDENT">aux</span></a> <span class="LPAREN">(</span><span class="UIDENT">Q</span><span class="DOT">.</span><span class="LIDENT">next_resume</span> <a href="#local_t_110"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">producers</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-take_nonblocking"><span class="LIDENT">take_nonblocking</span></span> <span id="local_t_115"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LPAREN">(</span><span class="LIDENT">take_nonblocking</span> <a href="#local_t_115"><span class="LIDENT">t</span></a><span class="EOL">
</span>   <span class="COLON">:</span>  <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#type-result"><span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="LBRACKET">[</span>  <span class="BACKQUOTE">`</span><span class="UIDENT">Would_block</span> <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Closed</span> <span class="RBRACKET">]</span><span class="RPAREN">)</span> <span class="LIDENT">result</span></a><span class="EOL">
</span>   <span class="COLONGREATER">:&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#type-result"><span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="LBRACKETGREATER">[&gt;</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Would_block</span> <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Closed</span> <span class="RBRACKET">]</span><span class="RPAREN">)</span> <span class="LIDENT">result</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* Creation and status. *)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-create"><span class="LIDENT">create</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LBRACE">{</span><span class="EOL">
</span>    <span class="LIDENT">consumers</span> <span class="EQUAL">=</span> <span class="UIDENT">Q</span><span class="DOT">.</span><span class="LIDENT">make</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">producers</span> <span class="EQUAL">=</span> <span class="UIDENT">Q</span><span class="DOT">.</span><span class="LIDENT">make</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">balance</span> <span class="EQUAL">=</span> <span class="UIDENT">Balance</span><span class="DOT">.</span><span class="LIDENT">make</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>  <span class="RBRACE">}</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-close"><span class="LIDENT">close</span></span> <span id="local_t_116"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="MATCH">match</span> <span class="UIDENT">Balance</span><span class="DOT">.</span><span class="LIDENT">close</span> <a href="#local_t_116"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">balance</span> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Error</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Closed</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Ok</span> <span id="local_old_117"><span class="LIDENT">old</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_old_117"><span class="LIDENT">old</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <span class="INT">0</span> <span class="THEN">then</span> <span class="LPAREN">(</span><span class="EOL">
</span>      <span class="COMMENT">(* Reject each waiting producer. They will try to restart and then discover the stream is closed. *)</span><span class="EOL">
</span>      <span class="FOR">for</span> <span class="UNDERSCORE">_</span> <span class="EQUAL">=</span> <span class="INT">1</span> <span class="TO">to</span> <a href="#local_old_117"><span class="LIDENT">old</span></a> <span class="DO">do</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_cell_118"><span class="LIDENT">cell</span></span> <span class="EQUAL">=</span> <span class="UIDENT">Q</span><span class="DOT">.</span><span class="LIDENT">next_resume</span> <a href="#local_t_116"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">producers</span> <span class="IN">in</span><span class="EOL">
</span>        <span class="LIDENT">add_to_cell</span> <a href="#local_t_116"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">consumers</span> <span class="LIDENT">reject</span> <a href="#local_cell_118"><span class="LIDENT">cell</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <span class="DONE">done</span><span class="EOL">
</span>    <span class="RPAREN">)</span> <span class="ELSE">else</span> <span class="LPAREN">(</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_reject_consumer_119"><span class="LIDENT">reject_consumer</span></span> <span class="EQUAL">=</span> <span class="UIDENT">Item</span> <span class="LBRACE">{</span> <span class="LIDENT">v</span> <span class="EQUAL">=</span> <span class="UIDENT">Error</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Closed</span><span class="SEMI">;</span> <span class="LIDENT">kp</span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a><span class="SEMI">;</span> <span class="LIDENT">cancel</span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-make"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">make</span></a> <span class="BACKQUOTE">`</span><span class="UIDENT">Resuming</span> <span class="RBRACE">}</span> <span class="IN">in</span><span class="EOL">
</span>      <span class="COMMENT">(* Reject each waiting consumer. *)</span><span class="EOL">
</span>      <span class="FOR">for</span> <span class="UNDERSCORE">_</span> <span class="EQUAL">=</span> <span class="INT">1</span> <span class="TO">to</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(~-)"><span class="MINUS">-</span></a><a href="#local_old_117"><span class="LIDENT">old</span></a> <span class="DO">do</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_cell_120"><span class="LIDENT">cell</span></span> <span class="EQUAL">=</span> <span class="UIDENT">Q</span><span class="DOT">.</span><span class="LIDENT">next_resume</span> <a href="#local_t_116"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">consumers</span> <span class="IN">in</span><span class="EOL">
</span>        <span class="LIDENT">add_to_cell</span> <a href="#local_t_116"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">consumers</span> <a href="#local_reject_consumer_119"><span class="LIDENT">reject_consumer</span></a> <a href="#local_cell_120"><span class="LIDENT">cell</span></a><span class="EOL">
</span>      <span class="DONE">done</span><span class="EOL">
</span>    <span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-balance"><span class="LIDENT">balance</span></span> <span id="local_t_121"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="UIDENT">Balance</span><span class="DOT">.</span><span class="LIDENT">get</span> <a href="#local_t_121"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">balance</span><span class="EOL">
</span></span></code></pre></body></html>
