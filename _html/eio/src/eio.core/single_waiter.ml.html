<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Source: single_waiter.ml (eio.src.eio.core)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.css"/><meta name="generator" content="odoc %%VERSION%%"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/></head><body class="odoc-src"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">eio</a> &#x00BB; <a href="../index.html">Sources</a> &#x00BB; eio.core &#x00BB; single_waiter.ml</nav><header class="odoc-preamble"><h1>Source file <code><span>single_waiter.ml</span></code></h1></header><div class="odoc-tocs"><nav class="odoc-toc odoc-global-toc"><ul><li><a href="../../index.html">eio</a><ul><li>Library <code>eio</code><ul><li><a href="../../eio/Eio/index.html">Eio</a></li></ul></li><li>Library <code>eio.core</code></li><li>Library <code>eio.mock</code><ul><li><a href="../../eio.mock/Eio_mock/index.html">Eio_mock</a></li></ul></li><li>Library <code>eio.runtime_events</code><ul><li><a href="../../eio.runtime_events/Eio_runtime_events/index.html">Eio_runtime_events</a></li></ul></li><li>Library <code>eio.unix</code><ul><li><a href="../../eio.unix/Eio_unix/index.html">Eio_unix</a></li></ul></li><li>Library <code>eio.utils</code><ul><li><a href="../../eio.utils/Eio_utils/index.html">Eio_utils</a></li></ul></li><li><a href="../index.html">Sources</a><ul><li>eio<ul><li><a href="../eio/buf_read.ml.html">buf_read.ml</a></li><li><a href="../eio/buf_write.ml.html">buf_write.ml</a></li><li><a href="../eio/condition.ml.html">condition.ml</a></li><li><a href="../eio/domain_manager.ml.html">domain_manager.ml</a></li><li><a href="../eio/eio.ml.html">eio.ml</a></li><li><a href="../eio/eio__.ml.html">eio__.ml</a></li><li><a href="../eio/eio_mutex.ml.html">eio_mutex.ml</a></li><li><a href="../eio/executor_pool.ml.html">executor_pool.ml</a></li><li><a href="../eio/file.ml.html">file.ml</a></li><li><a href="../eio/flow.ml.html">flow.ml</a></li><li><a href="../eio/fs.ml.html">fs.ml</a></li><li><a href="../eio/hook.ml.html">hook.ml</a></li><li><a href="../eio/lazy.ml.html">lazy.ml</a></li><li><a href="../eio/net.ml.html">net.ml</a></li><li><a href="../eio/path.ml.html">path.ml</a></li><li><a href="../eio/pool.ml.html">pool.ml</a></li><li><a href="../eio/process.ml.html">process.ml</a></li><li><a href="../eio/resource.ml.html">resource.ml</a></li><li><a href="../eio/sem_state.ml.html">sem_state.ml</a></li><li><a href="../eio/semaphore.ml.html">semaphore.ml</a></li><li><a href="../eio/std.ml.html">std.ml</a></li><li><a href="../eio/stream.ml.html">stream.ml</a></li><li><a href="../eio/sync.ml.html">sync.ml</a></li><li><a href="../eio/time.ml.html">time.ml</a></li><li><a href="../eio/waiters.ml.html">waiters.ml</a></li></ul></li><li>eio.core<ul><li><a href="broadcast.ml.html">broadcast.ml</a></li><li><a href="cancel.ml.html">cancel.ml</a></li><li><a href="cells.ml.html">cells.ml</a></li><li><a href="debug.ml.html">debug.ml</a></li><li><a href="dla.ml.html">dla.ml</a></li><li><a href="eio__core.ml.html">eio__core.ml</a></li><li><a href="eio__core__.ml.html">eio__core__.ml</a></li><li><a href="exn.ml.html">exn.ml</a></li><li><a href="fiber.ml.html">fiber.ml</a></li><li><a href="promise.ml.html">promise.ml</a></li><li><a href="#" class="current_unit">single_waiter.ml</a></li><li><a href="suspend.ml.html">suspend.ml</a></li><li><a href="switch.ml.html">switch.ml</a></li><li><a href="trace.ml.html">trace.ml</a></li></ul></li><li>eio.mock<ul><li><a href="../eio.mock/action.ml.html">action.ml</a></li><li><a href="../eio.mock/backend.ml.html">backend.ml</a></li><li><a href="../eio.mock/clock.ml.html">clock.ml</a></li><li><a href="../eio.mock/domain_manager.ml.html">domain_manager.ml</a></li><li><a href="../eio.mock/eio_mock.ml.html">eio_mock.ml</a></li><li><a href="../eio.mock/eio_mock__.ml.html">eio_mock__.ml</a></li><li><a href="../eio.mock/flow.ml.html">flow.ml</a></li><li><a href="../eio.mock/handler.ml.html">handler.ml</a></li><li><a href="../eio.mock/net.ml.html">net.ml</a></li></ul></li><li>eio.runtime_events<ul><li><a href="../eio.runtime_events/eio_runtime_events.ml.html">eio_runtime_events.ml</a></li></ul></li><li>eio.unix<ul><li><a href="../eio.unix/cap.ml.html">cap.ml</a></li><li><a href="../eio.unix/eio_unix.ml.html">eio_unix.ml</a></li><li><a href="../eio.unix/eio_unix__.ml.html">eio_unix__.ml</a></li><li><a href="../eio.unix/fd.ml.html">fd.ml</a></li><li><a href="../eio.unix/fork_action.ml.html">fork_action.ml</a></li><li><a href="../eio.unix/inherit_fds.ml.html">inherit_fds.ml</a></li><li><a href="../eio.unix/net.ml.html">net.ml</a></li><li><a href="../eio.unix/pi.ml.html">pi.ml</a></li><li><a href="../eio.unix/private.ml.html">private.ml</a></li><li><a href="../eio.unix/process.ml.html">process.ml</a></li><li><a href="../eio.unix/rcfd.ml.html">rcfd.ml</a></li><li><a href="../eio.unix/resource.ml.html">resource.ml</a></li><li><a href="../eio.unix/thread_pool.ml.html">thread_pool.ml</a></li><li><a href="../eio.unix/types.ml.html">types.ml</a></li></ul></li><li>eio.utils<ul><li><a href="../eio.utils/eio_utils.ml.html">eio_utils.ml</a></li><li><a href="../eio.utils/eio_utils__.ml.html">eio_utils__.ml</a></li><li><a href="../eio.utils/lf_queue.ml.html">lf_queue.ml</a></li><li><a href="../eio.utils/suspended.ml.html">suspended.ml</a></li><li><a href="../eio.utils/zzz.ml.html">zzz.ml</a></li></ul></li></ul></li></ul></li></ul></nav></div><pre class="source_container"><code class="source_line_column"><a id="L1" class="source_line" href="#L1">1</a>
<a id="L2" class="source_line" href="#L2">2</a>
<a id="L3" class="source_line" href="#L3">3</a>
<a id="L4" class="source_line" href="#L4">4</a>
<a id="L5" class="source_line" href="#L5">5</a>
<a id="L6" class="source_line" href="#L6">6</a>
<a id="L7" class="source_line" href="#L7">7</a>
<a id="L8" class="source_line" href="#L8">8</a>
<a id="L9" class="source_line" href="#L9">9</a>
<a id="L10" class="source_line" href="#L10">10</a>
<a id="L11" class="source_line" href="#L11">11</a>
<a id="L12" class="source_line" href="#L12">12</a>
<a id="L13" class="source_line" href="#L13">13</a>
<a id="L14" class="source_line" href="#L14">14</a>
<a id="L15" class="source_line" href="#L15">15</a>
<a id="L16" class="source_line" href="#L16">16</a>
<a id="L17" class="source_line" href="#L17">17</a>
<a id="L18" class="source_line" href="#L18">18</a>
<a id="L19" class="source_line" href="#L19">19</a>
<a id="L20" class="source_line" href="#L20">20</a>
<a id="L21" class="source_line" href="#L21">21</a>
<a id="L22" class="source_line" href="#L22">22</a>
<a id="L23" class="source_line" href="#L23">23</a>
<a id="L24" class="source_line" href="#L24">24</a>
<a id="L25" class="source_line" href="#L25">25</a>
<a id="L26" class="source_line" href="#L26">26</a>
<a id="L27" class="source_line" href="#L27">27</a>
<a id="L28" class="source_line" href="#L28">28</a>
<a id="L29" class="source_line" href="#L29">29</a>
<a id="L30" class="source_line" href="#L30">30</a>
<a id="L31" class="source_line" href="#L31">31</a>
<a id="L32" class="source_line" href="#L32">32</a>
<a id="L33" class="source_line" href="#L33">33</a>
<a id="L34" class="source_line" href="#L34">34</a>
<a id="L35" class="source_line" href="#L35">35</a>
</code><code class="source_code"><span><span class="COMMENT">(* Allows a single fiber to wait to be notified by another fiber in the same domain.
   If multiple fibers need to wait at once, or the notification comes from another domain,
   this can't be used. *)</span><span class="EOL">
</span><span class="EOL">
</span><span id="type-t"><span class="TYPE">type</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">t</span> <span class="EQUAL">=</span> <span class="LBRACE">{</span><span class="EOL">
</span>  <span id="def_18"><span class="MUTABLE">mutable</span> <span class="LIDENT">wake</span> <span class="COLON">:</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#type-result"><span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="LIDENT">exn</span><span class="RPAREN">)</span> <span class="LIDENT">result</span></a> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span><span class="SEMI">;</span></span><span class="EOL">
</span><span class="RBRACE">}</span></span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-create"><span class="LIDENT">create</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span> <span class="LBRACE">{</span> <span class="LIDENT">wake</span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a> <span class="RBRACE">}</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-wake"><span class="LIDENT">wake</span></span> <span id="local_t_1"><span class="LIDENT">t</span></span> <span id="local_v_2"><span class="LIDENT">v</span></span> <span class="EQUAL">=</span> <a href="#local_t_1"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">wake</span> <a href="#local_v_2"><span class="LIDENT">v</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-await"><span class="LIDENT">await</span></span> <span id="local_t_3"><span class="LIDENT">t</span></span> <span id="local_op_4"><span class="LIDENT">op</span></span> <span id="local_id_5"><span class="LIDENT">id</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_x_6"><span class="LIDENT">x</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <a href="suspend.ml.html#val-enter"><span class="UIDENT">Suspend</span><span class="DOT">.</span><span class="LIDENT">enter</span></a> <a href="#local_op_4"><span class="LIDENT">op</span></a> <span class="INFIXOP1">@@</span> <span class="FUN">fun</span> <span id="local_ctx_7"><span class="LIDENT">ctx</span></span> <span id="local_enqueue_8"><span class="LIDENT">enqueue</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="cancel.ml.html#module-Fiber_context.val-set_cancel_fn"><span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="UIDENT">Fiber_context</span><span class="DOT">.</span><span class="LIDENT">set_cancel_fn</span></a> <a href="#local_ctx_7"><span class="LIDENT">ctx</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_ex_9"><span class="LIDENT">ex</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <a href="#local_t_3"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">wake</span> <span class="LESSMINUS">&lt;-</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a><span class="SEMI">;</span><span class="EOL">
</span>        <a href="#local_enqueue_8"><span class="LIDENT">enqueue</span></a> <span class="LPAREN">(</span><span class="UIDENT">Error</span> <a href="#local_ex_9"><span class="LIDENT">ex</span></a><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="#local_t_3"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">wake</span> <span class="LESSMINUS">&lt;-</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_x_10"><span class="LIDENT">x</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <a href="cancel.ml.html#module-Fiber_context.val-clear_cancel_fn"><span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="UIDENT">Fiber_context</span><span class="DOT">.</span><span class="LIDENT">clear_cancel_fn</span></a> <a href="#local_ctx_7"><span class="LIDENT">ctx</span></a><span class="SEMI">;</span><span class="EOL">
</span>        <a href="#local_t_3"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">wake</span> <span class="LESSMINUS">&lt;-</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a><span class="SEMI">;</span><span class="EOL">
</span>        <a href="#local_enqueue_8"><span class="LIDENT">enqueue</span></a> <a href="#local_x_10"><span class="LIDENT">x</span></a><span class="EOL">
</span>      <span class="RPAREN">)</span><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <a href="trace.ml.html#val-get"><span class="UIDENT">Trace</span><span class="DOT">.</span><span class="LIDENT">get</span></a> <a href="#local_id_5"><span class="LIDENT">id</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <a href="#local_x_6"><span class="LIDENT">x</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-await_protect"><span class="LIDENT">await_protect</span></span> <span id="local_t_11"><span class="LIDENT">t</span></span> <span id="local_op_12"><span class="LIDENT">op</span></span> <span id="local_id_13"><span class="LIDENT">id</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_x_14"><span class="LIDENT">x</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <a href="suspend.ml.html#val-enter_unchecked"><span class="UIDENT">Suspend</span><span class="DOT">.</span><span class="LIDENT">enter_unchecked</span></a> <a href="#local_op_12"><span class="LIDENT">op</span></a> <span class="INFIXOP1">@@</span> <span class="FUN">fun</span> <span id="local__ctx_15"><span class="LIDENT">_ctx</span></span> <span id="local_enqueue_16"><span class="LIDENT">enqueue</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="#local_t_11"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">wake</span> <span class="LESSMINUS">&lt;-</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_x_17"><span class="LIDENT">x</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_t_11"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">wake</span> <span class="LESSMINUS">&lt;-</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a><span class="SEMI">;</span> <a href="#local_enqueue_16"><span class="LIDENT">enqueue</span></a> <a href="#local_x_17"><span class="LIDENT">x</span></a><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <a href="trace.ml.html#val-get"><span class="UIDENT">Trace</span><span class="DOT">.</span><span class="LIDENT">get</span></a> <a href="#local_id_13"><span class="LIDENT">id</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <a href="#local_x_14"><span class="LIDENT">x</span></a><span class="EOL">
</span></span></code></pre></body></html>
