<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Source: lambda_lifting.ml (js_of_ocaml-compiler.src.js_of_ocaml-compiler)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.css"/><meta name="generator" content="odoc %%VERSION%%"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/></head><body class="odoc-src"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">js_of_ocaml-compiler</a> &#x00BB; <a href="../index.html">Sources</a> &#x00BB; js_of_ocaml-compiler &#x00BB; lambda_lifting.ml</nav><header class="odoc-preamble"><h1>Source file <code><span>lambda_lifting.ml</span></code></h1></header><div class="odoc-tocs"><nav class="odoc-toc odoc-global-toc"><ul><li><a href="../../index.html">js_of_ocaml-compiler</a><ul><li>Library <code>js_of_ocaml-compiler</code><ul><li><a href="../../js_of_ocaml-compiler/Js_of_ocaml_compiler/index.html">Js_of_ocaml_compiler</a></li></ul></li><li>Library <code>js_of_ocaml-compiler.dynlink</code><ul><li><a href="../../js_of_ocaml-compiler.dynlink/Js_of_ocaml_compiler_dynlink/index.html">Js_of_ocaml_compiler_dynlink</a></li></ul></li><li>Library <code>js_of_ocaml-compiler.findlib-support</code><ul><li><a href="../../js_of_ocaml-compiler.findlib-support/Jsoo_findlib_support/index.html">Jsoo_findlib_support</a></li></ul></li><li>Library <code>js_of_ocaml-compiler.runtime</code><ul><li><a href="../../js_of_ocaml-compiler.runtime/Jsoo_runtime/index.html">Jsoo_runtime</a></li></ul></li><li>Library <code>js_of_ocaml-compiler.runtime-files</code><ul><li><a href="../../js_of_ocaml-compiler.runtime-files/Js_of_ocaml_compiler_runtime_files/index.html">Js_of_ocaml_compiler_runtime_files</a></li></ul></li><li><a href="../index.html">Sources</a><ul><li>js_of_ocaml-compiler<ul><li><a href="annot_lexer.ml.html">annot_lexer.ml</a></li><li><a href="annot_parser.ml.html">annot_parser.ml</a></li><li><a href="base64.ml.html">base64.ml</a></li><li><a href="build_info.ml.html">build_info.ml</a></li><li><a href="build_path_prefix_map.ml.html">build_path_prefix_map.ml</a></li><li><a href="builtins.ml.html">builtins.ml</a></li><li><a href="code.ml.html">code.ml</a></li><li><a href="compiler_version.ml.html">compiler_version.ml</a></li><li><a href="config.ml.html">config.ml</a></li><li><a href="constant.ml.html">constant.ml</a></li><li><a href="deadcode.ml.html">deadcode.ml</a></li><li><a href="debug.ml.html">debug.ml</a></li><li><a href="dgraph.ml.html">dgraph.ml</a></li><li><a href="driver.ml.html">driver.ml</a></li><li><a href="duplicate.ml.html">duplicate.ml</a></li><li><a href="effects.ml.html">effects.ml</a></li><li><a href="eval.ml.html">eval.ml</a></li><li><a href="findlib.ml.html">findlib.ml</a></li><li><a href="flow.ml.html">flow.ml</a></li><li><a href="flow_lexer.ml.html">flow_lexer.ml</a></li><li><a href="freevars.ml.html">freevars.ml</a></li><li><a href="fs.ml.html">fs.ml</a></li><li><a href="generate.ml.html">generate.ml</a></li><li><a href="generate_closure.ml.html">generate_closure.ml</a></li><li><a href="global_deadcode.ml.html">global_deadcode.ml</a></li><li><a href="global_flow.ml.html">global_flow.ml</a></li><li><a href="inline.ml.html">inline.ml</a></li><li><a href="instr.ml.html">instr.ml</a></li><li><a href="javascript.ml.html">javascript.ml</a></li><li><a href="js_assign.ml.html">js_assign.ml</a></li><li><a href="js_of_ocaml_compiler.ml.html">js_of_ocaml_compiler.ml</a></li><li><a href="js_output.ml.html">js_output.ml</a></li><li><a href="js_parser.ml.html">js_parser.ml</a></li><li><a href="js_simpl.ml.html">js_simpl.ml</a></li><li><a href="js_token.ml.html">js_token.ml</a></li><li><a href="js_traverse.ml.html">js_traverse.ml</a></li><li><a href="#" class="current_unit">lambda_lifting.ml</a></li><li><a href="link_js.ml.html">link_js.ml</a></li><li><a href="linker.ml.html">linker.ml</a></li><li><a href="loc.ml.html">loc.ml</a></li><li><a href="macro.ml.html">macro.ml</a></li><li><a href="magic_number.ml.html">magic_number.ml</a></li><li><a href="mlvalue.ml.html">mlvalue.ml</a></li><li><a href="ocaml_compiler.ml.html">ocaml_compiler.ml</a></li><li><a href="ocaml_version.ml.html">ocaml_version.ml</a></li><li><a href="parse_bytecode.ml.html">parse_bytecode.ml</a></li><li><a href="parse_info.ml.html">parse_info.ml</a></li><li><a href="parse_js.ml.html">parse_js.ml</a></li><li><a href="partial_cps_analysis.ml.html">partial_cps_analysis.ml</a></li><li><a href="phisimpl.ml.html">phisimpl.ml</a></li><li><a href="pretty_print.ml.html">pretty_print.ml</a></li><li><a href="primitive.ml.html">primitive.ml</a></li><li><a href="pseudo_fs.ml.html">pseudo_fs.ml</a></li><li><a href="pure_fun.ml.html">pure_fun.ml</a></li><li><a href="reserved.ml.html">reserved.ml</a></li><li><a href="source_map.ml.html">source_map.ml</a></li><li><a href="source_map_io.ml.html">source_map_io.ml</a></li><li><a href="specialize.ml.html">specialize.ml</a></li><li><a href="specialize_js.ml.html">specialize_js.ml</a></li><li><a href="stdlib.ml.html">stdlib.ml</a></li><li><a href="strongly_connected_components.ml.html">strongly_connected_components.ml</a></li><li><a href="structure.ml.html">structure.ml</a></li><li><a href="subst.ml.html">subst.ml</a></li><li><a href="tailcall.ml.html">tailcall.ml</a></li><li><a href="target_env.ml.html">target_env.ml</a></li><li><a href="timer.ml.html">timer.ml</a></li><li><a href="unit_info.ml.html">unit_info.ml</a></li><li><a href="var_printer.ml.html">var_printer.ml</a></li><li><a href="vlq64.ml.html">vlq64.ml</a></li></ul></li><li>js_of_ocaml-compiler.dynlink<ul><li><a href="../js_of_ocaml-compiler.dynlink/js_of_ocaml_compiler_dynlink.ml.html">js_of_ocaml_compiler_dynlink.ml</a></li></ul></li><li>js_of_ocaml-compiler.findlib-support<ul><li><a href="../js_of_ocaml-compiler.findlib-support/jsoo_findlib_support.ml.html">jsoo_findlib_support.ml</a></li></ul></li><li>js_of_ocaml-compiler.runtime<ul><li><a href="../js_of_ocaml-compiler.runtime/jsoo_runtime.ml.html">jsoo_runtime.ml</a></li><li><a href="../js_of_ocaml-compiler.runtime/jsoo_runtime__.ml.html">jsoo_runtime__.ml</a></li><li><a href="../js_of_ocaml-compiler.runtime/runtime_version.ml.html">runtime_version.ml</a></li></ul></li><li>js_of_ocaml-compiler.runtime-files<ul><li><a href="../js_of_ocaml-compiler.runtime-files/files.ml.html">files.ml</a></li><li><a href="../js_of_ocaml-compiler.runtime-files/js_of_ocaml_compiler_runtime_files.ml.html">js_of_ocaml_compiler_runtime_files.ml</a></li><li><a href="../js_of_ocaml-compiler.runtime-files/js_of_ocaml_compiler_runtime_files__.ml.html">js_of_ocaml_compiler_runtime_files__.ml</a></li></ul></li></ul></li></ul></li></ul></nav></div><pre class="source_container"><code class="source_line_column"><a id="L1" class="source_line" href="#L1">1</a>
<a id="L2" class="source_line" href="#L2">2</a>
<a id="L3" class="source_line" href="#L3">3</a>
<a id="L4" class="source_line" href="#L4">4</a>
<a id="L5" class="source_line" href="#L5">5</a>
<a id="L6" class="source_line" href="#L6">6</a>
<a id="L7" class="source_line" href="#L7">7</a>
<a id="L8" class="source_line" href="#L8">8</a>
<a id="L9" class="source_line" href="#L9">9</a>
<a id="L10" class="source_line" href="#L10">10</a>
<a id="L11" class="source_line" href="#L11">11</a>
<a id="L12" class="source_line" href="#L12">12</a>
<a id="L13" class="source_line" href="#L13">13</a>
<a id="L14" class="source_line" href="#L14">14</a>
<a id="L15" class="source_line" href="#L15">15</a>
<a id="L16" class="source_line" href="#L16">16</a>
<a id="L17" class="source_line" href="#L17">17</a>
<a id="L18" class="source_line" href="#L18">18</a>
<a id="L19" class="source_line" href="#L19">19</a>
<a id="L20" class="source_line" href="#L20">20</a>
<a id="L21" class="source_line" href="#L21">21</a>
<a id="L22" class="source_line" href="#L22">22</a>
<a id="L23" class="source_line" href="#L23">23</a>
<a id="L24" class="source_line" href="#L24">24</a>
<a id="L25" class="source_line" href="#L25">25</a>
<a id="L26" class="source_line" href="#L26">26</a>
<a id="L27" class="source_line" href="#L27">27</a>
<a id="L28" class="source_line" href="#L28">28</a>
<a id="L29" class="source_line" href="#L29">29</a>
<a id="L30" class="source_line" href="#L30">30</a>
<a id="L31" class="source_line" href="#L31">31</a>
<a id="L32" class="source_line" href="#L32">32</a>
<a id="L33" class="source_line" href="#L33">33</a>
<a id="L34" class="source_line" href="#L34">34</a>
<a id="L35" class="source_line" href="#L35">35</a>
<a id="L36" class="source_line" href="#L36">36</a>
<a id="L37" class="source_line" href="#L37">37</a>
<a id="L38" class="source_line" href="#L38">38</a>
<a id="L39" class="source_line" href="#L39">39</a>
<a id="L40" class="source_line" href="#L40">40</a>
<a id="L41" class="source_line" href="#L41">41</a>
<a id="L42" class="source_line" href="#L42">42</a>
<a id="L43" class="source_line" href="#L43">43</a>
<a id="L44" class="source_line" href="#L44">44</a>
<a id="L45" class="source_line" href="#L45">45</a>
<a id="L46" class="source_line" href="#L46">46</a>
<a id="L47" class="source_line" href="#L47">47</a>
<a id="L48" class="source_line" href="#L48">48</a>
<a id="L49" class="source_line" href="#L49">49</a>
<a id="L50" class="source_line" href="#L50">50</a>
<a id="L51" class="source_line" href="#L51">51</a>
<a id="L52" class="source_line" href="#L52">52</a>
<a id="L53" class="source_line" href="#L53">53</a>
<a id="L54" class="source_line" href="#L54">54</a>
<a id="L55" class="source_line" href="#L55">55</a>
<a id="L56" class="source_line" href="#L56">56</a>
<a id="L57" class="source_line" href="#L57">57</a>
<a id="L58" class="source_line" href="#L58">58</a>
<a id="L59" class="source_line" href="#L59">59</a>
<a id="L60" class="source_line" href="#L60">60</a>
<a id="L61" class="source_line" href="#L61">61</a>
<a id="L62" class="source_line" href="#L62">62</a>
<a id="L63" class="source_line" href="#L63">63</a>
<a id="L64" class="source_line" href="#L64">64</a>
<a id="L65" class="source_line" href="#L65">65</a>
<a id="L66" class="source_line" href="#L66">66</a>
<a id="L67" class="source_line" href="#L67">67</a>
<a id="L68" class="source_line" href="#L68">68</a>
<a id="L69" class="source_line" href="#L69">69</a>
<a id="L70" class="source_line" href="#L70">70</a>
<a id="L71" class="source_line" href="#L71">71</a>
<a id="L72" class="source_line" href="#L72">72</a>
<a id="L73" class="source_line" href="#L73">73</a>
<a id="L74" class="source_line" href="#L74">74</a>
<a id="L75" class="source_line" href="#L75">75</a>
<a id="L76" class="source_line" href="#L76">76</a>
<a id="L77" class="source_line" href="#L77">77</a>
<a id="L78" class="source_line" href="#L78">78</a>
<a id="L79" class="source_line" href="#L79">79</a>
<a id="L80" class="source_line" href="#L80">80</a>
<a id="L81" class="source_line" href="#L81">81</a>
<a id="L82" class="source_line" href="#L82">82</a>
<a id="L83" class="source_line" href="#L83">83</a>
<a id="L84" class="source_line" href="#L84">84</a>
<a id="L85" class="source_line" href="#L85">85</a>
<a id="L86" class="source_line" href="#L86">86</a>
<a id="L87" class="source_line" href="#L87">87</a>
<a id="L88" class="source_line" href="#L88">88</a>
<a id="L89" class="source_line" href="#L89">89</a>
<a id="L90" class="source_line" href="#L90">90</a>
<a id="L91" class="source_line" href="#L91">91</a>
<a id="L92" class="source_line" href="#L92">92</a>
<a id="L93" class="source_line" href="#L93">93</a>
<a id="L94" class="source_line" href="#L94">94</a>
<a id="L95" class="source_line" href="#L95">95</a>
<a id="L96" class="source_line" href="#L96">96</a>
<a id="L97" class="source_line" href="#L97">97</a>
<a id="L98" class="source_line" href="#L98">98</a>
<a id="L99" class="source_line" href="#L99">99</a>
<a id="L100" class="source_line" href="#L100">100</a>
<a id="L101" class="source_line" href="#L101">101</a>
<a id="L102" class="source_line" href="#L102">102</a>
<a id="L103" class="source_line" href="#L103">103</a>
<a id="L104" class="source_line" href="#L104">104</a>
<a id="L105" class="source_line" href="#L105">105</a>
<a id="L106" class="source_line" href="#L106">106</a>
<a id="L107" class="source_line" href="#L107">107</a>
<a id="L108" class="source_line" href="#L108">108</a>
<a id="L109" class="source_line" href="#L109">109</a>
<a id="L110" class="source_line" href="#L110">110</a>
<a id="L111" class="source_line" href="#L111">111</a>
<a id="L112" class="source_line" href="#L112">112</a>
<a id="L113" class="source_line" href="#L113">113</a>
<a id="L114" class="source_line" href="#L114">114</a>
<a id="L115" class="source_line" href="#L115">115</a>
<a id="L116" class="source_line" href="#L116">116</a>
<a id="L117" class="source_line" href="#L117">117</a>
<a id="L118" class="source_line" href="#L118">118</a>
<a id="L119" class="source_line" href="#L119">119</a>
<a id="L120" class="source_line" href="#L120">120</a>
<a id="L121" class="source_line" href="#L121">121</a>
<a id="L122" class="source_line" href="#L122">122</a>
<a id="L123" class="source_line" href="#L123">123</a>
<a id="L124" class="source_line" href="#L124">124</a>
<a id="L125" class="source_line" href="#L125">125</a>
<a id="L126" class="source_line" href="#L126">126</a>
<a id="L127" class="source_line" href="#L127">127</a>
<a id="L128" class="source_line" href="#L128">128</a>
<a id="L129" class="source_line" href="#L129">129</a>
<a id="L130" class="source_line" href="#L130">130</a>
<a id="L131" class="source_line" href="#L131">131</a>
<a id="L132" class="source_line" href="#L132">132</a>
<a id="L133" class="source_line" href="#L133">133</a>
<a id="L134" class="source_line" href="#L134">134</a>
<a id="L135" class="source_line" href="#L135">135</a>
<a id="L136" class="source_line" href="#L136">136</a>
<a id="L137" class="source_line" href="#L137">137</a>
<a id="L138" class="source_line" href="#L138">138</a>
<a id="L139" class="source_line" href="#L139">139</a>
<a id="L140" class="source_line" href="#L140">140</a>
<a id="L141" class="source_line" href="#L141">141</a>
<a id="L142" class="source_line" href="#L142">142</a>
<a id="L143" class="source_line" href="#L143">143</a>
<a id="L144" class="source_line" href="#L144">144</a>
<a id="L145" class="source_line" href="#L145">145</a>
<a id="L146" class="source_line" href="#L146">146</a>
<a id="L147" class="source_line" href="#L147">147</a>
<a id="L148" class="source_line" href="#L148">148</a>
<a id="L149" class="source_line" href="#L149">149</a>
<a id="L150" class="source_line" href="#L150">150</a>
<a id="L151" class="source_line" href="#L151">151</a>
<a id="L152" class="source_line" href="#L152">152</a>
<a id="L153" class="source_line" href="#L153">153</a>
<a id="L154" class="source_line" href="#L154">154</a>
<a id="L155" class="source_line" href="#L155">155</a>
<a id="L156" class="source_line" href="#L156">156</a>
<a id="L157" class="source_line" href="#L157">157</a>
<a id="L158" class="source_line" href="#L158">158</a>
<a id="L159" class="source_line" href="#L159">159</a>
<a id="L160" class="source_line" href="#L160">160</a>
<a id="L161" class="source_line" href="#L161">161</a>
<a id="L162" class="source_line" href="#L162">162</a>
<a id="L163" class="source_line" href="#L163">163</a>
<a id="L164" class="source_line" href="#L164">164</a>
<a id="L165" class="source_line" href="#L165">165</a>
<a id="L166" class="source_line" href="#L166">166</a>
<a id="L167" class="source_line" href="#L167">167</a>
<a id="L168" class="source_line" href="#L168">168</a>
<a id="L169" class="source_line" href="#L169">169</a>
<a id="L170" class="source_line" href="#L170">170</a>
<a id="L171" class="source_line" href="#L171">171</a>
<a id="L172" class="source_line" href="#L172">172</a>
<a id="L173" class="source_line" href="#L173">173</a>
<a id="L174" class="source_line" href="#L174">174</a>
<a id="L175" class="source_line" href="#L175">175</a>
<a id="L176" class="source_line" href="#L176">176</a>
<a id="L177" class="source_line" href="#L177">177</a>
<a id="L178" class="source_line" href="#L178">178</a>
<a id="L179" class="source_line" href="#L179">179</a>
<a id="L180" class="source_line" href="#L180">180</a>
<a id="L181" class="source_line" href="#L181">181</a>
<a id="L182" class="source_line" href="#L182">182</a>
<a id="L183" class="source_line" href="#L183">183</a>
<a id="L184" class="source_line" href="#L184">184</a>
<a id="L185" class="source_line" href="#L185">185</a>
<a id="L186" class="source_line" href="#L186">186</a>
<a id="L187" class="source_line" href="#L187">187</a>
<a id="L188" class="source_line" href="#L188">188</a>
<a id="L189" class="source_line" href="#L189">189</a>
<a id="L190" class="source_line" href="#L190">190</a>
<a id="L191" class="source_line" href="#L191">191</a>
<a id="L192" class="source_line" href="#L192">192</a>
<a id="L193" class="source_line" href="#L193">193</a>
<a id="L194" class="source_line" href="#L194">194</a>
<a id="L195" class="source_line" href="#L195">195</a>
<a id="L196" class="source_line" href="#L196">196</a>
<a id="L197" class="source_line" href="#L197">197</a>
<a id="L198" class="source_line" href="#L198">198</a>
<a id="L199" class="source_line" href="#L199">199</a>
<a id="L200" class="source_line" href="#L200">200</a>
<a id="L201" class="source_line" href="#L201">201</a>
<a id="L202" class="source_line" href="#L202">202</a>
<a id="L203" class="source_line" href="#L203">203</a>
<a id="L204" class="source_line" href="#L204">204</a>
<a id="L205" class="source_line" href="#L205">205</a>
<a id="L206" class="source_line" href="#L206">206</a>
<a id="L207" class="source_line" href="#L207">207</a>
<a id="L208" class="source_line" href="#L208">208</a>
<a id="L209" class="source_line" href="#L209">209</a>
<a id="L210" class="source_line" href="#L210">210</a>
<a id="L211" class="source_line" href="#L211">211</a>
<a id="L212" class="source_line" href="#L212">212</a>
<a id="L213" class="source_line" href="#L213">213</a>
<a id="L214" class="source_line" href="#L214">214</a>
<a id="L215" class="source_line" href="#L215">215</a>
<a id="L216" class="source_line" href="#L216">216</a>
<a id="L217" class="source_line" href="#L217">217</a>
<a id="L218" class="source_line" href="#L218">218</a>
<a id="L219" class="source_line" href="#L219">219</a>
<a id="L220" class="source_line" href="#L220">220</a>
<a id="L221" class="source_line" href="#L221">221</a>
<a id="L222" class="source_line" href="#L222">222</a>
<a id="L223" class="source_line" href="#L223">223</a>
<a id="L224" class="source_line" href="#L224">224</a>
<a id="L225" class="source_line" href="#L225">225</a>
<a id="L226" class="source_line" href="#L226">226</a>
<a id="L227" class="source_line" href="#L227">227</a>
<a id="L228" class="source_line" href="#L228">228</a>
<a id="L229" class="source_line" href="#L229">229</a>
<a id="L230" class="source_line" href="#L230">230</a>
<a id="L231" class="source_line" href="#L231">231</a>
<a id="L232" class="source_line" href="#L232">232</a>
<a id="L233" class="source_line" href="#L233">233</a>
<a id="L234" class="source_line" href="#L234">234</a>
<a id="L235" class="source_line" href="#L235">235</a>
<a id="L236" class="source_line" href="#L236">236</a>
<a id="L237" class="source_line" href="#L237">237</a>
<a id="L238" class="source_line" href="#L238">238</a>
<a id="L239" class="source_line" href="#L239">239</a>
<a id="L240" class="source_line" href="#L240">240</a>
<a id="L241" class="source_line" href="#L241">241</a>
</code><code class="source_code"><span><span class="COMMENT">(* Js_of_ocaml compiler
 * http://www.ocsigen.org/js_of_ocaml/
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation, with linking exception;
 * either version 2.1 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
 *)</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(*
The code transformation performed to deal with effect handlers produce
deeply nested functions, which is not supported by JavaScript engines.
So, we lift some functions to a lower level to limit the nesting
depth. To lift a function f, we basically wrapped it in a function f'
taking as parameter all free variables of f and returning f. Then we
can move f' to a lower level and replace the definition of f by an
application of f' to the actual value of the free variables. For
instance, this piece of code:

   function g () {
     var x = e
     function f (y) {
       return (x + y)
     }
     ...
   }

is turned into:

   function f'(x) {
     return function f (y) {
       return (x + y)
     }
   }
   function g () {
     var x = e
     var f = f'(x)
   }

Lambda-lifing has a quadratic space complexity, so we try not to lift
too many functions: we lift functions only starting at a given depth
threshold and when they themselves contains nested functions. We also
only lift functions that are isolated, so as not having to deal with
mutually recursive functions.

This implementation is doing the job: the nesting depth remains low
enough for the JavaScript engines and few functions are lifted.
However, on some large code, we can generate functions with thousands
of parameters. We might be able to improve on that by not lifting
functions too much, so that most of their free variables remain
directly accessible. A complimentary approach would be that when we
lift two functions which are initially within one another, we could
put them into nested wrapper functions. Then, the inner wrapper would
only need to deal with free variables from the inner function which
are not bound in the outer function.
*)</span><span class="EOL">
</span><span class="EOL">
</span><span class="OPEN">open</span><span class="BANG">!</span> <a href="stdlib.ml.html"><span class="UIDENT">Stdlib</span></a><span class="EOL">
</span><span class="OPEN">open</span> <a href="code.ml.html"><span class="UIDENT">Code</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-debug"><span class="LIDENT">debug</span></span> <span class="EQUAL">=</span> <a href="debug.ml.html#val-find"><span class="UIDENT">Debug</span><span class="DOT">.</span><span class="LIDENT">find</span></a> <span class="STRING">&quot;lifting&quot;</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span class="REC">rec</span> <span id="val-compute_depth"><span class="LIDENT">compute_depth</span></span> <span id="local_program_1"><span class="LIDENT">program</span></span> <span id="local_pc_2"><span class="LIDENT">pc</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="code.ml.html#val-preorder_traverse"><span class="UIDENT">Code</span><span class="DOT">.</span><span class="LIDENT">preorder_traverse</span></a><span class="EOL">
</span>    <span class="LBRACE">{</span> <span class="LIDENT">fold</span> <span class="EQUAL">=</span> <a href="code.ml.html#val-fold_children"><span class="UIDENT">Code</span><span class="DOT">.</span><span class="LIDENT">fold_children</span></a> <span class="RBRACE">}</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_pc_3"><span class="LIDENT">pc</span></span> <span id="local_d_4"><span class="LIDENT">d</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_block_5"><span class="LIDENT">block</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/map.ml.html#module-Make.val-find"><span class="UIDENT">Code</span><span class="DOT">.</span><span class="UIDENT">Addr</span><span class="DOT">.</span><span class="UIDENT">Map</span><span class="DOT">.</span><span class="LIDENT">find</span></a> <a href="#local_pc_3"><span class="LIDENT">pc</span></a> <a href="#local_program_1"><span class="LIDENT">program</span></a><span class="DOT">.</span><span class="LIDENT">blocks</span> <span class="IN">in</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-fold_left"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">fold_left</span></a> <a href="#local_block_5"><span class="LIDENT">block</span></a><span class="DOT">.</span><span class="LIDENT">body</span> <span class="LABEL">~init:</span><a href="#local_d_4"><span class="LIDENT">d</span></a> <span class="LABEL">~f:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_d_6"><span class="LIDENT">d</span></span> <span class="LPAREN">(</span><span id="local_i_7"><span class="LIDENT">i</span></span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="MATCH">match</span> <a href="#local_i_7"><span class="LIDENT">i</span></a> <span class="WITH">with</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="UIDENT">Let</span> <span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UIDENT">Closure</span> <span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="LPAREN">(</span><span id="local_pc'_8"><span class="LIDENT">pc'</span></span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>              <span class="LET">let</span> <span id="local_d'_9"><span class="LIDENT">d'</span></span> <span class="EQUAL">=</span> <span class="LIDENT">compute_depth</span> <a href="#local_program_1"><span class="LIDENT">program</span></a> <a href="#local_pc'_8"><span class="LIDENT">pc'</span></a> <span class="IN">in</span><span class="EOL">
</span>              <a href="stdlib.ml.html#module-Int_replace_polymorphic_compare.val-max"><span class="LIDENT">max</span></a> <a href="#local_d_6"><span class="LIDENT">d</span></a> <span class="LPAREN">(</span><a href="#local_d'_9"><span class="LIDENT">d'</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <span class="INT">1</span><span class="RPAREN">)</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_d_6"><span class="LIDENT">d</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>    <a href="#local_pc_2"><span class="LIDENT">pc</span></a><span class="EOL">
</span>    <a href="#local_program_1"><span class="LIDENT">program</span></a><span class="DOT">.</span><span class="LIDENT">blocks</span><span class="EOL">
</span>    <span class="INT">0</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-collect_free_vars"><span class="LIDENT">collect_free_vars</span></span> <span id="local_program_10"><span class="LIDENT">program</span></span> <span id="local_var_depth_11"><span class="LIDENT">var_depth</span></span> <span id="local_depth_12"><span class="LIDENT">depth</span></span> <span id="local_pc_13"><span class="LIDENT">pc</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_vars_14"><span class="LIDENT">vars</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ref"><span class="LIDENT">ref</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/set.ml.html#module-Make.val-empty"><span class="UIDENT">Var</span><span class="DOT">.</span><span class="UIDENT">Set</span><span class="DOT">.</span><span class="LIDENT">empty</span></a> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_baseline_15"><span class="LIDENT">baseline</span></span> <span class="EQUAL">=</span> <a href="config.ml.html#module-Param.val-lambda_lifting_baseline"><span class="UIDENT">Config</span><span class="DOT">.</span><span class="UIDENT">Param</span><span class="DOT">.</span><span class="LIDENT">lambda_lifting_baseline</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="REC">rec</span> <span id="local_traverse_16"><span class="LIDENT">traverse</span></span> <span id="local_pc_17"><span class="LIDENT">pc</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <a href="code.ml.html#val-preorder_traverse"><span class="UIDENT">Code</span><span class="DOT">.</span><span class="LIDENT">preorder_traverse</span></a><span class="EOL">
</span>      <span class="LBRACE">{</span> <span class="LIDENT">fold</span> <span class="EQUAL">=</span> <a href="code.ml.html#val-fold_children"><span class="UIDENT">Code</span><span class="DOT">.</span><span class="LIDENT">fold_children</span></a> <span class="RBRACE">}</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_pc_18"><span class="LIDENT">pc</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_block_19"><span class="LIDENT">block</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/map.ml.html#module-Make.val-find"><span class="UIDENT">Code</span><span class="DOT">.</span><span class="UIDENT">Addr</span><span class="DOT">.</span><span class="UIDENT">Map</span><span class="DOT">.</span><span class="LIDENT">find</span></a> <a href="#local_pc_18"><span class="LIDENT">pc</span></a> <a href="#local_program_10"><span class="LIDENT">program</span></a><span class="DOT">.</span><span class="LIDENT">blocks</span> <span class="IN">in</span><span class="EOL">
</span>        <a href="freevars.ml.html#val-iter_block_free_vars"><span class="UIDENT">Freevars</span><span class="DOT">.</span><span class="LIDENT">iter_block_free_vars</span></a><span class="EOL">
</span>          <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_x_20"><span class="LIDENT">x</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <span class="LET">let</span> <span id="local_idx_21"><span class="LIDENT">idx</span></span> <span class="EQUAL">=</span> <a href="code.ml.html#module-Var.val-idx"><span class="UIDENT">Var</span><span class="DOT">.</span><span class="LIDENT">idx</span></a> <a href="#local_x_20"><span class="LIDENT">x</span></a> <span class="IN">in</span><span class="EOL">
</span>            <span class="IF">if</span> <a href="#local_idx_21"><span class="LIDENT">idx</span></a> <a href="stdlib.ml.html#module-Int_replace_polymorphic_compare.val-(&lt;)"><span class="LESS">&lt;</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/array.ml.html#val-length"><span class="UIDENT">Array</span><span class="DOT">.</span><span class="LIDENT">length</span></a> <a href="#local_var_depth_11"><span class="LIDENT">var_depth</span></a><span class="EOL">
</span>            <span class="THEN">then</span> <span class="LPAREN">(</span><span class="EOL">
</span>              <span class="LET">let</span> <span id="local_d_22"><span class="LIDENT">d</span></span> <span class="EQUAL">=</span> <a href="#local_var_depth_11"><span class="LIDENT">var_depth</span></a><span class="DOT">.</span><span class="LPAREN">(</span><a href="#local_idx_21"><span class="LIDENT">idx</span></a><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>              <span class="ASSERT">assert</span> <span class="LPAREN">(</span><a href="#local_d_22"><span class="LIDENT">d</span></a> <a href="stdlib.ml.html#module-Int_replace_polymorphic_compare.val-(&gt;=)"><span class="INFIXOP0">&gt;=</span></a> <span class="INT">0</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>              <span class="IF">if</span> <a href="#local_d_22"><span class="LIDENT">d</span></a> <a href="stdlib.ml.html#module-Int_replace_polymorphic_compare.val-(&gt;)"><span class="GREATER">&gt;</span></a> <a href="#local_baseline_15"><span class="LIDENT">baseline</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&amp;&amp;)"><span class="AMPERAMPER">&amp;&amp;</span></a> <a href="#local_d_22"><span class="LIDENT">d</span></a> <a href="stdlib.ml.html#module-Int_replace_polymorphic_compare.val-(&lt;)"><span class="LESS">&lt;</span></a> <a href="#local_depth_12"><span class="LIDENT">depth</span></a> <span class="THEN">then</span> <a href="#local_vars_14"><span class="LIDENT">vars</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/set.ml.html#module-Make.val-add"><span class="UIDENT">Var</span><span class="DOT">.</span><span class="UIDENT">Set</span><span class="DOT">.</span><span class="LIDENT">add</span></a> <a href="#local_x_20"><span class="LIDENT">x</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="#local_vars_14"><span class="LIDENT">vars</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>          <a href="#local_block_19"><span class="LIDENT">block</span></a><span class="SEMI">;</span><span class="EOL">
</span>        <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-iter"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">iter</span></a> <a href="#local_block_19"><span class="LIDENT">block</span></a><span class="DOT">.</span><span class="LIDENT">body</span> <span class="LABEL">~f:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span id="local_i_23"><span class="LIDENT">i</span></span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <span class="MATCH">match</span> <a href="#local_i_23"><span class="LIDENT">i</span></a> <span class="WITH">with</span><span class="EOL">
</span>            <span class="BAR">|</span> <span class="UIDENT">Let</span> <span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UIDENT">Closure</span> <span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="LPAREN">(</span><span id="local_pc'_24"><span class="LIDENT">pc'</span></span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_traverse_16"><span class="LIDENT">traverse</span></a> <a href="#local_pc'_24"><span class="LIDENT">pc'</span></a><span class="EOL">
</span>            <span class="BAR">|</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>      <a href="#local_pc_17"><span class="LIDENT">pc</span></a><span class="EOL">
</span>      <a href="#local_program_10"><span class="LIDENT">program</span></a><span class="DOT">.</span><span class="LIDENT">blocks</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <a href="#local_traverse_16"><span class="LIDENT">traverse</span></a> <a href="#local_pc_13"><span class="LIDENT">pc</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="#local_vars_14"><span class="LIDENT">vars</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-mark_bound_variables"><span class="LIDENT">mark_bound_variables</span></span> <span id="local_var_depth_25"><span class="LIDENT">var_depth</span></span> <span id="local_block_26"><span class="LIDENT">block</span></span> <span id="local_depth_27"><span class="LIDENT">depth</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="freevars.ml.html#val-iter_block_bound_vars"><span class="UIDENT">Freevars</span><span class="DOT">.</span><span class="LIDENT">iter_block_bound_vars</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_x_28"><span class="LIDENT">x</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_var_depth_25"><span class="LIDENT">var_depth</span></a><span class="DOT">.</span><span class="LPAREN">(</span><a href="code.ml.html#module-Var.val-idx"><span class="UIDENT">Var</span><span class="DOT">.</span><span class="LIDENT">idx</span></a> <a href="#local_x_28"><span class="LIDENT">x</span></a><span class="RPAREN">)</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_depth_27"><span class="LIDENT">depth</span></a><span class="RPAREN">)</span> <a href="#local_block_26"><span class="LIDENT">block</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-iter"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">iter</span></a> <a href="#local_block_26"><span class="LIDENT">block</span></a><span class="DOT">.</span><span class="LIDENT">body</span> <span class="LABEL">~f:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span id="local_i_29"><span class="LIDENT">i</span></span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="MATCH">match</span> <a href="#local_i_29"><span class="LIDENT">i</span></a> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Let</span> <span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UIDENT">Closure</span> <span class="LPAREN">(</span><span id="local_params_30"><span class="LIDENT">params</span></span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-iter"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">iter</span></a> <a href="#local_params_30"><span class="LIDENT">params</span></a> <span class="LABEL">~f:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_x_31"><span class="LIDENT">x</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_var_depth_25"><span class="LIDENT">var_depth</span></a><span class="DOT">.</span><span class="LPAREN">(</span><a href="code.ml.html#module-Var.val-idx"><span class="UIDENT">Var</span><span class="DOT">.</span><span class="LIDENT">idx</span></a> <a href="#local_x_31"><span class="LIDENT">x</span></a><span class="RPAREN">)</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_depth_27"><span class="LIDENT">depth</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <span class="INT">1</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span class="REC">rec</span> <span id="val-traverse"><span class="LIDENT">traverse</span></span> <span id="local_var_depth_32"><span class="LIDENT">var_depth</span></span> <span class="LPAREN">(</span><span id="local_program_33"><span class="LIDENT">program</span></span><span class="COMMA">,</span> <span id="local_functions_34"><span class="LIDENT">functions</span></span><span class="RPAREN">)</span> <span id="local_pc_35"><span class="LIDENT">pc</span></span> <span id="local_depth_36"><span class="LIDENT">depth</span></span> <span id="local_limit_37"><span class="LIDENT">limit</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_baseline_38"><span class="LIDENT">baseline</span></span> <span class="EQUAL">=</span> <a href="config.ml.html#module-Param.val-lambda_lifting_baseline"><span class="UIDENT">Config</span><span class="DOT">.</span><span class="UIDENT">Param</span><span class="DOT">.</span><span class="LIDENT">lambda_lifting_baseline</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>  <a href="code.ml.html#val-preorder_traverse"><span class="UIDENT">Code</span><span class="DOT">.</span><span class="LIDENT">preorder_traverse</span></a><span class="EOL">
</span>    <span class="LBRACE">{</span> <span class="LIDENT">fold</span> <span class="EQUAL">=</span> <a href="code.ml.html#val-fold_children"><span class="UIDENT">Code</span><span class="DOT">.</span><span class="LIDENT">fold_children</span></a> <span class="RBRACE">}</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_pc_39"><span class="LIDENT">pc</span></span> <span class="LPAREN">(</span><span id="local_program_40"><span class="LIDENT">program</span></span><span class="COMMA">,</span> <span id="local_functions_41"><span class="LIDENT">functions</span></span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_block_42"><span class="LIDENT">block</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/map.ml.html#module-Make.val-find"><span class="UIDENT">Code</span><span class="DOT">.</span><span class="UIDENT">Addr</span><span class="DOT">.</span><span class="UIDENT">Map</span><span class="DOT">.</span><span class="LIDENT">find</span></a> <a href="#local_pc_39"><span class="LIDENT">pc</span></a> <a href="#local_program_40"><span class="LIDENT">program</span></a><span class="DOT">.</span><span class="LIDENT">blocks</span> <span class="IN">in</span><span class="EOL">
</span>      <span class="LIDENT">mark_bound_variables</span> <a href="#local_var_depth_32"><span class="LIDENT">var_depth</span></a> <a href="#local_block_42"><span class="LIDENT">block</span></a> <a href="#local_depth_36"><span class="LIDENT">depth</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <span class="IF">if</span> <a href="#local_depth_36"><span class="LIDENT">depth</span></a> <a href="stdlib.ml.html#module-Int_replace_polymorphic_compare.val-(=)"><span class="EQUAL">=</span></a> <a href="#local_baseline_38"><span class="LIDENT">baseline</span></a><span class="EOL">
</span>      <span class="THEN">then</span> <span class="LPAREN">(</span><span class="EOL">
</span>        <span class="ASSERT">assert</span> <span class="LPAREN">(</span><a href="stdlib.ml.html#module-List.val-is_empty"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">is_empty</span></a> <a href="#local_functions_41"><span class="LIDENT">functions</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="def_117"><span id="local_program_43"><span class="LIDENT">program</span></span><span class="COMMA">,</span> <span id="local_body_44"><span class="LIDENT">body</span></span></span> <span class="EQUAL">=</span><span class="EOL">
</span>          <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-fold_right"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">fold_right</span></a> <a href="#local_block_42"><span class="LIDENT">block</span></a><span class="DOT">.</span><span class="LIDENT">body</span> <span class="LABEL">~init:</span><span class="LPAREN">(</span><a href="#local_program_40"><span class="LIDENT">program</span></a><span class="COMMA">,</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span><span class="RPAREN">)</span> <span class="LABEL">~f:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_i_45"><span class="LIDENT">i</span></span> <span class="LPAREN">(</span><span id="local_program_46"><span class="LIDENT">program</span></span><span class="COMMA">,</span> <span id="local_rem_47"><span class="LIDENT">rem</span></span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>              <span class="MATCH">match</span> <a href="#local_i_45"><span class="LIDENT">i</span></a> <span class="WITH">with</span><span class="EOL">
</span>              <span class="BAR">|</span> <span class="LPAREN">(</span><span class="UIDENT">Let</span> <span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UIDENT">Closure</span> <span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="LPAREN">(</span><span id="local_pc'_49"><span class="LIDENT">pc'</span></span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="COMMA">,</span> <span id="local__loc_50"><span class="LIDENT">_loc</span></span><span class="RPAREN">)</span> <span class="AS">as</span> <span id="local_i_48"><span class="LIDENT">i</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>                  <span class="LET">let</span> <span id="def_109"><span id="local_program_51"><span class="LIDENT">program</span></span><span class="COMMA">,</span> <span id="local_functions_52"><span class="LIDENT">functions</span></span></span> <span class="EQUAL">=</span><span class="EOL">
</span>                    <span class="LIDENT">traverse</span> <a href="#local_var_depth_32"><span class="LIDENT">var_depth</span></a> <span class="LPAREN">(</span><a href="#local_program_46"><span class="LIDENT">program</span></a><span class="COMMA">,</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span><span class="RPAREN">)</span> <a href="#local_pc'_49"><span class="LIDENT">pc'</span></a> <span class="LPAREN">(</span><a href="#local_depth_36"><span class="LIDENT">depth</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <span class="INT">1</span><span class="RPAREN">)</span> <a href="#local_limit_37"><span class="LIDENT">limit</span></a><span class="EOL">
</span>                  <span class="IN">in</span><span class="EOL">
</span>                  <a href="#local_program_51"><span class="LIDENT">program</span></a><span class="COMMA">,</span> <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-rev_append"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">rev_append</span></a> <a href="#local_functions_52"><span class="LIDENT">functions</span></a> <span class="LPAREN">(</span><a href="#local_i_48"><span class="LIDENT">i</span></a> <span class="COLONCOLON">::</span> <a href="#local_rem_47"><span class="LIDENT">rem</span></a><span class="RPAREN">)</span><span class="EOL">
</span>              <span class="BAR">|</span> <span id="local_i_53"><span class="LIDENT">i</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_program_46"><span class="LIDENT">program</span></a><span class="COMMA">,</span> <a href="#local_i_53"><span class="LIDENT">i</span></a> <span class="COLONCOLON">::</span> <a href="#local_rem_47"><span class="LIDENT">rem</span></a><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="IN">in</span><span class="EOL">
</span>        <span class="LBRACE">{</span> <a href="#local_program_43"><span class="LIDENT">program</span></a> <span class="WITH">with</span> <span class="LIDENT">blocks</span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/map.ml.html#module-Make.val-add"><span class="UIDENT">Addr</span><span class="DOT">.</span><span class="UIDENT">Map</span><span class="DOT">.</span><span class="LIDENT">add</span></a> <a href="#local_pc_39"><span class="LIDENT">pc</span></a> <span class="LBRACE">{</span> <a href="#local_block_42"><span class="LIDENT">block</span></a> <span class="WITH">with</span> <a href="#local_body_44"><span class="LIDENT">body</span></a> <span class="RBRACE">}</span> <a href="#local_program_43"><span class="LIDENT">program</span></a><span class="DOT">.</span><span class="LIDENT">blocks</span> <span class="RBRACE">}</span><span class="COMMA">,</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="ELSE">else</span> <span class="IF">if</span> <a href="#local_depth_36"><span class="LIDENT">depth</span></a> <a href="stdlib.ml.html#module-Int_replace_polymorphic_compare.val-(&lt;)"><span class="LESS">&lt;</span></a> <a href="#local_limit_37"><span class="LIDENT">limit</span></a><span class="EOL">
</span>      <span class="THEN">then</span><span class="EOL">
</span>        <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-fold_left"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">fold_left</span></a> <a href="#local_block_42"><span class="LIDENT">block</span></a><span class="DOT">.</span><span class="LIDENT">body</span> <span class="LABEL">~init:</span><span class="LPAREN">(</span><a href="#local_program_40"><span class="LIDENT">program</span></a><span class="COMMA">,</span> <a href="#local_functions_41"><span class="LIDENT">functions</span></a><span class="RPAREN">)</span> <span class="LABEL">~f:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_st_54"><span class="LIDENT">st</span></span> <span id="local_i_55"><span class="LIDENT">i</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <span class="MATCH">match</span> <a href="#local_i_55"><span class="LIDENT">i</span></a> <span class="WITH">with</span><span class="EOL">
</span>            <span class="BAR">|</span> <span class="UIDENT">Let</span> <span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UIDENT">Closure</span> <span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="LPAREN">(</span><span id="local_pc'_56"><span class="LIDENT">pc'</span></span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>                <span class="LIDENT">traverse</span> <a href="#local_var_depth_32"><span class="LIDENT">var_depth</span></a> <a href="#local_st_54"><span class="LIDENT">st</span></a> <a href="#local_pc'_56"><span class="LIDENT">pc'</span></a> <span class="LPAREN">(</span><a href="#local_depth_36"><span class="LIDENT">depth</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <span class="INT">1</span><span class="RPAREN">)</span> <a href="#local_limit_37"><span class="LIDENT">limit</span></a><span class="EOL">
</span>            <span class="BAR">|</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_st_54"><span class="LIDENT">st</span></a><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="ELSE">else</span><span class="EOL">
</span>        <span class="COMMENT">(* We lift isolated closures (so that we do not have to deal
           with mutual recursion) which are deep enough and contain
           deeply nested closures. *)</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_does_not_start_with_closure_57"><span class="LIDENT">does_not_start_with_closure</span></span> <span id="local_l_58"><span class="LIDENT">l</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>          <span class="MATCH">match</span> <a href="#local_l_58"><span class="LIDENT">l</span></a> <span class="WITH">with</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="LPAREN">(</span><span class="UIDENT">Let</span> <span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UIDENT">Closure</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="COLONCOLON">::</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="FALSE">false</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="TRUE">true</span><span class="EOL">
</span>        <span class="IN">in</span><span class="EOL">
</span>        <span class="LET">let</span> <span class="REC">rec</span> <span id="local_rewrite_body_59"><span class="LIDENT">rewrite_body</span></span> <span id="local_first_60"><span class="LIDENT">first</span></span> <span id="local_st_61"><span class="LIDENT">st</span></span> <span id="local_l_62"><span class="LIDENT">l</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>          <span class="MATCH">match</span> <a href="#local_l_62"><span class="LIDENT">l</span></a> <span class="WITH">with</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="LPAREN">(</span><span class="LPAREN">(</span><span class="UIDENT">Let</span> <span class="LPAREN">(</span><span id="local_f_64"><span class="LIDENT">f</span></span><span class="COMMA">,</span> <span class="LPAREN">(</span><span class="UIDENT">Closure</span> <span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="LPAREN">(</span><span id="local_pc'_66"><span class="LIDENT">pc'</span></span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span><span class="RPAREN">)</span> <span class="AS">as</span> <span id="local_cl_65"><span class="LIDENT">cl</span></span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="COMMA">,</span> <span id="local_loc_67"><span class="LIDENT">loc</span></span><span class="RPAREN">)</span> <span class="AS">as</span> <span id="local_i_63"><span class="LIDENT">i</span></span><span class="RPAREN">)</span> <span class="COLONCOLON">::</span> <span id="local_rem_68"><span class="LIDENT">rem</span></span><span class="EOL">
</span>            <span class="WHEN">when</span> <a href="#local_first_60"><span class="LIDENT">first</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&amp;&amp;)"><span class="AMPERAMPER">&amp;&amp;</span></a> <a href="#local_does_not_start_with_closure_57"><span class="LIDENT">does_not_start_with_closure</span></a> <a href="#local_rem_68"><span class="LIDENT">rem</span></a> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>              <span class="LET">let</span> <span id="local_threshold_69"><span class="LIDENT">threshold</span></span> <span class="EQUAL">=</span> <a href="config.ml.html#module-Param.val-lambda_lifting_threshold"><span class="UIDENT">Config</span><span class="DOT">.</span><span class="UIDENT">Param</span><span class="DOT">.</span><span class="LIDENT">lambda_lifting_threshold</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>              <span class="LET">let</span> <span id="def_110"><span id="local_program_70"><span class="LIDENT">program</span></span><span class="COMMA">,</span> <span id="local_functions_71"><span class="LIDENT">functions</span></span></span> <span class="EQUAL">=</span><span class="EOL">
</span>                <span class="LIDENT">traverse</span> <a href="#local_var_depth_32"><span class="LIDENT">var_depth</span></a> <a href="#local_st_61"><span class="LIDENT">st</span></a> <a href="#local_pc'_66"><span class="LIDENT">pc'</span></a> <span class="LPAREN">(</span><a href="#local_depth_36"><span class="LIDENT">depth</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <span class="INT">1</span><span class="RPAREN">)</span> <span class="LPAREN">(</span><a href="#local_depth_36"><span class="LIDENT">depth</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <a href="#local_threshold_69"><span class="LIDENT">threshold</span></a><span class="RPAREN">)</span><span class="EOL">
</span>              <span class="IN">in</span><span class="EOL">
</span>              <span class="IF">if</span> <span class="LIDENT">compute_depth</span> <a href="#local_program_70"><span class="LIDENT">program</span></a> <a href="#local_pc'_66"><span class="LIDENT">pc'</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <span class="INT">1</span> <a href="stdlib.ml.html#module-Int_replace_polymorphic_compare.val-(&gt;=)"><span class="INFIXOP0">&gt;=</span></a> <a href="#local_threshold_69"><span class="LIDENT">threshold</span></a><span class="EOL">
</span>              <span class="THEN">then</span> <span class="LPAREN">(</span><span class="EOL">
</span>                <span class="LET">let</span> <span id="local_free_vars_72"><span class="LIDENT">free_vars</span></span> <span class="EQUAL">=</span> <span class="LIDENT">collect_free_vars</span> <a href="#local_program_70"><span class="LIDENT">program</span></a> <a href="#local_var_depth_32"><span class="LIDENT">var_depth</span></a> <span class="LPAREN">(</span><a href="#local_depth_36"><span class="LIDENT">depth</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <span class="INT">1</span><span class="RPAREN">)</span> <a href="#local_pc'_66"><span class="LIDENT">pc'</span></a> <span class="IN">in</span><span class="EOL">
</span>                <span class="LET">let</span> <span id="local_s_73"><span class="LIDENT">s</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>                  <a href="../../../ocaml-base-compiler/src/stdlib/set.ml.html#module-Make.val-fold"><span class="UIDENT">Var</span><span class="DOT">.</span><span class="UIDENT">Set</span><span class="DOT">.</span><span class="LIDENT">fold</span></a><span class="EOL">
</span>                    <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_x_74"><span class="LIDENT">x</span></span> <span id="local_m_75"><span class="LIDENT">m</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/map.ml.html#module-Make.val-add"><span class="UIDENT">Var</span><span class="DOT">.</span><span class="UIDENT">Map</span><span class="DOT">.</span><span class="LIDENT">add</span></a> <a href="#local_x_74"><span class="LIDENT">x</span></a> <span class="LPAREN">(</span><a href="code.ml.html#module-Var.val-fork"><span class="UIDENT">Var</span><span class="DOT">.</span><span class="LIDENT">fork</span></a> <a href="#local_x_74"><span class="LIDENT">x</span></a><span class="RPAREN">)</span> <a href="#local_m_75"><span class="LIDENT">m</span></a><span class="RPAREN">)</span><span class="EOL">
</span>                    <a href="#local_free_vars_72"><span class="LIDENT">free_vars</span></a><span class="EOL">
</span>                    <a href="../../../ocaml-base-compiler/src/stdlib/map.ml.html#module-Make.val-empty"><span class="UIDENT">Var</span><span class="DOT">.</span><span class="UIDENT">Map</span><span class="DOT">.</span><span class="LIDENT">empty</span></a><span class="EOL">
</span>                <span class="IN">in</span><span class="EOL">
</span>                <span class="LET">let</span> <span id="local_program_76"><span class="LIDENT">program</span></span> <span class="EQUAL">=</span> <a href="subst.ml.html#val-cont"><span class="UIDENT">Subst</span><span class="DOT">.</span><span class="LIDENT">cont</span></a> <span class="LPAREN">(</span><a href="subst.ml.html#val-from_map"><span class="UIDENT">Subst</span><span class="DOT">.</span><span class="LIDENT">from_map</span></a> <a href="#local_s_73"><span class="LIDENT">s</span></a><span class="RPAREN">)</span> <a href="#local_pc'_66"><span class="LIDENT">pc'</span></a> <a href="#local_program_70"><span class="LIDENT">program</span></a> <span class="IN">in</span><span class="EOL">
</span>                <span class="LET">let</span> <span id="local_f'_77"><span class="LIDENT">f'</span></span> <span class="EQUAL">=</span> <span class="TRY">try</span> <a href="../../../ocaml-base-compiler/src/stdlib/map.ml.html#module-Make.val-find"><span class="UIDENT">Var</span><span class="DOT">.</span><span class="UIDENT">Map</span><span class="DOT">.</span><span class="LIDENT">find</span></a> <a href="#local_f_64"><span class="LIDENT">f</span></a> <a href="#local_s_73"><span class="LIDENT">s</span></a> <span class="WITH">with</span> <span class="UIDENT">Not_found</span> <span class="MINUSGREATER">-&gt;</span> <a href="code.ml.html#module-Var.val-fork"><span class="UIDENT">Var</span><span class="DOT">.</span><span class="LIDENT">fork</span></a> <a href="#local_f_64"><span class="LIDENT">f</span></a> <span class="IN">in</span><span class="EOL">
</span>                <span class="LET">let</span> <span id="local_s_78"><span class="LIDENT">s</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/map.ml.html#module-Make.val-bindings"><span class="UIDENT">Var</span><span class="DOT">.</span><span class="UIDENT">Map</span><span class="DOT">.</span><span class="LIDENT">bindings</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/map.ml.html#module-Make.val-remove"><span class="UIDENT">Var</span><span class="DOT">.</span><span class="UIDENT">Map</span><span class="DOT">.</span><span class="LIDENT">remove</span></a> <a href="#local_f_64"><span class="LIDENT">f</span></a> <a href="#local_s_73"><span class="LIDENT">s</span></a><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>                <span class="LET">let</span> <span id="local_f''_79"><span class="LIDENT">f''</span></span> <span class="EQUAL">=</span> <a href="code.ml.html#module-Var.val-fork"><span class="UIDENT">Var</span><span class="DOT">.</span><span class="LIDENT">fork</span></a> <a href="#local_f_64"><span class="LIDENT">f</span></a> <span class="IN">in</span><span class="EOL">
</span>                <span class="IF">if</span> <span class="LIDENT">debug</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>                <span class="THEN">then</span><span class="EOL">
</span>                  <a href="../../../ocaml-base-compiler/src/stdlib/format.ml.html#val-eprintf"><span class="UIDENT">Format</span><span class="DOT">.</span><span class="LIDENT">eprintf</span></a><span class="EOL">
</span>                    <span class="STRING">&quot;LIFT %s (depth:%d free_vars:%d inner_depth:%d)@.&quot;</span><span class="EOL">
</span>                    <span class="LPAREN">(</span><a href="code.ml.html#module-Var.val-to_string"><span class="UIDENT">Code</span><span class="DOT">.</span><span class="UIDENT">Var</span><span class="DOT">.</span><span class="LIDENT">to_string</span></a> <a href="#local_f''_79"><span class="LIDENT">f''</span></a><span class="RPAREN">)</span><span class="EOL">
</span>                    <a href="#local_depth_36"><span class="LIDENT">depth</span></a><span class="EOL">
</span>                    <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/set.ml.html#module-Make.val-cardinal"><span class="UIDENT">Var</span><span class="DOT">.</span><span class="UIDENT">Set</span><span class="DOT">.</span><span class="LIDENT">cardinal</span></a> <a href="#local_free_vars_72"><span class="LIDENT">free_vars</span></a><span class="RPAREN">)</span><span class="EOL">
</span>                    <span class="LPAREN">(</span><span class="LIDENT">compute_depth</span> <a href="#local_program_76"><span class="LIDENT">program</span></a> <a href="#local_pc'_66"><span class="LIDENT">pc'</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>                <span class="LET">let</span> <span id="local_pc''_80"><span class="LIDENT">pc''</span></span> <span class="EQUAL">=</span> <a href="#local_program_76"><span class="LIDENT">program</span></a><span class="DOT">.</span><span class="LIDENT">free_pc</span> <span class="IN">in</span><span class="EOL">
</span>                <span class="LET">let</span> <span id="local_bl_81"><span class="LIDENT">bl</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>                  <span class="LBRACE">{</span> <span class="LIDENT">params</span> <span class="EQUAL">=</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span><span class="EOL">
</span>                  <span class="SEMI">;</span> <span class="LIDENT">body</span> <span class="EQUAL">=</span> <span class="LBRACKET">[</span> <span class="UIDENT">Let</span> <span class="LPAREN">(</span><a href="#local_f'_77"><span class="LIDENT">f'</span></a><span class="COMMA">,</span> <a href="#local_cl_65"><span class="LIDENT">cl</span></a><span class="RPAREN">)</span><span class="COMMA">,</span> <a href="code.ml.html#val-noloc"><span class="LIDENT">noloc</span></a> <span class="RBRACKET">]</span><span class="EOL">
</span>                  <span class="SEMI">;</span> <span class="LIDENT">branch</span> <span class="EQUAL">=</span> <span class="UIDENT">Return</span> <a href="#local_f'_77"><span class="LIDENT">f'</span></a><span class="COMMA">,</span> <a href="code.ml.html#val-noloc"><span class="LIDENT">noloc</span></a><span class="EOL">
</span>                  <span class="RBRACE">}</span><span class="EOL">
</span>                <span class="IN">in</span><span class="EOL">
</span>                <span class="LET">let</span> <span id="local_program_82"><span class="LIDENT">program</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>                  <span class="LBRACE">{</span> <a href="#local_program_76"><span class="LIDENT">program</span></a> <span class="WITH">with</span><span class="EOL">
</span>                    <span class="LIDENT">free_pc</span> <span class="EQUAL">=</span> <a href="#local_pc''_80"><span class="LIDENT">pc''</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <span class="INT">1</span><span class="EOL">
</span>                  <span class="SEMI">;</span> <span class="LIDENT">blocks</span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/map.ml.html#module-Make.val-add"><span class="UIDENT">Addr</span><span class="DOT">.</span><span class="UIDENT">Map</span><span class="DOT">.</span><span class="LIDENT">add</span></a> <a href="#local_pc''_80"><span class="LIDENT">pc''</span></a> <a href="#local_bl_81"><span class="LIDENT">bl</span></a> <a href="#local_program_76"><span class="LIDENT">program</span></a><span class="DOT">.</span><span class="LIDENT">blocks</span><span class="EOL">
</span>                  <span class="RBRACE">}</span><span class="EOL">
</span>                <span class="IN">in</span><span class="EOL">
</span>                <span class="LET">let</span> <span id="local_functions_83"><span class="LIDENT">functions</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>                  <span class="LPAREN">(</span><span class="UIDENT">Let</span> <span class="LPAREN">(</span><a href="#local_f''_79"><span class="LIDENT">f''</span></a><span class="COMMA">,</span> <span class="UIDENT">Closure</span> <span class="LPAREN">(</span><a href="stdlib.ml.html#module-List.val-map"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">map</span></a> <a href="#local_s_78"><span class="LIDENT">s</span></a> <span class="LABEL">~f:</span><a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-snd"><span class="LIDENT">snd</span></a><span class="COMMA">,</span> <span class="LPAREN">(</span><a href="#local_pc''_80"><span class="LIDENT">pc''</span></a><span class="COMMA">,</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="COMMA">,</span> <a href="#local_loc_67"><span class="LIDENT">loc</span></a><span class="RPAREN">)</span> <span class="COLONCOLON">::</span> <a href="#local_functions_71"><span class="LIDENT">functions</span></a><span class="EOL">
</span>                <span class="IN">in</span><span class="EOL">
</span>                <span class="LET">let</span> <span id="def_113"><span id="local_rem'_84"><span class="LIDENT">rem'</span></span><span class="COMMA">,</span> <span id="local_st_85"><span class="LIDENT">st</span></span></span> <span class="EQUAL">=</span> <a href="#local_rewrite_body_59"><span class="LIDENT">rewrite_body</span></a> <span class="FALSE">false</span> <span class="LPAREN">(</span><a href="#local_program_82"><span class="LIDENT">program</span></a><span class="COMMA">,</span> <a href="#local_functions_83"><span class="LIDENT">functions</span></a><span class="RPAREN">)</span> <a href="#local_rem_68"><span class="LIDENT">rem</span></a> <span class="IN">in</span><span class="EOL">
</span>                <span class="LPAREN">(</span> <span class="LPAREN">(</span><span class="UIDENT">Let</span> <span class="LPAREN">(</span><a href="#local_f_64"><span class="LIDENT">f</span></a><span class="COMMA">,</span> <span class="UIDENT">Apply</span> <span class="LBRACE">{</span> <span class="LIDENT">f</span> <span class="EQUAL">=</span> <a href="#local_f''_79"><span class="LIDENT">f''</span></a><span class="SEMI">;</span> <span class="LIDENT">args</span> <span class="EQUAL">=</span> <a href="stdlib.ml.html#module-List.val-map"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">map</span></a> <span class="LABEL">~f:</span><a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-fst"><span class="LIDENT">fst</span></a> <a href="#local_s_78"><span class="LIDENT">s</span></a><span class="SEMI">;</span> <span class="LIDENT">exact</span> <span class="EQUAL">=</span> <span class="TRUE">true</span> <span class="RBRACE">}</span><span class="RPAREN">)</span><span class="COMMA">,</span> <a href="#local_loc_67"><span class="LIDENT">loc</span></a><span class="RPAREN">)</span><span class="EOL">
</span>                  <span class="COLONCOLON">::</span> <a href="#local_rem'_84"><span class="LIDENT">rem'</span></a><span class="EOL">
</span>                <span class="COMMA">,</span> <a href="#local_st_85"><span class="LIDENT">st</span></a> <span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>              <span class="ELSE">else</span><span class="EOL">
</span>                <span class="LET">let</span> <span id="def_112"><span id="local_rem'_86"><span class="LIDENT">rem'</span></span><span class="COMMA">,</span> <span id="local_st_87"><span class="LIDENT">st</span></span></span> <span class="EQUAL">=</span> <a href="#local_rewrite_body_59"><span class="LIDENT">rewrite_body</span></a> <span class="FALSE">false</span> <span class="LPAREN">(</span><a href="#local_program_70"><span class="LIDENT">program</span></a><span class="COMMA">,</span> <a href="#local_functions_71"><span class="LIDENT">functions</span></a><span class="RPAREN">)</span> <a href="#local_rem_68"><span class="LIDENT">rem</span></a> <span class="IN">in</span><span class="EOL">
</span>                <a href="#local_i_63"><span class="LIDENT">i</span></a> <span class="COLONCOLON">::</span> <a href="#local_rem'_86"><span class="LIDENT">rem'</span></a><span class="COMMA">,</span> <a href="#local_st_87"><span class="LIDENT">st</span></a><span class="EOL">
</span>          <span class="BAR">|</span> <span class="LPAREN">(</span><span class="LPAREN">(</span><span class="UIDENT">Let</span> <span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UIDENT">Closure</span> <span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="LPAREN">(</span><span id="local_pc'_89"><span class="LIDENT">pc'</span></span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="AS">as</span> <span id="local_i_88"><span class="LIDENT">i</span></span><span class="RPAREN">)</span> <span class="COLONCOLON">::</span> <span id="local_rem_90"><span class="LIDENT">rem</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>              <span class="LET">let</span> <span id="local_st_91"><span class="LIDENT">st</span></span> <span class="EQUAL">=</span> <span class="LIDENT">traverse</span> <a href="#local_var_depth_32"><span class="LIDENT">var_depth</span></a> <a href="#local_st_61"><span class="LIDENT">st</span></a> <a href="#local_pc'_89"><span class="LIDENT">pc'</span></a> <span class="LPAREN">(</span><a href="#local_depth_36"><span class="LIDENT">depth</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <span class="INT">1</span><span class="RPAREN">)</span> <a href="#local_limit_37"><span class="LIDENT">limit</span></a> <span class="IN">in</span><span class="EOL">
</span>              <span class="LET">let</span> <span id="def_115"><span id="local_rem'_92"><span class="LIDENT">rem'</span></span><span class="COMMA">,</span> <span id="local_st_93"><span class="LIDENT">st</span></span></span> <span class="EQUAL">=</span> <a href="#local_rewrite_body_59"><span class="LIDENT">rewrite_body</span></a> <span class="FALSE">false</span> <a href="#local_st_91"><span class="LIDENT">st</span></a> <a href="#local_rem_90"><span class="LIDENT">rem</span></a> <span class="IN">in</span><span class="EOL">
</span>              <a href="#local_i_88"><span class="LIDENT">i</span></a> <span class="COLONCOLON">::</span> <a href="#local_rem'_92"><span class="LIDENT">rem'</span></a><span class="COMMA">,</span> <a href="#local_st_93"><span class="LIDENT">st</span></a><span class="EOL">
</span>          <span class="BAR">|</span> <span id="local_i_94"><span class="LIDENT">i</span></span> <span class="COLONCOLON">::</span> <span id="local_rem_95"><span class="LIDENT">rem</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>              <span class="LET">let</span> <span id="def_111"><span id="local_rem'_96"><span class="LIDENT">rem'</span></span><span class="COMMA">,</span> <span id="local_st_97"><span class="LIDENT">st</span></span></span> <span class="EQUAL">=</span> <a href="#local_rewrite_body_59"><span class="LIDENT">rewrite_body</span></a> <span class="LPAREN">(</span><a href="#local_does_not_start_with_closure_57"><span class="LIDENT">does_not_start_with_closure</span></a> <a href="#local_l_62"><span class="LIDENT">l</span></a><span class="RPAREN">)</span> <a href="#local_st_61"><span class="LIDENT">st</span></a> <a href="#local_rem_95"><span class="LIDENT">rem</span></a> <span class="IN">in</span><span class="EOL">
</span>              <a href="#local_i_94"><span class="LIDENT">i</span></a> <span class="COLONCOLON">::</span> <a href="#local_rem'_96"><span class="LIDENT">rem'</span></a><span class="COMMA">,</span> <a href="#local_st_97"><span class="LIDENT">st</span></a><span class="EOL">
</span>          <span class="BAR">|</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="MINUSGREATER">-&gt;</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span><span class="COMMA">,</span> <a href="#local_st_61"><span class="LIDENT">st</span></a><span class="EOL">
</span>        <span class="IN">in</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="def_114"><span id="local_body_98"><span class="LIDENT">body</span></span><span class="COMMA">,</span> <span class="LPAREN">(</span><span id="local_program_99"><span class="LIDENT">program</span></span><span class="COMMA">,</span> <span id="local_functions_100"><span class="LIDENT">functions</span></span><span class="RPAREN">)</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>          <a href="#local_rewrite_body_59"><span class="LIDENT">rewrite_body</span></a> <span class="TRUE">true</span> <span class="LPAREN">(</span><a href="#local_program_40"><span class="LIDENT">program</span></a><span class="COMMA">,</span> <a href="#local_functions_41"><span class="LIDENT">functions</span></a><span class="RPAREN">)</span> <a href="#local_block_42"><span class="LIDENT">block</span></a><span class="DOT">.</span><span class="LIDENT">body</span><span class="EOL">
</span>        <span class="IN">in</span><span class="EOL">
</span>        <span class="LPAREN">(</span> <span class="LBRACE">{</span> <a href="#local_program_99"><span class="LIDENT">program</span></a> <span class="WITH">with</span> <span class="LIDENT">blocks</span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/map.ml.html#module-Make.val-add"><span class="UIDENT">Addr</span><span class="DOT">.</span><span class="UIDENT">Map</span><span class="DOT">.</span><span class="LIDENT">add</span></a> <a href="#local_pc_39"><span class="LIDENT">pc</span></a> <span class="LBRACE">{</span> <a href="#local_block_42"><span class="LIDENT">block</span></a> <span class="WITH">with</span> <a href="#local_body_98"><span class="LIDENT">body</span></a> <span class="RBRACE">}</span> <a href="#local_program_99"><span class="LIDENT">program</span></a><span class="DOT">.</span><span class="LIDENT">blocks</span> <span class="RBRACE">}</span><span class="EOL">
</span>        <span class="COMMA">,</span> <a href="#local_functions_100"><span class="LIDENT">functions</span></a> <span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>    <a href="#local_pc_35"><span class="LIDENT">pc</span></a><span class="EOL">
</span>    <a href="#local_program_33"><span class="LIDENT">program</span></a><span class="DOT">.</span><span class="LIDENT">blocks</span><span class="EOL">
</span>    <span class="LPAREN">(</span><a href="#local_program_33"><span class="LIDENT">program</span></a><span class="COMMA">,</span> <a href="#local_functions_34"><span class="LIDENT">functions</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-f"><span class="LIDENT">f</span></span> <span id="local_program_101"><span class="LIDENT">program</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_t_102"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span> <a href="timer.ml.html#val-make"><span class="UIDENT">Timer</span><span class="DOT">.</span><span class="LIDENT">make</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_nv_103"><span class="LIDENT">nv</span></span> <span class="EQUAL">=</span> <a href="code.ml.html#module-Var.val-count"><span class="UIDENT">Var</span><span class="DOT">.</span><span class="LIDENT">count</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_var_depth_104"><span class="LIDENT">var_depth</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/array.ml.html#val-make"><span class="UIDENT">Array</span><span class="DOT">.</span><span class="LIDENT">make</span></a> <a href="#local_nv_103"><span class="LIDENT">nv</span></a> <span class="LPAREN">(</span><span class="MINUS">-</span><span class="INT">1</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="def_116"><span id="local_program_105"><span class="LIDENT">program</span></span><span class="COMMA">,</span> <span id="local_functions_106"><span class="LIDENT">functions</span></span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_threshold_107"><span class="LIDENT">threshold</span></span> <span class="EQUAL">=</span> <a href="config.ml.html#module-Param.val-lambda_lifting_threshold"><span class="UIDENT">Config</span><span class="DOT">.</span><span class="UIDENT">Param</span><span class="DOT">.</span><span class="LIDENT">lambda_lifting_threshold</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_baseline_108"><span class="LIDENT">baseline</span></span> <span class="EQUAL">=</span> <a href="config.ml.html#module-Param.val-lambda_lifting_baseline"><span class="UIDENT">Config</span><span class="DOT">.</span><span class="UIDENT">Param</span><span class="DOT">.</span><span class="LIDENT">lambda_lifting_baseline</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="LIDENT">traverse</span> <a href="#local_var_depth_104"><span class="LIDENT">var_depth</span></a> <span class="LPAREN">(</span><a href="#local_program_101"><span class="LIDENT">program</span></a><span class="COMMA">,</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span><span class="RPAREN">)</span> <a href="#local_program_101"><span class="LIDENT">program</span></a><span class="DOT">.</span><span class="LIDENT">start</span> <span class="INT">0</span> <span class="LPAREN">(</span><a href="#local_baseline_108"><span class="LIDENT">baseline</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <a href="#local_threshold_107"><span class="LIDENT">threshold</span></a><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <span class="ASSERT">assert</span> <span class="LPAREN">(</span><a href="stdlib.ml.html#module-List.val-is_empty"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">is_empty</span></a> <a href="#local_functions_106"><span class="LIDENT">functions</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="debug.ml.html#val-find"><span class="UIDENT">Debug</span><span class="DOT">.</span><span class="LIDENT">find</span></a> <span class="STRING">&quot;times&quot;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="THEN">then</span> <a href="../../../ocaml-base-compiler/src/stdlib/format.ml.html#val-eprintf"><span class="UIDENT">Format</span><span class="DOT">.</span><span class="LIDENT">eprintf</span></a> <span class="STRING">&quot;  lambda lifting: %a@.&quot;</span> <a href="timer.ml.html#val-print"><span class="UIDENT">Timer</span><span class="DOT">.</span><span class="LIDENT">print</span></a> <a href="#local_t_102"><span class="LIDENT">t</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <a href="#local_program_105"><span class="LIDENT">program</span></a><span class="EOL">
</span></span></code></pre></body></html>
