<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Source: cycles.ml (ocamlgraph.src.ocamlgraph)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.css"/><meta name="generator" content="odoc %%VERSION%%"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/></head><body class="odoc-src"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">ocamlgraph</a> &#x00BB; <a href="../index.html">Sources</a> &#x00BB; ocamlgraph &#x00BB; cycles.ml</nav><header class="odoc-preamble"><h1>Source file <code><span>cycles.ml</span></code></h1></header><div class="odoc-tocs"><nav class="odoc-toc odoc-global-toc"><ul><li><a href="../../index.html">ocamlgraph</a><ul><li>Library <code>ocamlgraph</code><ul><li><a href="../../ocamlgraph/Graph/index.html">Graph</a></li></ul></li><li><a href="../index.html">Sources</a><ul><li>ocamlgraph<ul><li><a href="blocks.ml.html">blocks.ml</a></li><li><a href="builder.ml.html">builder.ml</a></li><li><a href="chaoticIteration.ml.html">chaoticIteration.ml</a></li><li><a href="classic.ml.html">classic.ml</a></li><li><a href="clique.ml.html">clique.ml</a></li><li><a href="cliquetree.ml.html">cliquetree.ml</a></li><li><a href="coloring.ml.html">coloring.ml</a></li><li><a href="components.ml.html">components.ml</a></li><li><a href="contraction.ml.html">contraction.ml</a></li><li><a href="#" class="current_unit">cycles.ml</a></li><li><a href="dGraphModel.ml.html">dGraphModel.ml</a></li><li><a href="dGraphRandModel.ml.html">dGraphRandModel.ml</a></li><li><a href="dGraphSubTree.ml.html">dGraphSubTree.ml</a></li><li><a href="dGraphTreeLayout.ml.html">dGraphTreeLayout.ml</a></li><li><a href="dGraphTreeModel.ml.html">dGraphTreeModel.ml</a></li><li><a href="delaunay.ml.html">delaunay.ml</a></li><li><a href="dominator.ml.html">dominator.ml</a></li><li><a href="dot.ml.html">dot.ml</a></li><li><a href="dot_lexer.ml.html">dot_lexer.ml</a></li><li><a href="dot_parser.ml.html">dot_parser.ml</a></li><li><a href="eulerian.ml.html">eulerian.ml</a></li><li><a href="fixpoint.ml.html">fixpoint.ml</a></li><li><a href="flow.ml.html">flow.ml</a></li><li><a href="gmap.ml.html">gmap.ml</a></li><li><a href="gml.ml.html">gml.ml</a></li><li><a href="graph.ml.html">graph.ml</a></li><li><a href="graph__.ml.html">graph__.ml</a></li><li><a href="graphml.ml.html">graphml.ml</a></li><li><a href="graphviz.ml.html">graphviz.ml</a></li><li><a href="imperative.ml.html">imperative.ml</a></li><li><a href="kruskal.ml.html">kruskal.ml</a></li><li><a href="leaderlist.ml.html">leaderlist.ml</a></li><li><a href="mcs_m.ml.html">mcs_m.ml</a></li><li><a href="md.ml.html">md.ml</a></li><li><a href="merge.ml.html">merge.ml</a></li><li><a href="mincut.ml.html">mincut.ml</a></li><li><a href="minsep.ml.html">minsep.ml</a></li><li><a href="nonnegative.ml.html">nonnegative.ml</a></li><li><a href="oper.ml.html">oper.ml</a></li><li><a href="pack.ml.html">pack.ml</a></li><li><a href="path.ml.html">path.ml</a></li><li><a href="persistent.ml.html">persistent.ml</a></li><li><a href="prim.ml.html">prim.ml</a></li><li><a href="rand.ml.html">rand.ml</a></li><li><a href="strat.ml.html">strat.ml</a></li><li><a href="topological.ml.html">topological.ml</a></li><li><a href="traverse.ml.html">traverse.ml</a></li><li><a href="util.ml.html">util.ml</a></li><li><a href="weakTopological.ml.html">weakTopological.ml</a></li><li><a href="xDot.ml.html">xDot.ml</a></li><li><a href="xDotDraw.ml.html">xDotDraw.ml</a></li></ul></li></ul></li></ul></li></ul></nav></div><pre class="source_container"><code class="source_line_column"><a id="L1" class="source_line" href="#L1">1</a>
<a id="L2" class="source_line" href="#L2">2</a>
<a id="L3" class="source_line" href="#L3">3</a>
<a id="L4" class="source_line" href="#L4">4</a>
<a id="L5" class="source_line" href="#L5">5</a>
<a id="L6" class="source_line" href="#L6">6</a>
<a id="L7" class="source_line" href="#L7">7</a>
<a id="L8" class="source_line" href="#L8">8</a>
<a id="L9" class="source_line" href="#L9">9</a>
<a id="L10" class="source_line" href="#L10">10</a>
<a id="L11" class="source_line" href="#L11">11</a>
<a id="L12" class="source_line" href="#L12">12</a>
<a id="L13" class="source_line" href="#L13">13</a>
<a id="L14" class="source_line" href="#L14">14</a>
<a id="L15" class="source_line" href="#L15">15</a>
<a id="L16" class="source_line" href="#L16">16</a>
<a id="L17" class="source_line" href="#L17">17</a>
<a id="L18" class="source_line" href="#L18">18</a>
<a id="L19" class="source_line" href="#L19">19</a>
<a id="L20" class="source_line" href="#L20">20</a>
<a id="L21" class="source_line" href="#L21">21</a>
<a id="L22" class="source_line" href="#L22">22</a>
<a id="L23" class="source_line" href="#L23">23</a>
<a id="L24" class="source_line" href="#L24">24</a>
<a id="L25" class="source_line" href="#L25">25</a>
<a id="L26" class="source_line" href="#L26">26</a>
<a id="L27" class="source_line" href="#L27">27</a>
<a id="L28" class="source_line" href="#L28">28</a>
<a id="L29" class="source_line" href="#L29">29</a>
<a id="L30" class="source_line" href="#L30">30</a>
<a id="L31" class="source_line" href="#L31">31</a>
<a id="L32" class="source_line" href="#L32">32</a>
<a id="L33" class="source_line" href="#L33">33</a>
<a id="L34" class="source_line" href="#L34">34</a>
<a id="L35" class="source_line" href="#L35">35</a>
<a id="L36" class="source_line" href="#L36">36</a>
<a id="L37" class="source_line" href="#L37">37</a>
<a id="L38" class="source_line" href="#L38">38</a>
<a id="L39" class="source_line" href="#L39">39</a>
<a id="L40" class="source_line" href="#L40">40</a>
<a id="L41" class="source_line" href="#L41">41</a>
<a id="L42" class="source_line" href="#L42">42</a>
<a id="L43" class="source_line" href="#L43">43</a>
<a id="L44" class="source_line" href="#L44">44</a>
<a id="L45" class="source_line" href="#L45">45</a>
<a id="L46" class="source_line" href="#L46">46</a>
<a id="L47" class="source_line" href="#L47">47</a>
<a id="L48" class="source_line" href="#L48">48</a>
<a id="L49" class="source_line" href="#L49">49</a>
<a id="L50" class="source_line" href="#L50">50</a>
<a id="L51" class="source_line" href="#L51">51</a>
<a id="L52" class="source_line" href="#L52">52</a>
<a id="L53" class="source_line" href="#L53">53</a>
<a id="L54" class="source_line" href="#L54">54</a>
<a id="L55" class="source_line" href="#L55">55</a>
<a id="L56" class="source_line" href="#L56">56</a>
<a id="L57" class="source_line" href="#L57">57</a>
<a id="L58" class="source_line" href="#L58">58</a>
<a id="L59" class="source_line" href="#L59">59</a>
<a id="L60" class="source_line" href="#L60">60</a>
<a id="L61" class="source_line" href="#L61">61</a>
<a id="L62" class="source_line" href="#L62">62</a>
<a id="L63" class="source_line" href="#L63">63</a>
<a id="L64" class="source_line" href="#L64">64</a>
<a id="L65" class="source_line" href="#L65">65</a>
<a id="L66" class="source_line" href="#L66">66</a>
<a id="L67" class="source_line" href="#L67">67</a>
<a id="L68" class="source_line" href="#L68">68</a>
<a id="L69" class="source_line" href="#L69">69</a>
<a id="L70" class="source_line" href="#L70">70</a>
<a id="L71" class="source_line" href="#L71">71</a>
<a id="L72" class="source_line" href="#L72">72</a>
<a id="L73" class="source_line" href="#L73">73</a>
<a id="L74" class="source_line" href="#L74">74</a>
<a id="L75" class="source_line" href="#L75">75</a>
<a id="L76" class="source_line" href="#L76">76</a>
<a id="L77" class="source_line" href="#L77">77</a>
<a id="L78" class="source_line" href="#L78">78</a>
<a id="L79" class="source_line" href="#L79">79</a>
<a id="L80" class="source_line" href="#L80">80</a>
<a id="L81" class="source_line" href="#L81">81</a>
<a id="L82" class="source_line" href="#L82">82</a>
<a id="L83" class="source_line" href="#L83">83</a>
<a id="L84" class="source_line" href="#L84">84</a>
<a id="L85" class="source_line" href="#L85">85</a>
<a id="L86" class="source_line" href="#L86">86</a>
<a id="L87" class="source_line" href="#L87">87</a>
<a id="L88" class="source_line" href="#L88">88</a>
<a id="L89" class="source_line" href="#L89">89</a>
<a id="L90" class="source_line" href="#L90">90</a>
<a id="L91" class="source_line" href="#L91">91</a>
<a id="L92" class="source_line" href="#L92">92</a>
<a id="L93" class="source_line" href="#L93">93</a>
<a id="L94" class="source_line" href="#L94">94</a>
<a id="L95" class="source_line" href="#L95">95</a>
<a id="L96" class="source_line" href="#L96">96</a>
<a id="L97" class="source_line" href="#L97">97</a>
<a id="L98" class="source_line" href="#L98">98</a>
<a id="L99" class="source_line" href="#L99">99</a>
<a id="L100" class="source_line" href="#L100">100</a>
<a id="L101" class="source_line" href="#L101">101</a>
<a id="L102" class="source_line" href="#L102">102</a>
<a id="L103" class="source_line" href="#L103">103</a>
<a id="L104" class="source_line" href="#L104">104</a>
<a id="L105" class="source_line" href="#L105">105</a>
<a id="L106" class="source_line" href="#L106">106</a>
<a id="L107" class="source_line" href="#L107">107</a>
<a id="L108" class="source_line" href="#L108">108</a>
<a id="L109" class="source_line" href="#L109">109</a>
<a id="L110" class="source_line" href="#L110">110</a>
<a id="L111" class="source_line" href="#L111">111</a>
<a id="L112" class="source_line" href="#L112">112</a>
<a id="L113" class="source_line" href="#L113">113</a>
<a id="L114" class="source_line" href="#L114">114</a>
<a id="L115" class="source_line" href="#L115">115</a>
<a id="L116" class="source_line" href="#L116">116</a>
<a id="L117" class="source_line" href="#L117">117</a>
<a id="L118" class="source_line" href="#L118">118</a>
<a id="L119" class="source_line" href="#L119">119</a>
<a id="L120" class="source_line" href="#L120">120</a>
<a id="L121" class="source_line" href="#L121">121</a>
<a id="L122" class="source_line" href="#L122">122</a>
<a id="L123" class="source_line" href="#L123">123</a>
<a id="L124" class="source_line" href="#L124">124</a>
<a id="L125" class="source_line" href="#L125">125</a>
<a id="L126" class="source_line" href="#L126">126</a>
<a id="L127" class="source_line" href="#L127">127</a>
<a id="L128" class="source_line" href="#L128">128</a>
<a id="L129" class="source_line" href="#L129">129</a>
<a id="L130" class="source_line" href="#L130">130</a>
<a id="L131" class="source_line" href="#L131">131</a>
<a id="L132" class="source_line" href="#L132">132</a>
<a id="L133" class="source_line" href="#L133">133</a>
<a id="L134" class="source_line" href="#L134">134</a>
<a id="L135" class="source_line" href="#L135">135</a>
<a id="L136" class="source_line" href="#L136">136</a>
<a id="L137" class="source_line" href="#L137">137</a>
<a id="L138" class="source_line" href="#L138">138</a>
<a id="L139" class="source_line" href="#L139">139</a>
<a id="L140" class="source_line" href="#L140">140</a>
<a id="L141" class="source_line" href="#L141">141</a>
<a id="L142" class="source_line" href="#L142">142</a>
<a id="L143" class="source_line" href="#L143">143</a>
<a id="L144" class="source_line" href="#L144">144</a>
<a id="L145" class="source_line" href="#L145">145</a>
<a id="L146" class="source_line" href="#L146">146</a>
<a id="L147" class="source_line" href="#L147">147</a>
<a id="L148" class="source_line" href="#L148">148</a>
<a id="L149" class="source_line" href="#L149">149</a>
<a id="L150" class="source_line" href="#L150">150</a>
<a id="L151" class="source_line" href="#L151">151</a>
<a id="L152" class="source_line" href="#L152">152</a>
<a id="L153" class="source_line" href="#L153">153</a>
<a id="L154" class="source_line" href="#L154">154</a>
<a id="L155" class="source_line" href="#L155">155</a>
<a id="L156" class="source_line" href="#L156">156</a>
<a id="L157" class="source_line" href="#L157">157</a>
<a id="L158" class="source_line" href="#L158">158</a>
<a id="L159" class="source_line" href="#L159">159</a>
<a id="L160" class="source_line" href="#L160">160</a>
<a id="L161" class="source_line" href="#L161">161</a>
<a id="L162" class="source_line" href="#L162">162</a>
<a id="L163" class="source_line" href="#L163">163</a>
<a id="L164" class="source_line" href="#L164">164</a>
<a id="L165" class="source_line" href="#L165">165</a>
<a id="L166" class="source_line" href="#L166">166</a>
<a id="L167" class="source_line" href="#L167">167</a>
<a id="L168" class="source_line" href="#L168">168</a>
<a id="L169" class="source_line" href="#L169">169</a>
<a id="L170" class="source_line" href="#L170">170</a>
<a id="L171" class="source_line" href="#L171">171</a>
<a id="L172" class="source_line" href="#L172">172</a>
<a id="L173" class="source_line" href="#L173">173</a>
<a id="L174" class="source_line" href="#L174">174</a>
<a id="L175" class="source_line" href="#L175">175</a>
<a id="L176" class="source_line" href="#L176">176</a>
<a id="L177" class="source_line" href="#L177">177</a>
<a id="L178" class="source_line" href="#L178">178</a>
<a id="L179" class="source_line" href="#L179">179</a>
<a id="L180" class="source_line" href="#L180">180</a>
<a id="L181" class="source_line" href="#L181">181</a>
<a id="L182" class="source_line" href="#L182">182</a>
<a id="L183" class="source_line" href="#L183">183</a>
<a id="L184" class="source_line" href="#L184">184</a>
<a id="L185" class="source_line" href="#L185">185</a>
<a id="L186" class="source_line" href="#L186">186</a>
<a id="L187" class="source_line" href="#L187">187</a>
<a id="L188" class="source_line" href="#L188">188</a>
<a id="L189" class="source_line" href="#L189">189</a>
<a id="L190" class="source_line" href="#L190">190</a>
<a id="L191" class="source_line" href="#L191">191</a>
<a id="L192" class="source_line" href="#L192">192</a>
<a id="L193" class="source_line" href="#L193">193</a>
<a id="L194" class="source_line" href="#L194">194</a>
<a id="L195" class="source_line" href="#L195">195</a>
<a id="L196" class="source_line" href="#L196">196</a>
<a id="L197" class="source_line" href="#L197">197</a>
<a id="L198" class="source_line" href="#L198">198</a>
<a id="L199" class="source_line" href="#L199">199</a>
<a id="L200" class="source_line" href="#L200">200</a>
<a id="L201" class="source_line" href="#L201">201</a>
<a id="L202" class="source_line" href="#L202">202</a>
<a id="L203" class="source_line" href="#L203">203</a>
<a id="L204" class="source_line" href="#L204">204</a>
<a id="L205" class="source_line" href="#L205">205</a>
<a id="L206" class="source_line" href="#L206">206</a>
<a id="L207" class="source_line" href="#L207">207</a>
<a id="L208" class="source_line" href="#L208">208</a>
<a id="L209" class="source_line" href="#L209">209</a>
<a id="L210" class="source_line" href="#L210">210</a>
<a id="L211" class="source_line" href="#L211">211</a>
<a id="L212" class="source_line" href="#L212">212</a>
<a id="L213" class="source_line" href="#L213">213</a>
<a id="L214" class="source_line" href="#L214">214</a>
<a id="L215" class="source_line" href="#L215">215</a>
<a id="L216" class="source_line" href="#L216">216</a>
<a id="L217" class="source_line" href="#L217">217</a>
<a id="L218" class="source_line" href="#L218">218</a>
<a id="L219" class="source_line" href="#L219">219</a>
<a id="L220" class="source_line" href="#L220">220</a>
<a id="L221" class="source_line" href="#L221">221</a>
<a id="L222" class="source_line" href="#L222">222</a>
<a id="L223" class="source_line" href="#L223">223</a>
<a id="L224" class="source_line" href="#L224">224</a>
<a id="L225" class="source_line" href="#L225">225</a>
<a id="L226" class="source_line" href="#L226">226</a>
<a id="L227" class="source_line" href="#L227">227</a>
<a id="L228" class="source_line" href="#L228">228</a>
<a id="L229" class="source_line" href="#L229">229</a>
<a id="L230" class="source_line" href="#L230">230</a>
<a id="L231" class="source_line" href="#L231">231</a>
<a id="L232" class="source_line" href="#L232">232</a>
<a id="L233" class="source_line" href="#L233">233</a>
<a id="L234" class="source_line" href="#L234">234</a>
<a id="L235" class="source_line" href="#L235">235</a>
<a id="L236" class="source_line" href="#L236">236</a>
<a id="L237" class="source_line" href="#L237">237</a>
<a id="L238" class="source_line" href="#L238">238</a>
<a id="L239" class="source_line" href="#L239">239</a>
<a id="L240" class="source_line" href="#L240">240</a>
<a id="L241" class="source_line" href="#L241">241</a>
<a id="L242" class="source_line" href="#L242">242</a>
<a id="L243" class="source_line" href="#L243">243</a>
<a id="L244" class="source_line" href="#L244">244</a>
<a id="L245" class="source_line" href="#L245">245</a>
<a id="L246" class="source_line" href="#L246">246</a>
<a id="L247" class="source_line" href="#L247">247</a>
<a id="L248" class="source_line" href="#L248">248</a>
<a id="L249" class="source_line" href="#L249">249</a>
<a id="L250" class="source_line" href="#L250">250</a>
<a id="L251" class="source_line" href="#L251">251</a>
<a id="L252" class="source_line" href="#L252">252</a>
<a id="L253" class="source_line" href="#L253">253</a>
<a id="L254" class="source_line" href="#L254">254</a>
<a id="L255" class="source_line" href="#L255">255</a>
<a id="L256" class="source_line" href="#L256">256</a>
<a id="L257" class="source_line" href="#L257">257</a>
<a id="L258" class="source_line" href="#L258">258</a>
<a id="L259" class="source_line" href="#L259">259</a>
<a id="L260" class="source_line" href="#L260">260</a>
<a id="L261" class="source_line" href="#L261">261</a>
<a id="L262" class="source_line" href="#L262">262</a>
<a id="L263" class="source_line" href="#L263">263</a>
<a id="L264" class="source_line" href="#L264">264</a>
<a id="L265" class="source_line" href="#L265">265</a>
<a id="L266" class="source_line" href="#L266">266</a>
<a id="L267" class="source_line" href="#L267">267</a>
<a id="L268" class="source_line" href="#L268">268</a>
<a id="L269" class="source_line" href="#L269">269</a>
<a id="L270" class="source_line" href="#L270">270</a>
<a id="L271" class="source_line" href="#L271">271</a>
<a id="L272" class="source_line" href="#L272">272</a>
<a id="L273" class="source_line" href="#L273">273</a>
<a id="L274" class="source_line" href="#L274">274</a>
<a id="L275" class="source_line" href="#L275">275</a>
<a id="L276" class="source_line" href="#L276">276</a>
<a id="L277" class="source_line" href="#L277">277</a>
<a id="L278" class="source_line" href="#L278">278</a>
<a id="L279" class="source_line" href="#L279">279</a>
<a id="L280" class="source_line" href="#L280">280</a>
<a id="L281" class="source_line" href="#L281">281</a>
<a id="L282" class="source_line" href="#L282">282</a>
<a id="L283" class="source_line" href="#L283">283</a>
<a id="L284" class="source_line" href="#L284">284</a>
<a id="L285" class="source_line" href="#L285">285</a>
<a id="L286" class="source_line" href="#L286">286</a>
<a id="L287" class="source_line" href="#L287">287</a>
<a id="L288" class="source_line" href="#L288">288</a>
<a id="L289" class="source_line" href="#L289">289</a>
<a id="L290" class="source_line" href="#L290">290</a>
<a id="L291" class="source_line" href="#L291">291</a>
<a id="L292" class="source_line" href="#L292">292</a>
<a id="L293" class="source_line" href="#L293">293</a>
<a id="L294" class="source_line" href="#L294">294</a>
<a id="L295" class="source_line" href="#L295">295</a>
<a id="L296" class="source_line" href="#L296">296</a>
<a id="L297" class="source_line" href="#L297">297</a>
<a id="L298" class="source_line" href="#L298">298</a>
<a id="L299" class="source_line" href="#L299">299</a>
<a id="L300" class="source_line" href="#L300">300</a>
<a id="L301" class="source_line" href="#L301">301</a>
<a id="L302" class="source_line" href="#L302">302</a>
<a id="L303" class="source_line" href="#L303">303</a>
<a id="L304" class="source_line" href="#L304">304</a>
<a id="L305" class="source_line" href="#L305">305</a>
<a id="L306" class="source_line" href="#L306">306</a>
<a id="L307" class="source_line" href="#L307">307</a>
<a id="L308" class="source_line" href="#L308">308</a>
<a id="L309" class="source_line" href="#L309">309</a>
<a id="L310" class="source_line" href="#L310">310</a>
<a id="L311" class="source_line" href="#L311">311</a>
<a id="L312" class="source_line" href="#L312">312</a>
<a id="L313" class="source_line" href="#L313">313</a>
<a id="L314" class="source_line" href="#L314">314</a>
<a id="L315" class="source_line" href="#L315">315</a>
<a id="L316" class="source_line" href="#L316">316</a>
<a id="L317" class="source_line" href="#L317">317</a>
<a id="L318" class="source_line" href="#L318">318</a>
<a id="L319" class="source_line" href="#L319">319</a>
<a id="L320" class="source_line" href="#L320">320</a>
<a id="L321" class="source_line" href="#L321">321</a>
<a id="L322" class="source_line" href="#L322">322</a>
<a id="L323" class="source_line" href="#L323">323</a>
<a id="L324" class="source_line" href="#L324">324</a>
<a id="L325" class="source_line" href="#L325">325</a>
<a id="L326" class="source_line" href="#L326">326</a>
<a id="L327" class="source_line" href="#L327">327</a>
<a id="L328" class="source_line" href="#L328">328</a>
<a id="L329" class="source_line" href="#L329">329</a>
<a id="L330" class="source_line" href="#L330">330</a>
<a id="L331" class="source_line" href="#L331">331</a>
<a id="L332" class="source_line" href="#L332">332</a>
</code><code class="source_code"><span><span class="EOL">
</span><span id="type-weight"><span class="TYPE">type</span> <span class="LIDENT">weight</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span id="type-weight.constructor-Normal"><span class="BAR">|</span> <span class="UIDENT">Normal</span> <span class="OF">of</span> <span class="LIDENT">int</span></span><span class="EOL">
</span>  <span id="type-weight.constructor-Obligatory"><span class="BAR">|</span> <span class="UIDENT">Obligatory</span> <span class="OF">of</span> <span class="LIDENT">int</span></span></span><span class="EOL">
</span><span class="EOL">
</span><span id="module-Fashwo"><span class="MODULE">module</span> <span class="UIDENT">Fashwo</span><span class="EOL">
</span> <span class="LPAREN">(</span><span class="UIDENT">GB</span> <span class="COLON">:</span> <span class="SIG">sig</span><span class="EOL">
</span>         <span class="INCLUDE">include</span> <a href="builder.ml.html#module-type-S"><span class="UIDENT">Builder</span><span class="DOT">.</span><span class="UIDENT">S</span></a><span class="EOL">
</span>         <span id="module-Fashwo.argument-1-GB.val-weight"><span class="VAL">val</span> <span class="LIDENT">weight</span> <span class="COLON">:</span> <span class="UIDENT">G</span><span class="DOT">.</span><span class="LIDENT">edge</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">weight</span></span><span class="EOL">
</span>       <span class="END">end</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EQUAL">=</span><span class="EOL">
</span><span class="STRUCT">struct</span><span class="EOL">
</span>  <span id="module-Fashwo.module-G"><span class="MODULE">module</span> <span class="UIDENT">G</span> <span class="EQUAL">=</span> <span class="UIDENT">GB</span><span class="DOT">.</span><span class="UIDENT">G</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Fashwo.exception-Stuck"><span class="EXCEPTION">exception</span> <span class="UIDENT">Stuck</span> <span class="OF">of</span> <span class="UIDENT">G</span><span class="DOT">.</span><span class="LIDENT">vertex</span> <span class="LIDENT">list</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Fashwo.module-IM"><span class="MODULE">module</span> <span class="UIDENT">IM</span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/map.ml.html#module-Make"><span class="UIDENT">Map</span><span class="DOT">.</span><span class="UIDENT">Make</span></a> <span class="LPAREN">(</span><span class="STRUCT">struct</span> <span id="def_168"><span class="TYPE">type</span> <span class="LIDENT">t</span> <span class="EQUAL">=</span> <span class="LIDENT">int</span></span> <span class="LET">let</span> <span id="local_compare_1"><span class="LIDENT">compare</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-compare"><span class="UIDENT">Stdlib</span><span class="DOT">.</span><span class="LIDENT">compare</span></a> <span class="END">end</span><span class="RPAREN">)</span></span><span class="EOL">
</span>  <span id="module-Fashwo.module-VM"><span class="MODULE">module</span> <span class="UIDENT">VM</span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/map.ml.html#module-Make"><span class="UIDENT">Map</span><span class="DOT">.</span><span class="UIDENT">Make</span></a> <span class="LPAREN">(</span><span class="UIDENT">G</span><span class="DOT">.</span><span class="UIDENT">V</span><span class="RPAREN">)</span></span><span class="EOL">
</span>  <span id="module-Fashwo.module-VS"><span class="MODULE">module</span> <span class="UIDENT">VS</span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/set.ml.html#module-Make"><span class="UIDENT">Set</span><span class="DOT">.</span><span class="UIDENT">Make</span></a> <span class="LPAREN">(</span><span class="UIDENT">G</span><span class="DOT">.</span><span class="UIDENT">V</span><span class="RPAREN">)</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* The algorithm of Eades, Lin, and Smyth (ELS 1993) works by &quot;scheduling&quot;
     vertexes onto two lists called s1 and s2. At each iteration a vertex is
     chosen, scheduled, and removed from the graph. Arcs from a newly scheduled
     node toward nodes already in s1 are classified as &quot;leftward&quot;; they are
     included in the generated feedback arc set. &quot;Rightward&quot; arcs, to vertexes
     in s2 or that have not yet been scheduled, are not included in the
     feedback arc set. The algorithm tries to maximize the number of rightward
     arcs and thereby minimize the number of leftward ones. Source vertexes,
     those with no incoming arcs in the current graph (i.e., because all its
     predecssors have already been scheduled), are appended directly onto s1
     and do not induce any feedback arcs. Sink vertexes are consed directly
     onto s2 and do not induce any feedback arcs. Otherwise, the algorithm
     chooses a vertex to maximize the difference between the number of
     outgoing arcs and the number of incoming ones: the (remaining) incoming
     arcs must be included in the feedback arc set. The difference between the
     number of rightward arcs (no cost) and the number of leftward arcs
     (feedback arcs) is called &quot;delta&quot;. The algorithm is implemented
     efficiently by using a data structure to group unscheduled vertexes
     according to their delta value. When more than one vertex has the maximum
     delta value, the original algorithm makes an arbitrary choice. The
     algorithm of Eades and Lin (EL 1995) makes the choice using a heuristic
     that maximizes the difference between incoming arcs and outgoing ones in
     the vertexes that remain at the end of the iteration as such vertexes are
     the most &quot;unbalanced&quot; and thus less likely to contribute to the feedback
     arc set in future iterations. The EL 1995 algorithm includes a further
     refinement to ignore chains of vertexes when looking for unbalanced ones,
     since such chains do not contribute feedback arcs.

     Since we just want to produce a list of feedback arcs, we don't bother
     tracking order in s1, and we only track s2 to properly handle the
     preprocessing optimization that removes two cycles. We maintain lists of
     source and sink vertexes (scheduled but not yet removed from the graph)
     and a map from delta values to sets of vertexes. As the delta value map
     caches the state of the graph, it must be updated when the a vertex is
     scheduled and removed from the graph. Additionally, we remember which two
     cycles were removed during preprocessing and ensure that one of their
     arcs is included in the feedback arc set, depending on whichever of the
     two interlinked vertexes is scheduled first. *)</span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Fashwo.type-t"><span class="TYPE">type</span> <span class="LIDENT">t</span> <span class="EQUAL">=</span> <span class="LBRACE">{</span><span class="EOL">
</span>    <span id="def_172"><span class="LIDENT">s1</span>         <span class="COLON">:</span> <span class="UIDENT">VS</span><span class="DOT">.</span><span class="LIDENT">t</span><span class="SEMI">;</span></span>             <span class="COMMENT">(* vertexes placed &quot;at left&quot; *)</span><span class="EOL">
</span>    <span id="def_164"><span class="LIDENT">s2</span>         <span class="COLON">:</span> <span class="UIDENT">VS</span><span class="DOT">.</span><span class="LIDENT">t</span><span class="SEMI">;</span></span>             <span class="COMMENT">(* vertexes placed &quot;at right&quot;;
                                      only needed to optimize for two_cycles *)</span><span class="EOL">
</span>    <span id="def_178"><span class="LIDENT">sources</span>    <span class="COLON">:</span> <span class="UIDENT">VS</span><span class="DOT">.</span><span class="LIDENT">t</span><span class="SEMI">;</span></span>             <span class="COMMENT">(* vertexes with no incoming arcs *)</span><span class="EOL">
</span>    <span id="def_177"><span class="LIDENT">sinks</span>      <span class="COLON">:</span> <span class="UIDENT">VS</span><span class="DOT">.</span><span class="LIDENT">t</span><span class="SEMI">;</span></span>             <span class="COMMENT">(* vertexes with no outgoing arcs *)</span><span class="EOL">
</span>    <span id="def_163"><span class="LIDENT">delta_bins</span> <span class="COLON">:</span> <span class="UIDENT">VS</span><span class="DOT">.</span><span class="LIDENT">t</span> <span class="UIDENT">IM</span><span class="DOT">.</span><span class="LIDENT">t</span><span class="SEMI">;</span></span>        <span class="COMMENT">(* group vertexes by delta value *)</span><span class="EOL">
</span>    <span id="def_166"><span class="LIDENT">vertex_bin</span> <span class="COLON">:</span> <span class="LIDENT">int</span> <span class="UIDENT">VM</span><span class="DOT">.</span><span class="LIDENT">t</span><span class="SEMI">;</span></span>         <span class="COMMENT">(* map each vertex to its bin *)</span><span class="EOL">
</span>    <span id="def_179"><span class="LIDENT">two_cycles</span> <span class="COLON">:</span> <span class="UIDENT">G</span><span class="DOT">.</span><span class="LIDENT">edge</span> <span class="LIDENT">list</span> <span class="UIDENT">VM</span><span class="DOT">.</span><span class="LIDENT">t</span><span class="SEMI">;</span></span> <span class="COMMENT">(* edges for 2-cycles *)</span><span class="EOL">
</span>    <span id="def_180"><span class="LIDENT">fas</span>        <span class="COLON">:</span> <span class="UIDENT">G</span><span class="DOT">.</span><span class="LIDENT">edge</span> <span class="LIDENT">list</span><span class="SEMI">;</span></span>      <span class="COMMENT">(* current feedback arc set *)</span><span class="EOL">
</span>  <span class="RBRACE">}</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Fashwo.val-empty"><span class="LIDENT">empty</span></span> <span class="EQUAL">=</span> <span class="LBRACE">{</span><span class="EOL">
</span>      <span class="LIDENT">s1</span> <span class="EQUAL">=</span> <span class="UIDENT">VS</span><span class="DOT">.</span><span class="LIDENT">empty</span><span class="SEMI">;</span><span class="EOL">
</span>      <span class="LIDENT">s2</span> <span class="EQUAL">=</span> <span class="UIDENT">VS</span><span class="DOT">.</span><span class="LIDENT">empty</span><span class="SEMI">;</span><span class="EOL">
</span>      <span class="LIDENT">sources</span> <span class="EQUAL">=</span> <span class="UIDENT">VS</span><span class="DOT">.</span><span class="LIDENT">empty</span><span class="SEMI">;</span><span class="EOL">
</span>      <span class="LIDENT">sinks</span> <span class="EQUAL">=</span> <span class="UIDENT">VS</span><span class="DOT">.</span><span class="LIDENT">empty</span><span class="SEMI">;</span><span class="EOL">
</span>      <span class="LIDENT">delta_bins</span> <span class="EQUAL">=</span> <span class="UIDENT">IM</span><span class="DOT">.</span><span class="LIDENT">empty</span><span class="SEMI">;</span><span class="EOL">
</span>      <span class="LIDENT">vertex_bin</span> <span class="EQUAL">=</span> <span class="UIDENT">VM</span><span class="DOT">.</span><span class="LIDENT">empty</span><span class="SEMI">;</span><span class="EOL">
</span>      <span class="LIDENT">two_cycles</span> <span class="EQUAL">=</span> <span class="UIDENT">VM</span><span class="DOT">.</span><span class="LIDENT">empty</span><span class="SEMI">;</span><span class="EOL">
</span>      <span class="LIDENT">fas</span> <span class="EQUAL">=</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="RBRACE">}</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Fashwo.val-add_to_bin"><span class="LIDENT">add_to_bin</span></span> <span id="local_delta_2"><span class="LIDENT">delta</span></span> <span id="local_v_3"><span class="LIDENT">v</span></span> <span class="LPAREN">(</span><span class="LBRACE">{</span> <span id="local_delta_bins_5"><span class="LIDENT">delta_bins</span></span><span class="SEMI">;</span> <span id="local_vertex_bin_6"><span class="LIDENT">vertex_bin</span></span><span class="SEMI">;</span> <span class="UNDERSCORE">_</span> <span class="RBRACE">}</span> <span class="AS">as</span> <span id="local_st_4"><span class="LIDENT">st</span></span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LBRACE">{</span> <a href="#local_st_4"><span class="LIDENT">st</span></a> <span class="WITH">with</span> <span class="LIDENT">delta_bins</span> <span class="EQUAL">=</span><span class="EOL">
</span>                <span class="UIDENT">IM</span><span class="DOT">.</span><span class="LIDENT">update</span> <a href="#local_delta_2"><span class="LIDENT">delta</span></a> <span class="LPAREN">(</span><span class="FUNCTION">function</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Some</span> <span class="LPAREN">(</span><span class="UIDENT">VS</span><span class="DOT">.</span><span class="LIDENT">singleton</span> <a href="#local_v_3"><span class="LIDENT">v</span></a><span class="RPAREN">)</span><span class="EOL">
</span>                                        <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_vs_7"><span class="LIDENT">vs</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Some</span> <span class="LPAREN">(</span><span class="UIDENT">VS</span><span class="DOT">.</span><span class="LIDENT">add</span> <a href="#local_v_3"><span class="LIDENT">v</span></a> <a href="#local_vs_7"><span class="LIDENT">vs</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>                  <a href="#local_delta_bins_5"><span class="LIDENT">delta_bins</span></a><span class="SEMI">;</span><span class="EOL">
</span>                <span class="LIDENT">vertex_bin</span> <span class="EQUAL">=</span> <span class="UIDENT">VM</span><span class="DOT">.</span><span class="LIDENT">add</span> <a href="#local_v_3"><span class="LIDENT">v</span></a> <a href="#local_delta_2"><span class="LIDENT">delta</span></a> <a href="#local_vertex_bin_6"><span class="LIDENT">vertex_bin</span></a> <span class="RBRACE">}</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Fashwo.val-remove_from_bin"><span class="LIDENT">remove_from_bin</span></span> <span id="local_v_8"><span class="LIDENT">v</span></span> <span class="LPAREN">(</span><span class="LBRACE">{</span> <span id="local_delta_bins_10"><span class="LIDENT">delta_bins</span></span><span class="SEMI">;</span> <span id="local_vertex_bin_11"><span class="LIDENT">vertex_bin</span></span><span class="SEMI">;</span> <span class="UNDERSCORE">_</span> <span class="RBRACE">}</span> <span class="AS">as</span> <span id="local_st_9"><span class="LIDENT">st</span></span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="MATCH">match</span> <span class="UIDENT">VM</span><span class="DOT">.</span><span class="LIDENT">find_opt</span> <a href="#local_v_8"><span class="LIDENT">v</span></a> <a href="#local_vertex_bin_11"><span class="LIDENT">vertex_bin</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_st_9"><span class="LIDENT">st</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_delta_12"><span class="LIDENT">delta</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LBRACE">{</span> <a href="#local_st_9"><span class="LIDENT">st</span></a> <span class="WITH">with</span> <span class="LIDENT">delta_bins</span> <span class="EQUAL">=</span><span class="EOL">
</span>                    <span class="UIDENT">IM</span><span class="DOT">.</span><span class="LIDENT">update</span> <a href="#local_delta_12"><span class="LIDENT">delta</span></a> <span class="LPAREN">(</span><span class="FUNCTION">function</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">None</span><span class="EOL">
</span>                                            <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_vs_13"><span class="LIDENT">vs</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Some</span> <span class="LPAREN">(</span><span class="UIDENT">VS</span><span class="DOT">.</span><span class="LIDENT">remove</span> <a href="#local_v_8"><span class="LIDENT">v</span></a> <a href="#local_vs_13"><span class="LIDENT">vs</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>                      <a href="#local_delta_bins_10"><span class="LIDENT">delta_bins</span></a><span class="SEMI">;</span><span class="EOL">
</span>                  <span class="LIDENT">vertex_bin</span> <span class="EQUAL">=</span> <span class="UIDENT">VM</span><span class="DOT">.</span><span class="LIDENT">remove</span> <a href="#local_v_8"><span class="LIDENT">v</span></a> <a href="#local_vertex_bin_11"><span class="LIDENT">vertex_bin</span></a> <span class="RBRACE">}</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Calculate the sums of incoming and outgoing edge weights, ignoring
     obligatory arcs; they must be respected so their weight is irrelevant. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Fashwo.val-weights"><span class="LIDENT">weights</span></span> <span id="local_g_14"><span class="LIDENT">g</span></span> <span id="local_v_15"><span class="LIDENT">v</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_add_pweight_16"><span class="LIDENT">add_pweight</span></span> <span id="local_e_17"><span class="LIDENT">e</span></span> <span class="LPAREN">(</span><span id="local_s_18"><span class="LIDENT">s</span></span><span class="COMMA">,</span> <span id="local_b_19"><span class="LIDENT">b</span></span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="MATCH">match</span> <span class="UIDENT">GB</span><span class="DOT">.</span><span class="LIDENT">weight</span> <a href="#local_e_17"><span class="LIDENT">e</span></a> <span class="WITH">with</span> <span class="UIDENT">Obligatory</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><a href="#local_s_18"><span class="LIDENT">s</span></a><span class="COMMA">,</span> <span class="TRUE">true</span><span class="RPAREN">)</span> <span class="BAR">|</span> <span class="UIDENT">Normal</span> <span id="local_w_20"><span class="LIDENT">w</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><a href="#local_s_18"><span class="LIDENT">s</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <a href="#local_w_20"><span class="LIDENT">w</span></a><span class="COMMA">,</span> <a href="#local_b_19"><span class="LIDENT">b</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_add_sweight_21"><span class="LIDENT">add_sweight</span></span> <span id="local_e_22"><span class="LIDENT">e</span></span> <span id="local_s_23"><span class="LIDENT">s</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="MATCH">match</span> <span class="UIDENT">GB</span><span class="DOT">.</span><span class="LIDENT">weight</span> <a href="#local_e_22"><span class="LIDENT">e</span></a> <span class="WITH">with</span> <span class="UIDENT">Obligatory</span> <span id="local_w_24"><span class="LIDENT">w</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_s_23"><span class="LIDENT">s</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <a href="#local_w_24"><span class="LIDENT">w</span></a> <span class="BAR">|</span> <span class="UIDENT">Normal</span> <span id="local_w_25"><span class="LIDENT">w</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_s_23"><span class="LIDENT">s</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <a href="#local_w_25"><span class="LIDENT">w</span></a><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="def_167"><span id="local_inw_26"><span class="LIDENT">inw</span></span><span class="COMMA">,</span> <span id="local_blocked_27"><span class="LIDENT">blocked</span></span></span> <span class="EQUAL">=</span> <span class="UIDENT">G</span><span class="DOT">.</span><span class="LIDENT">fold_pred_e</span> <a href="#local_add_pweight_16"><span class="LIDENT">add_pweight</span></a> <a href="#local_g_14"><span class="LIDENT">g</span></a> <a href="#local_v_15"><span class="LIDENT">v</span></a> <span class="LPAREN">(</span><span class="INT">0</span><span class="COMMA">,</span> <span class="FALSE">false</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_outw_28"><span class="LIDENT">outw</span></span> <span class="EQUAL">=</span> <span class="UIDENT">G</span><span class="DOT">.</span><span class="LIDENT">fold_succ_e</span> <a href="#local_add_sweight_21"><span class="LIDENT">add_sweight</span></a> <a href="#local_g_14"><span class="LIDENT">g</span></a> <a href="#local_v_15"><span class="LIDENT">v</span></a> <span class="INT">0</span> <span class="IN">in</span><span class="EOL">
</span>    <a href="#local_blocked_27"><span class="LIDENT">blocked</span></a><span class="COMMA">,</span> <a href="#local_inw_26"><span class="LIDENT">inw</span></a><span class="COMMA">,</span> <a href="#local_outw_28"><span class="LIDENT">outw</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Fashwo.val-add_vertex"><span class="LIDENT">add_vertex</span></span> <span id="local_g_29"><span class="LIDENT">g</span></span> <span id="local_v_30"><span class="LIDENT">v</span></span> <span id="local_delta_31"><span class="LIDENT">delta</span></span> <span class="LPAREN">(</span><span class="LBRACE">{</span> <span id="local_sources_33"><span class="LIDENT">sources</span></span><span class="SEMI">;</span> <span id="local_sinks_34"><span class="LIDENT">sinks</span></span><span class="SEMI">;</span> <span class="UNDERSCORE">_</span> <span class="RBRACE">}</span> <span class="AS">as</span> <span id="local_st_32"><span class="LIDENT">st</span></span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="def_169"><span id="local_ind_35"><span class="LIDENT">ind</span></span><span class="COMMA">,</span> <span id="local_outd_36"><span class="LIDENT">outd</span></span></span> <span class="EQUAL">=</span> <span class="UIDENT">G</span><span class="DOT">.</span><span class="LIDENT">in_degree</span> <a href="#local_g_29"><span class="LIDENT">g</span></a> <a href="#local_v_30"><span class="LIDENT">v</span></a><span class="COMMA">,</span> <span class="UIDENT">G</span><span class="DOT">.</span><span class="LIDENT">out_degree</span> <a href="#local_g_29"><span class="LIDENT">g</span></a> <a href="#local_v_30"><span class="LIDENT">v</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_ind_35"><span class="LIDENT">ind</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="INT">0</span> <span class="THEN">then</span> <span class="LBRACE">{</span> <a href="#local_st_32"><span class="LIDENT">st</span></a> <span class="WITH">with</span> <span class="LIDENT">sources</span> <span class="EQUAL">=</span> <span class="UIDENT">VS</span><span class="DOT">.</span><span class="LIDENT">add</span> <a href="#local_v_30"><span class="LIDENT">v</span></a> <a href="#local_sources_33"><span class="LIDENT">sources</span></a> <span class="RBRACE">}</span><span class="EOL">
</span>    <span class="ELSE">else</span> <span class="IF">if</span> <a href="#local_outd_36"><span class="LIDENT">outd</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="INT">0</span> <span class="THEN">then</span> <span class="LBRACE">{</span> <a href="#local_st_32"><span class="LIDENT">st</span></a> <span class="WITH">with</span> <span class="LIDENT">sinks</span> <span class="EQUAL">=</span> <span class="UIDENT">VS</span><span class="DOT">.</span><span class="LIDENT">add</span> <a href="#local_v_30"><span class="LIDENT">v</span></a> <a href="#local_sinks_34"><span class="LIDENT">sinks</span></a> <span class="RBRACE">}</span><span class="EOL">
</span>    <span class="ELSE">else</span> <span class="LIDENT">add_to_bin</span> <a href="#local_delta_31"><span class="LIDENT">delta</span></a> <a href="#local_v_30"><span class="LIDENT">v</span></a> <a href="#local_st_32"><span class="LIDENT">st</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Initialize the state for a given vertex. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Fashwo.val-init_vertex"><span class="LIDENT">init_vertex</span></span> <span id="local_g_37"><span class="LIDENT">g</span></span> <span id="local_v_38"><span class="LIDENT">v</span></span> <span id="local_st_39"><span class="LIDENT">st</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="def_165"><span id="local_blocked_40"><span class="LIDENT">blocked</span></span><span class="COMMA">,</span> <span id="local_inw_41"><span class="LIDENT">inw</span></span><span class="COMMA">,</span> <span id="local_outw_42"><span class="LIDENT">outw</span></span></span> <span class="EQUAL">=</span> <span class="LIDENT">weights</span> <a href="#local_g_37"><span class="LIDENT">g</span></a> <a href="#local_v_38"><span class="LIDENT">v</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_blocked_40"><span class="LIDENT">blocked</span></a> <span class="THEN">then</span> <a href="#local_st_39"><span class="LIDENT">st</span></a> <span class="ELSE">else</span> <span class="LIDENT">add_vertex</span> <a href="#local_g_37"><span class="LIDENT">g</span></a> <a href="#local_v_38"><span class="LIDENT">v</span></a> <span class="LPAREN">(</span><a href="#local_outw_42"><span class="LIDENT">outw</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <a href="#local_inw_41"><span class="LIDENT">inw</span></a><span class="RPAREN">)</span> <a href="#local_st_39"><span class="LIDENT">st</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Fashwo.val-init"><span class="LIDENT">init</span></span> <span id="local_g_43"><span class="LIDENT">g</span></span> <span class="EQUAL">=</span> <span class="UIDENT">G</span><span class="DOT">.</span><span class="LIDENT">fold_vertex</span> <span class="LPAREN">(</span><span class="LIDENT">init_vertex</span> <a href="#local_g_43"><span class="LIDENT">g</span></a><span class="RPAREN">)</span> <a href="#local_g_43"><span class="LIDENT">g</span></a> <span class="LIDENT">empty</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Move v from the bin for delta to sources, sinks, or another bin. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Fashwo.val-shift_bins"><span class="LIDENT">shift_bins</span></span> <span id="local_g_44"><span class="LIDENT">g</span></span> <span id="local_v_45"><span class="LIDENT">v</span></span> <span id="local_delta'_46"><span class="LIDENT">delta'</span></span> <span id="local_st0_47"><span class="LIDENT">st0</span></span> <span class="EQUAL">=</span> <span class="LIDENT">add_vertex</span> <a href="#local_g_44"><span class="LIDENT">g</span></a> <a href="#local_v_45"><span class="LIDENT">v</span></a> <a href="#local_delta'_46"><span class="LIDENT">delta'</span></a> <span class="LPAREN">(</span><span class="LIDENT">remove_from_bin</span> <a href="#local_v_45"><span class="LIDENT">v</span></a> <a href="#local_st0_47"><span class="LIDENT">st0</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Before removing v from the graph, update the state of its sucessors. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Fashwo.val-update_removed_succ"><span class="LIDENT">update_removed_succ</span></span> <span id="local_g'_48"><span class="LIDENT">g'</span></span> <span id="local_e_49"><span class="LIDENT">e</span></span> <span id="local_st_50"><span class="LIDENT">st</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_v_51"><span class="LIDENT">v</span></span> <span class="EQUAL">=</span> <span class="UIDENT">G</span><span class="DOT">.</span><span class="UIDENT">E</span><span class="DOT">.</span><span class="LIDENT">dst</span> <a href="#local_e_49"><span class="LIDENT">e</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="def_173"><span id="local_still_blocked_52"><span class="LIDENT">still_blocked</span></span><span class="COMMA">,</span> <span id="local_inw'_53"><span class="LIDENT">inw'</span></span><span class="COMMA">,</span> <span id="local_outw'_54"><span class="LIDENT">outw'</span></span></span> <span class="EQUAL">=</span> <span class="LIDENT">weights</span> <a href="#local_g'_48"><span class="LIDENT">g'</span></a> <a href="#local_v_51"><span class="LIDENT">v</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_still_blocked_52"><span class="LIDENT">still_blocked</span></a> <span class="THEN">then</span> <a href="#local_st_50"><span class="LIDENT">st</span></a> <span class="ELSE">else</span> <span class="LIDENT">shift_bins</span> <a href="#local_g'_48"><span class="LIDENT">g'</span></a> <a href="#local_v_51"><span class="LIDENT">v</span></a> <span class="LPAREN">(</span><a href="#local_outw'_54"><span class="LIDENT">outw'</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <a href="#local_inw'_53"><span class="LIDENT">inw'</span></a><span class="RPAREN">)</span> <a href="#local_st_50"><span class="LIDENT">st</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Before removing v from the graph, update the state of its predecessors. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Fashwo.val-update_removed_pred"><span class="LIDENT">update_removed_pred</span></span> <span id="local_g'_55"><span class="LIDENT">g'</span></span> <span id="local_e_56"><span class="LIDENT">e</span></span> <span class="LPAREN">(</span><span class="LBRACE">{</span> <span id="local_sinks_58"><span class="LIDENT">sinks</span></span><span class="SEMI">;</span> <span class="UNDERSCORE">_</span> <span class="RBRACE">}</span> <span class="AS">as</span> <span id="local_st_57"><span class="LIDENT">st</span></span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_v_59"><span class="LIDENT">v</span></span> <span class="EQUAL">=</span> <span class="UIDENT">G</span><span class="DOT">.</span><span class="UIDENT">E</span><span class="DOT">.</span><span class="LIDENT">src</span> <a href="#local_e_56"><span class="LIDENT">e</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="def_162"><span id="local_blocked_60"><span class="LIDENT">blocked</span></span><span class="COMMA">,</span> <span id="local_inw'_61"><span class="LIDENT">inw'</span></span><span class="COMMA">,</span> <span id="local_outw'_62"><span class="LIDENT">outw'</span></span></span> <span class="EQUAL">=</span> <span class="LIDENT">weights</span> <a href="#local_g'_55"><span class="LIDENT">g'</span></a> <a href="#local_v_59"><span class="LIDENT">v</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="MATCH">match</span> <span class="UIDENT">GB</span><span class="DOT">.</span><span class="LIDENT">weight</span> <a href="#local_e_56"><span class="LIDENT">e</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Obligatory</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="IF">if</span> <a href="#local_blocked_60"><span class="LIDENT">blocked</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(||)"><span class="BARBAR">||</span></a> <a href="#local_outw'_62"><span class="LIDENT">outw'</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <span class="INT">0</span> <span class="THEN">then</span> <a href="#local_st_57"><span class="LIDENT">st</span></a><span class="EOL">
</span>        <span class="ELSE">else</span> <span class="COMMENT">(* not blocked &amp;&amp; outw' = 0 *)</span><span class="EOL">
</span>        <span class="LBRACE">{</span> <span class="LPAREN">(</span><span class="LIDENT">remove_from_bin</span> <a href="#local_v_59"><span class="LIDENT">v</span></a> <a href="#local_st_57"><span class="LIDENT">st</span></a><span class="RPAREN">)</span> <span class="WITH">with</span> <span class="LIDENT">sinks</span> <span class="EQUAL">=</span> <span class="UIDENT">VS</span><span class="DOT">.</span><span class="LIDENT">add</span> <a href="#local_v_59"><span class="LIDENT">v</span></a> <a href="#local_sinks_58"><span class="LIDENT">sinks</span></a> <span class="RBRACE">}</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Normal</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="IF">if</span> <a href="#local_blocked_60"><span class="LIDENT">blocked</span></a> <span class="THEN">then</span> <a href="#local_st_57"><span class="LIDENT">st</span></a> <span class="ELSE">else</span> <span class="LIDENT">shift_bins</span> <a href="#local_g'_55"><span class="LIDENT">g'</span></a> <a href="#local_v_59"><span class="LIDENT">v</span></a> <span class="LPAREN">(</span><a href="#local_outw'_62"><span class="LIDENT">outw'</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <a href="#local_inw'_61"><span class="LIDENT">inw'</span></a><span class="RPAREN">)</span> <a href="#local_st_57"><span class="LIDENT">st</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Remove a vertex from the graph and update the data structures for its
     succesors and predecessors. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Fashwo.val-remove_vertex"><span class="LIDENT">remove_vertex</span></span> <span id="local_g_63"><span class="LIDENT">g</span></span> <span id="local_v_64"><span class="LIDENT">v</span></span> <span id="local_st_65"><span class="LIDENT">st</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_g'_66"><span class="LIDENT">g'</span></span> <span class="EQUAL">=</span> <span class="UIDENT">GB</span><span class="DOT">.</span><span class="LIDENT">remove_vertex</span> <a href="#local_g_63"><span class="LIDENT">g</span></a> <a href="#local_v_64"><span class="LIDENT">v</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LPAREN">(</span><a href="#local_g'_66"><span class="LIDENT">g'</span></a><span class="COMMA">,</span> <span class="UIDENT">G</span><span class="DOT">.</span><span class="LIDENT">fold_succ_e</span> <span class="LPAREN">(</span><span class="LIDENT">update_removed_succ</span> <a href="#local_g'_66"><span class="LIDENT">g'</span></a><span class="RPAREN">)</span> <a href="#local_g_63"><span class="LIDENT">g</span></a> <a href="#local_v_64"><span class="LIDENT">v</span></a> <a href="#local_st_65"><span class="LIDENT">st</span></a><span class="EOL">
</span>         <span class="INFIXOP0">|&gt;</span> <span class="UIDENT">G</span><span class="DOT">.</span><span class="LIDENT">fold_pred_e</span> <span class="LPAREN">(</span><span class="LIDENT">update_removed_pred</span> <a href="#local_g'_66"><span class="LIDENT">g'</span></a><span class="RPAREN">)</span> <a href="#local_g_63"><span class="LIDENT">g</span></a> <a href="#local_v_64"><span class="LIDENT">v</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* The original article proposes preprocessing the graph to condense long
     chains of vertexes. This works together with the heuristic for generating
     unbalanced vertexes, since the intermediate nodes on the chain do not
     contribute any leftward arcs (when the last vertex is removed, they
     become a sequence of sinks). Using such a preprocessing step with
     weighted edges risks removing good feedback arcs, i.e., those with a big
     difference between outgoing and incoming weights. That is why here we
     use on-the-fly condensation, even if there is a risk of recomputing the
     same result several times. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="REC">rec</span> <span id="module-Fashwo.val-condense"><span class="LIDENT">condense</span></span> <span id="local_w_67"><span class="LIDENT">w</span></span> <span id="local_g_68"><span class="LIDENT">g</span></span> <span id="local_v_69"><span class="LIDENT">v</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="IF">if</span> <span class="UIDENT">G</span><span class="DOT">.</span><span class="LIDENT">out_degree</span> <a href="#local_g_68"><span class="LIDENT">g</span></a> <a href="#local_v_69"><span class="LIDENT">v</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="INT">1</span> <span class="THEN">then</span><span class="EOL">
</span>      <span class="MATCH">match</span> <span class="UIDENT">G</span><span class="DOT">.</span><span class="LIDENT">pred</span> <a href="#local_g_68"><span class="LIDENT">g</span></a> <a href="#local_v_69"><span class="LIDENT">v</span></a> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="LBRACKET">[</span><span id="local_u_70"><span class="LIDENT">u</span></span><span class="RBRACKET">]</span> <span class="WHEN">when</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-not"><span class="LIDENT">not</span></a> <span class="LPAREN">(</span><span class="UIDENT">G</span><span class="DOT">.</span><span class="UIDENT">V</span><span class="DOT">.</span><span class="LIDENT">equal</span> <a href="#local_u_70"><span class="LIDENT">u</span></a> <a href="#local_w_67"><span class="LIDENT">w</span></a><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">condense</span> <a href="#local_w_67"><span class="LIDENT">w</span></a> <a href="#local_g_68"><span class="LIDENT">g</span></a> <a href="#local_u_70"><span class="LIDENT">u</span></a><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_v_69"><span class="LIDENT">v</span></a><span class="EOL">
</span>    <span class="ELSE">else</span> <a href="#local_v_69"><span class="LIDENT">v</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Find the vertex v that has the most &quot;unbalanced&quot; predecessor u. Most
     unbalanced means the biggest difference between the input weights and
     output weights. Skip any vertex with an incoming obligatory arc. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Fashwo.val-takemax"><span class="LIDENT">takemax</span></span> <span id="local_g_71"><span class="LIDENT">g</span></span> <span id="local_v_72"><span class="LIDENT">v</span></span> <span id="local_imax_73"><span class="LIDENT">imax</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_check_edge_74"><span class="LIDENT">check_edge</span></span> <span id="local_e_75"><span class="LIDENT">e</span></span> <span id="local_max_76"><span class="LIDENT">max</span></span> <span class="EQUAL">=</span> <span class="COMMENT">(* check u -&gt; v *)</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="def_176"><span id="local_u_blocked_77"><span class="LIDENT">u_blocked</span></span><span class="COMMA">,</span> <span id="local_u_inw_78"><span class="LIDENT">u_inw</span></span><span class="COMMA">,</span> <span id="local_u_outw_79"><span class="LIDENT">u_outw</span></span></span> <span class="EQUAL">=</span><span class="EOL">
</span>        <span class="LIDENT">weights</span> <a href="#local_g_71"><span class="LIDENT">g</span></a> <span class="LPAREN">(</span><span class="LIDENT">condense</span> <span class="LPAREN">(</span><span class="UIDENT">G</span><span class="DOT">.</span><span class="UIDENT">E</span><span class="DOT">.</span><span class="LIDENT">dst</span> <a href="#local_e_75"><span class="LIDENT">e</span></a><span class="RPAREN">)</span> <a href="#local_g_71"><span class="LIDENT">g</span></a> <span class="LPAREN">(</span><span class="UIDENT">G</span><span class="DOT">.</span><span class="UIDENT">E</span><span class="DOT">.</span><span class="LIDENT">src</span> <a href="#local_e_75"><span class="LIDENT">e</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_u_w_80"><span class="LIDENT">u_w</span></span> <span class="EQUAL">=</span> <a href="#local_u_inw_78"><span class="LIDENT">u_inw</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <a href="#local_u_outw_79"><span class="LIDENT">u_outw</span></a> <span class="IN">in</span><span class="EOL">
</span>      <span class="MATCH">match</span> <a href="#local_max_76"><span class="LIDENT">max</span></a> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Some</span> <span class="LPAREN">(</span><span class="UIDENT">None</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Some</span> <span class="LPAREN">(</span><span class="LPAREN">(</span><span class="IF">if</span> <a href="#local_u_blocked_77"><span class="LIDENT">u_blocked</span></a> <span class="THEN">then</span> <span class="UIDENT">None</span> <span class="ELSE">else</span> <span class="UIDENT">Some</span> <a href="#local_u_w_80"><span class="LIDENT">u_w</span></a><span class="RPAREN">)</span><span class="COMMA">,</span> <a href="#local_v_72"><span class="LIDENT">v</span></a><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Some</span> <span class="LPAREN">(</span><span class="UIDENT">Some</span> <span id="local_x_w_81"><span class="LIDENT">x_w</span></span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span><span class="RPAREN">)</span> <span class="WHEN">when</span> <a href="#local_u_w_80"><span class="LIDENT">u_w</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <a href="#local_x_w_81"><span class="LIDENT">x_w</span></a> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Some</span> <span class="LPAREN">(</span><span class="UIDENT">Some</span> <a href="#local_u_w_80"><span class="LIDENT">u_w</span></a><span class="COMMA">,</span> <a href="#local_v_72"><span class="LIDENT">v</span></a><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_max_76"><span class="LIDENT">max</span></a><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span>    <span class="UIDENT">G</span><span class="DOT">.</span><span class="LIDENT">fold_pred_e</span> <a href="#local_check_edge_74"><span class="LIDENT">check_edge</span></a> <a href="#local_g_71"><span class="LIDENT">g</span></a> <a href="#local_v_72"><span class="LIDENT">v</span></a> <a href="#local_imax_73"><span class="LIDENT">imax</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Look for the vertex with the highest delta value that is not the target
     of an obligatory arc. Use the &quot;unbalanced&quot; heuristic impllemented in
     [takemax] to discriminate between competing possibilities. If a vertex
     is found, remove it from the returned delta bins. *)</span><span class="EOL">
</span><span class="COMMENT">(*
  let max_from_deltas g ({ delta_bins; _ } as st) =
    let rec f = function
      | Seq.Nil -&gt; None
      | Seq.Cons ((_, dbin), tl) -&gt;
          (match VS.fold (takemax g) dbin None with
           | None -&gt; f (tl ())
           | Some (_, v) -&gt; Some (v, remove_from_bin v st))
    in
    f (IM.to_rev_seq delta_bins ())
*)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Fashwo.val-max_from_deltas"><span class="LIDENT">max_from_deltas</span></span> <span id="local_g_82"><span class="LIDENT">g</span></span> <span class="LPAREN">(</span><span class="LBRACE">{</span> <span id="local_delta_bins_84"><span class="LIDENT">delta_bins</span></span><span class="SEMI">;</span> <span class="UNDERSCORE">_</span> <span class="RBRACE">}</span> <span class="AS">as</span> <span id="local_st_83"><span class="LIDENT">st</span></span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="REC">rec</span> <span id="local_f_85"><span class="LIDENT">f</span></span> <span id="local_im_86"><span class="LIDENT">im</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="IF">if</span> <span class="UIDENT">IM</span><span class="DOT">.</span><span class="LIDENT">is_empty</span> <a href="#local_im_86"><span class="LIDENT">im</span></a> <span class="THEN">then</span><span class="EOL">
</span>        <span class="UIDENT">None</span><span class="EOL">
</span>      <span class="ELSE">else</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="def_175"><span id="local_k_87"><span class="LIDENT">k</span></span><span class="COMMA">,</span> <span id="local_dbin_88"><span class="LIDENT">dbin</span></span></span> <span class="EQUAL">=</span> <span class="UIDENT">IM</span><span class="DOT">.</span><span class="LIDENT">max_binding</span> <a href="#local_im_86"><span class="LIDENT">im</span></a> <span class="IN">in</span><span class="EOL">
</span>        <span class="LPAREN">(</span><span class="MATCH">match</span> <span class="UIDENT">VS</span><span class="DOT">.</span><span class="LIDENT">fold</span> <span class="LPAREN">(</span><span class="LIDENT">takemax</span> <a href="#local_g_82"><span class="LIDENT">g</span></a><span class="RPAREN">)</span> <a href="#local_dbin_88"><span class="LIDENT">dbin</span></a> <span class="UIDENT">None</span> <span class="WITH">with</span><span class="EOL">
</span>           <span class="BAR">|</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_f_85"><span class="LIDENT">f</span></a> <span class="LPAREN">(</span><span class="UIDENT">IM</span><span class="DOT">.</span><span class="LIDENT">remove</span> <a href="#local_k_87"><span class="LIDENT">k</span></a> <a href="#local_im_86"><span class="LIDENT">im</span></a><span class="RPAREN">)</span><span class="EOL">
</span>           <span class="BAR">|</span> <span class="UIDENT">Some</span> <span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span id="local_v_89"><span class="LIDENT">v</span></span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Some</span> <span class="LPAREN">(</span><a href="#local_v_89"><span class="LIDENT">v</span></a><span class="COMMA">,</span> <span class="LIDENT">remove_from_bin</span> <a href="#local_v_89"><span class="LIDENT">v</span></a> <a href="#local_st_83"><span class="LIDENT">st</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span>    <a href="#local_f_85"><span class="LIDENT">f</span></a> <a href="#local_delta_bins_84"><span class="LIDENT">delta_bins</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Include any leftward arcs due to the two-cycles that were removed by
     preprocessing. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Fashwo.val-add_from_two_cycles"><span class="LIDENT">add_from_two_cycles</span></span> <span id="local_s1_90"><span class="LIDENT">s1</span></span> <span id="local_s2_91"><span class="LIDENT">s2</span></span> <span id="local_two_cycles_92"><span class="LIDENT">two_cycles</span></span> <span id="local_v_93"><span class="LIDENT">v</span></span> <span id="local_fas_94"><span class="LIDENT">fas</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_bf_95"><span class="LIDENT">bf</span></span> <span id="local_es_96"><span class="LIDENT">es</span></span> <span id="local_b_97"><span class="LIDENT">b</span></span> <span class="EQUAL">=</span> <span class="IF">if</span> <span class="UIDENT">G</span><span class="DOT">.</span><span class="UIDENT">V</span><span class="DOT">.</span><span class="LIDENT">equal</span> <span class="LPAREN">(</span><span class="UIDENT">G</span><span class="DOT">.</span><span class="UIDENT">E</span><span class="DOT">.</span><span class="LIDENT">dst</span> <a href="#local_b_97"><span class="LIDENT">b</span></a><span class="RPAREN">)</span> <a href="#local_v_93"><span class="LIDENT">v</span></a> <span class="THEN">then</span> <a href="#local_b_97"><span class="LIDENT">b</span></a><span class="COLONCOLON">::</span><a href="#local_es_96"><span class="LIDENT">es</span></a> <span class="ELSE">else</span> <a href="#local_es_96"><span class="LIDENT">es</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_f_98"><span class="LIDENT">f</span></span> <span id="local_es_99"><span class="LIDENT">es</span></span> <span id="local_e_100"><span class="LIDENT">e</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_w_101"><span class="LIDENT">w</span></span> <span class="EQUAL">=</span> <span class="UIDENT">G</span><span class="DOT">.</span><span class="UIDENT">E</span><span class="DOT">.</span><span class="LIDENT">dst</span> <a href="#local_e_100"><span class="LIDENT">e</span></a> <span class="IN">in</span><span class="EOL">
</span>      <span class="IF">if</span> <span class="UIDENT">VS</span><span class="DOT">.</span><span class="LIDENT">mem</span> <a href="#local_w_101"><span class="LIDENT">w</span></a> <a href="#local_s1_90"><span class="LIDENT">s1</span></a> <span class="THEN">then</span> <a href="#local_e_100"><span class="LIDENT">e</span></a><span class="COLONCOLON">::</span><a href="#local_es_99"><span class="LIDENT">es</span></a><span class="EOL">
</span>      <span class="ELSE">else</span> <span class="IF">if</span> <span class="UIDENT">VS</span><span class="DOT">.</span><span class="LIDENT">mem</span> <a href="#local_w_101"><span class="LIDENT">w</span></a> <a href="#local_s2_91"><span class="LIDENT">s2</span></a> <span class="THEN">then</span><span class="EOL">
</span>        <span class="COMMENT">(* the two-cycle partner has already been scheduled as sink, so
           the feedback edges come from it. *)</span><span class="EOL">
</span>        <span class="MATCH">match</span> <span class="UIDENT">VM</span><span class="DOT">.</span><span class="LIDENT">find_opt</span> <a href="#local_w_101"><span class="LIDENT">w</span></a> <a href="#local_two_cycles_92"><span class="LIDENT">two_cycles</span></a> <span class="WITH">with</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_es_99"><span class="LIDENT">es</span></a><span class="EOL">
</span>        <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_bs_102"><span class="LIDENT">bs</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-fold_left"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">fold_left</span></a> <a href="#local_bf_95"><span class="LIDENT">bf</span></a> <a href="#local_es_99"><span class="LIDENT">es</span></a> <a href="#local_bs_102"><span class="LIDENT">bs</span></a><span class="EOL">
</span>      <span class="ELSE">else</span> <a href="#local_es_99"><span class="LIDENT">es</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="MATCH">match</span> <span class="UIDENT">VM</span><span class="DOT">.</span><span class="LIDENT">find_opt</span> <a href="#local_v_93"><span class="LIDENT">v</span></a> <a href="#local_two_cycles_92"><span class="LIDENT">two_cycles</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_fas_94"><span class="LIDENT">fas</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_es_103"><span class="LIDENT">es</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-fold_left"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">fold_left</span></a> <a href="#local_f_98"><span class="LIDENT">f</span></a> <a href="#local_fas_94"><span class="LIDENT">fas</span></a> <a href="#local_es_103"><span class="LIDENT">es</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Shift a given vertex onto s1, and add any leftward arcs to the feedback
     arc set. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Fashwo.val-schedule_vertex"><span class="LIDENT">schedule_vertex</span></span> <span id="local_g_104"><span class="LIDENT">g</span></span> <span class="LPAREN">(</span><span id="local_v_105"><span class="LIDENT">v</span></span><span class="COMMA">,</span> <span class="LPAREN">(</span><span class="LBRACE">{</span> <span id="local_s1_107"><span class="LIDENT">s1</span></span><span class="SEMI">;</span> <span id="local_s2_108"><span class="LIDENT">s2</span></span><span class="SEMI">;</span> <span id="local_fas_110"><span class="LIDENT">fas</span></span><span class="SEMI">;</span> <span id="local_two_cycles_109"><span class="LIDENT">two_cycles</span></span><span class="SEMI">;</span> <span class="UNDERSCORE">_</span> <span class="RBRACE">}</span> <span class="AS">as</span> <span id="local_st_106"><span class="LIDENT">st</span></span><span class="RPAREN">)</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_add_to_fas_111"><span class="LIDENT">add_to_fas</span></span> <span id="local_e_112"><span class="LIDENT">e</span></span> <span id="local_es_113"><span class="LIDENT">es</span></span> <span class="EQUAL">=</span> <span class="IF">if</span> <span class="UIDENT">VS</span><span class="DOT">.</span><span class="LIDENT">mem</span> <span class="LPAREN">(</span><span class="UIDENT">G</span><span class="DOT">.</span><span class="UIDENT">E</span><span class="DOT">.</span><span class="LIDENT">src</span> <a href="#local_e_112"><span class="LIDENT">e</span></a><span class="RPAREN">)</span> <a href="#local_s1_107"><span class="LIDENT">s1</span></a> <span class="THEN">then</span> <a href="#local_es_113"><span class="LIDENT">es</span></a> <span class="ELSE">else</span> <a href="#local_e_112"><span class="LIDENT">e</span></a><span class="COLONCOLON">::</span><a href="#local_es_113"><span class="LIDENT">es</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LPAREN">(</span><a href="#local_v_105"><span class="LIDENT">v</span></a><span class="COMMA">,</span> <span class="LBRACE">{</span> <a href="#local_st_106"><span class="LIDENT">st</span></a> <span class="WITH">with</span> <span class="LIDENT">s1</span> <span class="EQUAL">=</span> <span class="UIDENT">VS</span><span class="DOT">.</span><span class="LIDENT">add</span> <a href="#local_v_105"><span class="LIDENT">v</span></a> <a href="#local_s1_107"><span class="LIDENT">s1</span></a><span class="SEMI">;</span><span class="EOL">
</span>                  <span class="LIDENT">fas</span> <span class="EQUAL">=</span> <span class="UIDENT">G</span><span class="DOT">.</span><span class="LIDENT">fold_pred_e</span> <a href="#local_add_to_fas_111"><span class="LIDENT">add_to_fas</span></a> <a href="#local_g_104"><span class="LIDENT">g</span></a> <a href="#local_v_105"><span class="LIDENT">v</span></a> <a href="#local_fas_110"><span class="LIDENT">fas</span></a><span class="EOL">
</span>                          <span class="INFIXOP0">|&gt;</span> <span class="LIDENT">add_from_two_cycles</span> <a href="#local_s1_107"><span class="LIDENT">s1</span></a> <a href="#local_s2_108"><span class="LIDENT">s2</span></a> <a href="#local_two_cycles_109"><span class="LIDENT">two_cycles</span></a> <a href="#local_v_105"><span class="LIDENT">v</span></a> <span class="RBRACE">}</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Take the next available vertex from, in order, sources, sinks, or the
     highset possible delta bin. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Fashwo.val-choose_vertex"><span class="LIDENT">choose_vertex</span></span> <span id="local_g_114"><span class="LIDENT">g</span></span> <span class="LPAREN">(</span><span class="LBRACE">{</span> <span id="local_s1_116"><span class="LIDENT">s1</span></span><span class="SEMI">;</span> <span id="local_s2_117"><span class="LIDENT">s2</span></span><span class="SEMI">;</span> <span id="local_sources_118"><span class="LIDENT">sources</span></span><span class="SEMI">;</span> <span id="local_sinks_119"><span class="LIDENT">sinks</span></span><span class="SEMI">;</span> <span id="local_two_cycles_120"><span class="LIDENT">two_cycles</span></span><span class="SEMI">;</span> <span id="local_fas_121"><span class="LIDENT">fas</span></span><span class="SEMI">;</span> <span class="UNDERSCORE">_</span> <span class="RBRACE">}</span> <span class="AS">as</span> <span id="local_st0_115"><span class="LIDENT">st0</span></span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="MATCH">match</span> <span class="UIDENT">VS</span><span class="DOT">.</span><span class="LIDENT">choose_opt</span> <a href="#local_sources_118"><span class="LIDENT">sources</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_v_122"><span class="LIDENT">v</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="UIDENT">Some</span> <span class="LPAREN">(</span><a href="#local_v_122"><span class="LIDENT">v</span></a><span class="COMMA">,</span> <span class="LBRACE">{</span> <a href="#local_st0_115"><span class="LIDENT">st0</span></a> <span class="WITH">with</span> <span class="LIDENT">sources</span> <span class="EQUAL">=</span> <span class="UIDENT">VS</span><span class="DOT">.</span><span class="LIDENT">remove</span> <a href="#local_v_122"><span class="LIDENT">v</span></a> <a href="#local_sources_118"><span class="LIDENT">sources</span></a><span class="SEMI">;</span><span class="EOL">
</span>                            <span class="LIDENT">sinks</span> <span class="EQUAL">=</span> <span class="UIDENT">VS</span><span class="DOT">.</span><span class="LIDENT">remove</span> <a href="#local_v_122"><span class="LIDENT">v</span></a> <a href="#local_sinks_119"><span class="LIDENT">sinks</span></a><span class="SEMI">;</span><span class="EOL">
</span>                            <span class="LIDENT">s1</span> <span class="EQUAL">=</span> <span class="UIDENT">VS</span><span class="DOT">.</span><span class="LIDENT">add</span> <a href="#local_v_122"><span class="LIDENT">v</span></a> <a href="#local_s1_116"><span class="LIDENT">s1</span></a><span class="SEMI">;</span><span class="EOL">
</span>                            <span class="LIDENT">fas</span> <span class="EQUAL">=</span> <span class="LIDENT">add_from_two_cycles</span> <a href="#local_s1_116"><span class="LIDENT">s1</span></a> <a href="#local_s2_117"><span class="LIDENT">s2</span></a> <a href="#local_two_cycles_120"><span class="LIDENT">two_cycles</span></a> <a href="#local_v_122"><span class="LIDENT">v</span></a> <a href="#local_fas_121"><span class="LIDENT">fas</span></a> <span class="RBRACE">}</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LPAREN">(</span><span class="MATCH">match</span> <span class="UIDENT">VS</span><span class="DOT">.</span><span class="LIDENT">choose_opt</span> <a href="#local_sinks_119"><span class="LIDENT">sinks</span></a> <span class="WITH">with</span><span class="EOL">
</span>         <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_v_123"><span class="LIDENT">v</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>             <span class="UIDENT">Some</span> <span class="LPAREN">(</span><a href="#local_v_123"><span class="LIDENT">v</span></a><span class="COMMA">,</span> <span class="LBRACE">{</span> <a href="#local_st0_115"><span class="LIDENT">st0</span></a> <span class="WITH">with</span> <span class="LIDENT">sinks</span> <span class="EQUAL">=</span> <span class="UIDENT">VS</span><span class="DOT">.</span><span class="LIDENT">remove</span> <a href="#local_v_123"><span class="LIDENT">v</span></a> <a href="#local_sinks_119"><span class="LIDENT">sinks</span></a><span class="SEMI">;</span><span class="EOL">
</span>                                 <span class="LIDENT">s2</span> <span class="EQUAL">=</span> <span class="UIDENT">VS</span><span class="DOT">.</span><span class="LIDENT">add</span> <a href="#local_v_123"><span class="LIDENT">v</span></a> <a href="#local_s2_117"><span class="LIDENT">s2</span></a><span class="SEMI">;</span><span class="EOL">
</span>                                 <span class="LIDENT">fas</span> <span class="EQUAL">=</span> <span class="LIDENT">add_from_two_cycles</span> <a href="#local_s1_116"><span class="LIDENT">s1</span></a> <a href="#local_s2_117"><span class="LIDENT">s2</span></a> <a href="#local_two_cycles_120"><span class="LIDENT">two_cycles</span></a> <a href="#local_v_123"><span class="LIDENT">v</span></a> <a href="#local_fas_121"><span class="LIDENT">fas</span></a> <span class="RBRACE">}</span><span class="RPAREN">)</span><span class="EOL">
</span>         <span class="BAR">|</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/option.ml.html#val-map"><span class="UIDENT">Option</span><span class="DOT">.</span><span class="LIDENT">map</span></a> <span class="LPAREN">(</span><span class="LIDENT">schedule_vertex</span> <a href="#local_g_114"><span class="LIDENT">g</span></a><span class="RPAREN">)</span> <span class="LPAREN">(</span><span class="LIDENT">max_from_deltas</span> <a href="#local_g_114"><span class="LIDENT">g</span></a> <a href="#local_st0_115"><span class="LIDENT">st0</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Fashwo.val-add_two_cycle_edge"><span class="LIDENT">add_two_cycle_edge</span></span> <span id="local_two_cycles_124"><span class="LIDENT">two_cycles</span></span> <span id="local_e_125"><span class="LIDENT">e</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="UIDENT">VM</span><span class="DOT">.</span><span class="LIDENT">update</span> <span class="LPAREN">(</span><span class="UIDENT">G</span><span class="DOT">.</span><span class="UIDENT">E</span><span class="DOT">.</span><span class="LIDENT">src</span> <a href="#local_e_125"><span class="LIDENT">e</span></a><span class="RPAREN">)</span> <span class="LPAREN">(</span><span class="FUNCTION">function</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Some</span> <span class="LBRACKET">[</span><a href="#local_e_125"><span class="LIDENT">e</span></a><span class="RBRACKET">]</span><span class="EOL">
</span>                                  <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_es_126"><span class="LIDENT">es</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Some</span> <span class="LPAREN">(</span><a href="#local_e_125"><span class="LIDENT">e</span></a> <span class="COLONCOLON">::</span> <a href="#local_es_126"><span class="LIDENT">es</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span> <a href="#local_two_cycles_124"><span class="LIDENT">two_cycles</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Fashwo.val-same_weight"><span class="LIDENT">same_weight</span></span> <span id="local_w_127"><span class="LIDENT">w</span></span> <span id="local_e_128"><span class="LIDENT">e</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="MATCH">match</span> <span class="UIDENT">GB</span><span class="DOT">.</span><span class="LIDENT">weight</span> <a href="#local_e_128"><span class="LIDENT">e</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Obligatory</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="FALSE">false</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Normal</span> <span id="local_w'_129"><span class="LIDENT">w'</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_w'_129"><span class="LIDENT">w'</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <a href="#local_w_127"><span class="LIDENT">w</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* For every pair of distinct vertexes A and B linked to each other by
     edges A -ab-&gt; B and B -ba-&gt; A with the same weight, update the mapping
     by linking A to ab, and B to ba, and remove the edges from the graph.
     When A is scheduled, if B is already in s1 then the edge ab is a
     feedback arc, and similarly for B and ba. The principle is that there
     will be a feedback arc regardless of whether A is &quot;scheduled&quot; before B or
     vice versa, therefore such cycles should not constrain vertex choices. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Fashwo.val-remove_two_cycles"><span class="LIDENT">remove_two_cycles</span></span> <span id="local_g0_130"><span class="LIDENT">g0</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_f_131"><span class="LIDENT">f</span></span> <span id="local_e_132"><span class="LIDENT">e</span></span> <span class="LPAREN">(</span><span class="LPAREN">(</span><span id="local_g_134"><span class="LIDENT">g</span></span><span class="COMMA">,</span> <span id="local_cycles_135"><span class="LIDENT">cycles</span></span><span class="RPAREN">)</span> <span class="AS">as</span> <span id="local_unchanged_133"><span class="LIDENT">unchanged</span></span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="MATCH">match</span> <span class="UIDENT">GB</span><span class="DOT">.</span><span class="LIDENT">weight</span> <a href="#local_e_132"><span class="LIDENT">e</span></a> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Obligatory</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_unchanged_133"><span class="LIDENT">unchanged</span></a><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Normal</span> <span id="local_w_136"><span class="LIDENT">w</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-length"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">length</span></a> <span class="LPAREN">(</span><span class="UIDENT">G</span><span class="DOT">.</span><span class="LIDENT">find_all_edges</span> <a href="#local_g0_130"><span class="LIDENT">g0</span></a> <span class="LPAREN">(</span><span class="UIDENT">G</span><span class="DOT">.</span><span class="UIDENT">E</span><span class="DOT">.</span><span class="LIDENT">src</span> <a href="#local_e_132"><span class="LIDENT">e</span></a><span class="RPAREN">)</span> <span class="LPAREN">(</span><span class="UIDENT">G</span><span class="DOT">.</span><span class="UIDENT">E</span><span class="DOT">.</span><span class="LIDENT">dst</span> <a href="#local_e_132"><span class="LIDENT">e</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <span class="INT">1</span><span class="EOL">
</span>          <span class="COMMENT">(* invalid for graphs like: { A -1-&gt; B, A -2-&gt; B, B -3-&gt; A *)</span><span class="EOL">
</span>          <span class="THEN">then</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-raise"><span class="LIDENT">raise</span></a> <span class="UIDENT">Exit</span><span class="EOL">
</span>          <span class="ELSE">else</span><span class="EOL">
</span>            <span class="LET">let</span> <span id="local_back_edges_137"><span class="LIDENT">back_edges</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>              <span class="UIDENT">G</span><span class="DOT">.</span><span class="LIDENT">find_all_edges</span> <a href="#local_g0_130"><span class="LIDENT">g0</span></a> <span class="LPAREN">(</span><span class="UIDENT">G</span><span class="DOT">.</span><span class="UIDENT">E</span><span class="DOT">.</span><span class="LIDENT">dst</span> <a href="#local_e_132"><span class="LIDENT">e</span></a><span class="RPAREN">)</span> <span class="LPAREN">(</span><span class="UIDENT">G</span><span class="DOT">.</span><span class="UIDENT">E</span><span class="DOT">.</span><span class="LIDENT">src</span> <a href="#local_e_132"><span class="LIDENT">e</span></a><span class="RPAREN">)</span><span class="EOL">
</span>              <span class="INFIXOP0">|&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-filter"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">filter</span></a> <span class="LPAREN">(</span><span class="LIDENT">same_weight</span> <a href="#local_w_136"><span class="LIDENT">w</span></a><span class="RPAREN">)</span><span class="EOL">
</span>            <span class="IN">in</span><span class="EOL">
</span>            <span class="IF">if</span> <a href="#local_back_edges_137"><span class="LIDENT">back_edges</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="THEN">then</span> <a href="#local_unchanged_133"><span class="LIDENT">unchanged</span></a><span class="EOL">
</span>            <span class="ELSE">else</span> <span class="LPAREN">(</span><span class="UIDENT">GB</span><span class="DOT">.</span><span class="LIDENT">remove_edge_e</span> <a href="#local_g_134"><span class="LIDENT">g</span></a> <a href="#local_e_132"><span class="LIDENT">e</span></a><span class="COMMA">,</span><span class="EOL">
</span>                  <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-fold_left"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">fold_left</span></a> <span class="LIDENT">add_two_cycle_edge</span> <a href="#local_cycles_135"><span class="LIDENT">cycles</span></a> <a href="#local_back_edges_137"><span class="LIDENT">back_edges</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span>    <span class="TRY">try</span><span class="EOL">
</span>      <span class="UIDENT">G</span><span class="DOT">.</span><span class="LIDENT">fold_edges_e</span> <a href="#local_f_131"><span class="LIDENT">f</span></a> <a href="#local_g0_130"><span class="LIDENT">g0</span></a> <span class="LPAREN">(</span><a href="#local_g0_130"><span class="LIDENT">g0</span></a><span class="COMMA">,</span> <span class="UIDENT">VM</span><span class="DOT">.</span><span class="LIDENT">empty</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="WITH">with</span> <span class="UIDENT">Exit</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><a href="#local_g0_130"><span class="LIDENT">g0</span></a><span class="COMMA">,</span> <span class="UIDENT">VM</span><span class="DOT">.</span><span class="LIDENT">empty</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* All self loops must be broken, so just add them straight into the
     feedback arc set. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Fashwo.val-remove_self_loops"><span class="LIDENT">remove_self_loops</span></span> <span id="local_g0_138"><span class="LIDENT">g0</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_f_139"><span class="LIDENT">f</span></span> <span id="local_v_140"><span class="LIDENT">v</span></span> <span class="LPAREN">(</span><span id="local_g_141"><span class="LIDENT">g</span></span><span class="COMMA">,</span> <span id="local_fas_142"><span class="LIDENT">fas</span></span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_self_loops_143"><span class="LIDENT">self_loops</span></span> <span class="EQUAL">=</span> <span class="UIDENT">G</span><span class="DOT">.</span><span class="LIDENT">find_all_edges</span> <a href="#local_g0_138"><span class="LIDENT">g0</span></a> <a href="#local_v_140"><span class="LIDENT">v</span></a> <a href="#local_v_140"><span class="LIDENT">v</span></a> <span class="IN">in</span><span class="EOL">
</span>      <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-fold_left"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">fold_left</span></a> <span class="UIDENT">GB</span><span class="DOT">.</span><span class="LIDENT">remove_edge_e</span> <a href="#local_g_141"><span class="LIDENT">g</span></a> <a href="#local_self_loops_143"><span class="LIDENT">self_loops</span></a><span class="COMMA">,</span><span class="EOL">
</span>       <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-rev_append"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">rev_append</span></a> <a href="#local_self_loops_143"><span class="LIDENT">self_loops</span></a> <a href="#local_fas_142"><span class="LIDENT">fas</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span>    <span class="UIDENT">G</span><span class="DOT">.</span><span class="LIDENT">fold_vertex</span> <a href="#local_f_139"><span class="LIDENT">f</span></a> <a href="#local_g0_138"><span class="LIDENT">g0</span></a> <span class="LPAREN">(</span><a href="#local_g0_138"><span class="LIDENT">g0</span></a><span class="COMMA">,</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="COMMENT">(* Remove any arcs between strongly connected components. There can be no
     cycles between distinct sccs by definition. *)</span><span class="EOL">
</span>  <span id="module-Fashwo.module-C"><span class="MODULE">module</span> <span class="UIDENT">C</span> <span class="EQUAL">=</span> <a href="components.ml.html#module-Make"><span class="UIDENT">Components</span><span class="DOT">.</span><span class="UIDENT">Make</span></a><span class="LPAREN">(</span><span class="UIDENT">G</span><span class="RPAREN">)</span></span><span class="EOL">
</span>  <span id="module-Fashwo.module-Emap"><span class="MODULE">module</span> <span class="UIDENT">Emap</span> <span class="EQUAL">=</span> <a href="gmap.ml.html#module-Edge"><span class="UIDENT">Gmap</span><span class="DOT">.</span><span class="UIDENT">Edge</span></a><span class="LPAREN">(</span><span class="UIDENT">G</span><span class="RPAREN">)</span><span class="LPAREN">(</span><span class="STRUCT">struct</span> <span class="INCLUDE">include</span> <span class="UIDENT">GB</span><span class="DOT">.</span><span class="UIDENT">G</span> <span class="INCLUDE">include</span> <span class="UIDENT">GB</span> <span class="END">end</span><span class="RPAREN">)</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Fashwo.val-disconnect_sccs"><span class="LIDENT">disconnect_sccs</span></span> <span id="local_g_144"><span class="LIDENT">g</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="def_170"><span id="local_nsccs_145"><span class="LIDENT">nsccs</span></span><span class="COMMA">,</span> <span id="local_fscc_146"><span class="LIDENT">fscc</span></span></span> <span class="EQUAL">=</span> <span class="UIDENT">C</span><span class="DOT">.</span><span class="LIDENT">scc</span> <a href="#local_g_144"><span class="LIDENT">g</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_in_same_scc_147"><span class="LIDENT">in_same_scc</span></span> <span id="local_e_148"><span class="LIDENT">e</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="IF">if</span> <a href="#local_fscc_146"><span class="LIDENT">fscc</span></a> <span class="LPAREN">(</span><span class="UIDENT">G</span><span class="DOT">.</span><span class="UIDENT">E</span><span class="DOT">.</span><span class="LIDENT">src</span> <a href="#local_e_148"><span class="LIDENT">e</span></a><span class="RPAREN">)</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <a href="#local_fscc_146"><span class="LIDENT">fscc</span></a> <span class="LPAREN">(</span><span class="UIDENT">G</span><span class="DOT">.</span><span class="UIDENT">E</span><span class="DOT">.</span><span class="LIDENT">dst</span> <a href="#local_e_148"><span class="LIDENT">e</span></a><span class="RPAREN">)</span> <span class="THEN">then</span> <span class="UIDENT">Some</span> <a href="#local_e_148"><span class="LIDENT">e</span></a> <span class="ELSE">else</span> <span class="UIDENT">None</span><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_nsccs_145"><span class="LIDENT">nsccs</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;)"><span class="LESS">&lt;</span></a> <span class="INT">2</span> <span class="THEN">then</span> <a href="#local_g_144"><span class="LIDENT">g</span></a><span class="EOL">
</span>    <span class="ELSE">else</span> <span class="UIDENT">Emap</span><span class="DOT">.</span><span class="LIDENT">filter_map</span> <a href="#local_in_same_scc_147"><span class="LIDENT">in_same_scc</span></a> <a href="#local_g_144"><span class="LIDENT">g</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Fashwo.val-feedback_arc_set"><span class="LIDENT">feedback_arc_set</span></span> <span id="local_g0_149"><span class="LIDENT">g0</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span class="REC">rec</span> <span id="local_loop_150"><span class="LIDENT">loop</span></span> <span class="LPAREN">(</span><span id="local_g_151"><span class="LIDENT">g</span></span><span class="COMMA">,</span> <span id="local_st_152"><span class="LIDENT">st</span></span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="MATCH">match</span> <span class="LIDENT">choose_vertex</span> <a href="#local_g_151"><span class="LIDENT">g</span></a> <a href="#local_st_152"><span class="LIDENT">st</span></a> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Some</span> <span class="LPAREN">(</span><span id="local_v_153"><span class="LIDENT">v</span></span><span class="COMMA">,</span> <span id="local_st'_154"><span class="LIDENT">st'</span></span><span class="RPAREN">)</span> <span class="WHEN">when</span> <span class="UIDENT">G</span><span class="DOT">.</span><span class="LIDENT">mem_vertex</span> <a href="#local_g_151"><span class="LIDENT">g</span></a> <a href="#local_v_153"><span class="LIDENT">v</span></a> <span class="MINUSGREATER">-&gt;</span> <a href="#local_loop_150"><span class="LIDENT">loop</span></a> <span class="LPAREN">(</span><span class="LIDENT">remove_vertex</span> <a href="#local_g_151"><span class="LIDENT">g</span></a> <a href="#local_v_153"><span class="LIDENT">v</span></a> <a href="#local_st'_154"><span class="LIDENT">st'</span></a><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Some</span> <span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span id="local_st'_155"><span class="LIDENT">st'</span></span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_loop_150"><span class="LIDENT">loop</span></a> <span class="LPAREN">(</span><a href="#local_g_151"><span class="LIDENT">g</span></a><span class="COMMA">,</span> <a href="#local_st'_155"><span class="LIDENT">st'</span></a><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_remaining_156"><span class="LIDENT">remaining</span></span> <span class="EQUAL">=</span> <span class="UIDENT">IM</span><span class="DOT">.</span><span class="LIDENT">fold</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/fun.ml.html#val-const"><span class="UIDENT">Fun</span><span class="DOT">.</span><span class="LIDENT">const</span></a> <span class="UIDENT">VS</span><span class="DOT">.</span><span class="LIDENT">union</span><span class="RPAREN">)</span> <a href="#local_st_152"><span class="LIDENT">st</span></a><span class="DOT">.</span><span class="LIDENT">delta_bins</span> <span class="UIDENT">VS</span><span class="DOT">.</span><span class="LIDENT">empty</span> <span class="IN">in</span><span class="EOL">
</span>          <span class="IF">if</span> <span class="UIDENT">VS</span><span class="DOT">.</span><span class="LIDENT">is_empty</span> <a href="#local_remaining_156"><span class="LIDENT">remaining</span></a> <span class="THEN">then</span> <a href="#local_st_152"><span class="LIDENT">st</span></a><span class="DOT">.</span><span class="LIDENT">fas</span><span class="EOL">
</span>          <span class="ELSE">else</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-raise"><span class="LIDENT">raise</span></a> <span class="LPAREN">(</span><span class="UIDENT">Stuck</span> <span class="LPAREN">(</span><span class="UIDENT">VS</span><span class="DOT">.</span><span class="LIDENT">elements</span> <a href="#local_remaining_156"><span class="LIDENT">remaining</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_g1_157"><span class="LIDENT">g1</span></span> <span class="EQUAL">=</span> <span class="LIDENT">disconnect_sccs</span> <a href="#local_g0_149"><span class="LIDENT">g0</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="def_171"><span id="local_g2_158"><span class="LIDENT">g2</span></span><span class="COMMA">,</span> <span id="local_fas_159"><span class="LIDENT">fas</span></span></span> <span class="EQUAL">=</span> <span class="LIDENT">remove_self_loops</span> <a href="#local_g1_157"><span class="LIDENT">g1</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="def_174"><span id="local_g3_160"><span class="LIDENT">g3</span></span><span class="COMMA">,</span> <span id="local_two_cycles_161"><span class="LIDENT">two_cycles</span></span></span> <span class="EQUAL">=</span> <span class="LIDENT">remove_two_cycles</span> <a href="#local_g2_158"><span class="LIDENT">g2</span></a> <span class="IN">in</span><span class="EOL">
</span>    <a href="#local_loop_150"><span class="LIDENT">loop</span></a> <span class="LPAREN">(</span><a href="#local_g3_160"><span class="LIDENT">g3</span></a><span class="COMMA">,</span> <span class="LBRACE">{</span> <span class="LPAREN">(</span><span class="LIDENT">init</span> <a href="#local_g3_160"><span class="LIDENT">g3</span></a><span class="RPAREN">)</span> <span class="WITH">with</span> <a href="#local_fas_159"><span class="LIDENT">fas</span></a><span class="SEMI">;</span> <a href="#local_two_cycles_161"><span class="LIDENT">two_cycles</span></a> <span class="RBRACE">}</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="END">end</span></span><span class="EOL">
</span><span class="EOL">
</span></span></code></pre></body></html>
