<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Source: fiber.ml (eio.src.eio.core)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.css"/><meta name="generator" content="odoc %%VERSION%%"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/></head><body class="odoc-src"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">eio</a> &#x00BB; <a href="../index.html">Sources</a> &#x00BB; eio.core &#x00BB; fiber.ml</nav><header class="odoc-preamble"><h1>Source file <code><span>fiber.ml</span></code></h1></header><div class="odoc-tocs"><nav class="odoc-toc odoc-global-toc"><ul><li><a href="../../index.html">eio</a><ul><li>Library <code>eio</code><ul><li><a href="../../eio/Eio/index.html">Eio</a></li></ul></li><li>Library <code>eio.core</code></li><li>Library <code>eio.mock</code><ul><li><a href="../../eio.mock/Eio_mock/index.html">Eio_mock</a></li></ul></li><li>Library <code>eio.runtime_events</code><ul><li><a href="../../eio.runtime_events/Eio_runtime_events/index.html">Eio_runtime_events</a></li></ul></li><li>Library <code>eio.unix</code><ul><li><a href="../../eio.unix/Eio_unix/index.html">Eio_unix</a></li></ul></li><li>Library <code>eio.utils</code><ul><li><a href="../../eio.utils/Eio_utils/index.html">Eio_utils</a></li></ul></li><li><a href="../index.html">Sources</a><ul><li>eio<ul><li><a href="../eio/buf_read.ml.html">buf_read.ml</a></li><li><a href="../eio/buf_write.ml.html">buf_write.ml</a></li><li><a href="../eio/condition.ml.html">condition.ml</a></li><li><a href="../eio/domain_manager.ml.html">domain_manager.ml</a></li><li><a href="../eio/eio.ml.html">eio.ml</a></li><li><a href="../eio/eio__.ml.html">eio__.ml</a></li><li><a href="../eio/eio_mutex.ml.html">eio_mutex.ml</a></li><li><a href="../eio/executor_pool.ml.html">executor_pool.ml</a></li><li><a href="../eio/file.ml.html">file.ml</a></li><li><a href="../eio/flow.ml.html">flow.ml</a></li><li><a href="../eio/fs.ml.html">fs.ml</a></li><li><a href="../eio/hook.ml.html">hook.ml</a></li><li><a href="../eio/lazy.ml.html">lazy.ml</a></li><li><a href="../eio/net.ml.html">net.ml</a></li><li><a href="../eio/path.ml.html">path.ml</a></li><li><a href="../eio/pool.ml.html">pool.ml</a></li><li><a href="../eio/process.ml.html">process.ml</a></li><li><a href="../eio/resource.ml.html">resource.ml</a></li><li><a href="../eio/sem_state.ml.html">sem_state.ml</a></li><li><a href="../eio/semaphore.ml.html">semaphore.ml</a></li><li><a href="../eio/std.ml.html">std.ml</a></li><li><a href="../eio/stream.ml.html">stream.ml</a></li><li><a href="../eio/sync.ml.html">sync.ml</a></li><li><a href="../eio/time.ml.html">time.ml</a></li><li><a href="../eio/waiters.ml.html">waiters.ml</a></li></ul></li><li>eio.core<ul><li><a href="broadcast.ml.html">broadcast.ml</a></li><li><a href="cancel.ml.html">cancel.ml</a></li><li><a href="cells.ml.html">cells.ml</a></li><li><a href="debug.ml.html">debug.ml</a></li><li><a href="dla.ml.html">dla.ml</a></li><li><a href="eio__core.ml.html">eio__core.ml</a></li><li><a href="eio__core__.ml.html">eio__core__.ml</a></li><li><a href="exn.ml.html">exn.ml</a></li><li><a href="#" class="current_unit">fiber.ml</a></li><li><a href="promise.ml.html">promise.ml</a></li><li><a href="single_waiter.ml.html">single_waiter.ml</a></li><li><a href="suspend.ml.html">suspend.ml</a></li><li><a href="switch.ml.html">switch.ml</a></li><li><a href="trace.ml.html">trace.ml</a></li></ul></li><li>eio.mock<ul><li><a href="../eio.mock/action.ml.html">action.ml</a></li><li><a href="../eio.mock/backend.ml.html">backend.ml</a></li><li><a href="../eio.mock/clock.ml.html">clock.ml</a></li><li><a href="../eio.mock/domain_manager.ml.html">domain_manager.ml</a></li><li><a href="../eio.mock/eio_mock.ml.html">eio_mock.ml</a></li><li><a href="../eio.mock/eio_mock__.ml.html">eio_mock__.ml</a></li><li><a href="../eio.mock/flow.ml.html">flow.ml</a></li><li><a href="../eio.mock/handler.ml.html">handler.ml</a></li><li><a href="../eio.mock/net.ml.html">net.ml</a></li></ul></li><li>eio.runtime_events<ul><li><a href="../eio.runtime_events/eio_runtime_events.ml.html">eio_runtime_events.ml</a></li></ul></li><li>eio.unix<ul><li><a href="../eio.unix/cap.ml.html">cap.ml</a></li><li><a href="../eio.unix/eio_unix.ml.html">eio_unix.ml</a></li><li><a href="../eio.unix/eio_unix__.ml.html">eio_unix__.ml</a></li><li><a href="../eio.unix/fd.ml.html">fd.ml</a></li><li><a href="../eio.unix/fork_action.ml.html">fork_action.ml</a></li><li><a href="../eio.unix/inherit_fds.ml.html">inherit_fds.ml</a></li><li><a href="../eio.unix/net.ml.html">net.ml</a></li><li><a href="../eio.unix/pi.ml.html">pi.ml</a></li><li><a href="../eio.unix/private.ml.html">private.ml</a></li><li><a href="../eio.unix/process.ml.html">process.ml</a></li><li><a href="../eio.unix/rcfd.ml.html">rcfd.ml</a></li><li><a href="../eio.unix/resource.ml.html">resource.ml</a></li><li><a href="../eio.unix/thread_pool.ml.html">thread_pool.ml</a></li><li><a href="../eio.unix/types.ml.html">types.ml</a></li></ul></li><li>eio.utils<ul><li><a href="../eio.utils/eio_utils.ml.html">eio_utils.ml</a></li><li><a href="../eio.utils/eio_utils__.ml.html">eio_utils__.ml</a></li><li><a href="../eio.utils/lf_queue.ml.html">lf_queue.ml</a></li><li><a href="../eio.utils/suspended.ml.html">suspended.ml</a></li><li><a href="../eio.utils/zzz.ml.html">zzz.ml</a></li></ul></li></ul></li></ul></li></ul></nav></div><pre class="source_container"><code class="source_line_column"><a id="L1" class="source_line" href="#L1">1</a>
<a id="L2" class="source_line" href="#L2">2</a>
<a id="L3" class="source_line" href="#L3">3</a>
<a id="L4" class="source_line" href="#L4">4</a>
<a id="L5" class="source_line" href="#L5">5</a>
<a id="L6" class="source_line" href="#L6">6</a>
<a id="L7" class="source_line" href="#L7">7</a>
<a id="L8" class="source_line" href="#L8">8</a>
<a id="L9" class="source_line" href="#L9">9</a>
<a id="L10" class="source_line" href="#L10">10</a>
<a id="L11" class="source_line" href="#L11">11</a>
<a id="L12" class="source_line" href="#L12">12</a>
<a id="L13" class="source_line" href="#L13">13</a>
<a id="L14" class="source_line" href="#L14">14</a>
<a id="L15" class="source_line" href="#L15">15</a>
<a id="L16" class="source_line" href="#L16">16</a>
<a id="L17" class="source_line" href="#L17">17</a>
<a id="L18" class="source_line" href="#L18">18</a>
<a id="L19" class="source_line" href="#L19">19</a>
<a id="L20" class="source_line" href="#L20">20</a>
<a id="L21" class="source_line" href="#L21">21</a>
<a id="L22" class="source_line" href="#L22">22</a>
<a id="L23" class="source_line" href="#L23">23</a>
<a id="L24" class="source_line" href="#L24">24</a>
<a id="L25" class="source_line" href="#L25">25</a>
<a id="L26" class="source_line" href="#L26">26</a>
<a id="L27" class="source_line" href="#L27">27</a>
<a id="L28" class="source_line" href="#L28">28</a>
<a id="L29" class="source_line" href="#L29">29</a>
<a id="L30" class="source_line" href="#L30">30</a>
<a id="L31" class="source_line" href="#L31">31</a>
<a id="L32" class="source_line" href="#L32">32</a>
<a id="L33" class="source_line" href="#L33">33</a>
<a id="L34" class="source_line" href="#L34">34</a>
<a id="L35" class="source_line" href="#L35">35</a>
<a id="L36" class="source_line" href="#L36">36</a>
<a id="L37" class="source_line" href="#L37">37</a>
<a id="L38" class="source_line" href="#L38">38</a>
<a id="L39" class="source_line" href="#L39">39</a>
<a id="L40" class="source_line" href="#L40">40</a>
<a id="L41" class="source_line" href="#L41">41</a>
<a id="L42" class="source_line" href="#L42">42</a>
<a id="L43" class="source_line" href="#L43">43</a>
<a id="L44" class="source_line" href="#L44">44</a>
<a id="L45" class="source_line" href="#L45">45</a>
<a id="L46" class="source_line" href="#L46">46</a>
<a id="L47" class="source_line" href="#L47">47</a>
<a id="L48" class="source_line" href="#L48">48</a>
<a id="L49" class="source_line" href="#L49">49</a>
<a id="L50" class="source_line" href="#L50">50</a>
<a id="L51" class="source_line" href="#L51">51</a>
<a id="L52" class="source_line" href="#L52">52</a>
<a id="L53" class="source_line" href="#L53">53</a>
<a id="L54" class="source_line" href="#L54">54</a>
<a id="L55" class="source_line" href="#L55">55</a>
<a id="L56" class="source_line" href="#L56">56</a>
<a id="L57" class="source_line" href="#L57">57</a>
<a id="L58" class="source_line" href="#L58">58</a>
<a id="L59" class="source_line" href="#L59">59</a>
<a id="L60" class="source_line" href="#L60">60</a>
<a id="L61" class="source_line" href="#L61">61</a>
<a id="L62" class="source_line" href="#L62">62</a>
<a id="L63" class="source_line" href="#L63">63</a>
<a id="L64" class="source_line" href="#L64">64</a>
<a id="L65" class="source_line" href="#L65">65</a>
<a id="L66" class="source_line" href="#L66">66</a>
<a id="L67" class="source_line" href="#L67">67</a>
<a id="L68" class="source_line" href="#L68">68</a>
<a id="L69" class="source_line" href="#L69">69</a>
<a id="L70" class="source_line" href="#L70">70</a>
<a id="L71" class="source_line" href="#L71">71</a>
<a id="L72" class="source_line" href="#L72">72</a>
<a id="L73" class="source_line" href="#L73">73</a>
<a id="L74" class="source_line" href="#L74">74</a>
<a id="L75" class="source_line" href="#L75">75</a>
<a id="L76" class="source_line" href="#L76">76</a>
<a id="L77" class="source_line" href="#L77">77</a>
<a id="L78" class="source_line" href="#L78">78</a>
<a id="L79" class="source_line" href="#L79">79</a>
<a id="L80" class="source_line" href="#L80">80</a>
<a id="L81" class="source_line" href="#L81">81</a>
<a id="L82" class="source_line" href="#L82">82</a>
<a id="L83" class="source_line" href="#L83">83</a>
<a id="L84" class="source_line" href="#L84">84</a>
<a id="L85" class="source_line" href="#L85">85</a>
<a id="L86" class="source_line" href="#L86">86</a>
<a id="L87" class="source_line" href="#L87">87</a>
<a id="L88" class="source_line" href="#L88">88</a>
<a id="L89" class="source_line" href="#L89">89</a>
<a id="L90" class="source_line" href="#L90">90</a>
<a id="L91" class="source_line" href="#L91">91</a>
<a id="L92" class="source_line" href="#L92">92</a>
<a id="L93" class="source_line" href="#L93">93</a>
<a id="L94" class="source_line" href="#L94">94</a>
<a id="L95" class="source_line" href="#L95">95</a>
<a id="L96" class="source_line" href="#L96">96</a>
<a id="L97" class="source_line" href="#L97">97</a>
<a id="L98" class="source_line" href="#L98">98</a>
<a id="L99" class="source_line" href="#L99">99</a>
<a id="L100" class="source_line" href="#L100">100</a>
<a id="L101" class="source_line" href="#L101">101</a>
<a id="L102" class="source_line" href="#L102">102</a>
<a id="L103" class="source_line" href="#L103">103</a>
<a id="L104" class="source_line" href="#L104">104</a>
<a id="L105" class="source_line" href="#L105">105</a>
<a id="L106" class="source_line" href="#L106">106</a>
<a id="L107" class="source_line" href="#L107">107</a>
<a id="L108" class="source_line" href="#L108">108</a>
<a id="L109" class="source_line" href="#L109">109</a>
<a id="L110" class="source_line" href="#L110">110</a>
<a id="L111" class="source_line" href="#L111">111</a>
<a id="L112" class="source_line" href="#L112">112</a>
<a id="L113" class="source_line" href="#L113">113</a>
<a id="L114" class="source_line" href="#L114">114</a>
<a id="L115" class="source_line" href="#L115">115</a>
<a id="L116" class="source_line" href="#L116">116</a>
<a id="L117" class="source_line" href="#L117">117</a>
<a id="L118" class="source_line" href="#L118">118</a>
<a id="L119" class="source_line" href="#L119">119</a>
<a id="L120" class="source_line" href="#L120">120</a>
<a id="L121" class="source_line" href="#L121">121</a>
<a id="L122" class="source_line" href="#L122">122</a>
<a id="L123" class="source_line" href="#L123">123</a>
<a id="L124" class="source_line" href="#L124">124</a>
<a id="L125" class="source_line" href="#L125">125</a>
<a id="L126" class="source_line" href="#L126">126</a>
<a id="L127" class="source_line" href="#L127">127</a>
<a id="L128" class="source_line" href="#L128">128</a>
<a id="L129" class="source_line" href="#L129">129</a>
<a id="L130" class="source_line" href="#L130">130</a>
<a id="L131" class="source_line" href="#L131">131</a>
<a id="L132" class="source_line" href="#L132">132</a>
<a id="L133" class="source_line" href="#L133">133</a>
<a id="L134" class="source_line" href="#L134">134</a>
<a id="L135" class="source_line" href="#L135">135</a>
<a id="L136" class="source_line" href="#L136">136</a>
<a id="L137" class="source_line" href="#L137">137</a>
<a id="L138" class="source_line" href="#L138">138</a>
<a id="L139" class="source_line" href="#L139">139</a>
<a id="L140" class="source_line" href="#L140">140</a>
<a id="L141" class="source_line" href="#L141">141</a>
<a id="L142" class="source_line" href="#L142">142</a>
<a id="L143" class="source_line" href="#L143">143</a>
<a id="L144" class="source_line" href="#L144">144</a>
<a id="L145" class="source_line" href="#L145">145</a>
<a id="L146" class="source_line" href="#L146">146</a>
<a id="L147" class="source_line" href="#L147">147</a>
<a id="L148" class="source_line" href="#L148">148</a>
<a id="L149" class="source_line" href="#L149">149</a>
<a id="L150" class="source_line" href="#L150">150</a>
<a id="L151" class="source_line" href="#L151">151</a>
<a id="L152" class="source_line" href="#L152">152</a>
<a id="L153" class="source_line" href="#L153">153</a>
<a id="L154" class="source_line" href="#L154">154</a>
<a id="L155" class="source_line" href="#L155">155</a>
<a id="L156" class="source_line" href="#L156">156</a>
<a id="L157" class="source_line" href="#L157">157</a>
<a id="L158" class="source_line" href="#L158">158</a>
<a id="L159" class="source_line" href="#L159">159</a>
<a id="L160" class="source_line" href="#L160">160</a>
<a id="L161" class="source_line" href="#L161">161</a>
<a id="L162" class="source_line" href="#L162">162</a>
<a id="L163" class="source_line" href="#L163">163</a>
<a id="L164" class="source_line" href="#L164">164</a>
<a id="L165" class="source_line" href="#L165">165</a>
<a id="L166" class="source_line" href="#L166">166</a>
<a id="L167" class="source_line" href="#L167">167</a>
<a id="L168" class="source_line" href="#L168">168</a>
<a id="L169" class="source_line" href="#L169">169</a>
<a id="L170" class="source_line" href="#L170">170</a>
<a id="L171" class="source_line" href="#L171">171</a>
<a id="L172" class="source_line" href="#L172">172</a>
<a id="L173" class="source_line" href="#L173">173</a>
<a id="L174" class="source_line" href="#L174">174</a>
<a id="L175" class="source_line" href="#L175">175</a>
<a id="L176" class="source_line" href="#L176">176</a>
<a id="L177" class="source_line" href="#L177">177</a>
<a id="L178" class="source_line" href="#L178">178</a>
<a id="L179" class="source_line" href="#L179">179</a>
<a id="L180" class="source_line" href="#L180">180</a>
<a id="L181" class="source_line" href="#L181">181</a>
<a id="L182" class="source_line" href="#L182">182</a>
<a id="L183" class="source_line" href="#L183">183</a>
<a id="L184" class="source_line" href="#L184">184</a>
<a id="L185" class="source_line" href="#L185">185</a>
<a id="L186" class="source_line" href="#L186">186</a>
<a id="L187" class="source_line" href="#L187">187</a>
<a id="L188" class="source_line" href="#L188">188</a>
<a id="L189" class="source_line" href="#L189">189</a>
<a id="L190" class="source_line" href="#L190">190</a>
<a id="L191" class="source_line" href="#L191">191</a>
<a id="L192" class="source_line" href="#L192">192</a>
<a id="L193" class="source_line" href="#L193">193</a>
<a id="L194" class="source_line" href="#L194">194</a>
<a id="L195" class="source_line" href="#L195">195</a>
<a id="L196" class="source_line" href="#L196">196</a>
<a id="L197" class="source_line" href="#L197">197</a>
<a id="L198" class="source_line" href="#L198">198</a>
<a id="L199" class="source_line" href="#L199">199</a>
<a id="L200" class="source_line" href="#L200">200</a>
<a id="L201" class="source_line" href="#L201">201</a>
<a id="L202" class="source_line" href="#L202">202</a>
<a id="L203" class="source_line" href="#L203">203</a>
<a id="L204" class="source_line" href="#L204">204</a>
<a id="L205" class="source_line" href="#L205">205</a>
<a id="L206" class="source_line" href="#L206">206</a>
<a id="L207" class="source_line" href="#L207">207</a>
<a id="L208" class="source_line" href="#L208">208</a>
<a id="L209" class="source_line" href="#L209">209</a>
<a id="L210" class="source_line" href="#L210">210</a>
<a id="L211" class="source_line" href="#L211">211</a>
<a id="L212" class="source_line" href="#L212">212</a>
<a id="L213" class="source_line" href="#L213">213</a>
<a id="L214" class="source_line" href="#L214">214</a>
<a id="L215" class="source_line" href="#L215">215</a>
<a id="L216" class="source_line" href="#L216">216</a>
<a id="L217" class="source_line" href="#L217">217</a>
<a id="L218" class="source_line" href="#L218">218</a>
<a id="L219" class="source_line" href="#L219">219</a>
<a id="L220" class="source_line" href="#L220">220</a>
<a id="L221" class="source_line" href="#L221">221</a>
<a id="L222" class="source_line" href="#L222">222</a>
<a id="L223" class="source_line" href="#L223">223</a>
<a id="L224" class="source_line" href="#L224">224</a>
<a id="L225" class="source_line" href="#L225">225</a>
<a id="L226" class="source_line" href="#L226">226</a>
<a id="L227" class="source_line" href="#L227">227</a>
<a id="L228" class="source_line" href="#L228">228</a>
<a id="L229" class="source_line" href="#L229">229</a>
<a id="L230" class="source_line" href="#L230">230</a>
<a id="L231" class="source_line" href="#L231">231</a>
<a id="L232" class="source_line" href="#L232">232</a>
<a id="L233" class="source_line" href="#L233">233</a>
<a id="L234" class="source_line" href="#L234">234</a>
<a id="L235" class="source_line" href="#L235">235</a>
<a id="L236" class="source_line" href="#L236">236</a>
<a id="L237" class="source_line" href="#L237">237</a>
<a id="L238" class="source_line" href="#L238">238</a>
<a id="L239" class="source_line" href="#L239">239</a>
<a id="L240" class="source_line" href="#L240">240</a>
<a id="L241" class="source_line" href="#L241">241</a>
<a id="L242" class="source_line" href="#L242">242</a>
<a id="L243" class="source_line" href="#L243">243</a>
<a id="L244" class="source_line" href="#L244">244</a>
<a id="L245" class="source_line" href="#L245">245</a>
<a id="L246" class="source_line" href="#L246">246</a>
<a id="L247" class="source_line" href="#L247">247</a>
<a id="L248" class="source_line" href="#L248">248</a>
<a id="L249" class="source_line" href="#L249">249</a>
<a id="L250" class="source_line" href="#L250">250</a>
<a id="L251" class="source_line" href="#L251">251</a>
<a id="L252" class="source_line" href="#L252">252</a>
<a id="L253" class="source_line" href="#L253">253</a>
<a id="L254" class="source_line" href="#L254">254</a>
<a id="L255" class="source_line" href="#L255">255</a>
<a id="L256" class="source_line" href="#L256">256</a>
<a id="L257" class="source_line" href="#L257">257</a>
<a id="L258" class="source_line" href="#L258">258</a>
<a id="L259" class="source_line" href="#L259">259</a>
<a id="L260" class="source_line" href="#L260">260</a>
<a id="L261" class="source_line" href="#L261">261</a>
<a id="L262" class="source_line" href="#L262">262</a>
<a id="L263" class="source_line" href="#L263">263</a>
<a id="L264" class="source_line" href="#L264">264</a>
<a id="L265" class="source_line" href="#L265">265</a>
<a id="L266" class="source_line" href="#L266">266</a>
<a id="L267" class="source_line" href="#L267">267</a>
<a id="L268" class="source_line" href="#L268">268</a>
<a id="L269" class="source_line" href="#L269">269</a>
<a id="L270" class="source_line" href="#L270">270</a>
<a id="L271" class="source_line" href="#L271">271</a>
<a id="L272" class="source_line" href="#L272">272</a>
<a id="L273" class="source_line" href="#L273">273</a>
<a id="L274" class="source_line" href="#L274">274</a>
<a id="L275" class="source_line" href="#L275">275</a>
<a id="L276" class="source_line" href="#L276">276</a>
<a id="L277" class="source_line" href="#L277">277</a>
<a id="L278" class="source_line" href="#L278">278</a>
<a id="L279" class="source_line" href="#L279">279</a>
<a id="L280" class="source_line" href="#L280">280</a>
<a id="L281" class="source_line" href="#L281">281</a>
<a id="L282" class="source_line" href="#L282">282</a>
<a id="L283" class="source_line" href="#L283">283</a>
<a id="L284" class="source_line" href="#L284">284</a>
<a id="L285" class="source_line" href="#L285">285</a>
<a id="L286" class="source_line" href="#L286">286</a>
<a id="L287" class="source_line" href="#L287">287</a>
<a id="L288" class="source_line" href="#L288">288</a>
<a id="L289" class="source_line" href="#L289">289</a>
<a id="L290" class="source_line" href="#L290">290</a>
<a id="L291" class="source_line" href="#L291">291</a>
<a id="L292" class="source_line" href="#L292">292</a>
<a id="L293" class="source_line" href="#L293">293</a>
<a id="L294" class="source_line" href="#L294">294</a>
<a id="L295" class="source_line" href="#L295">295</a>
<a id="L296" class="source_line" href="#L296">296</a>
<a id="L297" class="source_line" href="#L297">297</a>
<a id="L298" class="source_line" href="#L298">298</a>
<a id="L299" class="source_line" href="#L299">299</a>
<a id="L300" class="source_line" href="#L300">300</a>
<a id="L301" class="source_line" href="#L301">301</a>
<a id="L302" class="source_line" href="#L302">302</a>
<a id="L303" class="source_line" href="#L303">303</a>
<a id="L304" class="source_line" href="#L304">304</a>
<a id="L305" class="source_line" href="#L305">305</a>
<a id="L306" class="source_line" href="#L306">306</a>
<a id="L307" class="source_line" href="#L307">307</a>
<a id="L308" class="source_line" href="#L308">308</a>
<a id="L309" class="source_line" href="#L309">309</a>
<a id="L310" class="source_line" href="#L310">310</a>
<a id="L311" class="source_line" href="#L311">311</a>
<a id="L312" class="source_line" href="#L312">312</a>
<a id="L313" class="source_line" href="#L313">313</a>
<a id="L314" class="source_line" href="#L314">314</a>
<a id="L315" class="source_line" href="#L315">315</a>
<a id="L316" class="source_line" href="#L316">316</a>
<a id="L317" class="source_line" href="#L317">317</a>
<a id="L318" class="source_line" href="#L318">318</a>
<a id="L319" class="source_line" href="#L319">319</a>
<a id="L320" class="source_line" href="#L320">320</a>
<a id="L321" class="source_line" href="#L321">321</a>
<a id="L322" class="source_line" href="#L322">322</a>
<a id="L323" class="source_line" href="#L323">323</a>
<a id="L324" class="source_line" href="#L324">324</a>
<a id="L325" class="source_line" href="#L325">325</a>
<a id="L326" class="source_line" href="#L326">326</a>
<a id="L327" class="source_line" href="#L327">327</a>
<a id="L328" class="source_line" href="#L328">328</a>
<a id="L329" class="source_line" href="#L329">329</a>
<a id="L330" class="source_line" href="#L330">330</a>
<a id="L331" class="source_line" href="#L331">331</a>
<a id="L332" class="source_line" href="#L332">332</a>
<a id="L333" class="source_line" href="#L333">333</a>
<a id="L334" class="source_line" href="#L334">334</a>
<a id="L335" class="source_line" href="#L335">335</a>
<a id="L336" class="source_line" href="#L336">336</a>
<a id="L337" class="source_line" href="#L337">337</a>
<a id="L338" class="source_line" href="#L338">338</a>
<a id="L339" class="source_line" href="#L339">339</a>
<a id="L340" class="source_line" href="#L340">340</a>
<a id="L341" class="source_line" href="#L341">341</a>
<a id="L342" class="source_line" href="#L342">342</a>
<a id="L343" class="source_line" href="#L343">343</a>
<a id="L344" class="source_line" href="#L344">344</a>
<a id="L345" class="source_line" href="#L345">345</a>
<a id="L346" class="source_line" href="#L346">346</a>
<a id="L347" class="source_line" href="#L347">347</a>
<a id="L348" class="source_line" href="#L348">348</a>
<a id="L349" class="source_line" href="#L349">349</a>
<a id="L350" class="source_line" href="#L350">350</a>
<a id="L351" class="source_line" href="#L351">351</a>
<a id="L352" class="source_line" href="#L352">352</a>
<a id="L353" class="source_line" href="#L353">353</a>
<a id="L354" class="source_line" href="#L354">354</a>
<a id="L355" class="source_line" href="#L355">355</a>
<a id="L356" class="source_line" href="#L356">356</a>
<a id="L357" class="source_line" href="#L357">357</a>
<a id="L358" class="source_line" href="#L358">358</a>
<a id="L359" class="source_line" href="#L359">359</a>
<a id="L360" class="source_line" href="#L360">360</a>
<a id="L361" class="source_line" href="#L361">361</a>
<a id="L362" class="source_line" href="#L362">362</a>
<a id="L363" class="source_line" href="#L363">363</a>
<a id="L364" class="source_line" href="#L364">364</a>
<a id="L365" class="source_line" href="#L365">365</a>
<a id="L366" class="source_line" href="#L366">366</a>
<a id="L367" class="source_line" href="#L367">367</a>
<a id="L368" class="source_line" href="#L368">368</a>
<a id="L369" class="source_line" href="#L369">369</a>
<a id="L370" class="source_line" href="#L370">370</a>
<a id="L371" class="source_line" href="#L371">371</a>
<a id="L372" class="source_line" href="#L372">372</a>
<a id="L373" class="source_line" href="#L373">373</a>
<a id="L374" class="source_line" href="#L374">374</a>
<a id="L375" class="source_line" href="#L375">375</a>
<a id="L376" class="source_line" href="#L376">376</a>
<a id="L377" class="source_line" href="#L377">377</a>
<a id="L378" class="source_line" href="#L378">378</a>
<a id="L379" class="source_line" href="#L379">379</a>
<a id="L380" class="source_line" href="#L380">380</a>
<a id="L381" class="source_line" href="#L381">381</a>
<a id="L382" class="source_line" href="#L382">382</a>
<a id="L383" class="source_line" href="#L383">383</a>
<a id="L384" class="source_line" href="#L384">384</a>
<a id="L385" class="source_line" href="#L385">385</a>
<a id="L386" class="source_line" href="#L386">386</a>
<a id="L387" class="source_line" href="#L387">387</a>
<a id="L388" class="source_line" href="#L388">388</a>
<a id="L389" class="source_line" href="#L389">389</a>
<a id="L390" class="source_line" href="#L390">390</a>
<a id="L391" class="source_line" href="#L391">391</a>
<a id="L392" class="source_line" href="#L392">392</a>
<a id="L393" class="source_line" href="#L393">393</a>
<a id="L394" class="source_line" href="#L394">394</a>
<a id="L395" class="source_line" href="#L395">395</a>
<a id="L396" class="source_line" href="#L396">396</a>
<a id="L397" class="source_line" href="#L397">397</a>
<a id="L398" class="source_line" href="#L398">398</a>
<a id="L399" class="source_line" href="#L399">399</a>
</code><code class="source_code"><span><span class="LBRACKETATATAT">[@@@</span><span class="LIDENT">alert</span> <span class="STRING">&quot;-unstable&quot;</span><span class="RBRACKET">]</span><span class="EOL">
</span><span class="EOL">
</span><span class="TYPE">type</span> <span class="UNDERSCORE">_</span> <span class="UIDENT">Effect</span><span class="DOT">.</span><span class="LIDENT">t</span> <span class="PLUSEQ">+=</span> <span id="extension-Fork"><span class="UIDENT">Fork</span> <span class="COLON">:</span> <a href="cancel.ml.html#type-fiber_context"><span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="LIDENT">fiber_context</span></a> <span class="STAR">*</span> <span class="LPAREN">(</span><span class="LIDENT">unit</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/effect.ml.html#type-t"><span class="LIDENT">unit</span> <span class="UIDENT">Effect</span><span class="DOT">.</span><span class="LIDENT">t</span></a></span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-yield"><span class="LIDENT">yield</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_fiber_1"><span class="LIDENT">fiber</span></span> <span class="EQUAL">=</span> <a href="suspend.ml.html#val-enter"><span class="UIDENT">Suspend</span><span class="DOT">.</span><span class="LIDENT">enter</span></a> <span class="STRING">&quot;&quot;</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_fiber_2"><span class="LIDENT">fiber</span></span> <span id="local_enqueue_3"><span class="LIDENT">enqueue</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_enqueue_3"><span class="LIDENT">enqueue</span></a> <span class="LPAREN">(</span><span class="UIDENT">Ok</span> <a href="#local_fiber_2"><span class="LIDENT">fiber</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>  <a href="cancel.ml.html#val-check"><span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="LIDENT">check</span></a> <a href="#local_fiber_1"><span class="LIDENT">fiber</span></a><span class="DOT">.</span><span class="LIDENT">cancel_context</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* Note: [f] must not raise an exception, as that would terminate the whole scheduler. *)</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-fork_raw"><span class="LIDENT">fork_raw</span></span> <span id="local_new_fiber_4"><span class="LIDENT">new_fiber</span></span> <span id="local_f_5"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="../../../ocaml-base-compiler/src/stdlib/effect.ml.html#val-perform"><span class="UIDENT">Effect</span><span class="DOT">.</span><span class="LIDENT">perform</span></a> <span class="LPAREN">(</span><span class="UIDENT">Fork</span> <span class="LPAREN">(</span><a href="#local_new_fiber_4"><span class="LIDENT">new_fiber</span></a><span class="COMMA">,</span> <a href="#local_f_5"><span class="LIDENT">f</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-fork"><span class="LIDENT">fork</span></span> <span class="TILDE">~</span><span id="local_sw_6"><span class="LIDENT">sw</span></span> <span id="local_f_7"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="switch.ml.html#val-check_our_domain"><span class="UIDENT">Switch</span><span class="DOT">.</span><span class="LIDENT">check_our_domain</span></a> <a href="#local_sw_6"><span class="LIDENT">sw</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="cancel.ml.html#val-is_on"><span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="LIDENT">is_on</span></a> <a href="#local_sw_6"><span class="LIDENT">sw</span></a><span class="DOT">.</span><span class="LIDENT">cancel</span> <span class="THEN">then</span> <span class="LPAREN">(</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_vars_8"><span class="LIDENT">vars</span></span> <span class="EQUAL">=</span> <a href="cancel.ml.html#module-Fiber_context.val-get_vars"><span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="UIDENT">Fiber_context</span><span class="DOT">.</span><span class="LIDENT">get_vars</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_new_fiber_9"><span class="LIDENT">new_fiber</span></span> <span class="EQUAL">=</span> <a href="cancel.ml.html#module-Fiber_context.val-make"><span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="UIDENT">Fiber_context</span><span class="DOT">.</span><span class="LIDENT">make</span></a> <span class="LABEL">~cc:</span><a href="#local_sw_6"><span class="LIDENT">sw</span></a><span class="DOT">.</span><span class="LIDENT">cancel</span> <span class="TILDE">~</span><a href="#local_vars_8"><span class="LIDENT">vars</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LIDENT">fork_raw</span> <a href="#local_new_fiber_9"><span class="LIDENT">new_fiber</span></a> <span class="INFIXOP1">@@</span> <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="switch.ml.html#val-with_op"><span class="UIDENT">Switch</span><span class="DOT">.</span><span class="LIDENT">with_op</span></a> <a href="#local_sw_6"><span class="LIDENT">sw</span></a> <span class="INFIXOP1">@@</span> <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="TRY">try</span><span class="EOL">
</span>      <a href="#local_f_7"><span class="LIDENT">f</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="WITH">with</span> <span id="local_ex_10"><span class="LIDENT">ex</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_bt_11"><span class="LIDENT">bt</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/printexc.ml.html#val-get_raw_backtrace"><span class="UIDENT">Printexc</span><span class="DOT">.</span><span class="LIDENT">get_raw_backtrace</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>      <a href="switch.ml.html#val-fail"><span class="UIDENT">Switch</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <span class="TILDE">~</span><a href="#local_bt_11"><span class="LIDENT">bt</span></a> <a href="#local_sw_6"><span class="LIDENT">sw</span></a> <a href="#local_ex_10"><span class="LIDENT">ex</span></a><span class="SEMI">;</span>  <span class="COMMENT">(* The [with_op] ensures this will succeed *)</span><span class="EOL">
</span>  <span class="RPAREN">)</span> <span class="COMMENT">(* else the fiber should report the error to [sw], but [sw] is failed anyway *)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-fork_daemon"><span class="LIDENT">fork_daemon</span></span> <span class="TILDE">~</span><span id="local_sw_12"><span class="LIDENT">sw</span></span> <span id="local_f_13"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="switch.ml.html#val-check_our_domain"><span class="UIDENT">Switch</span><span class="DOT">.</span><span class="LIDENT">check_our_domain</span></a> <a href="#local_sw_12"><span class="LIDENT">sw</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="cancel.ml.html#val-is_on"><span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="LIDENT">is_on</span></a> <a href="#local_sw_12"><span class="LIDENT">sw</span></a><span class="DOT">.</span><span class="LIDENT">cancel</span> <span class="THEN">then</span> <span class="LPAREN">(</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_vars_14"><span class="LIDENT">vars</span></span> <span class="EQUAL">=</span> <a href="cancel.ml.html#module-Fiber_context.val-get_vars"><span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="UIDENT">Fiber_context</span><span class="DOT">.</span><span class="LIDENT">get_vars</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_new_fiber_15"><span class="LIDENT">new_fiber</span></span> <span class="EQUAL">=</span> <a href="cancel.ml.html#module-Fiber_context.val-make"><span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="UIDENT">Fiber_context</span><span class="DOT">.</span><span class="LIDENT">make</span></a> <span class="LABEL">~cc:</span><a href="#local_sw_12"><span class="LIDENT">sw</span></a><span class="DOT">.</span><span class="LIDENT">cancel</span> <span class="TILDE">~</span><a href="#local_vars_14"><span class="LIDENT">vars</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LIDENT">fork_raw</span> <a href="#local_new_fiber_15"><span class="LIDENT">new_fiber</span></a> <span class="INFIXOP1">@@</span> <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="switch.ml.html#val-with_daemon"><span class="UIDENT">Switch</span><span class="DOT">.</span><span class="LIDENT">with_daemon</span></a> <a href="#local_sw_12"><span class="LIDENT">sw</span></a> <span class="INFIXOP1">@@</span> <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_f_13"><span class="LIDENT">f</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Stop_daemon</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="COMMENT">(* The daemon asked to stop. *)</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="EXCEPTION">exception</span> <span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="UIDENT">Cancelled</span> <span class="UIDENT">Exit</span> <span class="WHEN">when</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-not"><span class="LIDENT">not</span></a> <span class="LPAREN">(</span><a href="cancel.ml.html#val-is_on"><span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="LIDENT">is_on</span></a> <a href="#local_sw_12"><span class="LIDENT">sw</span></a><span class="DOT">.</span><span class="LIDENT">cancel</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="COMMENT">(* The daemon was cancelled because all non-daemon fibers are finished. *)</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="EXCEPTION">exception</span> <span id="local_ex_16"><span class="LIDENT">ex</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="switch.ml.html#val-fail"><span class="UIDENT">Switch</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <a href="#local_sw_12"><span class="LIDENT">sw</span></a> <a href="#local_ex_16"><span class="LIDENT">ex</span></a><span class="SEMI">;</span>  <span class="COMMENT">(* The [with_daemon] ensures this will succeed *)</span><span class="EOL">
</span>  <span class="RPAREN">)</span> <span class="COMMENT">(* else the fiber should report the error to [sw], but [sw] is failed anyway *)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-fork_promise"><span class="LIDENT">fork_promise</span></span> <span class="TILDE">~</span><span id="local_sw_17"><span class="LIDENT">sw</span></span> <span id="local_f_18"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="switch.ml.html#val-check_our_domain"><span class="UIDENT">Switch</span><span class="DOT">.</span><span class="LIDENT">check_our_domain</span></a> <a href="#local_sw_17"><span class="LIDENT">sw</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_vars_19"><span class="LIDENT">vars</span></span> <span class="EQUAL">=</span> <a href="cancel.ml.html#module-Fiber_context.val-get_vars"><span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="UIDENT">Fiber_context</span><span class="DOT">.</span><span class="LIDENT">get_vars</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_new_fiber_20"><span class="LIDENT">new_fiber</span></span> <span class="EQUAL">=</span> <a href="cancel.ml.html#module-Fiber_context.val-make"><span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="UIDENT">Fiber_context</span><span class="DOT">.</span><span class="LIDENT">make</span></a> <span class="LABEL">~cc:</span><a href="#local_sw_17"><span class="LIDENT">sw</span></a><span class="DOT">.</span><span class="UIDENT">Switch</span><span class="DOT">.</span><span class="LIDENT">cancel</span> <span class="TILDE">~</span><a href="#local_vars_19"><span class="LIDENT">vars</span></a> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="def_182"><span id="local_p_21"><span class="LIDENT">p</span></span><span class="COMMA">,</span> <span id="local_r_22"><span class="LIDENT">r</span></span></span> <span class="EQUAL">=</span> <a href="promise.ml.html#val-create_with_id"><span class="UIDENT">Promise</span><span class="DOT">.</span><span class="LIDENT">create_with_id</span></a> <span class="LPAREN">(</span><a href="cancel.ml.html#module-Fiber_context.val-tid"><span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="UIDENT">Fiber_context</span><span class="DOT">.</span><span class="LIDENT">tid</span></a> <a href="#local_new_fiber_20"><span class="LIDENT">new_fiber</span></a><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LIDENT">fork_raw</span> <a href="#local_new_fiber_20"><span class="LIDENT">new_fiber</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="MATCH">match</span> <a href="switch.ml.html#val-with_op"><span class="UIDENT">Switch</span><span class="DOT">.</span><span class="LIDENT">with_op</span></a> <a href="#local_sw_17"><span class="LIDENT">sw</span></a> <a href="#local_f_18"><span class="LIDENT">f</span></a> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span id="local_x_23"><span class="LIDENT">x</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="promise.ml.html#val-resolve_ok"><span class="UIDENT">Promise</span><span class="DOT">.</span><span class="LIDENT">resolve_ok</span></a> <a href="#local_r_22"><span class="LIDENT">r</span></a> <a href="#local_x_23"><span class="LIDENT">x</span></a><span class="EOL">
</span>      <span class="BAR">|</span> <span class="EXCEPTION">exception</span> <span id="local_ex_24"><span class="LIDENT">ex</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="promise.ml.html#val-resolve_error"><span class="UIDENT">Promise</span><span class="DOT">.</span><span class="LIDENT">resolve_error</span></a> <a href="#local_r_22"><span class="LIDENT">r</span></a> <a href="#local_ex_24"><span class="LIDENT">ex</span></a>        <span class="COMMENT">(* Can't fail; only we have [r] *)</span><span class="EOL">
</span>    <span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>  <a href="#local_p_21"><span class="LIDENT">p</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* This is not exposed. On failure it fails [sw], but you need to make sure that
   any fibers waiting on the promise will be cancelled. *)</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-fork_promise_exn"><span class="LIDENT">fork_promise_exn</span></span> <span class="TILDE">~</span><span id="local_sw_25"><span class="LIDENT">sw</span></span> <span id="local_f_26"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="switch.ml.html#val-check_our_domain"><span class="UIDENT">Switch</span><span class="DOT">.</span><span class="LIDENT">check_our_domain</span></a> <a href="#local_sw_25"><span class="LIDENT">sw</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_vars_27"><span class="LIDENT">vars</span></span> <span class="EQUAL">=</span> <a href="cancel.ml.html#module-Fiber_context.val-get_vars"><span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="UIDENT">Fiber_context</span><span class="DOT">.</span><span class="LIDENT">get_vars</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_new_fiber_28"><span class="LIDENT">new_fiber</span></span> <span class="EQUAL">=</span> <a href="cancel.ml.html#module-Fiber_context.val-make"><span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="UIDENT">Fiber_context</span><span class="DOT">.</span><span class="LIDENT">make</span></a> <span class="LABEL">~cc:</span><a href="#local_sw_25"><span class="LIDENT">sw</span></a><span class="DOT">.</span><span class="UIDENT">Switch</span><span class="DOT">.</span><span class="LIDENT">cancel</span> <span class="TILDE">~</span><a href="#local_vars_27"><span class="LIDENT">vars</span></a> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="def_184"><span id="local_p_29"><span class="LIDENT">p</span></span><span class="COMMA">,</span> <span id="local_r_30"><span class="LIDENT">r</span></span></span> <span class="EQUAL">=</span> <a href="promise.ml.html#val-create_with_id"><span class="UIDENT">Promise</span><span class="DOT">.</span><span class="LIDENT">create_with_id</span></a> <span class="LPAREN">(</span><a href="cancel.ml.html#module-Fiber_context.val-tid"><span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="UIDENT">Fiber_context</span><span class="DOT">.</span><span class="LIDENT">tid</span></a> <a href="#local_new_fiber_28"><span class="LIDENT">new_fiber</span></a><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LIDENT">fork_raw</span> <a href="#local_new_fiber_28"><span class="LIDENT">new_fiber</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="MATCH">match</span> <a href="switch.ml.html#val-with_op"><span class="UIDENT">Switch</span><span class="DOT">.</span><span class="LIDENT">with_op</span></a> <a href="#local_sw_25"><span class="LIDENT">sw</span></a> <a href="#local_f_26"><span class="LIDENT">f</span></a> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span id="local_x_31"><span class="LIDENT">x</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="promise.ml.html#val-resolve"><span class="UIDENT">Promise</span><span class="DOT">.</span><span class="LIDENT">resolve</span></a> <a href="#local_r_30"><span class="LIDENT">r</span></a> <a href="#local_x_31"><span class="LIDENT">x</span></a><span class="EOL">
</span>      <span class="BAR">|</span> <span class="EXCEPTION">exception</span> <span id="local_ex_32"><span class="LIDENT">ex</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <a href="switch.ml.html#val-fail"><span class="UIDENT">Switch</span><span class="DOT">.</span><span class="LIDENT">fail</span></a> <a href="#local_sw_25"><span class="LIDENT">sw</span></a> <a href="#local_ex_32"><span class="LIDENT">ex</span></a>  <span class="COMMENT">(* The [with_op] ensures this will succeed *)</span><span class="EOL">
</span>    <span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>  <a href="#local_p_29"><span class="LIDENT">p</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* Like [List.iter (fork ~sw)], but runs the last one in the current fiber
   for efficiency and less cluttered traces. *)</span><span class="EOL">
</span><span class="LET">let</span> <span class="REC">rec</span> <span id="val-forks"><span class="LIDENT">forks</span></span> <span class="TILDE">~</span><span id="local_sw_33"><span class="LIDENT">sw</span></span> <span class="EQUAL">=</span> <span class="FUNCTION">function</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="LBRACKET">[</span><span id="local_x_34"><span class="LIDENT">x</span></span><span class="RBRACKET">]</span> <span class="MINUSGREATER">-&gt;</span> <a href="switch.ml.html#val-check"><span class="UIDENT">Switch</span><span class="DOT">.</span><span class="LIDENT">check</span></a> <a href="#local_sw_33"><span class="LIDENT">sw</span></a><span class="SEMI">;</span> <a href="#local_x_34"><span class="LIDENT">x</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="BAR">|</span> <span id="local_x_35"><span class="LIDENT">x</span></span> <span class="COLONCOLON">::</span> <span id="local_xs_36"><span class="LIDENT">xs</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LIDENT">fork</span> <span class="TILDE">~</span><a href="#local_sw_33"><span class="LIDENT">sw</span></a> <a href="#local_x_35"><span class="LIDENT">x</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">forks</span> <span class="TILDE">~</span><a href="#local_sw_33"><span class="LIDENT">sw</span></a> <a href="#local_xs_36"><span class="LIDENT">xs</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-all"><span class="LIDENT">all</span></span> <span id="local_xs_37"><span class="LIDENT">xs</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="switch.ml.html#val-run"><span class="UIDENT">Switch</span><span class="DOT">.</span><span class="LIDENT">run</span></a> <span class="LABEL">~name:</span><span class="STRING">&quot;all&quot;</span> <span class="INFIXOP1">@@</span> <span class="FUN">fun</span> <span id="local_sw_38"><span class="LIDENT">sw</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>  <span class="LIDENT">forks</span> <span class="TILDE">~</span><a href="#local_sw_38"><span class="LIDENT">sw</span></a> <a href="#local_xs_37"><span class="LIDENT">xs</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-both"><span class="LIDENT">both</span></span> <span id="local_f_39"><span class="LIDENT">f</span></span> <span id="local_g_40"><span class="LIDENT">g</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="switch.ml.html#val-run"><span class="UIDENT">Switch</span><span class="DOT">.</span><span class="LIDENT">run</span></a> <span class="LABEL">~name:</span><span class="STRING">&quot;both&quot;</span> <span class="INFIXOP1">@@</span> <span class="FUN">fun</span> <span id="local_sw_41"><span class="LIDENT">sw</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>  <span class="LIDENT">forks</span> <span class="TILDE">~</span><a href="#local_sw_41"><span class="LIDENT">sw</span></a> <span class="LBRACKET">[</span><a href="#local_f_39"><span class="LIDENT">f</span></a><span class="SEMI">;</span> <a href="#local_g_40"><span class="LIDENT">g</span></a><span class="RBRACKET">]</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-pair"><span class="LIDENT">pair</span></span> <span id="local_f_42"><span class="LIDENT">f</span></span> <span id="local_g_43"><span class="LIDENT">g</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="switch.ml.html#val-run"><span class="UIDENT">Switch</span><span class="DOT">.</span><span class="LIDENT">run</span></a> <span class="LABEL">~name:</span><span class="STRING">&quot;pair&quot;</span> <span class="INFIXOP1">@@</span> <span class="FUN">fun</span> <span id="local_sw_44"><span class="LIDENT">sw</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_x_45"><span class="LIDENT">x</span></span> <span class="EQUAL">=</span> <span class="LIDENT">fork_promise</span> <span class="TILDE">~</span><a href="#local_sw_44"><span class="LIDENT">sw</span></a> <a href="#local_f_42"><span class="LIDENT">f</span></a> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_y_46"><span class="LIDENT">y</span></span> <span class="EQUAL">=</span> <a href="#local_g_43"><span class="LIDENT">g</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LPAREN">(</span><a href="promise.ml.html#val-await_exn"><span class="UIDENT">Promise</span><span class="DOT">.</span><span class="LIDENT">await_exn</span></a> <a href="#local_x_45"><span class="LIDENT">x</span></a><span class="COMMA">,</span> <a href="#local_y_46"><span class="LIDENT">y</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span id="exception-Not_first"><span class="EXCEPTION">exception</span> <span class="UIDENT">Not_first</span></span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-await_cancel"><span class="LIDENT">await_cancel</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="suspend.ml.html#val-enter"><span class="UIDENT">Suspend</span><span class="DOT">.</span><span class="LIDENT">enter</span></a> <span class="STRING">&quot;await_cancel&quot;</span> <span class="INFIXOP1">@@</span> <span class="FUN">fun</span> <span id="local_fiber_47"><span class="LIDENT">fiber</span></span> <span id="local_enqueue_48"><span class="LIDENT">enqueue</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>  <a href="cancel.ml.html#module-Fiber_context.val-set_cancel_fn"><span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="UIDENT">Fiber_context</span><span class="DOT">.</span><span class="LIDENT">set_cancel_fn</span></a> <a href="#local_fiber_47"><span class="LIDENT">fiber</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_ex_49"><span class="LIDENT">ex</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_enqueue_48"><span class="LIDENT">enqueue</span></a> <span class="LPAREN">(</span><span class="UIDENT">Error</span> <a href="#local_ex_49"><span class="LIDENT">ex</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span id="type-any_status"><span class="TYPE">type</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">any_status</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span id="type-any_status.constructor-New"><span class="BAR">|</span> <span class="UIDENT">New</span></span><span class="EOL">
</span>  <span id="type-any_status.constructor-Ex"><span class="BAR">|</span> <span class="UIDENT">Ex</span> <span class="OF">of</span> <span class="LPAREN">(</span><span class="LIDENT">exn</span> <span class="STAR">*</span> <a href="../../../ocaml-base-compiler/src/stdlib/printexc.ml.html#type-raw_backtrace"><span class="UIDENT">Printexc</span><span class="DOT">.</span><span class="LIDENT">raw_backtrace</span></a><span class="RPAREN">)</span></span><span class="EOL">
</span>  <span id="type-any_status.constructor-OK"><span class="BAR">|</span> <span class="UIDENT">OK</span> <span class="OF">of</span> <span class="QUOTE">'</span><span class="LIDENT">a</span></span></span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-any_gen"><span class="LIDENT">any_gen</span></span> <span class="TILDE">~</span><span id="local_return_50"><span class="LIDENT">return</span></span> <span class="TILDE">~</span><span id="local_combine_51"><span class="LIDENT">combine</span></span> <span id="local_fs_52"><span class="LIDENT">fs</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_r_53"><span class="LIDENT">r</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ref"><span class="LIDENT">ref</span></a> <span class="UIDENT">New</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_parent_c_54"><span class="LIDENT">parent_c</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <a href="cancel.ml.html#val-sub_unchecked"><span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="LIDENT">sub_unchecked</span></a> <span class="UIDENT">Any</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_cc_55"><span class="LIDENT">cc</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_wrap_56"><span class="LIDENT">wrap</span></span> <span id="local_h_57"><span class="LIDENT">h</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>          <span class="MATCH">match</span> <a href="#local_h_57"><span class="LIDENT">h</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="WITH">with</span><span class="EOL">
</span>          <span class="BAR">|</span> <span id="local_x_58"><span class="LIDENT">x</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <span class="BEGIN">begin</span> <span class="MATCH">match</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="#local_r_53"><span class="LIDENT">r</span></a> <span class="WITH">with</span><span class="EOL">
</span>              <span class="BAR">|</span> <span class="UIDENT">New</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_r_53"><span class="LIDENT">r</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <span class="UIDENT">OK</span> <span class="LPAREN">(</span><a href="#local_return_50"><span class="LIDENT">return</span></a> <a href="#local_x_58"><span class="LIDENT">x</span></a><span class="RPAREN">)</span><span class="SEMI">;</span> <a href="cancel.ml.html#val-cancel"><span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="LIDENT">cancel</span></a> <a href="#local_cc_55"><span class="LIDENT">cc</span></a> <span class="UIDENT">Not_first</span><span class="EOL">
</span>              <span class="BAR">|</span> <span class="UIDENT">OK</span> <span id="local_prev_59"><span class="LIDENT">prev</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_r_53"><span class="LIDENT">r</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <span class="UIDENT">OK</span> <span class="LPAREN">(</span><a href="#local_combine_51"><span class="LIDENT">combine</span></a> <a href="#local_prev_59"><span class="LIDENT">prev</span></a> <a href="#local_x_58"><span class="LIDENT">x</span></a><span class="RPAREN">)</span><span class="EOL">
</span>              <span class="BAR">|</span> <span class="UIDENT">Ex</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>            <span class="END">end</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="EXCEPTION">exception</span> <span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="UIDENT">Cancelled</span> <span class="UNDERSCORE">_</span> <span class="WHEN">when</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-not"><span class="LIDENT">not</span></a> <span class="LPAREN">(</span><a href="cancel.ml.html#val-is_on"><span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="LIDENT">is_on</span></a> <a href="#local_cc_55"><span class="LIDENT">cc</span></a><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <span class="COMMENT">(* If this is in response to us asking the fiber to cancel then we can just ignore it.
               If it's in response to our parent context being cancelled (which also cancels [cc]) then
               we'll check that context and raise it at the end anyway. *)</span><span class="EOL">
</span>            <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="EXCEPTION">exception</span> <span id="local_ex_60"><span class="LIDENT">ex</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <span class="BEGIN">begin</span> <span class="MATCH">match</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="#local_r_53"><span class="LIDENT">r</span></a> <span class="WITH">with</span><span class="EOL">
</span>              <span class="BAR">|</span> <span class="UIDENT">New</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_r_53"><span class="LIDENT">r</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <span class="UIDENT">Ex</span> <span class="LPAREN">(</span><a href="#local_ex_60"><span class="LIDENT">ex</span></a><span class="COMMA">,</span> <a href="../../../ocaml-base-compiler/src/stdlib/printexc.ml.html#val-get_raw_backtrace"><span class="UIDENT">Printexc</span><span class="DOT">.</span><span class="LIDENT">get_raw_backtrace</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="SEMI">;</span> <a href="cancel.ml.html#val-cancel"><span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="LIDENT">cancel</span></a> <a href="#local_cc_55"><span class="LIDENT">cc</span></a> <a href="#local_ex_60"><span class="LIDENT">ex</span></a><span class="EOL">
</span>              <span class="BAR">|</span> <span class="UIDENT">OK</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_r_53"><span class="LIDENT">r</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <span class="UIDENT">Ex</span> <span class="LPAREN">(</span><a href="#local_ex_60"><span class="LIDENT">ex</span></a><span class="COMMA">,</span> <a href="../../../ocaml-base-compiler/src/stdlib/printexc.ml.html#val-get_raw_backtrace"><span class="UIDENT">Printexc</span><span class="DOT">.</span><span class="LIDENT">get_raw_backtrace</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>              <span class="BAR">|</span> <span class="UIDENT">Ex</span> <span id="local_prev_61"><span class="LIDENT">prev</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>                <span class="LET">let</span> <span id="local_bt_62"><span class="LIDENT">bt</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/printexc.ml.html#val-get_raw_backtrace"><span class="UIDENT">Printexc</span><span class="DOT">.</span><span class="LIDENT">get_raw_backtrace</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>                <a href="#local_r_53"><span class="LIDENT">r</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <span class="UIDENT">Ex</span> <span class="LPAREN">(</span><a href="exn.ml.html#val-combine"><span class="UIDENT">Exn</span><span class="DOT">.</span><span class="LIDENT">combine</span></a> <a href="#local_prev_61"><span class="LIDENT">prev</span></a> <span class="LPAREN">(</span><a href="#local_ex_60"><span class="LIDENT">ex</span></a><span class="COMMA">,</span> <a href="#local_bt_62"><span class="LIDENT">bt</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>            <span class="END">end</span><span class="EOL">
</span>        <span class="IN">in</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_vars_63"><span class="LIDENT">vars</span></span> <span class="EQUAL">=</span> <a href="cancel.ml.html#module-Fiber_context.val-get_vars"><span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="UIDENT">Fiber_context</span><span class="DOT">.</span><span class="LIDENT">get_vars</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>        <span class="LET">let</span> <span class="REC">rec</span> <span id="local_aux_64"><span class="LIDENT">aux</span></span> <span class="EQUAL">=</span> <span class="FUNCTION">function</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">await_cancel</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="LBRACKET">[</span><span id="local_f_65"><span class="LIDENT">f</span></span><span class="RBRACKET">]</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_wrap_56"><span class="LIDENT">wrap</span></a> <a href="#local_f_65"><span class="LIDENT">f</span></a><span class="SEMI">;</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span><span class="EOL">
</span>          <span class="BAR">|</span> <span id="local_f_66"><span class="LIDENT">f</span></span> <span class="COLONCOLON">::</span> <span id="local_fs_67"><span class="LIDENT">fs</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <span class="LET">let</span> <span id="local_new_fiber_68"><span class="LIDENT">new_fiber</span></span> <span class="EQUAL">=</span> <a href="cancel.ml.html#module-Fiber_context.val-make"><span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="UIDENT">Fiber_context</span><span class="DOT">.</span><span class="LIDENT">make</span></a> <span class="TILDE">~</span><a href="#local_cc_55"><span class="LIDENT">cc</span></a> <span class="TILDE">~</span><a href="#local_vars_63"><span class="LIDENT">vars</span></a> <span class="IN">in</span><span class="EOL">
</span>            <span class="LET">let</span> <span id="def_185"><span id="local_p_69"><span class="LIDENT">p</span></span><span class="COMMA">,</span> <span id="local_r_70"><span class="LIDENT">r</span></span></span> <span class="EQUAL">=</span> <a href="promise.ml.html#val-create_with_id"><span class="UIDENT">Promise</span><span class="DOT">.</span><span class="LIDENT">create_with_id</span></a> <span class="LPAREN">(</span><a href="cancel.ml.html#module-Fiber_context.val-tid"><span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="UIDENT">Fiber_context</span><span class="DOT">.</span><span class="LIDENT">tid</span></a> <a href="#local_new_fiber_68"><span class="LIDENT">new_fiber</span></a><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>            <span class="LIDENT">fork_raw</span> <a href="#local_new_fiber_68"><span class="LIDENT">new_fiber</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>                <span class="MATCH">match</span> <a href="#local_wrap_56"><span class="LIDENT">wrap</span></a> <a href="#local_f_66"><span class="LIDENT">f</span></a> <span class="WITH">with</span><span class="EOL">
</span>                <span class="BAR">|</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="promise.ml.html#val-resolve_ok"><span class="UIDENT">Promise</span><span class="DOT">.</span><span class="LIDENT">resolve_ok</span></a> <a href="#local_r_70"><span class="LIDENT">r</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>                <span class="BAR">|</span> <span class="EXCEPTION">exception</span> <span id="local_ex_71"><span class="LIDENT">ex</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="promise.ml.html#val-resolve_error"><span class="UIDENT">Promise</span><span class="DOT">.</span><span class="LIDENT">resolve_error</span></a> <a href="#local_r_70"><span class="LIDENT">r</span></a> <a href="#local_ex_71"><span class="LIDENT">ex</span></a><span class="EOL">
</span>              <span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>            <a href="#local_p_69"><span class="LIDENT">p</span></a> <span class="COLONCOLON">::</span> <a href="#local_aux_64"><span class="LIDENT">aux</span></a> <a href="#local_fs_67"><span class="LIDENT">fs</span></a><span class="EOL">
</span>        <span class="IN">in</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_ps_72"><span class="LIDENT">ps</span></span> <span class="EQUAL">=</span> <a href="#local_aux_64"><span class="LIDENT">aux</span></a> <a href="#local_fs_52"><span class="LIDENT">fs</span></a> <span class="IN">in</span><span class="EOL">
</span>        <a href="cancel.ml.html#val-protect"><span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="LIDENT">protect</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-iter"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">iter</span></a> <a href="promise.ml.html#val-await_exn"><span class="UIDENT">Promise</span><span class="DOT">.</span><span class="LIDENT">await_exn</span></a> <a href="#local_ps_72"><span class="LIDENT">ps</span></a><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="RPAREN">)</span><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <span class="MATCH">match</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="#local_r_53"><span class="LIDENT">r</span></a><span class="COMMA">,</span> <a href="cancel.ml.html#val-get_error"><span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="LIDENT">get_error</span></a> <a href="#local_parent_c_54"><span class="LIDENT">parent_c</span></a> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">OK</span> <span id="local_r_73"><span class="LIDENT">r</span></span><span class="COMMA">,</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_r_73"><span class="LIDENT">r</span></a><span class="EOL">
</span>  <span class="BAR">|</span> <span class="LPAREN">(</span><span class="UIDENT">OK</span> <span class="UNDERSCORE">_</span> <span class="BAR">|</span> <span class="UIDENT">New</span><span class="RPAREN">)</span><span class="COMMA">,</span> <span class="UIDENT">Some</span> <span id="local_ex_74"><span class="LIDENT">ex</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-raise"><span class="LIDENT">raise</span></a> <a href="#local_ex_74"><span class="LIDENT">ex</span></a><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Ex</span> <span class="LPAREN">(</span><span id="local_ex_75"><span class="LIDENT">ex</span></span><span class="COMMA">,</span> <span id="local_bt_76"><span class="LIDENT">bt</span></span><span class="RPAREN">)</span><span class="COMMA">,</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/printexc.ml.html#val-raise_with_backtrace"><span class="UIDENT">Printexc</span><span class="DOT">.</span><span class="LIDENT">raise_with_backtrace</span></a> <a href="#local_ex_75"><span class="LIDENT">ex</span></a> <a href="#local_bt_76"><span class="LIDENT">bt</span></a><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Ex</span> <span id="local_ex1_77"><span class="LIDENT">ex1</span></span><span class="COMMA">,</span> <span class="UIDENT">Some</span> <span id="local_ex2_78"><span class="LIDENT">ex2</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_bt2_79"><span class="LIDENT">bt2</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/printexc.ml.html#val-get_raw_backtrace"><span class="UIDENT">Printexc</span><span class="DOT">.</span><span class="LIDENT">get_raw_backtrace</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="def_187"><span id="local_ex_80"><span class="LIDENT">ex</span></span><span class="COMMA">,</span> <span id="local_bt_81"><span class="LIDENT">bt</span></span></span> <span class="EQUAL">=</span> <a href="exn.ml.html#val-combine"><span class="UIDENT">Exn</span><span class="DOT">.</span><span class="LIDENT">combine</span></a> <a href="#local_ex1_77"><span class="LIDENT">ex1</span></a> <span class="LPAREN">(</span><a href="#local_ex2_78"><span class="LIDENT">ex2</span></a><span class="COMMA">,</span> <a href="#local_bt2_79"><span class="LIDENT">bt2</span></a><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/printexc.ml.html#val-raise_with_backtrace"><span class="UIDENT">Printexc</span><span class="DOT">.</span><span class="LIDENT">raise_with_backtrace</span></a> <a href="#local_ex_80"><span class="LIDENT">ex</span></a> <a href="#local_bt_81"><span class="LIDENT">bt</span></a><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">New</span><span class="COMMA">,</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span> <span class="ASSERT">assert</span> <span class="FALSE">false</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-n_any"><span class="LIDENT">n_any</span></span> <span id="local_fs_82"><span class="LIDENT">fs</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-rev"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">rev</span></a> <span class="LPAREN">(</span><span class="LIDENT">any_gen</span> <a href="#local_fs_82"><span class="LIDENT">fs</span></a> <span class="LABEL">~return:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_x_83"><span class="LIDENT">x</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="LBRACKET">[</span><a href="#local_x_83"><span class="LIDENT">x</span></a><span class="RBRACKET">]</span><span class="RPAREN">)</span> <span class="LABEL">~combine:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_xs_84"><span class="LIDENT">xs</span></span> <span id="local_x_85"><span class="LIDENT">x</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_x_85"><span class="LIDENT">x</span></a> <span class="COLONCOLON">::</span> <a href="#local_xs_84"><span class="LIDENT">xs</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-any"><span class="LIDENT">any</span></span> <span class="QUESTION">?</span><span class="LPAREN">(</span><span id="local_combine_86"><span class="LIDENT">combine</span></span><span class="EQUAL">=</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_x_87"><span class="LIDENT">x</span></span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_x_87"><span class="LIDENT">x</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span> <span id="local_fs_88"><span class="LIDENT">fs</span></span> <span class="EQUAL">=</span> <span class="LIDENT">any_gen</span> <a href="#local_fs_88"><span class="LIDENT">fs</span></a> <span class="LABEL">~return:</span><a href="../../../ocaml-base-compiler/src/stdlib/fun.ml.html#val-id"><span class="UIDENT">Fun</span><span class="DOT">.</span><span class="LIDENT">id</span></a> <span class="TILDE">~</span><a href="#local_combine_86"><span class="LIDENT">combine</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-first"><span class="LIDENT">first</span></span> <span class="QUESTION">?</span><span id="local_combine_89"><span class="LIDENT">combine</span></span> <span id="local_f_90"><span class="LIDENT">f</span></span> <span id="local_g_91"><span class="LIDENT">g</span></span> <span class="EQUAL">=</span> <span class="LIDENT">any</span> <span class="QUESTION">?</span><a href="#local_combine_89"><span class="LIDENT">combine</span></a> <span class="LBRACKET">[</span><a href="#local_f_90"><span class="LIDENT">f</span></a><span class="SEMI">;</span> <a href="#local_g_91"><span class="LIDENT">g</span></a><span class="RBRACKET">]</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-is_cancelled"><span class="LIDENT">is_cancelled</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_ctx_92"><span class="LIDENT">ctx</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/effect.ml.html#val-perform"><span class="UIDENT">Effect</span><span class="DOT">.</span><span class="LIDENT">perform</span></a> <span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="UIDENT">Get_context</span> <span class="IN">in</span><span class="EOL">
</span>  <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-not"><span class="LIDENT">not</span></a> <span class="LPAREN">(</span><a href="cancel.ml.html#val-is_on"><span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="LIDENT">is_on</span></a> <a href="#local_ctx_92"><span class="LIDENT">ctx</span></a><span class="DOT">.</span><span class="LIDENT">cancel_context</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-check"><span class="LIDENT">check</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_ctx_93"><span class="LIDENT">ctx</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/effect.ml.html#val-perform"><span class="UIDENT">Effect</span><span class="DOT">.</span><span class="LIDENT">perform</span></a> <span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="UIDENT">Get_context</span> <span class="IN">in</span><span class="EOL">
</span>  <a href="cancel.ml.html#val-check"><span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="LIDENT">check</span></a> <a href="#local_ctx_93"><span class="LIDENT">ctx</span></a><span class="DOT">.</span><span class="LIDENT">cancel_context</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* Some concurrent list operations *)</span><span class="EOL">
</span><span id="module-List"><span class="MODULE">module</span> <span class="UIDENT">List</span> <span class="EQUAL">=</span> <span class="STRUCT">struct</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-List.val-opt_cons"><span class="LIDENT">opt_cons</span></span> <span id="local_x_94"><span class="LIDENT">x</span></span> <span id="local_xs_95"><span class="LIDENT">xs</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_x_94"><span class="LIDENT">x</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_xs_95"><span class="LIDENT">xs</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_x_96"><span class="LIDENT">x</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_x_96"><span class="LIDENT">x</span></a> <span class="COLONCOLON">::</span> <a href="#local_xs_95"><span class="LIDENT">xs</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-List.module-Limiter"><span class="MODULE">module</span> <span class="UIDENT">Limiter</span> <span class="COLON">:</span> <span class="SIG">sig</span><span class="EOL">
</span>    <span class="DOCSTRING">(** This is a bit like using a semaphore, but it assumes that there is only a
        single fiber using it. e.g. you must not call {!use}, {!fork}, etc from
        two different fibers. *)</span><span class="EOL">
</span><span class="EOL">
</span>    <span id="module-List.module-Limiter.type-t"><span class="TYPE">type</span> <span class="LIDENT">t</span></span><span class="EOL">
</span><span class="EOL">
</span>    <span id="module-List.module-Limiter.val-create"><span class="VAL">val</span> <span class="LIDENT">create</span> <span class="COLON">:</span> <span class="LIDENT">sw</span><span class="COLON">:</span><a href="switch.ml.html#type-t"><span class="UIDENT">Switch</span><span class="DOT">.</span><span class="LIDENT">t</span></a> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">int</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">t</span></span><span class="EOL">
</span>    <span class="DOCSTRING">(** [create ~sw n] is a limiter that allows running up to [n] jobs at once. *)</span><span class="EOL">
</span><span class="EOL">
</span>    <span id="module-List.module-Limiter.val-use"><span class="VAL">val</span> <span class="LIDENT">use</span> <span class="COLON">:</span> <span class="LIDENT">t</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">b</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">b</span></span><span class="EOL">
</span>    <span class="DOCSTRING">(** [use t fn x] runs [fn x] in this fiber, counting it as one use of [t]. *)</span><span class="EOL">
</span><span class="EOL">
</span>    <span id="module-List.module-Limiter.val-fork"><span class="VAL">val</span> <span class="LIDENT">fork</span> <span class="COLON">:</span> <span class="LIDENT">t</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span></span><span class="EOL">
</span>    <span class="DOCSTRING">(** [fork t fn x] runs [fn x] in a new fibre, once a fiber is free. *)</span><span class="EOL">
</span><span class="EOL">
</span>    <span id="module-List.module-Limiter.val-fork_promise_exn"><span class="VAL">val</span> <span class="LIDENT">fork_promise_exn</span> <span class="COLON">:</span> <span class="LIDENT">t</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">b</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="MINUSGREATER">-&gt;</span> <a href="promise.ml.html#type-t"><span class="QUOTE">'</span><span class="LIDENT">b</span> <span class="UIDENT">Promise</span><span class="DOT">.</span><span class="LIDENT">t</span></a></span><span class="EOL">
</span>    <span class="DOCSTRING">(** [fork_promise_exn t fn x] runs [fn x] in a new fibre, once a fiber is free,
        and returns a promise for the result. *)</span><span class="EOL">
</span>  <span class="END">end</span> <span class="EQUAL">=</span> <span class="STRUCT">struct</span><span class="EOL">
</span>    <span id="module-List.module-Limiter.type-t"><span class="TYPE">type</span> <span class="LIDENT">t</span> <span class="EQUAL">=</span> <span class="LBRACE">{</span><span class="EOL">
</span>      <span id="def_189"><span class="MUTABLE">mutable</span> <span class="LIDENT">free_fibers</span> <span class="COLON">:</span> <span class="LIDENT">int</span><span class="SEMI">;</span></span><span class="EOL">
</span>      <span id="def_186"><span class="LIDENT">cond</span> <span class="COLON">:</span> <a href="single_waiter.ml.html#type-t"><span class="LIDENT">unit</span> <span class="UIDENT">Single_waiter</span><span class="DOT">.</span><span class="LIDENT">t</span></a><span class="SEMI">;</span></span><span class="EOL">
</span>      <span id="def_181"><span class="LIDENT">sw</span> <span class="COLON">:</span> <a href="switch.ml.html#type-t"><span class="UIDENT">Switch</span><span class="DOT">.</span><span class="LIDENT">t</span></a><span class="SEMI">;</span></span><span class="EOL">
</span>    <span class="RBRACE">}</span></span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="module-List.module-Limiter.val-max_fibers_err"><span class="LIDENT">max_fibers_err</span></span> <span id="local_n_97"><span class="LIDENT">n</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="UIDENT">Fmt</span><span class="DOT">.</span><span class="failwith">failwith</span> <span class="STRING">&quot;max_fibers must be positive (got %d)&quot;</span> <a href="#local_n_97"><span class="LIDENT">n</span></a><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="module-List.module-Limiter.val-create"><span class="LIDENT">create</span></span> <span class="TILDE">~</span><span id="local_sw_98"><span class="LIDENT">sw</span></span> <span id="local_max_fibers_99"><span class="LIDENT">max_fibers</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="IF">if</span> <a href="#local_max_fibers_99"><span class="LIDENT">max_fibers</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;=)"><span class="INFIXOP0">&lt;=</span></a> <span class="INT">0</span> <span class="THEN">then</span> <span class="LIDENT">max_fibers_err</span> <a href="#local_max_fibers_99"><span class="LIDENT">max_fibers</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <span class="LBRACE">{</span><span class="EOL">
</span>        <span class="LIDENT">free_fibers</span> <span class="EQUAL">=</span> <a href="#local_max_fibers_99"><span class="LIDENT">max_fibers</span></a><span class="SEMI">;</span><span class="EOL">
</span>        <span class="LIDENT">cond</span> <span class="EQUAL">=</span> <a href="single_waiter.ml.html#val-create"><span class="UIDENT">Single_waiter</span><span class="DOT">.</span><span class="LIDENT">create</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>        <a href="#local_sw_98"><span class="LIDENT">sw</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <span class="RBRACE">}</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="module-List.module-Limiter.val-await_free"><span class="LIDENT">await_free</span></span> <span id="local_t_100"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="IF">if</span> <a href="#local_t_100"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">free_fibers</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="INT">0</span> <span class="THEN">then</span> <a href="single_waiter.ml.html#val-await"><span class="UIDENT">Single_waiter</span><span class="DOT">.</span><span class="LIDENT">await</span></a> <a href="#local_t_100"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">cond</span> <span class="STRING">&quot;Limiter.await_free&quot;</span> <a href="#local_t_100"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">sw</span><span class="DOT">.</span><span class="LIDENT">cancel</span><span class="DOT">.</span><span class="LIDENT">id</span><span class="SEMI">;</span><span class="EOL">
</span>      <span class="COMMENT">(* If we got woken up then there was a free fiber then. And since we're the
         only fiber that uses [t], and we were sleeping, it must still be free. *)</span><span class="EOL">
</span>      <span class="ASSERT">assert</span> <span class="LPAREN">(</span><a href="#local_t_100"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">free_fibers</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <span class="INT">0</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>      <a href="#local_t_100"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">free_fibers</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_t_100"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">free_fibers</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <span class="INT">1</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="module-List.module-Limiter.val-release"><span class="LIDENT">release</span></span> <span id="local_t_101"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <a href="#local_t_101"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">free_fibers</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_t_101"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">free_fibers</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <span class="INT">1</span><span class="SEMI">;</span><span class="EOL">
</span>      <span class="IF">if</span> <a href="#local_t_101"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">free_fibers</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="INT">1</span> <span class="THEN">then</span> <a href="single_waiter.ml.html#val-wake"><span class="UIDENT">Single_waiter</span><span class="DOT">.</span><span class="LIDENT">wake</span></a> <a href="#local_t_101"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">cond</span> <span class="LPAREN">(</span><span class="UIDENT">Ok</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="module-List.module-Limiter.val-use"><span class="LIDENT">use</span></span> <span id="local_t_102"><span class="LIDENT">t</span></span> <span id="local_fn_103"><span class="LIDENT">fn</span></span> <span id="local_x_104"><span class="LIDENT">x</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LIDENT">await_free</span> <a href="#local_t_102"><span class="LIDENT">t</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_r_105"><span class="LIDENT">r</span></span> <span class="EQUAL">=</span> <a href="#local_fn_103"><span class="LIDENT">fn</span></a> <a href="#local_x_104"><span class="LIDENT">x</span></a> <span class="IN">in</span><span class="EOL">
</span>      <span class="LIDENT">release</span> <a href="#local_t_102"><span class="LIDENT">t</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <a href="#local_r_105"><span class="LIDENT">r</span></a><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="module-List.module-Limiter.val-fork_promise_exn"><span class="LIDENT">fork_promise_exn</span></span> <span id="local_t_106"><span class="LIDENT">t</span></span> <span id="local_fn_107"><span class="LIDENT">fn</span></span> <span id="local_x_108"><span class="LIDENT">x</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LIDENT">await_free</span> <a href="#local_t_106"><span class="LIDENT">t</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <span class="LIDENT">fork_promise_exn</span> <span class="LABEL">~sw:</span><a href="#local_t_106"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">sw</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LET">let</span> <span id="local_r_109"><span class="LIDENT">r</span></span> <span class="EQUAL">=</span> <a href="#local_fn_107"><span class="LIDENT">fn</span></a> <a href="#local_x_108"><span class="LIDENT">x</span></a> <span class="IN">in</span> <span class="LIDENT">release</span> <a href="#local_t_106"><span class="LIDENT">t</span></a><span class="SEMI">;</span> <a href="#local_r_109"><span class="LIDENT">r</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="module-List.module-Limiter.val-fork"><span class="LIDENT">fork</span></span> <span id="local_t_110"><span class="LIDENT">t</span></span> <span id="local_fn_111"><span class="LIDENT">fn</span></span> <span id="local_x_112"><span class="LIDENT">x</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LIDENT">await_free</span> <a href="#local_t_110"><span class="LIDENT">t</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <span class="LIDENT">fork</span> <span class="LABEL">~sw:</span><a href="#local_t_110"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">sw</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_fn_111"><span class="LIDENT">fn</span></a> <a href="#local_x_112"><span class="LIDENT">x</span></a><span class="SEMI">;</span> <span class="LIDENT">release</span> <a href="#local_t_110"><span class="LIDENT">t</span></a><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="END">end</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-List.val-filter_map"><span class="LIDENT">filter_map</span></span> <span class="QUESTION">?</span><span class="LPAREN">(</span><span id="local_max_fibers_113"><span class="LIDENT">max_fibers</span></span><span class="EQUAL">=</span><a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-max_int"><span class="LIDENT">max_int</span></a><span class="RPAREN">)</span> <span id="local_fn_114"><span class="LIDENT">fn</span></span> <span id="local_items_115"><span class="LIDENT">items</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_items_115"><span class="LIDENT">items</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="MINUSGREATER">-&gt;</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span>    <span class="COMMENT">(* Avoid creating a switch in the simple case *)</span><span class="EOL">
</span>    <span class="BAR">|</span> <span id="local_items_116"><span class="LIDENT">items</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="switch.ml.html#val-run"><span class="UIDENT">Switch</span><span class="DOT">.</span><span class="LIDENT">run</span></a> <span class="LABEL">~name:</span><span class="STRING">&quot;filter_map&quot;</span> <span class="INFIXOP1">@@</span> <span class="FUN">fun</span> <span id="local_sw_117"><span class="LIDENT">sw</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_limiter_118"><span class="LIDENT">limiter</span></span> <span class="EQUAL">=</span> <span class="UIDENT">Limiter</span><span class="DOT">.</span><span class="LIDENT">create</span> <span class="TILDE">~</span><a href="#local_sw_117"><span class="LIDENT">sw</span></a> <a href="#local_max_fibers_113"><span class="LIDENT">max_fibers</span></a> <span class="IN">in</span><span class="EOL">
</span>      <span class="LET">let</span> <span class="REC">rec</span> <span id="local_aux_119"><span class="LIDENT">aux</span></span> <span class="EQUAL">=</span> <span class="FUNCTION">function</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="MINUSGREATER">-&gt;</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="LBRACKET">[</span><span id="local_x_120"><span class="LIDENT">x</span></span><span class="RBRACKET">]</span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/option.ml.html#val-to_list"><span class="UIDENT">Option</span><span class="DOT">.</span><span class="LIDENT">to_list</span></a> <span class="LPAREN">(</span><span class="UIDENT">Limiter</span><span class="DOT">.</span><span class="LIDENT">use</span> <a href="#local_limiter_118"><span class="LIDENT">limiter</span></a> <a href="#local_fn_114"><span class="LIDENT">fn</span></a> <a href="#local_x_120"><span class="LIDENT">x</span></a><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="BAR">|</span> <span id="local_x_121"><span class="LIDENT">x</span></span> <span class="COLONCOLON">::</span> <span id="local_xs_122"><span class="LIDENT">xs</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_x_123"><span class="LIDENT">x</span></span> <span class="EQUAL">=</span> <span class="UIDENT">Limiter</span><span class="DOT">.</span><span class="LIDENT">fork_promise_exn</span> <a href="#local_limiter_118"><span class="LIDENT">limiter</span></a> <a href="#local_fn_114"><span class="LIDENT">fn</span></a> <a href="#local_x_121"><span class="LIDENT">x</span></a> <span class="IN">in</span><span class="EOL">
</span>          <span class="LET">let</span> <span id="local_xs_124"><span class="LIDENT">xs</span></span> <span class="EQUAL">=</span> <a href="#local_aux_119"><span class="LIDENT">aux</span></a> <a href="#local_xs_122"><span class="LIDENT">xs</span></a> <span class="IN">in</span><span class="EOL">
</span>          <span class="LIDENT">opt_cons</span> <span class="LPAREN">(</span><a href="promise.ml.html#val-await"><span class="UIDENT">Promise</span><span class="DOT">.</span><span class="LIDENT">await</span></a> <a href="#local_x_123"><span class="LIDENT">x</span></a><span class="RPAREN">)</span> <a href="#local_xs_124"><span class="LIDENT">xs</span></a><span class="EOL">
</span>      <span class="IN">in</span><span class="EOL">
</span>      <a href="#local_aux_119"><span class="LIDENT">aux</span></a> <a href="#local_items_116"><span class="LIDENT">items</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-List.val-map"><span class="LIDENT">map</span></span> <span class="QUESTION">?</span><span id="local_max_fibers_125"><span class="LIDENT">max_fibers</span></span> <span id="local_fn_126"><span class="LIDENT">fn</span></span> <span class="EQUAL">=</span> <span class="LIDENT">filter_map</span> <span class="QUESTION">?</span><a href="#local_max_fibers_125"><span class="LIDENT">max_fibers</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_x_127"><span class="LIDENT">x</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Some</span> <span class="LPAREN">(</span><a href="#local_fn_126"><span class="LIDENT">fn</span></a> <a href="#local_x_127"><span class="LIDENT">x</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-List.val-filter"><span class="LIDENT">filter</span></span> <span class="QUESTION">?</span><span id="local_max_fibers_128"><span class="LIDENT">max_fibers</span></span> <span id="local_fn_129"><span class="LIDENT">fn</span></span> <span class="EQUAL">=</span> <span class="LIDENT">filter_map</span> <span class="QUESTION">?</span><a href="#local_max_fibers_128"><span class="LIDENT">max_fibers</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_x_130"><span class="LIDENT">x</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="IF">if</span> <a href="#local_fn_129"><span class="LIDENT">fn</span></a> <a href="#local_x_130"><span class="LIDENT">x</span></a> <span class="THEN">then</span> <span class="UIDENT">Some</span> <a href="#local_x_130"><span class="LIDENT">x</span></a> <span class="ELSE">else</span> <span class="UIDENT">None</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-List.val-iter"><span class="LIDENT">iter</span></span> <span class="QUESTION">?</span><span class="LPAREN">(</span><span id="local_max_fibers_131"><span class="LIDENT">max_fibers</span></span><span class="EQUAL">=</span><a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-max_int"><span class="LIDENT">max_int</span></a><span class="RPAREN">)</span> <span id="local_fn_132"><span class="LIDENT">fn</span></span> <span id="local_items_133"><span class="LIDENT">items</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_items_133"><span class="LIDENT">items</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span>    <span class="COMMENT">(* Avoid creating a switch in the simple case *)</span><span class="EOL">
</span>    <span class="BAR">|</span> <span id="local_items_134"><span class="LIDENT">items</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="switch.ml.html#val-run"><span class="UIDENT">Switch</span><span class="DOT">.</span><span class="LIDENT">run</span></a> <span class="LABEL">~name:</span><span class="STRING">&quot;iter&quot;</span> <span class="INFIXOP1">@@</span> <span class="FUN">fun</span> <span id="local_sw_135"><span class="LIDENT">sw</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_limiter_136"><span class="LIDENT">limiter</span></span> <span class="EQUAL">=</span> <span class="UIDENT">Limiter</span><span class="DOT">.</span><span class="LIDENT">create</span> <span class="TILDE">~</span><a href="#local_sw_135"><span class="LIDENT">sw</span></a> <a href="#local_max_fibers_131"><span class="LIDENT">max_fibers</span></a> <span class="IN">in</span><span class="EOL">
</span>      <span class="LET">let</span> <span class="REC">rec</span> <span id="local_aux_137"><span class="LIDENT">aux</span></span> <span class="EQUAL">=</span> <span class="FUNCTION">function</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="LBRACKET">[</span><span id="local_x_138"><span class="LIDENT">x</span></span><span class="RBRACKET">]</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Limiter</span><span class="DOT">.</span><span class="LIDENT">use</span> <a href="#local_limiter_136"><span class="LIDENT">limiter</span></a> <a href="#local_fn_132"><span class="LIDENT">fn</span></a> <a href="#local_x_138"><span class="LIDENT">x</span></a><span class="EOL">
</span>        <span class="BAR">|</span> <span id="local_x_139"><span class="LIDENT">x</span></span> <span class="COLONCOLON">::</span> <span id="local_xs_140"><span class="LIDENT">xs</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <span class="UIDENT">Limiter</span><span class="DOT">.</span><span class="LIDENT">fork</span> <a href="#local_limiter_136"><span class="LIDENT">limiter</span></a> <a href="#local_fn_132"><span class="LIDENT">fn</span></a> <a href="#local_x_139"><span class="LIDENT">x</span></a><span class="SEMI">;</span><span class="EOL">
</span>          <a href="#local_aux_137"><span class="LIDENT">aux</span></a> <a href="#local_xs_140"><span class="LIDENT">xs</span></a><span class="EOL">
</span>      <span class="IN">in</span><span class="EOL">
</span>      <a href="#local_aux_137"><span class="LIDENT">aux</span></a> <a href="#local_items_134"><span class="LIDENT">items</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="END">end</span></span><span class="EOL">
</span><span class="EOL">
</span><span id="type-key"><span class="TYPE">type</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="LIDENT">key</span> <span class="EQUAL">=</span> <span class="QUOTE">'</span><span class="LIDENT">a</span> <span class="UIDENT">Hmap</span><span class="DOT">.</span><span class="LIDENT">key</span></span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-create_key"><span class="LIDENT">create_key</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span> <span class="UIDENT">Hmap</span><span class="DOT">.</span><span class="UIDENT">Key</span><span class="DOT">.</span><span class="LIDENT">create</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-get"><span class="LIDENT">get</span></span> <span id="local_key_141"><span class="LIDENT">key</span></span> <span class="EQUAL">=</span> <span class="UIDENT">Hmap</span><span class="DOT">.</span><span class="LIDENT">find</span> <a href="#local_key_141"><span class="LIDENT">key</span></a> <span class="LPAREN">(</span><a href="cancel.ml.html#module-Fiber_context.val-get_vars"><span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="UIDENT">Fiber_context</span><span class="DOT">.</span><span class="LIDENT">get_vars</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-with_binding"><span class="LIDENT">with_binding</span></span> <span id="local_var_142"><span class="LIDENT">var</span></span> <span id="local_value_143"><span class="LIDENT">value</span></span> <span id="local_fn_144"><span class="LIDENT">fn</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_ctx_145"><span class="LIDENT">ctx</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/effect.ml.html#val-perform"><span class="UIDENT">Effect</span><span class="DOT">.</span><span class="LIDENT">perform</span></a> <span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="UIDENT">Get_context</span> <span class="IN">in</span><span class="EOL">
</span>  <a href="cancel.ml.html#module-Fiber_context.val-with_vars"><span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="UIDENT">Fiber_context</span><span class="DOT">.</span><span class="LIDENT">with_vars</span></a> <a href="#local_ctx_145"><span class="LIDENT">ctx</span></a> <span class="LPAREN">(</span><span class="UIDENT">Hmap</span><span class="DOT">.</span><span class="LIDENT">add</span> <a href="#local_var_142"><span class="LIDENT">var</span></a> <a href="#local_value_143"><span class="LIDENT">value</span></a> <a href="#local_ctx_145"><span class="LIDENT">ctx</span></a><span class="DOT">.</span><span class="LIDENT">vars</span><span class="RPAREN">)</span> <a href="#local_fn_144"><span class="LIDENT">fn</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-without_binding"><span class="LIDENT">without_binding</span></span> <span id="local_var_146"><span class="LIDENT">var</span></span> <span id="local_fn_147"><span class="LIDENT">fn</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_ctx_148"><span class="LIDENT">ctx</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/effect.ml.html#val-perform"><span class="UIDENT">Effect</span><span class="DOT">.</span><span class="LIDENT">perform</span></a> <span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="UIDENT">Get_context</span> <span class="IN">in</span><span class="EOL">
</span>  <a href="cancel.ml.html#module-Fiber_context.val-with_vars"><span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="UIDENT">Fiber_context</span><span class="DOT">.</span><span class="LIDENT">with_vars</span></a> <a href="#local_ctx_148"><span class="LIDENT">ctx</span></a> <span class="LPAREN">(</span><span class="UIDENT">Hmap</span><span class="DOT">.</span><span class="LIDENT">rem</span> <a href="#local_var_146"><span class="LIDENT">var</span></a> <a href="#local_ctx_148"><span class="LIDENT">ctx</span></a><span class="DOT">.</span><span class="LIDENT">vars</span><span class="RPAREN">)</span> <a href="#local_fn_147"><span class="LIDENT">fn</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* Coroutines.

   [fork_coroutine ~sw fn] creates a new fiber for [fn]. [fn] immediately suspends, setting its state to
   [Ready enqueue]. A consumer can resume it by setting the state to [Running] and calling [enqueue],
   while suspending itself. The consumer passes in its own [enqueue] function. They run alternatively
   like this, switching between the [Ready] and [Running] states.

   To finish, the coroutine fiber can set the state to [Finished] or [Failed],
   or the client can set the state to [Client_cancelled].
*)</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* Note: we could easily generalise this to [('in, 'out) coroutine] if that was useful. *)</span><span class="EOL">
</span><span id="type-coroutine"><span class="TYPE">type</span> <span class="QUOTE">'</span><span class="LIDENT">out</span> <span class="LIDENT">coroutine</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LBRACKET">[</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Init</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Ready</span> <span class="OF">of</span> <a href="suspend.ml.html#type-enqueue"><span class="LBRACKET">[</span><span class="BACKQUOTE">`</span><span class="UIDENT">Running</span> <span class="OF">of</span> <a href="suspend.ml.html#type-enqueue"><span class="QUOTE">'</span><span class="LIDENT">out</span> <span class="UIDENT">Suspend</span><span class="DOT">.</span><span class="LIDENT">enqueue</span></a><span class="RBRACKET">]</span> <span class="UIDENT">Suspend</span><span class="DOT">.</span><span class="LIDENT">enqueue</span></a><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Running</span> <span class="OF">of</span> <a href="suspend.ml.html#type-enqueue"><span class="QUOTE">'</span><span class="LIDENT">out</span> <span class="UIDENT">Suspend</span><span class="DOT">.</span><span class="LIDENT">enqueue</span></a><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Finished</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Client_cancelled</span> <span class="OF">of</span> <span class="LIDENT">exn</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Failed</span> <span class="OF">of</span> <span class="LIDENT">exn</span> <span class="RBRACKET">]</span></span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* The only good reason for the state to change while the coroutine is running is if the client
   cancels. Return the exception in that case. If the coroutine is buggy it might e.g. fork two
   fibers and yield twice for a single request - return Invalid_argument in that case. *)</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-unwrap_cancelled"><span class="LIDENT">unwrap_cancelled</span></span> <span id="local_state_149"><span class="LIDENT">state</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="MATCH">match</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-get"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">get</span></a> <a href="#local_state_149"><span class="LIDENT">state</span></a> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Client_cancelled</span> <span id="local_ex_150"><span class="LIDENT">ex</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_ex_150"><span class="LIDENT">ex</span></a><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Finished</span> <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Failed</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Invalid_argument</span> <span class="STRING">&quot;Coroutine has already stopped!&quot;</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Ready</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Invalid_argument</span> <span class="STRING">&quot;Coroutine has already yielded!&quot;</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Init</span> <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Running</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Invalid_argument</span> <span class="STRING">&quot;Coroutine in unexpected state!&quot;</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-run_coroutine"><span class="LIDENT">run_coroutine</span></span> <span class="TILDE">~</span><span id="local_state_151"><span class="LIDENT">state</span></span> <span id="local_fn_152"><span class="LIDENT">fn</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_await_request_153"><span class="LIDENT">await_request</span></span> <span class="TILDE">~</span><span id="local_prev_154"><span class="LIDENT">prev</span></span> <span class="TILDE">~</span><span id="local_on_suspend_155"><span class="LIDENT">on_suspend</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="COMMENT">(* Suspend and wait for the consumer to resume us: *)</span><span class="EOL">
</span>    <a href="suspend.ml.html#val-enter"><span class="UIDENT">Suspend</span><span class="DOT">.</span><span class="LIDENT">enter</span></a> <span class="STRING">&quot;await-consumer&quot;</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_ctx_156"><span class="LIDENT">ctx</span></span> <span id="local_enqueue_157"><span class="LIDENT">enqueue</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_ready_158"><span class="LIDENT">ready</span></span> <span class="EQUAL">=</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Ready</span> <a href="#local_enqueue_157"><span class="LIDENT">enqueue</span></a> <span class="IN">in</span><span class="EOL">
</span>        <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-compare_and_set"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">compare_and_set</span></a> <a href="#local_state_151"><span class="LIDENT">state</span></a> <a href="#local_prev_154"><span class="LIDENT">prev</span></a> <a href="#local_ready_158"><span class="LIDENT">ready</span></a> <span class="THEN">then</span> <span class="LPAREN">(</span><span class="EOL">
</span>          <a href="cancel.ml.html#module-Fiber_context.val-set_cancel_fn"><span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="UIDENT">Fiber_context</span><span class="DOT">.</span><span class="LIDENT">set_cancel_fn</span></a> <a href="#local_ctx_156"><span class="LIDENT">ctx</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_ex_159"><span class="LIDENT">ex</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>              <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-compare_and_set"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">compare_and_set</span></a> <a href="#local_state_151"><span class="LIDENT">state</span></a> <a href="#local_ready_158"><span class="LIDENT">ready</span></a> <span class="LPAREN">(</span><span class="BACKQUOTE">`</span><span class="UIDENT">Failed</span> <a href="#local_ex_159"><span class="LIDENT">ex</span></a><span class="RPAREN">)</span> <span class="THEN">then</span><span class="EOL">
</span>                <a href="#local_enqueue_157"><span class="LIDENT">enqueue</span></a> <span class="LPAREN">(</span><span class="UIDENT">Error</span> <a href="#local_ex_159"><span class="LIDENT">ex</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>              <span class="COMMENT">(* else the client enqueued a resume for us; handle that instead *)</span><span class="EOL">
</span>            <span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>          <a href="#local_on_suspend_155"><span class="LIDENT">on_suspend</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="RPAREN">)</span> <span class="ELSE">else</span> <span class="LPAREN">(</span><span class="EOL">
</span>          <a href="#local_enqueue_157"><span class="LIDENT">enqueue</span></a> <span class="LPAREN">(</span><span class="UIDENT">Error</span> <span class="LPAREN">(</span><span class="LIDENT">unwrap_cancelled</span> <a href="#local_state_151"><span class="LIDENT">state</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>        <span class="RPAREN">)</span><span class="EOL">
</span>      <span class="RPAREN">)</span><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_current_state_160"><span class="LIDENT">current_state</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ref"><span class="LIDENT">ref</span></a> <span class="LPAREN">(</span><a href="#local_await_request_153"><span class="LIDENT">await_request</span></a> <span class="LABEL">~prev:</span><span class="BACKQUOTE">`</span><span class="UIDENT">Init</span> <span class="LABEL">~on_suspend:</span><a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>  <a href="#local_fn_152"><span class="LIDENT">fn</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_v_161"><span class="LIDENT">v</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="COMMENT">(* The coroutine wants to yield the value [v] and suspend. *)</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="def_188"><span class="BACKQUOTE">`</span><span class="UIDENT">Running</span> <span id="local_enqueue_163"><span class="LIDENT">enqueue</span></span> <span class="AS">as</span> <span id="local_prev_162"><span class="LIDENT">prev</span></span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="#local_current_state_160"><span class="LIDENT">current_state</span></a> <span class="IN">in</span><span class="EOL">
</span>      <a href="#local_current_state_160"><span class="LIDENT">current_state</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="#local_await_request_153"><span class="LIDENT">await_request</span></a> <span class="TILDE">~</span><a href="#local_prev_162"><span class="LIDENT">prev</span></a> <span class="LABEL">~on_suspend:</span><span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_enqueue_163"><span class="LIDENT">enqueue</span></a> <span class="LPAREN">(</span><span class="UIDENT">Ok</span> <span class="LPAREN">(</span><span class="UIDENT">Some</span> <a href="#local_v_161"><span class="LIDENT">v</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>  <span class="COMMENT">(* [fn] has finished. End the stream. *)</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-compare_and_set"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">compare_and_set</span></a> <a href="#local_state_151"><span class="LIDENT">state</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="#local_current_state_160"><span class="LIDENT">current_state</span></a> <span class="COLONGREATER">:&gt;</span> <span class="UNDERSCORE">_</span> <span class="LIDENT">coroutine</span><span class="RPAREN">)</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Finished</span> <span class="THEN">then</span> <span class="LPAREN">(</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="def_183"><span class="BACKQUOTE">`</span><span class="UIDENT">Running</span> <span id="local_enqueue_164"><span class="LIDENT">enqueue</span></span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="#local_current_state_160"><span class="LIDENT">current_state</span></a> <span class="IN">in</span><span class="EOL">
</span>    <a href="#local_enqueue_164"><span class="LIDENT">enqueue</span></a> <span class="LPAREN">(</span><span class="UIDENT">Ok</span> <span class="UIDENT">None</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="RPAREN">)</span> <span class="ELSE">else</span> <span class="LPAREN">(</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-raise"><span class="LIDENT">raise</span></a> <span class="LPAREN">(</span><span class="LIDENT">unwrap_cancelled</span> <a href="#local_state_151"><span class="LIDENT">state</span></a><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-fork_coroutine"><span class="LIDENT">fork_coroutine</span></span> <span class="TILDE">~</span><span id="local_sw_165"><span class="LIDENT">sw</span></span> <span id="local_fn_166"><span class="LIDENT">fn</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_state_167"><span class="LIDENT">state</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-make"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">make</span></a> <span class="BACKQUOTE">`</span><span class="UIDENT">Init</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LIDENT">fork_daemon</span> <span class="TILDE">~</span><a href="#local_sw_165"><span class="LIDENT">sw</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="TRY">try</span><span class="EOL">
</span>        <span class="LIDENT">run_coroutine</span> <span class="TILDE">~</span><a href="#local_state_167"><span class="LIDENT">state</span></a> <a href="#local_fn_166"><span class="LIDENT">fn</span></a><span class="SEMI">;</span><span class="EOL">
</span>        <span class="BACKQUOTE">`</span><span class="UIDENT">Stop_daemon</span><span class="EOL">
</span>      <span class="WITH">with</span> <span id="local_ex_168"><span class="LIDENT">ex</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="MATCH">match</span> <a href="#local_ex_168"><span class="LIDENT">ex</span></a><span class="COMMA">,</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-exchange"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">exchange</span></a> <a href="#local_state_167"><span class="LIDENT">state</span></a> <span class="LPAREN">(</span><span class="BACKQUOTE">`</span><span class="UIDENT">Failed</span> <a href="#local_ex_168"><span class="LIDENT">ex</span></a><span class="RPAREN">)</span> <span class="WITH">with</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Running</span> <span id="local_enqueue_169"><span class="LIDENT">enqueue</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <span class="COMMENT">(* A client is waiting for us. Send the error there. Also do this if we were cancelled. *)</span><span class="EOL">
</span>            <a href="#local_enqueue_169"><span class="LIDENT">enqueue</span></a> <span class="LPAREN">(</span><span class="UIDENT">Error</span> <a href="#local_ex_168"><span class="LIDENT">ex</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>            <span class="BACKQUOTE">`</span><span class="UIDENT">Stop_daemon</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="UIDENT">Cancelled</span> <span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <span class="COMMENT">(* The client isn't waiting (probably it got cancelled, then we tried to yield to it and got cancelled too).
               If it tries to resume us later it will see the error. *)</span><span class="EOL">
</span>            <span class="BACKQUOTE">`</span><span class="UIDENT">Stop_daemon</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <span class="COMMENT">(* Something unexpected happened. Re-raise. *)</span><span class="EOL">
</span>            <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-raise"><span class="LIDENT">raise</span></a> <a href="#local_ex_168"><span class="LIDENT">ex</span></a><span class="EOL">
</span>    <span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>  <span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="suspend.ml.html#val-enter"><span class="UIDENT">Suspend</span><span class="DOT">.</span><span class="LIDENT">enter</span></a> <span class="STRING">&quot;await-producer&quot;</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_ctx_170"><span class="LIDENT">ctx</span></span> <span id="local_enqueue_171"><span class="LIDENT">enqueue</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <span class="LET">let</span> <span class="REC">rec</span> <span id="local_aux_172"><span class="LIDENT">aux</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>          <span class="MATCH">match</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-get"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">get</span></a> <a href="#local_state_167"><span class="LIDENT">state</span></a> <span class="WITH">with</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Ready</span> <span id="local_resume_174"><span class="LIDENT">resume</span></span> <span class="AS">as</span> <span id="local_prev_173"><span class="LIDENT">prev</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <span class="LET">let</span> <span id="local_running_175"><span class="LIDENT">running</span></span> <span class="EQUAL">=</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Running</span> <a href="#local_enqueue_171"><span class="LIDENT">enqueue</span></a> <span class="IN">in</span><span class="EOL">
</span>            <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-compare_and_set"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">compare_and_set</span></a> <a href="#local_state_167"><span class="LIDENT">state</span></a> <a href="#local_prev_173"><span class="LIDENT">prev</span></a> <a href="#local_running_175"><span class="LIDENT">running</span></a> <span class="THEN">then</span> <span class="LPAREN">(</span><span class="EOL">
</span>              <a href="#local_resume_174"><span class="LIDENT">resume</span></a> <span class="LPAREN">(</span><span class="UIDENT">Ok</span> <a href="#local_running_175"><span class="LIDENT">running</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>              <a href="cancel.ml.html#module-Fiber_context.val-set_cancel_fn"><span class="UIDENT">Cancel</span><span class="DOT">.</span><span class="UIDENT">Fiber_context</span><span class="DOT">.</span><span class="LIDENT">set_cancel_fn</span></a> <a href="#local_ctx_170"><span class="LIDENT">ctx</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_ex_176"><span class="LIDENT">ex</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>                  <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-compare_and_set"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">compare_and_set</span></a> <a href="#local_state_167"><span class="LIDENT">state</span></a> <a href="#local_running_175"><span class="LIDENT">running</span></a> <span class="LPAREN">(</span><span class="BACKQUOTE">`</span><span class="UIDENT">Client_cancelled</span> <a href="#local_ex_176"><span class="LIDENT">ex</span></a><span class="RPAREN">)</span> <span class="THEN">then</span><span class="EOL">
</span>                    <a href="#local_enqueue_171"><span class="LIDENT">enqueue</span></a> <span class="LPAREN">(</span><span class="UIDENT">Error</span> <a href="#local_ex_176"><span class="LIDENT">ex</span></a><span class="RPAREN">)</span><span class="EOL">
</span>                <span class="RPAREN">)</span><span class="EOL">
</span>            <span class="RPAREN">)</span> <span class="ELSE">else</span> <a href="#local_aux_172"><span class="LIDENT">aux</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Finished</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_enqueue_171"><span class="LIDENT">enqueue</span></a> <span class="LPAREN">(</span><span class="UIDENT">Error</span> <span class="LPAREN">(</span><span class="UIDENT">Invalid_argument</span> <span class="STRING">&quot;Coroutine has already finished!&quot;</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Failed</span> <span id="local_ex_177"><span class="LIDENT">ex</span></span> <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Client_cancelled</span> <span id="local_ex_178"><span class="LIDENT">ex</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_enqueue_171"><span class="LIDENT">enqueue</span></a> <span class="LPAREN">(</span><span class="UIDENT">Error</span> <span class="LPAREN">(</span><span class="UIDENT">Invalid_argument</span> <span class="LPAREN">(</span><span class="STRING">&quot;Coroutine has already failed: &quot;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(^)"><span class="INFIXOP1">^</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/printexc.ml.html#val-to_string"><span class="UIDENT">Printexc</span><span class="DOT">.</span><span class="LIDENT">to_string</span></a> <a href="#local_ex_178"><span class="LIDENT">ex</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Running</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_enqueue_171"><span class="LIDENT">enqueue</span></a> <span class="LPAREN">(</span><span class="UIDENT">Error</span> <span class="LPAREN">(</span><span class="UIDENT">Invalid_argument</span> <span class="STRING">&quot;Coroutine is still running!&quot;</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>          <span class="BAR">|</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Init</span> <span class="MINUSGREATER">-&gt;</span> <span class="ASSERT">assert</span> <span class="FALSE">false</span><span class="EOL">
</span>        <span class="IN">in</span><span class="EOL">
</span>        <a href="#local_aux_172"><span class="LIDENT">aux</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-fork_seq"><span class="LIDENT">fork_seq</span></span> <span class="TILDE">~</span><span id="local_sw_179"><span class="LIDENT">sw</span></span> <span id="local_fn_180"><span class="LIDENT">fn</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="../../../ocaml-base-compiler/src/stdlib/seq.ml.html#val-of_dispenser"><span class="UIDENT">Seq</span><span class="DOT">.</span><span class="LIDENT">of_dispenser</span></a> <span class="LPAREN">(</span><span class="LIDENT">fork_coroutine</span> <span class="TILDE">~</span><a href="#local_sw_179"><span class="LIDENT">sw</span></a> <a href="#local_fn_180"><span class="LIDENT">fn</span></a><span class="RPAREN">)</span><span class="EOL">
</span></span></code></pre></body></html>
