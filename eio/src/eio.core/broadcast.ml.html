<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Source: broadcast.ml (eio.src.eio.core)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.css"/><meta name="generator" content="odoc %%VERSION%%"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/></head><body class="odoc-src"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">eio</a> &#x00BB; <a href="../index.html">Sources</a> &#x00BB; eio.core &#x00BB; broadcast.ml</nav><header class="odoc-preamble"><h1>Source file <code><span>broadcast.ml</span></code></h1></header><div class="odoc-tocs"><nav class="odoc-toc odoc-global-toc"><ul><li><a href="../../index.html">eio</a><ul><li>Library <code>eio</code><ul><li><a href="../../eio/Eio/index.html">Eio</a></li></ul></li><li>Library <code>eio.core</code></li><li>Library <code>eio.mock</code><ul><li><a href="../../eio.mock/Eio_mock/index.html">Eio_mock</a></li></ul></li><li>Library <code>eio.runtime_events</code><ul><li><a href="../../eio.runtime_events/Eio_runtime_events/index.html">Eio_runtime_events</a></li></ul></li><li>Library <code>eio.unix</code><ul><li><a href="../../eio.unix/Eio_unix/index.html">Eio_unix</a></li></ul></li><li>Library <code>eio.utils</code><ul><li><a href="../../eio.utils/Eio_utils/index.html">Eio_utils</a></li></ul></li><li><a href="../index.html">Sources</a><ul><li>eio<ul><li><a href="../eio/buf_read.ml.html">buf_read.ml</a></li><li><a href="../eio/buf_write.ml.html">buf_write.ml</a></li><li><a href="../eio/condition.ml.html">condition.ml</a></li><li><a href="../eio/domain_manager.ml.html">domain_manager.ml</a></li><li><a href="../eio/eio.ml.html">eio.ml</a></li><li><a href="../eio/eio__.ml.html">eio__.ml</a></li><li><a href="../eio/eio_mutex.ml.html">eio_mutex.ml</a></li><li><a href="../eio/executor_pool.ml.html">executor_pool.ml</a></li><li><a href="../eio/file.ml.html">file.ml</a></li><li><a href="../eio/flow.ml.html">flow.ml</a></li><li><a href="../eio/fs.ml.html">fs.ml</a></li><li><a href="../eio/hook.ml.html">hook.ml</a></li><li><a href="../eio/lazy.ml.html">lazy.ml</a></li><li><a href="../eio/net.ml.html">net.ml</a></li><li><a href="../eio/path.ml.html">path.ml</a></li><li><a href="../eio/pool.ml.html">pool.ml</a></li><li><a href="../eio/process.ml.html">process.ml</a></li><li><a href="../eio/resource.ml.html">resource.ml</a></li><li><a href="../eio/sem_state.ml.html">sem_state.ml</a></li><li><a href="../eio/semaphore.ml.html">semaphore.ml</a></li><li><a href="../eio/std.ml.html">std.ml</a></li><li><a href="../eio/stream.ml.html">stream.ml</a></li><li><a href="../eio/sync.ml.html">sync.ml</a></li><li><a href="../eio/time.ml.html">time.ml</a></li><li><a href="../eio/waiters.ml.html">waiters.ml</a></li></ul></li><li>eio.core<ul><li><a href="#" class="current_unit">broadcast.ml</a></li><li><a href="cancel.ml.html">cancel.ml</a></li><li><a href="cells.ml.html">cells.ml</a></li><li><a href="debug.ml.html">debug.ml</a></li><li><a href="dla.ml.html">dla.ml</a></li><li><a href="eio__core.ml.html">eio__core.ml</a></li><li><a href="eio__core__.ml.html">eio__core__.ml</a></li><li><a href="exn.ml.html">exn.ml</a></li><li><a href="fiber.ml.html">fiber.ml</a></li><li><a href="promise.ml.html">promise.ml</a></li><li><a href="single_waiter.ml.html">single_waiter.ml</a></li><li><a href="suspend.ml.html">suspend.ml</a></li><li><a href="switch.ml.html">switch.ml</a></li><li><a href="trace.ml.html">trace.ml</a></li></ul></li><li>eio.mock<ul><li><a href="../eio.mock/action.ml.html">action.ml</a></li><li><a href="../eio.mock/backend.ml.html">backend.ml</a></li><li><a href="../eio.mock/clock.ml.html">clock.ml</a></li><li><a href="../eio.mock/domain_manager.ml.html">domain_manager.ml</a></li><li><a href="../eio.mock/eio_mock.ml.html">eio_mock.ml</a></li><li><a href="../eio.mock/eio_mock__.ml.html">eio_mock__.ml</a></li><li><a href="../eio.mock/flow.ml.html">flow.ml</a></li><li><a href="../eio.mock/handler.ml.html">handler.ml</a></li><li><a href="../eio.mock/net.ml.html">net.ml</a></li></ul></li><li>eio.runtime_events<ul><li><a href="../eio.runtime_events/eio_runtime_events.ml.html">eio_runtime_events.ml</a></li></ul></li><li>eio.unix<ul><li><a href="../eio.unix/cap.ml.html">cap.ml</a></li><li><a href="../eio.unix/eio_unix.ml.html">eio_unix.ml</a></li><li><a href="../eio.unix/eio_unix__.ml.html">eio_unix__.ml</a></li><li><a href="../eio.unix/fd.ml.html">fd.ml</a></li><li><a href="../eio.unix/fork_action.ml.html">fork_action.ml</a></li><li><a href="../eio.unix/inherit_fds.ml.html">inherit_fds.ml</a></li><li><a href="../eio.unix/net.ml.html">net.ml</a></li><li><a href="../eio.unix/pi.ml.html">pi.ml</a></li><li><a href="../eio.unix/private.ml.html">private.ml</a></li><li><a href="../eio.unix/process.ml.html">process.ml</a></li><li><a href="../eio.unix/rcfd.ml.html">rcfd.ml</a></li><li><a href="../eio.unix/resource.ml.html">resource.ml</a></li><li><a href="../eio.unix/thread_pool.ml.html">thread_pool.ml</a></li><li><a href="../eio.unix/types.ml.html">types.ml</a></li></ul></li><li>eio.utils<ul><li><a href="../eio.utils/eio_utils.ml.html">eio_utils.ml</a></li><li><a href="../eio.utils/eio_utils__.ml.html">eio_utils__.ml</a></li><li><a href="../eio.utils/lf_queue.ml.html">lf_queue.ml</a></li><li><a href="../eio.utils/suspended.ml.html">suspended.ml</a></li><li><a href="../eio.utils/zzz.ml.html">zzz.ml</a></li></ul></li></ul></li></ul></li></ul></nav></div><pre class="source_container"><code class="source_line_column"><a id="L1" class="source_line" href="#L1">1</a>
<a id="L2" class="source_line" href="#L2">2</a>
<a id="L3" class="source_line" href="#L3">3</a>
<a id="L4" class="source_line" href="#L4">4</a>
<a id="L5" class="source_line" href="#L5">5</a>
<a id="L6" class="source_line" href="#L6">6</a>
<a id="L7" class="source_line" href="#L7">7</a>
<a id="L8" class="source_line" href="#L8">8</a>
<a id="L9" class="source_line" href="#L9">9</a>
<a id="L10" class="source_line" href="#L10">10</a>
<a id="L11" class="source_line" href="#L11">11</a>
<a id="L12" class="source_line" href="#L12">12</a>
<a id="L13" class="source_line" href="#L13">13</a>
<a id="L14" class="source_line" href="#L14">14</a>
<a id="L15" class="source_line" href="#L15">15</a>
<a id="L16" class="source_line" href="#L16">16</a>
<a id="L17" class="source_line" href="#L17">17</a>
<a id="L18" class="source_line" href="#L18">18</a>
<a id="L19" class="source_line" href="#L19">19</a>
<a id="L20" class="source_line" href="#L20">20</a>
<a id="L21" class="source_line" href="#L21">21</a>
<a id="L22" class="source_line" href="#L22">22</a>
<a id="L23" class="source_line" href="#L23">23</a>
<a id="L24" class="source_line" href="#L24">24</a>
<a id="L25" class="source_line" href="#L25">25</a>
<a id="L26" class="source_line" href="#L26">26</a>
<a id="L27" class="source_line" href="#L27">27</a>
<a id="L28" class="source_line" href="#L28">28</a>
<a id="L29" class="source_line" href="#L29">29</a>
<a id="L30" class="source_line" href="#L30">30</a>
<a id="L31" class="source_line" href="#L31">31</a>
<a id="L32" class="source_line" href="#L32">32</a>
<a id="L33" class="source_line" href="#L33">33</a>
<a id="L34" class="source_line" href="#L34">34</a>
<a id="L35" class="source_line" href="#L35">35</a>
<a id="L36" class="source_line" href="#L36">36</a>
<a id="L37" class="source_line" href="#L37">37</a>
<a id="L38" class="source_line" href="#L38">38</a>
<a id="L39" class="source_line" href="#L39">39</a>
<a id="L40" class="source_line" href="#L40">40</a>
<a id="L41" class="source_line" href="#L41">41</a>
<a id="L42" class="source_line" href="#L42">42</a>
<a id="L43" class="source_line" href="#L43">43</a>
<a id="L44" class="source_line" href="#L44">44</a>
<a id="L45" class="source_line" href="#L45">45</a>
<a id="L46" class="source_line" href="#L46">46</a>
<a id="L47" class="source_line" href="#L47">47</a>
<a id="L48" class="source_line" href="#L48">48</a>
<a id="L49" class="source_line" href="#L49">49</a>
<a id="L50" class="source_line" href="#L50">50</a>
<a id="L51" class="source_line" href="#L51">51</a>
<a id="L52" class="source_line" href="#L52">52</a>
<a id="L53" class="source_line" href="#L53">53</a>
<a id="L54" class="source_line" href="#L54">54</a>
<a id="L55" class="source_line" href="#L55">55</a>
<a id="L56" class="source_line" href="#L56">56</a>
<a id="L57" class="source_line" href="#L57">57</a>
<a id="L58" class="source_line" href="#L58">58</a>
<a id="L59" class="source_line" href="#L59">59</a>
<a id="L60" class="source_line" href="#L60">60</a>
<a id="L61" class="source_line" href="#L61">61</a>
<a id="L62" class="source_line" href="#L62">62</a>
<a id="L63" class="source_line" href="#L63">63</a>
<a id="L64" class="source_line" href="#L64">64</a>
<a id="L65" class="source_line" href="#L65">65</a>
<a id="L66" class="source_line" href="#L66">66</a>
<a id="L67" class="source_line" href="#L67">67</a>
<a id="L68" class="source_line" href="#L68">68</a>
<a id="L69" class="source_line" href="#L69">69</a>
<a id="L70" class="source_line" href="#L70">70</a>
<a id="L71" class="source_line" href="#L71">71</a>
<a id="L72" class="source_line" href="#L72">72</a>
<a id="L73" class="source_line" href="#L73">73</a>
<a id="L74" class="source_line" href="#L74">74</a>
<a id="L75" class="source_line" href="#L75">75</a>
<a id="L76" class="source_line" href="#L76">76</a>
<a id="L77" class="source_line" href="#L77">77</a>
<a id="L78" class="source_line" href="#L78">78</a>
<a id="L79" class="source_line" href="#L79">79</a>
<a id="L80" class="source_line" href="#L80">80</a>
<a id="L81" class="source_line" href="#L81">81</a>
<a id="L82" class="source_line" href="#L82">82</a>
<a id="L83" class="source_line" href="#L83">83</a>
<a id="L84" class="source_line" href="#L84">84</a>
<a id="L85" class="source_line" href="#L85">85</a>
<a id="L86" class="source_line" href="#L86">86</a>
<a id="L87" class="source_line" href="#L87">87</a>
<a id="L88" class="source_line" href="#L88">88</a>
<a id="L89" class="source_line" href="#L89">89</a>
<a id="L90" class="source_line" href="#L90">90</a>
<a id="L91" class="source_line" href="#L91">91</a>
<a id="L92" class="source_line" href="#L92">92</a>
<a id="L93" class="source_line" href="#L93">93</a>
<a id="L94" class="source_line" href="#L94">94</a>
<a id="L95" class="source_line" href="#L95">95</a>
<a id="L96" class="source_line" href="#L96">96</a>
<a id="L97" class="source_line" href="#L97">97</a>
<a id="L98" class="source_line" href="#L98">98</a>
<a id="L99" class="source_line" href="#L99">99</a>
<a id="L100" class="source_line" href="#L100">100</a>
<a id="L101" class="source_line" href="#L101">101</a>
<a id="L102" class="source_line" href="#L102">102</a>
<a id="L103" class="source_line" href="#L103">103</a>
<a id="L104" class="source_line" href="#L104">104</a>
<a id="L105" class="source_line" href="#L105">105</a>
<a id="L106" class="source_line" href="#L106">106</a>
<a id="L107" class="source_line" href="#L107">107</a>
<a id="L108" class="source_line" href="#L108">108</a>
</code><code class="source_code"><span><span class="COMMENT">(* See the Cells module for an overview of this system.

   Each new waiter atomically increments the &quot;suspend&quot; pointer and writes
   a callback there. The waking fiber removes all the callbacks and calls them.
   In this version, &quot;resume&quot; never gets ahead of &quot;suspend&quot; (broadcasting just
   brings it up-to-date with the &quot;suspend&quot; pointer).

   When the resume fiber runs, some of the cells reserved for callbacks might
   not yet have been filled. In this case, the resuming fiber just marks them
   as needing to be resumed. When the suspending fiber continues, it will
   notice this and continue immediately. *)</span><span class="EOL">
</span><span class="EOL">
</span><span id="module-Cell"><span class="MODULE">module</span> <span class="UIDENT">Cell</span> <span class="EQUAL">=</span> <span class="STRUCT">struct</span><span class="EOL">
</span>  <span class="COMMENT">(* For any given cell, there are two actors running in parallel: the
     suspender and the resumer.

     The resumer only performs a single operation (resume).

     The consumer waits to be resumed and then, optionally, cancels.

     This means we only have three cases to think about:

     1. Consumer adds request (Empty -&gt; Request).
        1a. Provider fulfills it (Request -&gt; Resumed).
        1b. Consumer cancels it (Request -&gt; Cancelled).
     2. Provider gets to cell first (Empty -&gt; Resumed).
        When the consumer tries to wait, it resumes immediately.

     The Resumed state should never been seen. It exists only to allow the
     request to be GC'd promptly. We could replace it with Empty, but having
     separate states is clearer for debugging. *)</span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Cell.type-t"><span class="TYPE">type</span> <span class="UNDERSCORE">_</span> <span class="LIDENT">t</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span id="module-Cell.type-t.constructor-Request"><span class="BAR">|</span> <span class="UIDENT">Request</span> <span class="OF">of</span> <span class="LPAREN">(</span><span class="LIDENT">unit</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span><span class="RPAREN">)</span></span><span class="EOL">
</span>    <span id="module-Cell.type-t.constructor-Cancelled"><span class="BAR">|</span> <span class="UIDENT">Cancelled</span></span><span class="EOL">
</span>    <span id="module-Cell.type-t.constructor-Resumed"><span class="BAR">|</span> <span class="UIDENT">Resumed</span></span><span class="EOL">
</span>    <span id="module-Cell.type-t.constructor-Empty"><span class="BAR">|</span> <span class="UIDENT">Empty</span></span></span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Cell.val-init"><span class="LIDENT">init</span></span> <span class="EQUAL">=</span> <span class="UIDENT">Empty</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Cell.val-segment_order"><span class="LIDENT">segment_order</span></span> <span class="EQUAL">=</span> <span class="INT">2</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Cell.val-dump"><span class="LIDENT">dump</span></span> <span id="local_f_1"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span> <span class="FUNCTION">function</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Request</span> <span class="UNDERSCORE">_</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Fmt</span><span class="DOT">.</span><span class="LIDENT">string</span> <a href="#local_f_1"><span class="LIDENT">f</span></a> <span class="STRING">&quot;Request&quot;</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Empty</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Fmt</span><span class="DOT">.</span><span class="LIDENT">string</span> <a href="#local_f_1"><span class="LIDENT">f</span></a> <span class="STRING">&quot;Empty&quot;</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Resumed</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Fmt</span><span class="DOT">.</span><span class="LIDENT">string</span> <a href="#local_f_1"><span class="LIDENT">f</span></a> <span class="STRING">&quot;Resumed&quot;</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Cancelled</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Fmt</span><span class="DOT">.</span><span class="LIDENT">string</span> <a href="#local_f_1"><span class="LIDENT">f</span></a> <span class="STRING">&quot;Cancelled&quot;</span><span class="EOL">
</span><span class="END">end</span></span><span class="EOL">
</span><span class="EOL">
</span><span id="module-Cells"><span class="MODULE">module</span> <span class="UIDENT">Cells</span> <span class="EQUAL">=</span> <a href="cells.ml.html#module-Make"><span class="UIDENT">Cells</span><span class="DOT">.</span><span class="UIDENT">Make</span></a><span class="LPAREN">(</span><span class="UIDENT">Cell</span><span class="RPAREN">)</span></span><span class="EOL">
</span><span class="EOL">
</span><span id="type-cell"><span class="TYPE">type</span> <span class="LIDENT">cell</span> <span class="EQUAL">=</span> <span class="LIDENT">unit</span> <span class="UIDENT">Cell</span><span class="DOT">.</span><span class="LIDENT">t</span></span><span class="EOL">
</span><span id="type-t"><span class="TYPE">type</span> <span class="LIDENT">t</span> <span class="EQUAL">=</span> <span class="LIDENT">unit</span> <span class="UIDENT">Cells</span><span class="DOT">.</span><span class="LIDENT">t</span></span><span class="EOL">
</span><span class="EOL">
</span><span id="type-request"><span class="TYPE">type</span> <span class="LIDENT">request</span> <span class="EQUAL">=</span> <span class="LIDENT">unit</span> <span class="UIDENT">Cells</span><span class="DOT">.</span><span class="LIDENT">segment</span> <span class="STAR">*</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#type-t"><span class="LIDENT">cell</span> <span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">t</span></a></span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span class="REC">rec</span> <span id="val-resume"><span class="LIDENT">resume</span></span> <span id="local_cell_2"><span class="LIDENT">cell</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="MATCH">match</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-get"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">get</span></a> <a href="#local_cell_2"><span class="LIDENT">cell</span></a> <span class="COLON">:</span> <span class="LIDENT">cell</span><span class="RPAREN">)</span> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Request</span> <span id="local_r_4"><span class="LIDENT">r</span></span> <span class="AS">as</span> <span id="local_cur_3"><span class="LIDENT">cur</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="COMMENT">(* The common case: we have a waiter for the value *)</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-compare_and_set"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">compare_and_set</span></a> <a href="#local_cell_2"><span class="LIDENT">cell</span></a> <a href="#local_cur_3"><span class="LIDENT">cur</span></a> <span class="UIDENT">Resumed</span> <span class="THEN">then</span> <a href="#local_r_4"><span class="LIDENT">r</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="COMMENT">(* else it was cancelled at the same time; ignore *)</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Empty</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="COMMENT">(* The consumer has reserved this cell but not yet stored the request.
       We place Resumed there and it will handle it soon. *)</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-compare_and_set"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">compare_and_set</span></a> <a href="#local_cell_2"><span class="LIDENT">cell</span></a> <span class="UIDENT">Empty</span> <span class="UIDENT">Resumed</span> <span class="THEN">then</span><span class="EOL">
</span>      <span class="LPAREN">(</span><span class="RPAREN">)</span>                <span class="COMMENT">(* The consumer will deal with it *)</span><span class="EOL">
</span>    <span class="ELSE">else</span><span class="EOL">
</span>      <span class="LIDENT">resume</span> <a href="#local_cell_2"><span class="LIDENT">cell</span></a>       <span class="COMMENT">(* The Request was added concurrently; use it *)</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Cancelled</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Resumed</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="COMMENT">(* This state is unreachable because we (the provider) haven't set this yet *)</span><span class="EOL">
</span>    <span class="ASSERT">assert</span> <span class="FALSE">false</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-cancel"><span class="LIDENT">cancel</span></span> <span class="LPAREN">(</span><span id="local_segment_5"><span class="LIDENT">segment</span></span><span class="COMMA">,</span> <span id="local_cell_6"><span class="LIDENT">cell</span></span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="MATCH">match</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-get"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">get</span></a> <a href="#local_cell_6"><span class="LIDENT">cell</span></a> <span class="COLON">:</span> <span class="LIDENT">cell</span><span class="RPAREN">)</span> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Request</span> <span class="UNDERSCORE">_</span> <span class="AS">as</span> <span id="local_old_7"><span class="LIDENT">old</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-compare_and_set"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">compare_and_set</span></a> <a href="#local_cell_6"><span class="LIDENT">cell</span></a> <a href="#local_old_7"><span class="LIDENT">old</span></a> <span class="UIDENT">Cancelled</span> <span class="THEN">then</span> <span class="LPAREN">(</span><span class="EOL">
</span>      <span class="UIDENT">Cells</span><span class="DOT">.</span><span class="LIDENT">cancel_cell</span> <a href="#local_segment_5"><span class="LIDENT">segment</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <span class="TRUE">true</span><span class="EOL">
</span>    <span class="RPAREN">)</span> <span class="ELSE">else</span> <span class="FALSE">false</span>          <span class="COMMENT">(* We got resumed first *)</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Resumed</span> <span class="MINUSGREATER">-&gt;</span> <span class="FALSE">false</span>      <span class="COMMENT">(* We got resumed first *)</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Cancelled</span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-invalid_arg"><span class="LIDENT">invalid_arg</span></a> <span class="STRING">&quot;Already cancelled!&quot;</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Empty</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="COMMENT">(* To call [cancel] the user needs a [request] value,
       which they only get once we've reached the [Request] state.
       [Empty] is unreachable from [Request]. *)</span><span class="EOL">
</span>    <span class="ASSERT">assert</span> <span class="FALSE">false</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-suspend"><span class="LIDENT">suspend</span></span> <span id="local_t_8"><span class="LIDENT">t</span></span> <span id="local_k_9"><span class="LIDENT">k</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="def_15"><span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span id="local_cell_11"><span class="LIDENT">cell</span></span><span class="RPAREN">)</span> <span class="AS">as</span> <span id="local_request_10"><span class="LIDENT">request</span></span></span> <span class="EQUAL">=</span> <span class="UIDENT">Cells</span><span class="DOT">.</span><span class="LIDENT">next_suspend</span> <a href="#local_t_8"><span class="LIDENT">t</span></a> <span class="IN">in</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-compare_and_set"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">compare_and_set</span></a> <a href="#local_cell_11"><span class="LIDENT">cell</span></a> <span class="UIDENT">Empty</span> <span class="LPAREN">(</span><span class="UIDENT">Request</span> <a href="#local_k_9"><span class="LIDENT">k</span></a><span class="RPAREN">)</span> <span class="THEN">then</span> <span class="UIDENT">Some</span> <a href="#local_request_10"><span class="LIDENT">request</span></a><span class="EOL">
</span>  <span class="ELSE">else</span> <span class="MATCH">match</span> <a href="../../../ocaml-base-compiler/src/stdlib/atomic.ml.html#val-get"><span class="UIDENT">Atomic</span><span class="DOT">.</span><span class="LIDENT">get</span></a> <a href="#local_cell_11"><span class="LIDENT">cell</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Resumed</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="COMMENT">(* Resumed before we could add the waiter *)</span><span class="EOL">
</span>      <a href="#local_k_9"><span class="LIDENT">k</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>      <span class="UIDENT">None</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Cancelled</span> <span class="BAR">|</span> <span class="UIDENT">Request</span> <span class="UNDERSCORE">_</span> <span class="BAR">|</span> <span class="UIDENT">Empty</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="COMMENT">(* These are unreachable from the previously-observed non-Empty state
         without us taking some action first *)</span><span class="EOL">
</span>      <span class="ASSERT">assert</span> <span class="FALSE">false</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-resume_all"><span class="LIDENT">resume_all</span></span> <span id="local_t_12"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="UIDENT">Cells</span><span class="DOT">.</span><span class="LIDENT">resume_all</span> <a href="#local_t_12"><span class="LIDENT">t</span></a> <span class="LIDENT">resume</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-create"><span class="LIDENT">create</span></span> <span class="EQUAL">=</span> <span class="UIDENT">Cells</span><span class="DOT">.</span><span class="LIDENT">make</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-dump"><span class="LIDENT">dump</span></span> <span id="local_f_13"><span class="LIDENT">f</span></span> <span id="local_t_14"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span> <span class="UIDENT">Cells</span><span class="DOT">.</span><span class="LIDENT">dump</span> <a href="#local_f_13"><span class="LIDENT">f</span></a> <a href="#local_t_14"><span class="LIDENT">t</span></a><span class="EOL">
</span></span></code></pre></body></html>
