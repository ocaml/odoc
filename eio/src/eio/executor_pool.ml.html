<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Source: executor_pool.ml (eio.src.eio)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.css"/><meta name="generator" content="odoc %%VERSION%%"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/></head><body class="odoc-src"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">eio</a> &#x00BB; <a href="../index.html">Sources</a> &#x00BB; eio &#x00BB; executor_pool.ml</nav><header class="odoc-preamble"><h1>Source file <code><span>executor_pool.ml</span></code></h1></header><div class="odoc-tocs"><nav class="odoc-toc odoc-global-toc"><ul><li><a href="../../index.html">eio</a><ul><li>Library <code>eio</code><ul><li><a href="../../eio/Eio/index.html">Eio</a></li></ul></li><li>Library <code>eio.core</code></li><li>Library <code>eio.mock</code><ul><li><a href="../../eio.mock/Eio_mock/index.html">Eio_mock</a></li></ul></li><li>Library <code>eio.runtime_events</code><ul><li><a href="../../eio.runtime_events/Eio_runtime_events/index.html">Eio_runtime_events</a></li></ul></li><li>Library <code>eio.unix</code><ul><li><a href="../../eio.unix/Eio_unix/index.html">Eio_unix</a></li></ul></li><li>Library <code>eio.utils</code><ul><li><a href="../../eio.utils/Eio_utils/index.html">Eio_utils</a></li></ul></li><li><a href="../index.html">Sources</a><ul><li>eio<ul><li><a href="buf_read.ml.html">buf_read.ml</a></li><li><a href="buf_write.ml.html">buf_write.ml</a></li><li><a href="condition.ml.html">condition.ml</a></li><li><a href="domain_manager.ml.html">domain_manager.ml</a></li><li><a href="eio.ml.html">eio.ml</a></li><li><a href="eio__.ml.html">eio__.ml</a></li><li><a href="eio_mutex.ml.html">eio_mutex.ml</a></li><li><a href="#" class="current_unit">executor_pool.ml</a></li><li><a href="file.ml.html">file.ml</a></li><li><a href="flow.ml.html">flow.ml</a></li><li><a href="fs.ml.html">fs.ml</a></li><li><a href="hook.ml.html">hook.ml</a></li><li><a href="lazy.ml.html">lazy.ml</a></li><li><a href="net.ml.html">net.ml</a></li><li><a href="path.ml.html">path.ml</a></li><li><a href="pool.ml.html">pool.ml</a></li><li><a href="process.ml.html">process.ml</a></li><li><a href="resource.ml.html">resource.ml</a></li><li><a href="sem_state.ml.html">sem_state.ml</a></li><li><a href="semaphore.ml.html">semaphore.ml</a></li><li><a href="std.ml.html">std.ml</a></li><li><a href="stream.ml.html">stream.ml</a></li><li><a href="sync.ml.html">sync.ml</a></li><li><a href="time.ml.html">time.ml</a></li><li><a href="waiters.ml.html">waiters.ml</a></li></ul></li><li>eio.core<ul><li><a href="../eio.core/broadcast.ml.html">broadcast.ml</a></li><li><a href="../eio.core/cancel.ml.html">cancel.ml</a></li><li><a href="../eio.core/cells.ml.html">cells.ml</a></li><li><a href="../eio.core/debug.ml.html">debug.ml</a></li><li><a href="../eio.core/dla.ml.html">dla.ml</a></li><li><a href="../eio.core/eio__core.ml.html">eio__core.ml</a></li><li><a href="../eio.core/eio__core__.ml.html">eio__core__.ml</a></li><li><a href="../eio.core/exn.ml.html">exn.ml</a></li><li><a href="../eio.core/fiber.ml.html">fiber.ml</a></li><li><a href="../eio.core/promise.ml.html">promise.ml</a></li><li><a href="../eio.core/single_waiter.ml.html">single_waiter.ml</a></li><li><a href="../eio.core/suspend.ml.html">suspend.ml</a></li><li><a href="../eio.core/switch.ml.html">switch.ml</a></li><li><a href="../eio.core/trace.ml.html">trace.ml</a></li></ul></li><li>eio.mock<ul><li><a href="../eio.mock/action.ml.html">action.ml</a></li><li><a href="../eio.mock/backend.ml.html">backend.ml</a></li><li><a href="../eio.mock/clock.ml.html">clock.ml</a></li><li><a href="../eio.mock/domain_manager.ml.html">domain_manager.ml</a></li><li><a href="../eio.mock/eio_mock.ml.html">eio_mock.ml</a></li><li><a href="../eio.mock/eio_mock__.ml.html">eio_mock__.ml</a></li><li><a href="../eio.mock/flow.ml.html">flow.ml</a></li><li><a href="../eio.mock/handler.ml.html">handler.ml</a></li><li><a href="../eio.mock/net.ml.html">net.ml</a></li></ul></li><li>eio.runtime_events<ul><li><a href="../eio.runtime_events/eio_runtime_events.ml.html">eio_runtime_events.ml</a></li></ul></li><li>eio.unix<ul><li><a href="../eio.unix/cap.ml.html">cap.ml</a></li><li><a href="../eio.unix/eio_unix.ml.html">eio_unix.ml</a></li><li><a href="../eio.unix/eio_unix__.ml.html">eio_unix__.ml</a></li><li><a href="../eio.unix/fd.ml.html">fd.ml</a></li><li><a href="../eio.unix/fork_action.ml.html">fork_action.ml</a></li><li><a href="../eio.unix/inherit_fds.ml.html">inherit_fds.ml</a></li><li><a href="../eio.unix/net.ml.html">net.ml</a></li><li><a href="../eio.unix/pi.ml.html">pi.ml</a></li><li><a href="../eio.unix/private.ml.html">private.ml</a></li><li><a href="../eio.unix/process.ml.html">process.ml</a></li><li><a href="../eio.unix/rcfd.ml.html">rcfd.ml</a></li><li><a href="../eio.unix/resource.ml.html">resource.ml</a></li><li><a href="../eio.unix/thread_pool.ml.html">thread_pool.ml</a></li><li><a href="../eio.unix/types.ml.html">types.ml</a></li></ul></li><li>eio.utils<ul><li><a href="../eio.utils/eio_utils.ml.html">eio_utils.ml</a></li><li><a href="../eio.utils/eio_utils__.ml.html">eio_utils__.ml</a></li><li><a href="../eio.utils/lf_queue.ml.html">lf_queue.ml</a></li><li><a href="../eio.utils/suspended.ml.html">suspended.ml</a></li><li><a href="../eio.utils/zzz.ml.html">zzz.ml</a></li></ul></li></ul></li></ul></li></ul></nav></div><pre class="source_container"><code class="source_line_column"><a id="L1" class="source_line" href="#L1">1</a>
<a id="L2" class="source_line" href="#L2">2</a>
<a id="L3" class="source_line" href="#L3">3</a>
<a id="L4" class="source_line" href="#L4">4</a>
<a id="L5" class="source_line" href="#L5">5</a>
<a id="L6" class="source_line" href="#L6">6</a>
<a id="L7" class="source_line" href="#L7">7</a>
<a id="L8" class="source_line" href="#L8">8</a>
<a id="L9" class="source_line" href="#L9">9</a>
<a id="L10" class="source_line" href="#L10">10</a>
<a id="L11" class="source_line" href="#L11">11</a>
<a id="L12" class="source_line" href="#L12">12</a>
<a id="L13" class="source_line" href="#L13">13</a>
<a id="L14" class="source_line" href="#L14">14</a>
<a id="L15" class="source_line" href="#L15">15</a>
<a id="L16" class="source_line" href="#L16">16</a>
<a id="L17" class="source_line" href="#L17">17</a>
<a id="L18" class="source_line" href="#L18">18</a>
<a id="L19" class="source_line" href="#L19">19</a>
<a id="L20" class="source_line" href="#L20">20</a>
<a id="L21" class="source_line" href="#L21">21</a>
<a id="L22" class="source_line" href="#L22">22</a>
<a id="L23" class="source_line" href="#L23">23</a>
<a id="L24" class="source_line" href="#L24">24</a>
<a id="L25" class="source_line" href="#L25">25</a>
<a id="L26" class="source_line" href="#L26">26</a>
<a id="L27" class="source_line" href="#L27">27</a>
<a id="L28" class="source_line" href="#L28">28</a>
<a id="L29" class="source_line" href="#L29">29</a>
<a id="L30" class="source_line" href="#L30">30</a>
<a id="L31" class="source_line" href="#L31">31</a>
<a id="L32" class="source_line" href="#L32">32</a>
<a id="L33" class="source_line" href="#L33">33</a>
<a id="L34" class="source_line" href="#L34">34</a>
<a id="L35" class="source_line" href="#L35">35</a>
<a id="L36" class="source_line" href="#L36">36</a>
<a id="L37" class="source_line" href="#L37">37</a>
<a id="L38" class="source_line" href="#L38">38</a>
<a id="L39" class="source_line" href="#L39">39</a>
<a id="L40" class="source_line" href="#L40">40</a>
<a id="L41" class="source_line" href="#L41">41</a>
<a id="L42" class="source_line" href="#L42">42</a>
<a id="L43" class="source_line" href="#L43">43</a>
<a id="L44" class="source_line" href="#L44">44</a>
<a id="L45" class="source_line" href="#L45">45</a>
<a id="L46" class="source_line" href="#L46">46</a>
<a id="L47" class="source_line" href="#L47">47</a>
<a id="L48" class="source_line" href="#L48">48</a>
<a id="L49" class="source_line" href="#L49">49</a>
<a id="L50" class="source_line" href="#L50">50</a>
<a id="L51" class="source_line" href="#L51">51</a>
<a id="L52" class="source_line" href="#L52">52</a>
<a id="L53" class="source_line" href="#L53">53</a>
<a id="L54" class="source_line" href="#L54">54</a>
<a id="L55" class="source_line" href="#L55">55</a>
<a id="L56" class="source_line" href="#L56">56</a>
<a id="L57" class="source_line" href="#L57">57</a>
<a id="L58" class="source_line" href="#L58">58</a>
<a id="L59" class="source_line" href="#L59">59</a>
<a id="L60" class="source_line" href="#L60">60</a>
<a id="L61" class="source_line" href="#L61">61</a>
<a id="L62" class="source_line" href="#L62">62</a>
<a id="L63" class="source_line" href="#L63">63</a>
<a id="L64" class="source_line" href="#L64">64</a>
<a id="L65" class="source_line" href="#L65">65</a>
<a id="L66" class="source_line" href="#L66">66</a>
<a id="L67" class="source_line" href="#L67">67</a>
<a id="L68" class="source_line" href="#L68">68</a>
<a id="L69" class="source_line" href="#L69">69</a>
<a id="L70" class="source_line" href="#L70">70</a>
<a id="L71" class="source_line" href="#L71">71</a>
<a id="L72" class="source_line" href="#L72">72</a>
<a id="L73" class="source_line" href="#L73">73</a>
<a id="L74" class="source_line" href="#L74">74</a>
</code><code class="source_code"><span><span id="type-job"><span class="TYPE">type</span> <span class="LIDENT">job</span> <span class="EQUAL">=</span> <span id="type-job.constructor-Pack"><span class="UIDENT">Pack</span> <span class="COLON">:</span> <span class="LBRACE">{</span><span class="EOL">
</span>    <span id="def_34"><span class="LIDENT">fn</span> <span class="COLON">:</span> <span class="LIDENT">unit</span> <span class="MINUSGREATER">-&gt;</span> <span class="QUOTE">'</span><span class="LIDENT">a</span><span class="SEMI">;</span></span><span class="EOL">
</span>    <span id="def_33"><span class="LIDENT">w</span> <span class="COLON">:</span> <a href="../eio.core/promise.ml.html#type-u"><a href="../../../ocaml-base-compiler/src/stdlib/result.ml.html#type-t"><span class="LPAREN">(</span><span class="QUOTE">'</span><span class="LIDENT">a</span><span class="COMMA">,</span> <span class="LIDENT">exn</span><span class="RPAREN">)</span> <span class="UIDENT">Result</span><span class="DOT">.</span><span class="LIDENT">t</span></a> <span class="UIDENT">Promise</span><span class="DOT">.</span><span class="LIDENT">u</span></a><span class="SEMI">;</span></span><span class="EOL">
</span>    <span id="def_32"><span class="LIDENT">weight</span> <span class="COLON">:</span> <span class="LIDENT">int</span><span class="SEMI">;</span></span><span class="EOL">
</span>  <span class="RBRACE">}</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">job</span></span></span><span class="EOL">
</span><span class="EOL">
</span><span id="type-t"><span class="TYPE">type</span> <span class="LIDENT">t</span> <span class="EQUAL">=</span> <span class="LBRACE">{</span><span class="EOL">
</span>  <span id="def_31"><span class="LIDENT">queue</span> <span class="COLON">:</span> <a href="sync.ml.html#type-t"><span class="LIDENT">job</span> <span class="UIDENT">Sync</span><span class="DOT">.</span><span class="LIDENT">t</span></a><span class="SEMI">;</span></span><span class="EOL">
</span><span class="RBRACE">}</span></span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-max_capacity"><span class="LIDENT">max_capacity</span></span> <span class="EQUAL">=</span> <span class="INT">1_000_000</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-max_capacity_f"><span class="LIDENT">max_capacity_f</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-float"><span class="LIDENT">float</span></a> <span class="LIDENT">max_capacity</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* This function is the core of executor_pool.ml.
   Each worker runs in its own domain,
   taking jobs from [queue] whenever it has spare capacity. *)</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-run_worker"><span class="LIDENT">run_worker</span></span> <span class="LBRACE">{</span> <span id="local_queue_1"><span class="LIDENT">queue</span></span> <span class="RBRACE">}</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="../eio.core/switch.ml.html#val-run"><span class="UIDENT">Switch</span><span class="DOT">.</span><span class="LIDENT">run</span></a> <span class="LABEL">~name:</span><span class="STRING">&quot;run_worker&quot;</span> <span class="INFIXOP1">@@</span> <span class="FUN">fun</span> <span id="local_sw_2"><span class="LIDENT">sw</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_capacity_3"><span class="LIDENT">capacity</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ref"><span class="LIDENT">ref</span></a> <span class="INT">0</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_condition_4"><span class="LIDENT">condition</span></span> <span class="EQUAL">=</span> <a href="condition.ml.html#val-create"><span class="UIDENT">Condition</span><span class="DOT">.</span><span class="LIDENT">create</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="COMMENT">(* The main worker loop. *)</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="REC">rec</span> <span id="local_loop_5"><span class="LIDENT">loop</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="WHILE">while</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="#local_capacity_3"><span class="LIDENT">capacity</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;=)"><span class="INFIXOP0">&gt;=</span></a> <span class="LIDENT">max_capacity</span> <span class="DO">do</span> <a href="condition.ml.html#val-await_no_mutex"><span class="UIDENT">Condition</span><span class="DOT">.</span><span class="LIDENT">await_no_mutex</span></a> <a href="#local_condition_4"><span class="LIDENT">condition</span></a> <span class="DONE">done</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="sync.ml.html#val-take"><span class="UIDENT">Sync</span><span class="DOT">.</span><span class="LIDENT">take</span></a> <a href="#local_queue_1"><span class="LIDENT">queue</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Error</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Closed</span> <span class="MINUSGREATER">-&gt;</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Stop_daemon</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Ok</span> <span class="LPAREN">(</span><span class="UIDENT">Pack</span> <span class="LBRACE">{</span> <span id="local_fn_6"><span class="LIDENT">fn</span></span><span class="SEMI">;</span> <span id="local_w_7"><span class="LIDENT">w</span></span><span class="SEMI">;</span> <span id="local_weight_8"><span class="LIDENT">weight</span></span> <span class="RBRACE">}</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="#local_capacity_3"><span class="LIDENT">capacity</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="#local_capacity_3"><span class="LIDENT">capacity</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <a href="#local_weight_8"><span class="LIDENT">weight</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/option.ml.html#val-iter"><span class="UIDENT">Option</span><span class="DOT">.</span><span class="LIDENT">iter</span></a> <span class="LPAREN">(</span><a href="../eio.core/promise.ml.html#val-resolve_error"><span class="UIDENT">Promise</span><span class="DOT">.</span><span class="LIDENT">resolve_error</span></a> <a href="#local_w_7"><span class="LIDENT">w</span></a><span class="RPAREN">)</span> <span class="LPAREN">(</span><a href="../eio.core/switch.ml.html#val-get_error"><span class="UIDENT">Switch</span><span class="DOT">.</span><span class="LIDENT">get_error</span></a> <a href="#local_sw_2"><span class="LIDENT">sw</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>      <a href="../eio.core/fiber.ml.html#val-fork"><span class="UIDENT">Fiber</span><span class="DOT">.</span><span class="LIDENT">fork</span></a> <span class="TILDE">~</span><a href="#local_sw_2"><span class="LIDENT">sw</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="../eio.core/promise.ml.html#val-resolve"><span class="UIDENT">Promise</span><span class="DOT">.</span><span class="LIDENT">resolve</span></a> <a href="#local_w_7"><span class="LIDENT">w</span></a> <span class="LPAREN">(</span><span class="TRY">try</span> <span class="UIDENT">Ok</span> <span class="LPAREN">(</span><a href="#local_fn_6"><span class="LIDENT">fn</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="RPAREN">)</span> <span class="WITH">with</span> <span id="local_ex_9"><span class="LIDENT">ex</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Error</span> <a href="#local_ex_9"><span class="LIDENT">ex</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>          <a href="#local_capacity_3"><span class="LIDENT">capacity</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="#local_capacity_3"><span class="LIDENT">capacity</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <a href="#local_weight_8"><span class="LIDENT">weight</span></a><span class="SEMI">;</span><span class="EOL">
</span>          <a href="condition.ml.html#val-broadcast"><span class="UIDENT">Condition</span><span class="DOT">.</span><span class="LIDENT">broadcast</span></a> <a href="#local_condition_4"><span class="LIDENT">condition</span></a><span class="EOL">
</span>        <span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>      <span class="COMMENT">(* Give a chance to other domains to start waiting on [queue]
         before the current thread blocks on [Sync.take] again. *)</span><span class="EOL">
</span>      <a href="../eio.core/fiber.ml.html#val-yield"><span class="UIDENT">Fiber</span><span class="DOT">.</span><span class="LIDENT">yield</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>      <a href="#local_loop_5"><span class="LPAREN">(</span><span class="LIDENT">loop</span> <span class="LBRACKETAT">[@</span><span class="LIDENT">tailcall</span><span class="RBRACKET">]</span><span class="RPAREN">)</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <a href="#local_loop_5"><span class="LIDENT">loop</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-create"><span class="LIDENT">create</span></span> <span class="TILDE">~</span><span id="local_sw_10"><span class="LIDENT">sw</span></span> <span class="TILDE">~</span><span id="local_domain_count_11"><span class="LIDENT">domain_count</span></span> <span id="local_domain_mgr_12"><span class="LIDENT">domain_mgr</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_queue_13"><span class="LIDENT">queue</span></span> <span class="EQUAL">=</span> <a href="sync.ml.html#val-create"><span class="UIDENT">Sync</span><span class="DOT">.</span><span class="LIDENT">create</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_t_14"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span> <span class="LBRACE">{</span> <a href="#local_queue_13"><span class="LIDENT">queue</span></a> <span class="RBRACE">}</span> <span class="IN">in</span><span class="EOL">
</span>  <a href="../eio.core/switch.ml.html#val-on_release"><span class="UIDENT">Switch</span><span class="DOT">.</span><span class="LIDENT">on_release</span></a> <a href="#local_sw_10"><span class="LIDENT">sw</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <a href="sync.ml.html#val-close"><span class="UIDENT">Sync</span><span class="DOT">.</span><span class="LIDENT">close</span></a> <a href="#local_queue_13"><span class="LIDENT">queue</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>  <span class="FOR">for</span> <span class="UNDERSCORE">_</span> <span class="EQUAL">=</span> <span class="INT">1</span> <span class="TO">to</span> <a href="#local_domain_count_11"><span class="LIDENT">domain_count</span></a> <span class="DO">do</span><span class="EOL">
</span>    <span class="COMMENT">(* Workers run as daemons to not hold the user's switch from completing.
       It's up to the user to hold the switch open (and thus, the executor pool)
       by blocking on the jobs issued to the pool. *)</span><span class="EOL">
</span>    <a href="../eio.core/fiber.ml.html#val-fork_daemon"><span class="UIDENT">Fiber</span><span class="DOT">.</span><span class="LIDENT">fork_daemon</span></a> <span class="TILDE">~</span><a href="#local_sw_10"><span class="LIDENT">sw</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <a href="domain_manager.ml.html#val-run"><span class="UIDENT">Domain_manager</span><span class="DOT">.</span><span class="LIDENT">run</span></a> <a href="#local_domain_mgr_12"><span class="LIDENT">domain_mgr</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <span class="LIDENT">run_worker</span> <a href="#local_t_14"><span class="LIDENT">t</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="DONE">done</span><span class="SEMI">;</span><span class="EOL">
</span>  <a href="#local_t_14"><span class="LIDENT">t</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-enqueue"><span class="LIDENT">enqueue</span></span> <span class="LBRACE">{</span> <span id="local_queue_15"><span class="LIDENT">queue</span></span> <span class="RBRACE">}</span> <span class="TILDE">~</span><span id="local_weight_16"><span class="LIDENT">weight</span></span> <span id="local_fn_17"><span class="LIDENT">fn</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-not"><span class="LIDENT">not</span></a> <span class="LPAREN">(</span><a href="#local_weight_16"><span class="LIDENT">weight</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;=)"><span class="INFIXOP0">&gt;=</span></a> <span class="FLOAT">0.</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&amp;&amp;)"><span class="AMPERAMPER">&amp;&amp;</span></a> <a href="#local_weight_16"><span class="LIDENT">weight</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;=)"><span class="INFIXOP0">&lt;=</span></a> <span class="FLOAT">1.</span><span class="RPAREN">)</span> <span class="COMMENT">(* Handles NaN *)</span><span class="EOL">
</span>  <span class="THEN">then</span> <span class="UIDENT">Fmt</span><span class="DOT">.</span><span class="LIDENT">invalid_arg</span> <span class="STRING">&quot;Executor_pool: weight %g not &gt;= 0.0 &amp;&amp; &lt;= 1.0&quot;</span> <a href="#local_weight_16"><span class="LIDENT">weight</span></a><span class="EOL">
</span>  <span class="ELSE">else</span> <span class="LPAREN">(</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_weight_18"><span class="LIDENT">weight</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/float.ml.html#val-to_int"><span class="UIDENT">Float</span><span class="DOT">.</span><span class="LIDENT">to_int</span></a> <span class="LPAREN">(</span><a href="#local_weight_16"><span class="LIDENT">weight</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(*.)"><span class="INFIXOP3">*.</span></a> <span class="LIDENT">max_capacity_f</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="def_35"><span id="local_p_19"><span class="LIDENT">p</span></span><span class="COMMA">,</span> <span id="local_w_20"><span class="LIDENT">w</span></span></span> <span class="EQUAL">=</span> <a href="../eio.core/promise.ml.html#val-create"><span class="UIDENT">Promise</span><span class="DOT">.</span><span class="LIDENT">create</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>    <a href="sync.ml.html#val-put"><span class="UIDENT">Sync</span><span class="DOT">.</span><span class="LIDENT">put</span></a> <a href="#local_queue_15"><span class="LIDENT">queue</span></a> <span class="LPAREN">(</span><span class="UIDENT">Pack</span> <span class="LBRACE">{</span> <a href="#local_fn_17"><span class="LIDENT">fn</span></a><span class="SEMI">;</span> <a href="#local_w_20"><span class="LIDENT">w</span></a><span class="SEMI">;</span> <a href="#local_weight_18"><span class="LIDENT">weight</span></a> <span class="RBRACE">}</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="#local_p_19"><span class="LIDENT">p</span></a><span class="EOL">
</span>  <span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-submit"><span class="LIDENT">submit</span></span> <span id="local_t_21"><span class="LIDENT">t</span></span> <span class="TILDE">~</span><span id="local_weight_22"><span class="LIDENT">weight</span></span> <span id="local_fn_23"><span class="LIDENT">fn</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">enqueue</span> <a href="#local_t_21"><span class="LIDENT">t</span></a> <span class="TILDE">~</span><a href="#local_weight_22"><span class="LIDENT">weight</span></a> <a href="#local_fn_23"><span class="LIDENT">fn</span></a> <span class="INFIXOP0">|&gt;</span> <a href="../eio.core/promise.ml.html#val-await"><span class="UIDENT">Promise</span><span class="DOT">.</span><span class="LIDENT">await</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-submit_exn"><span class="LIDENT">submit_exn</span></span> <span id="local_t_24"><span class="LIDENT">t</span></span> <span class="TILDE">~</span><span id="local_weight_25"><span class="LIDENT">weight</span></span> <span id="local_fn_26"><span class="LIDENT">fn</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">enqueue</span> <a href="#local_t_24"><span class="LIDENT">t</span></a> <span class="TILDE">~</span><a href="#local_weight_25"><span class="LIDENT">weight</span></a> <a href="#local_fn_26"><span class="LIDENT">fn</span></a> <span class="INFIXOP0">|&gt;</span> <a href="../eio.core/promise.ml.html#val-await_exn"><span class="UIDENT">Promise</span><span class="DOT">.</span><span class="LIDENT">await_exn</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-submit_fork"><span class="LIDENT">submit_fork</span></span> <span class="TILDE">~</span><span id="local_sw_27"><span class="LIDENT">sw</span></span> <span id="local_t_28"><span class="LIDENT">t</span></span> <span class="TILDE">~</span><span id="local_weight_29"><span class="LIDENT">weight</span></span> <span id="local_fn_30"><span class="LIDENT">fn</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="COMMENT">(* [enqueue] blocks until the job is accepted, so we have to fork here. *)</span><span class="EOL">
</span>  <a href="../eio.core/fiber.ml.html#val-fork_promise"><span class="UIDENT">Fiber</span><span class="DOT">.</span><span class="LIDENT">fork_promise</span></a> <span class="TILDE">~</span><a href="#local_sw_27"><span class="LIDENT">sw</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">submit_exn</span> <a href="#local_t_28"><span class="LIDENT">t</span></a> <span class="TILDE">~</span><a href="#local_weight_29"><span class="LIDENT">weight</span></a> <a href="#local_fn_30"><span class="LIDENT">fn</span></a><span class="RPAREN">)</span><span class="EOL">
</span></span></code></pre></body></html>
