<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Source: buf_write.ml (eio.src.eio)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.css"/><meta name="generator" content="odoc %%VERSION%%"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/></head><body class="odoc-src"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">eio</a> &#x00BB; <a href="../index.html">Sources</a> &#x00BB; eio &#x00BB; buf_write.ml</nav><header class="odoc-preamble"><h1>Source file <code><span>buf_write.ml</span></code></h1></header><div class="odoc-tocs"><nav class="odoc-toc odoc-global-toc"><ul><li><a href="../../index.html">eio</a><ul><li>Library <code>eio</code><ul><li><a href="../../eio/Eio/index.html">Eio</a></li></ul></li><li>Library <code>eio.core</code></li><li>Library <code>eio.mock</code><ul><li><a href="../../eio.mock/Eio_mock/index.html">Eio_mock</a></li></ul></li><li>Library <code>eio.runtime_events</code><ul><li><a href="../../eio.runtime_events/Eio_runtime_events/index.html">Eio_runtime_events</a></li></ul></li><li>Library <code>eio.unix</code><ul><li><a href="../../eio.unix/Eio_unix/index.html">Eio_unix</a></li></ul></li><li>Library <code>eio.utils</code><ul><li><a href="../../eio.utils/Eio_utils/index.html">Eio_utils</a></li></ul></li><li><a href="../index.html">Sources</a><ul><li>eio<ul><li><a href="buf_read.ml.html">buf_read.ml</a></li><li><a href="#" class="current_unit">buf_write.ml</a></li><li><a href="condition.ml.html">condition.ml</a></li><li><a href="domain_manager.ml.html">domain_manager.ml</a></li><li><a href="eio.ml.html">eio.ml</a></li><li><a href="eio__.ml.html">eio__.ml</a></li><li><a href="eio_mutex.ml.html">eio_mutex.ml</a></li><li><a href="executor_pool.ml.html">executor_pool.ml</a></li><li><a href="file.ml.html">file.ml</a></li><li><a href="flow.ml.html">flow.ml</a></li><li><a href="fs.ml.html">fs.ml</a></li><li><a href="hook.ml.html">hook.ml</a></li><li><a href="lazy.ml.html">lazy.ml</a></li><li><a href="net.ml.html">net.ml</a></li><li><a href="path.ml.html">path.ml</a></li><li><a href="pool.ml.html">pool.ml</a></li><li><a href="process.ml.html">process.ml</a></li><li><a href="resource.ml.html">resource.ml</a></li><li><a href="sem_state.ml.html">sem_state.ml</a></li><li><a href="semaphore.ml.html">semaphore.ml</a></li><li><a href="std.ml.html">std.ml</a></li><li><a href="stream.ml.html">stream.ml</a></li><li><a href="sync.ml.html">sync.ml</a></li><li><a href="time.ml.html">time.ml</a></li><li><a href="waiters.ml.html">waiters.ml</a></li></ul></li><li>eio.core<ul><li><a href="../eio.core/broadcast.ml.html">broadcast.ml</a></li><li><a href="../eio.core/cancel.ml.html">cancel.ml</a></li><li><a href="../eio.core/cells.ml.html">cells.ml</a></li><li><a href="../eio.core/debug.ml.html">debug.ml</a></li><li><a href="../eio.core/dla.ml.html">dla.ml</a></li><li><a href="../eio.core/eio__core.ml.html">eio__core.ml</a></li><li><a href="../eio.core/eio__core__.ml.html">eio__core__.ml</a></li><li><a href="../eio.core/exn.ml.html">exn.ml</a></li><li><a href="../eio.core/fiber.ml.html">fiber.ml</a></li><li><a href="../eio.core/promise.ml.html">promise.ml</a></li><li><a href="../eio.core/single_waiter.ml.html">single_waiter.ml</a></li><li><a href="../eio.core/suspend.ml.html">suspend.ml</a></li><li><a href="../eio.core/switch.ml.html">switch.ml</a></li><li><a href="../eio.core/trace.ml.html">trace.ml</a></li></ul></li><li>eio.mock<ul><li><a href="../eio.mock/action.ml.html">action.ml</a></li><li><a href="../eio.mock/backend.ml.html">backend.ml</a></li><li><a href="../eio.mock/clock.ml.html">clock.ml</a></li><li><a href="../eio.mock/domain_manager.ml.html">domain_manager.ml</a></li><li><a href="../eio.mock/eio_mock.ml.html">eio_mock.ml</a></li><li><a href="../eio.mock/eio_mock__.ml.html">eio_mock__.ml</a></li><li><a href="../eio.mock/flow.ml.html">flow.ml</a></li><li><a href="../eio.mock/handler.ml.html">handler.ml</a></li><li><a href="../eio.mock/net.ml.html">net.ml</a></li></ul></li><li>eio.runtime_events<ul><li><a href="../eio.runtime_events/eio_runtime_events.ml.html">eio_runtime_events.ml</a></li></ul></li><li>eio.unix<ul><li><a href="../eio.unix/cap.ml.html">cap.ml</a></li><li><a href="../eio.unix/eio_unix.ml.html">eio_unix.ml</a></li><li><a href="../eio.unix/eio_unix__.ml.html">eio_unix__.ml</a></li><li><a href="../eio.unix/fd.ml.html">fd.ml</a></li><li><a href="../eio.unix/fork_action.ml.html">fork_action.ml</a></li><li><a href="../eio.unix/inherit_fds.ml.html">inherit_fds.ml</a></li><li><a href="../eio.unix/net.ml.html">net.ml</a></li><li><a href="../eio.unix/pi.ml.html">pi.ml</a></li><li><a href="../eio.unix/private.ml.html">private.ml</a></li><li><a href="../eio.unix/process.ml.html">process.ml</a></li><li><a href="../eio.unix/rcfd.ml.html">rcfd.ml</a></li><li><a href="../eio.unix/resource.ml.html">resource.ml</a></li><li><a href="../eio.unix/thread_pool.ml.html">thread_pool.ml</a></li><li><a href="../eio.unix/types.ml.html">types.ml</a></li></ul></li><li>eio.utils<ul><li><a href="../eio.utils/eio_utils.ml.html">eio_utils.ml</a></li><li><a href="../eio.utils/eio_utils__.ml.html">eio_utils__.ml</a></li><li><a href="../eio.utils/lf_queue.ml.html">lf_queue.ml</a></li><li><a href="../eio.utils/suspended.ml.html">suspended.ml</a></li><li><a href="../eio.utils/zzz.ml.html">zzz.ml</a></li></ul></li></ul></li></ul></li></ul></nav></div><pre class="source_container"><code class="source_line_column"><a id="L1" class="source_line" href="#L1">1</a>
<a id="L2" class="source_line" href="#L2">2</a>
<a id="L3" class="source_line" href="#L3">3</a>
<a id="L4" class="source_line" href="#L4">4</a>
<a id="L5" class="source_line" href="#L5">5</a>
<a id="L6" class="source_line" href="#L6">6</a>
<a id="L7" class="source_line" href="#L7">7</a>
<a id="L8" class="source_line" href="#L8">8</a>
<a id="L9" class="source_line" href="#L9">9</a>
<a id="L10" class="source_line" href="#L10">10</a>
<a id="L11" class="source_line" href="#L11">11</a>
<a id="L12" class="source_line" href="#L12">12</a>
<a id="L13" class="source_line" href="#L13">13</a>
<a id="L14" class="source_line" href="#L14">14</a>
<a id="L15" class="source_line" href="#L15">15</a>
<a id="L16" class="source_line" href="#L16">16</a>
<a id="L17" class="source_line" href="#L17">17</a>
<a id="L18" class="source_line" href="#L18">18</a>
<a id="L19" class="source_line" href="#L19">19</a>
<a id="L20" class="source_line" href="#L20">20</a>
<a id="L21" class="source_line" href="#L21">21</a>
<a id="L22" class="source_line" href="#L22">22</a>
<a id="L23" class="source_line" href="#L23">23</a>
<a id="L24" class="source_line" href="#L24">24</a>
<a id="L25" class="source_line" href="#L25">25</a>
<a id="L26" class="source_line" href="#L26">26</a>
<a id="L27" class="source_line" href="#L27">27</a>
<a id="L28" class="source_line" href="#L28">28</a>
<a id="L29" class="source_line" href="#L29">29</a>
<a id="L30" class="source_line" href="#L30">30</a>
<a id="L31" class="source_line" href="#L31">31</a>
<a id="L32" class="source_line" href="#L32">32</a>
<a id="L33" class="source_line" href="#L33">33</a>
<a id="L34" class="source_line" href="#L34">34</a>
<a id="L35" class="source_line" href="#L35">35</a>
<a id="L36" class="source_line" href="#L36">36</a>
<a id="L37" class="source_line" href="#L37">37</a>
<a id="L38" class="source_line" href="#L38">38</a>
<a id="L39" class="source_line" href="#L39">39</a>
<a id="L40" class="source_line" href="#L40">40</a>
<a id="L41" class="source_line" href="#L41">41</a>
<a id="L42" class="source_line" href="#L42">42</a>
<a id="L43" class="source_line" href="#L43">43</a>
<a id="L44" class="source_line" href="#L44">44</a>
<a id="L45" class="source_line" href="#L45">45</a>
<a id="L46" class="source_line" href="#L46">46</a>
<a id="L47" class="source_line" href="#L47">47</a>
<a id="L48" class="source_line" href="#L48">48</a>
<a id="L49" class="source_line" href="#L49">49</a>
<a id="L50" class="source_line" href="#L50">50</a>
<a id="L51" class="source_line" href="#L51">51</a>
<a id="L52" class="source_line" href="#L52">52</a>
<a id="L53" class="source_line" href="#L53">53</a>
<a id="L54" class="source_line" href="#L54">54</a>
<a id="L55" class="source_line" href="#L55">55</a>
<a id="L56" class="source_line" href="#L56">56</a>
<a id="L57" class="source_line" href="#L57">57</a>
<a id="L58" class="source_line" href="#L58">58</a>
<a id="L59" class="source_line" href="#L59">59</a>
<a id="L60" class="source_line" href="#L60">60</a>
<a id="L61" class="source_line" href="#L61">61</a>
<a id="L62" class="source_line" href="#L62">62</a>
<a id="L63" class="source_line" href="#L63">63</a>
<a id="L64" class="source_line" href="#L64">64</a>
<a id="L65" class="source_line" href="#L65">65</a>
<a id="L66" class="source_line" href="#L66">66</a>
<a id="L67" class="source_line" href="#L67">67</a>
<a id="L68" class="source_line" href="#L68">68</a>
<a id="L69" class="source_line" href="#L69">69</a>
<a id="L70" class="source_line" href="#L70">70</a>
<a id="L71" class="source_line" href="#L71">71</a>
<a id="L72" class="source_line" href="#L72">72</a>
<a id="L73" class="source_line" href="#L73">73</a>
<a id="L74" class="source_line" href="#L74">74</a>
<a id="L75" class="source_line" href="#L75">75</a>
<a id="L76" class="source_line" href="#L76">76</a>
<a id="L77" class="source_line" href="#L77">77</a>
<a id="L78" class="source_line" href="#L78">78</a>
<a id="L79" class="source_line" href="#L79">79</a>
<a id="L80" class="source_line" href="#L80">80</a>
<a id="L81" class="source_line" href="#L81">81</a>
<a id="L82" class="source_line" href="#L82">82</a>
<a id="L83" class="source_line" href="#L83">83</a>
<a id="L84" class="source_line" href="#L84">84</a>
<a id="L85" class="source_line" href="#L85">85</a>
<a id="L86" class="source_line" href="#L86">86</a>
<a id="L87" class="source_line" href="#L87">87</a>
<a id="L88" class="source_line" href="#L88">88</a>
<a id="L89" class="source_line" href="#L89">89</a>
<a id="L90" class="source_line" href="#L90">90</a>
<a id="L91" class="source_line" href="#L91">91</a>
<a id="L92" class="source_line" href="#L92">92</a>
<a id="L93" class="source_line" href="#L93">93</a>
<a id="L94" class="source_line" href="#L94">94</a>
<a id="L95" class="source_line" href="#L95">95</a>
<a id="L96" class="source_line" href="#L96">96</a>
<a id="L97" class="source_line" href="#L97">97</a>
<a id="L98" class="source_line" href="#L98">98</a>
<a id="L99" class="source_line" href="#L99">99</a>
<a id="L100" class="source_line" href="#L100">100</a>
<a id="L101" class="source_line" href="#L101">101</a>
<a id="L102" class="source_line" href="#L102">102</a>
<a id="L103" class="source_line" href="#L103">103</a>
<a id="L104" class="source_line" href="#L104">104</a>
<a id="L105" class="source_line" href="#L105">105</a>
<a id="L106" class="source_line" href="#L106">106</a>
<a id="L107" class="source_line" href="#L107">107</a>
<a id="L108" class="source_line" href="#L108">108</a>
<a id="L109" class="source_line" href="#L109">109</a>
<a id="L110" class="source_line" href="#L110">110</a>
<a id="L111" class="source_line" href="#L111">111</a>
<a id="L112" class="source_line" href="#L112">112</a>
<a id="L113" class="source_line" href="#L113">113</a>
<a id="L114" class="source_line" href="#L114">114</a>
<a id="L115" class="source_line" href="#L115">115</a>
<a id="L116" class="source_line" href="#L116">116</a>
<a id="L117" class="source_line" href="#L117">117</a>
<a id="L118" class="source_line" href="#L118">118</a>
<a id="L119" class="source_line" href="#L119">119</a>
<a id="L120" class="source_line" href="#L120">120</a>
<a id="L121" class="source_line" href="#L121">121</a>
<a id="L122" class="source_line" href="#L122">122</a>
<a id="L123" class="source_line" href="#L123">123</a>
<a id="L124" class="source_line" href="#L124">124</a>
<a id="L125" class="source_line" href="#L125">125</a>
<a id="L126" class="source_line" href="#L126">126</a>
<a id="L127" class="source_line" href="#L127">127</a>
<a id="L128" class="source_line" href="#L128">128</a>
<a id="L129" class="source_line" href="#L129">129</a>
<a id="L130" class="source_line" href="#L130">130</a>
<a id="L131" class="source_line" href="#L131">131</a>
<a id="L132" class="source_line" href="#L132">132</a>
<a id="L133" class="source_line" href="#L133">133</a>
<a id="L134" class="source_line" href="#L134">134</a>
<a id="L135" class="source_line" href="#L135">135</a>
<a id="L136" class="source_line" href="#L136">136</a>
<a id="L137" class="source_line" href="#L137">137</a>
<a id="L138" class="source_line" href="#L138">138</a>
<a id="L139" class="source_line" href="#L139">139</a>
<a id="L140" class="source_line" href="#L140">140</a>
<a id="L141" class="source_line" href="#L141">141</a>
<a id="L142" class="source_line" href="#L142">142</a>
<a id="L143" class="source_line" href="#L143">143</a>
<a id="L144" class="source_line" href="#L144">144</a>
<a id="L145" class="source_line" href="#L145">145</a>
<a id="L146" class="source_line" href="#L146">146</a>
<a id="L147" class="source_line" href="#L147">147</a>
<a id="L148" class="source_line" href="#L148">148</a>
<a id="L149" class="source_line" href="#L149">149</a>
<a id="L150" class="source_line" href="#L150">150</a>
<a id="L151" class="source_line" href="#L151">151</a>
<a id="L152" class="source_line" href="#L152">152</a>
<a id="L153" class="source_line" href="#L153">153</a>
<a id="L154" class="source_line" href="#L154">154</a>
<a id="L155" class="source_line" href="#L155">155</a>
<a id="L156" class="source_line" href="#L156">156</a>
<a id="L157" class="source_line" href="#L157">157</a>
<a id="L158" class="source_line" href="#L158">158</a>
<a id="L159" class="source_line" href="#L159">159</a>
<a id="L160" class="source_line" href="#L160">160</a>
<a id="L161" class="source_line" href="#L161">161</a>
<a id="L162" class="source_line" href="#L162">162</a>
<a id="L163" class="source_line" href="#L163">163</a>
<a id="L164" class="source_line" href="#L164">164</a>
<a id="L165" class="source_line" href="#L165">165</a>
<a id="L166" class="source_line" href="#L166">166</a>
<a id="L167" class="source_line" href="#L167">167</a>
<a id="L168" class="source_line" href="#L168">168</a>
<a id="L169" class="source_line" href="#L169">169</a>
<a id="L170" class="source_line" href="#L170">170</a>
<a id="L171" class="source_line" href="#L171">171</a>
<a id="L172" class="source_line" href="#L172">172</a>
<a id="L173" class="source_line" href="#L173">173</a>
<a id="L174" class="source_line" href="#L174">174</a>
<a id="L175" class="source_line" href="#L175">175</a>
<a id="L176" class="source_line" href="#L176">176</a>
<a id="L177" class="source_line" href="#L177">177</a>
<a id="L178" class="source_line" href="#L178">178</a>
<a id="L179" class="source_line" href="#L179">179</a>
<a id="L180" class="source_line" href="#L180">180</a>
<a id="L181" class="source_line" href="#L181">181</a>
<a id="L182" class="source_line" href="#L182">182</a>
<a id="L183" class="source_line" href="#L183">183</a>
<a id="L184" class="source_line" href="#L184">184</a>
<a id="L185" class="source_line" href="#L185">185</a>
<a id="L186" class="source_line" href="#L186">186</a>
<a id="L187" class="source_line" href="#L187">187</a>
<a id="L188" class="source_line" href="#L188">188</a>
<a id="L189" class="source_line" href="#L189">189</a>
<a id="L190" class="source_line" href="#L190">190</a>
<a id="L191" class="source_line" href="#L191">191</a>
<a id="L192" class="source_line" href="#L192">192</a>
<a id="L193" class="source_line" href="#L193">193</a>
<a id="L194" class="source_line" href="#L194">194</a>
<a id="L195" class="source_line" href="#L195">195</a>
<a id="L196" class="source_line" href="#L196">196</a>
<a id="L197" class="source_line" href="#L197">197</a>
<a id="L198" class="source_line" href="#L198">198</a>
<a id="L199" class="source_line" href="#L199">199</a>
<a id="L200" class="source_line" href="#L200">200</a>
<a id="L201" class="source_line" href="#L201">201</a>
<a id="L202" class="source_line" href="#L202">202</a>
<a id="L203" class="source_line" href="#L203">203</a>
<a id="L204" class="source_line" href="#L204">204</a>
<a id="L205" class="source_line" href="#L205">205</a>
<a id="L206" class="source_line" href="#L206">206</a>
<a id="L207" class="source_line" href="#L207">207</a>
<a id="L208" class="source_line" href="#L208">208</a>
<a id="L209" class="source_line" href="#L209">209</a>
<a id="L210" class="source_line" href="#L210">210</a>
<a id="L211" class="source_line" href="#L211">211</a>
<a id="L212" class="source_line" href="#L212">212</a>
<a id="L213" class="source_line" href="#L213">213</a>
<a id="L214" class="source_line" href="#L214">214</a>
<a id="L215" class="source_line" href="#L215">215</a>
<a id="L216" class="source_line" href="#L216">216</a>
<a id="L217" class="source_line" href="#L217">217</a>
<a id="L218" class="source_line" href="#L218">218</a>
<a id="L219" class="source_line" href="#L219">219</a>
<a id="L220" class="source_line" href="#L220">220</a>
<a id="L221" class="source_line" href="#L221">221</a>
<a id="L222" class="source_line" href="#L222">222</a>
<a id="L223" class="source_line" href="#L223">223</a>
<a id="L224" class="source_line" href="#L224">224</a>
<a id="L225" class="source_line" href="#L225">225</a>
<a id="L226" class="source_line" href="#L226">226</a>
<a id="L227" class="source_line" href="#L227">227</a>
<a id="L228" class="source_line" href="#L228">228</a>
<a id="L229" class="source_line" href="#L229">229</a>
<a id="L230" class="source_line" href="#L230">230</a>
<a id="L231" class="source_line" href="#L231">231</a>
<a id="L232" class="source_line" href="#L232">232</a>
<a id="L233" class="source_line" href="#L233">233</a>
<a id="L234" class="source_line" href="#L234">234</a>
<a id="L235" class="source_line" href="#L235">235</a>
<a id="L236" class="source_line" href="#L236">236</a>
<a id="L237" class="source_line" href="#L237">237</a>
<a id="L238" class="source_line" href="#L238">238</a>
<a id="L239" class="source_line" href="#L239">239</a>
<a id="L240" class="source_line" href="#L240">240</a>
<a id="L241" class="source_line" href="#L241">241</a>
<a id="L242" class="source_line" href="#L242">242</a>
<a id="L243" class="source_line" href="#L243">243</a>
<a id="L244" class="source_line" href="#L244">244</a>
<a id="L245" class="source_line" href="#L245">245</a>
<a id="L246" class="source_line" href="#L246">246</a>
<a id="L247" class="source_line" href="#L247">247</a>
<a id="L248" class="source_line" href="#L248">248</a>
<a id="L249" class="source_line" href="#L249">249</a>
<a id="L250" class="source_line" href="#L250">250</a>
<a id="L251" class="source_line" href="#L251">251</a>
<a id="L252" class="source_line" href="#L252">252</a>
<a id="L253" class="source_line" href="#L253">253</a>
<a id="L254" class="source_line" href="#L254">254</a>
<a id="L255" class="source_line" href="#L255">255</a>
<a id="L256" class="source_line" href="#L256">256</a>
<a id="L257" class="source_line" href="#L257">257</a>
<a id="L258" class="source_line" href="#L258">258</a>
<a id="L259" class="source_line" href="#L259">259</a>
<a id="L260" class="source_line" href="#L260">260</a>
<a id="L261" class="source_line" href="#L261">261</a>
<a id="L262" class="source_line" href="#L262">262</a>
<a id="L263" class="source_line" href="#L263">263</a>
<a id="L264" class="source_line" href="#L264">264</a>
<a id="L265" class="source_line" href="#L265">265</a>
<a id="L266" class="source_line" href="#L266">266</a>
<a id="L267" class="source_line" href="#L267">267</a>
<a id="L268" class="source_line" href="#L268">268</a>
<a id="L269" class="source_line" href="#L269">269</a>
<a id="L270" class="source_line" href="#L270">270</a>
<a id="L271" class="source_line" href="#L271">271</a>
<a id="L272" class="source_line" href="#L272">272</a>
<a id="L273" class="source_line" href="#L273">273</a>
<a id="L274" class="source_line" href="#L274">274</a>
<a id="L275" class="source_line" href="#L275">275</a>
<a id="L276" class="source_line" href="#L276">276</a>
<a id="L277" class="source_line" href="#L277">277</a>
<a id="L278" class="source_line" href="#L278">278</a>
<a id="L279" class="source_line" href="#L279">279</a>
<a id="L280" class="source_line" href="#L280">280</a>
<a id="L281" class="source_line" href="#L281">281</a>
<a id="L282" class="source_line" href="#L282">282</a>
<a id="L283" class="source_line" href="#L283">283</a>
<a id="L284" class="source_line" href="#L284">284</a>
<a id="L285" class="source_line" href="#L285">285</a>
<a id="L286" class="source_line" href="#L286">286</a>
<a id="L287" class="source_line" href="#L287">287</a>
<a id="L288" class="source_line" href="#L288">288</a>
<a id="L289" class="source_line" href="#L289">289</a>
<a id="L290" class="source_line" href="#L290">290</a>
<a id="L291" class="source_line" href="#L291">291</a>
<a id="L292" class="source_line" href="#L292">292</a>
<a id="L293" class="source_line" href="#L293">293</a>
<a id="L294" class="source_line" href="#L294">294</a>
<a id="L295" class="source_line" href="#L295">295</a>
<a id="L296" class="source_line" href="#L296">296</a>
<a id="L297" class="source_line" href="#L297">297</a>
<a id="L298" class="source_line" href="#L298">298</a>
<a id="L299" class="source_line" href="#L299">299</a>
<a id="L300" class="source_line" href="#L300">300</a>
<a id="L301" class="source_line" href="#L301">301</a>
<a id="L302" class="source_line" href="#L302">302</a>
<a id="L303" class="source_line" href="#L303">303</a>
<a id="L304" class="source_line" href="#L304">304</a>
<a id="L305" class="source_line" href="#L305">305</a>
<a id="L306" class="source_line" href="#L306">306</a>
<a id="L307" class="source_line" href="#L307">307</a>
<a id="L308" class="source_line" href="#L308">308</a>
<a id="L309" class="source_line" href="#L309">309</a>
<a id="L310" class="source_line" href="#L310">310</a>
<a id="L311" class="source_line" href="#L311">311</a>
<a id="L312" class="source_line" href="#L312">312</a>
<a id="L313" class="source_line" href="#L313">313</a>
<a id="L314" class="source_line" href="#L314">314</a>
<a id="L315" class="source_line" href="#L315">315</a>
<a id="L316" class="source_line" href="#L316">316</a>
<a id="L317" class="source_line" href="#L317">317</a>
<a id="L318" class="source_line" href="#L318">318</a>
<a id="L319" class="source_line" href="#L319">319</a>
<a id="L320" class="source_line" href="#L320">320</a>
<a id="L321" class="source_line" href="#L321">321</a>
<a id="L322" class="source_line" href="#L322">322</a>
<a id="L323" class="source_line" href="#L323">323</a>
<a id="L324" class="source_line" href="#L324">324</a>
<a id="L325" class="source_line" href="#L325">325</a>
<a id="L326" class="source_line" href="#L326">326</a>
<a id="L327" class="source_line" href="#L327">327</a>
<a id="L328" class="source_line" href="#L328">328</a>
<a id="L329" class="source_line" href="#L329">329</a>
<a id="L330" class="source_line" href="#L330">330</a>
<a id="L331" class="source_line" href="#L331">331</a>
<a id="L332" class="source_line" href="#L332">332</a>
<a id="L333" class="source_line" href="#L333">333</a>
<a id="L334" class="source_line" href="#L334">334</a>
<a id="L335" class="source_line" href="#L335">335</a>
<a id="L336" class="source_line" href="#L336">336</a>
<a id="L337" class="source_line" href="#L337">337</a>
<a id="L338" class="source_line" href="#L338">338</a>
<a id="L339" class="source_line" href="#L339">339</a>
<a id="L340" class="source_line" href="#L340">340</a>
<a id="L341" class="source_line" href="#L341">341</a>
<a id="L342" class="source_line" href="#L342">342</a>
<a id="L343" class="source_line" href="#L343">343</a>
<a id="L344" class="source_line" href="#L344">344</a>
<a id="L345" class="source_line" href="#L345">345</a>
<a id="L346" class="source_line" href="#L346">346</a>
<a id="L347" class="source_line" href="#L347">347</a>
<a id="L348" class="source_line" href="#L348">348</a>
<a id="L349" class="source_line" href="#L349">349</a>
<a id="L350" class="source_line" href="#L350">350</a>
<a id="L351" class="source_line" href="#L351">351</a>
<a id="L352" class="source_line" href="#L352">352</a>
<a id="L353" class="source_line" href="#L353">353</a>
<a id="L354" class="source_line" href="#L354">354</a>
<a id="L355" class="source_line" href="#L355">355</a>
<a id="L356" class="source_line" href="#L356">356</a>
<a id="L357" class="source_line" href="#L357">357</a>
<a id="L358" class="source_line" href="#L358">358</a>
<a id="L359" class="source_line" href="#L359">359</a>
<a id="L360" class="source_line" href="#L360">360</a>
<a id="L361" class="source_line" href="#L361">361</a>
<a id="L362" class="source_line" href="#L362">362</a>
<a id="L363" class="source_line" href="#L363">363</a>
<a id="L364" class="source_line" href="#L364">364</a>
<a id="L365" class="source_line" href="#L365">365</a>
<a id="L366" class="source_line" href="#L366">366</a>
<a id="L367" class="source_line" href="#L367">367</a>
<a id="L368" class="source_line" href="#L368">368</a>
<a id="L369" class="source_line" href="#L369">369</a>
<a id="L370" class="source_line" href="#L370">370</a>
<a id="L371" class="source_line" href="#L371">371</a>
<a id="L372" class="source_line" href="#L372">372</a>
<a id="L373" class="source_line" href="#L373">373</a>
<a id="L374" class="source_line" href="#L374">374</a>
<a id="L375" class="source_line" href="#L375">375</a>
<a id="L376" class="source_line" href="#L376">376</a>
<a id="L377" class="source_line" href="#L377">377</a>
<a id="L378" class="source_line" href="#L378">378</a>
<a id="L379" class="source_line" href="#L379">379</a>
<a id="L380" class="source_line" href="#L380">380</a>
<a id="L381" class="source_line" href="#L381">381</a>
<a id="L382" class="source_line" href="#L382">382</a>
<a id="L383" class="source_line" href="#L383">383</a>
<a id="L384" class="source_line" href="#L384">384</a>
<a id="L385" class="source_line" href="#L385">385</a>
<a id="L386" class="source_line" href="#L386">386</a>
<a id="L387" class="source_line" href="#L387">387</a>
<a id="L388" class="source_line" href="#L388">388</a>
<a id="L389" class="source_line" href="#L389">389</a>
<a id="L390" class="source_line" href="#L390">390</a>
<a id="L391" class="source_line" href="#L391">391</a>
<a id="L392" class="source_line" href="#L392">392</a>
<a id="L393" class="source_line" href="#L393">393</a>
<a id="L394" class="source_line" href="#L394">394</a>
<a id="L395" class="source_line" href="#L395">395</a>
<a id="L396" class="source_line" href="#L396">396</a>
<a id="L397" class="source_line" href="#L397">397</a>
<a id="L398" class="source_line" href="#L398">398</a>
<a id="L399" class="source_line" href="#L399">399</a>
<a id="L400" class="source_line" href="#L400">400</a>
<a id="L401" class="source_line" href="#L401">401</a>
<a id="L402" class="source_line" href="#L402">402</a>
<a id="L403" class="source_line" href="#L403">403</a>
<a id="L404" class="source_line" href="#L404">404</a>
<a id="L405" class="source_line" href="#L405">405</a>
<a id="L406" class="source_line" href="#L406">406</a>
<a id="L407" class="source_line" href="#L407">407</a>
<a id="L408" class="source_line" href="#L408">408</a>
<a id="L409" class="source_line" href="#L409">409</a>
<a id="L410" class="source_line" href="#L410">410</a>
<a id="L411" class="source_line" href="#L411">411</a>
<a id="L412" class="source_line" href="#L412">412</a>
<a id="L413" class="source_line" href="#L413">413</a>
<a id="L414" class="source_line" href="#L414">414</a>
<a id="L415" class="source_line" href="#L415">415</a>
<a id="L416" class="source_line" href="#L416">416</a>
<a id="L417" class="source_line" href="#L417">417</a>
<a id="L418" class="source_line" href="#L418">418</a>
<a id="L419" class="source_line" href="#L419">419</a>
<a id="L420" class="source_line" href="#L420">420</a>
<a id="L421" class="source_line" href="#L421">421</a>
<a id="L422" class="source_line" href="#L422">422</a>
<a id="L423" class="source_line" href="#L423">423</a>
<a id="L424" class="source_line" href="#L424">424</a>
<a id="L425" class="source_line" href="#L425">425</a>
<a id="L426" class="source_line" href="#L426">426</a>
<a id="L427" class="source_line" href="#L427">427</a>
<a id="L428" class="source_line" href="#L428">428</a>
<a id="L429" class="source_line" href="#L429">429</a>
<a id="L430" class="source_line" href="#L430">430</a>
<a id="L431" class="source_line" href="#L431">431</a>
<a id="L432" class="source_line" href="#L432">432</a>
<a id="L433" class="source_line" href="#L433">433</a>
<a id="L434" class="source_line" href="#L434">434</a>
<a id="L435" class="source_line" href="#L435">435</a>
<a id="L436" class="source_line" href="#L436">436</a>
<a id="L437" class="source_line" href="#L437">437</a>
<a id="L438" class="source_line" href="#L438">438</a>
<a id="L439" class="source_line" href="#L439">439</a>
<a id="L440" class="source_line" href="#L440">440</a>
<a id="L441" class="source_line" href="#L441">441</a>
<a id="L442" class="source_line" href="#L442">442</a>
<a id="L443" class="source_line" href="#L443">443</a>
<a id="L444" class="source_line" href="#L444">444</a>
<a id="L445" class="source_line" href="#L445">445</a>
<a id="L446" class="source_line" href="#L446">446</a>
<a id="L447" class="source_line" href="#L447">447</a>
<a id="L448" class="source_line" href="#L448">448</a>
<a id="L449" class="source_line" href="#L449">449</a>
<a id="L450" class="source_line" href="#L450">450</a>
<a id="L451" class="source_line" href="#L451">451</a>
<a id="L452" class="source_line" href="#L452">452</a>
<a id="L453" class="source_line" href="#L453">453</a>
<a id="L454" class="source_line" href="#L454">454</a>
<a id="L455" class="source_line" href="#L455">455</a>
<a id="L456" class="source_line" href="#L456">456</a>
<a id="L457" class="source_line" href="#L457">457</a>
<a id="L458" class="source_line" href="#L458">458</a>
<a id="L459" class="source_line" href="#L459">459</a>
<a id="L460" class="source_line" href="#L460">460</a>
<a id="L461" class="source_line" href="#L461">461</a>
<a id="L462" class="source_line" href="#L462">462</a>
<a id="L463" class="source_line" href="#L463">463</a>
<a id="L464" class="source_line" href="#L464">464</a>
<a id="L465" class="source_line" href="#L465">465</a>
<a id="L466" class="source_line" href="#L466">466</a>
<a id="L467" class="source_line" href="#L467">467</a>
<a id="L468" class="source_line" href="#L468">468</a>
<a id="L469" class="source_line" href="#L469">469</a>
<a id="L470" class="source_line" href="#L470">470</a>
<a id="L471" class="source_line" href="#L471">471</a>
<a id="L472" class="source_line" href="#L472">472</a>
<a id="L473" class="source_line" href="#L473">473</a>
<a id="L474" class="source_line" href="#L474">474</a>
<a id="L475" class="source_line" href="#L475">475</a>
<a id="L476" class="source_line" href="#L476">476</a>
<a id="L477" class="source_line" href="#L477">477</a>
<a id="L478" class="source_line" href="#L478">478</a>
<a id="L479" class="source_line" href="#L479">479</a>
<a id="L480" class="source_line" href="#L480">480</a>
<a id="L481" class="source_line" href="#L481">481</a>
<a id="L482" class="source_line" href="#L482">482</a>
<a id="L483" class="source_line" href="#L483">483</a>
<a id="L484" class="source_line" href="#L484">484</a>
<a id="L485" class="source_line" href="#L485">485</a>
<a id="L486" class="source_line" href="#L486">486</a>
<a id="L487" class="source_line" href="#L487">487</a>
<a id="L488" class="source_line" href="#L488">488</a>
<a id="L489" class="source_line" href="#L489">489</a>
<a id="L490" class="source_line" href="#L490">490</a>
<a id="L491" class="source_line" href="#L491">491</a>
<a id="L492" class="source_line" href="#L492">492</a>
<a id="L493" class="source_line" href="#L493">493</a>
<a id="L494" class="source_line" href="#L494">494</a>
<a id="L495" class="source_line" href="#L495">495</a>
<a id="L496" class="source_line" href="#L496">496</a>
<a id="L497" class="source_line" href="#L497">497</a>
<a id="L498" class="source_line" href="#L498">498</a>
<a id="L499" class="source_line" href="#L499">499</a>
<a id="L500" class="source_line" href="#L500">500</a>
<a id="L501" class="source_line" href="#L501">501</a>
<a id="L502" class="source_line" href="#L502">502</a>
<a id="L503" class="source_line" href="#L503">503</a>
<a id="L504" class="source_line" href="#L504">504</a>
<a id="L505" class="source_line" href="#L505">505</a>
<a id="L506" class="source_line" href="#L506">506</a>
<a id="L507" class="source_line" href="#L507">507</a>
<a id="L508" class="source_line" href="#L508">508</a>
<a id="L509" class="source_line" href="#L509">509</a>
<a id="L510" class="source_line" href="#L510">510</a>
<a id="L511" class="source_line" href="#L511">511</a>
<a id="L512" class="source_line" href="#L512">512</a>
<a id="L513" class="source_line" href="#L513">513</a>
<a id="L514" class="source_line" href="#L514">514</a>
<a id="L515" class="source_line" href="#L515">515</a>
<a id="L516" class="source_line" href="#L516">516</a>
<a id="L517" class="source_line" href="#L517">517</a>
<a id="L518" class="source_line" href="#L518">518</a>
<a id="L519" class="source_line" href="#L519">519</a>
<a id="L520" class="source_line" href="#L520">520</a>
<a id="L521" class="source_line" href="#L521">521</a>
<a id="L522" class="source_line" href="#L522">522</a>
<a id="L523" class="source_line" href="#L523">523</a>
<a id="L524" class="source_line" href="#L524">524</a>
<a id="L525" class="source_line" href="#L525">525</a>
<a id="L526" class="source_line" href="#L526">526</a>
<a id="L527" class="source_line" href="#L527">527</a>
<a id="L528" class="source_line" href="#L528">528</a>
<a id="L529" class="source_line" href="#L529">529</a>
<a id="L530" class="source_line" href="#L530">530</a>
<a id="L531" class="source_line" href="#L531">531</a>
<a id="L532" class="source_line" href="#L532">532</a>
<a id="L533" class="source_line" href="#L533">533</a>
<a id="L534" class="source_line" href="#L534">534</a>
<a id="L535" class="source_line" href="#L535">535</a>
<a id="L536" class="source_line" href="#L536">536</a>
<a id="L537" class="source_line" href="#L537">537</a>
<a id="L538" class="source_line" href="#L538">538</a>
<a id="L539" class="source_line" href="#L539">539</a>
<a id="L540" class="source_line" href="#L540">540</a>
<a id="L541" class="source_line" href="#L541">541</a>
<a id="L542" class="source_line" href="#L542">542</a>
<a id="L543" class="source_line" href="#L543">543</a>
<a id="L544" class="source_line" href="#L544">544</a>
<a id="L545" class="source_line" href="#L545">545</a>
<a id="L546" class="source_line" href="#L546">546</a>
<a id="L547" class="source_line" href="#L547">547</a>
<a id="L548" class="source_line" href="#L548">548</a>
<a id="L549" class="source_line" href="#L549">549</a>
<a id="L550" class="source_line" href="#L550">550</a>
<a id="L551" class="source_line" href="#L551">551</a>
<a id="L552" class="source_line" href="#L552">552</a>
<a id="L553" class="source_line" href="#L553">553</a>
<a id="L554" class="source_line" href="#L554">554</a>
<a id="L555" class="source_line" href="#L555">555</a>
<a id="L556" class="source_line" href="#L556">556</a>
<a id="L557" class="source_line" href="#L557">557</a>
<a id="L558" class="source_line" href="#L558">558</a>
<a id="L559" class="source_line" href="#L559">559</a>
<a id="L560" class="source_line" href="#L560">560</a>
<a id="L561" class="source_line" href="#L561">561</a>
<a id="L562" class="source_line" href="#L562">562</a>
<a id="L563" class="source_line" href="#L563">563</a>
<a id="L564" class="source_line" href="#L564">564</a>
<a id="L565" class="source_line" href="#L565">565</a>
<a id="L566" class="source_line" href="#L566">566</a>
<a id="L567" class="source_line" href="#L567">567</a>
<a id="L568" class="source_line" href="#L568">568</a>
<a id="L569" class="source_line" href="#L569">569</a>
<a id="L570" class="source_line" href="#L570">570</a>
<a id="L571" class="source_line" href="#L571">571</a>
<a id="L572" class="source_line" href="#L572">572</a>
<a id="L573" class="source_line" href="#L573">573</a>
<a id="L574" class="source_line" href="#L574">574</a>
<a id="L575" class="source_line" href="#L575">575</a>
<a id="L576" class="source_line" href="#L576">576</a>
<a id="L577" class="source_line" href="#L577">577</a>
<a id="L578" class="source_line" href="#L578">578</a>
<a id="L579" class="source_line" href="#L579">579</a>
<a id="L580" class="source_line" href="#L580">580</a>
<a id="L581" class="source_line" href="#L581">581</a>
</code><code class="source_code"><span><span class="COMMENT">(* This module is based on code from Faraday (0.7.2), which had the following
   license:

  ----------------------------------------------------------------------------
    Copyright (c) 2016 Inhabited Type LLC.

    All rights reserved.

    Redistribution and use in source and binary forms, with or without
    modification, are permitted provided that the following conditions
    are met:

    1. Redistributions of source code must retain the above copyright
       notice, this list of conditions and the following disclaimer.

    2. Redistributions in binary form must reproduce the above copyright
       notice, this list of conditions and the following disclaimer in the
       documentation and/or other materials provided with the distribution.

    3. Neither the name of the author nor the names of his contributors
       may be used to endorse or promote products derived from this software
       without specific prior written permission.

    THIS SOFTWARE IS PROVIDED BY THE CONTRIBUTORS ``AS IS'' AND ANY EXPRESS
    OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
    WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
    DISCLAIMED.  IN NO EVENT SHALL THE AUTHORS OR CONTRIBUTORS BE LIABLE FOR
    ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
    DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
    OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
    HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
    STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN
    ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
    POSSIBILITY OF SUCH DAMAGE.
  ----------------------------------------------------------------------------*)</span><span class="EOL">
</span><span class="EOL">
</span><span class="EOL">
</span><span id="type-bigstring"><span class="TYPE">type</span> <span class="LIDENT">bigstring</span> <span class="EQUAL">=</span> <a href="../../../bigstringaf/src/bigstringaf/bigstringaf.ml.html#type-t"><span class="UIDENT">Bigstringaf</span><span class="DOT">.</span><span class="LIDENT">t</span></a></span><span class="EOL">
</span><span class="EOL">
</span><span id="exception-Dequeue_empty"><span class="EXCEPTION">exception</span> <span class="UIDENT">Dequeue_empty</span></span><span class="EOL">
</span><span class="EOL">
</span><span id="module-Deque"><span class="MODULE">module</span> <span class="UIDENT">Deque</span><span class="LPAREN">(</span><span class="UIDENT">T</span><span class="COLON">:</span><span class="SIG">sig</span> <span id="module-Deque.argument-1-T.type-t"><span class="TYPE">type</span> <span class="LIDENT">t</span></span> <span id="module-Deque.argument-1-T.val-sentinel"><span class="VAL">val</span> <span class="LIDENT">sentinel</span> <span class="COLON">:</span> <span class="LIDENT">t</span></span> <span class="END">end</span><span class="RPAREN">)</span> <span class="COLON">:</span> <span class="SIG">sig</span><span class="EOL">
</span>  <span id="module-Deque.type-elem"><span class="TYPE">type</span> <span class="LIDENT">elem</span> <span class="EQUAL">=</span> <span class="UIDENT">T</span><span class="DOT">.</span><span class="LIDENT">t</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Deque.type-t"><span class="TYPE">type</span> <span class="LIDENT">t</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Deque.val-create"><span class="VAL">val</span> <span class="LIDENT">create</span> <span class="COLON">:</span> <span class="LIDENT">int</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">t</span></span><span class="EOL">
</span>  <span class="COMMENT">(* [t = create n] creates a new deque with initial capacity [n].

     [to_list t = []] *)</span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Deque.val-is_empty"><span class="VAL">val</span> <span class="LIDENT">is_empty</span> <span class="COLON">:</span> <span class="LIDENT">t</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">bool</span></span><span class="EOL">
</span>  <span class="COMMENT">(* [is_empty t = (to_list t = []) *)</span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Deque.val-enqueue"><span class="VAL">val</span> <span class="LIDENT">enqueue</span> <span class="COLON">:</span> <span class="LIDENT">elem</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">t</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span></span><span class="EOL">
</span>  <span class="COMMENT">(* [enqueue elem t]

     [to_list t'] = to_list t @ [elem] *)</span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Deque.val-dequeue_exn"><span class="VAL">val</span> <span class="LIDENT">dequeue_exn</span> <span class="COLON">:</span> <span class="LIDENT">t</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">elem</span></span><span class="EOL">
</span>  <span class="COMMENT">(* [dequeue_exn t = List.hd (to_list t)]

     [to_list t' = List.tl (to_list t)] *)</span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Deque.val-enqueue_front"><span class="VAL">val</span> <span class="LIDENT">enqueue_front</span> <span class="COLON">:</span> <span class="LIDENT">elem</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">t</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span></span><span class="EOL">
</span>  <span class="COMMENT">(* [enqueue_front elem t]

     to_list t' = elem :: to_list t *)</span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Deque.val-to_list"><span class="VAL">val</span> <span class="LIDENT">to_list</span> <span class="COLON">:</span> <span class="LIDENT">t</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">elem</span> <span class="LIDENT">list</span></span><span class="EOL">
</span><span class="END">end</span> <span class="EQUAL">=</span> <span class="STRUCT">struct</span><span class="EOL">
</span>  <span id="module-Deque.type-elem"><span class="TYPE">type</span> <span class="LIDENT">elem</span> <span class="EQUAL">=</span> <span class="UIDENT">T</span><span class="DOT">.</span><span class="LIDENT">t</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span id="module-Deque.type-t"><span class="TYPE">type</span> <span class="LIDENT">t</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LBRACE">{</span> <span id="def_181"><span class="MUTABLE">mutable</span> <span class="LIDENT">elements</span> <span class="COLON">:</span> <span class="LIDENT">elem</span> <span class="LIDENT">array</span><span class="EOL">
</span>    <span class="SEMI">;</span></span> <span id="def_170"><span class="MUTABLE">mutable</span> <span class="LIDENT">front</span>    <span class="COLON">:</span> <span class="LIDENT">int</span><span class="EOL">
</span>    <span class="SEMI">;</span></span> <span id="def_174"><span class="MUTABLE">mutable</span> <span class="LIDENT">back</span>     <span class="COLON">:</span> <span class="LIDENT">int</span></span> <span class="RBRACE">}</span></span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Deque.val-sentinel"><span class="LIDENT">sentinel</span></span> <span class="EQUAL">=</span> <span class="UIDENT">T</span><span class="DOT">.</span><span class="LIDENT">sentinel</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Deque.val-create"><span class="LIDENT">create</span></span> <span id="local_size_1"><span class="LIDENT">size</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LBRACE">{</span> <span class="LIDENT">elements</span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/array.ml.html#val-make"><span class="UIDENT">Array</span><span class="DOT">.</span><span class="LIDENT">make</span></a> <a href="#local_size_1"><span class="LIDENT">size</span></a> <span class="LIDENT">sentinel</span><span class="SEMI">;</span> <span class="LIDENT">front</span> <span class="EQUAL">=</span> <span class="INT">0</span><span class="SEMI">;</span> <span class="LIDENT">back</span> <span class="EQUAL">=</span> <span class="INT">0</span> <span class="RBRACE">}</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Deque.val-is_empty"><span class="LIDENT">is_empty</span></span> <span id="local_t_2"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <a href="#local_t_2"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">front</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <a href="#local_t_2"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">back</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Deque.val-ensure_space"><span class="LIDENT">ensure_space</span></span> <span id="local_t_3"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_t_3"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">back</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/array.ml.html#val-length"><span class="UIDENT">Array</span><span class="DOT">.</span><span class="LIDENT">length</span></a> <a href="#local_t_3"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">elements</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <span class="INT">1</span> <span class="THEN">then</span> <span class="BEGIN">begin</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_len_4"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span> <a href="#local_t_3"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">back</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <a href="#local_t_3"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">front</span> <span class="IN">in</span><span class="EOL">
</span>      <span class="IF">if</span> <a href="#local_t_3"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">front</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <span class="INT">0</span> <span class="THEN">then</span> <span class="BEGIN">begin</span><span class="EOL">
</span>        <span class="COMMENT">(* Shift everything to the front of the array and then clear out
         * dangling pointers to elements from their previous locations. *)</span><span class="EOL">
</span>        <a href="../../../ocaml-base-compiler/src/stdlib/array.ml.html#val-blit"><span class="UIDENT">Array</span><span class="DOT">.</span><span class="LIDENT">blit</span></a> <a href="#local_t_3"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">elements</span> <a href="#local_t_3"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">front</span> <a href="#local_t_3"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">elements</span> <span class="INT">0</span> <a href="#local_len_4"><span class="LIDENT">len</span></a><span class="SEMI">;</span><span class="EOL">
</span>        <a href="../../../ocaml-base-compiler/src/stdlib/array.ml.html#val-fill"><span class="UIDENT">Array</span><span class="DOT">.</span><span class="LIDENT">fill</span></a> <a href="#local_t_3"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">elements</span> <a href="#local_len_4"><span class="LIDENT">len</span></a> <a href="#local_t_3"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">front</span> <span class="LIDENT">sentinel</span><span class="EOL">
</span>      <span class="END">end</span> <span class="ELSE">else</span> <span class="BEGIN">begin</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_old_5"><span class="LIDENT">old</span></span>  <span class="EQUAL">=</span> <a href="#local_t_3"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">elements</span> <span class="IN">in</span><span class="EOL">
</span>        <span class="LET">let</span> <span id="local_new__6"><span class="LIDENT">new_</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/array.ml.html"><span class="UIDENT">Array</span></a><span class="DOT">.</span><span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/array.ml.html#val-make"><span class="LIDENT">make</span></a> <span class="LPAREN">(</span><span class="INT">2</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(*)"><span class="STAR">*</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/array.ml.html#val-length"><span class="LIDENT">length</span></a> <a href="#local_old_5"><span class="LIDENT">old</span></a><span class="RPAREN">)</span> <span class="LIDENT">sentinel</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>        <a href="../../../ocaml-base-compiler/src/stdlib/array.ml.html#val-blit"><span class="UIDENT">Array</span><span class="DOT">.</span><span class="LIDENT">blit</span></a> <a href="#local_old_5"><span class="LIDENT">old</span></a> <a href="#local_t_3"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">front</span> <a href="#local_new__6"><span class="LIDENT">new_</span></a> <span class="INT">0</span> <a href="#local_len_4"><span class="LIDENT">len</span></a><span class="SEMI">;</span><span class="EOL">
</span>        <a href="#local_t_3"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">elements</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_new__6"><span class="LIDENT">new_</span></a><span class="EOL">
</span>      <span class="END">end</span><span class="SEMI">;</span><span class="EOL">
</span>      <a href="#local_t_3"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">front</span> <span class="LESSMINUS">&lt;-</span> <span class="INT">0</span><span class="SEMI">;</span><span class="EOL">
</span>      <a href="#local_t_3"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">back</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_len_4"><span class="LIDENT">len</span></a><span class="EOL">
</span>    <span class="END">end</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Deque.val-enqueue"><span class="LIDENT">enqueue</span></span> <span id="local_e_7"><span class="LIDENT">e</span></span> <span id="local_t_8"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">ensure_space</span> <a href="#local_t_8"><span class="LIDENT">t</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <a href="#local_t_8"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">elements</span><span class="DOT">.</span><span class="LPAREN">(</span><a href="#local_t_8"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">back</span><span class="RPAREN">)</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_e_7"><span class="LIDENT">e</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <a href="#local_t_8"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">back</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_t_8"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">back</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <span class="INT">1</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Deque.val-dequeue_exn"><span class="LIDENT">dequeue_exn</span></span> <span id="local_t_9"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="IF">if</span> <span class="LIDENT">is_empty</span> <a href="#local_t_9"><span class="LIDENT">t</span></a> <span class="THEN">then</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-raise"><span class="LIDENT">raise</span></a> <span class="UIDENT">Dequeue_empty</span><span class="EOL">
</span>    <span class="ELSE">else</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_result_10"><span class="LIDENT">result</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/array.ml.html#val-unsafe_get"><span class="UIDENT">Array</span><span class="DOT">.</span><span class="LIDENT">unsafe_get</span></a> <a href="#local_t_9"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">elements</span> <a href="#local_t_9"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">front</span> <span class="IN">in</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/array.ml.html#val-unsafe_set"><span class="UIDENT">Array</span><span class="DOT">.</span><span class="LIDENT">unsafe_set</span></a> <a href="#local_t_9"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">elements</span> <a href="#local_t_9"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">front</span> <span class="LIDENT">sentinel</span><span class="SEMI">;</span><span class="EOL">
</span>      <a href="#local_t_9"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">front</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_t_9"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">front</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <span class="INT">1</span><span class="SEMI">;</span><span class="EOL">
</span>      <a href="#local_result_10"><span class="LIDENT">result</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Deque.val-enqueue_front"><span class="LIDENT">enqueue_front</span></span> <span id="local_e_11"><span class="LIDENT">e</span></span> <span id="local_t_12"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="COMMENT">(* This is in general not true for Deque data structures, but the usage
     * below ensures that there is always space to push an element back on the
     * front. An [enqueue_front] is always preceded by a [dequeue], with no
     * intervening operations. *)</span><span class="EOL">
</span>    <span class="ASSERT">assert</span> <span class="LPAREN">(</span><a href="#local_t_12"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">front</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <span class="INT">0</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="#local_t_12"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">front</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_t_12"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">front</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <span class="INT">1</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="#local_t_12"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">elements</span><span class="DOT">.</span><span class="LPAREN">(</span><a href="#local_t_12"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">front</span><span class="RPAREN">)</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_e_11"><span class="LIDENT">e</span></a><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-Deque.val-to_list"><span class="LIDENT">to_list</span></span> <span id="local_t_13"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_result_14"><span class="LIDENT">result</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ref"><span class="LIDENT">ref</span></a> <span class="LBRACKET">[</span><span class="RBRACKET">]</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="FOR">for</span> <span class="LIDENT">i</span> <span class="EQUAL">=</span> <a href="#local_t_13"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">back</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <span class="INT">1</span> <span class="DOWNTO">downto</span> <a href="#local_t_13"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">front</span> <span class="DO">do</span><span class="EOL">
</span>      <a href="#local_result_14"><span class="LIDENT">result</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="#local_t_13"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">elements</span><span class="DOT">.</span><span class="LPAREN">(</span><span class="LIDENT">i</span><span class="RPAREN">)</span> <span class="COLONCOLON">::</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="#local_result_14"><span class="LIDENT">result</span></a><span class="EOL">
</span>    <span class="DONE">done</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="#local_result_14"><span class="LIDENT">result</span></a><span class="EOL">
</span><span class="END">end</span></span><span class="EOL">
</span><span class="EOL">
</span><span id="module-Buffers"><span class="MODULE">module</span> <span class="UIDENT">Buffers</span> <span class="EQUAL">=</span> <span class="UIDENT">Deque</span><span class="LPAREN">(</span><span class="STRUCT">struct</span><span class="EOL">
</span>  <span id="def_184"><span class="TYPE">type</span> <span class="LIDENT">t</span> <span class="EQUAL">=</span> <a href="../../../cstruct/src/cstruct/cstruct.ml.html#type-t"><span class="UIDENT">Cstruct</span><span class="DOT">.</span><span class="LIDENT">t</span></a></span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_sentinel_15"><span class="LIDENT">sentinel</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_deadbeef_16"><span class="LIDENT">deadbeef</span></span> <span class="EQUAL">=</span> <span class="STRING">&quot;\222\173\190\239&quot;</span> <span class="IN">in</span><span class="EOL">
</span>    <a href="../../../cstruct/src/cstruct/cstruct.ml.html#val-of_string"><span class="UIDENT">Cstruct</span><span class="DOT">.</span><span class="LIDENT">of_string</span></a> <a href="#local_deadbeef_16"><span class="LIDENT">deadbeef</span></a><span class="EOL">
</span><span class="END">end</span><span class="RPAREN">)</span></span><span class="EOL">
</span><span class="EOL">
</span><span id="module-Flushes"><span class="MODULE">module</span> <span class="UIDENT">Flushes</span> <span class="EQUAL">=</span> <span class="UIDENT">Deque</span><span class="LPAREN">(</span><span class="STRUCT">struct</span><span class="EOL">
</span>    <span id="def_178"><span class="TYPE">type</span> <span class="LIDENT">t</span> <span class="EQUAL">=</span> <span class="LIDENT">int</span> <span class="STAR">*</span> <span class="LPAREN">(</span><a href="../eio.core/promise.ml.html#type-u"><a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#type-result"><span class="LPAREN">(</span><span class="LIDENT">unit</span><span class="COMMA">,</span> <span class="LIDENT">exn</span><span class="RPAREN">)</span> <span class="LIDENT">result</span></a> <span class="UIDENT">Promise</span><span class="DOT">.</span><span class="LIDENT">u</span></a><span class="RPAREN">)</span></span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_sentinel_17"><span class="LIDENT">sentinel</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="def_171"><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span id="local_r_18"><span class="LIDENT">r</span></span></span> <span class="EQUAL">=</span> <a href="../eio.core/promise.ml.html#val-create"><span class="UIDENT">Promise</span><span class="DOT">.</span><span class="LIDENT">create</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>      <a href="../eio.core/promise.ml.html#val-resolve_ok"><span class="UIDENT">Promise</span><span class="DOT">.</span><span class="LIDENT">resolve_ok</span></a> <a href="#local_r_18"><span class="LIDENT">r</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>      <span class="INT">0</span><span class="COMMA">,</span> <a href="#local_r_18"><span class="LIDENT">r</span></a><span class="EOL">
</span>  <span class="END">end</span><span class="RPAREN">)</span></span><span class="EOL">
</span><span class="EOL">
</span><span id="type-state"><span class="TYPE">type</span> <span class="LIDENT">state</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span id="type-state.constructor-Active"><span class="BAR">|</span> <span class="UIDENT">Active</span></span><span class="EOL">
</span>  <span id="type-state.constructor-Paused"><span class="BAR">|</span> <span class="UIDENT">Paused</span></span><span class="EOL">
</span>  <span id="type-state.constructor-Closed"><span class="BAR">|</span> <span class="UIDENT">Closed</span></span></span><span class="EOL">
</span><span class="EOL">
</span><span id="type-t"><span class="TYPE">type</span> <span class="LIDENT">t</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LBRACE">{</span> <span id="def_185"><span class="MUTABLE">mutable</span> <span class="LIDENT">buffer</span>         <span class="COLON">:</span> <span class="LIDENT">bigstring</span><span class="EOL">
</span>  <span class="SEMI">;</span></span> <span id="def_179"><span class="MUTABLE">mutable</span> <span class="LIDENT">scheduled_pos</span>  <span class="COLON">:</span> <span class="LIDENT">int</span>        <span class="COMMENT">(* How much of [buffer] is in [scheduled] *)</span><span class="EOL">
</span>  <span class="SEMI">;</span></span> <span id="def_177"><span class="MUTABLE">mutable</span> <span class="LIDENT">write_pos</span>      <span class="COLON">:</span> <span class="LIDENT">int</span>        <span class="COMMENT">(* How much of [buffer] has been written to *)</span><span class="EOL">
</span>  <span class="SEMI">;</span></span> <span id="def_176"><span class="LIDENT">scheduled</span>              <span class="COLON">:</span> <span class="UIDENT">Buffers</span><span class="DOT">.</span><span class="LIDENT">t</span><span class="EOL">
</span>  <span class="SEMI">;</span></span> <span id="def_173"><span class="LIDENT">flushed</span>                <span class="COLON">:</span> <span class="UIDENT">Flushes</span><span class="DOT">.</span><span class="LIDENT">t</span><span class="EOL">
</span>  <span class="SEMI">;</span></span> <span id="def_180"><span class="MUTABLE">mutable</span> <span class="LIDENT">bytes_received</span> <span class="COLON">:</span> <span class="LIDENT">int</span>        <span class="COMMENT">(* Total scheduled bytes. Wraps. *)</span><span class="EOL">
</span>  <span class="SEMI">;</span></span> <span id="def_168"><span class="MUTABLE">mutable</span> <span class="LIDENT">bytes_written</span>  <span class="COLON">:</span> <span class="LIDENT">int</span>        <span class="COMMENT">(* Total written bytes. Wraps. *)</span><span class="EOL">
</span>  <span class="SEMI">;</span></span> <span id="def_169"><span class="MUTABLE">mutable</span> <span class="LIDENT">state</span>          <span class="COLON">:</span> <span class="LIDENT">state</span><span class="EOL">
</span>  <span class="SEMI">;</span></span> <span id="def_183"><span class="MUTABLE">mutable</span> <span class="LIDENT">wake_writer</span>    <span class="COLON">:</span> <span class="LIDENT">unit</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">unit</span><span class="EOL">
</span>  <span class="SEMI">;</span></span> <span id="def_182"><span class="MUTABLE">mutable</span> <span class="LIDENT">printf</span>         <span class="COLON">:</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/format.ml.html#type-formatter"><span class="UIDENT">Format</span><span class="DOT">.</span><span class="LIDENT">formatter</span></a> <span class="STAR">*</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#type-ref"><span class="LIDENT">bool</span> <span class="LIDENT">ref</span></a><span class="RPAREN">)</span> <span class="LIDENT">option</span></span><span class="EOL">
</span>  <span class="RBRACE">}</span></span><span class="EOL">
</span><span class="COMMENT">(* Invariant: [write_pos &gt;= scheduled_pos] *)</span><span class="EOL">
</span><span class="EOL">
</span><span id="exception-Flush_aborted"><span class="EXCEPTION">exception</span> <span class="UIDENT">Flush_aborted</span></span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-writable_exn"><span class="LIDENT">writable_exn</span></span> <span id="local_t_19"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="MATCH">match</span> <a href="#local_t_19"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Active</span> <span class="BAR">|</span> <span class="UIDENT">Paused</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Closed</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-failwith"><span class="failwith">failwith</span></a> <span class="STRING">&quot;cannot write to closed writer&quot;</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-wake_writer"><span class="LIDENT">wake_writer</span></span> <span id="local_t_20"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="MATCH">match</span> <a href="#local_t_20"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Paused</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Active</span> <span class="BAR">|</span> <span class="UIDENT">Closed</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_wake_21"><span class="LIDENT">wake</span></span> <span class="EQUAL">=</span> <a href="#local_t_20"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">wake_writer</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_wake_21"><span class="LIDENT">wake</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!=)"><span class="INFIXOP0">!=</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a> <span class="THEN">then</span> <span class="LPAREN">(</span><span class="EOL">
</span>      <a href="#local_t_20"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">wake_writer</span> <span class="LESSMINUS">&lt;-</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <a href="#local_wake_21"><span class="LIDENT">wake</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* Schedule [cs] now, without any checks. Users use {!schedule_cstruct} instead. *)</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-schedule_iovec"><span class="LIDENT">schedule_iovec</span></span> <span id="local_t_22"><span class="LIDENT">t</span></span> <span id="local_cs_23"><span class="LIDENT">cs</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="#local_t_22"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">bytes_received</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_t_22"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">bytes_received</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <a href="../../../cstruct/src/cstruct/cstruct.ml.html#val-length"><span class="UIDENT">Cstruct</span><span class="DOT">.</span><span class="LIDENT">length</span></a> <a href="#local_cs_23"><span class="LIDENT">cs</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="UIDENT">Buffers</span><span class="DOT">.</span><span class="LIDENT">enqueue</span> <a href="#local_cs_23"><span class="LIDENT">cs</span></a> <a href="#local_t_22"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">scheduled</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* Schedule all pending data in [buffer]. *)</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-flush_buffer"><span class="LIDENT">flush_buffer</span></span> <span id="local_t_24"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_len_25"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span> <a href="#local_t_24"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">write_pos</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <a href="#local_t_24"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">scheduled_pos</span> <span class="IN">in</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="#local_len_25"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <span class="INT">0</span> <span class="THEN">then</span> <span class="BEGIN">begin</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_off_26"><span class="LIDENT">off</span></span> <span class="EQUAL">=</span> <a href="#local_t_24"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">scheduled_pos</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="LIDENT">schedule_iovec</span> <a href="#local_t_24"><span class="LIDENT">t</span></a> <span class="LPAREN">(</span><a href="../../../cstruct/src/cstruct/cstruct.ml.html#val-of_bigarray"><span class="UIDENT">Cstruct</span><span class="DOT">.</span><span class="LIDENT">of_bigarray</span></a> <span class="TILDE">~</span><a href="#local_off_26"><span class="LIDENT">off</span></a> <span class="TILDE">~</span><a href="#local_len_25"><span class="LIDENT">len</span></a> <a href="#local_t_24"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="#local_t_24"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">scheduled_pos</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_t_24"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">write_pos</span><span class="EOL">
</span>  <span class="END">end</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-free_bytes_in_buffer"><span class="LIDENT">free_bytes_in_buffer</span></span> <span id="local_t_27"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_buf_len_28"><span class="LIDENT">buf_len</span></span> <span class="EQUAL">=</span> <a href="../../../bigstringaf/src/bigstringaf/bigstringaf.ml.html#val-length"><span class="UIDENT">Bigstringaf</span><span class="DOT">.</span><span class="LIDENT">length</span></a> <a href="#local_t_27"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <span class="IN">in</span><span class="EOL">
</span>  <a href="#local_buf_len_28"><span class="LIDENT">buf_len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <a href="#local_t_27"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">write_pos</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-schedule_cstruct"><span class="LIDENT">schedule_cstruct</span></span> <span id="local_t_29"><span class="LIDENT">t</span></span> <span id="local_cs_30"><span class="LIDENT">cs</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">writable_exn</span> <a href="#local_t_29"><span class="LIDENT">t</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="LIDENT">flush_buffer</span> <a href="#local_t_29"><span class="LIDENT">t</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="../../../cstruct/src/cstruct/cstruct.ml.html#val-length"><span class="UIDENT">Cstruct</span><span class="DOT">.</span><span class="LIDENT">length</span></a> <a href="#local_cs_30"><span class="LIDENT">cs</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;)"><span class="GREATER">&gt;</span></a> <span class="INT">0</span> <span class="THEN">then</span> <span class="LPAREN">(</span><span class="EOL">
</span>    <span class="LIDENT">schedule_iovec</span> <a href="#local_t_29"><span class="LIDENT">t</span></a> <a href="#local_cs_30"><span class="LIDENT">cs</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">wake_writer</span> <a href="#local_t_29"><span class="LIDENT">t</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-ensure_space"><span class="LIDENT">ensure_space</span></span> <span id="local_t_31"><span class="LIDENT">t</span></span> <span id="local_len_32"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="IF">if</span> <span class="LIDENT">free_bytes_in_buffer</span> <a href="#local_t_31"><span class="LIDENT">t</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;)"><span class="LESS">&lt;</span></a> <a href="#local_len_32"><span class="LIDENT">len</span></a> <span class="THEN">then</span> <span class="BEGIN">begin</span><span class="EOL">
</span>    <span class="LIDENT">flush_buffer</span> <a href="#local_t_31"><span class="LIDENT">t</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <a href="#local_t_31"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <span class="LESSMINUS">&lt;-</span> <a href="../../../bigstringaf/src/bigstringaf/bigstringaf.ml.html#val-create"><span class="UIDENT">Bigstringaf</span><span class="DOT">.</span><span class="LIDENT">create</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-max"><span class="LIDENT">max</span></a> <span class="LPAREN">(</span><a href="../../../bigstringaf/src/bigstringaf/bigstringaf.ml.html#val-length"><span class="UIDENT">Bigstringaf</span><span class="DOT">.</span><span class="LIDENT">length</span></a> <a href="#local_t_31"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span><span class="RPAREN">)</span> <a href="#local_len_32"><span class="LIDENT">len</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="#local_t_31"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">write_pos</span> <span class="LESSMINUS">&lt;-</span> <span class="INT">0</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="#local_t_31"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">scheduled_pos</span> <span class="LESSMINUS">&lt;-</span> <span class="INT">0</span><span class="EOL">
</span>  <span class="END">end</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-advance_pos"><span class="LIDENT">advance_pos</span></span> <span id="local_t_33"><span class="LIDENT">t</span></span> <span id="local_n_34"><span class="LIDENT">n</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="#local_t_33"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">write_pos</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_t_33"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">write_pos</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <a href="#local_n_34"><span class="LIDENT">n</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="LIDENT">wake_writer</span> <a href="#local_t_33"><span class="LIDENT">t</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-write_gen"><span class="LIDENT">write_gen</span></span> <span id="local_t_35"><span class="LIDENT">t</span></span> <span class="TILDE">~</span><span id="local_blit_36"><span class="LIDENT">blit</span></span> <span class="TILDE">~</span><span id="local_off_37"><span class="LIDENT">off</span></span> <span class="TILDE">~</span><span id="local_len_38"><span class="LIDENT">len</span></span> <span id="local_a_39"><span class="LIDENT">a</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">writable_exn</span> <a href="#local_t_35"><span class="LIDENT">t</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="LIDENT">ensure_space</span> <a href="#local_t_35"><span class="LIDENT">t</span></a> <a href="#local_len_38"><span class="LIDENT">len</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <a href="#local_blit_36"><span class="LIDENT">blit</span></a> <a href="#local_a_39"><span class="LIDENT">a</span></a> <span class="LABEL">~src_off:</span><a href="#local_off_37"><span class="LIDENT">off</span></a> <a href="#local_t_35"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <span class="LABEL">~dst_off:</span><a href="#local_t_35"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">write_pos</span> <span class="TILDE">~</span><a href="#local_len_38"><span class="LIDENT">len</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="LIDENT">advance_pos</span> <a href="#local_t_35"><span class="LIDENT">t</span></a> <a href="#local_len_38"><span class="LIDENT">len</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-string"><span class="LIDENT">string</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_blit_40"><span class="LIDENT">blit</span></span> <span class="EQUAL">=</span> <a href="../../../bigstringaf/src/bigstringaf/bigstringaf.ml.html#val-blit_from_string"><span class="UIDENT">Bigstringaf</span><span class="DOT">.</span><span class="LIDENT">blit_from_string</span></a> <span class="IN">in</span><span class="EOL">
</span>  <span class="FUN">fun</span> <span id="local_t_41"><span class="LIDENT">t</span></span> <span class="QUESTION">?</span><span class="LPAREN">(</span><span id="local_off_42"><span class="LIDENT">off</span></span><span class="EQUAL">=</span><span class="INT">0</span><span class="RPAREN">)</span> <span class="QUESTION">?</span><span id="local_len_43"><span class="LIDENT">len</span></span> <span id="local_a_44"><span class="LIDENT">a</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_len_45"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="MATCH">match</span> <a href="#local_len_43"><span class="LIDENT">len</span></a> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">None</span>     <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/string.ml.html#val-length"><span class="UIDENT">String</span><span class="DOT">.</span><span class="LIDENT">length</span></a> <a href="#local_a_44"><span class="LIDENT">a</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <a href="#local_off_42"><span class="LIDENT">off</span></a><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_len_46"><span class="LIDENT">len</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_len_46"><span class="LIDENT">len</span></a><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span>    <span class="LIDENT">write_gen</span> <a href="#local_t_41"><span class="LIDENT">t</span></a> <span class="TILDE">~</span><a href="#local_blit_40"><span class="LIDENT">blit</span></a> <span class="TILDE">~</span><a href="#local_off_42"><span class="LIDENT">off</span></a> <span class="TILDE">~</span><a href="#local_len_45"><span class="LIDENT">len</span></a> <a href="#local_a_44"><span class="LIDENT">a</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-bytes"><span class="LIDENT">bytes</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_blit_47"><span class="LIDENT">blit</span></span> <span class="EQUAL">=</span> <a href="../../../bigstringaf/src/bigstringaf/bigstringaf.ml.html#val-blit_from_bytes"><span class="UIDENT">Bigstringaf</span><span class="DOT">.</span><span class="LIDENT">blit_from_bytes</span></a> <span class="IN">in</span><span class="EOL">
</span>  <span class="FUN">fun</span> <span id="local_t_48"><span class="LIDENT">t</span></span> <span class="QUESTION">?</span><span class="LPAREN">(</span><span id="local_off_49"><span class="LIDENT">off</span></span><span class="EQUAL">=</span><span class="INT">0</span><span class="RPAREN">)</span> <span class="QUESTION">?</span><span id="local_len_50"><span class="LIDENT">len</span></span> <span id="local_a_51"><span class="LIDENT">a</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_len_52"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>      <span class="MATCH">match</span> <a href="#local_len_50"><span class="LIDENT">len</span></a> <span class="WITH">with</span><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">None</span>     <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/bytes.ml.html#val-length"><span class="UIDENT">Bytes</span><span class="DOT">.</span><span class="LIDENT">length</span></a> <a href="#local_a_51"><span class="LIDENT">a</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <a href="#local_off_49"><span class="LIDENT">off</span></a><span class="EOL">
</span>      <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_len_53"><span class="LIDENT">len</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_len_53"><span class="LIDENT">len</span></a><span class="EOL">
</span>    <span class="IN">in</span><span class="EOL">
</span>    <span class="LIDENT">write_gen</span> <a href="#local_t_48"><span class="LIDENT">t</span></a> <span class="TILDE">~</span><a href="#local_blit_47"><span class="LIDENT">blit</span></a> <span class="TILDE">~</span><a href="#local_off_49"><span class="LIDENT">off</span></a> <span class="TILDE">~</span><a href="#local_len_52"><span class="LIDENT">len</span></a> <a href="#local_a_51"><span class="LIDENT">a</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-cstruct"><span class="LIDENT">cstruct</span></span> <span id="local_t_54"><span class="LIDENT">t</span></span> <span class="LBRACE">{</span> <span id="local_buffer_55"><span class="UIDENT">Cstruct</span><span class="DOT">.</span><span class="LIDENT">buffer</span></span><span class="SEMI">;</span> <span id="local_off_56"><span class="LIDENT">off</span></span><span class="SEMI">;</span> <span id="local_len_57"><span class="LIDENT">len</span></span> <span class="RBRACE">}</span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">write_gen</span> <a href="#local_t_54"><span class="LIDENT">t</span></a> <span class="TILDE">~</span><a href="#local_off_56"><span class="LIDENT">off</span></a> <span class="TILDE">~</span><a href="#local_len_57"><span class="LIDENT">len</span></a> <a href="#local_buffer_55"><span class="LIDENT">buffer</span></a><span class="EOL">
</span>    <span class="LABEL">~blit:</span><a href="../../../bigstringaf/src/bigstringaf/bigstringaf.ml.html#val-unsafe_blit"><span class="UIDENT">Bigstringaf</span><span class="DOT">.</span><span class="LIDENT">unsafe_blit</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-char"><span class="LIDENT">char</span></span> <span id="local_t_58"><span class="LIDENT">t</span></span> <span id="local_c_59"><span class="LIDENT">c</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">writable_exn</span> <a href="#local_t_58"><span class="LIDENT">t</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="LIDENT">ensure_space</span> <a href="#local_t_58"><span class="LIDENT">t</span></a> <span class="INT">1</span><span class="SEMI">;</span><span class="EOL">
</span>  <a href="../../../bigstringaf/src/bigstringaf/bigstringaf.ml.html#val-unsafe_set"><span class="UIDENT">Bigstringaf</span><span class="DOT">.</span><span class="LIDENT">unsafe_set</span></a> <a href="#local_t_58"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <a href="#local_t_58"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">write_pos</span> <a href="#local_c_59"><span class="LIDENT">c</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="LIDENT">advance_pos</span> <a href="#local_t_58"><span class="LIDENT">t</span></a> <span class="INT">1</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-uint8"><span class="LIDENT">uint8</span></span> <span id="local_t_60"><span class="LIDENT">t</span></span> <span id="local_b_61"><span class="LIDENT">b</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">writable_exn</span> <a href="#local_t_60"><span class="LIDENT">t</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="LIDENT">ensure_space</span> <a href="#local_t_60"><span class="LIDENT">t</span></a> <span class="INT">1</span><span class="SEMI">;</span><span class="EOL">
</span>  <a href="../../../bigstringaf/src/bigstringaf/bigstringaf.ml.html#val-unsafe_set"><span class="UIDENT">Bigstringaf</span><span class="DOT">.</span><span class="LIDENT">unsafe_set</span></a> <a href="#local_t_60"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <a href="#local_t_60"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">write_pos</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/char.ml.html#val-unsafe_chr"><span class="UIDENT">Char</span><span class="DOT">.</span><span class="LIDENT">unsafe_chr</span></a> <a href="#local_b_61"><span class="LIDENT">b</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>  <span class="LIDENT">advance_pos</span> <a href="#local_t_60"><span class="LIDENT">t</span></a> <span class="INT">1</span><span class="EOL">
</span><span class="EOL">
</span><span id="module-BE"><span class="MODULE">module</span> <span class="UIDENT">BE</span> <span class="EQUAL">=</span> <span class="STRUCT">struct</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-BE.val-uint16"><span class="LIDENT">uint16</span></span> <span id="local_t_62"><span class="LIDENT">t</span></span> <span id="local_i_63"><span class="LIDENT">i</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">writable_exn</span> <a href="#local_t_62"><span class="LIDENT">t</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">ensure_space</span> <a href="#local_t_62"><span class="LIDENT">t</span></a> <span class="INT">2</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="../../../bigstringaf/src/bigstringaf/bigstringaf.ml.html#def_130"><span class="UIDENT">Bigstringaf</span><span class="DOT">.</span><span class="LIDENT">unsafe_set_int16_be</span></a> <a href="#local_t_62"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <a href="#local_t_62"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">write_pos</span> <a href="#local_i_63"><span class="LIDENT">i</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">advance_pos</span> <a href="#local_t_62"><span class="LIDENT">t</span></a> <span class="INT">2</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-BE.val-uint32"><span class="LIDENT">uint32</span></span> <span id="local_t_64"><span class="LIDENT">t</span></span> <span id="local_i_65"><span class="LIDENT">i</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">writable_exn</span> <a href="#local_t_64"><span class="LIDENT">t</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">ensure_space</span> <a href="#local_t_64"><span class="LIDENT">t</span></a> <span class="INT">4</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="../../../bigstringaf/src/bigstringaf/bigstringaf.ml.html#def_138"><span class="UIDENT">Bigstringaf</span><span class="DOT">.</span><span class="LIDENT">unsafe_set_int32_be</span></a> <a href="#local_t_64"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <a href="#local_t_64"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">write_pos</span> <a href="#local_i_65"><span class="LIDENT">i</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">advance_pos</span> <a href="#local_t_64"><span class="LIDENT">t</span></a> <span class="INT">4</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-BE.val-uint48"><span class="LIDENT">uint48</span></span> <span id="local_t_66"><span class="LIDENT">t</span></span> <span id="local_i_67"><span class="LIDENT">i</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">writable_exn</span> <a href="#local_t_66"><span class="LIDENT">t</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">ensure_space</span> <a href="#local_t_66"><span class="LIDENT">t</span></a> <span class="INT">6</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="../../../bigstringaf/src/bigstringaf/bigstringaf.ml.html#def_130"><span class="UIDENT">Bigstringaf</span><span class="DOT">.</span><span class="LIDENT">unsafe_set_int16_be</span></a> <a href="#local_t_66"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <a href="#local_t_66"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">write_pos</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/int64.ml.html"><span class="UIDENT">Int64</span></a><span class="DOT">.</span><span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/int64.ml.html#val-to_int"><span class="LIDENT">to_int</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/int64.ml.html#val-shift_right_logical"><span class="LIDENT">shift_right_logical</span></a> <a href="#local_i_67"><span class="LIDENT">i</span></a> <span class="INT">32</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="../../../bigstringaf/src/bigstringaf/bigstringaf.ml.html#def_138"><span class="UIDENT">Bigstringaf</span><span class="DOT">.</span><span class="LIDENT">unsafe_set_int32_be</span></a> <a href="#local_t_66"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <span class="LPAREN">(</span><a href="#local_t_66"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">write_pos</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <span class="INT">2</span><span class="RPAREN">)</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/int64.ml.html"><span class="UIDENT">Int64</span></a><span class="DOT">.</span><span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/int64.ml.html#val-to_int32"><span class="LIDENT">to_int32</span></a> <a href="#local_i_67"><span class="LIDENT">i</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">advance_pos</span> <a href="#local_t_66"><span class="LIDENT">t</span></a> <span class="INT">6</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-BE.val-uint64"><span class="LIDENT">uint64</span></span> <span id="local_t_68"><span class="LIDENT">t</span></span> <span id="local_i_69"><span class="LIDENT">i</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">writable_exn</span> <a href="#local_t_68"><span class="LIDENT">t</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">ensure_space</span> <a href="#local_t_68"><span class="LIDENT">t</span></a> <span class="INT">8</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="../../../bigstringaf/src/bigstringaf/bigstringaf.ml.html#def_128"><span class="UIDENT">Bigstringaf</span><span class="DOT">.</span><span class="LIDENT">unsafe_set_int64_be</span></a> <a href="#local_t_68"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <a href="#local_t_68"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">write_pos</span> <a href="#local_i_69"><span class="LIDENT">i</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">advance_pos</span> <a href="#local_t_68"><span class="LIDENT">t</span></a> <span class="INT">8</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-BE.val-float"><span class="LIDENT">float</span></span> <span id="local_t_70"><span class="LIDENT">t</span></span> <span id="local_f_71"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">writable_exn</span> <a href="#local_t_70"><span class="LIDENT">t</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">ensure_space</span> <a href="#local_t_70"><span class="LIDENT">t</span></a> <span class="INT">4</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="../../../bigstringaf/src/bigstringaf/bigstringaf.ml.html#def_138"><span class="UIDENT">Bigstringaf</span><span class="DOT">.</span><span class="LIDENT">unsafe_set_int32_be</span></a> <a href="#local_t_70"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <a href="#local_t_70"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">write_pos</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/int32.ml.html#val-bits_of_float"><span class="UIDENT">Int32</span><span class="DOT">.</span><span class="LIDENT">bits_of_float</span></a> <a href="#local_f_71"><span class="LIDENT">f</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">advance_pos</span> <a href="#local_t_70"><span class="LIDENT">t</span></a> <span class="INT">4</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-BE.val-double"><span class="LIDENT">double</span></span> <span id="local_t_72"><span class="LIDENT">t</span></span> <span id="local_d_73"><span class="LIDENT">d</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">writable_exn</span> <a href="#local_t_72"><span class="LIDENT">t</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">ensure_space</span> <a href="#local_t_72"><span class="LIDENT">t</span></a> <span class="INT">8</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="../../../bigstringaf/src/bigstringaf/bigstringaf.ml.html#def_128"><span class="UIDENT">Bigstringaf</span><span class="DOT">.</span><span class="LIDENT">unsafe_set_int64_be</span></a> <a href="#local_t_72"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <a href="#local_t_72"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">write_pos</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/int64.ml.html#val-bits_of_float"><span class="UIDENT">Int64</span><span class="DOT">.</span><span class="LIDENT">bits_of_float</span></a> <a href="#local_d_73"><span class="LIDENT">d</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">advance_pos</span> <a href="#local_t_72"><span class="LIDENT">t</span></a> <span class="INT">8</span><span class="EOL">
</span><span class="END">end</span></span><span class="EOL">
</span><span class="EOL">
</span><span id="module-LE"><span class="MODULE">module</span> <span class="UIDENT">LE</span> <span class="EQUAL">=</span> <span class="STRUCT">struct</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-LE.val-uint16"><span class="LIDENT">uint16</span></span> <span id="local_t_74"><span class="LIDENT">t</span></span> <span id="local_i_75"><span class="LIDENT">i</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">writable_exn</span> <a href="#local_t_74"><span class="LIDENT">t</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">ensure_space</span> <a href="#local_t_74"><span class="LIDENT">t</span></a> <span class="INT">2</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="../../../bigstringaf/src/bigstringaf/bigstringaf.ml.html#def_130"><span class="UIDENT">Bigstringaf</span><span class="DOT">.</span><span class="LIDENT">unsafe_set_int16_le</span></a> <a href="#local_t_74"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <a href="#local_t_74"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">write_pos</span> <a href="#local_i_75"><span class="LIDENT">i</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">advance_pos</span> <a href="#local_t_74"><span class="LIDENT">t</span></a> <span class="INT">2</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-LE.val-uint32"><span class="LIDENT">uint32</span></span> <span id="local_t_76"><span class="LIDENT">t</span></span> <span id="local_i_77"><span class="LIDENT">i</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">writable_exn</span> <a href="#local_t_76"><span class="LIDENT">t</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">ensure_space</span> <a href="#local_t_76"><span class="LIDENT">t</span></a> <span class="INT">4</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="../../../bigstringaf/src/bigstringaf/bigstringaf.ml.html#def_138"><span class="UIDENT">Bigstringaf</span><span class="DOT">.</span><span class="LIDENT">unsafe_set_int32_le</span></a> <a href="#local_t_76"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <a href="#local_t_76"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">write_pos</span> <a href="#local_i_77"><span class="LIDENT">i</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">advance_pos</span> <a href="#local_t_76"><span class="LIDENT">t</span></a> <span class="INT">4</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-LE.val-uint48"><span class="LIDENT">uint48</span></span> <span id="local_t_78"><span class="LIDENT">t</span></span> <span id="local_i_79"><span class="LIDENT">i</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">writable_exn</span> <a href="#local_t_78"><span class="LIDENT">t</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">ensure_space</span> <a href="#local_t_78"><span class="LIDENT">t</span></a> <span class="INT">6</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="../../../bigstringaf/src/bigstringaf/bigstringaf.ml.html#def_130"><span class="UIDENT">Bigstringaf</span><span class="DOT">.</span><span class="LIDENT">unsafe_set_int16_le</span></a> <a href="#local_t_78"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <a href="#local_t_78"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">write_pos</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/int64.ml.html"><span class="UIDENT">Int64</span></a><span class="DOT">.</span><span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/int64.ml.html#val-to_int"><span class="LIDENT">to_int</span></a> <a href="#local_i_79"><span class="LIDENT">i</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="../../../bigstringaf/src/bigstringaf/bigstringaf.ml.html#def_138"><span class="UIDENT">Bigstringaf</span><span class="DOT">.</span><span class="LIDENT">unsafe_set_int32_le</span></a> <a href="#local_t_78"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <span class="LPAREN">(</span><a href="#local_t_78"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">write_pos</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <span class="INT">2</span><span class="RPAREN">)</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/int64.ml.html"><span class="UIDENT">Int64</span></a><span class="DOT">.</span><span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/int64.ml.html#val-to_int32"><span class="LIDENT">to_int32</span></a> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/int64.ml.html#val-shift_right_logical"><span class="LIDENT">shift_right_logical</span></a> <a href="#local_i_79"><span class="LIDENT">i</span></a> <span class="INT">16</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">advance_pos</span> <a href="#local_t_78"><span class="LIDENT">t</span></a> <span class="INT">6</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-LE.val-uint64"><span class="LIDENT">uint64</span></span> <span id="local_t_80"><span class="LIDENT">t</span></span> <span id="local_i_81"><span class="LIDENT">i</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">writable_exn</span> <a href="#local_t_80"><span class="LIDENT">t</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">ensure_space</span> <a href="#local_t_80"><span class="LIDENT">t</span></a> <span class="INT">8</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="../../../bigstringaf/src/bigstringaf/bigstringaf.ml.html#def_128"><span class="UIDENT">Bigstringaf</span><span class="DOT">.</span><span class="LIDENT">unsafe_set_int64_le</span></a> <a href="#local_t_80"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <a href="#local_t_80"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">write_pos</span> <a href="#local_i_81"><span class="LIDENT">i</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">advance_pos</span> <a href="#local_t_80"><span class="LIDENT">t</span></a> <span class="INT">8</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-LE.val-float"><span class="LIDENT">float</span></span> <span id="local_t_82"><span class="LIDENT">t</span></span> <span id="local_f_83"><span class="LIDENT">f</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">writable_exn</span> <a href="#local_t_82"><span class="LIDENT">t</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">ensure_space</span> <a href="#local_t_82"><span class="LIDENT">t</span></a> <span class="INT">4</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="../../../bigstringaf/src/bigstringaf/bigstringaf.ml.html#def_138"><span class="UIDENT">Bigstringaf</span><span class="DOT">.</span><span class="LIDENT">unsafe_set_int32_le</span></a> <a href="#local_t_82"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <a href="#local_t_82"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">write_pos</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/int32.ml.html#val-bits_of_float"><span class="UIDENT">Int32</span><span class="DOT">.</span><span class="LIDENT">bits_of_float</span></a> <a href="#local_f_83"><span class="LIDENT">f</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">advance_pos</span> <a href="#local_t_82"><span class="LIDENT">t</span></a> <span class="INT">4</span><span class="EOL">
</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="module-LE.val-double"><span class="LIDENT">double</span></span> <span id="local_t_84"><span class="LIDENT">t</span></span> <span id="local_d_85"><span class="LIDENT">d</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LIDENT">writable_exn</span> <a href="#local_t_84"><span class="LIDENT">t</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">ensure_space</span> <a href="#local_t_84"><span class="LIDENT">t</span></a> <span class="INT">8</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="../../../bigstringaf/src/bigstringaf/bigstringaf.ml.html#def_128"><span class="UIDENT">Bigstringaf</span><span class="DOT">.</span><span class="LIDENT">unsafe_set_int64_le</span></a> <a href="#local_t_84"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">buffer</span> <a href="#local_t_84"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">write_pos</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/int64.ml.html#val-bits_of_float"><span class="UIDENT">Int64</span><span class="DOT">.</span><span class="LIDENT">bits_of_float</span></a> <a href="#local_d_85"><span class="LIDENT">d</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">advance_pos</span> <a href="#local_t_84"><span class="LIDENT">t</span></a> <span class="INT">8</span><span class="EOL">
</span><span class="END">end</span></span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-close"><span class="LIDENT">close</span></span> <span id="local_t_86"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="#local_t_86"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="LESSMINUS">&lt;-</span> <span class="UIDENT">Closed</span><span class="SEMI">;</span><span class="EOL">
</span>  <span class="LIDENT">flush_buffer</span> <a href="#local_t_86"><span class="LIDENT">t</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="LIDENT">wake_writer</span> <a href="#local_t_86"><span class="LIDENT">t</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-is_closed"><span class="LIDENT">is_closed</span></span> <span id="local_t_87"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="MATCH">match</span> <a href="#local_t_87"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Closed</span> <span class="MINUSGREATER">-&gt;</span> <span class="TRUE">true</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Active</span> <span class="BAR">|</span> <span class="UIDENT">Paused</span> <span class="MINUSGREATER">-&gt;</span> <span class="FALSE">false</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-abort"><span class="LIDENT">abort</span></span> <span id="local_t_88"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">close</span> <a href="#local_t_88"><span class="LIDENT">t</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="REC">rec</span> <span id="local_aux_89"><span class="LIDENT">aux</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="MATCH">match</span> <span class="UIDENT">Flushes</span><span class="DOT">.</span><span class="LIDENT">dequeue_exn</span> <a href="#local_t_88"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">flushed</span> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="EXCEPTION">exception</span> <span class="UIDENT">Dequeue_empty</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="LPAREN">(</span><span id="local__threshold_90"><span class="LIDENT">_threshold</span></span><span class="COMMA">,</span> <span id="local_r_91"><span class="LIDENT">r</span></span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="../eio.core/promise.ml.html#val-resolve_error"><span class="UIDENT">Promise</span><span class="DOT">.</span><span class="LIDENT">resolve_error</span></a> <a href="#local_r_91"><span class="LIDENT">r</span></a> <span class="UIDENT">Flush_aborted</span><span class="SEMI">;</span><span class="EOL">
</span>      <a href="#local_aux_89"><span class="LIDENT">aux</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <a href="#local_aux_89"><span class="LIDENT">aux</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-of_buffer"><span class="LIDENT">of_buffer</span></span> <span class="QUESTION">?</span><span id="local_sw_92"><span class="LIDENT">sw</span></span> <span id="local_buffer_93"><span class="LIDENT">buffer</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_t_94"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span> <span class="LBRACE">{</span> <a href="#local_buffer_93"><span class="LIDENT">buffer</span></a><span class="EOL">
</span>          <span class="SEMI">;</span> <span class="LIDENT">write_pos</span>       <span class="EQUAL">=</span> <span class="INT">0</span><span class="EOL">
</span>          <span class="SEMI">;</span> <span class="LIDENT">scheduled_pos</span>   <span class="EQUAL">=</span> <span class="INT">0</span><span class="EOL">
</span>          <span class="SEMI">;</span> <span class="LIDENT">scheduled</span>       <span class="EQUAL">=</span> <span class="UIDENT">Buffers</span><span class="DOT">.</span><span class="LIDENT">create</span> <span class="INT">4</span><span class="EOL">
</span>          <span class="SEMI">;</span> <span class="LIDENT">flushed</span>         <span class="EQUAL">=</span> <span class="UIDENT">Flushes</span><span class="DOT">.</span><span class="LIDENT">create</span> <span class="INT">1</span><span class="EOL">
</span>          <span class="SEMI">;</span> <span class="LIDENT">bytes_received</span>  <span class="EQUAL">=</span> <span class="INT">0</span><span class="EOL">
</span>          <span class="SEMI">;</span> <span class="LIDENT">bytes_written</span>   <span class="EQUAL">=</span> <span class="INT">0</span><span class="EOL">
</span>          <span class="SEMI">;</span> <span class="LIDENT">state</span>           <span class="EQUAL">=</span> <span class="UIDENT">Active</span><span class="EOL">
</span>          <span class="SEMI">;</span> <span class="LIDENT">wake_writer</span>     <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a><span class="EOL">
</span>          <span class="SEMI">;</span> <span class="LIDENT">printf</span>          <span class="EQUAL">=</span> <span class="UIDENT">None</span><span class="EOL">
</span>          <span class="RBRACE">}</span><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <span class="BEGIN">begin</span> <span class="MATCH">match</span> <a href="#local_sw_92"><span class="LIDENT">sw</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Some</span> <span id="local_sw_95"><span class="LIDENT">sw</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="../eio.core/switch.ml.html#val-on_release"><span class="UIDENT">Switch</span><span class="DOT">.</span><span class="LIDENT">on_release</span></a> <a href="#local_sw_95"><span class="LIDENT">sw</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">abort</span> <a href="#local_t_94"><span class="LIDENT">t</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="END">end</span><span class="SEMI">;</span><span class="EOL">
</span>  <a href="#local_t_94"><span class="LIDENT">t</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-create"><span class="LIDENT">create</span></span> <span class="QUESTION">?</span><span id="local_sw_96"><span class="LIDENT">sw</span></span> <span id="local_size_97"><span class="LIDENT">size</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">of_buffer</span> <span class="QUESTION">?</span><a href="#local_sw_96"><span class="LIDENT">sw</span></a> <span class="LPAREN">(</span><a href="../../../bigstringaf/src/bigstringaf/bigstringaf.ml.html#val-create"><span class="UIDENT">Bigstringaf</span><span class="DOT">.</span><span class="LIDENT">create</span></a> <a href="#local_size_97"><span class="LIDENT">size</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-pending_bytes"><span class="LIDENT">pending_bytes</span></span> <span id="local_t_98"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LPAREN">(</span><a href="#local_t_98"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">write_pos</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <a href="#local_t_98"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">scheduled_pos</span><span class="RPAREN">)</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <span class="LPAREN">(</span><a href="#local_t_98"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">bytes_received</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <a href="#local_t_98"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">bytes_written</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-has_pending_output"><span class="LIDENT">has_pending_output</span></span> <span id="local_t_99"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">pending_bytes</span> <a href="#local_t_99"><span class="LIDENT">t</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;&gt;)"><span class="INFIXOP0">&lt;&gt;</span></a> <span class="INT">0</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-pause"><span class="LIDENT">pause</span></span> <span id="local_t_100"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="MATCH">match</span> <a href="#local_t_100"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Active</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_t_100"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="LESSMINUS">&lt;-</span> <span class="UIDENT">Paused</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Paused</span> <span class="BAR">|</span> <span class="UIDENT">Closed</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-unpause"><span class="LIDENT">unpause</span></span> <span id="local_t_101"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="MATCH">match</span> <a href="#local_t_101"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Active</span> <span class="BAR">|</span> <span class="UIDENT">Closed</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Paused</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="#local_t_101"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">state</span> <span class="LESSMINUS">&lt;-</span> <span class="UIDENT">Active</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="IF">if</span> <span class="LIDENT">has_pending_output</span> <a href="#local_t_101"><span class="LIDENT">t</span></a> <span class="THEN">then</span><span class="EOL">
</span>      <span class="LIDENT">wake_writer</span> <a href="#local_t_101"><span class="LIDENT">t</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-flush"><span class="LIDENT">flush</span></span> <span id="local_t_102"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">flush_buffer</span> <a href="#local_t_102"><span class="LIDENT">t</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="LIDENT">unpause</span> <a href="#local_t_102"><span class="LIDENT">t</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-not"><span class="LIDENT">not</span></a> <span class="LPAREN">(</span><span class="UIDENT">Buffers</span><span class="DOT">.</span><span class="LIDENT">is_empty</span> <a href="#local_t_102"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">scheduled</span><span class="RPAREN">)</span> <span class="THEN">then</span> <span class="LPAREN">(</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="def_172"><span id="local_p_103"><span class="LIDENT">p</span></span><span class="COMMA">,</span> <span id="local_r_104"><span class="LIDENT">r</span></span></span> <span class="EQUAL">=</span> <a href="../eio.core/promise.ml.html#val-create"><span class="UIDENT">Promise</span><span class="DOT">.</span><span class="LIDENT">create</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="IN">in</span><span class="EOL">
</span>    <span class="UIDENT">Flushes</span><span class="DOT">.</span><span class="LIDENT">enqueue</span> <span class="LPAREN">(</span><a href="#local_t_102"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">bytes_received</span><span class="COMMA">,</span> <a href="#local_r_104"><span class="LIDENT">r</span></a><span class="RPAREN">)</span> <a href="#local_t_102"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">flushed</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="../eio.core/promise.ml.html#val-await_exn"><span class="UIDENT">Promise</span><span class="DOT">.</span><span class="LIDENT">await_exn</span></a> <a href="#local_p_103"><span class="LIDENT">p</span></a><span class="EOL">
</span>  <span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-make_formatter"><span class="LIDENT">make_formatter</span></span> <span id="local_t_105"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="../../../ocaml-base-compiler/src/stdlib/format.ml.html#val-make_formatter"><span class="UIDENT">Format</span><span class="DOT">.</span><span class="LIDENT">make_formatter</span></a><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_buf_106"><span class="LIDENT">buf</span></span> <span id="local_off_107"><span class="LIDENT">off</span></span> <span id="local_len_108"><span class="LIDENT">len</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">write_gen</span> <a href="#local_t_105"><span class="LIDENT">t</span></a> <a href="#local_buf_106"><span class="LIDENT">buf</span></a> <span class="TILDE">~</span><a href="#local_off_107"><span class="LIDENT">off</span></a> <span class="TILDE">~</span><a href="#local_len_108"><span class="LIDENT">len</span></a> <span class="LABEL">~blit:</span><a href="../../../bigstringaf/src/bigstringaf/bigstringaf.ml.html#val-blit_from_string"><span class="UIDENT">Bigstringaf</span><span class="DOT">.</span><span class="LIDENT">blit_from_string</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">flush</span> <a href="#local_t_105"><span class="LIDENT">t</span></a><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-printf"><span class="LIDENT">printf</span></span> <span id="local_t_109"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="def_175"><span id="local_ppf_110"><span class="LIDENT">ppf</span></span><span class="COMMA">,</span> <span id="local_is_formatting_111"><span class="LIDENT">is_formatting</span></span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_t_109"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">printf</span> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Some</span> <span class="LPAREN">(</span><span class="UNDERSCORE">_</span><span class="COMMA">,</span> <span id="local_is_formatting_113"><span class="LIDENT">is_formatting</span></span> <span class="AS">as</span> <span id="local_x_112"><span class="LIDENT">x</span></span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <a href="#local_is_formatting_113"><span class="LIDENT">is_formatting</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <span class="TRUE">true</span><span class="SEMI">;</span><span class="EOL">
</span>      <a href="#local_x_112"><span class="LIDENT">x</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">None</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_is_formatting_114"><span class="LIDENT">is_formatting</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ref"><span class="LIDENT">ref</span></a> <span class="TRUE">true</span> <span class="IN">in</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_ppf_115"><span class="LIDENT">ppf</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>        <a href="../../../ocaml-base-compiler/src/stdlib/format.ml.html#val-make_formatter"><span class="UIDENT">Format</span><span class="DOT">.</span><span class="LIDENT">make_formatter</span></a><span class="EOL">
</span>          <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_buf_116"><span class="LIDENT">buf</span></span> <span id="local_off_117"><span class="LIDENT">off</span></span> <span id="local_len_118"><span class="LIDENT">len</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">write_gen</span> <a href="#local_t_109"><span class="LIDENT">t</span></a> <a href="#local_buf_116"><span class="LIDENT">buf</span></a> <span class="TILDE">~</span><a href="#local_off_117"><span class="LIDENT">off</span></a> <span class="TILDE">~</span><a href="#local_len_118"><span class="LIDENT">len</span></a> <span class="LABEL">~blit:</span><a href="../../../bigstringaf/src/bigstringaf/bigstringaf.ml.html#val-blit_from_string"><span class="UIDENT">Bigstringaf</span><span class="DOT">.</span><span class="LIDENT">blit_from_string</span></a><span class="RPAREN">)</span><span class="EOL">
</span>          <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>             <span class="COMMENT">(* As per the Format module manual, an explicit flush writes to the
                output channel and ensures that &quot;all pending text is displayed&quot;
                and &quot;these explicit flush calls [...] could dramatically impact efficiency&quot;.
                Therefore it is clear that we need to call `flush t` instead of `flush_buffer t`. *)</span><span class="EOL">
</span>             <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="#local_is_formatting_114"><span class="LIDENT">is_formatting</span></a> <span class="THEN">then</span> <span class="LIDENT">flush</span> <a href="#local_t_109"><span class="LIDENT">t</span></a><span class="RPAREN">)</span><span class="EOL">
</span>      <span class="IN">in</span><span class="EOL">
</span>      <a href="#local_t_109"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">printf</span> <span class="LESSMINUS">&lt;-</span> <span class="UIDENT">Some</span> <span class="LPAREN">(</span><a href="#local_ppf_115"><span class="LIDENT">ppf</span></a><span class="COMMA">,</span> <a href="#local_is_formatting_114"><span class="LIDENT">is_formatting</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>      <a href="#local_ppf_115"><span class="LIDENT">ppf</span></a><span class="COMMA">,</span> <a href="#local_is_formatting_114"><span class="LIDENT">is_formatting</span></a><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <a href="../../../ocaml-base-compiler/src/stdlib/format.ml.html#val-kfprintf"><span class="UIDENT">Format</span><span class="DOT">.</span><span class="LIDENT">kfprintf</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_ppf_119"><span class="LIDENT">ppf</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-not"><span class="LIDENT">not</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="#local_is_formatting_111"><span class="LIDENT">is_formatting</span></a> <span class="THEN">then</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-raise"><span class="LIDENT">raise</span></a> <span class="LPAREN">(</span><span class="UIDENT">Sys_error</span> <span class="STRING">&quot;Buf_write.printf: invalid concurrent access&quot;</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>      <span class="COMMENT">(* Ensure that [ppf]'s internal buffer is flushed to [t], but without flushing [t] itself: *)</span><span class="EOL">
</span>      <a href="#local_is_formatting_111"><span class="LIDENT">is_formatting</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <span class="FALSE">false</span><span class="SEMI">;</span><span class="EOL">
</span>      <a href="../../../ocaml-base-compiler/src/stdlib/format.ml.html#val-pp_print_flush"><span class="UIDENT">Format</span><span class="DOT">.</span><span class="LIDENT">pp_print_flush</span></a> <a href="#local_ppf_119"><span class="LIDENT">ppf</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="RPAREN">)</span> <a href="#local_ppf_110"><span class="LIDENT">ppf</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span class="REC">rec</span> <span id="val-shift_buffers"><span class="LIDENT">shift_buffers</span></span> <span id="local_t_120"><span class="LIDENT">t</span></span> <span id="local_written_121"><span class="LIDENT">written</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="MATCH">match</span> <span class="UIDENT">Buffers</span><span class="DOT">.</span><span class="LIDENT">dequeue_exn</span> <a href="#local_t_120"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">scheduled</span> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="LBRACE">{</span> <span id="local_len_123"><span class="UIDENT">Cstruct</span><span class="DOT">.</span><span class="LIDENT">len</span></span><span class="SEMI">;</span> <span class="UNDERSCORE">_</span> <span class="RBRACE">}</span> <span class="AS">as</span> <span id="local_iovec_122"><span class="LIDENT">iovec</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_len_123"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&lt;=)"><span class="INFIXOP0">&lt;=</span></a> <a href="#local_written_121"><span class="LIDENT">written</span></a> <span class="THEN">then</span><span class="EOL">
</span>      <span class="LIDENT">shift_buffers</span> <a href="#local_t_120"><span class="LIDENT">t</span></a> <span class="LPAREN">(</span><a href="#local_written_121"><span class="LIDENT">written</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <a href="#local_len_123"><span class="LIDENT">len</span></a><span class="RPAREN">)</span><span class="EOL">
</span>    <span class="ELSE">else</span><span class="EOL">
</span>      <span class="UIDENT">Buffers</span><span class="DOT">.</span><span class="LIDENT">enqueue_front</span> <span class="LPAREN">(</span><a href="../../../cstruct/src/cstruct/cstruct.ml.html#val-shift"><span class="UIDENT">Cstruct</span><span class="DOT">.</span><span class="LIDENT">shift</span></a> <a href="#local_iovec_122"><span class="LIDENT">iovec</span></a> <a href="#local_written_121"><span class="LIDENT">written</span></a><span class="RPAREN">)</span> <a href="#local_t_120"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">scheduled</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="EXCEPTION">exception</span> <span class="UIDENT">Dequeue_empty</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="ASSERT">assert</span> <span class="LPAREN">(</span><a href="#local_written_121"><span class="LIDENT">written</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <span class="INT">0</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_t_120"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">scheduled_pos</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(=)"><span class="EQUAL">=</span></a> <a href="#local_t_120"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">write_pos</span> <span class="THEN">then</span> <span class="BEGIN">begin</span><span class="EOL">
</span>      <a href="#local_t_120"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">scheduled_pos</span> <span class="LESSMINUS">&lt;-</span> <span class="INT">0</span><span class="SEMI">;</span><span class="EOL">
</span>      <a href="#local_t_120"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">write_pos</span> <span class="LESSMINUS">&lt;-</span> <span class="INT">0</span><span class="EOL">
</span>    <span class="END">end</span><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* Resolve any flushes that are now due. *)</span><span class="EOL">
</span><span class="LET">let</span> <span class="REC">rec</span> <span id="val-shift_flushes"><span class="LIDENT">shift_flushes</span></span> <span id="local_t_124"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="MATCH">match</span> <span class="UIDENT">Flushes</span><span class="DOT">.</span><span class="LIDENT">dequeue_exn</span> <a href="#local_t_124"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">flushed</span> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="EXCEPTION">exception</span> <span class="UIDENT">Dequeue_empty</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="LPAREN">(</span><span id="local_threshold_126"><span class="LIDENT">threshold</span></span><span class="COMMA">,</span> <span id="local_r_127"><span class="LIDENT">r</span></span><span class="RPAREN">)</span> <span class="AS">as</span> <span id="local_flush_125"><span class="LIDENT">flush</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="COMMENT">(* Be careful: [bytes_written] and [threshold] both wrap, so subtract first. *)</span><span class="EOL">
</span>    <span class="IF">if</span> <a href="#local_t_124"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">bytes_written</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(-)"><span class="MINUS">-</span></a> <a href="#local_threshold_126"><span class="LIDENT">threshold</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(&gt;=)"><span class="INFIXOP0">&gt;=</span></a> <span class="INT">0</span> <span class="THEN">then</span> <span class="LPAREN">(</span><span class="EOL">
</span>      <span class="COMMENT">(* We have written at least up to [threshold]
         (or we're more than [max_int] behind, which we assume won't happen). *)</span><span class="EOL">
</span>      <a href="../eio.core/promise.ml.html#val-resolve_ok"><span class="UIDENT">Promise</span><span class="DOT">.</span><span class="LIDENT">resolve_ok</span></a> <a href="#local_r_127"><span class="LIDENT">r</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>      <span class="LIDENT">shift_flushes</span> <a href="#local_t_124"><span class="LIDENT">t</span></a><span class="EOL">
</span>    <span class="RPAREN">)</span> <span class="ELSE">else</span> <span class="LPAREN">(</span><span class="EOL">
</span>      <span class="UIDENT">Flushes</span><span class="DOT">.</span><span class="LIDENT">enqueue_front</span> <a href="#local_flush_125"><span class="LIDENT">flush</span></a> <a href="#local_t_124"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">flushed</span><span class="EOL">
</span>    <span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-shift"><span class="LIDENT">shift</span></span> <span id="local_t_128"><span class="LIDENT">t</span></span> <span id="local_written_129"><span class="LIDENT">written</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">shift_buffers</span> <a href="#local_t_128"><span class="LIDENT">t</span></a> <a href="#local_written_129"><span class="LIDENT">written</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <a href="#local_t_128"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">bytes_written</span> <span class="LESSMINUS">&lt;-</span> <a href="#local_t_128"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">bytes_written</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <a href="#local_written_129"><span class="LIDENT">written</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="LIDENT">shift_flushes</span> <a href="#local_t_128"><span class="LIDENT">t</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span class="REC">rec</span> <span id="val-await_batch"><span class="LIDENT">await_batch</span></span> <span id="local_t_130"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">flush_buffer</span> <a href="#local_t_130"><span class="LIDENT">t</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="MATCH">match</span> <a href="#local_t_130"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">state</span><span class="COMMA">,</span> <span class="LIDENT">has_pending_output</span> <a href="#local_t_130"><span class="LIDENT">t</span></a> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Closed</span><span class="COMMA">,</span> <span class="FALSE">false</span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-raise"><span class="LIDENT">raise</span></a> <span class="UIDENT">End_of_file</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="LPAREN">(</span><span class="UIDENT">Active</span> <span class="BAR">|</span> <span class="UIDENT">Closed</span><span class="RPAREN">)</span><span class="COMMA">,</span> <span class="TRUE">true</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Buffers</span><span class="DOT">.</span><span class="LIDENT">to_list</span> <a href="#local_t_130"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">scheduled</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="UIDENT">Paused</span><span class="COMMA">,</span> <span class="UNDERSCORE">_</span> <span class="BAR">|</span> <span class="UIDENT">Active</span><span class="COMMA">,</span> <span class="FALSE">false</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <a href="../eio.core/suspend.ml.html#val-enter"><span class="UIDENT">Suspend</span><span class="DOT">.</span><span class="LIDENT">enter</span></a> <span class="STRING">&quot;Buf_write.await_batch&quot;</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_ctx_131"><span class="LIDENT">ctx</span></span> <span id="local_enqueue_132"><span class="LIDENT">enqueue</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>        <a href="../eio.core/cancel.ml.html#module-Fiber_context.val-set_cancel_fn"><span class="UIDENT">Fiber_context</span><span class="DOT">.</span><span class="LIDENT">set_cancel_fn</span></a> <a href="#local_ctx_131"><span class="LIDENT">ctx</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span id="local_ex_133"><span class="LIDENT">ex</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <a href="#local_t_130"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">wake_writer</span> <span class="LESSMINUS">&lt;-</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ignore"><span class="LIDENT">ignore</span></a><span class="SEMI">;</span><span class="EOL">
</span>            <a href="#local_enqueue_132"><span class="LIDENT">enqueue</span></a> <span class="LPAREN">(</span><span class="UIDENT">Error</span> <a href="#local_ex_133"><span class="LIDENT">ex</span></a><span class="RPAREN">)</span><span class="EOL">
</span>          <span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>        <a href="#local_t_130"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">wake_writer</span> <span class="LESSMINUS">&lt;-</span> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>            <span class="COMMENT">(* Our caller has already set [wake_writer &lt;- ignore]. *)</span><span class="EOL">
</span>            <a href="../eio.core/cancel.ml.html#module-Fiber_context.val-clear_cancel_fn"><span class="UIDENT">Fiber_context</span><span class="DOT">.</span><span class="LIDENT">clear_cancel_fn</span></a> <a href="#local_ctx_131"><span class="LIDENT">ctx</span></a><span class="SEMI">;</span><span class="EOL">
</span>            <a href="#local_enqueue_132"><span class="LIDENT">enqueue</span></a> <span class="LPAREN">(</span><span class="UIDENT">Ok</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="EOL">
</span>          <span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>      <span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">await_batch</span> <a href="#local_t_130"><span class="LIDENT">t</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="COMMENT">(* We have to do our own copy, because we can't [shift] until the write is complete. *)</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-copy"><span class="LIDENT">copy</span></span> <span id="local_t_134"><span class="LIDENT">t</span></span> <span id="local_flow_135"><span class="LIDENT">flow</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="REC">rec</span> <span id="local_aux_136"><span class="LIDENT">aux</span></span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_iovecs_137"><span class="LIDENT">iovecs</span></span> <span class="EQUAL">=</span> <span class="LIDENT">await_batch</span> <a href="#local_t_134"><span class="LIDENT">t</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_wrote_138"><span class="LIDENT">wrote</span></span> <span class="EQUAL">=</span> <a href="flow.ml.html#val-single_write"><span class="UIDENT">Flow</span><span class="DOT">.</span><span class="LIDENT">single_write</span></a> <a href="#local_flow_135"><span class="LIDENT">flow</span></a> <a href="#local_iovecs_137"><span class="LIDENT">iovecs</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LIDENT">shift</span> <a href="#local_t_134"><span class="LIDENT">t</span></a> <a href="#local_wrote_138"><span class="LIDENT">wrote</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <a href="#local_aux_136"><span class="LIDENT">aux</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <span class="TRY">try</span> <a href="#local_aux_136"><span class="LIDENT">aux</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="WITH">with</span> <span class="UIDENT">End_of_file</span> <span class="MINUSGREATER">-&gt;</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-with_flow"><span class="LIDENT">with_flow</span></span> <span class="QUESTION">?</span><span class="LPAREN">(</span><span id="local_initial_size_139"><span class="LIDENT">initial_size</span></span><span class="EQUAL">=</span><span class="INT">0x1000</span><span class="RPAREN">)</span> <span id="local_flow_140"><span class="LIDENT">flow</span></span> <span id="local_fn_141"><span class="LIDENT">fn</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <a href="../eio.core/switch.ml.html#val-run"><span class="UIDENT">Switch</span><span class="DOT">.</span><span class="LIDENT">run</span></a> <span class="LABEL">~name:</span><span class="STRING">&quot;Buf_write.with_flow&quot;</span> <span class="INFIXOP1">@@</span> <span class="FUN">fun</span> <span id="local_sw_142"><span class="LIDENT">sw</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>  <span class="LET">let</span> <span id="local_t_143"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span> <span class="LIDENT">create</span> <span class="TILDE">~</span><a href="#local_sw_142"><span class="LIDENT">sw</span></a> <a href="#local_initial_size_139"><span class="LIDENT">initial_size</span></a> <span class="IN">in</span><span class="EOL">
</span>  <a href="../eio.core/fiber.ml.html#val-fork"><span class="UIDENT">Fiber</span><span class="DOT">.</span><span class="LIDENT">fork</span></a> <span class="TILDE">~</span><a href="#local_sw_142"><span class="LIDENT">sw</span></a> <span class="LPAREN">(</span><span class="FUN">fun</span> <span class="LPAREN">(</span><span class="RPAREN">)</span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">copy</span> <a href="#local_t_143"><span class="LIDENT">t</span></a> <a href="#local_flow_140"><span class="LIDENT">flow</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>  <span class="MATCH">match</span> <a href="#local_fn_141"><span class="LIDENT">fn</span></a> <a href="#local_t_143"><span class="LIDENT">t</span></a> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span id="local_x_144"><span class="LIDENT">x</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LIDENT">close</span> <a href="#local_t_143"><span class="LIDENT">t</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <a href="#local_x_144"><span class="LIDENT">x</span></a><span class="EOL">
</span>  <span class="BAR">|</span> <span class="EXCEPTION">exception</span> <span id="local_ex_145"><span class="LIDENT">ex</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LIDENT">close</span> <a href="#local_t_143"><span class="LIDENT">t</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="COMMENT">(* Raising the exception will cancel the writer thread, so do a flush first.
       We don't want to flush if cancelled, but in that case the switch will
       end the writer thread itself (and [flush] will raise). *)</span><span class="EOL">
</span>    <span class="LIDENT">flush</span> <a href="#local_t_143"><span class="LIDENT">t</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-raise"><span class="LIDENT">raise</span></a> <a href="#local_ex_145"><span class="LIDENT">ex</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span class="REC">rec</span> <span id="val-serialize"><span class="LIDENT">serialize</span></span> <span id="local_t_146"><span class="LIDENT">t</span></span> <span id="local_writev_147"><span class="LIDENT">writev</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="MATCH">match</span> <span class="LIDENT">await_batch</span> <a href="#local_t_146"><span class="LIDENT">t</span></a> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="EXCEPTION">exception</span> <span class="UIDENT">End_of_file</span> <span class="MINUSGREATER">-&gt;</span> <span class="UIDENT">Ok</span> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="BAR">|</span> <span id="local_iovecs_148"><span class="LIDENT">iovecs</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="MATCH">match</span> <a href="#local_writev_147"><span class="LIDENT">writev</span></a> <a href="#local_iovecs_148"><span class="LIDENT">iovecs</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Error</span> <span class="BACKQUOTE">`</span><span class="UIDENT">Closed</span> <span class="AS">as</span> <span id="local_e_149"><span class="LIDENT">e</span></span> <span class="MINUSGREATER">-&gt;</span> <span class="LIDENT">close</span> <a href="#local_t_146"><span class="LIDENT">t</span></a><span class="SEMI">;</span> <a href="#local_e_149"><span class="LIDENT">e</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span class="UIDENT">Ok</span> <span id="local_n_150"><span class="LIDENT">n</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LIDENT">shift</span> <a href="#local_t_146"><span class="LIDENT">t</span></a> <a href="#local_n_150"><span class="LIDENT">n</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <span class="IF">if</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-not"><span class="LIDENT">not</span></a> <span class="LPAREN">(</span><span class="UIDENT">Buffers</span><span class="DOT">.</span><span class="LIDENT">is_empty</span> <a href="#local_t_146"><span class="LIDENT">t</span></a><span class="DOT">.</span><span class="LIDENT">scheduled</span><span class="RPAREN">)</span> <span class="THEN">then</span> <a href="../eio.core/fiber.ml.html#val-yield"><span class="UIDENT">Fiber</span><span class="DOT">.</span><span class="LIDENT">yield</span></a> <span class="LPAREN">(</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>      <span class="LIDENT">serialize</span> <a href="#local_t_146"><span class="LIDENT">t</span></a> <a href="#local_writev_147"><span class="LIDENT">writev</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-serialize_to_string"><span class="LIDENT">serialize_to_string</span></span> <span id="local_t_151"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">close</span> <a href="#local_t_151"><span class="LIDENT">t</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="MATCH">match</span> <span class="LIDENT">await_batch</span> <a href="#local_t_151"><span class="LIDENT">t</span></a> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="EXCEPTION">exception</span> <span class="UIDENT">End_of_file</span> <span class="MINUSGREATER">-&gt;</span> <span class="STRING">&quot;&quot;</span><span class="EOL">
</span>  <span class="BAR">|</span> <span id="local_iovecs_152"><span class="LIDENT">iovecs</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_len_153"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span> <a href="../../../cstruct/src/cstruct/cstruct.ml.html#val-lenv"><span class="UIDENT">Cstruct</span><span class="DOT">.</span><span class="LIDENT">lenv</span></a> <a href="#local_iovecs_152"><span class="LIDENT">iovecs</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_bytes_154"><span class="LIDENT">bytes</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/bytes.ml.html#val-create"><span class="UIDENT">Bytes</span><span class="DOT">.</span><span class="LIDENT">create</span></a> <a href="#local_len_153"><span class="LIDENT">len</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_pos_155"><span class="LIDENT">pos</span></span> <span class="EQUAL">=</span> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-ref"><span class="LIDENT">ref</span></a> <span class="INT">0</span> <span class="IN">in</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/list.ml.html#val-iter"><span class="UIDENT">List</span><span class="DOT">.</span><span class="LIDENT">iter</span></a> <span class="LPAREN">(</span><span class="FUNCTION">function</span><span class="EOL">
</span>        <span class="BAR">|</span> <span class="LBRACE">{</span> <span id="local_buffer_156"><span class="UIDENT">Cstruct</span><span class="DOT">.</span><span class="LIDENT">buffer</span></span><span class="SEMI">;</span> <span id="local_off_157"><span class="LIDENT">off</span></span><span class="SEMI">;</span> <span id="local_len_158"><span class="LIDENT">len</span></span> <span class="RBRACE">}</span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>          <a href="../../../bigstringaf/src/bigstringaf/bigstringaf.ml.html#val-unsafe_blit_to_bytes"><span class="UIDENT">Bigstringaf</span><span class="DOT">.</span><span class="LIDENT">unsafe_blit_to_bytes</span></a> <a href="#local_buffer_156"><span class="LIDENT">buffer</span></a> <span class="LABEL">~src_off:</span><a href="#local_off_157"><span class="LIDENT">off</span></a> <a href="#local_bytes_154"><span class="LIDENT">bytes</span></a> <span class="LABEL">~dst_off:</span><a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="#local_pos_155"><span class="LIDENT">pos</span></a> <span class="TILDE">~</span><a href="#local_len_158"><span class="LIDENT">len</span></a><span class="SEMI">;</span><span class="EOL">
</span>          <a href="#local_pos_155"><span class="LIDENT">pos</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(:=)"><span class="COLONEQUAL">:=</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(!)"><span class="BANG">!</span></a><a href="#local_pos_155"><span class="LIDENT">pos</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <a href="#local_len_158"><span class="LIDENT">len</span></a><span class="RPAREN">)</span><span class="EOL">
</span>      <a href="#local_iovecs_152"><span class="LIDENT">iovecs</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="LIDENT">shift</span> <a href="#local_t_151"><span class="LIDENT">t</span></a> <a href="#local_len_153"><span class="LIDENT">len</span></a><span class="SEMI">;</span><span class="EOL">
</span>    <span class="ASSERT">assert</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-not"><span class="LIDENT">not</span></a> <span class="LPAREN">(</span><span class="LIDENT">has_pending_output</span> <a href="#local_t_151"><span class="LIDENT">t</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="../../../ocaml-base-compiler/src/stdlib/bytes.ml.html#val-unsafe_to_string"><span class="UIDENT">Bytes</span><span class="DOT">.</span><span class="LIDENT">unsafe_to_string</span></a> <a href="#local_bytes_154"><span class="LIDENT">bytes</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-serialize_to_cstruct"><span class="LIDENT">serialize_to_cstruct</span></span> <span id="local_t_159"><span class="LIDENT">t</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LIDENT">close</span> <a href="#local_t_159"><span class="LIDENT">t</span></a><span class="SEMI">;</span><span class="EOL">
</span>  <span class="MATCH">match</span> <span class="LIDENT">await_batch</span> <a href="#local_t_159"><span class="LIDENT">t</span></a> <span class="WITH">with</span><span class="EOL">
</span>  <span class="BAR">|</span> <span class="EXCEPTION">exception</span> <span class="UIDENT">End_of_file</span> <span class="MINUSGREATER">-&gt;</span> <a href="../../../cstruct/src/cstruct/cstruct.ml.html#val-empty"><span class="UIDENT">Cstruct</span><span class="DOT">.</span><span class="LIDENT">empty</span></a><span class="EOL">
</span>  <span class="BAR">|</span> <span id="local_iovecs_160"><span class="LIDENT">iovecs</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>    <span class="LET">let</span> <span id="local_data_161"><span class="LIDENT">data</span></span> <span class="EQUAL">=</span> <a href="../../../cstruct/src/cstruct/cstruct.ml.html#val-concat"><span class="UIDENT">Cstruct</span><span class="DOT">.</span><span class="LIDENT">concat</span></a> <a href="#local_iovecs_160"><span class="LIDENT">iovecs</span></a> <span class="IN">in</span><span class="EOL">
</span>    <span class="LIDENT">shift</span> <a href="#local_t_159"><span class="LIDENT">t</span></a> <span class="LPAREN">(</span><a href="../../../cstruct/src/cstruct/cstruct.ml.html#val-length"><span class="UIDENT">Cstruct</span><span class="DOT">.</span><span class="LIDENT">length</span></a> <a href="#local_data_161"><span class="LIDENT">data</span></a><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>    <span class="ASSERT">assert</span> <span class="LPAREN">(</span><a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-not"><span class="LIDENT">not</span></a> <span class="LPAREN">(</span><span class="LIDENT">has_pending_output</span> <a href="#local_t_159"><span class="LIDENT">t</span></a><span class="RPAREN">)</span><span class="RPAREN">)</span><span class="SEMI">;</span><span class="EOL">
</span>    <a href="#local_data_161"><span class="LIDENT">data</span></a><span class="EOL">
</span><span class="EOL">
</span><span class="LET">let</span> <span id="val-drain"><span class="LIDENT">drain</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>  <span class="LET">let</span> <span class="REC">rec</span> <span id="local_loop_162"><span class="LIDENT">loop</span></span> <span id="local_t_163"><span class="LIDENT">t</span></span> <span id="local_acc_164"><span class="LIDENT">acc</span></span> <span class="EQUAL">=</span><span class="EOL">
</span>    <span class="MATCH">match</span> <span class="LIDENT">await_batch</span> <a href="#local_t_163"><span class="LIDENT">t</span></a> <span class="WITH">with</span><span class="EOL">
</span>    <span class="BAR">|</span> <span class="EXCEPTION">exception</span> <span class="UIDENT">End_of_file</span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_acc_164"><span class="LIDENT">acc</span></a><span class="EOL">
</span>    <span class="BAR">|</span> <span id="local_iovecs_165"><span class="LIDENT">iovecs</span></span> <span class="MINUSGREATER">-&gt;</span><span class="EOL">
</span>      <span class="LET">let</span> <span id="local_len_166"><span class="LIDENT">len</span></span> <span class="EQUAL">=</span> <a href="../../../cstruct/src/cstruct/cstruct.ml.html#val-lenv"><span class="UIDENT">Cstruct</span><span class="DOT">.</span><span class="LIDENT">lenv</span></a> <a href="#local_iovecs_165"><span class="LIDENT">iovecs</span></a> <span class="IN">in</span><span class="EOL">
</span>      <span class="LIDENT">shift</span> <a href="#local_t_163"><span class="LIDENT">t</span></a> <a href="#local_len_166"><span class="LIDENT">len</span></a><span class="SEMI">;</span><span class="EOL">
</span>      <a href="#local_loop_162"><span class="LIDENT">loop</span></a> <a href="#local_t_163"><span class="LIDENT">t</span></a> <span class="LPAREN">(</span><a href="#local_len_166"><span class="LIDENT">len</span></a> <a href="../../../ocaml-base-compiler/src/stdlib/stdlib.ml.html#val-(+)"><span class="PLUS">+</span></a> <a href="#local_acc_164"><span class="LIDENT">acc</span></a><span class="RPAREN">)</span><span class="EOL">
</span>  <span class="IN">in</span><span class="EOL">
</span>  <span class="FUN">fun</span> <span id="local_t_167"><span class="LIDENT">t</span></span> <span class="MINUSGREATER">-&gt;</span> <a href="#local_loop_162"><span class="LIDENT">loop</span></a> <a href="#local_t_167"><span class="LIDENT">t</span></a> <span class="INT">0</span><span class="EOL">
</span></span></code></pre></body></html>
