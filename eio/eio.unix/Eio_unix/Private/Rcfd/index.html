<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Rcfd (eio.eio.unix.Eio_unix.Private.Rcfd)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../../../odoc.css"/><meta name="generator" content="odoc %%VERSION%%"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>let base_url = '../../../../../';
let search_urls = ['../../../../sherlodoc_db.js','../../../../../sherlodoc.js'];
</script><script src="../../../../../odoc_search.js" defer="defer"></script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> ‚Äì <a href="../../../../../index.html">üè†</a> &#x00BB; <a href="../../../../index.html">eio</a> &#x00BB; Library <code>eio.unix</code> &#x00BB; <a href="../../index.html">Eio_unix</a> &#x00BB; <a href="../index.html">Private</a> &#x00BB; Rcfd</nav><div class="odoc-search"><div class="search-inner"><input class="search-bar" placeholder="üîé Type '/' to search..."/><div class="search-snake"></div><div class="search-result"></div></div></div><header class="odoc-preamble"><h1>Module <code><span>Private.Rcfd</span></code><a href="../../../../src/eio.unix/rcfd.ml.html" class="source_link">Source</a></h1><p>A safe wrapper around <code>Unix.file_descr</code>.</p><p>When FDs are shared between domains, there is the risk that one domain will try to use an FD just as another domain is closing it. Then this can happen:</p><ol><li>Domain A decides to write to FD 3, which it shares with domain B.</li><li>Domain B closes FD 3.</li><li>Domain C opens a new file, getting assigned FD 3 by the OS.</li><li>Domain A writes to FD 3, corrupting domain C's file.</li></ol><p>This would break modularity, since the fibers in domains A and C may have no connection with each other.</p><p>To prevent this, we keep a ref-count, tracking how many fibers are using the FD. Wrap uses of the FD in <a href="#val-use"><code>use</code></a> to ensure that it won't be closed while you're using it.</p><p>Calling <a href="#val-close"><code>close</code></a> while one or more operations are still in progress marks the wrapper as closing (so that no futher operations can start); the last operation to finish will close the underlying FD.</p></header><div class="odoc-tocs"><nav class="odoc-toc odoc-global-toc"><ul><li><a href="../../../../index.html">eio</a><ul><li>Library <code>eio</code><ul><li><a href="../../../../eio/Eio/index.html">Eio</a></li></ul></li><li>Library <code>eio.core</code></li><li>Library <code>eio.mock</code><ul><li><a href="../../../../eio.mock/Eio_mock/index.html">Eio_mock</a></li></ul></li><li>Library <code>eio.runtime_events</code><ul><li><a href="../../../../eio.runtime_events/Eio_runtime_events/index.html">Eio_runtime_events</a></li></ul></li><li>Library <code>eio.unix</code><ul><li><a href="../../index.html">Eio_unix</a><ul><li><a href="../../Fd/index.html">Fd</a></li><li><a href="../../Resource/index.html">Resource</a></li><li><a href="../../Net/index.html">Net</a></li><li><a href="../../Process/index.html">Process</a></li><li><a href="../../Cap/index.html">Cap</a></li><li><a href="../../Stdenv/index.html">Stdenv</a></li><li><a href="../index.html">Private</a><ul><li><a href="#" class="current_unit">Rcfd</a></li><li><a href="../index.html#module-Fork_action">Fork_action</a></li><li><a href="../Thread_pool/index.html">Thread_pool</a></li></ul></li><li><a href="../../Pi/index.html">Pi</a></li></ul></li></ul></li><li>Library <code>eio.utils</code><ul><li><a href="../../../../eio.utils/Eio_utils/index.html">Eio_utils</a></li></ul></li><li><a href="../../../../src/index.html">Sources</a></li></ul></li></ul></nav></div><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><a href="../../../../src/eio.unix/rcfd.ml.html#type-t" class="source_link">Source</a><code><span><span class="keyword">type</span> t</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-make"><a href="#val-make" class="anchor"></a><a href="../../../../src/eio.unix/rcfd.ml.html#val-make" class="source_link">Source</a><code><span><span class="keyword">val</span> make : <span><a href="../../../../../ocaml-base-compiler/unix/Unix/index.html#type-file_descr">Unix.file_descr</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>let t = make fd</code> wraps <code>fd</code>.</p><p><code>t</code> takes ownership of <code>fd</code>. The caller is responsible for ensuring that <a href="#val-close"><code>close</code></a> (or <a href="#val-remove"><code>remove</code></a>) is called at least once in the future.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-use"><a href="#val-use" class="anchor"></a><a href="../../../../src/eio.unix/rcfd.ml.html#val-use" class="source_link">Source</a><code><span><span class="keyword">val</span> use : <span><span class="label">if_closed</span>:<span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span><a href="../../../../../ocaml-base-compiler/unix/Unix/index.html#type-file_descr">Unix.file_descr</a> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div><div class="spec-doc"><p><code>use t fn ~if_closed</code> calls <code>fn fd</code>, preventing <code>fd</code> from being closed until <code>fn</code> returns.</p><p><code>if_closed ()</code> is used if <code>t</code> is closed before we can increment the ref-count. <code>use</code> can be used in parallel from multiple domains at the same time.</p><p>This operation is lock-free and can be used safely from signal handlers, etc.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-is_open"><a href="#val-is_open" class="anchor"></a><a href="../../../../src/eio.unix/rcfd.ml.html#val-is_open" class="source_link">Source</a><code><span><span class="keyword">val</span> is_open : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>is_open t</code> returns <code>true</code> until <code>t</code> has been marked as closing, after which it returns <code>false</code>.</p><p>This is mostly useful inside the callback of <a href="#val-use"><code>use</code></a>, to test whether another fiber has started closing <code>t</code> (in which case you may decide to stop early).</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-close"><a href="#val-close" class="anchor"></a><a href="../../../../src/eio.unix/rcfd.ml.html#val-close" class="source_link">Source</a><code><span><span class="keyword">val</span> close : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>close t</code> marks <code>t</code> as closed and arranges for its FD to be closed.</p><p>If there are calls to <a href="#val-use"><code>use</code></a> in progress, the last one to finish will close the underlying FD. Note that this function returns without waiting for the close to happen in that case.</p><p>Returns <code>true</code> after successfully marking <code>t</code> as closing, or <code>false</code> if it was already marked.</p><p>If you need to wait until the underlying FD is closed, use <a href="#val-remove"><code>remove</code></a> and then close the FD yourself instead.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-remove"><a href="#val-remove" class="anchor"></a><a href="../../../../src/eio.unix/rcfd.ml.html#val-remove" class="source_link">Source</a><code><span><span class="keyword">val</span> remove : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../../../ocaml-base-compiler/unix/Unix/index.html#type-file_descr">Unix.file_descr</a> option</span></span></code></div><div class="spec-doc"><p><code>remove t</code> closes <code>t</code> and returns the FD.</p><p>It immediately marks <code>t</code> as closing (so no further operations can start) and then waits until there are no further users.</p><p>This operation suspends the calling fiber and so must run from an Eio fiber. It does not allow itself to be cancelled, since it takes ownership of the FD and that would be leaked if it aborted.</p><p>If another fiber marks <code>t</code> as closing before <code>remove</code> can, it returns <code>None</code> immediately.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-peek"><a href="#val-peek" class="anchor"></a><a href="../../../../src/eio.unix/rcfd.ml.html#val-peek" class="source_link">Source</a><code><span><span class="keyword">val</span> peek : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../../../ocaml-base-compiler/unix/Unix/index.html#type-file_descr">Unix.file_descr</a></span></code></div><div class="spec-doc"><p><code>peek t</code> returns the file-descriptor without updating the ref-count.</p><p>You must ensure that <code>t</code> isn't closed while using the result. This is a dangerous operation and may be removed in the future.</p><p>If <code>t</code> was closed, it instead raises an exception (if you're not sure when <code>t</code> might get closed, you shouldn't be using this function).</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp"><a href="#val-pp" class="anchor"></a><a href="../../../../src/eio.unix/rcfd.ml.html#val-pp" class="source_link">Source</a><code><span><span class="keyword">val</span> pp : <span><a href="#type-t">t</a> <a href="../../../../../fmt/fmt/Fmt/index.html#type-t">Fmt.t</a></span></span></code></div><div class="spec-doc"><p>Displays the FD number.</p></div></div></div></body></html>
