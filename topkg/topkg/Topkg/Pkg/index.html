<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Pkg (topkg.topkg.Topkg.Pkg)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../../odoc.css"/><meta name="generator" content="odoc %%VERSION%%"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>let base_url = '../../../../';
let search_urls = ['../../../sherlodoc_db.js','../../../../sherlodoc.js'];
</script><script src="../../../../odoc_search.js" defer="defer"></script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> ‚Äì <a href="../../../../index.html">üè†</a> &#x00BB; <a href="../../../index.html">topkg</a> &#x00BB; Library <code>topkg</code> &#x00BB; <a href="../index.html">Topkg</a> &#x00BB; Pkg</nav><div class="odoc-search"><div class="search-inner"><input class="search-bar" placeholder="üîé Type '/' to search..."/><div class="search-snake"></div><div class="search-result"></div></div></div><header class="odoc-preamble"><h1>Module <code><span>Topkg.Pkg</span></code></h1><p>Package description.</p><p>See the <a href="../index.html#basics" title="basics">basics</a>.</p></header><div class="odoc-tocs"><nav class="odoc-toc odoc-local-toc"><ul><li><a href="#install">Installation description</a><ul><li><a href="#tests">Test executable description</a></li><li><a href="#ocamlbuild-higher-level-installs">OCamlbuild higher-level installs</a></li></ul></li><li><a href="#build">Build description</a><ul><li><a href="#ocamlbuild">OCamlbuild support</a></li></ul></li><li><a href="#distrib">Distribution description</a></li><li><a href="#distribution-publication-description">Distribution publication description</a></li><li><a href="#package-description">Package description</a></li><li><a href="#distdetails">Package distribution creation details</a><ul><li><a href="#watnote">Note on watermarking</a></li></ul></li></ul></nav><nav class="odoc-toc odoc-global-toc"><ul><li><a href="../../../index.html">topkg</a><ul><li>Library <code>topkg</code><ul><li><a href="../index.html">Topkg</a><ul><li><a href="../R/index.html">R</a></li><li><a href="../String/index.html">String</a></li><li><a href="../Fpath/index.html">Fpath</a></li><li><a href="../Cmd/index.html">Cmd</a></li><li><a href="../Log/index.html">Log</a></li><li><a href="../OS/index.html">OS</a></li><li><a href="../Vcs/index.html">Vcs</a></li><li><a href="../Conf/index.html">Conf</a></li><li><a href="../Exts/index.html">Exts</a></li><li><a href="#" class="current_unit">Pkg</a></li><li><a href="../Private/index.html">Private</a></li></ul></li></ul></li></ul></li></ul></nav></div><div class="odoc-content"><h2 id="install"><a href="#install" class="anchor"></a>Installation description</h2><p>The installation description generates an opam install file which is simply a description of file moves (in the <code>mv</code> sense) from the build or source directory to standard install directories. Describing these moves in a given build configuration effectively determines what needs to built by the <a href="#val-build" title="build">package build command</a>.</p><p><b>Note.</b> Always use <code>&quot;/&quot;</code> as a directory seperator for paths, even on Windows.</p><div class="odoc-spec"><div class="spec type anchored" id="type-install"><a href="#type-install" class="anchor"></a><code><span><span class="keyword">type</span> install</span></code></div><div class="spec-doc"><p>The type for representing a set of install moves.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-nothing"><a href="#val-nothing" class="anchor"></a><code><span><span class="keyword">val</span> nothing : <a href="#type-install">install</a></span></code></div><div class="spec-doc"><p><code>nothing</code> is an empty set of install moves.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-flatten"><a href="#val-flatten" class="anchor"></a><code><span><span class="keyword">val</span> flatten : <span><span><a href="#type-install">install</a> list</span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-install">install</a></span></code></div><div class="spec-doc"><p><code>flatten installs</code> is the union of all the install moves in <code>installs</code>.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-field"><a href="#type-field" class="anchor"></a><code><span><span class="keyword">type</span> field</span><span> =
  <span><span class="optlabel">?force</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?built</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?cond</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?exts</span>:<a href="../Exts/index.html#type-t">Exts.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?dst</span>:<a href="../index.html#type-fpath">fpath</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../index.html#type-fpath">fpath</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-install">install</a></span></code></div><div class="spec-doc"><p>The type for an install field, a function that describe file moves to a particular installation directory. In the simplest form a call <code>field src</code> simply moves the file <code>src</code> at the root of the install directory of the field.</p><p>In general <code>field ~force ~built ~cond ~exts ~dst src</code> generates install move as follows:</p><ul><li><code>dst</code> is the path were the source is written to. Expressed relative to the install directory of the field. Defaults to <code>Fpath.basename src</code>, i.e. at the root of the install directory. If <code>dst</code> is a <a href="../Fpath/index.html#val-is_dir_path" title="Fpath.is_dir_path">directory path</a>, the destination is <code>(dst ^ Fpath.basename src)</code>.</li><li>If <code>exts</code> is present and non empty, generates the list of paths <code>List.map (fun e -&gt; src ^ e)</code> and a move for each of these. For example <code>field ~exts:</code><a href="../Exts/index.html#val-api"><code>Exts.api</code></a><code> &quot;src/m&quot;</code> would generate a move for the files <code>&quot;src/m.mli&quot;</code>, <code>&quot;src/m.cmi&quot;</code>, <code>&quot;src/m.cmti&quot;</code>, <code>&quot;src/m.cmx&quot;</code>.</li><li><p>If <code>cond</code> is <code>false</code> (defaults to <code>true</code>) no file move is generated. This provides a convenient way to conditionalize installation based on the build configuration for example:</p><pre class="language-ocaml"><code>let jsoo = Conf.value jsoo in
Pkg.mllib ~cond:jsoo &quot;src/mylib_jsoo.mllib&quot;</code></pre></li><li>If <code>built</code> is <code>true</code> (default), <code>src</code> is expressed relative to the <a href="#val-build" title="build">build directory</a> of the distribution and the path <code>src</code> is be given to <a href="#val-build" title="build">build system invocation</a> for construction. If <code>false</code>, <code>src</code> is relative to the root of the distribution and is excluded from the build system invocation; this can be used for installing files that don't need to be built.</li><li>If <code>force</code> is <code>true</code> (defaults to <code>false</code>) it disables the automatic <code>src</code> filtering performed by the library. When <code>false</code>, the library automatically disable certain build artefact depending on <a href="../Conf/OCaml/index.html" title="Conf.OCaml">OCaml's configuration</a>, one such example is filtering native code build artefact if the OCaml install doesn't support <a href="../Conf/OCaml/index.html#val-native" title="Conf.OCaml.native">native code compilation</a></li></ul></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-exec_field"><a href="#type-exec_field" class="anchor"></a><code><span><span class="keyword">type</span> exec_field</span><span> = <span><span class="optlabel">?auto</span>:bool <span class="arrow">&#45;&gt;</span></span> <a href="#type-field">field</a></span></code></div><div class="spec-doc"><p>The type for fields that install executable files. This is like <a href="#type-field"><code>field</code></a> except for the additional <code>auto</code> parameter:</p><ul><li>If <code>auto</code> is <code>true</code> (default) then <code>field src dst</code> automatically adds the <code>&quot;.native&quot;</code> suffix to <code>src</code> if <a href="../Conf/OCaml/index.html#val-native"><code>Conf.OCaml.native</code></a> is <code>true</code> and the <code>&quot;.byte&quot;</code> suffix otherwise. Besides it automatically adds <a href="../Exts/index.html#val-exe"><code>Exts.exe</code></a> to <code>dst</code>, which handles things correctly on the various Windows ports.</li><li>If <code>auto</code> is <code>false</code> you have full control according to <a href="#type-field"><code>field</code></a>.</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-bin"><a href="#val-bin" class="anchor"></a><code><span><span class="keyword">val</span> bin : <a href="#type-exec_field">exec_field</a></span></code></div><div class="spec-doc"><p><code>bin</code> is a field that installs to a common <code>bin/</code> directory.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-doc"><a href="#val-doc" class="anchor"></a><code><span><span class="keyword">val</span> doc : <a href="#type-field">field</a></span></code></div><div class="spec-doc"><p><code>doc</code> is a field that installs to a package specific <code>doc/</code> directory</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-etc"><a href="#val-etc" class="anchor"></a><code><span><span class="keyword">val</span> etc : <a href="#type-field">field</a></span></code></div><div class="spec-doc"><p><code>etc</code> is a field that installs to a package specific <code>etc/</code> directory.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-lib"><a href="#val-lib" class="anchor"></a><code><span><span class="keyword">val</span> lib : <a href="#type-field">field</a></span></code></div><div class="spec-doc"><p><code>lib</code> is a field that installs to a package specific <code>lib/</code> directory.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-lib_root"><a href="#val-lib_root" class="anchor"></a><code><span><span class="keyword">val</span> lib_root : <a href="#type-field">field</a></span></code></div><div class="spec-doc"><p><code>lib_root</code> is a field that install to a common <code>lib/</code> directory.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-libexec"><a href="#val-libexec" class="anchor"></a><code><span><span class="keyword">val</span> libexec : <a href="#type-exec_field">exec_field</a></span></code></div><div class="spec-doc"><p><code>libexec</code> is a field that installs to a package specific <code>lib/</code> directory but with the executable bit set.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-libexec_root"><a href="#val-libexec_root" class="anchor"></a><code><span><span class="keyword">val</span> libexec_root : <a href="#type-exec_field">exec_field</a></span></code></div><div class="spec-doc"><p><code>libexec_root</code> is a field that install to a common <code>lib/</code> directory but with the executable bit set.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-man"><a href="#val-man" class="anchor"></a><code><span><span class="keyword">val</span> man : <a href="#type-field">field</a></span></code></div><div class="spec-doc"><p><code>man</code> is a field that installs to a common <code>man/</code> directory. See the <a href="https://opam.ocaml.org/doc/manual/dev-manual.html#sec25">opam manual</a> for details.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-misc"><a href="#val-misc" class="anchor"></a><code><span><span class="keyword">val</span> misc : <a href="#type-field">field</a></span></code></div><div class="spec-doc"><p><code>misc</code> is a field that installs to an arbitrary absolute path, the user is prompted for authorization, see the <a href="https://opam.ocaml.org/doc/manual/dev-manual.html#sec25">opam manual</a> for details.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-sbin"><a href="#val-sbin" class="anchor"></a><code><span><span class="keyword">val</span> sbin : <a href="#type-exec_field">exec_field</a></span></code></div><div class="spec-doc"><p><code>sbin</code> is a field that installs to a common <code>sbin/</code> directory.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-share"><a href="#val-share" class="anchor"></a><code><span><span class="keyword">val</span> share : <a href="#type-field">field</a></span></code></div><div class="spec-doc"><p><code>share</code> is a field that installs to a package specific <code>share/</code> directory.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-share_root"><a href="#val-share_root" class="anchor"></a><code><span><span class="keyword">val</span> share_root : <a href="#type-field">field</a></span></code></div><div class="spec-doc"><p><code>share_root</code> is a field that installs to a common <code>share/</code> directory.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-stublibs"><a href="#val-stublibs" class="anchor"></a><code><span><span class="keyword">val</span> stublibs : <a href="#type-field">field</a></span></code></div><div class="spec-doc"><p><code>stublibs</code> is a field that install to a common <code>lib/stublibs/</code> directory. Used for OCaml C stub directory.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-toplevel"><a href="#val-toplevel" class="anchor"></a><code><span><span class="keyword">val</span> toplevel : <a href="#type-field">field</a></span></code></div><div class="spec-doc"><p><code>toplevel</code> is a field that installs to a common <code>lib/toplevel/</code> directory.</p></div></div><h3 id="tests"><a href="#tests" class="anchor"></a>Test executable description</h3><div class="odoc-spec"><div class="spec value anchored" id="val-test"><a href="#val-test" class="anchor"></a><code><span><span class="keyword">val</span> test : <span><span class="optlabel">?run</span>:bool <span class="arrow">&#45;&gt;</span></span> <span><span class="optlabel">?dir</span>:<a href="../index.html#type-fpath">fpath</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="optlabel">?args</span>:<a href="../Cmd/index.html#type-t">Cmd.t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-exec_field">exec_field</a></span></code></div><div class="spec-doc"><p><code>test</code> is a special <a href="#type-exec_field" title="exec_field">executable field</a>: it doesn't install the described executable (as such the <code>dst</code> argument is ignored at the moment). If <code>run</code> is <code>true</code> (default) executes the test with <code>args</code> when <code>ocaml pkg/pkg.ml test</code> is run; this will notably run to test the distribution tarball. If <code>run</code> is <code>false</code> the test needs to be invoked explicitely. <code>dir</code> specifies the current working directory for the test, expressed relative to the root directory of the package (defaults to <code>.</code>).</p></div></div><h3 id="ocamlbuild-higher-level-installs"><a href="#ocamlbuild-higher-level-installs" class="anchor"></a>OCamlbuild higher-level installs</h3><p>The following functions are OCamlbuild specific higher level installs that generate moves by reading OCamlbuild specification files. They also automatically handle the <a href="../Conf/index.html#val-debugger_support"><code>Conf.debugger_support</code></a> configuration key by building and installing the build artefacts needed by debuggers whenever its value is <code>true</code>.</p><div class="odoc-spec"><div class="spec value anchored" id="val-mllib"><a href="#val-mllib" class="anchor"></a><code><span><span class="keyword">val</span> mllib : 
  <span><span class="optlabel">?field</span>:<a href="#type-field">field</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?cond</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?cma</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?cmxa</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?cmxs</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?api</span>:<span>string list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?dst_dir</span>:<a href="../index.html#type-fpath">fpath</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../index.html#type-fpath">fpath</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-install">install</a></span></code></div><div class="spec-doc"><p><code>mllib ~field ~cond ~cma ~cmxa ~cmxs ~api ~dst_dir mllib</code> installs an OCaml library described by the <a href="https://github.com/ocaml/ocamlbuild/blob/master/manual/manual.adoc#Sec_Archives_documentation">OCamlbuild .mllib file</a> <code>mllib</code> with:</p><ul><li><code>field</code> is the field where it gets installed (defaults to <a href="#val-lib"><code>lib</code></a>).</li><li>If <code>cond</code> is <code>false</code> (defaults to <code>true</code>), no move is generated.</li><li><code>cma</code>, <code>cmxa</code>, <code>cmxs</code> determine if corresponding archives are built and installed, they all default to <code>true</code>.</li><li><code>api</code> is the list of modules that defines the public interface of the library, if <code>None</code> all the modules mentioned in <code>mllib</code> are part of the public interface.</li><li><code>dst_dir</code> is the destination directory of the library in the field. If unspecified this is the root of the field's directory.</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-clib"><a href="#val-clib" class="anchor"></a><code><span><span class="keyword">val</span> clib : 
  <span><span class="optlabel">?dllfield</span>:<a href="#type-field">field</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?libfield</span>:<a href="#type-field">field</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?cond</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?lib_dst_dir</span>:<a href="../index.html#type-fpath">fpath</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../index.html#type-fpath">fpath</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-install">install</a></span></code></div><div class="spec-doc"><p><code>clib clib</code> installs C stubs described by the <a href="https://github.com/ocaml/ocamlbuild/blob/master/manual/manual.adoc#advanced-targets">OCamlbuild .clib file</a> <code>clib</code> with:</p><ul><li><code>dllfield</code> is the field where the C DLL archive gets installed, (defaults to <a href="#val-stublibs"><code>stublibs</code></a>)</li><li><code>libfield</code> is the field where the C static archive gets installed (defaults to <a href="#val-lib"><code>lib</code></a>)</li><li>If <code>cond</code> is <code>false</code> (defaults to <code>true</code>), no move is generated.</li><li><code>lib_dst_dir</code> is the destination directory of the library in the <code>libfield</code> field. If unspecified this is the root of the field's directory. This does not affect the <code>dllfield</code>, DLLs are always installed at the root directory of the <code>dllfield</code>.</li></ul></div></div><h2 id="build"><a href="#build" class="anchor"></a>Build description</h2><div class="odoc-spec"><div class="spec type anchored" id="type-build"><a href="#type-build" class="anchor"></a><code><span><span class="keyword">type</span> build</span></code></div><div class="spec-doc"><p>The type for package build description.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-build"><a href="#val-build" class="anchor"></a><code><span><span class="keyword">val</span> build : 
  <span><span class="optlabel">?prepare_on_pin</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?dir</span>:<a href="../index.html#type-fpath">fpath</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?pre</span>:<span>(<span><a href="../Conf/index.html#type-t">Conf.t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <a href="../index.html#type-result">result</a></span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?cmd</span>:<span>(<span><a href="../Conf/index.html#type-t">Conf.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Conf/index.html#type-os">Conf.os</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="../index.html#type-fpath">fpath</a> list</span> <span class="arrow">&#45;&gt;</span></span> <span>unit <a href="../index.html#type-result">result</a></span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?post</span>:<span>(<span><a href="../Conf/index.html#type-t">Conf.t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <a href="../index.html#type-result">result</a></span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?clean</span>:<span>(<span><a href="../Conf/index.html#type-os">Conf.os</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="label">build_dir</span>:<a href="../index.html#type-fpath">fpath</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <a href="../index.html#type-result">result</a></span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-build">build</a></span></code></div><div class="spec-doc"><p><code>build ~prepare_on_pin ~dir ~cmd ~pre ~post</code> describes the package build procedure.</p><ul><li><code>prepare_on_pin</code> if <code>true</code> (default) distribution preparation is performed if a <code>`Pin</code> <a href="../Conf/index.html#type-build_context" title="Conf.build_context">build context</a> is detected. This means that the checkout is watermarked and the massage hook is invoked, see step 2. of <a href="#distdetails" title="distdetails">distribution creation</a>.</li><li><code>dir</code> is the directory where build artefacts are generated, (defaults to <code>&quot;_build&quot;</code>). Note that his value can be overriden from the command line.</li><li><code>pre</code> is a hook that is invoked with the build context, after distribution preparation if applicable, but before the build command. It can be used to adapt the build setup according to the build configuration. Default is a nop.</li><li><p><code>cmd</code> invokes the build system to build the files determined by <a href="#type-install" title="install">install</a> moves. It is given the build configuration, an <a href="../Conf/index.html#type-os" title="Conf.os">OS specification</a>, the list of files to build relative to the <a href="../Conf/index.html#val-build_dir" title="Conf.build_dir">build directory</a>, and build the given files in the build directory. The default is:</p><pre class="language-ocaml"><code>fun c os files -&gt; OS.Cmd.run @@ Cmd.(Pkg.build_cmd c os %% of_list files)</code></pre></li><li><code>post</code> is a hook that is invoked with the build context after the build command returned sucessfully. Default is a nop.</li><li><p><code>clean</code> is invoked to clean a build. It is given an <a href="../Conf/index.html#type-os" title="Conf.os">OS specification</a> and a build directory to clean. The default is:</p><pre class="language-ocaml"><code>let clean os ~build_dir = OS.Cmd.run @@ Pkg.clean_cmd os ~build_dir</code></pre></li></ul><p><b>Warning.</b> If you are invoking tools in your hooks consider using <a href="../Conf/index.html#tool" title="tool">Tool lookup</a> to look them up it helps for cross-compilation.</p></div></div><h3 id="ocamlbuild"><a href="#ocamlbuild" class="anchor"></a>OCamlbuild support</h3><p>If you are using <code>ocamlbuild</code>, the following functions help to customize the build system invocation according to the configuration.</p><div class="odoc-spec"><div class="spec value anchored" id="val-build_cmd"><a href="#val-build_cmd" class="anchor"></a><code><span><span class="keyword">val</span> build_cmd : <span><a href="../Conf/index.html#type-t">Conf.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Conf/index.html#type-os">Conf.os</a> <span class="arrow">&#45;&gt;</span></span> <a href="../Cmd/index.html#type-t">Cmd.t</a></span></code></div><div class="spec-doc"><p><code>build_cmd c os</code> is the default build command to which files to build are given. Its value is defined by:</p><pre class="language-ocaml"><code>fun c os -&gt;
let ocamlbuild = Conf.tool &quot;ocamlbuild&quot; os in
let build_dir = Conf.build_dir c in
let toolchain =
  match Topkg_conf.toolchain c with
  | Some toolchain -&gt; Topkg_cmd.(v &quot;-toolchain&quot; % toolchain)
  | _ -&gt; Topkg_cmd.empty
in
let debug = Cmd.(on (Conf.debug c) (v &quot;-tag&quot; % &quot;debug&quot;)) in
let profile = Cmd.(on (Conf.profile c) (v &quot;-tag&quot; % &quot;profile&quot;)) in
Cmd.(ocamlbuild % &quot;-use-ocamlfind&quot; %% toolchain % &quot;-classic-display&quot; %%
                  debug %% profile % &quot;-build-dir&quot; % build_dir)</code></pre></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-clean_cmd"><a href="#val-clean_cmd" class="anchor"></a><code><span><span class="keyword">val</span> clean_cmd : <span><a href="../Conf/index.html#type-os">Conf.os</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="label">build_dir</span>:<a href="../index.html#type-fpath">fpath</a> <span class="arrow">&#45;&gt;</span></span> <a href="../Cmd/index.html#type-t">Cmd.t</a></span></code></div><div class="spec-doc"><p><code>clean_cmd os ~build_dir</code> is the default clean command. Its value is defined by:</p><pre class="language-ocaml"><code>fun os ~build_dir -&gt;
let ocamlbuild = Conf.tool &quot;ocamlbuild&quot; os in
Cmd.(ocamlbuild % &quot;-use-ocamlfind&quot; % &quot;-classic-display&quot; %
                  &quot;-build-dir&quot; % build_dir % &quot;-clean&quot;) </code></pre></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-ocb_tag"><a href="#val-ocb_tag" class="anchor"></a><code><span><span class="keyword">val</span> ocb_tag : <span><a href="../Conf/index.html#type-t">Conf.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="../Conf/index.html#type-key">Conf.key</a></span> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <a href="../Cmd/index.html#type-t">Cmd.t</a></span></code></div><div class="spec-doc"><p><code>ocb_tag c key name</code> is a command fragment adding the <code>ocamlbuild</code> parameterized tag <code>name</code> with <code>key</code>'s value to the default set of tags. The key value is converted to a string using the printer of the key value <a href="../Conf/index.html#type-conv" title="Conf.conv">converter</a>.</p><p>For example with a key <code>k : bool Conf.key</code> whose value is <code>true</code>, <code>ocb_tag c k &quot;foo&quot;</code> adds the tag <code>foo(true)</code> to the default tags. A sample build command for <a href="#val-build"><code>build</code></a> using this key would be:</p><pre class="language-ocaml"><code>let cmd c os files =
  OS.Cmd.run Cmd.(build_cmd c os %% ocb_tag c k &quot;foo&quot; %% of_list files)</code></pre></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-ocb_bool_tag"><a href="#val-ocb_bool_tag" class="anchor"></a><code><span><span class="keyword">val</span> ocb_bool_tag : <span><a href="../Conf/index.html#type-t">Conf.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>bool <a href="../Conf/index.html#type-key">Conf.key</a></span> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <a href="../Cmd/index.html#type-t">Cmd.t</a></span></code></div><div class="spec-doc"><p><code>ocb_bool_tag c key name</code> is a command fragment adding the <code>ocamlbuild</code> tag <code>name</code> to the default set of tags iff <code>key</code>'s value is <code>true</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-ocb_bool_tags"><a href="#val-ocb_bool_tags" class="anchor"></a><code><span><span class="keyword">val</span> ocb_bool_tags : <span><a href="../Conf/index.html#type-t">Conf.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<span>bool <a href="../Conf/index.html#type-key">Conf.key</a></span> * string)</span> list</span> <span class="arrow">&#45;&gt;</span></span> <a href="../Cmd/index.html#type-t">Cmd.t</a></span></code></div><div class="spec-doc"><p><code>ocb_bool_tags c assoc</code> is the concatenation of <a href="#val-ocb_bool_tag"><code>ocb_bool_tag</code></a> for all pairs in <code>assoc</code>.</p></div></div><h2 id="distrib"><a href="#distrib" class="anchor"></a>Distribution description</h2><div class="odoc-spec"><div class="spec type anchored" id="type-watermark"><a href="#type-watermark" class="anchor"></a><code><span><span class="keyword">type</span> watermark</span><span> =
  string
  * <span>[ <span>`String of string</span>
    <span>| `Version</span>
    <span>| `Version_num</span>
    <span>| `Name</span>
    <span><span>| `Vcs</span> of <span>[ `Commit_id ]</span></span>
    <span><span>| `Opam</span> of <span><a href="../index.html#type-fpath">fpath</a> option</span> * string * string</span> ]</span></span></code></div><div class="spec-doc"><p>The type for watermarks. A watermark identifier, e.g. <code>&quot;ID&quot;</code> and its definition:</p><ul><li><code>`String s</code>, <code>s</code> is the definition.</li><li><code>`Name</code>, is the name of package.</li><li><code>`Version</code>, is the version of the distribution.</li><li><code>`Version_num</code>, is the version of the distribution with a potential leading <code>'v'</code> or <code>'V'</code> dropped.</li><li><code>`Vcs `Commit_id</code>, is the commit identifier (hash) of the distribution. May be post-fixed by <code>&quot;dirty&quot;</code> in <a href="../Conf/index.html#type-build_context" title="Conf.build_context">dev package (<code>`Pin</code>) builds</a>.</li><li><code>`Opam (file, field, sep)</code>, is the values of the field <code>field</code> concatenated with separator <code>sep</code> of the opam file <code>file</code>, expressed relative to the distribution root directory, if <code>file</code> is <code>None</code> this is the package's default opam file, see <a href="#val-describe"><code>describe</code></a>. Not all fields are supported see the value of <code>Topkg_care.Opam.File.field_names</code>. <b>Warning.</b> In <a href="../Conf/index.html#type-build_context" title="Conf.build_context">dev package (<code>`Pin</code>) builds</a>, <code>`Opam</code> watermarks are only substituted if the package <code>topkg-care</code> is installed.</li></ul><p>When a file is watermarked with an identifier <code>&quot;ID&quot;</code>, any occurence of the sequence <code>%%ID%%</code> in its content is substituted by its definition.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-distrib"><a href="#type-distrib" class="anchor"></a><code><span><span class="keyword">type</span> distrib</span></code></div><div class="spec-doc"><p>The type for describing distribution creation.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-distrib"><a href="#val-distrib" class="anchor"></a><code><span><span class="keyword">val</span> distrib : 
  <span><span class="optlabel">?watermarks</span>:<span><a href="#type-watermark">watermark</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?files_to_watermark</span>:<span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span><span><a href="../index.html#type-fpath">fpath</a> list</span> <a href="../index.html#type-result">result</a></span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?massage</span>:<span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span>unit <a href="../index.html#type-result">result</a></span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?exclude_paths</span>:<span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span><span><a href="../index.html#type-fpath">fpath</a> list</span> <a href="../index.html#type-result">result</a></span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?uri</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-distrib">distrib</a></span></code></div><div class="spec-doc"><p><code>distrib ~watermarks ~files_to_watermark ~massage ~exclude_paths ~uri ()</code> influences the distribution creation process performed by the <code>topkg</code> tool. See the <a href="#distdetails" title="distdetails">full details about distribution creation</a>.</p><p>In the following the <em>distribution build directory</em> is a private clone of the package's source repository's <code>HEAD</code> when <code>topkg distrib</code> is invoked.</p><ul><li><code>watermarks</code> defines the source watermarks for the distribution, defaults to <a href="#val-watermarks"><code>watermarks</code></a>.</li><li><code>files_to_watermark</code> is invoked in the distribution build directory to determine the files to watermark, defaults to <a href="#val-files_to_watermark"><code>files_to_watermark</code></a>.</li><li><code>massage</code> is invoked in the distribution build directory, after watermarking, but before archiving. It can be used to generate distribution time build artefacts. Defaults to <a href="#val-massage"><code>massage</code></a>.</li><li><code>exclude_paths ()</code> is invoked in the distribution build directory, after massaging, to determine the paths that are excluded from being added to the distribution archive. Defaults to <a href="#val-exclude_paths"><code>exclude_paths</code></a>.</li><li><p><code>uri</code> is an URI pattern that specifies the location of the distribution on the WWW. In this string any sub-string <code>&quot;$(NAME)&quot;</code> is replaced by the package name, <code>&quot;$(VERSION)&quot;</code> is replaced by the distribution version string and <code>&quot;$(VERSION_NUM)&quot;</code> by the distribution version string, chopping an initial <code>'v'</code> or <code>'V'</code> character if present. This argument is used to generate the <code>url</code> file of an opam package for the distribution; it will be deprecated in the future in favour of a <code>x-distrib-uri</code> field in the opam file. If the value is unspecified it defaults to:</p><pre class="language-ocaml"><code>PKG_HOMEPAGE/releases/$(NAME)-$(VERSION_NUM).tbz</code></pre><p>where PKG_HOMEPAGE is the package's opam file <code>homepage</code> field. As a special case if the hostname of PKG_HOMEPAGE is <code>github</code> the following is used:</p><pre class="language-ocaml"><code>PKG_DEV_REPO/releases/download/$(VERSION)/$(NAME)-$(VERSION_NUM).tbz</code></pre><p>where PKG_DEV_REPO is the package's opam file <code>dev-repo</code> field without the <code>.git</code> suffix and a possible <code>git+</code> prefix.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-watermarks"><a href="#val-watermarks" class="anchor"></a><code><span><span class="keyword">val</span> watermarks : <span><a href="#type-watermark">watermark</a> list</span></span></code></div><div class="spec-doc"><p><code>watermarks</code> is the default list of watermarks. It has the following elements:</p><ul><li><code>(&quot;NAME&quot;, `Name)</code></li><li><code>(&quot;VERSION&quot;, `Version)</code></li><li><code>(&quot;VERSION_NUM&quot;, `Version_num)</code></li><li><code>(&quot;VCS_COMMIT_ID&quot;, `Vcs [`Commit_id])</code></li><li><code>(&quot;PKG_MAINTAINER&quot;, `Opam (None, &quot;maintainer&quot;, &quot;, &quot;))</code></li><li><code>(&quot;PKG_AUTHORS&quot;, `Opam (None, &quot;authors&quot;, &quot;, &quot;)</code></li><li><code>(&quot;PKG_HOMEPAGE&quot;, `Opam (None, &quot;homepage&quot;, &quot; &quot;)</code></li><li><code>(&quot;PKG_ISSUES&quot;, `Opam (None, &quot;bug-reports&quot;, &quot; &quot;)</code></li><li><code>(&quot;PKG_DOC&quot;, `Opam (None, &quot;doc&quot;, &quot; &quot;))</code></li><li><code>(&quot;PKG_LICENSE&quot;, `Opam (None, &quot;license&quot;, &quot;, &quot;)</code></li><li><code>(&quot;PKG_REPO&quot;, `Opam (None, &quot;dev-repo&quot;, &quot; &quot;))</code></li></ul><p>Prepending to the list overrides default definitions.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-files_to_watermark"><a href="#val-files_to_watermark" class="anchor"></a><code><span><span class="keyword">val</span> files_to_watermark : <span>unit <span class="arrow">&#45;&gt;</span></span> <span><span><a href="../index.html#type-fpath">fpath</a> list</span> <a href="../index.html#type-result">result</a></span></span></code></div><div class="spec-doc"><p><code>files_to_watermark ()</code> is the default list of files to watermark. It is invoked in the distribution build directory and gets the set of <a href="../Vcs/index.html#val-tracked_files" title="Vcs.tracked_files">tracked files</a> of this directory from which it removes the files that end with <code>.eps</code>, <code>.flv</code>, <code>.gif</code>, <code>.ico</code>, <code>.jpeg</code>, <code>.jpg</code>, <code>.mov</code>, <code>.mp3</code>, <code>.mp4</code>, <code>.otf</code>, <code>.pdf</code>, <code>.png</code>, <code>.ps</code>, <code>.ttf</code>, <code>.woff</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-massage"><a href="#val-massage" class="anchor"></a><code><span><span class="keyword">val</span> massage : <span>unit <span class="arrow">&#45;&gt;</span></span> <span>unit <a href="../index.html#type-result">result</a></span></span></code></div><div class="spec-doc"><p><code>massage</code> is the default distribution massaging function. It is invoked in the distribution build directory and does nothing.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-exclude_paths"><a href="#val-exclude_paths" class="anchor"></a><code><span><span class="keyword">val</span> exclude_paths : <span>unit <span class="arrow">&#45;&gt;</span></span> <span><span><a href="../index.html#type-fpath">fpath</a> list</span> <a href="../index.html#type-result">result</a></span></span></code></div><div class="spec-doc"><p><code>exclude_paths ()</code> is the default list of paths to exclude from the distribution archive. It is invoked in the distribution build directory and returns the following static set of files.</p><pre class="language-ocaml"><code>fun () -&gt; Ok [&quot;.git&quot;; &quot;.gitignore&quot;; &quot;.gitattributes&quot;; &quot;.hg&quot;; &quot;.hgignore&quot;;
              &quot;build&quot;; &quot;Makefile&quot;; &quot;_build&quot;]</code></pre></div></div><h2 id="distribution-publication-description"><a href="#distribution-publication-description" class="anchor"></a>Distribution publication description</h2><div class="odoc-spec"><div class="spec type anchored" id="type-publish"><a href="#type-publish" class="anchor"></a><code><span><span class="keyword">type</span> publish</span></code></div><div class="spec-doc"><p>The type for describing distribution publication.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-publish"><a href="#val-publish" class="anchor"></a><code><span><span class="keyword">val</span> publish : 
  <span><span class="optlabel">?artefacts</span>:<span><span>[ `Doc <span>| `Distrib</span> <span><span>| `Alt</span> of string</span> ]</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-publish">publish</a></span></code></div><div class="spec-doc"><p><code>publish ~artefacts ()</code> influences the distribution publication process performed by the <code>topkg</code> tool:</p><ul><li><code>artefacts</code> defines which artefacts are published by an invocation of <code>topkg publish</code> without arguments (defaults to <code>[`Doc;`Distrib]</code>).</li></ul></div></div><h2 id="package-description"><a href="#package-description" class="anchor"></a>Package description</h2><div class="odoc-spec"><div class="spec type anchored" id="type-std_file"><a href="#type-std_file" class="anchor"></a><code><span><span class="keyword">type</span> std_file</span></code></div><div class="spec-doc"><p>The type for specifying a standard file.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-std_file"><a href="#val-std_file" class="anchor"></a><code><span><span class="keyword">val</span> std_file : <span><span class="optlabel">?install</span>:bool <span class="arrow">&#45;&gt;</span></span> <span><a href="../index.html#type-fpath">fpath</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-std_file">std_file</a></span></code></div><div class="spec-doc"><p><code>std_file ~install p</code> is a standard file <code>p</code> expressed relative to the distribution root directory. The file is automatically installed if <code>install</code> is <code>true</code> (default).</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-meta_file"><a href="#type-meta_file" class="anchor"></a><code><span><span class="keyword">type</span> meta_file</span></code></div><div class="spec-doc"><p>The type for specifying an OCamlfind META file.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-meta_file"><a href="#val-meta_file" class="anchor"></a><code><span><span class="keyword">val</span> meta_file : <span><span class="optlabel">?lint</span>:bool <span class="arrow">&#45;&gt;</span></span> <span><span class="optlabel">?install</span>:bool <span class="arrow">&#45;&gt;</span></span> <span><a href="../index.html#type-fpath">fpath</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-meta_file">meta_file</a></span></code></div><div class="spec-doc"><p><code>meta_file ~lint ~install p</code> is a META file <code>p</code> expressed relative to the distribution root directory. The file is automatically installed in the <a href="#val-lib"><code>lib</code></a> field if <code>install</code> is <code>true</code> (default). If <code>lint</code> is <code>true</code> (default), it is OCamlfind linted.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-opam_file"><a href="#type-opam_file" class="anchor"></a><code><span><span class="keyword">type</span> opam_file</span></code></div><div class="spec-doc"><p>The type for specifying an opam file.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-opam_file"><a href="#val-opam_file" class="anchor"></a><code><span><span class="keyword">val</span> opam_file : 
  <span><span class="optlabel">?lint</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?lint_deps_excluding</span>:<span><span>string list</span> option</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?install</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../index.html#type-fpath">fpath</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-opam_file">opam_file</a></span></code></div><div class="spec-doc"><p><code>opam_file ~lint ~lint_deps_excluding ~install p</code> is an opam file <code>p</code> expressd relative to the distribution root directory such that:</p><ul><li>If <code>install</code> is <code>true</code> (default), it is automatically installed in the <a href="#val-lib"><code>lib</code></a> field.</li><li>If <code>lint</code> is <code>true</code> (default), it is opam linted.</li><li><p>If <code>lint_deps_excluding</code> is <code>Some excludes</code>, <code>topkg</code> checks that each of the opam package dependencies is mentioned as a root package in the OCamlbuild <code>_tags</code> file and vice-versa. The following package names are excluded from this test:</p><ul><li>The packages names mentioned in <code>excludes</code>.</li><li>Package names that start with <code>&quot;conf-&quot;</code></li><li><code>Topkg_care.OCamlfind.base_packages</code></li><li><code>Topkg_care.Opam.ocaml_base_packages</code></li></ul><p>If <code>None</code> the dependency check is disabled.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-describe"><a href="#val-describe" class="anchor"></a><code><span><span class="keyword">val</span> describe : 
  <span><span class="optlabel">?delegate</span>:<a href="../Cmd/index.html#type-t">Cmd.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?readmes</span>:<span><a href="#type-std_file">std_file</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?licenses</span>:<span><a href="#type-std_file">std_file</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?change_logs</span>:<span><a href="#type-std_file">std_file</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?metas</span>:<span><a href="#type-meta_file">meta_file</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?opams</span>:<span><a href="#type-opam_file">opam_file</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?lint_files</span>:<span><span><a href="../index.html#type-fpath">fpath</a> list</span> option</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?lint_custom</span>:<span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span><span><a href="../R/index.html#type-msg">R.msg</a> <a href="../index.html#type-result">result</a></span> list</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?distrib</span>:<a href="#type-distrib">distrib</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?publish</span>:<a href="#type-publish">publish</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?build</span>:<a href="#type-build">build</a> <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><a href="../Conf/index.html#type-t">Conf.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-install">install</a> list</span> <a href="../index.html#type-result">result</a></span>)</span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p><code>describe name install</code> describes a package named <code>name</code> with:</p><ul><li><code>delegate</code>, the package delegate command to use. If unspecfied determined by the delegate lookup procedure, see <code>topkg help delegate</code> for more information.</li><li><code>readmes</code> are readme files, defaults to <code>[std_file &quot;README.md&quot;]</code>. Automatic install is in the <a href="#val-doc"><code>doc</code></a> field.</li><li><code>licenses</code> are license files, defaults to <code>[std_file &quot;LICENSE.md&quot;]</code>. Automatic install is in the <a href="#val-doc"><code>doc</code></a> field.</li><li><code>change_logs</code> are change logs, defaults to <code>[std_file &quot;CHANGES.md&quot;]</code>. The first file of the list is the one that is acted upon by the <code>topkg log</code> command. Automatic install is in the <a href="#val-doc"><code>doc</code></a> field.</li><li><code>metas</code> the package's ocamlfind META files, defaults to <code>[ meta_file &quot;pkg/META&quot; ]</code>.</li><li><code>opams</code> the package's opam package files, defaults to <code>[opam_file &quot;opam&quot;]</code>. The default opam file used by a package description depends on the package <code>name</code> (which can be overriden from the command line). The opam file lookup procedure selects the first path in <code>opams</code> whose filename is <code>(name ^ &quot;.opam&quot;)</code> and, failing to do so, it fallbacks to an <code>&quot;opam&quot;</code> file at the root of the distribution.</li><li><code>lint_files</code> if <code>Some files</code>, ensures that all files mentioned in <code>readme</code>, <code>license</code>, <code>change_log</code>, <code>metas</code>, <code>opams</code> and <code>files</code> are present in the distribution. Defaults to <code>Some []</code>. If <code>None</code> disables the file existence tests (including readme, change_log, license, metas, opams, metas.)</li><li><code>lint_custom</code> defines a custom linting process run with the current directory set at the root of the distribution. Successes and errors in the returned list are reported as such and any error in the list makes the lint fail. Defaults to <code>None</code>.</li><li><code>distrib</code>, specifies the distribution process, defaults to <a href="#val-distrib"><code>distrib</code></a><code> ()</code>.</li><li><code>publish</code>, specifies the publication process, defaults to <a href="#val-publish"><code>publish</code></a><code> ()</code>.</li><li><code>build</code>, specifies the build process, defaults to <a href="#val-build"><code>build</code></a><code> ()</code>.</li><li><code>install</code> given a <a href="../Conf/index.html#type-t" title="Conf.t">build configuration</a> specifies the install moves. Note that some of standard files are automatically installed and don't need to be specified, see <a href="#val-std_file"><code>std_file</code></a>, <a href="#val-meta_file"><code>meta_file</code></a> and <a href="#val-opam_file"><code>opam_file</code></a>.</li></ul></div></div><h2 id="distdetails"><a href="#distdetails" class="anchor"></a>Package distribution creation details</h2><p>The following describes the exact steps performed by <code>topkg distrib</code> to create the distribution archive. Note that <code>topkg</code> allows to override or disable part of the process via command line arguments, e.g. to specify the version string manually or skip linting. See <code>topkg distrib --help</code> for more information.</p><p>The distribution process assumes that the source repository working directory is clean so that its definitions are consistent with those of the distribution build directory. A warning is generated if this is not the case as it may end up in inconsistent distribution archives (but which may be fine to only publish a documentation update).</p><p>Let <code>$NAME</code> be the name of the package, <code>$BUILD</code> be its <a href="#val-build" title="build">build directory</a>, <code>$VERSION</code> be the VCS tag description (e.g. <code>git-describe(1)</code> if you are using <code>git</code>) of the source repository HEAD commit and <code>distrib</code> the <a href="#val-distrib" title="distrib">distribution description</a> found in the source's repository <code>pkg/pkg.ml</code> file.</p><ol><li>Clone the source repository at <code>HEAD</code> as the distribution build directory <code>$BUILD/$NAME-$VERSION.build</code>.</li><li><p>Prepare the distribution:</p><ol><li>Invoke the <code>files_to_watermark</code> function of <code>distrib</code> in the distribution build directory to determine the files to watermark with <code>watermarks</code> and perform the watermarking process.</li><li>Adds a version field with value <code>$VERSION</code> to the opam files mentioned by <a href="#val-describe"><code>Pkg.describe</code></a>.</li><li>Run the <code>massage</code> function of <code>distrib</code> in the distribution build directory. This can be used to create distribution time build artefacts.</li></ol></li><li>Invoke the <code>exclude_paths</code> function of <code>distrib</code> in the distribution build directory to determine the paths to exclude from the archive.</li><li>Create a distribution tarball <code>$BUILD/$NAME-$VERSION.tbz</code> with the file hierarchy in <code>$BUILD/$NAME-$VERSION.build</code>, excluding the paths determined at the preceeding point and delete the clone <code>$BUILD/$NAME-$VERSION.build</code>. File modifications times in the archive are set to <code>HEAD</code>'s commit time and file permissions are preserved. Any other form of file metadata is discarded in the archive.</li><li>Test the distribution. Unpack it in directory <code>$BUILD/$NAME-$VERSION</code>, lint the distribution, build the package in the current build environment with its tests, run the tests, on success delete <code>$BUILD/$NAME-$VERSION</code>. Note that this uses the archive's <code>pkg/pkg.ml</code> file, which should not be different from the source's repository file if the latter was clean when <code>topkg distrib</code> was invoked.</li></ol><h3 id="watnote"><a href="#watnote" class="anchor"></a>Note on watermarking</h3><p>It is right to doubt the beauty and be concerned about the watermarking process. However experience shows that alternatives like having an OCaml module generated with the appropriate information doesn't work well in practice. Version numbers do not only show up in OCaml source code. They also appear in documentation comments, metadata files, textual data files and non-OCaml source files.</p><p>Watermarking by default all the non binary files of the distribution allows one to write %‚Äå%VERSION%% in any context and be sure it is be substituted with the right version number in dev package (<code>`Pin</code>) and distribution (<code>`Distrib</code>) <a href="../Conf/index.html#type-build_context" title="Conf.build_context">build contexts</a> (this occurence was not subsituted because a ZERO WIDTH NON-JOINER U+200C was introduced between the first two percent characters).</p><p>If this scheme poses a problem for certain files or you remain unconvinced, simply filter the result of <a href="#val-files_to_watermark"><code>files_to_watermark</code></a> or replace it by the exact files you would like to watermark.</p></div></body></html>
