<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Topkg (topkg.topkg.Topkg)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.css"/><meta name="generator" content="odoc %%VERSION%%"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>let base_url = '../../../';
let search_urls = ['../../sherlodoc_db.js','../../../sherlodoc.js'];
</script><script src="../../../odoc_search.js" defer="defer"></script></head><body class="odoc"><nav class="odoc-nav"><a href="../../index.html">Up</a> ‚Äì <a href="../../../index.html">üè†</a> &#x00BB; <a href="../../index.html">topkg</a> &#x00BB; Library <code>topkg</code> &#x00BB; Topkg</nav><div class="odoc-search"><div class="search-inner"><input class="search-bar" placeholder="üîé Type '/' to search..."/><div class="search-snake"></div><div class="search-result"></div></div></div><header class="odoc-preamble"><h1>Module <code><span>Topkg</span></code></h1><p>The transitory OCaml package builder.</p><p>See the <a href="#basics" title="basics">basics</a> and the <a href="#menagerie" title="menagerie">menagerie</a> of <code>pkg.ml</code> files.</p><p><em>v1.0.7 - <a href="https://erratique.ch/software/topkg">homepage</a></em></p></header><div class="odoc-tocs"><nav class="odoc-toc odoc-local-toc"><ul><li><a href="#prels">Preliminaries</a></li><li><a href="#pkgdescr">Package description</a></li><li><a href="#private">Private</a></li><li><a href="#basics">Basics</a></li><li><a href="#setup">Source repository setup</a><ul><li><a href="#carcass_ad">Quick setup (advertisement)</a></li></ul></li><li><a href="#build">opam and package build instructions</a></li><li><a href="#descr">Package description</a></li><li><a href="#installdescr">Install description</a><ul><li><a href="#installlib">Installing libraries and C stubs</a></li><li><a href="#installbin">Installing binaries</a></li><li><a href="#installcond">Conditional install</a></li><li><a href="#installautoconds">Automatic install conditions</a></li><li><a href="#installexts">Extension sets and platform dependent extensions</a></li><li><a href="#installrename">Renaming and installing in subdirectories</a></li><li><a href="#cmt">Handling cmt and cmti files</a></li></ul></li><li><a href="#care">Package care</a><ul><li><a href="#doccare">Documentation care</a></li></ul></li><li><a href="#advanced">Advanced topics</a><ul><li><a href="#config_store">Storing build configuration information in software</a></li><li><a href="#multiopam">Multiple opam packages for a single distribution</a></li></ul></li><li><a href="#menagerie">Menagerie of <code>pkg.ml</code> files</a></li></ul></nav><nav class="odoc-toc odoc-global-toc"><ul><li><a href="../../index.html">topkg</a><ul><li>Library <code>topkg</code><ul><li><a href="#" class="current_unit">Topkg</a><ul><li><a href="R/index.html">R</a></li><li><a href="String/index.html">String</a></li><li><a href="Fpath/index.html">Fpath</a></li><li><a href="Cmd/index.html">Cmd</a></li><li><a href="Log/index.html">Log</a></li><li><a href="OS/index.html">OS</a></li><li><a href="Vcs/index.html">Vcs</a></li><li><a href="Conf/index.html">Conf</a></li><li><a href="Exts/index.html">Exts</a></li><li><a href="Pkg/index.html">Pkg</a></li><li><a href="Private/index.html">Private</a></li></ul></li></ul></li></ul></li></ul></nav></div><div class="odoc-content"><h2 id="prels"><a href="#prels" class="anchor"></a>Preliminaries</h2><p>In the most simple cases you won't need this, jump directly to the <a href="#basics" title="basics">basics</a> or <a href="Pkg/index.html" title="Pkg">package description API</a>.</p><div class="odoc-spec"><div class="spec value anchored" id="val-(&gt;&gt;=)"><a href="#val-(&gt;&gt;=)" class="anchor"></a><code><span><span class="keyword">val</span> (&gt;&gt;=) : <span><span><span>(<span class="type-var">'a</span>, <span class="type-var">'b</span>)</span> <a href="../../../ocaml-base-compiler/stdlib/Stdlib/index.html#type-result">result</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span class="type-var">'c</span>, <span class="type-var">'b</span>)</span> <a href="../../../ocaml-base-compiler/stdlib/Stdlib/index.html#type-result">result</a></span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span class="type-var">'c</span>, <span class="type-var">'b</span>)</span> <a href="../../../ocaml-base-compiler/stdlib/Stdlib/index.html#type-result">result</a></span></span></code></div><div class="spec-doc"><p><code>r &gt;&gt;= f</code> is <code>f v</code> if <code>r = Ok v</code> and <code>r</code> if <code>r = Error _</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-(&gt;&gt;|)"><a href="#val-(&gt;&gt;|)" class="anchor"></a><code><span><span class="keyword">val</span> (&gt;&gt;|) : <span><span><span>(<span class="type-var">'a</span>, <span class="type-var">'b</span>)</span> <a href="../../../ocaml-base-compiler/stdlib/Stdlib/index.html#type-result">result</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'c</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span class="type-var">'c</span>, <span class="type-var">'b</span>)</span> <a href="../../../ocaml-base-compiler/stdlib/Stdlib/index.html#type-result">result</a></span></span></code></div><div class="spec-doc"><p><code>r &gt;&gt;| f</code> is <code>Ok (f v)</code> if <code>r = Ok v</code> and <code>r</code> if <code>r = Error _</code>.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-r"><a href="#type-r" class="anchor"></a><code><span><span class="keyword">type</span> <span>('a, 'b) r</span></span><span> = <span><span>(<span class="type-var">'a</span>, <span class="type-var">'b</span>)</span> <a href="../../../ocaml-base-compiler/stdlib/Stdlib/index.html#type-result">result</a></span></span><span> = </span></code><ol><li id="type-r.Ok" class="def variant constructor anchored"><a href="#type-r.Ok" class="anchor"></a><code><span>| </span><span><span class="constructor">Ok</span> <span class="keyword">of</span> <span class="type-var">'a</span></span></code></li><li id="type-r.Error" class="def variant constructor anchored"><a href="#type-r.Error" class="anchor"></a><code><span>| </span><span><span class="constructor">Error</span> <span class="keyword">of</span> <span class="type-var">'b</span></span></code></li></ol></div><div class="spec-doc"><p>This definition re-export <code>result</code>'s constructors so that an <code>open Topkg</code> gets them in scope.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-result"><a href="#type-result" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a result</span></span><span> = <span><span>(<span class="type-var">'a</span>, <span>[ <span>`Msg of string</span> ]</span>)</span> <a href="#type-r">r</a></span></span></code></div><div class="spec-doc"><p>The type for topkg results.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-R"><a href="#module-R" class="anchor"></a><code><span><span class="keyword">module</span> <a href="R/index.html">R</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Result value combinators.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-strf"><a href="#val-strf" class="anchor"></a><code><span><span class="keyword">val</span> strf : <span><span><span>(<span class="type-var">'a</span>, <a href="../../../ocaml-base-compiler/stdlib/Stdlib/Format/index.html#type-formatter">Format.formatter</a>, unit, string)</span> <a href="../../../ocaml-base-compiler/stdlib/Stdlib/index.html#type-format4">format4</a></span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div><div class="spec-doc"><p><code>strf</code> is <code>Printf.asprintf</code>.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-String"><a href="#module-String" class="anchor"></a><code><span><span class="keyword">module</span> <a href="String/index.html">String</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Strings.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-fpath"><a href="#type-fpath" class="anchor"></a><code><span><span class="keyword">type</span> fpath</span><span> = string</span></code></div><div class="spec-doc"><p>The type for file system paths.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Fpath"><a href="#module-Fpath" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Fpath/index.html">Fpath</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>File system paths.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Cmd"><a href="#module-Cmd" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Cmd/index.html">Cmd</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Command lines.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Log"><a href="#module-Log" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Log/index.html">Log</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Topkg log.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-OS"><a href="#module-OS" class="anchor"></a><code><span><span class="keyword">module</span> <a href="OS/index.html">OS</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>OS interaction.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Vcs"><a href="#module-Vcs" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Vcs/index.html">Vcs</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Version control system repositories.</p></div></div><h2 id="pkgdescr"><a href="#pkgdescr" class="anchor"></a>Package description</h2><div class="odoc-spec"><div class="spec module anchored" id="module-Conf"><a href="#module-Conf" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Conf/index.html">Conf</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Build configuration.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Exts"><a href="#module-Exts" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Exts/index.html">Exts</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Exts defines sets of file extensions.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Pkg"><a href="#module-Pkg" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Pkg/index.html">Pkg</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Package description.</p></div></div><h2 id="private"><a href="#private" class="anchor"></a>Private</h2><div class="odoc-spec"><div class="spec module anchored" id="module-Private"><a href="#module-Private" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Private/index.html">Private</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Private definitions.</p></div></div><h2 id="basics"><a href="#basics" class="anchor"></a>Basics</h2><p><a href="#"><code>Topkg</code></a> is a packager for distributing OCaml software. Fundamentally it only provides a simple and flexible mechanism to describe an opam <a href="http://opam.ocaml.org/doc/manual/dev-manual.html#sec25"><code>install</code> file</a> according to the build configuration which is used to infer one corresponding invocation of your build system.</p><p>This simple idea brings the following advantages:</p><ol><li>It frees you from implementing an install procedure in your build system: this task is delegated to <a href="http://opam.ocaml.org">opam</a>, to the <code>opam-installer</code> tool or anything that understands an opam install file.</li><li>It doesn't reclaim control over your build system. It only invokes it <em>once</em> with a list of targets determined by the package <a href="Pkg/index.html#install" title="install">install description</a>.</li><li>It is very flexible, supports a wide range of installation scenarios and is expressed in the reasonable language.</li></ol><p>Beyond this a <code>Topkg</code> package description provides information about the package's distribution creation and publication procedures. This enables swift and correct package distribution management via the <code>topkg</code> tool, see <a href="#care" title="care">Package care</a>.</p><ul><li><a href="#setup" title="setup">Source repository setup</a></li><li><a href="#build" title="build">opam and package build instructions</a></li><li><a href="#descr" title="descr">Package description</a></li><li><a href="#installdescr" title="installdescr">Install description</a></li><li><a href="#care" title="care">Package care</a></li><li><p><a href="#advanced" title="advanced">Advanced topics</a></p><ul><li><a href="#config_store" title="config_store">Storing build configuration information in software</a></li><li><a href="#multiopam" title="multiopam">Multiple opam packages for a single distribution</a></li></ul></li><li><a href="#menagerie" title="menagerie">Menagerie of <code>pkg.ml</code> files</a></li></ul><h2 id="setup"><a href="#setup" class="anchor"></a>Source repository setup</h2><p>The root of you source repository should have the following layout:</p><ul><li><code>pkg/pkg.ml</code>, the package description written with <a href="#"><code>Topkg</code></a>'s API. See <a href="#descr" title="descr">package description.</a></li><li><code>pkg/META</code>, an <a href="http://projects.camlcity.org/projects/findlib.html">ocamlfind</a> META file describing your package. See <a href="Pkg/index.html#val-describe"><code>Pkg.describe</code></a> to configure this.</li><li><code>_tags</code>, ocamlbuild file with at least a <code>true : bin_annot</code> line. See <a href="#cmt" title="cmt">handling cmt and cmti</a> files for details.</li><li><code>opam</code>, the package's opam metadata. See <a href="#build" title="build">opam and package build instructions</a>.</li><li><code>README.md</code>, your readme file. See <a href="Pkg/index.html#val-describe"><code>Pkg.describe</code></a> to configure this.</li><li><code>LICENSE.md</code>, your license file. See <a href="Pkg/index.html#val-describe"><code>Pkg.describe</code></a> to configure this.</li><li><code>CHANGES.md</code>, your change log. See <a href="Pkg/index.html#val-describe"><code>Pkg.describe</code></a> to configure this.</li></ul><h3 id="carcass_ad"><a href="#carcass_ad" class="anchor"></a>Quick setup (advertisement)</h3><p>If you start a new library <a href="http://erratique.ch/software/carcass"><code>carcass</code></a> can generate the structural boilerplate with your personal information and preferences. Invoke:</p><pre>carcass body topkg/pkg mypkg
(cd mypkg &amp;&amp; git init &amp;&amp; git add . &amp;&amp; git commit -m &quot;First commit.&quot;)
opam pin add -kgit mypkg mypkg#master</pre><p>and you have a library that is <code>{opam,ocamlfind}</code>-able with correct version watermarks on releases and opam pins. You are now only a few invocations away to release it in the OCaml opam repository, see <code>topkg help release</code> for doing so; but don't forget to document it and make it do something useful.</p><h2 id="build"><a href="#build" class="anchor"></a>opam and package build instructions</h2><p>The package needs to build-depend on <code>topkg</code> as well as <code>ocamlfind</code> which is used by the package description file <code>pkg/pkg.ml</code> to find the <code>topkg</code> library; it is likely that you are using <code>ocamlbuild</code> too. So the depends field of your opam file should at least have:</p><pre>depends: [
  &quot;ocamlfind&quot; {build}
  &quot;ocamlbuild&quot; {build}
  &quot;topkg&quot; {build &amp; &gt;= 0.9.0} ]</pre><p>The build instructions of the package are simply an invocation of <code>pkg/pkg.ml</code> with the <code>build</code> command and a specification of the build configuration on the command line. In the simplest case, if your package has no configuration options, this simply boils down to:</p><pre class="language-ocaml"><code># For opam &gt;= 2.0
build: [[ &quot;ocaml&quot; &quot;pkg/pkg.ml&quot; &quot;build&quot; &quot;--dev-pkg&quot; &quot;%{dev}%&quot; ]]

# For opam &lt; 2.0
build: [[ &quot;ocaml&quot; &quot;pkg/pkg.ml&quot; &quot;build&quot; &quot;--dev-pkg&quot; &quot;%{pinned}%&quot; ]]</code></pre><p>The <code>&quot;--dev-pkg&quot;</code> configuration key is used to inform the package description about the <a href="Conf/index.html#type-build_context" title="Conf.build_context">build context</a>. This invocation of <code>pkg/pkg.ml</code> executes your build system with a set of targets determined from the build configuration and generates in the root directory of your distribution an opam <code>install</code> file that opam uses to install and uninstall your package.</p><p>This is all you need to specify. Do not put anything in the remove field of the opam file. Likewise there is no need to invoke <code>ocamlfind</code> with your <code>META</code> file. Your <code>META</code> file should simply be installed in the directory of the <code>lib</code> field which happens automatically by default.</p><p>If you described <a href="Pkg/index.html#tests" title="tests">tests</a> then you should specify the instructions as follows (unfortunately for opam &lt; 2.0 this involves the repetition of the build line):</p><pre class="language-ocaml"><code># For opam &gt;= 2.0

build:
[[ &quot;ocaml&quot; &quot;pkg/pkg.ml&quot; &quot;build&quot; &quot;--dev-pkg&quot; &quot;%{dev}%&quot;
                                &quot;--tests&quot; &quot;%{build-test}%&quot; ]]
run-test:
[[ &quot;ocaml&quot; &quot;pkg/pkg.ml&quot; &quot;test&quot; ]]

# For opam &lt; 2.0

build:
[[ &quot;ocaml&quot; &quot;pkg/pkg.ml&quot; &quot;build&quot; &quot;--dev-pkg&quot; &quot;%{pinned}%&quot; ]]

build-test:
[[ &quot;ocaml&quot; &quot;pkg/pkg.ml&quot; &quot;build&quot; &quot;--dev-pkg&quot; &quot;%{pinned}%&quot; &quot;--tests&quot; &quot;true&quot; ]
 [ &quot;ocaml&quot; &quot;pkg/pkg.ml&quot; &quot;test&quot; ]]</code></pre><p><b>Beyond opam.</b> If you need to support another package system you can invoke <code>pkg/pkg.ml</code> as above and then manage the installation and uninstallation at a given <code>$DESTDIR</code> with the generated opam <code>install</code> file using <code>opam-installer</code> tool or any other program that understand these files.</p><h2 id="descr"><a href="#descr" class="anchor"></a>Package description</h2><p>The <a href="Pkg/index.html#val-describe"><code>Pkg.describe</code></a> function has a daunting number of arguments and configuration options. However if you keep things simple and stick to the defaults, much of this does not need to be specified.</p><p>For example, if we consider the basic <a href="#setup" title="setup">setup</a> mentioned above for a library described with an OCamlbuild <code>src/mylib.mllib</code> file, your package description file <code>pkg/pkg.ml</code> simply looks like this:</p><pre class="language-ocaml"><code>#!/usr/bin/env ocaml
#use &quot;topfind&quot;
#require &quot;topkg&quot;
open Topkg

let () =
  Pkg.describe &quot;mylib&quot; @@ fun c -&gt;
  Ok [ Pkg.mllib &quot;src/mylib.mllib&quot; ]</code></pre><p><b>Tip.</b> To allow <a href="https://github.com/the-lambda-church/merlin">merlin</a> to function correctly in your package description, issue <code>M-x merlin-use topkg</code> in <code>emacs</code> or <code>:MerlinUse topkg</code> in <code>vim</code>.</p><p>This simple description builds and installs the library described by the <code>src/mylib.mllib</code> file. It works correctly if native code compilation or native dynamic linking is not available. It automatically installs the package's META file in the directory of the <code>lib</code> field and your readme, change log and license file in the directory of the <code>doc</code> field.</p><p>Try to test the package build description with <code>topkg build</code>, this builds the package according to the description and build configuration and writes a <code>mylib.install</code> at the root of the distribution that describes the package installation. If everything went well, you are now ready to release, see <code>topkg help release</code> for the procedure.</p><p>To debug package descriptions it useful to dry run the build. This prevents the package from building and only writes the <code>mylib.install</code> file determined according to the build configuration.</p><pre class="language-ocaml"><code>topkg build -d    # Only write the opam install file
topkg build -d -v # Also print the build configuration
topkg help troubleshoot # More troubleshooting tips</code></pre><p>Note that <code>topkg build</code> does nothing more than invoke <code>ocaml &quot;pkg/pkg.ml&quot; build</code>. If you would like to see the build <a href="Conf/index.html#key" title="key">configuration options</a> of a package description you should do:</p><pre>ocaml pkg/pkg.ml help
./pkg/pkg.ml help     # If has exec right</pre><h2 id="installdescr"><a href="#installdescr" class="anchor"></a>Install description</h2><p>An opam <code>install</code> file is a description of a standard UNIX install. It has fields for each of the standard directories <code>lib</code>, <code>bin</code>, <code>man</code>, <code>etc</code>, etc. Each of these fields lists the files to install in the corresponding directory (or subdirectories). See the <a href="http://opam.ocaml.org/doc/manual/dev-manual.html#sec25">install file specification</a> in the opam developer manual for more information.</p><p>A topkg install description is just a convenient and compact way to describe an opam install file according to the build configuration. In turn this also describes what needs to be built which allows topkg to call the build system appropriately.</p><p>For each opam install field there is a corresponding field function that you can use to generate install moves. The documentation of <a href="Pkg/index.html#type-field"><code>Pkg.field</code></a> and <a href="Pkg/index.html#type-exec_field"><code>Pkg.exec_field</code></a> describes how you can use or omit their various arguments to simplify the description. Topkg also provides a few higher-level convenience functions like <a href="Pkg/index.html#val-mllib"><code>Pkg.mllib</code></a> and <a href="Pkg/index.html#val-clib"><code>Pkg.clib</code></a> which allow to reuse the description work already done for OCamlbuild.</p><p>In the following we review a few basic install use cases. The <a href="#menagerie" title="menagerie">menagerie</a> provides links to full and more complex examples.</p><h3 id="installlib"><a href="#installlib" class="anchor"></a>Installing libraries and C stubs</h3><p>It is possible to use the <a href="Pkg/index.html#val-lib"><code>Pkg.lib</code></a> field function and appropriate <a href="Exts/index.html" title="Exts">file extensions</a> to manually install a library, but this quickly becomes tedious. The higher-level <a href="Pkg/index.html#val-mllib"><code>Pkg.mllib</code></a> install function brings this to a single line by reading from a OCamlbuild <code>mllib</code> file. Given a library described in <code>src/mylib.mllib</code> file use:</p><pre class="language-ocaml"><code>Pkg.mllib &quot;src/mylib.mllib&quot;</code></pre><p>This will make all the modules mentioned in the <code>mllib</code> file part of the API (i.e. install its <code>cmi</code> files). You can restrict the API by using the <code>~api</code> optional argument. In the following, only <code>Mod1</code> and <code>Mod2</code> define the API, the other modules of <code>mllib</code> remain hidden to the end user (but unfortunately not to the linkers...):</p><pre class="language-ocaml"><code>Pkg.mllib ~api:[&quot;Mod1&quot;; &quot;Mod2&quot;] &quot;src/myllib.mllib&quot;</code></pre><p>A shortcut also exists for installing C stubs: <a href="Pkg/index.html#val-clib"><code>Pkg.clib</code></a>. Simply use it on an existing <code>src/libmystub.clib</code> file (N.B. OCamlbuild mandates that your <code>clib</code> file name starts with <code>lib</code>):</p><pre class="language-ocaml"><code>Pkg.clib &quot;src/libmystub.clib&quot;</code></pre><p>This will generate the appropriate install moves in the <code>lib</code> and <code>stublib</code> fields.</p><h3 id="installbin"><a href="#installbin" class="anchor"></a>Installing binaries</h3><p>In opam, binaries can only be installed by using the <code>bin</code>, <code>sbin</code> and <code>libexec</code> fields. Trying to install a binary in other fields will not set its executable bit (<a href="https://github.com/ocaml/opam/issues/2430">discussion</a>).</p><p>Most of the time one wants to install native binaries if native code compilation is available and bytecode ones if it is not. The <code>auto</code> argument of <a href="Pkg/index.html#type-exec_field"><code>Pkg.exec_field</code></a> does exactly this if omited.</p><p>So if you have an executable to install in the <code>bin</code> field whose <code>main</code> is in <code>src/myexec.ml</code>, describe it with:</p><pre class="language-ocaml"><code>Pkg.bin &quot;src/myexec&quot;</code></pre><p>As with any other field it easy to rename the executable along the way with the <code>dst</code> argument:</p><pre class="language-ocaml"><code>Pkg.bin &quot;src/myexec&quot; ~dst:&quot;my-exec&quot;</code></pre><p>Note that using the default value of <code>auto</code> also automatically handles the extension business for Windows platforms.</p><h3 id="installcond"><a href="#installcond" class="anchor"></a>Conditional install</h3><p>An easy and readable way to handle conditional installs is to use the <code>cond</code> argument of <a href="Pkg/index.html#type-field" title="Pkg.field">field functions</a>. The following shows how to conditionaly build and install a binary depending on the opam <code>cmdliner</code> package being installed:</p><pre class="language-ocaml"><code>let cmdliner = Conf.with_pkg &quot;cmdliner&quot;
let () =
  Pkg.describe &quot;mypkg&quot; @@ fun c -&gt;
  let cmdliner = Conf.value c cmdliner in
  Ok [ Pkg.bin ~cond:cmdliner &quot;src/myexec&quot; ]</code></pre><p>Note that <a href="Conf/index.html#key" title="key">configuration keys</a> must be created before the call to <a href="Pkg/index.html#val-describe"><code>Pkg.describe</code></a>. Their value can then be accessed with the <a href="Conf/index.html#val-value"><code>Conf.value</code></a> from the configuration given to the install move function you specify.</p><p>For this conditional install the opam build instructions look like this:</p><pre class="language-ocaml"><code>depopts: [ &quot;cmdliner&quot; ]
build: [[
  &quot;ocaml&quot; &quot;pkg/pkg.ml&quot; &quot;build&quot;
          &quot;--dev-pkg&quot; &quot;%{dev}%&quot; # use &quot;%{pinned}%&quot; for opam &lt; 2.0
          &quot;--with-cmdliner&quot; cmdliner:installed ]]</code></pre><h3 id="installautoconds"><a href="#installautoconds" class="anchor"></a>Automatic install conditions</h3><p>Some conditions related to native code and native code dynamic linking happen automatically. For example moves with paths ending with <code>.cmxs</code> are automatically dropped if <a href="Conf/OCaml/index.html#val-native_dynlink"><code>Conf.OCaml.native_dynlink</code></a> is <code>false</code> in the current build configuration. This behaviour can be disabled by using the <code>force</code> argument of <a href="Pkg/index.html#type-field" title="Pkg.field">field functions</a>.</p><h3 id="installexts"><a href="#installexts" class="anchor"></a>Extension sets and platform dependent extensions</h3><p>The <a href="Pkg/index.html#type-field" title="Pkg.field">field functions</a> have an optional <code>exts</code> argument. If present these extensions are appended to the <code>src</code> path given to the function. The module <a href="Exts/index.html"><code>Exts</code></a> defines a few predefined extension sets. For example a single module library archive implemented in <code>src/mylib.ml</code> can be declared by:</p><pre class="language-ocaml"><code>Pkg.lib ~exts:Exts.module_library &quot;src/mylib&quot;</code></pre><p>which is, effectively, a shortcut for:</p><pre class="language-ocaml"><code>[ Pkg.lib &quot;src/mylib.mli&quot;;
  Pkg.lib &quot;src/mylib.cmti&quot;;
  Pkg.lib &quot;src/mylib.cmi&quot;;
  Pkg.lib &quot;src/mylib.cmx&quot;;
  Pkg.lib &quot;src/mylib.cma&quot;;
  Pkg.lib &quot;src/mylib.a&quot;;
  Pkg.lib &quot;src/mylib.cmxa&quot;;
  Pkg.lib &quot;src/mylib.cmxs&quot;; ]</code></pre><p>Extensions sets are also used to support platform independent installs. For example to install a static C library archive you should use the second invocation, not the first one:</p><pre class="language-ocaml"><code>Pkg.lib &quot;src/libmylib.a&quot; (* DON'T do this *)
Pkg.lib ~exts:Exts.c_library &quot;src/libmylib&quot; (* Do this *)</code></pre><p>this ensures that the correct, platform dependent, suffix is used.</p><h3 id="installrename"><a href="#installrename" class="anchor"></a>Renaming and installing in subdirectories</h3><p>By default install moves simply install the file at the root directory of the field. Using the <code>dst</code> optional argument you can rename the file and/or install it to subdirectories.</p><pre class="language-ocaml"><code>Pkg.lib &quot;src/b.cmo&quot; ~dst:&quot;hey&quot;  (* Install as [hey] file. *)
Pkg.lib &quot;src/b.cmo&quot; ~dst:&quot;hey/&quot; (* Install in [hey] subdirectory *)
Pkg.lib &quot;src/b.cmo&quot; ~dst:&quot;hey/ho.cmo&quot;  (* Install as [ho.cmo] in [hey]. *)</code></pre><h3 id="cmt"><a href="#cmt" class="anchor"></a>Handling cmt and cmti files</h3><p>Since the OCaml tools generate <code>.cmt</code> and <code>.cmti</code> files only as a side effect they are treated specially: they are not built. For OCamlbuild you should add this line to your <code>_tags</code> file:</p><pre class="language-ocaml"><code>true : bin_annot</code></pre><p>this will build them as a side effect of other build invocations. In the generated opam install file the <code>cmt</code> and <code>cmti</code> files are prefixed by a ? so that if they are not built the install does not fail.</p><h2 id="care"><a href="#care" class="anchor"></a>Package care</h2><p>Developing and distributing packages implies a lot of mundane but nevertheless important tasks. The <code>topkg</code> tool, guided by information provided by <a href="Pkg/index.html#val-describe"><code>Pkg.describe</code></a> helps you with these tasks.</p><p>For example <code>topkg lint</code> makes sure that the package source repository or distribution follows a few established (or your) conventions and that the META and opam files of the package pass their respective linter. <code>topkg distrib</code> will create watermarked and reproducible distribution archives (see <a href="Pkg/index.html#distrib" title="distrib">Distribution description</a>) while <code>topkg publish</code> and <code>topkg opam</code> will help publishing them. All this and more is described with details in <code>topkg</code>'s help system, invoke:</p><pre>topkg help release
topkg help</pre><p>to get an extended introduction and pointers to these features.</p><h3 id="doccare"><a href="#doccare" class="anchor"></a>Documentation care</h3><p>Topkg provides support to make it easier to write and publish your package documentation. The <code>topkg doc -r</code> command generates and refreshes renderings of the package documentation while you work on it.</p><p>Documentation publication is always derived from a generated distribution archive (the latter doesn't need to be published of course). So to push documentation fixes and clarifications simply invoke:</p><pre>topkg distrib
topkg publish doc</pre><p>Make sure you include %‚Äå%VERSION%% watermarks in the documentation so that readers know exactly which version they are reading. By default this will be substituted by a VCS tag description so it will be precise even though you may not have properly tagged a new release for the package.</p><h2 id="advanced"><a href="#advanced" class="anchor"></a>Advanced topics</h2><h3 id="config_store"><a href="#config_store" class="anchor"></a>Storing build configuration information in software</h3><p>The following sample setup shows how to store build configuration information in build artefacts.</p><p>In this example we store the location of the install's <code>etc</code> directory in the build artefacts. The setup also works seamlessly during development if build artefacts are invoked from the root directory of the source repository.</p><p>We have the following file layout in our source repository:</p><pre>etc/mypkg.conf       # Configuration file
src/mypkg_etc.ml     # Module with path to the etc dir</pre><p>the contents of <code>src/mypkg_etc.ml</code> is simply:</p><pre class="language-ocaml"><code>(* This file is overwritten by distribution builds. During development
   it refers to the [etc] directory at the root directory of the
   source repository. *)

let dir = &quot;etc&quot;</code></pre><p>the value <code>Mypkg_etc.dir</code> is used in the sources to refer to the <code>etc</code> directory of the install. In the package description file <code>pkg/pkg.ml</code> we have the following lines:</p><pre class="language-ocaml"><code>let (* 1 *) etc_dir =
  let doc = &quot;Use $(docv) as the etc install directory&quot; in
  Conf.(key &quot;etc-dir&quot; fpath ~absent:&quot;etc&quot; ~doc)

let (* 2 *) etc_config c = match Conf.build_context c with
| `Dev -&gt; Ok () (* Do nothing, the repo src/mypkg_etc.ml will do *)
| `Pin | `Distrib -&gt;
    let config = strf &quot;let dir = %S&quot; (Conf.value c etc_dir) in
    OS.File.write &quot;src/mypkg_etc.ml&quot; config

let () =
  let build = Pkg.build ~pre:etc_config () in
  Pkg.describe &quot;mypkg&quot; ~build @@ fun c -&gt;
  Ok [ (* 3 *) Pkg.etc &quot;etc/mpypkg.conf&quot;; ... ]</code></pre><p>In words:</p><ol><li>We declare a configuration key <code>&quot;etc-dir&quot;</code> that holds the location of the install <code>etc</code> directory.</li><li>We have a pre-build hook that writes the file <code>src/mypkg_etc.ml</code> with its actual value on <code>`Pin</code> and <code>`Distrib</code> builds.</li><li>We install the <code>etc/mypkg.conf</code> configuration in the install <code>etc</code> directory.</li></ol><p>The opam build instructions for the package are:</p><pre class="language-ocaml"><code>build: [[
  &quot;ocaml&quot; &quot;pkg/pkg.ml&quot; &quot;build&quot;
          &quot;--dev-pkg&quot; &quot;%{dev}%&quot; # use &quot;%{pinned}%&quot; for opam &lt; 2.0
          &quot;--etc-dir&quot; mypkg:etc ]]</code></pre><h3 id="multiopam"><a href="#multiopam" class="anchor"></a>Multiple opam packages for a single distribution</h3><p>It is not too hard to define multiple opam packages for the same distribution. Topkg itself <a href="https://github.com/dbuenzli/topkg/blob/master/DEVEL.md">uses this trick</a> to manage its dependencies between <code>topkg</code> and <code>topkg-care</code>.</p><p>To achieve this your package description file can simply condition the package install description on the package name <a href="Conf/index.html#val-pkg_name" title="Conf.pkg_name">communicated by the configuration</a>. In this setup you'll likely have one <code>$PKG.opam</code> per <code>$PKG</code> at the root of your source repository, you should declare them in the description too, so that they get properly linted and used by the <code>topkg</code> tool when appropriate (see how the opam file is looked up according to the package name in <a href="Pkg/index.html#val-describe"><code>Pkg.describe</code></a>). Here is a blueprint:</p><pre class="language-ocaml"><code>let () =
  let opams =
    let install = false in
    [ Pkg.opam_file ~install &quot;mypkg-main.opam&quot;;
      Pkg.opam_file ~install &quot;mypkg-snd.opam&quot;; ]
  in
  Pkg.describe ~opams &quot;mypkg-main&quot; @@ fun c -&gt;
  match Conf.pkg_name c with
  | &quot;mypkg-main&quot; -&gt;
      Ok [ Pkg.lib &quot;mypkg-main.opam&quot; ~dst:&quot;opam&quot;;
           (* mypkg-main install *) ]
  | &quot;mypkg-snd&quot; -&gt;
      Ok [ Pkg.lib &quot;mypkg-snd.opam&quot; ~dst:&quot;opam&quot;;
           (* mypkg-snd install *) ]
  | other -&gt;
      R.error_msgf &quot;unknown package name: %s&quot; other</code></pre><p>The build instructions of these opam files need to give the name of the package to the build invocation so that the right install description can be selected:</p><pre class="language-ocaml"><code>build: [[
  &quot;ocaml&quot; &quot;pkg/pkg.ml&quot; &quot;build&quot;
          &quot;--pkg-name&quot; name
          &quot;--dev-pkg&quot; &quot;%{dev}%&quot; # use &quot;%{pinned}%&quot; for opam &lt; 2.0
]]</code></pre><p>In general you will use the default, main, package name and its opam file to create and publish the distribution archive file and all packages will use the same distribution; the opam packages will only differ in their opam file. Releasing the set of packages then becomes:</p><pre class="language-ocaml"><code># Release the distribution and base package (use topkg bistro
# for doing this via a single invocation)
topkg distrib
topkg publish
topkg opam pkg
topkg opam submit

# Create and release the other opam package based on the ditrib
topkg opam pkg --pkg-name mypkg-snd
topkg opam submit --pkg-name mypkg-snd</code></pre><p>See <code>topkg help release</code> for more information about releasing packages with <code>topkg</code>.</p><h2 id="menagerie"><a href="#menagerie" class="anchor"></a>Menagerie of <code>pkg.ml</code> files</h2><p>This is a menagerie of <code>pkg.ml</code> with a description of what they showcase. The examples are approximatively sorted by increasing complexity.</p><p>In all these packages the readme, change log and license file are automatically installed in the directory of the <code>doc</code> field and the ocamlfind META file and opam file of the package are automatically installed in the directory of the <code>lib</code> field.</p><p><a href="https://github.com/dbuenzli/hmap/blob/master/pkg/pkg.ml">Hmap</a> (<a href="https://github.com/dbuenzli/hmap/blob/master/pkg/META">META</a>, <a href="https://github.com/dbuenzli/hmap/blob/master/opam"><code>opam</code></a>)</p><ul><li>Single module library archive <code>hmap</code>. The simplest you can get.</li></ul><p><a href="https://github.com/dbuenzli/fpath/blob/master/pkg/pkg.ml">Fpath</a> (<a href="https://github.com/dbuenzli/fpath/blob/master/pkg/META">META</a>, <a href="https://github.com/dbuenzli/fpath/blob/master/opam"><code>opam</code></a>)</p><ul><li>Single module library archive <code>fpath</code>.</li><li>Private library archive <code>fpath_top</code> for toplevel support.</li></ul><p><a href="https://github.com/dbuenzli/astring/blob/master/pkg/pkg.ml">Astring</a> (<a href="https://github.com/dbuenzli/astring/blob/master/pkg/META">META</a>, <a href="https://github.com/dbuenzli/astring/blob/master/opam"><code>opam</code></a>)</p><ul><li>Library archive <code>astring</code> namespaced by one module.</li><li>Private library archive for toplevel support (<code>astring_top</code>).</li><li>Installation of sample code in the <code>doc/</code> directory.</li></ul><p><a href="https://github.com/dbuenzli/fmt/blob/master/pkg/pkg.ml">Fmt</a> (<a href="https://github.com/dbuenzli/fmt/blob/master/pkg/META">META</a>, <a href="https://github.com/dbuenzli/fmt/blob/master/opam"><code>opam</code></a>)</p><ul><li>Single module library archive (<code>fmt</code>).</li><li>Private library archive <code>fmt_top</code> for toplevel support.</li><li>Single module library archive <code>fmt_tty</code> conditional on the presence of the opam <code>base-unix</code> package.</li><li>Single module library archive <code>fmt_cli</code> conditional on the presence of the opam <code>cmdliner</code> package.</li></ul><p><a href="https://github.com/dbuenzli/ptime/blob/master/pkg/pkg.ml">Ptime</a> (<a href="https://github.com/dbuenzli/ptime/blob/master/pkg/META">META</a>, <a href="https://github.com/dbuenzli/ptime/blob/master/opam">opam</a>)</p><ul><li>Single module library archive <code>ptime</code>.</li><li>Private library archive <code>ptime_top</code> for toplevel support.</li><li>Library archive <code>ptime_clock</code> targeting regular OSes using C stubs and installed in the <code>os/</code> subdirectory of <code>lib</code> field along with a private library archive <code>ptime_clock_top</code> for toplevel support.</li><li>Library archive <code>ptime_clock</code> targeting JavaScript installed in the <code>jsoo/</code> subdirectory of <code>lib</code> field conditional on the presence of the opam <code>js_of_ocaml</code> package.</li><li>Installation of sample code in the <code>doc/</code> directory.</li></ul><p><a href="https://github.com/dbuenzli/uucp/blob/master/pkg/pkg.ml">Uucp</a> (<a href="https://github.com/dbuenzli/uucp/blob/master/pkg/META">META</a>, <a href="https://github.com/dbuenzli/uucp/blob/master/opam">opam</a>)</p><ul><li>Library archive <code>uucp</code> namespaced by a single module.</li><li>Custom watermark for substituting the supported Unicode version.</li><li>Generation of distribution time build artefacts via a <a href="Pkg/index.html#distrib" title="distrib">massage</a> hook which invokes an <a href="https://github.com/dbuenzli/uucp/blob/master/pkg/build_support.ml">OCaml script</a> that downloads the UCD XML file and extracts compact and efficient representation of it as OCaml source data structures it writes in the <code>src/</code> directory.</li><li>Adds the <code>support/</code> path to the <a href="Pkg/index.html#distrib" title="distrib">paths to exclude</a> from the distribution.</li><li>Installation of development information and sample code in the <code>doc/</code> directory.</li></ul><p><a href="https://github.com/dbuenzli/carcass/blob/master/pkg/pkg.ml">Carcass</a> (<a href="https://github.com/dbuenzli/carcass/blob/master/pkg/META">META</a>, <a href="https://github.com/dbuenzli/carcass/blob/master/opam">opam</a>)</p><ul><li>Library archive <code>carcass</code> namespaced by a single module.</li><li>Single module library archive <code>carcass_cli</code>.</li><li>Executable <code>carcass</code>.</li><li><a href="#config_store" title="config_store">Stores</a> install <code>etc</code> location in the software artefacts with a <a href="Pkg/index.html#build" title="build">pre-build hook</a>.</li><li>Adjusts the <a href="Pkg/index.html#distrib" title="distrib">files to watermark</a> to ignore the files in the <code>etc</code> file hierarchy of the distribution.</li><li>Installs the <code>etc</code> hierarchy of the distribution in the <code>etc</code> field directly from the source tree (i.e. the files are not built).</li></ul><p><a href="https://github.com/dbuenzli/topkg/blob/master/pkg/pkg.ml">Topkg</a> (<a href="https://github.com/dbuenzli/topkg/blob/master/pkg/META">META</a>, <a href="https://github.com/dbuenzli/topkg/blob/master/topkg.opam">topkg.opam</a>, <a href="https://github.com/dbuenzli/topkg/blob/master/topkg-care.opam">topkg-care.opam</a>)</p><ul><li>Ignore the funky source bootstraping (<code>#mod_use</code> directives), that's only for using <code>topkg</code> on itself.</li><li>Makes <a href="#multiopam" title="multiopam">multiple opam packages</a> for the same distribution.</li><li>Multiple opam file declaration and dependency linting exclusions: the build system mentions packages that are not relevant to all opam files. Manual, per package, opam file install in the <code>lib</code> field.</li><li>Manual <code>META</code> install, a single one is installed for all opam packages by the base package <code>topkg</code>. This leverages the <code>if_exists</code> ocamlfind mecanism.</li><li>The <code>topkg</code> package installs the library archive <code>topkg</code> namespaced by a single module.</li><li>The <code>topkg-care</code> package installs the library archive <code>topkg-care</code> namespaced by a single module and the binaries <code>topkg</code> and <code>toy-github-topkg-delegate</code></li></ul></div></body></html>
